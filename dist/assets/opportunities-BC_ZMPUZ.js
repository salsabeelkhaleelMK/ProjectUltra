const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dj_RD8l0.js","assets/index-B2AXF7q7.css"])))=>i.map(i=>d[i]);
import{D as M,r as p,c as A,l as R,ah as W,_ as $,ai as g,aj as I,ak as j,P as q,a9 as h,al as H,ag as U,am as z,an as G,ao as J,ae as K,ap as Q,aq as X,ar as Z}from"./index-Dj_RD8l0.js";const ae=M("opportunities",()=>{const o=p([]),l=p(null),f=p([]),u=p(!1),r=p(null),_=A(()=>o.value.filter(a=>a.priority==="Hot"&&a.stage!=="Closed Lost"));R(l,async(a,t)=>{if(a){if(!t||t.id!==a.id)try{f.value=await h(a.id)}catch(i){console.error("Failed to load opportunity activities:",i),f.value=[]}}else f.value=[]},{immediate:!0});const k=async(a={})=>{u.value=!0,r.value=null;try{const t=await W(a),i=t.data||t,{checkNegotiationSubstatusTransition:e}=await $(async()=>{const{checkNegotiationSubstatusTransition:s}=await import("./index-Dj_RD8l0.js").then(n=>n.bt);return{checkNegotiationSubstatusTransition:s}},__vite__mapDeps([0,1]));for(const s of i){const n=e(s);n!==s.negotiationSubstatus&&(s.negotiationSubstatus=n,g(s.id,{negotiationSubstatus:n}).catch(c=>{console.error("Failed to auto-update negotiation substatus:",c)}))}return o.value=i,t}catch(t){throw r.value=t.message,t}finally{u.value=!1}},N=async a=>{u.value=!0,r.value=null;try{const t=await I(a),{checkNegotiationSubstatusTransition:i}=await $(async()=>{const{checkNegotiationSubstatusTransition:n}=await import("./index-Dj_RD8l0.js").then(c=>c.bt);return{checkNegotiationSubstatusTransition:n}},__vite__mapDeps([0,1])),e=i(t);e!==t.negotiationSubstatus&&(t.negotiationSubstatus=e,g(a,{negotiationSubstatus:e}).catch(n=>{console.error("Failed to auto-update negotiation substatus:",n)})),l.value=t;const s=o.value.findIndex(n=>n.id===parseInt(a));return s!==-1&&(o.value[s]=t),l.value}catch(t){throw r.value=t.message,t}finally{u.value=!1}},x=async a=>{u.value=!0,r.value=null;try{const t=await j(a);return o.value.push(t),t}catch(t){throw r.value=t.message,t}finally{u.value=!1}},C=async(a,t)=>{var i,e;u.value=!0,r.value=null;try{const n=q().getSetting("autoCloseWidgetsOnClose"),c=((i=l.value)==null?void 0:i.id)===a?l.value:o.value.find(v=>v.id===a);if(n&&t.stage&&(t.stage==="Closed Won"||t.stage==="Closed Lost")){const v=c==null?void 0:c.stage;if(v&&v!=="Closed Won"&&v!=="Closed Lost"){const D=(await h(a)).filter(d=>{var m,b;return d.type==="nfu-task"||d.type==="ofb-task"||((m=d.action)==null?void 0:m.includes("NFU"))||((b=d.action)==null?void 0:b.includes("OFB"))});for(const d of D)d.completed||await w(a,d.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${t.stage}`})}}const y=await g(a,t),S=o.value.findIndex(v=>v.id===a);return S!==-1&&(o.value[S]=y),((e=l.value)==null?void 0:e.id)===a&&(l.value=y),y}catch(s){throw r.value=s.message,s}finally{u.value=!1}},B=async a=>{u.value=!0,r.value=null;try{await H(a),o.value=o.value.filter(t=>t.id!==a)}catch(t){throw r.value=t.message,t}finally{u.value=!1}},O=async(a,t)=>{var i;u.value=!0,r.value=null;try{const e=await U(a,t);return((i=l.value)==null?void 0:i.id)===parseInt(a)&&(f.value=await h(a)),e}catch(e){throw r.value=e.message,e}finally{u.value=!1}},T=async(a,t)=>{var i;u.value=!0,r.value=null;try{const e={id:`offer-${Date.now()}`,createdAt:new Date().toISOString(),vehicleBrand:t.vehicleBrand||"",vehicleModel:t.vehicleModel||"",vehicleYear:t.vehicleYear||"",price:t.price||0,status:"active",data:t.data||{}},s=await z(a,e),n=o.value.find(c=>c.id===a);return n&&(n.offers||(n.offers=[]),n.offers.push(s),n.offers.length===1&&(n.stage="In Negotiation",n.negotiationSubstatus="Offer Sent")),((i=l.value)==null?void 0:i.id)===a&&(l.value.offers||(l.value.offers=[]),l.value.offers.push(s),l.value.offers.length===1&&(l.value.stage="In Negotiation",l.value.negotiationSubstatus="Offer Sent")),await O(a,{type:"offer",user:"You",action:"created an offer",content:`Offer created: ${e.vehicleBrand} ${e.vehicleModel} (${e.vehicleYear}) - â‚¬ ${e.price.toLocaleString()}`,data:{offerId:e.id},timestamp:new Date().toISOString()}),s}catch(e){throw r.value=e.message,e}finally{u.value=!1}},F=async(a,t)=>{var i;u.value=!0,r.value=null;try{await G(a,t);const e=o.value.find(s=>s.id===a);if(e&&e.offers){const s=e.offers.find(n=>n.id===t);s&&(s.status="accepted"),e.negotiationSubstatus="Offer Accepted",e.stage="In Negotiation"}if(((i=l.value)==null?void 0:i.id)===a&&l.value.offers){const s=l.value.offers.find(n=>n.id===t);s&&(s.status="accepted"),l.value.negotiationSubstatus="Offer Accepted",l.value.stage="In Negotiation"}}catch(e){throw r.value=e.message,e}finally{u.value=!1}},L=async(a,t)=>{var i;u.value=!0,r.value=null;try{await J(a,t);const e=o.value.find(s=>s.id===a);if(e&&e.offers){const s=e.offers.find(n=>n.id===t);s&&(s.status="archived")}if(((i=l.value)==null?void 0:i.id)===a&&l.value.offers){const s=l.value.offers.find(n=>n.id===t);s&&(s.status="archived")}}catch(e){throw r.value=e.message,e}finally{u.value=!1}},E=async(a,t)=>{var i;u.value=!0,r.value=null;try{await g(a,{negotiationSubstatus:t});const e=o.value.find(s=>s.id===a);e&&(e.negotiationSubstatus=t),((i=l.value)==null?void 0:i.id)===a&&(l.value.negotiationSubstatus=t)}catch(e){throw r.value=e.message,e}finally{u.value=!1}},w=async(a,t,i)=>{var e;u.value=!0,r.value=null;try{const s=await K(a,t,i);return((e=l.value)==null?void 0:e.id)===parseInt(a)&&(f.value=await h(a)),s}catch(s){throw r.value=s.message,s}finally{u.value=!1}},P=async(a,t)=>{var i;u.value=!0,r.value=null;try{const e=await Q(a,t),s=o.value.findIndex(n=>n.id===parseInt(a));return s!==-1&&(o.value[s]=e),((i=l.value)==null?void 0:i.id)===parseInt(a)&&(l.value=e),e}catch(e){throw r.value=e.message,e}finally{u.value=!1}},V=async(a,t)=>{var i;u.value=!0,r.value=null;try{const e=await X(a,t),s=o.value.findIndex(n=>n.id===parseInt(a));return s!==-1&&(o.value[s]=e.opportunity),((i=l.value)==null?void 0:i.id)===parseInt(a)&&(l.value=e.opportunity),e}catch(e){throw r.value=e.message,e}finally{u.value=!1}},Y=async(a,t)=>{var i;u.value=!0,r.value=null;try{return await Z(a,t),((i=l.value)==null?void 0:i.id)===parseInt(a)&&(f.value=await h(a)),{success:!0}}catch(e){throw r.value=e.message,e}finally{u.value=!1}};return{opportunities:o,currentOpportunity:l,loading:u,error:r,currentOpportunityActivities:A(()=>f.value),hotOpportunities:_,fetchOpportunities:k,fetchOpportunityById:N,createOpportunity:x,updateOpportunity:C,deleteOpportunity:B,addActivity:O,updateActivity:w,deleteActivity:Y,addVehicle:P,createOffer:V,addOffer:T,markOfferAccepted:F,deleteOffer:L,updateNegotiationSubstatus:E}});export{ae as u};
