import{r as I,d as S,o as x,s as u,_ as he,c as A,e as r,x as P,g as M,B as f,k as V,y as e,t as q,n as N,F as U,i as j,l as H,h as ne,C as le,D as be,w as xe,q as _e,E as ke,m as we,G as Se}from"./index-BSxt259F.js";import{_ as Ce,u as oe}from"./UnifiedAddForm-fTV8M0qH.js";import{u as ie}from"./opportunities-C7VMVq_4.js";import{Q as K,J as R,Y as O,e as Q,t as B,z as ue,G as Z,W as ee,U as te,H as ae,j as se,n as re,A as $e,c as Fe,a as Ie,b as qe,Z as Te,X as J}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-CK4ymTFf.js";import{_ as Ee}from"./PageHeader-D-QUKZVE.js";import"./contacts-CvrS-If3.js";const Me={__name:"ManualTab",emits:["submit"],setup(p,{expose:m}){const d=I(null);return m({resetSubmitting:()=>{var t;return(t=d.value)==null?void 0:t.resetSubmitting()},submit:()=>{var t;return(t=d.value)==null?void 0:t.submit()},clear:()=>{var t;return(t=d.value)==null?void 0:t.clear()},canSubmit:()=>{var t;return(t=d.value)==null?void 0:t.canSubmit},isSubmitting:()=>{var t;return(t=d.value)==null?void 0:t.isSubmitting}}),(t,c)=>(x(),S("div",null,[u(Ce,{ref_key:"formRef",ref:d,onSubmit:c[0]||(c[0]=h=>t.$emit("submit",h))},null,512)]))}};function Ve(p,m=","){const d=p.split(`
`).filter(h=>h.trim());if(d.length===0)throw new Error("CSV file is empty");const t=d[0].split(m).map(h=>h.trim().replace(/^"|"$/g,"")),c=[];for(let h=1;h<d.length;h++){const _=d[h].split(m).map(o=>o.trim().replace(/^"|"$/g,""));if(_.length!==t.length){const o=d[h],C=new RegExp(`(?:^|${m})(?:"([^"]*)"|([^${m}]*))`,"g"),n=[];let s;for(;(s=C.exec(o))!==null;)n.push(s[1]||s[2]||"");if(n.length===t.length){const y={};t.forEach((i,v)=>{y[i]=n[v]||""}),c.push(y)}else console.warn(`Row ${h+1} has ${_.length} columns, expected ${t.length}. Skipping.`)}else{const o={};t.forEach((C,n)=>{o[C]=_[n]||""}),c.push(o)}}return{headers:t,data:c}}async function De(p){const m=await he(()=>import("./xlsx-D_0l8YDs.js"),[]);return new Promise((d,t)=>{const c=new FileReader;c.onload=h=>{try{const _=new Uint8Array(h.target.result),o=m.read(_,{type:"array"}),C=o.SheetNames[0],n=o.Sheets[C],s=m.utils.sheet_to_json(n,{header:1});if(s.length===0){t(new Error("Excel file is empty"));return}const y=s[0].map(v=>String(v||"").trim()),i=[];for(let v=1;v<s.length;v++){const b=s[v],T={};y.forEach((a,l)=>{T[a]=b[l]!==void 0?String(b[l]):""}),i.push(T)}d({headers:y,data:i})}catch(_){t(new Error(`Failed to parse Excel file: ${_.message}`))}},c.onerror=()=>{t(new Error("Failed to read Excel file"))},c.readAsArrayBuffer(p)})}async function Oe(p){const m=p.name.toLowerCase();if(m.endsWith(".csv")){const d=await p.text();return Ve(d)}else{if(m.endsWith(".xls")||m.endsWith(".xlsx"))return await De(p);throw new Error("Unsupported file format. Please upload a CSV or Excel file (.csv, .xls, .xlsx)")}}function Re(){const p=I(null),m=I(null),d=I([]),t=I(!1),c=I(null),h=n=>{const s=[".csv",".xls",".xlsx"],y=n.name.toLowerCase();if(!s.some(b=>y.endsWith(b)))throw new Error("Invalid file type. Please upload a CSV or Excel file (.csv, .xls, .xlsx)");const v=10*1024*1024;if(n.size>v)throw new Error("File size exceeds 10MB limit");return!0};return{selectedFile:p,parsedData:m,headers:d,loading:t,error:c,handleFileSelect:async n=>{try{c.value=null,t.value=!0,h(n);const s=await Oe(n);if(p.value=n,m.value=s.data,d.value=s.headers,!s.data||s.data.length===0)throw new Error("File contains no data rows");if(!s.headers||s.headers.length===0)throw new Error("File contains no header row");return{file:n,headers:s.headers,data:s.data,rowCount:s.data.length}}catch(s){throw c.value=s.message,p.value=null,m.value=null,d.value=[],s}finally{t.value=!1}},clearFile:()=>{p.value=null,m.value=null,d.value=[],c.value=null},getPreview:(n=5)=>m.value?m.value.slice(0,n):[]}}const Ue={class:"space-y-4"},je={class:"space-y-2"},Pe={class:"relative w-full"},Ae=["disabled"],Ne={class:"text-foreground text-sm font-bold mb-1"},ze={class:"text-xs text-red-700"},He={class:"flex items-center justify-between"},Le={class:"overflow-x-auto"},Ke={class:"w-full text-xs"},Be={class:"border-b border-border"},We={key:0,class:"text-muted-foreground text-xs mt-3 text-center"},Y=5,Je={__name:"FileUploadForm",props:{modelValue:{type:File,default:null},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","file-parsed"],setup(p,{expose:m,emit:d}){const t=d,c=I(null),{selectedFile:h,parsedData:_,headers:o,loading:C,error:n,handleFileSelect:s,clearFile:y,getPreview:i}=Re(),v=A(()=>i(Y)),b=async T=>{var l;const a=(l=T.target.files)==null?void 0:l[0];if(a)try{const w=await s(a);t("update:modelValue",a),t("file-parsed",w)}catch{t("update:modelValue",null)}};return m({clearFile:y,selectedFile:h,parsedData:_,headers:o}),(T,a)=>(x(),S("div",Ue,[r("div",je,[u(e(K),{class:"block text-sm font-semibold text-foreground"},{default:f(()=>[...a[1]||(a[1]=[V(" Select File ",-1),r("span",{class:"text-brand-red"},"*",-1)])]),_:1}),r("div",Pe,[r("input",{ref_key:"fileInputRef",ref:c,type:"file",accept:".csv,.xls,.xlsx",onChange:b,class:"hidden",disabled:e(C)},null,40,Ae),u(e(O),{onClick:a[0]||(a[0]=l=>{var w;return(w=c.value)==null?void 0:w.click()}),class:N(["border-2 border-dashed cursor-pointer transition-all hover:border-brand-primary/50 w-full",{"opacity-50 cursor-not-allowed":e(C),"border-border":!e(C)}])},{default:f(()=>[u(e(R),{class:"text-center py-8"},{default:f(()=>[a[2]||(a[2]=r("i",{class:"fa-solid fa-cloud-arrow-up text-4xl text-muted-foreground mb-3"},null,-1)),r("p",Ne,q(e(h)?e(h).name:"Click to upload or drag and drop"),1),a[3]||(a[3]=r("p",{class:"text-muted-foreground text-xs"},"CSV or Excel (.csv, .xls, .xlsx) up to 10MB",-1))]),_:1})]),_:1},8,["class"])]),e(n)?(x(),P(e(O),{key:0,class:"bg-red-50 border-red-200 mt-2"},{default:f(()=>[u(e(R),{class:"flex items-start gap-2 p-3"},{default:f(()=>[a[4]||(a[4]=r("i",{class:"fa-solid fa-exclamation-circle text-red-600 mt-0.5 text-sm"},null,-1)),r("span",ze,q(e(n)),1)]),_:1})]),_:1})):M("",!0)]),e(h)&&e(_)&&e(_).length>0?(x(),P(e(O),{key:0,class:"border-border"},{default:f(()=>[u(e(Q),null,{default:f(()=>[r("div",He,[u(e(B),null,{default:f(()=>[...a[5]||(a[5]=[V("File Preview",-1)])]),_:1}),u(e(ue),{text:`${e(_).length} rows`,theme:"gray",size:"small"},null,8,["text"])])]),_:1}),u(e(R),null,{default:f(()=>[r("div",Le,[r("table",Ke,[r("thead",null,[r("tr",Be,[(x(!0),S(U,null,j(e(o),l=>(x(),S("th",{key:l,class:"text-left p-2 font-bold text-muted-foreground uppercase tracking-wider"},q(l),1))),128))])]),r("tbody",null,[(x(!0),S(U,null,j(v.value,(l,w)=>(x(),S("tr",{key:w,class:"border-b border-border hover:bg-muted transition-colors"},[(x(!0),S(U,null,j(e(o),D=>(x(),S("td",{key:D,class:"p-2 text-muted-foreground"},q(l[D]||"-"),1))),128))]))),128))])])]),e(_).length>Y?(x(),S("p",We," Showing first "+q(Y)+" of "+q(e(_).length)+" rows ",1)):M("",!0)]),_:1})]),_:1})):M("",!0)]))}},Ye={contacts:{required:["name","email"],optional:["phone","company","address"]},leads:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays"]},opportunities:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays","stage","priority"]}};function G(p){return Ye[p]||{required:[],optional:[]}}function Ge(p,m=[]){const d=I({}),t=I({}),c=A(()=>{const i=G(p.value);return{required:i.required||[],optional:i.optional||[]}}),h=()=>{const i=c.value,v=[...i.required,...i.optional];d.value={},v.forEach(b=>{d.value[b]=""})},_=(i,v)=>{d.value[i]=v||"",o()},o=()=>{t.value={},c.value.required.forEach(v=>{(!d.value[v]||d.value[v].trim()==="")&&(t.value[v]="This field is required")})},C=A(()=>(o(),Object.keys(t.value).length===0)),n=i=>{const v={},b=c.value;return[...b.required,...b.optional].forEach(a=>{const l=d.value[a];if(l&&i[l]!==void 0){const w=i[l];a==="year"||a==="price"||a==="kilometers"||a==="stockDays"?v[a]=w?Number(w):null:v[a]=w?String(w).trim():""}}),v},s=i=>i.map((v,b)=>{try{return n(v)}catch(T){return console.error(`Error transforming row ${b+1}:`,T),null}}).filter(v=>v!==null),y=()=>{const i=Object.entries(d.value).filter(([v,b])=>b&&b.trim()!=="").map(([v,b])=>({field:v,fileColumn:b}));return{totalFields:c.value.required.length+c.value.optional.length,mappedFields:i.length,requiredMapped:c.value.required.filter(v=>d.value[v]).length,requiredTotal:c.value.required.length}};return m.length>0&&h(),{mapping:d,errors:t,availableFields:c,isValid:C,setMapping:_,validateMapping:o,transformRow:n,transformData:s,getMappingSummary:y,initializeMapping:h}}const Qe={class:"space-y-4"},Xe={class:"text-muted-foreground text-xs"},Ze={key:0,class:"space-y-4"},et={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},tt={key:0,class:"text-brand-red text-xs mt-1"},at={key:1,class:"space-y-4"},st={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},rt={class:"flex items-center justify-between"},nt={class:"text-foreground font-bold text-sm"},lt={__name:"ColumnMappingForm",props:{entityType:{type:String,required:!0,validator:p=>["contacts","leads","opportunities"].includes(p)},fileColumns:{type:Array,default:()=>[]},mapping:{type:Object,required:!0}},emits:["update:mapping"],setup(p,{expose:m,emit:d}){const t=p,c=d,{availableFields:h,errors:_,isValid:o,setMapping:C,validateMapping:n,getMappingSummary:s,initializeMapping:y}=Ge(A(()=>t.entityType),t.fileColumns);H([()=>t.fileColumns,()=>t.entityType],([T,a])=>{if(T&&T.length>0&&a&&Object.keys(t.mapping).length===0){y();const l=h.value,w=[...l.required,...l.optional],D={};w.forEach(W=>{D[W]=""}),c("update:mapping",D)}},{immediate:!0});const i=A(()=>s()),v=(T,a)=>{C(T,a),c("update:mapping",{...t.mapping,[T]:a})},b=T=>T.replace(/([A-Z])/g," $1").replace(/^./,a=>a.toUpperCase()).trim();return m({isValid:o,validateMapping:n}),(T,a)=>(x(),S("div",Qe,[u(e(O),{class:"border-border"},{default:f(()=>[u(e(Q),null,{default:f(()=>[u(e(B),null,{default:f(()=>[...a[0]||(a[0]=[V("Map Columns",-1)])]),_:1})]),_:1}),u(e(R),{class:"space-y-6"},{default:f(()=>[r("p",Xe,[V(" Map file columns to "+q(p.entityType)+" fields. ",1),a[1]||(a[1]=r("span",{class:"text-brand-red"},"*",-1)),a[2]||(a[2]=V(" Required. ",-1))]),e(h).required.length>0?(x(),S("div",Ze,[a[4]||(a[4]=r("h4",{class:"text-xs font-bold uppercase text-muted-foreground tracking-wider"},"Required Fields",-1)),r("div",et,[(x(!0),S(U,null,j(e(h).required,l=>(x(),S("div",{key:l,class:"space-y-2"},[u(e(K),{class:"block text-sm font-semibold text-foreground"},{default:f(()=>[V(q(b(l))+" ",1),a[3]||(a[3]=r("span",{class:"text-brand-red"},"*",-1))]),_:2},1024),u(e(Z),{"model-value":p.mapping[l]||"","onUpdate:modelValue":w=>v(l,w)},{default:f(()=>[u(e(ee),{class:N(["w-full h-10",{"border-brand-red":e(_)[l]}])},{default:f(()=>[u(e(te),{placeholder:"-- Select column --"})]),_:1},8,["class"]),u(e(ae),null,{default:f(()=>[(x(!0),S(U,null,j(p.fileColumns,w=>(x(),P(e(se),{key:w,value:w},{default:f(()=>[V(q(w),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"]),e(_)[l]?(x(),S("p",tt,q(e(_)[l]),1)):M("",!0)]))),128))])])):M("",!0),e(h).optional.length>0?(x(),S("div",at,[a[5]||(a[5]=r("h4",{class:"text-xs font-bold uppercase text-muted-foreground tracking-wider"},"Optional Fields",-1)),r("div",st,[(x(!0),S(U,null,j(e(h).optional,l=>(x(),S("div",{key:l,class:"space-y-2"},[u(e(K),{class:"block text-sm font-semibold text-foreground"},{default:f(()=>[V(q(b(l)),1)]),_:2},1024),u(e(Z),{"model-value":p.mapping[l]||"","onUpdate:modelValue":w=>v(l,w)},{default:f(()=>[u(e(ee),{class:"w-full h-10"},{default:f(()=>[u(e(te),{placeholder:"-- Select column --"})]),_:1}),u(e(ae),null,{default:f(()=>[(x(!0),S(U,null,j(p.fileColumns,w=>(x(),P(e(se),{key:w,value:w},{default:f(()=>[V(q(w),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["model-value","onUpdate:modelValue"])]))),128))])])):M("",!0),i.value?(x(),P(e(O),{key:2,class:"bg-muted border-border"},{default:f(()=>[u(e(R),null,{default:f(()=>[r("div",rt,[r("div",null,[a[6]||(a[6]=r("p",{class:"text-muted-foreground text-xs font-semibold uppercase tracking-wider mb-1"},"Mapping Progress",-1)),r("p",nt,q(i.value.mappedFields)+" / "+q(i.value.totalFields)+" fields mapped ",1)]),u(e(ue),{text:`${i.value.requiredMapped}/${i.value.requiredTotal} required`,theme:i.value.requiredMapped===i.value.requiredTotal?"green":"red",size:"small"},null,8,["text","theme"])])]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})]))}},ot={class:"w-full space-y-4"},it={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},ut={class:"flex items-center gap-3 mb-1"},dt={class:"w-10 h-10 rounded-lg bg-muted flex items-center justify-center border border-border shrink-0"},ct={class:"font-bold text-foreground text-sm"},pt={class:"text-muted-foreground text-xs"},mt={key:0},ft={key:1},gt={key:2,class:"flex items-center justify-end gap-3 pt-4 border-t border-border"},yt={key:0},vt={key:1},ht={class:"flex items-center justify-between"},bt={class:"text-muted-foreground text-xs"},xt={class:"text-xs text-orange-700"},_t={class:"text-muted-foreground text-xs"},kt={key:0,class:"text-orange-700 font-semibold"},wt={__name:"UploadTab",setup(p){const m=ne(),d=oe(),t=le(),c=ie(),h=I(null),_=I(null),o=I("contacts"),C=I(null),n=I(null),s=I([]),y=I({}),i=I(!1),v=I(0),b=I(0),T=I(0),a=I([]),l=I(!1),w=[{value:"contacts",label:"Contacts",description:"Import customer contacts",icon:"fa-solid fa-users"},{value:"leads",label:"Leads",description:"Import lead records",icon:"fa-solid fa-user-plus"},{value:"opportunities",label:"Opportunities",description:"Import opportunity records",icon:"fa-solid fa-briefcase"}],D=g=>{const $={},k=G(o.value);return[...k.required,...k.optional].forEach(E=>{const z=y.value[E];if(z&&g[z]!==void 0){const L=g[z];E==="year"||E==="price"||E==="kilometers"||E==="stockDays"?$[E]=L?Number(L):null:$[E]=L?String(L).trim():""}}),$},W=g=>g.map($=>{try{return D($)}catch(k){return console.error("Error transforming row:",k),null}}).filter($=>$!==null),pe=A(()=>o.value?(G(o.value).required||[]).every(k=>{const F=y.value[k];return F&&F.trim()!==""}):!1),X=A(()=>o.value&&n.value&&n.value.length>0&&pe.value),me=A(()=>b.value===0?0:Math.round(v.value/b.value*100)),fe=g=>{n.value=g.data,s.value=g.headers,y.value={},l.value=!1,a.value=[]},ge=()=>{var g;o.value="contacts",C.value=null,n.value=null,s.value=[],y.value={},(g=h.value)==null||g.clearFile(),l.value=!1,a.value=[]},ye=async()=>{if(X.value){i.value=!0,v.value=0,T.value=0,a.value=[],l.value=!1,b.value=n.value.length;try{const g=W(n.value),$=10;for(let k=0;k<g.length;k+=$){const F=g.slice(k,k+$);for(const E of F){try{await ve(E),T.value++}catch(z){a.value.push({row:k+F.indexOf(E)+1,error:z.message})}v.value++}}l.value=!0,setTimeout(()=>{const k=o.value==="contacts"?"contacts":o.value==="leads"?"open-leads":"open-opportunities";m.push({path:"/customers",query:{tab:k}})},2e3)}catch(g){console.error("Import error:",g),a.value.push({row:"all",error:g.message})}finally{i.value=!1}}},ve=async g=>{const $={name:g.name||"",email:g.email||"",phone:g.phone||"",company:g.company||null,address:g.address||"",initials:(g.name||"").split(" ").map(E=>E[0]).join("").toUpperCase()||"??",source:g.source||"Import",tags:[]},k=await d.addCustomer($);if(o.value==="contacts")return;const F={};if((g.brand||g.model||g.year||g.price)&&(F.brand=g.brand||"",F.model=g.model||"",F.year=g.year||null,F.price=g.price||null,F.requestMessage=g.requestMessage||"",F.requestType=g.requestType||"",F.source=g.source||"Import",F.dealership=g.dealership||"",F.channel=g.channel||"Email",F.fuelType=g.fuelType||"",F.gearType=g.gearType||"",F.kilometers=g.kilometers||null,F.stockDays=g.stockDays||null),o.value==="leads"){const E={customer:{id:k.id,name:k.name,initials:k.initials,email:k.email,phone:k.phone,address:k.address||""},status:"Open",stage:"Open Lead",priority:g.priority||"Normal",source:F.source||"Import",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};Object.keys(F).length>0&&(E.requestedCar=F),await t.createLead(E)}else if(o.value==="opportunities"){const E={customer:{id:k.id,name:k.name,initials:k.initials,email:k.email,phone:k.phone,address:k.address||""},stage:g.stage||"Qualified",priority:g.priority||"Normal",source:F.source||"Import",assignee:null,assigneeInitials:""};Object.keys(F).length>0&&(E.vehicle=F),await c.createOpportunity(E)}};return(g,$)=>(x(),S("div",ot,[u(e(O),{class:"border-border"},{default:f(()=>[u(e(Q),null,{default:f(()=>[u(e(B),null,{default:f(()=>[...$[2]||($[2]=[V("Select Source",-1)])]),_:1})]),_:1}),u(e(R),{class:"space-y-6"},{default:f(()=>[$[3]||($[3]=r("p",{class:"text-muted-foreground text-xs"}," Choose what type of data you want to import. ",-1)),r("div",it,[(x(),S(U,null,j(w,k=>u(e(O),{key:k.value,onClick:F=>o.value=k.value,class:N(["cursor-pointer transition-all p-1",o.value===k.value?"border-2 border-brand-primary bg-white shadow-md":"border-border hover:border-brand-primary/30 bg-white"])},{default:f(()=>[u(e(R),{class:"p-4"},{default:f(()=>[r("div",ut,[r("div",dt,[r("i",{class:N([k.icon,"text-lg",o.value===k.value?"text-brand-primary":"text-muted-foreground"])},null,2)]),r("div",null,[r("span",ct,q(k.label),1),r("p",pt,q(k.description),1)])])]),_:2},1024)]),_:2},1032,["onClick","class"])),64))])]),_:1})]),_:1}),o.value?(x(),S("div",mt,[u(Je,{ref_key:"fileUploadRef",ref:h,modelValue:C.value,"onUpdate:modelValue":$[0]||($[0]=k=>C.value=k),onFileParsed:fe},null,8,["modelValue"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),S("div",ft,[u(lt,{ref_key:"mappingFormRef",ref:_,"entity-type":o.value,"file-columns":s.value,mapping:y.value,"onUpdate:mapping":$[1]||($[1]=k=>y.value=k)},null,8,["entity-type","file-columns","mapping"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),S("div",gt,[u(e(re),{variant:"outline",size:"small",onClick:ge,disabled:i.value},{default:f(()=>[...$[4]||($[4]=[V(" Cancel ",-1)])]),_:1},8,["disabled"]),u(e(re),{variant:"primary",size:"small",onClick:ye,disabled:!X.value||i.value},{default:f(()=>[i.value?(x(),S("span",yt,"Importing...")):(x(),S("span",vt,"Import "+q(n.value.length)+" "+q(o.value),1))]),_:1},8,["disabled"])])):M("",!0),i.value?(x(),P(e(O),{key:3,class:"border-border"},{default:f(()=>[u(e(R),{class:"space-y-3"},{default:f(()=>[r("div",ht,[$[5]||($[5]=r("span",{class:"text-foreground text-xs font-bold"},"Importing...",-1)),r("span",bt,q(v.value)+" / "+q(b.value),1)]),u(e($e),{value:me.value,class:"h-1.5"},null,8,["value"]),a.value.length>0?(x(),P(e(O),{key:0,class:"bg-orange-50 border-orange-200"},{default:f(()=>[u(e(R),{class:"flex items-start gap-2"},{default:f(()=>[$[6]||($[6]=r("i",{class:"fa-solid fa-exclamation-triangle text-orange-600 mt-0.5 text-sm"},null,-1)),r("span",xt,q(a.value.length)+" errors encountered ",1)]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})):M("",!0),l.value?(x(),P(e(O),{key:4,class:"bg-green-50 border-green-200"},{default:f(()=>[u(e(R),{class:"space-y-2"},{default:f(()=>[$[7]||($[7]=r("div",{class:"flex items-center gap-2"},[r("i",{class:"fa-solid fa-check-circle text-green-600 text-base"}),r("span",{class:"font-bold text-foreground text-xs"},"Import Successful")],-1)),r("p",_t,[V(" Successfully imported "+q(T.value)+" "+q(o.value)+". ",1),a.value.length>0?(x(),S("span",kt,q(a.value.length)+" rows had errors. ",1)):M("",!0)])]),_:1})]),_:1})):M("",!0)]))}},de="project-ultra-integrations";function St(){try{const p=localStorage.getItem(de);return p?JSON.parse(p):[]}catch(p){return console.error("Failed to read integrations from localStorage:",p),[]}}function Ct(p){try{localStorage.setItem(de,JSON.stringify(p))}catch(m){console.error("Failed to save integrations to localStorage:",m)}}const ce=be("integrations",()=>{const p=[{id:"api",name:"API Integration",type:"api",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:"",webhookUrl:""},lastSync:null,syncHistory:[]},{id:"email",name:"Email Parsing",type:"email",enabled:!1,connected:!1,entityType:null,config:{emailAddress:"",imapServer:"",imapPort:"",username:"",password:""},lastSync:null,syncHistory:[]},{id:"portal",name:"Portal Integration",type:"portal",enabled:!1,connected:!1,entityType:null,config:{portalUrl:"",apiKey:"",username:""},lastSync:null,syncHistory:[]},{id:"zapier",name:"Zapier",type:"zapier",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:""},lastSync:null,syncHistory:[]},{id:"meta",name:"Meta (Facebook/Instagram)",type:"meta",enabled:!1,connected:!1,entityType:null,config:{appId:"",appSecret:"",accessToken:""},lastSync:null,syncHistory:[]},{id:"woice",name:"WOICE",type:"woice",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:""},lastSync:null,syncHistory:[]},{id:"webhook",name:"Custom Webhook",type:"webhook",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:"",secret:""},lastSync:null,syncHistory:[]}],m=St(),d=I(m.length>0?m:p);H(d,n=>{Ct(n)},{deep:!0});const t=n=>d.value.find(s=>s.id===n);return{integrations:d,getIntegration:t,toggleIntegration:n=>{const s=t(n);s&&(s.enabled=!s.enabled,s.enabled||(s.connected=!1))},updateConfig:(n,s)=>{const y=t(n);y&&(y.config={...y.config,...s})},setEntityType:(n,s)=>{const y=t(n);if(y){if(!["contacts","leads","opportunities"].includes(s))throw new Error("Invalid entity type. Must be contacts, leads, or opportunities");y.entityType=s}},testConnection:async n=>{const s=t(n);return s?new Promise(y=>{setTimeout(()=>{s.connected=!0,y(!0)},1e3)}):!1},addSyncHistory:(n,s)=>{const y=t(n);if(!y)return;const i={timestamp:new Date().toISOString(),entityType:y.entityType,recordsImported:s.recordsImported||0,errors:s.errors||[],conflicts:s.conflicts||[]};y.syncHistory.unshift(i),y.lastSync=i.timestamp,y.syncHistory.length>50&&(y.syncHistory=y.syncHistory.slice(0,50))}}}),$t={class:"px-4 py-4 flex flex-col gap-4"},Ft={class:"flex items-center justify-between gap-3"},It={class:"flex items-center gap-3 min-w-0"},qt={class:"w-8 h-8 rounded-lg bg-muted flex items-center justify-center border border-border shrink-0 group-hover:border-primary/30 transition-colors"},Tt={class:"min-w-0"},Et=["checked"],Mt={class:"space-y-2"},Vt={__name:"IntegrationCard",props:{integration:{type:Object,required:!0}},setup(p){var _;const m=p,d=ce(),t=I(((_=m.integration.config)==null?void 0:_.apiKey)||"");H(()=>{var o;return(o=m.integration.config)==null?void 0:o.apiKey},o=>{t.value=o||""});const c=()=>{var o;t.value!==(((o=m.integration.config)==null?void 0:o.apiKey)||"")&&d.updateConfig(m.integration.id,{apiKey:t.value})},h=()=>{d.toggleIntegration(m.integration.id)};return(o,C)=>(x(),P(e(O),{class:"rounded-xl border-border hover:shadow-mk-dashboard-card transition-all group overflow-hidden bg-surface"},{default:f(()=>[r("div",$t,[r("div",Ft,[r("div",It,[r("div",qt,[r("i",{class:N([p.integration.icon,"text-base text-primary"])},null,2)]),r("div",Tt,[C[2]||(C[2]=r("span",{class:"text-xs font-bold uppercase tracking-tighter text-muted-foreground block mb-0.5"},"Platform",-1)),u(e(B),{class:"text-foreground text-sm font-bold truncate leading-tight"},{default:f(()=>[V(q(p.integration.name),1)]),_:1})])]),r("label",{class:"inline-flex items-center cursor-pointer",onClick:C[0]||(C[0]=xe(()=>{},["stop"]))},[r("input",{type:"checkbox",checked:p.integration.enabled,onChange:h,class:"sr-only peer"},null,40,Et),r("div",{class:"relative w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-primary/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-primary",style:_e(p.integration.enabled?{backgroundColor:"var(--brand-primary, #0470e9)"}:{})},null,4)])]),r("div",Mt,[u(e(K),{class:"block text-sm font-semibold text-foreground"},{default:f(()=>[...C[3]||(C[3]=[V("API Key",-1)])]),_:1}),u(e(Fe),{modelValue:t.value,"onUpdate:modelValue":C[1]||(C[1]=n=>t.value=n),type:"password",placeholder:"Enter API Key",class:"w-full h-10 text-sm focus-visible:ring-brand-primary",onBlur:c,onKeyup:ke(c,["enter"])},null,8,["modelValue"])])])]),_:1}))}},Dt={class:"w-full"},Ot={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"},Rt={__name:"IntegrationsTab",setup(p){const m=ce(),d=A(()=>m.integrations.map(c=>({...c,icon:t(c.type)}))),t=c=>({api:"fa-solid fa-code",email:"fa-solid fa-envelope",portal:"fa-solid fa-globe",zapier:"fa-brands fa-zapier",meta:"fa-brands fa-meta",woice:"fa-solid fa-microphone",webhook:"fa-solid fa-link"})[c]||"fa-solid fa-plug";return(c,h)=>(x(),S("div",Dt,[r("div",Ot,[(x(!0),S(U,null,j(d.value,_=>(x(),P(Vt,{key:_.id,integration:_},null,8,["integration"]))),128))])]))}};function Ut(p,m="manual"){const t=I((()=>{try{return localStorage.getItem(p)||m}catch(c){return console.error("Failed to read tab from localStorage:",c),m}})());return H(t,c=>{try{localStorage.setItem(p,c)}catch(h){console.error("Failed to save tab to localStorage:",h)}}),{activeTab:t}}const jt={class:"page-container overflow-y-auto"},Pt={class:"px-4 md:px-8 py-8"},At={class:"max-w-6xl mx-auto"},Nt={class:"hidden md:inline whitespace-nowrap"},zt={key:0,class:"absolute bottom-0 left-0 right-0 h-[2px] bg-primary z-10"},Yt={__name:"AddNew",setup(p){const m=ne(),d=oe(),t=le(),c=ie(),h=I(null),{activeTab:_}=Ut("add-new-active-tab","manual");we(()=>{(!_.value||!["manual","upload","integrations"].includes(_.value))&&(_.value="manual")}),H(_,s=>{});const o=[{key:"manual",label:"Manual"},{key:"upload",label:"Upload"},{key:"integrations",label:"Integrations"}],C=s=>({manual:"fa-solid fa-pen",upload:"fa-solid fa-upload",integrations:"fa-solid fa-plug"})[s]||"fa-solid fa-circle",n=async s=>{try{const{contactMode:y,selectedContact:i,contactData:v,vehicleData:b,markAsLead:T,markAsOpportunity:a}=s;let l=i;if(y==="new"&&(l=await d.addCustomer({...v,initials:v.name.split(" ").map(w=>w[0]).join("").toUpperCase(),source:"Direct",tags:[],company:v.company||null})),T){const w={customer:{id:l.id,name:l.name,initials:l.initials,email:l.email,phone:l.phone,address:l.address||""},status:"Open",stage:"Open Lead",priority:"Normal",source:(b==null?void 0:b.source)||"Direct",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};b&&Object.keys(b).length>0&&(w.requestedCar=b);const D=await t.createLead(w);m.push({path:"/customers",query:{tab:"open-leads",highlight:`lead-${D.id}`}})}else if(a){const w={customer:{id:l.id,name:l.name,initials:l.initials,email:l.email,phone:l.phone,address:l.address||""},stage:"Qualified",priority:"Normal",source:(b==null?void 0:b.source)||"Direct",assignee:null,assigneeInitials:""};b&&Object.keys(b).length>0&&(w.vehicle=b);const D=await c.createOpportunity(w);m.push({path:"/customers",query:{tab:"open-opportunities",highlight:`opp-${D.id}`}})}else b&&Object.keys(b).length>0&&await d.addRequestedCar(l.id,b),m.push({path:"/customers",query:{tab:"contacts",highlight:`contact-${l.id}`}})}catch(y){console.error("Error saving data:",y),alert("Failed to save. Please try again."),h.value&&h.value.resetSubmitting()}};return(s,y)=>(x(),S("div",jt,[u(Ee,{title:"Add New Customer"}),r("div",Pt,[r("div",At,[u(e(Ie),{modelValue:e(_),"onUpdate:modelValue":y[0]||(y[0]=i=>Se(_)?_.value=i:null),class:"w-full"},{default:f(()=>[u(e(qe),{class:"w-full justify-start border-b border-border bg-transparent mb-8"},{default:f(()=>[(x(),S(U,null,j(o,i=>u(e(Te),{key:i.key,value:i.key,class:N(["flex items-center gap-2 text-sm font-medium transition-all relative bg-transparent outline-none",e(_)===i.key?"text-foreground":"text-muted-foreground hover:text-muted-foreground"])},{default:f(()=>[r("i",{class:N([C(i.key),"text-sm"])},null,2),r("span",Nt,q(i.label),1),e(_)===i.key?(x(),S("span",zt)):M("",!0)]),_:2},1032,["value","class"])),64))]),_:1}),u(e(J),{value:"manual"},{default:f(()=>[u(Me,{ref_key:"manualTabRef",ref:h,onSubmit:n},null,512)]),_:1}),u(e(J),{value:"upload"},{default:f(()=>[u(wt)]),_:1}),u(e(J),{value:"integrations"},{default:f(()=>[u(Rt)]),_:1})]),_:1},8,["modelValue"])])])]))}};export{Yt as default};
