import{d as u,o as a,F as ae,i as ie,n as B,e,_ as Qe,r as I,g as D,s as J,w as fe,D as X,p as z,T as rt,E as wt,c as q,l as de,t as $,x as G,G as le,H as Te,k as U,I as ze,J as Ee,K as _,y as M,L as se,M as Ye,u as Ve,m as Ne,v as me,N as kt,O as je,j as tt,h as Ke,C as Ge,P as Ue,Q as Ct,R as he,S as St,U as We,V as Pe,W as $t,X as At,Y as st}from"./index-4t0q-YoU.js";import{u as Je}from"./opportunities-DBOjrln3.js";import{u as Xe}from"./users-B2Q7ljfB.js";import{Q as Ie,i as Fe}from"./index-B_XAiWWB.js";import{u as we}from"./settings-Buo-UMP2.js";import{y as Dt}from"./components-DlDjID9_.js";import{_ as Tt,g as Lt,a as It,b as Ot,i as qt,c as Nt,d as Rt,e as Mt,f as ot}from"./ComingSoonModal-BiUL9UwQ.js";import{f as dt,a as Le,b as qe,g as ut,c as ct}from"./formatters-C-gGI16G.js";import{_ as ke}from"./ModalShell-CCJo1Yaq.js";import{_ as Ft}from"./CreateEventModal-BR-2QR2U.js";import{_ as Vt,a as Bt}from"./EditEventModal-BU-wUoDs.js";import{_ as Ut}from"./ReassignUserModal-C2VIE97n.js";import"./index-Ct-3v9pQ-BMtYOyzV.js";import"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-Dd2SCa0l.js";const Wt={class:"flex items-center bg-white border border-gray-200 rounded-full p-0.5 shadow-sm"},Et=["onClick"],pt={__name:"ViewToggle",props:{view:{type:String,required:!0},options:{type:Array,required:!0,validator:s=>s.every(k=>k.value&&k.icon&&k.label)}},emits:["update:view"],setup(s){return(k,t)=>(a(),u("div",Wt,[(a(!0),u(ae,null,ie(s.options,n=>(a(),u("button",{key:n.value,onClick:d=>k.$emit("update:view",n.value),class:B(["h-9 w-9 flex items-center justify-center rounded-full transition-colors",s.view===n.value?"bg-indigo-600 text-white shadow-md":"text-gray-400 hover:bg-gray-50"])},[e("i",{class:B([n.icon,"text-sm"])},null,2)],10,Et))),128))]))}},jt={class:"flex items-center gap-2"},Pt={key:0,class:"flex gap-2"},Ht={class:"relative ml-auto",ref:"sortContainer"},Qt={key:0,class:"absolute -top-0.5 -right-0.5 w-2 h-2 bg-blue-600 rounded-full border-2 border-white"},zt={key:0,class:"absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 overflow-hidden"},Yt={__name:"TaskFilters",props:{typeFilter:{type:String,default:"all"},sortOption:{type:String,default:"recent-first"},showTypeFilter:{type:Boolean,default:!0},showClosed:{type:Boolean,default:!1}},emits:["filter-change","sort-change","toggle-closed"],setup(s,{emit:k}){const t=k,n=I(!1),d=()=>{n.value=!n.value},o=c=>{n.value=!1,t("sort-change",c)},p={mounted(c,x){c.clickOutsideEvent=b=>{c===b.target||c.contains(b.target)||x.value(b)},document.addEventListener("click",c.clickOutsideEvent)},unmounted(c){document.removeEventListener("click",c.clickOutsideEvent)}};return(c,x)=>(a(),u("div",jt,[s.showTypeFilter?(a(),u("div",Pt,[e("button",{onClick:x[0]||(x[0]=b=>c.$emit("filter-change","all")),class:B(["text-xs font-medium px-3 py-1.5 rounded-md border transition-colors",s.typeFilter==="all"?"bg-blue-600 text-white border-blue-600":"bg-white hover:bg-gray-50 border-gray-200 text-gray-700"])}," All ",2),e("button",{onClick:x[1]||(x[1]=b=>c.$emit("filter-change","lead")),class:B(["text-xs font-medium px-3 py-1.5 rounded-md border transition-colors",s.typeFilter==="lead"?"bg-blue-600 text-white border-blue-600":"bg-white hover:bg-gray-50 border-gray-200 text-gray-700"])}," Leads ",2),e("button",{onClick:x[2]||(x[2]=b=>c.$emit("filter-change","opportunity")),class:B(["text-xs font-medium px-3 py-1.5 rounded-md border transition-colors",s.typeFilter==="opportunity"?"bg-blue-600 text-white border-blue-600":"bg-white hover:bg-gray-50 border-gray-200 text-gray-700"])}," Opportunities ",2)])):D("",!0),e("div",Ht,[e("button",{onClick:fe(d,["stop"]),class:"relative w-8 h-8 flex items-center justify-center rounded-md border border-gray-200 hover:bg-gray-50 transition-colors text-gray-600 hover:text-gray-900"},[x[7]||(x[7]=e("i",{class:"fa-solid fa-arrow-down-wide-short text-sm"},null,-1)),s.sortOption&&s.sortOption!=="recent-first"?(a(),u("span",Qt)):D("",!0)]),J(rt,{name:"dropdown"},{default:X(()=>[n.value?z((a(),u("div",zt,[e("button",{onClick:x[3]||(x[3]=b=>o("recent-first")),class:B(["w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2",{"bg-blue-50 text-blue-700":s.sortOption==="recent-first"}])},[e("i",{class:B(["fa-solid fa-check text-[10px] w-3",s.sortOption==="recent-first"?"opacity-100":"opacity-0"])},null,2),x[8]||(x[8]=e("span",null,"Most Recent First",-1))],2),s.typeFilter==="lead"?(a(),u("button",{key:0,onClick:x[4]||(x[4]=b=>o("urgent-first")),class:B(["w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2",{"bg-blue-50 text-blue-700":s.sortOption==="urgent-first"}])},[e("i",{class:B(["fa-solid fa-check text-[10px] w-3",s.sortOption==="urgent-first"?"opacity-100":"opacity-0"])},null,2),x[9]||(x[9]=e("span",null,"Urgent first",-1))],2)):D("",!0),e("button",{onClick:x[5]||(x[5]=b=>o("assigned-to-me")),class:B(["w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2",{"bg-blue-50 text-blue-700":s.sortOption==="assigned-to-me"}])},[e("i",{class:B(["fa-solid fa-check text-[10px] w-3",s.sortOption==="assigned-to-me"?"opacity-100":"opacity-0"])},null,2),x[10]||(x[10]=e("span",null,"Assigned to me",-1))],2),e("button",{onClick:x[6]||(x[6]=b=>o("assigned-to-my-team")),class:B(["w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2",{"bg-blue-50 text-blue-700":s.sortOption==="assigned-to-my-team"}])},[e("i",{class:B(["fa-solid fa-check text-[10px] w-3",s.sortOption==="assigned-to-my-team"?"opacity-100":"opacity-0"])},null,2),x[11]||(x[11]=e("span",null,"Assigned to my team",-1))],2)])),[[p,()=>n.value=!1]]):D("",!0)]),_:1})],512)]))}},Kt=Qe(Yt,[["__scopeId","data-v-4c08e987"]]);function mt(s,k,t){const n=we(),d=n.getSetting("urgencyWeights")||{intent:40,behavioral:35,temporal:25},o=n.getSetting("urgencyThresholds")||{hot:80,warm:50,standard:20},p=wt.filter(i=>i.leadId===s.id)||[],c=Gt(s,p),x=Jt(s,p),b=Xt(s),S=Zt(s),y=d.intent+d.behavioral+d.temporal,m={intent:d.intent/y*100,behavioral:d.behavioral/y*100,temporal:d.temporal/y*100},v=c/40*m.intent,w=x/35*m.behavioral,A=b/25*m.temporal,K=Math.min(100,Math.max(0,v+w+A+S));let T="COLD";return K>=o.hot?T="HOT":K>=o.warm?T="WARM":K>=o.standard&&(T="STANDARD"),{score:Math.round(K*10)/10,level:T,breakdown:{intent:Math.round(c*10)/10,behavioral:Math.round(x*10)/10,temporal:Math.round(b*10)/10,quality:Math.round(S*10)/10,total:Math.round(K*10)/10}}}function Gt(s,k){var n;let t=0;return(s.requestType==="Test Drive"||((n=s.scheduledAppointment)==null?void 0:n.type)==="test-drive"||k.some(d=>d.type==="test-drive"||d.type==="appointment"))&&(t=Math.max(t,40)),k.some(d=>d.type==="financing")&&(t=Math.max(t,35)),k.some(d=>d.type==="tradein")&&(t=Math.max(t,30)),(s.source==="Walk-in"||k.some(d=>{var o,p,c;return((o=d.content)==null?void 0:o.toLowerCase().includes("location"))||((p=d.content)==null?void 0:p.toLowerCase().includes("dealership"))||((c=d.content)==null?void 0:c.toLowerCase().includes("visit"))}))&&(t=Math.max(t,25)),s.requestedCar&&(s.requestedCar.requestMessage||k.some(d=>{var o,p;return((o=d.content)==null?void 0:o.toLowerCase().includes("configur"))||d.type==="attachment"&&((p=d.fileName)==null?void 0:p.toLowerCase().includes("config"))}))&&(t=Math.max(t,20)),k.some(d=>{var p;const o=((p=d.content)==null?void 0:p.toLowerCase())||"";return o.includes("compare")||o.includes("versus")||o.includes("vs")||o.includes("alternative")})&&(t=Math.max(t,15)),Math.min(t,40)}function Jt(s,k){let t=0;const n=new Set(k.map(c=>{if(!c.timestamp)return null;const x=new Date(c.timestamp);return`${x.getFullYear()}-${x.getMonth()}-${x.getDate()}`}).filter(Boolean)),d=Math.min(n.size*10,35);t+=d,s.contactAttempts&&s.contactAttempts.length>1&&(t+=20);const o=k.reduce((c,x)=>{var b;return c+(((b=x.content)==null?void 0:b.length)||0)},0),p=Math.min(Math.floor(o/50),25);return t+=p,k.some(c=>{var x,b,S;return c.type==="attachment"&&(((x=c.fileName)==null?void 0:x.toLowerCase().includes("brochure"))||((b=c.fileName)==null?void 0:b.toLowerCase().includes("spec"))||((S=c.fileName)==null?void 0:S.toLowerCase().includes("pdf")))})&&(t+=15),Math.min(t,35)}function Xt(s){let k=0;if(!s.createdAt)return 0;const t=new Date,n=new Date(s.createdAt),d=(t.getTime()-n.getTime())/(1e3*60*60);d<2?k+=25:d<24?k+=15:d<48?k+=5:k-=10;const o=n.getDay(),p=n.getHours();if((o===0||o===6||p<9||p>17)&&(k+=10),s.contactAttempts&&s.contactAttempts.length===3&&(k+=50),s.lastActivity){const c=new Date(s.lastActivity);(t.getTime()-c.getTime())/(1e3*60*60*24)>3&&(k+=20)}return Math.min(Math.max(k,0),25)}function Zt(s){var t,n,d,o,p,c,x;let k=0;return(t=s.customer)!=null&&t.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.customer.email)&&(k+=10),(n=s.customer)!=null&&n.phone&&/^\+?[\d\s\-()]+$/.test(s.customer.phone)&&s.customer.phone.length>=10&&(k+=10),(d=s.customer)!=null&&d.name&&((o=s.customer)!=null&&o.email)&&((p=s.customer)!=null&&p.phone)&&((c=s.customer)!=null&&c.address)&&(k+=5),(s.isDuplicate||s.isDisqualified||!((x=s.customer)!=null&&x.name))&&(k-=20),k}function yt(s){switch(s){case"HOT":return"ðŸ”¥";case"WARM":return"ðŸŸ¡";case"STANDARD":return"ðŸŸ¢";case"COLD":return"âšª";default:return"âšª"}}function gt(s){switch(s){case"HOT":return"bg-red-50 text-red-700 border-red-200";case"WARM":return"bg-orange-50 text-orange-700 border-orange-200";case"STANDARD":return"bg-green-50 text-green-700 border-green-200";case"COLD":return"bg-gray-50 text-gray-700 border-gray-200";default:return"bg-gray-50 text-gray-700 border-gray-200"}}const _t={class:"bg-white border-r border-gray-200 flex flex-col shrink-0 w-full lg:w-80 h-full"},es={class:"page-header shrink-0"},ts={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},ss={class:"page-header-title"},os={class:"flex items-center gap-3"},ls={class:"px-5 py-3"},ns={class:"relative"},as=["placeholder"],is={key:0,class:"px-5 pb-3"},rs=["onClick"],ds={key:0,class:"absolute right-3 top-10 w-40 bg-white border border-gray-200 rounded-sm shadow-xl z-50 overflow-hidden animate-fade-in"},us={class:"p-3 pl-3"},cs={class:"flex items-start justify-between mb-2"},ps={class:"flex items-center gap-3"},ms={class:"min-w-0"},ys={class:"flex items-center gap-2"},gs={class:"font-bold text-sm text-gray-900 truncate"},fs={class:"text-[10px] text-gray-400 truncate"},vs=["onClick"],bs={class:"flex items-center gap-2 mb-3"},xs={key:1,class:"text-xs px-1.5 py-0.5 rounded font-semibold border bg-red-100 text-red-700 border-red-200"},hs={class:"grid grid-cols-2 gap-2 bg-gray-50 rounded p-2 mb-2"},ws={class:"min-w-0"},ks={class:"text-xs font-medium text-gray-700 truncate"},Cs={class:"min-w-0"},Ss={class:"text-xs text-gray-500 truncate"},$s={class:"flex items-center justify-between"},As={class:"text-[10px] text-gray-400"},Ds={class:"text-gray-600 font-medium"},Ts={class:"text-[10px] text-gray-400 font-medium"},Ls={__name:"TasksList",props:{title:{type:String,required:!0},items:{type:Array,required:!0},selectedId:{type:[Number,String],default:null},selectedClass:{type:[String,Function],default:"bg-white border-2 border-blue-500 shadow-md"},unselectedClass:{type:[String,Function],default:"bg-white border border-gray-200 hover:border-blue-300"},searchPlaceholder:{type:String,default:"Search..."},showMenu:{type:Boolean,default:!0},openMenuId:{type:[Number,String],default:null},getName:{type:Function,required:!0},getInitials:{type:Function,required:!0},getVehicleInfo:{type:Function,required:!0},avatarClass:{type:Function,default:()=>"bg-orange-100 text-orange-600"},typeFilter:{type:String,default:"all"},showTypeFilter:{type:Boolean,default:!1},showMobileClose:{type:Boolean,default:!1},viewMode:{type:String,default:"card"}},emits:["select","menu-click","menu-close","filter-change","sort-change","close","view-change"],setup(s,{emit:k}){const t={mounted(v,w){v.clickOutsideEvent=A=>{v===A.target||v.contains(A.target)||w.value()},document.addEventListener("click",v.clickOutsideEvent)},unmounted(v){document.removeEventListener("click",v.clickOutsideEvent)}},n=s,d=k;we();const o=I(""),p=I("none"),c=q(()=>{let v=n.items;if(n.typeFilter&&n.typeFilter!=="all"&&(v=v.filter(w=>w.type===n.typeFilter)),o.value){const w=o.value.toLowerCase();v=v.filter(A=>{const K=n.getName(A).toLowerCase(),T=n.getVehicleInfo(A).toLowerCase();return K.includes(w)||T.includes(w)})}return v}),x=v=>{const w=v.compositeId||`${v.type||"task"}-${v.id}`||v.id;return n.selectedId===w},b=v=>{p.value=v,d("sort-change",v)},S=v=>{const w=v.displayStage||v.stage;return w?ze(w,v.type||"opportunity"):"bg-gray-100 text-gray-700"},y=I(null),m=I(null);return de(()=>n.selectedId,async v=>{if(v&&m.value){await Ee();try{m.value&&m.value.parentNode&&m.value.scrollIntoView({behavior:"smooth",block:"nearest"})}catch(w){console.debug("Could not scroll to selected item:",w)}}},{immediate:!0}),de(c,async()=>{n.selectedId&&m.value&&(await Ee(),setTimeout(()=>{try{m.value&&m.value.parentNode&&m.value.scrollIntoView({behavior:"smooth",block:"nearest"})}catch(v){console.debug("Could not scroll to selected item:",v)}},100))},{immediate:!0}),(v,w)=>(a(),u("div",_t,[e("header",es,[e("div",ts,[e("div",null,[e("h1",ss,$(s.title),1)]),e("div",os,[s.viewMode?(a(),G(pt,{key:0,view:s.viewMode,options:[{value:"card",icon:"fa-solid fa-table",label:"Cards"},{value:"table",icon:"fa-solid fa-list",label:"Table"}],"onUpdate:view":w[0]||(w[0]=A=>v.$emit("view-change",A))},null,8,["view"])):D("",!0)])])]),e("div",ls,[e("div",ns,[w[3]||(w[3]=e("i",{class:"fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-sm"},null,-1)),z(e("input",{"onUpdate:modelValue":w[1]||(w[1]=A=>o.value=A),type:"text",placeholder:s.searchPlaceholder,class:"w-full bg-gray-50 border border-gray-200 rounded-lg pl-9 pr-3 py-2 text-sm"},null,8,as),[[le,o.value]])])]),s.showTypeFilter?(a(),u("div",is,[J(Kt,{"type-filter":s.typeFilter,"sort-option":p.value,"show-type-filter":!0,onFilterChange:w[2]||(w[2]=A=>v.$emit("filter-change",A)),onSortChange:b},null,8,["type-filter","sort-option"])])):D("",!0),e("div",{ref_key:"scrollContainer",ref:y,class:"flex-1 overflow-y-auto px-5 space-y-3 pt-4 pb-6 scrollbar-hide bg-gray-50/50"},[(a(!0),u(ae,null,ie(c.value,A=>(a(),u("div",{key:A.compositeId||`${A.type||"task"}-${A.id}`,ref_for:!0,ref:K=>{x(A)&&(m.value=K)},onClick:K=>v.$emit("select",A.compositeId||`${A.type||"task"}-${A.id}`||A.id),class:B(["bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer relative group transition-all hover:shadow-md",[x(A)?typeof s.selectedClass=="function"?s.selectedClass(A):s.selectedClass:typeof s.unselectedClass=="function"?s.unselectedClass(A):s.unselectedClass]])},[e("div",{class:B(["absolute top-0 bottom-0 left-0 w-1.5",A.type==="lead"?"bg-blue-500":"bg-purple-500"])},null,2),s.openMenuId===A.id&&s.showMenu?z((a(),u("div",ds,[Te(v.$slots,"menu",{item:A},void 0,!0)])),[[t,()=>v.$emit("menu-close")]]):D("",!0),e("div",us,[e("div",cs,[e("div",ps,[e("div",{class:B(["w-8 h-8 rounded bg-gray-50 text-gray-600 font-bold flex items-center justify-center text-xs border border-gray-200 shrink-0",s.avatarClass(A)])},$(s.getInitials(A)),3),e("div",ms,[e("div",ys,[e("span",gs,$(s.getName(A)),1)]),e("div",fs,[Te(v.$slots,"location",{item:A},void 0,!0)])])]),s.showMenu?(a(),u("button",{key:0,onClick:fe(K=>v.$emit("menu-click",A.id),["stop"]),class:"w-6 h-6 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-sm transition-all shrink-0"},[...w[4]||(w[4]=[e("i",{class:"fa-solid fa-ellipsis-vertical text-sm"},null,-1)])],8,vs)):D("",!0)]),e("div",bs,[e("span",{class:B(["text-xs px-1.5 py-0.5 rounded font-semibold border",A.type==="lead"?"bg-blue-100 text-blue-700 border-blue-200":"bg-purple-100 text-purple-700 border-purple-200"])},$(A.type==="lead"?"Lead":"Opportunity"),3),A.displayStage||A.stage?(a(),u("span",{key:0,class:B(["text-xs px-1.5 py-0.5 rounded font-semibold border",S(A)])},$(A.displayStage||A.stage),3)):D("",!0),A.priority==="Hot"?(a(),u("span",xs," Hot ")):D("",!0)]),e("div",hs,[e("div",ws,[w[5]||(w[5]=e("div",{class:"text-[9px] text-gray-400 uppercase"},"Vehicle",-1)),e("div",ks,$(s.getVehicleInfo(A)),1)]),e("div",Cs,[w[6]||(w[6]=e("div",{class:"text-[9px] text-gray-400 uppercase"},"Status",-1)),e("div",Ss,[Te(v.$slots,"vehicle-status",{item:A},void 0,!0)])])]),e("div",$s,[e("div",As,[w[7]||(w[7]=U(" Owned by ",-1)),e("span",Ds,[Te(v.$slots,"owner",{item:A},void 0,!0)])]),e("div",Ts,[Te(v.$slots,"dates",{item:A},void 0,!0)])])])],10,rs))),128))],512)]))}},Is=Qe(Ls,[["__scopeId","data-v-06b7d279"]]),Os={class:"page-container flex-1 flex flex-col overflow-hidden min-w-0"},qs={class:"page-header shrink-0"},Ns={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},Rs={class:"flex items-center gap-3"},Ms={class:"flex-1 overflow-y-auto p-4 md:p-8"},Fs={class:"table-wrapper w-full"},Vs={__name:"TasksTableView",props:{tasks:{type:Array,required:!0},currentTaskId:{type:String,default:null},highlightId:{type:String,default:null},typeFilter:{type:String,default:"all"},sortOption:{type:String,default:"recent-first"},showTypeFilter:{type:Boolean,default:!0},showClosed:{type:Boolean,default:!1},showMobileClose:{type:Boolean,default:!1},openMenuId:{type:[Number,String],default:null},searchPlaceholder:{type:String,default:"Search tasks..."},getVehicleType:{type:Function,required:!0},getVehicleTypeBadgeClass:{type:Function,required:!0},getOwnerInfo:{type:Function,required:!0},getStageBadgeClass:{type:Function,required:!0},viewMode:{type:String,default:"table"}},emits:["select","menu-click","menu-close","filter-change","sort-change","toggle-closed","reassign","close","view-change"],setup(s,{emit:k}){const t=s,n=k,d=we();I("");const o=I({pageIndex:0,pageSize:10}),p=I(""),c=I([]),x=I([{id:"status",value:["Valid","Qualified","Open Lead"],operator:"in"},{id:"type",value:"lead",operator:"eq"},{id:"source",value:["Marketing","Website"],operator:"in"},{id:"assignee",value:void 0},{id:"urgencyLevel",value:void 0}]);I({});const b=q(()=>{const i=[];t.showTypeFilter&&i.push({key:"type",label:"Type",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"lead",label:"Lead"},{value:"opportunity",label:"Opportunity"}],aiHint:"Lead or Opportunity type",pinned:!0}),i.push({key:"status",label:"Status",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:[{value:"Valid",label:"Valid"},{value:"Not valid",label:"Not valid"},{value:"Qualified",label:"Qualified"},{value:"In Negotiation",label:"In Negotiation"},{value:"Won",label:"Won"},{value:"Lost",label:"Lost"},{value:"Not interested",label:"Not interested"},{value:"Open",label:"Open"},{value:"Open Lead",label:"Open Lead"}],aiHint:"Lead status or opportunity stage",pinned:!0}),i.push({key:"priority",label:"Priority",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"Hot",label:"High"},{value:"Normal",label:"Normal"}],aiHint:"Task priority level"}),t.typeFilter==="lead"&&i.push({key:"urgencyLevel",label:"Urgency",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"HOT",label:"ðŸ”¥ Hot"},{value:"WARM",label:"ðŸŸ¡ Warm"},{value:"STANDARD",label:"ðŸŸ¢ Standard"},{value:"COLD",label:"âšª Cold"}],aiHint:"Lead urgency level based on scoring",pinned:!0}),i.push({key:"source",label:"Source",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:[{value:"Marketing",label:"Marketing"},{value:"Website",label:"Website"},{value:"Referral",label:"Referral"},{value:"Walk-in",label:"Walk-in"}],aiHint:"Lead or opportunity source",pinned:!0});const g=[...new Set(t.tasks.map(F=>F.assignee).filter(Boolean))];g.length>0&&i.push({key:"assignee",label:"Assignee",type:"select",operators:[{value:"eq",label:"is"}],options:g.map(F=>({value:F,label:F})),aiHint:"Person assigned to the task",pinned:!0});const f=[...new Set(t.tasks.map(F=>{const Y=F.type==="lead"?F.requestedCar:F.vehicle;return Y==null?void 0:Y.brand}).filter(Boolean))];return f.length>0&&i.push({key:"requestedCarBrand",label:"Requested car",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:f.map(F=>({value:F,label:F})),aiHint:"Car brand requested by customer"}),i.push({key:"createdAt",label:"Creation date",type:"daterange",operators:[{value:"between",label:"is between"},{value:"gte",label:"is after"},{value:"lte",label:"is before"}],aiHint:"Date when the task was created"}),i}),S=q(()=>t.tasks),y=i=>i.compositeId===t.currentTaskId||i.compositeId===t.highlightId,m=i=>i.type==="lead"?i.requestedCar?`${i.requestedCar.brand} ${i.requestedCar.model}`:"No vehicle specified":i.vehicle?`${i.vehicle.brand} ${i.vehicle.model}`:"No vehicle specified",v=i=>{const g=i.type==="lead"?i.requestedCar:i.vehicle;if(!g)return{status:"N/A",class:"bg-gray-100 text-gray-700"};const f=g.stockDays!==void 0&&g.stockDays!==null;return{status:f?"In Stock":"Out of Stock",class:f?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}},w=i=>{var g;return i.type==="lead"?((g=i.requestedCar)==null?void 0:g.requestType)||i.requestType||"N/A":i.requestType||"Opportunity"},A=q(()=>[{accessorKey:"type",header:"Task type",meta:{title:"Task type",onOpen:i=>K(i.original)},cell:({row:i})=>{const g=i.original,f=g.type==="lead"?"bg-blue-50 text-blue-700":"bg-purple-50 text-purple-700";return _("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${f}`},g.type==="lead"?"Lead":"Opportunity")}},{accessorKey:"customer",header:"Customer",meta:{title:"Customer"},cell:({row:i})=>{const g=i.original;return _("div",{class:"flex items-center gap-2 md:gap-3"},[_("div",{class:`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold shrink-0 ${g.type==="lead"?"bg-orange-100 text-orange-600":"bg-purple-100 text-purple-600"}`},g.customer.initials),_("div",{class:"min-w-0"},[_("div",{class:"text-sm font-semibold text-gray-900 truncate max-w-[120px] md:max-w-none"},g.customer.name),_("div",{class:"text-xs text-gray-500 truncate hidden sm:block"},g.customer.email)])])}},{accessorKey:"car",header:"Car",meta:{title:"Car"},cell:({row:i})=>{const g=i.original,f=m(g);return f==="No vehicle specified"?_("span",{class:"text-sm text-gray-400"},"N/A"):_("div",{class:"flex items-center gap-2"},[_("i",{class:"fa-brands fa-volkswagen text-gray-400 text-sm"}),_("span",{class:"text-sm font-medium text-gray-900 truncate max-w-[120px]"},f)])}},{accessorKey:"carStatus",header:"Car status",meta:{title:"Car status"},cell:({row:i})=>{const g=i.original,f=v(g);return _("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${f.class}`},f.status)}},{accessorKey:"requestType",header:"Request type",meta:{title:"Request type"},cell:({row:i})=>{const g=i.original,f=w(g);return _("span",{class:"text-sm text-gray-600"},f)}},{accessorKey:"source",header:"Source",meta:{title:"Source"},cell:({row:i})=>{const g=i.original;return _("span",{class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-700"},g.source||"N/A")}},{accessorKey:"assignee",header:"Assignee",meta:{title:"Assignee"},cell:({row:i})=>{const g=i.original,f=t.getOwnerInfo(g);return _("div",{class:"flex items-center gap-2"},[_("div",{class:"w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-600 shrink-0"},f.initials),_("span",{class:"text-sm text-gray-600 truncate max-w-[80px]"},f.name)])}},{accessorKey:"status",header:"Status",meta:{title:"Status"},cell:({row:i})=>{const g=i.original,f=g.type==="lead"?g.status:g.displayStage||g.stage,F=t.getStageBadgeClass(f);return _("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${F}`},f)}},...t.typeFilter==="lead"&&d.getSetting("urgencyEnabled")!==!1?[{id:"urgencyLevel",accessorKey:"urgencyLevel",header:"Urgency",meta:{title:"Urgency"},cell:({row:i})=>{const g=i.original;if(g.type!=="lead")return _("span",{class:"text-sm text-gray-400"},"â€”");let f=g.urgencyLevel;f||(f=mt(g).level);const F=gt(f),Y=yt(f);return _("span",{class:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border ${F}`},[_("span",{},Y),_("span",{},f)])}}]:[],{id:"actions",header:"",meta:{title:"Actions"},cell:({row:i})=>{const g=i.original;return _("button",{class:"text-gray-400 hover:text-gray-600",onClick:f=>{f.stopPropagation(),n("menu-click",g.id)}},[_("i",{class:"fa-solid fa-ellipsis-vertical"})])}}]),K=i=>{n("select",i.compositeId)},T=q(()=>({class:{tr:i=>{const g="cursor-pointer hover:bg-gray-50 transition-colors",f=i.original;return y(f)?`${g} bg-blue-50 border-l-4 border-l-blue-500`:g}}}));return de(()=>[t.highlightId,t.tasks],async([i])=>{i&&t.tasks.length>0&&(await Ee(),setTimeout(()=>{var g,f;try{const F=document.querySelector(".table-wrapper");if(!F)return;const Y=t.tasks.find(O=>O.compositeId===i);if(!Y)return;const C=(g=Y.customer)==null?void 0:g.name;if(C){const O=F.querySelectorAll('tbody tr, [role="row"]');for(const P of O)if(P&&P.parentNode&&((f=P.textContent)!=null&&f.includes(C))){P.scrollIntoView({behavior:"smooth",block:"nearest"});break}}}catch(F){console.debug("Could not scroll to highlighted row:",F)}},500))},{immediate:!0}),(i,g)=>(a(),u("div",Os,[e("header",qs,[e("div",Ns,[g[7]||(g[7]=e("div",null,[e("h1",{class:"page-header-title"},"Tasks")],-1)),e("div",Rs,[e("button",{onClick:g[0]||(g[0]=f=>i.$emit("toggle-closed",!s.showClosed)),class:"flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium hover:bg-gray-50 transition-colors"},[...g[6]||(g[6]=[e("i",{class:"fa-solid fa-eye-slash"},null,-1),e("span",{class:"hidden sm:inline"},"Show Closed",-1)])]),J(pt,{view:s.viewMode,options:[{value:"card",icon:"fa-solid fa-table",label:"Cards"},{value:"table",icon:"fa-solid fa-list",label:"Table"}],"onUpdate:view":g[1]||(g[1]=f=>i.$emit("view-change",f))},null,8,["view"])])])]),e("div",Ms,[e("div",Fs,[J(M(Dt),{data:S.value,columns:A.value,meta:T.value,onRowClick:K,columnFiltersOptions:{filterDefs:b.value},pagination:o.value,"onUpdate:pagination":g[2]||(g[2]=f=>o.value=f),globalFilter:p.value,"onUpdate:globalFilter":g[3]||(g[3]=f=>p.value=f),sorting:c.value,"onUpdate:sorting":g[4]||(g[4]=f=>c.value=f),columnFilters:x.value,"onUpdate:columnFilters":g[5]||(g[5]=f=>x.value=f),paginationOptions:{rowCount:S.value.length},globalFilterOptions:{debounce:300,placeholder:"Q Search or ask a question"}},{"empty-state":X(()=>[...g[8]||(g[8]=[e("div",{class:"empty-state"},[e("i",{class:"fa-solid fa-tasks empty-state-icon"}),e("p",{class:"empty-state-text"},"No tasks found")],-1)])]),_:1},8,["data","columns","meta","columnFiltersOptions","pagination","globalFilter","sorting","columnFilters","paginationOptions"])])])]))}},lt={[se.NEW]:{primaryAction:{key:"call-to-verify",title:"Call to Verify Contact Details",description:"Begin lead qualification by verifying customer contact information",label:"Call to Verify",icon:"fa-solid fa-phone",buttonClass:"bg-blue-600 hover:bg-blue-700 text-white",colorScheme:{background:"bg-blue-50/50",border:"border-blue-100"}},secondaryActions:[{key:"disqualify",label:"Disqualify Lead",icon:"fa-solid fa-xmark",description:"Mark lead as invalid or not interested"}],taskWidgets:[{type:"LQ",condition:"always"}],showLQWidget:!0,showDeadlineBanner:!0,canPostpone:!0,canReassign:!0},[se.TO_BE_CALLED_BACK]:{primaryAction:{key:"call-prospect",title:"Call Prospect",description:"Customer requested a callback. Make the call at scheduled time",label:"Call Prospect",icon:"fa-solid fa-phone",buttonClass:"bg-purple-600 hover:bg-purple-700 text-white",colorScheme:{background:"bg-purple-50/50",border:"border-purple-100"}},secondaryActions:[{key:"postpone",label:"Postpone Task",icon:"fa-solid fa-clock",description:"Reschedule the callback"},{key:"disqualify",label:"Disqualify Lead",icon:"fa-solid fa-xmark"}],taskWidgets:[{type:"LQ",condition:"has-callback-date"}],showLQWidget:s=>!!(s.callbackDate||s.callbackScheduled),showDeadlineBanner:!0,canPostpone:!0,canReassign:!0},[se.VALID]:{primaryAction:{key:"complete-conversion",title:"Lead Validated",description:"Lead is validated. Complete conversion details to create opportunity",label:"Complete Conversion",icon:"fa-solid fa-check-circle",buttonClass:"bg-emerald-600 hover:bg-emerald-700 text-white",colorScheme:{background:"bg-emerald-50/50",border:"border-emerald-100"}},secondaryActions:[{key:"schedule-follow-up",label:"Schedule Follow-up",icon:"fa-solid fa-calendar-plus",conditional:"no-appointment"},{key:"disqualify",label:"Disqualify Lead",icon:"fa-solid fa-xmark"}],taskWidgets:[{type:"LQ",condition:"always"}],showLQWidget:!0,showDeadlineBanner:!0,canPostpone:!1,canReassign:!0,lqWidgetMode:"conversion"},[se.CLOSED_INVALID]:{primaryAction:{key:"reopen",title:"Lead Closed - Invalid",description:"This lead has been marked as invalid. Reopen it to continue qualification",label:"Reopen Lead",icon:"fa-solid fa-rotate-left",buttonClass:"bg-gray-600 hover:bg-gray-700 text-white",colorScheme:{background:"bg-gray-50/50",border:"border-gray-100"}},secondaryActions:[],taskWidgets:[],showLQWidget:!1,showDeadlineBanner:!1,canPostpone:!1,canReassign:!1},[se.CLOSED_NOT_INTERESTED]:{primaryAction:{key:"reopen",title:"Lead Closed - Not Interested",description:"This lead has been marked as not interested. Reopen it to continue qualification",label:"Reopen Lead",icon:"fa-solid fa-rotate-left",buttonClass:"bg-gray-600 hover:bg-gray-700 text-white",colorScheme:{background:"bg-gray-50/50",border:"border-gray-100"}},secondaryActions:[],taskWidgets:[],showLQWidget:!1,showDeadlineBanner:!1,canPostpone:!1,canReassign:!1},[se.CLOSED_DUPLICATE]:{primaryAction:{key:"reopen",title:"Lead Closed - Duplicate",description:"This lead has been marked as duplicate. Reopen it to continue qualification",label:"Reopen Lead",icon:"fa-solid fa-rotate-left",buttonClass:"bg-gray-600 hover:bg-gray-700 text-white",colorScheme:{background:"bg-gray-50/50",border:"border-gray-100"}},secondaryActions:[],taskWidgets:[],showLQWidget:!1,showDeadlineBanner:!1,canPostpone:!1,canReassign:!1}};function Bs(s){const k=Ye(s,"lead");return lt[k]||lt[se.NEW]}const nt={toClosed:(s,k,t)=>{const n={isDisqualified:!0,disqualifyReason:(t==null?void 0:t.reason)||null,disqualifyCategory:(t==null?void 0:t.category)||null,scheduledAppointment:null,nextActionDue:null};(t==null?void 0:t.reason)==="Duplicate"?(n.isDuplicate=!0,n.stage="Closed Failed"):(t==null?void 0:t.category)==="Not Interested"?n.stage="Not Interested":n.stage="Not Valid",n.status="Disqualified";const d=[{type:"note",user:"You",action:"disqualified lead",content:`Lead disqualified - Category: ${(t==null?void 0:t.category)||"Unknown"}, Reason: ${(t==null?void 0:t.reason)||"Unknown"}`}];return s.scheduledAppointment&&d.push({type:"appointment",user:"You",action:"cancelled appointment",content:"Appointment cancelled due to lead disqualification",data:{cancelledReason:"Lead disqualified",originalAppointment:s.scheduledAppointment}}),{updates:n,activities:d}},reopen:s=>({updates:{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open Lead",status:"Open",nextActionDue:null,scheduledAppointment:null},activities:[{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"}]})};function He(s,k){return k.startsWith("Closed")?nt.toClosed:s.startsWith("Closed")&&!k.startsWith("Closed")?nt.reopen:null}function ft(s){const k=we(),t=()=>typeof s=="function"?s():(s==null?void 0:s.value)||s,n=q(()=>{const T=t();if(!T)return se.NEW;const i={...T,isDisqualified:T.isDisqualified===!0},g=Ye(i,"lead");return!g||typeof g!="string"?se.NEW:i.isDisqualified!==!0&&g.startsWith("Closed")?(console.warn("Lead state machine error: Non-disqualified lead calculated as closed stage",{leadId:T.id,isDisqualified:T.isDisqualified,calculatedStage:g,stage:T.stage,apiStatus:T.apiStatus}),se.NEW):g}),d=q(()=>Bs(t())),o=q(()=>{const T=t(),i=(T==null?void 0:T.isDisqualified)===!0,g=n.value;if(console.log("isClosedState computed:",{leadId:T==null?void 0:T.id,isDisqualified:i,leadIsDisqualified:T==null?void 0:T.isDisqualified,displayStage:g,leadStage:T==null?void 0:T.stage,leadApiStatus:T==null?void 0:T.apiStatus}),!i)return console.log("isClosedState: returning false (not disqualified)"),!1;if(!g||typeof g!="string")return console.log("isClosedState: returning false (no stage)"),!1;const f=g===se.CLOSED_INVALID||g===se.CLOSED_NOT_INTERESTED||g===se.CLOSED_DUPLICATE||g.startsWith("Closed");return console.log("isClosedState: returning",f,"for disqualified lead"),f}),p=q(()=>{const T=t();return(T==null?void 0:T.isDisqualified)===!0}),c=q(()=>{const T=d.value;return typeof T.showLQWidget=="function"?T.showLQWidget(t()):T.showLQWidget??!1}),x=q(()=>{var T;return o.value?!1:d.value.showDeadlineBanner&&((T=t())==null?void 0:T.nextActionDue)}),b=q(()=>d.value.canPostpone??!1),S=q(()=>d.value.canReassign??!1),y=q(()=>k.getSetting("maxContactAttempts")),m=q(()=>{var T;return(((T=t())==null?void 0:T.contactAttempts)||[]).length||0}),v=q(()=>m.value+1>=y.value),w=q(()=>{const T=d.value.primaryAction;return typeof T=="function"?T({lead:t(),displayStage:n.value}):T}),A=q(()=>d.value.secondaryActions||[]),K=q(()=>d.value.lqWidgetMode||"qualification");return{displayStage:n,stateConfig:d,isClosedState:o,isDisqualified:p,showLQWidget:c,showDeadlineBanner:x,canPostpone:b,canReassign:S,maxContactAttempts:y,contactAttempts:m,shouldShowAutoDisqualifyWarning:v,primaryAction:w,secondaryActions:A,lqWidgetMode:K}}const Us={class:"space-y-4"},Ws={label:"Teams"},Es=["value"],js={label:"Users"},Ps=["value"],Hs={key:0,class:"text-xs text-gray-500 mt-1"},Qs={key:0,class:"animate-fade-in"},zs={class:"grid grid-cols-4 gap-2"},Ys=["onClick"],Ks={__name:"ScheduleAppointmentModal",props:{show:{type:Boolean,required:!0}},emits:["close","confirm"],setup(s,{emit:k}){const t=s,n=k,d=Ve(),o=Xe(),p=I(""),c=I(null),x=I(""),b=I(!1),S=I(""),y=q(()=>o.assignableUsers),m=q(()=>o.assignableTeams),v=q(()=>c.value&&c.value.startsWith("team-")),w=q(()=>!!(p.value&&x.value&&S.value&&c.value));Ne(()=>{var i;c.value=`user-${((i=d.currentUser)==null?void 0:i.id)||1}`}),de(()=>t.show,i=>{i||A()});const A=()=>{var i;p.value="",c.value=`user-${((i=d.currentUser)==null?void 0:i.id)||1}`,x.value="",b.value=!1,S.value=""},K=()=>{if(!w.value)return;const i=c.value.startsWith("team-"),g=parseInt(c.value.split("-")[1]);let f={};if(i){const F=o.getTeamById(g);f={assigneeType:"team",teamId:g,team:(F==null?void 0:F.name)||"Unknown Team",assignee:null,assigneeId:null}}else{const F=o.getUserById(g);f={assigneeType:"user",assigneeId:g,assignee:(F==null?void 0:F.name)||"Unknown",teamId:null,team:null}}n("confirm",{type:p.value,date:x.value,time:S.value,...f}),n("close")},T=()=>{n("close")};return(i,g)=>(a(),G(ke,{show:s.show,title:"Schedule Appointment",subtitle:"Book an appointment with the customer",size:"lg",onClose:T,onCancel:T},{actions:X(()=>[J(M(Ie),{label:"Confirm Appointment",variant:"primary",size:"small",class:"rounded-sm",disabled:!w.value,onClick:K},null,8,["disabled"])]),default:X(()=>[e("div",Us,[e("div",null,[g[5]||(g[5]=e("label",{class:"block text-xs font-medium text-gray-500 mb-1.5"},"Appointment Type",-1)),z(e("select",{"onUpdate:modelValue":g[0]||(g[0]=f=>p.value=f),class:"input"},[...g[4]||(g[4]=[e("option",{value:"",disabled:""},"Select type...",-1),e("option",null,"Showroom Visit",-1),e("option",null,"Test Drive",-1),e("option",null,"Video Call",-1),e("option",null,"Home Visit",-1),e("option",null,"Closing Meeting",-1)])],512),[[me,p.value]])]),e("div",null,[g[7]||(g[7]=e("label",{class:"block text-xs font-medium text-gray-500 mb-1.5"},"Assign to",-1)),z(e("select",{"onUpdate:modelValue":g[1]||(g[1]=f=>c.value=f),class:"input"},[e("optgroup",Ws,[(a(!0),u(ae,null,ie(m.value,f=>(a(),u("option",{key:`team-${f.id}`,value:`team-${f.id}`},$(f.name)+" Team ",9,Es))),128))]),e("optgroup",js,[(a(!0),u(ae,null,ie(y.value,f=>{var F;return a(),u("option",{key:`user-${f.id}`,value:`user-${f.id}`},$(f.name)+$(f.id===((F=M(d).currentUser)==null?void 0:F.id)?" (Me)":""),9,Ps)}),128))])],512),[[me,c.value]]),v.value?(a(),u("p",Hs,[...g[6]||(g[6]=[e("i",{class:"fa-solid fa-users text-gray-400"},null,-1),U(" Any available team member will be assigned ",-1)])])):D("",!0)]),e("div",null,[g[8]||(g[8]=e("label",{class:"block text-xs font-medium text-gray-500 mb-1.5"},"Select Date",-1)),z(e("input",{type:"date","onUpdate:modelValue":g[2]||(g[2]=f=>x.value=f),onChange:g[3]||(g[3]=f=>b.value=!0),class:"input"},null,544),[[le,x.value]])]),b.value?(a(),u("div",Qs,[g[9]||(g[9]=e("label",{class:"block text-xs font-medium text-gray-500 mb-2"},"Available Slots",-1)),e("div",zs,[(a(),u(ae,null,ie(["09:00","10:30","11:00","14:30","15:00","16:30"],f=>e("button",{key:f,onClick:F=>S.value=f,class:B(["py-2 border border-gray-200 rounded-lg text-xs font-medium transition-all",S.value===f?"border-blue-500 bg-blue-50 text-blue-600":"text-slate-600 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-600"])},$(f),11,Ys)),64))])])):D("",!0)])]),_:1},8,["show"]))}},Gs={class:"bg-white border border-gray-200 rounded-lg p-4 animate-fade-in"},Js={key:0,class:"flex justify-between items-center mb-4"},Xs={class:"font-semibold text-slate-800 text-sm"},Zs={__name:"InlineFormContainer",props:{title:{type:String,default:""},showClose:{type:Boolean,default:!0}},emits:["close"],setup(s){return(k,t)=>(a(),u("div",Gs,[s.title?(a(),u("div",Js,[e("h5",Xs,$(s.title),1),s.showClose?(a(),u("button",{key:0,onClick:t[0]||(t[0]=n=>k.$emit("close")),class:"text-gray-400 hover:text-gray-600 transition-colors"},[...t[1]||(t[1]=[e("i",{class:"fa-solid fa-xmark"},null,-1)])])):D("",!0)])):D("",!0),Te(k.$slots,"default")]))}},_s={class:"bg-gray-50/50 border border-gray-100 rounded-lg p-4 relative transition-all duration-300"},eo={class:"flex justify-between items-start mb-3"},to={class:"font-bold text-slate-800 text-sm"},so={class:"text-xs text-gray-500 mt-0.5"},oo={key:0,class:"mb-3 bg-blue-50 border border-blue-200 rounded-lg p-3"},lo={class:"text-xs text-blue-700"},no={key:1,class:"mb-3 bg-gray-100 border border-gray-200 rounded-lg p-3"},ao={class:"flex items-center justify-between"},io={class:"flex items-center gap-2"},ro={class:"text-xs font-bold text-slate-800"},uo={key:0,class:"text-xs text-orange-600 font-medium flex items-center gap-1"},co={class:"flex items-center gap-2 mb-3"},po={class:"text-sm text-slate-700 font-medium"},mo={key:2,class:"flex gap-2 items-center mb-4"},yo=["disabled"],go={key:0,class:"bg-blue-500 px-2 py-0.5 rounded text-xs font-bold"},fo=["disabled"],vo={key:3,class:"mb-4 space-y-4 border-t border-gray-200 pt-4"},bo={key:0,class:"bg-slate-900 text-white rounded-lg p-4"},xo={class:"flex items-center justify-between mb-4 pb-3 border-b border-slate-700"},ho={class:"flex items-center gap-2 text-red-400"},wo={class:"text-xs font-mono"},ko={class:"space-y-3 text-sm font-mono"},Co={class:"ml-2"},So={class:"ml-2"},$o={key:0},Ao={class:"ml-2"},Do={key:1},To={class:"ml-2"},Lo={key:2},Io={class:"ml-2"},Oo={class:"mt-4 pt-4 border-t border-slate-700"},qo={key:1,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},No={key:4,class:"mt-4 space-y-4 border-t border-gray-200 pt-4"},Ro={class:"grid grid-cols-3 gap-2"},Mo={key:0,class:"space-y-4 bg-white border border-gray-200 rounded-lg p-4"},Fo={class:"grid grid-cols-4 gap-2"},Vo=["onClick"],Bo={key:0},Uo={class:"mt-2 p-3 bg-gray-50 border border-gray-200 rounded-lg"},Wo={class:"text-xs text-slate-700"},Eo={class:"grid grid-cols-3 gap-2"},jo={key:0,class:"mt-3 grid grid-cols-2 gap-3"},Po={key:1,class:"space-y-4 bg-white border border-gray-200 rounded-lg p-4"},Ho={class:"flex gap-4"},Qo={class:"flex items-center gap-2 cursor-pointer"},zo={class:"flex items-center gap-2 cursor-pointer"},Yo={class:"flex justify-end gap-2 pt-3 border-t border-gray-200"},Ko=["disabled"],Go={key:2,class:"space-y-4"},Jo={class:"bg-white border border-gray-200 rounded-lg p-4"},Xo={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},Zo=["value"],_o=["value"],el=["value"],tl={class:"bg-white border border-gray-200 rounded-lg p-4"},sl={class:"flex gap-2"},ol={key:0,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},ll={class:"grid grid-cols-2 gap-3 text-sm mb-3"},nl={class:"ml-2 font-medium text-slate-800"},al={class:"ml-2 font-medium text-slate-800"},il={class:"ml-2 font-medium text-slate-800 capitalize"},rl={class:"ml-2 font-medium text-slate-800"},dl={key:1,class:"bg-white border border-gray-200 rounded-lg p-4"},ul={class:"space-y-2"},cl=["checked"],pl=["checked","disabled"],ml={class:"flex-1"},yl={class:"text-xs text-gray-500 mt-0.5"},gl={class:"space-y-3"},fl={class:"grid grid-cols-2 gap-3 text-sm"},vl={class:"ml-2 font-medium text-slate-800"},bl={class:"ml-2 font-medium text-slate-800"},xl={class:"ml-2 font-medium text-slate-800 capitalize"},hl={class:"ml-2 font-medium text-slate-800"},wl={key:0,class:"text-sm"},kl={class:"ml-2 font-medium text-slate-800"},Cl={key:1,class:"text-sm"},Sl={class:"mt-1 text-slate-700"},$l={__name:"LQWidget",props:{lead:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["postponed","validated","qualified","disqualified","call-attempt-logged","note-saved","open-purchase-method","open-trade-in","appointment-scheduled"],setup(s,{emit:k}){var Ze,_e,et;const t=s,n=k,d=Xe(),o=Ve();we();const p=ft(()=>t.lead),c=I(!1),x=I(!1),b=I(0),S=I(""),y=I(null),m=I(!1),v=I(null),w=I(!1),A=I(!1),K=I(null),T=I(!1),i=I(null),g=[{value:"whatsapp",label:"WhatsApp"},{value:"sms",label:"SMS"},{value:"email",label:"Email"},{value:"dont-send",label:"Don't send"}],f=I("whatsapp"),F=I("followup-1"),Y=I("custom"),C=I(""),O=I("09:00"),P=I("Not Interested"),te=I(""),W=["Barcelona","Madrid","Valencia","Firenze","Milano","Roma"],ne=["Audi Sales (New)","Audi Sales (Used)","Sales (New)","Sales (Used)"],ye=q(()=>d.assignableUsers),be=q(()=>o.currentUser),ue=I({dealership:((_e=(Ze=t.lead)==null?void 0:Ze.requestedCar)==null?void 0:_e.dealership)||"Barcelona",team:"Audi Sales (New)",assigneeId:((et=be.value)==null?void 0:et.id)||1}),pe=I({tradeIn:!1,financing:!1,contactAvailability:!1}),oe=I({}),ce=I(null);Ne(()=>{p.displayStage.value===se.VALID&&(v.value="interested",m.value=!0)});const re={leadLines:["Yes, this is Josh Adams speaking.","Oh, hi Michael! Yes, I was waiting for your call.","That sounds great. I'm definitely interested in seeing it."],salesLines:["Hi Josh, Michael here regarding your Audi A6 inquiry.","Great. I see you're interested in the Allroad. Do you have a vehicle you'd like to trade in?"]},xe=q(()=>{const j=Math.floor(b.value/60),l=b.value%60;return`${j.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}),Ce=q(()=>{var j;return((j=p.primaryAction.value)==null?void 0:j.title)||"Call to Verify Contact Details"}),Se=q(()=>{var j;return((j=p.primaryAction.value)==null?void 0:j.description)||"Begin lead qualification by verifying customer contact information."}),$e=q(()=>t.lead.scheduledAppointment?new Date(t.lead.scheduledAppointment.start)<new Date:!1),Q=q(()=>!!t.lead.scheduledAppointment),E=q(()=>Q.value?{text:"Follow-up Scheduled",class:"bg-blue-100 text-blue-700"}:$e.value?{text:"Overdue",class:"bg-red-100 text-red-700"}:{text:t.lead.nextActionDue?`Task Pending - Due ${dt(t.lead.nextActionDue)}`:"Task Pending",class:"bg-orange-100 text-orange-700"}),ee=p.contactAttempts,Ae=p.maxContactAttempts;q(()=>t.activities.filter(j=>j.type==="note"));const Be={"followup-1":`Hi ${t.lead.customer.name.split(" ")[0]}! I tried calling you earlier but couldn't reach you. When would be a good time to discuss the ${t.lead.requestedCar.brand} ${t.lead.requestedCar.model}?`,"followup-2":`Hello ${t.lead.customer.name.split(" ")[0]}, this is regarding your inquiry about the ${t.lead.requestedCar.brand} ${t.lead.requestedCar.model}. Please let me know when you're available for a call.`,custom:""},r=q(()=>F.value==="custom"?"Type your custom message...":Be[F.value]),L=()=>{c.value=!0,b.value=0,x.value=!1,S.value="",y.value=setInterval(()=>{b.value++,b.value>=20&&N()},1e3)},N=()=>{y.value&&(clearInterval(y.value),y.value=null),c.value=!1,x.value=!0,oe.value={duration:b.value,notes:S.value,transcription:re,channel:"phone"},m.value=!1},V=async()=>{try{await navigator.clipboard.writeText(t.lead.customer.phone),alert("Phone number copied to clipboard!")}catch(j){console.error("Failed to copy:",j)}},h=()=>{ce.value={tradeIn:re.leadLines.some(j=>j.toLowerCase().includes("trade")||j.toLowerCase().includes("exchange"))||!1,financing:re.leadLines.some(j=>j.toLowerCase().includes("financ")||j.toLowerCase().includes("payment")||j.toLowerCase().includes("loan"))||!1},ce.value.tradeIn&&(pe.value.tradeIn=!0),ce.value.financing&&(pe.value.financing=!0),m.value=!0,x.value=!1,c.value=!1},H=async j=>{i.value=j,T.value=!0,A.value=!1,n("appointment-scheduled",j)},Z=()=>{const j={timestamp:new Date().toISOString(),outcome:"interested",channel:oe.value.channel||"phone",notes:oe.value.notes||"",transcription:oe.value.transcription||null};n("call-attempt-logged",j),n("validated",{scheduleFollowUp:!1}),n("qualified",{assignment:ue.value,preferences:pe.value,scheduleAppointment:T.value,appointmentData:i.value}),De()},ge=()=>{const j={timestamp:new Date().toISOString(),outcome:"interested",channel:oe.value.channel||"phone",notes:oe.value.notes||"",transcription:oe.value.transcription||null};n("call-attempt-logged",j),v.value="not-valid"},Re=()=>{oe.value={channel:"external",notes:"",transcription:null},m.value=!0},Me=j=>{v.value=j,j==="interested"&&ce.value&&(pe.value.tradeIn=ce.value.tradeIn||!1,pe.value.financing=ce.value.financing||!1)},De=()=>{v.value=null,m.value=!1,T.value=!1,i.value=null},vt=()=>{if(Y.value==="tomorrow-9am"){const l=new Date;return l.setDate(l.getDate()+1),l.setHours(9,0,0,0),l.toISOString()}else if(Y.value==="monday"){const l=new Date,R=(8-l.getDay())%7||7;return l.setDate(l.getDate()+R),l.setHours(9,0,0,0),l.toISOString()}else if(Y.value==="custom"&&C.value&&O.value)return new Date(`${C.value}T${O.value}:00`).toISOString();const j=new Date;return j.setDate(j.getDate()+1),j.setHours(9,0,0,0),j.toISOString()},bt=async()=>{const j={timestamp:new Date().toISOString(),outcome:"no-answer",channel:oe.value.channel||"phone",notes:oe.value.notes||"",transcription:oe.value.transcription||null};n("call-attempt-logged",j),f.value&&f.value;const l=vt(),R=l.split("T")[0],Oe=new Date(l).toTimeString().slice(0,5);n("postponed",{date:R,time:Oe,createAppointment:!0}),ee.value+1>=Ae.value&&n("disqualified",{category:"Not Interested",reason:"Unreachable"}),De()},xt=()=>{const j={timestamp:new Date().toISOString(),outcome:"not-valid",channel:oe.value.channel||"phone",notes:oe.value.notes||"",transcription:oe.value.transcription||null};n("call-attempt-logged",j),n("disqualified",{category:P.value,reason:te.value}),De()},ht=j=>{w.value=!1,n("note-saved",j)};return kt(()=>{y.value&&clearInterval(y.value)}),(j,l)=>(a(),u("div",_s,[e("div",eo,[e("div",null,[e("h4",to,$(Ce.value),1),e("p",so,$(Se.value),1)]),e("div",{class:B(["flex items-center gap-2 px-2 py-1 rounded text-xs font-semibold",E.value.class])},$(E.value.text),3)]),Q.value?(a(),u("div",oo,[l[26]||(l[26]=e("div",{class:"flex items-center gap-2 mb-1"},[e("i",{class:"fa-solid fa-phone text-blue-600 text-xs"}),e("span",{class:"text-xs font-semibold text-blue-900"},"Scheduled Follow-up Call")],-1)),e("p",lo,$(M(Le)(s.lead.scheduledAppointment.start))+" at "+$(M(qe)(s.lead.scheduledAppointment.start)),1)])):D("",!0),M(ee)>0?(a(),u("div",no,[e("div",ao,[e("div",io,[l[27]||(l[27]=e("i",{class:"fa-solid fa-phone text-gray-600 text-xs"},null,-1)),l[28]||(l[28]=e("span",{class:"text-xs font-semibold text-slate-700"},"Contact Attempts:",-1)),e("span",ro,$(M(ee))+" / "+$(M(Ae)),1)]),M(ee)>=M(Ae)-1?(a(),u("div",uo,[...l[29]||(l[29]=[e("i",{class:"fa-solid fa-exclamation-triangle"},null,-1),U(" One more attempt before auto-disqualification ",-1)])])):D("",!0)])])):D("",!0),e("div",co,[e("span",po,$(s.lead.customer.phone),1),e("button",{onClick:V,class:"w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors",title:"Copy phone number"},[...l[30]||(l[30]=[e("i",{class:"fa-regular fa-copy text-xs"},null,-1)])])]),!m.value&&!c.value&&!x.value?(a(),u("div",mo,[e("button",{onClick:L,disabled:c.value,class:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-blue-200"},[l[31]||(l[31]=e("i",{class:"fa-solid fa-phone"},null,-1)),U(" "+$(M(ee)>0?"Call Again":"Initiate Call")+" ",1),M(ee)>0?(a(),u("span",go,$(M(ee)+1)+"/"+$(M(Ae)),1)):D("",!0)],8,yo),e("button",{onClick:Re,disabled:c.value,class:"bg-white hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...l[32]||(l[32]=[e("i",{class:"fa-solid fa-clipboard-check text-xs"},null,-1),U(" Log Call Outcome ",-1)])],8,fo)])):D("",!0),c.value||x.value?(a(),u("div",vo,[c.value?(a(),u("div",bo,[e("div",xo,[l[34]||(l[34]=e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-waveform-lines text-blue-400 animate-pulse"}),e("span",{class:"text-xs font-bold uppercase tracking-wider"},"TRANSCRIBING")],-1)),e("div",ho,[l[33]||(l[33]=e("span",{class:"w-2 h-2 bg-red-500 rounded-full animate-pulse"},null,-1)),e("span",wo,"REC "+$(xe.value),1)])]),e("div",ko,[e("div",null,[l[35]||(l[35]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Co,$(re.leadLines[0]),1)]),e("div",null,[l[36]||(l[36]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",So,$(re.salesLines[0]),1)]),b.value>=5?(a(),u("div",$o,[l[37]||(l[37]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Ao,$(re.leadLines[1]),1)])):D("",!0),b.value>=8?(a(),u("div",Do,[l[38]||(l[38]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",To,$(re.salesLines[1]),1)])):D("",!0),b.value>=12?(a(),u("div",Lo,[l[39]||(l[39]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Io,$(re.leadLines[2]),1)])):D("",!0)]),e("div",Oo,[z(e("textarea",{"onUpdate:modelValue":l[0]||(l[0]=R=>S.value=R),placeholder:"Add a quick note about this call...",class:"w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm placeholder-gray-500 focus:outline-none focus:border-blue-500 resize-none",rows:"3"},null,512),[[le,S.value]])]),e("div",{class:"mt-4 flex justify-end"},[e("button",{onClick:N,class:"bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...l[40]||(l[40]=[e("i",{class:"fa-solid fa-phone-slash"},null,-1),U(" End Call ",-1)])])])])):D("",!0),x.value&&!c.value?(a(),u("div",qo,[e("div",{class:"flex items-center justify-between"},[l[43]||(l[43]=e("div",null,[e("h4",{class:"font-bold text-slate-800 mb-1 text-sm"},"Call Ended"),e("p",{class:"text-xs text-gray-600"},"Extract information from the transcription or log the outcome")],-1)),e("div",{class:"flex gap-2"},[e("button",{onClick:h,class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...l[41]||(l[41]=[e("i",{class:"fa-solid fa-wand-magic-sparkles"},null,-1),U(" Extract information ",-1)])]),e("button",{onClick:Re,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...l[42]||(l[42]=[e("i",{class:"fa-solid fa-clipboard-check text-xs"},null,-1),U(" Log outcome ",-1)])])])])])):D("",!0)])):D("",!0),m.value?(a(),u("div",No,[e("div",null,[l[47]||(l[47]=e("h4",{class:"font-semibold text-slate-800 mb-2 text-sm"},"What's the outcome?",-1)),e("div",Ro,[e("button",{onClick:l[1]||(l[1]=R=>Me("no-answer")),class:B(["flex flex-col items-center justify-center gap-1.5 p-2 rounded-lg border transition-all",v.value==="no-answer"?"bg-blue-50 border-blue-500 text-blue-700 shadow-sm":"bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50"])},[...l[44]||(l[44]=[e("i",{class:"fa-solid fa-phone-slash text-base"},null,-1),e("span",{class:"font-medium text-xs"},"No answer",-1)])],2),e("button",{onClick:l[2]||(l[2]=R=>Me("not-valid")),class:B(["flex flex-col items-center justify-center gap-1.5 p-2 rounded-lg border transition-all",v.value==="not-valid"?"bg-red-50 border-red-500 text-red-700 shadow-sm":"bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50"])},[...l[45]||(l[45]=[e("i",{class:"fa-solid fa-thumbs-down text-base"},null,-1),e("span",{class:"font-medium text-xs"},"Not valid",-1)])],2),e("button",{onClick:l[3]||(l[3]=R=>Me("interested")),class:B(["flex flex-col items-center justify-center gap-1.5 p-2 rounded-lg border transition-all",v.value==="interested"?"bg-green-50 border-green-500 text-green-700 shadow-sm":"bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50"])},[...l[46]||(l[46]=[e("i",{class:"fa-solid fa-check text-base"},null,-1),e("span",{class:"font-medium text-xs"},"Interested",-1)])],2)])]),v.value==="no-answer"?(a(),u("div",Mo,[l[55]||(l[55]=e("h5",{class:"font-semibold text-slate-800 text-sm"},"Send follow-up message",-1)),e("div",Fo,[(a(),u(ae,null,ie(g,R=>e("button",{key:R.value,onClick:Oe=>f.value=R.value,class:B(["px-3 py-2 rounded-lg text-xs font-medium transition-all border-2",f.value===R.value?"bg-blue-50 border-blue-500 text-blue-700":"bg-white border-gray-200 text-gray-700 hover:border-gray-300"])},$(R.label),11,Vo)),64))]),f.value&&f.value!=="dont-send"?(a(),u("div",Bo,[l[50]||(l[50]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Template",-1)),z(e("select",{"onUpdate:modelValue":l[4]||(l[4]=R=>F.value=R),class:"input"},[...l[48]||(l[48]=[e("option",{value:"followup-1"},"Follow-up 1",-1),e("option",{value:"followup-2"},"Follow-up 2",-1),e("option",{value:"custom"},"Custom message",-1)])],512),[[me,F.value]]),e("div",Uo,[l[49]||(l[49]=e("p",{class:"text-xs font-semibold text-gray-600 mb-1 uppercase"},"Message preview",-1)),e("p",Wo,$(r.value),1)])])):D("",!0),e("div",null,[l[53]||(l[53]=e("h5",{class:"font-semibold text-slate-800 text-sm mb-2"},"Next call attempt",-1)),e("div",Eo,[e("button",{onClick:l[5]||(l[5]=R=>Y.value="tomorrow-9am"),class:B(["px-3 py-2 rounded-lg text-xs font-medium transition-all border-2",Y.value==="tomorrow-9am"?"bg-blue-50 border-blue-500 text-blue-700":"bg-white border-gray-200 text-gray-700 hover:border-gray-300"])}," Tomorrow 9:00 AM ",2),e("button",{onClick:l[6]||(l[6]=R=>Y.value="monday"),class:B(["px-3 py-2 rounded-lg text-xs font-medium transition-all border-2",Y.value==="monday"?"bg-blue-50 border-blue-500 text-blue-700":"bg-white border-gray-200 text-gray-700 hover:border-gray-300"])}," Monday ",2),e("button",{onClick:l[7]||(l[7]=R=>Y.value="custom"),class:B(["px-3 py-2 rounded-lg text-xs font-medium transition-all border-2",Y.value==="custom"?"bg-blue-50 border-blue-500 text-blue-700":"bg-white border-gray-200 text-gray-700 hover:border-gray-300"])}," Select time ",2)]),Y.value==="custom"?(a(),u("div",jo,[e("div",null,[l[51]||(l[51]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Date",-1)),z(e("input",{type:"date","onUpdate:modelValue":l[8]||(l[8]=R=>C.value=R),class:"input"},null,512),[[le,C.value]])]),e("div",null,[l[52]||(l[52]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Time",-1)),z(e("input",{type:"time","onUpdate:modelValue":l[9]||(l[9]=R=>O.value=R),class:"input"},null,512),[[le,O.value]])])])):D("",!0)]),e("div",{class:"flex justify-end gap-2 pt-3 border-t border-gray-200"},[e("button",{onClick:De,class:"bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors"}," Cancel "),e("button",{onClick:bt,class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...l[54]||(l[54]=[U(" Send and reschedule ",-1),e("i",{class:"fa-solid fa-check"},null,-1)])])])])):D("",!0),v.value==="not-valid"?(a(),u("div",Po,[e("div",null,[l[58]||(l[58]=e("label",{class:"block text-xs font-medium text-gray-600 mb-2"},"Category",-1)),e("div",Ho,[e("label",Qo,[z(e("input",{type:"radio","onUpdate:modelValue":l[10]||(l[10]=R=>P.value=R),value:"Not Valid",class:"w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300"},null,512),[[je,P.value]]),l[56]||(l[56]=e("span",{class:"text-sm text-gray-700"},"Not Valid",-1))]),e("label",zo,[z(e("input",{type:"radio","onUpdate:modelValue":l[11]||(l[11]=R=>P.value=R),value:"Not Interested",class:"w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300"},null,512),[[je,P.value]]),l[57]||(l[57]=e("span",{class:"text-sm text-gray-700"},"Not Interested",-1))])])]),e("div",null,[l[60]||(l[60]=e("label",{class:"block text-xs font-medium text-gray-600 mb-2"},"Failure Reason",-1)),z(e("select",{"onUpdate:modelValue":l[12]||(l[12]=R=>te.value=R),class:"w-full bg-white border-2 border-red-500 rounded-lg px-3 py-2 text-sm text-gray-700 focus:outline-none focus:border-red-600"},[...l[59]||(l[59]=[tt('<option value="">Select a reason...</option><option value="Data cleanup">Data cleanup</option><option value="Unreachable">Unreachable</option><option value="Purchase postponed">Purchase postponed</option><option value="Vehicle sold">Vehicle sold</option><option value="Out of budget">Out of budget</option><option value="Financing rejected">Financing rejected</option><option value="Duplicate">Duplicate</option><option value="Bought elsewhere">Bought elsewhere</option>',9)])],512),[[me,te.value]])]),e("div",Yo,[e("button",{onClick:De,class:"bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors"}," Cancel "),e("button",{onClick:xt,disabled:!P.value||!te.value,class:"bg-red-600 hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors"}," Confirm Disqualification ",8,Ko)])])):D("",!0),v.value==="interested"?(a(),u("div",Go,[e("div",Jo,[l[64]||(l[64]=e("h5",{class:"font-semibold text-slate-800 text-sm mb-3"},"Assign to salesman",-1)),e("div",Xo,[e("div",null,[l[61]||(l[61]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Dealership",-1)),z(e("select",{"onUpdate:modelValue":l[13]||(l[13]=R=>ue.value.dealership=R),class:"input"},[(a(),u(ae,null,ie(W,R=>e("option",{key:R,value:R},$(R),9,Zo)),64))],512),[[me,ue.value.dealership]])]),e("div",null,[l[62]||(l[62]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Team",-1)),z(e("select",{"onUpdate:modelValue":l[14]||(l[14]=R=>ue.value.team=R),class:"input"},[(a(),u(ae,null,ie(ne,R=>e("option",{key:R,value:R},$(R),9,_o)),64))],512),[[me,ue.value.team]])]),e("div",null,[l[63]||(l[63]=e("label",{class:"block text-xs font-medium text-gray-600 mb-1.5"},"Assignee",-1)),z(e("select",{"onUpdate:modelValue":l[15]||(l[15]=R=>ue.value.assigneeId=R),class:"input"},[(a(!0),u(ae,null,ie(ye.value,R=>(a(),u("option",{key:R.id,value:R.id},$(R.name)+$(R.id===be.value.id?" (Me)":""),9,el))),128))],512),[[me,ue.value.assigneeId]])])])]),e("div",tl,[l[68]||(l[68]=e("h5",{class:"font-semibold text-slate-800 text-sm mb-3"},"Customer preferences",-1)),e("div",sl,[e("button",{onClick:l[16]||(l[16]=R=>n("open-purchase-method")),class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...l[65]||(l[65]=[e("i",{class:"fa-solid fa-plus text-xs"},null,-1),U(" Add purchase method ",-1)])]),e("button",{onClick:l[17]||(l[17]=R=>n("open-trade-in")),class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...l[66]||(l[66]=[e("i",{class:"fa-solid fa-plus text-xs"},null,-1),U(" Add trade-in ",-1)])]),e("button",{onClick:l[18]||(l[18]=R=>w.value=!0),class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...l[67]||(l[67]=[e("i",{class:"fa-solid fa-plus text-xs"},null,-1),U(" Add note ",-1)])])])]),j.hasExistingAppointment&&!T.value?(a(),u("div",ol,[l[74]||(l[74]=tt('<div class="flex items-start justify-between mb-3"><div class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-blue-600"></i><h5 class="text-sm font-semibold text-slate-800">Existing Appointment</h5></div><span class="text-xs font-semibold text-blue-600 uppercase">Scheduled</span></div>',1)),e("div",ll,[e("div",null,[l[69]||(l[69]=e("span",{class:"text-gray-600"},"Date:",-1)),e("span",nl,$(M(Le)(s.lead.scheduledAppointment.start)),1)]),e("div",null,[l[70]||(l[70]=e("span",{class:"text-gray-600"},"Time:",-1)),e("span",al,$(M(qe)(s.lead.scheduledAppointment.start)),1)]),e("div",null,[l[71]||(l[71]=e("span",{class:"text-gray-600"},"Type:",-1)),e("span",il,$(s.lead.scheduledAppointment.type),1)]),e("div",null,[l[72]||(l[72]=e("span",{class:"text-gray-600"},"Assigned to:",-1)),e("span",rl,$(s.lead.scheduledAppointment.assignee),1)])]),e("button",{onClick:l[19]||(l[19]=R=>A.value=!0),class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors shadow-sm flex items-center gap-2"},[...l[73]||(l[73]=[e("i",{class:"fa-solid fa-calendar-days text-xs"},null,-1),U(" Reschedule Appointment ",-1)])])])):D("",!0),j.hasExistingAppointment?D("",!0):(a(),u("div",dl,[l[77]||(l[77]=e("h5",{class:"text-xs font-semibold text-gray-600 mb-3"},"Choose Next Step",-1)),e("div",ul,[e("label",{class:B(["flex items-start gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 hover:bg-blue-50/50 transition-all",{"border-blue-500 bg-blue-50":!T.value}])},[e("input",{type:"radio",checked:!T.value,onChange:l[20]||(l[20]=()=>{T.value=!1,i.value=null}),class:"mt-0.5 w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300"},null,40,cl),l[75]||(l[75]=e("div",{class:"flex-1"},[e("div",{class:"text-sm font-semibold text-slate-800"},"Qualify without appointment"),e("div",{class:"text-xs text-gray-500 mt-0.5"},"Proceed directly to opportunity stage")],-1))],2),e("label",{class:B(["flex items-start gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 hover:bg-blue-50/50 transition-all",{"border-blue-500 bg-blue-50":T.value}]),onClick:l[22]||(l[22]=R=>!T.value&&(A.value=!0))},[e("input",{type:"radio",checked:T.value,disabled:!T.value,class:"mt-0.5 w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300"},null,8,pl),e("div",ml,[l[76]||(l[76]=e("div",{class:"text-sm font-semibold text-slate-800"},"Schedule Appointment",-1)),e("div",yl,$(T.value?"Appointment scheduled":"Book a meeting or test drive"),1)]),T.value?(a(),u("button",{key:0,onClick:l[21]||(l[21]=fe(R=>A.value=!0,["stop","prevent"])),class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-3 py-1.5 rounded-lg text-xs transition-colors shadow-sm"}," Reschedule ")):D("",!0)],2)])])),T.value?(a(),G(Zs,{key:2,title:"Scheduled Appointment","show-close":!1},{default:X(()=>[e("div",gl,[e("div",fl,[e("div",null,[l[78]||(l[78]=e("span",{class:"text-gray-600"},"Date:",-1)),e("span",vl,$(M(Le)(i.value.datetime)),1)]),e("div",null,[l[79]||(l[79]=e("span",{class:"text-gray-600"},"Time:",-1)),e("span",bl,$(i.value.time),1)]),e("div",null,[l[80]||(l[80]=e("span",{class:"text-gray-600"},"Type:",-1)),e("span",xl,$(i.value.type),1)]),e("div",null,[l[81]||(l[81]=e("span",{class:"text-gray-600"},"Assigned to:",-1)),e("span",hl,$(i.value.assignee),1)])]),i.value.location?(a(),u("div",wl,[l[82]||(l[82]=e("span",{class:"text-gray-600"},"Location:",-1)),e("span",kl,$(i.value.location),1)])):D("",!0),i.value.notes?(a(),u("div",Cl,[l[83]||(l[83]=e("span",{class:"text-gray-600"},"Notes:",-1)),e("p",Sl,$(i.value.notes),1)])):D("",!0)])]),_:1})):D("",!0),e("div",{class:"flex justify-between items-center pt-3 border-t border-gray-200"},[e("button",{onClick:De,class:"bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors"}," Cancel "),e("div",{class:"flex gap-2"},[e("button",{onClick:ge,class:"bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2"},[...l[84]||(l[84]=[e("i",{class:"fa-solid fa-ban text-xs"},null,-1),U(" Disqualify ",-1)])]),e("button",{onClick:Z,class:"bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors shadow-sm flex items-center gap-2"},[...l[85]||(l[85]=[e("i",{class:"fa-solid fa-check text-xs"},null,-1),U(" Qualify ",-1)])])])])])):D("",!0)])):D("",!0),J(ke,{show:w.value,title:"Add Note",size:"2xl",onClose:l[24]||(l[24]=R=>w.value=!1)},{actions:X(()=>{var R,Oe;return[J(M(Ie),{label:"Save Note",variant:"primary",size:"small",class:"rounded-sm",disabled:!((R=K.value)!=null&&R.canSubmit()),onClick:(Oe=K.value)==null?void 0:Oe.submit},null,8,["disabled","onClick"])]}),default:X(()=>[J(Tt,{ref_key:"noteWidgetRef",ref:K,item:null,"task-type":"lead","task-id":s.lead.id,borderless:!1,"hide-actions":!0,"hide-header":!0,onSave:ht,onCancel:l[23]||(l[23]=R=>w.value=!1)},null,8,["task-id"])]),_:1},8,["show"]),J(Ks,{show:A.value,onConfirm:H,onClose:l[25]||(l[25]=R=>A.value=!1)},null,8,["show"])]))}},Al={key:0,class:"bg-white border border-gray-200 rounded-xl shadow-sm"},Dl={class:"flex items-center gap-3"},Tl={class:"flex-1"},Ll={key:0,class:"text-xs font-normal opacity-75"},Il={class:"p-5 space-y-6"},Ol={key:2,class:"bg-gray-50/50 border border-gray-100 rounded-lg p-4"},ql={class:"flex justify-between items-start mb-3"},Nl={class:"text-xs text-gray-500 mt-0.5"},Rl={key:0},Ml={__name:"LeadManagementWidget",props:{lead:{type:Object,required:!0}},emits:["open-purchase-method","open-trade-in"],setup(s,{emit:k}){const t=s,n=k,d=Ke(),o=Ge(),p=Ve(),c=I(new Set),x=q(()=>c.value.has(t.lead.id)),b=()=>{c.value.add(t.lead.id)},S=q(()=>ut(t.lead.nextActionDue)),y=ft(()=>{var P;const C=o.currentLead,O=C&&C.id===((P=t.lead)==null?void 0:P.id)?C:t.lead;return O&&console.log("LeadManagementWidget - Lead state:",{id:O.id,stage:O.stage,apiStatus:O.apiStatus,isDisqualified:O.isDisqualified,displayStage:O.displayStage,callbackDate:O.callbackDate,callbackScheduled:O.callbackScheduled}),O});de(()=>y.isClosedState.value,C=>{var O;console.log("isClosedState changed to:",C,"for lead:",(O=t.lead)==null?void 0:O.id)},{immediate:!0}),de(()=>t.lead,C=>{C&&console.log("Props lead changed:",{id:C.id,isDisqualified:C.isDisqualified,stage:C.stage,displayStage:C.displayStage,isClosedStateValue:y.isClosedState.value,displayStageValue:y.displayStage.value})},{immediate:!0,deep:!0});const m=q(()=>{var O;const C=y.isClosedState.value;return console.log("debugIsClosedState computed accessed:",C,"for lead:",(O=t.lead)==null?void 0:O.id),C});q(()=>ze(y.displayStage.value,"lead"));async function v(C){var O;if(!y.canPostpone.value){console.warn("Cannot postpone in current state");return}try{const P=new Date(`${C.date}T${C.time}:00`),te=P.toISOString(),W={nextActionDue:te};if((C.assigneeId||C.teamId)&&(W.assignee=C.assignee||null,W.assigneeId=C.assigneeId||null,W.assigneeType=C.assigneeType||"user",W.teamId=C.teamId||null,W.team=C.team||null),await o.modifyLead(t.lead.id,W),C.createAppointment){const ne=new Date(P);ne.setHours(ne.getHours()+1),await o.modifyLead(t.lead.id,{scheduledAppointment:{id:Date.now(),title:`Follow-up Call - ${t.lead.customer.name}`,start:te,end:ne.toISOString(),type:"Call",assignee:C.assignee||t.lead.assignee,assigneeId:C.assigneeId||t.lead.assigneeId,assigneeType:C.assigneeType||t.lead.assigneeType||"user",teamId:C.teamId||t.lead.teamId,team:C.team||t.lead.team,status:"scheduled"}}),await o.addActivity(t.lead.id,{type:"appointment",user:((O=p.currentUser)==null?void 0:O.name)||"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${Le(P)} at ${qe(P)}`,data:{type:"Call",date:C.date,time:C.time,assignee:C.assignee||t.lead.assignee}})}await o.addActivity(t.lead.id,{type:"note",user:"You",action:"postponed lead qualification task",content:`Task postponed to ${Le(P)} at ${qe(P)}${C.assignee?` and reassigned to ${C.assignee}`:""}`}),await o.loadLeadById(t.lead.id)}catch(P){console.error("Failed to postpone lead task:",P)}}async function w(C){try{if(await o.modifyLead(t.lead.id,{stage:"Validated"}),await o.addActivity(t.lead.id,{type:"note",user:"You",action:"validated lead",content:"Lead has been validated and is ready for follow-up"}),C.scheduleFollowUp&&C.appointmentData){const O=new Date(`${C.appointmentData.date}T${C.appointmentData.time}:00`);await o.scheduleFollowUp(t.lead.id,{dateTime:O.toISOString(),assignee:C.appointmentData.assignee||t.lead.assignee,assigneeId:C.appointmentData.assigneeId||null,assigneeType:C.appointmentData.assigneeType||"user",teamId:C.appointmentData.teamId||null,team:C.appointmentData.team||null}),await o.addActivity(t.lead.id,{type:"appointment",user:"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${Le(O)} at ${qe(O)}`})}await o.loadLeadById(t.lead.id)}catch(O){console.error("Failed to validate lead:",O)}}async function A(){try{const C=await o.convertLeadToOpportunity(t.lead.id);p.canAccessOpportunities()?d.push({path:`/tasks/${C}`,query:{type:"opportunity"}}):d.push("/tasks")}catch(C){console.error("Failed to qualify lead:",C)}}async function K(C){try{const O=t.lead.contactAttempts||[];await o.modifyLead(t.lead.id,{contactAttempts:[...O,C],lastContactAttempt:C.timestamp,totalContactAttempts:O.length+1}),await o.addActivity(t.lead.id,{type:"call",user:"You",action:`logged call attempt - ${C.outcome}`,content:C.notes||`Call attempt via ${C.channel}`,data:{outcome:C.outcome,channel:C.channel,duration:C.duration}}),await o.loadLeadById(t.lead.id)}catch(O){console.error("Failed to log call attempt:",O)}}async function T(C){try{await o.addActivity(t.lead.id,{type:"note",user:"You",action:"added a note",content:C.content||C.text||"",data:C}),await o.loadLeadById(t.lead.id)}catch(O){console.error("Failed to save note:",O)}}function i(){n("open-purchase-method")}function g(){n("open-trade-in")}async function f(C){var O;try{const P=`${C.date}T${C.time}:00`,te=new Date(P);te.setHours(te.getHours()+1),await o.modifyLead(t.lead.id,{scheduledAppointment:{id:Date.now(),title:`${C.type} - ${t.lead.customer.name}`,start:P,end:te.toISOString(),type:C.type,assignee:C.assignee,assigneeId:C.assigneeId,status:"scheduled",location:C.location||"",notes:C.notes||""}}),await o.addActivity(t.lead.id,{type:"appointment",user:((O=p.currentUser)==null?void 0:O.name)||"You",action:"scheduled an appointment",content:`${C.type} scheduled for ${C.date} at ${C.time}`,data:{type:C.type,date:C.date,time:C.time,assignee:C.assignee}}),await o.loadLeadById(t.lead.id)}catch(P){console.error("Failed to schedule appointment:",P)}}async function F(C){if(y.isClosedState.value&&!C.force){console.warn("Lead already closed");return}try{const O=y.displayStage.value,P=C.reason==="Duplicate"?se.CLOSED_DUPLICATE:C.category==="Not Interested"?se.CLOSED_NOT_INTERESTED:se.CLOSED_INVALID,te=He(O,P);if(te){const{updates:W,activities:ne}=te(t.lead,P,C);await o.modifyLead(t.lead.id,W);for(const ye of ne)await o.addActivity(t.lead.id,ye)}else{const W=C.reason==="Duplicate";await o.modifyLead(t.lead.id,{isDisqualified:!0,disqualifyReason:C.reason,isDuplicate:W,stage:W?"Closed Failed":"Not Valid",status:"Disqualified",scheduledAppointment:null,nextActionDue:null}),await o.addActivity(t.lead.id,{type:"note",user:"You",action:"disqualified lead",content:`Lead disqualified - Category: ${C.category}, Reason: ${C.reason}`})}d.push("/tasks")}catch(O){console.error("Failed to disqualify lead:",O)}}async function Y(){try{const C=y.displayStage.value,O=se.NEW,P=He(C,O);if(P){const{updates:te,activities:W}=P(t.lead);await o.modifyLead(t.lead.id,te);for(const ne of W)await o.addActivity(t.lead.id,ne)}else await o.modifyLead(t.lead.id,{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open Lead",status:"Open",nextActionDue:null,scheduledAppointment:null}),await o.addActivity(t.lead.id,{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"});await o.loadLeadById(t.lead.id)}catch(C){console.error("Failed to reopen lead:",C)}}return(C,O)=>s.lead?(a(),u("div",Al,[O[6]||(O[6]=e("div",{class:"p-4 border-b border-gray-100 bg-gray-50/50"},[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-clipboard-check text-gray-400 text-xs"}),e("h3",{class:"font-bold text-gray-800 text-sm"},"Manage next steps")])],-1)),!M(y).isClosedState&&M(y).showDeadlineBanner&&!x.value&&(S.value.type==="overdue"||S.value.type==="urgent")?(a(),u("div",{key:0,class:B(["mx-4 mt-4 px-4 py-3 rounded-lg border flex items-center justify-between",[S.value.bgClass,S.value.borderClass]])},[e("div",Dl,[e("div",{class:B(["w-9 h-9 rounded-lg flex items-center justify-center",[S.value.bgClass,S.value.borderClass,"border"]])},[e("i",{class:B(["text-base",[`fa-solid ${S.value.icon}`,S.value.textClass]])},null,2)],2),e("div",Tl,[O[0]||(O[0]=e("div",{class:"text-xs font-medium text-gray-600 mb-0.5"},"Next Action Due",-1)),e("div",{class:B(["text-sm font-bold",S.value.textClass])},[U($(M(ct)(s.lead.nextActionDue))+" ",1),S.value.type!=="overdue"?(a(),u("span",Ll," ("+$(M(dt)(s.lead.nextActionDue))+") ",1)):D("",!0)],2)]),S.value.type==="overdue"?(a(),u("div",{key:0,class:B(["text-xs font-bold uppercase px-2.5 py-1 rounded-md",[S.value.bgClass,S.value.textClass,S.value.borderClass,"border"]])},[...O[1]||(O[1]=[e("i",{class:"fa-solid fa-exclamation-circle mr-1"},null,-1),U(" Overdue ",-1)])],2)):S.value.type==="urgent"?(a(),u("div",{key:1,class:B(["text-xs font-bold uppercase px-2.5 py-1 rounded-md",[S.value.bgClass,S.value.textClass,S.value.borderClass,"border"]])},[...O[2]||(O[2]=[e("i",{class:"fa-solid fa-bolt mr-1"},null,-1),U(" Urgent ",-1)])],2)):D("",!0)]),e("button",{onClick:b,class:"w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition-colors ml-2 shrink-0",title:"Dismiss"},[...O[3]||(O[3]=[e("i",{class:"fa-solid fa-xmark text-xs"},null,-1)])])],2)):D("",!0),e("div",Il,[D("",!0),m.value?(a(),u("div",Ol,[e("div",ql,[e("div",null,[O[4]||(O[4]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Lead Closed",-1)),e("p",Nl,[U(" Status: "+$(M(y).displayStage)+" ",1),s.lead.disqualifyReason?(a(),u("span",Rl," - "+$(s.lead.disqualifyReason),1)):D("",!0)])])]),e("button",{onClick:Y,class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...O[5]||(O[5]=[U(" Reopen Lead ",-1),e("i",{class:"fa-solid fa-rotate-left"},null,-1)])])])):(a(),u(ae,{key:1},[M(y).showLQWidget?(a(),G($l,{key:s.lead.id,lead:s.lead,onPostponed:v,onValidated:w,onQualified:A,onDisqualified:F,onCallAttemptLogged:K,onNoteSaved:T,onOpenPurchaseMethod:i,onOpenTradeIn:g,onAppointmentScheduled:f},null,8,["lead"])):D("",!0)],64))])])):D("",!0)}},Fl={class:"mt-1.5 border-t border-gray-200 pt-1.5"},Vl={key:1},Bl={class:"flex items-center justify-between mb-1.5"},Ul={class:"space-y-1.5"},Wl={class:"block label-upper mb-1"},El=["onUpdate:modelValue","placeholder"],jl=["onUpdate:modelValue"],Pl=["value"],Hl={key:2,class:"space-y-0.5"},Ql=["onUpdate:modelValue","value"],ve={__name:"SurveyWidget",props:{questions:{type:Array,required:!0}},emits:["survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=I(!1),o=I({});de(()=>t.questions,S=>{const y={};S.forEach(m=>{y[m.key]=""}),o.value=y},{immediate:!0});const p=()=>{n("survey-completed",{...o.value}),b()},c=()=>{n("survey-refused"),b()},x=()=>{n("not-responding"),b()},b=()=>{d.value=!1;const S={};t.questions.forEach(y=>{S[y.key]=""}),o.value=S};return(S,y)=>(a(),u("div",Fl,[d.value?(a(),u("div",Vl,[e("div",Bl,[y[4]||(y[4]=e("h5",{class:"text-xs font-semibold text-gray-700"},"Survey / Feedback",-1)),e("button",{onClick:y[1]||(y[1]=m=>d.value=!1),class:"text-xs text-gray-400 hover:text-gray-600 font-medium py-0.5"},[...y[3]||(y[3]=[e("i",{class:"fa-solid fa-chevron-up text-[10px]"},null,-1)])])]),e("div",Ul,[(a(!0),u(ae,null,ie(s.questions,(m,v)=>(a(),u("div",{key:v,class:"bg-gray-50 rounded-md p-1.5"},[e("label",Wl,$(m.label),1),m.type==="text"?z((a(),u("textarea",{key:0,"onUpdate:modelValue":w=>o.value[m.key]=w,placeholder:m.placeholder,rows:"2",class:"input resize-none text-xs py-1 px-2"},null,8,El)),[[le,o.value[m.key]]]):m.type==="select"?z((a(),u("select",{key:1,"onUpdate:modelValue":w=>o.value[m.key]=w,class:"input text-xs py-1 px-2"},[y[5]||(y[5]=e("option",{value:""},"Select an option...",-1)),(a(!0),u(ae,null,ie(m.options,w=>(a(),u("option",{key:w,value:w},$(w),9,Pl))),128))],8,jl)),[[me,o.value[m.key]]]):m.type==="radio"?(a(),u("div",Hl,[(a(!0),u(ae,null,ie(m.options,w=>(a(),u("label",{key:w,class:"flex items-center text-xs"},[z(e("input",{type:"radio","onUpdate:modelValue":A=>o.value[m.key]=A,value:w,class:"mr-1"},null,8,Ql),[[je,o.value[m.key]]]),U(" "+$(w),1)]))),128))])):D("",!0)]))),128)),e("div",{class:"flex gap-1.5 flex-wrap pt-0.5"},[e("button",{onClick:p,class:"bg-green-600 hover:bg-green-700 text-white font-medium px-2.5 py-1 rounded-md text-xs transition-colors"}," Complete Survey "),e("button",{onClick:c,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-2.5 py-1 rounded-md text-xs transition-colors"}," Customer Refused "),e("button",{onClick:x,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-2.5 py-1 rounded-md text-xs transition-colors"}," Not Responding ")])])])):(a(),u("button",{key:0,onClick:y[0]||(y[0]=m=>d.value=!0),class:"w-full flex items-center justify-between text-xs text-gray-500 hover:text-gray-700 py-0.5 transition-colors"},[...y[2]||(y[2]=[e("span",{class:"font-medium"},"Survey / Feedback",-1),e("i",{class:"fa-solid fa-chevron-down text-[10px]"},null,-1)])]))]))}},zl={class:"bg-orange-50/50 border border-orange-100 rounded-lg p-4 relative transition-all duration-300"},Yl={class:"flex justify-between items-start mb-3"},Kl={class:"text-xs text-gray-500 mt-0.5"},Gl={__name:"OOFBWidget",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","review","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"offerStatus",label:"Why hasn't an offer been created?",type:"select",options:["Still gathering information","Awaiting customer response","Vehicle unavailable","Pricing concerns","Other"]},{key:"customerInterest",label:"Is customer still interested?",type:"radio",options:["Yes","Maybe","No"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Any relevant feedback or next steps..."}],o=q(()=>{if(!t.opportunity.createdAt)return 0;const y=new Date(t.opportunity.createdAt),v=Math.abs(new Date-y);return Math.ceil(v/(1e3*60*60*24))}),p=()=>{n("create-offer",t.opportunity)},c=()=>{n("review",t.opportunity)},x=y=>{n("survey-completed",{opportunity:t.opportunity,responses:y})},b=()=>{n("survey-refused",{opportunity:t.opportunity})},S=()=>{n("not-responding",{opportunity:t.opportunity})};return(y,m)=>(a(),u("div",zl,[e("div",Yl,[e("div",null,[m[0]||(m[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Open Opportunity Feedback",-1)),e("p",Kl,"This opportunity has been open for "+$(o.value)+" days without any offer. Consider creating an offer to move forward.",1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:p,class:"bg-orange-600 hover:bg-orange-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Create Offer "),e("button",{onClick:c,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"}," Review Opportunity ")]),J(ve,{questions:d,onSurveyCompleted:x,onSurveyRefused:b,onNotResponding:S})]))}},Jl={class:"bg-red-50/50 border border-red-100 rounded-lg p-4 relative transition-all duration-300"},Xl={class:"flex justify-between items-start mb-3"},Zl={class:"text-xs text-gray-500 mt-0.5"},_l={__name:"UFBWidget",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"lostInterest",label:"Has customer lost interest?",type:"radio",options:["Yes","Maybe","No","Unknown"]},{key:"blockers",label:"What are the blockers?",type:"select",options:["Pricing","Availability","Financing","No response","Changed mind","Found competitor","Other"]},{key:"notes",label:"Additional feedback",type:"text",placeholder:"Describe the situation and any relevant details..."}],o=q(()=>{if(!t.opportunity.createdAt)return 0;const S=new Date(t.opportunity.createdAt),m=Math.abs(new Date-S);return Math.ceil(m/(1e3*60*60*24))}),p=()=>{n("create-offer",t.opportunity)},c=S=>{n("survey-completed",{opportunity:t.opportunity,responses:S})},x=()=>{n("survey-refused",{opportunity:t.opportunity})},b=()=>{n("not-responding",{opportunity:t.opportunity})};return(S,y)=>(a(),u("div",Jl,[e("div",Xl,[e("div",null,[y[0]||(y[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Unsold Feedback",-1)),e("p",Zl,"This opportunity has been open for "+$(o.value)+" days without any offer. This is a follow-up to ensure progress. Consider creating an offer or closing the opportunity.",1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:p,class:"bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Create Offer ")]),J(ve,{questions:d,onSurveyCompleted:c,onSurveyRefused:x,onNotResponding:b})]))}},en={class:"bg-purple-50/50 border border-purple-100 rounded-lg p-4 relative transition-all duration-300"},tn={__name:"NFUWidget",props:{opportunity:{type:Object,required:!0}},emits:["schedule-closing","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"appointmentStatus",label:"Why no appointment scheduled?",type:"select",options:["Customer delaying","Awaiting vehicle availability","Logistics issues","Customer not responding","Other"]},{key:"customerStatus",label:"Customer status?",type:"radio",options:["Still interested","Considering","Lost interest","Unknown"]},{key:"notes",label:"Additional information",type:"text",placeholder:"Any relevant details about the follow-up..."}],o=()=>{n("schedule-closing",t.opportunity)},p=b=>{n("survey-completed",{opportunity:t.opportunity,responses:b})},c=()=>{n("survey-refused",{opportunity:t.opportunity})},x=()=>{n("not-responding",{opportunity:t.opportunity})};return(b,S)=>(a(),u("div",en,[S[0]||(S[0]=e("div",{class:"flex justify-between items-start mb-3"},[e("div",null,[e("h4",{class:"font-bold text-slate-800 text-sm"},"Opportunity Follow-up"),e("p",{class:"text-xs text-gray-500 mt-0.5"},"No contract date exists. Push to close or schedule a closing meeting to finalize the deal.")])],-1)),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:o,class:"bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Schedule Closing Meeting ")]),J(ve,{questions:d,onSurveyCompleted:p,onSurveyRefused:c,onNotResponding:x})]))}},sn={class:"bg-blue-50/50 border border-blue-100 rounded-lg p-4 relative transition-all duration-300"},on={class:"flex justify-between items-start mb-3"},ln={class:"text-xs text-gray-500 mt-0.5"},nn={__name:"OFBWidget",props:{opportunity:{type:Object,required:!0}},emits:["create-contract","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"customerFeedback",label:"Customer feedback on offer?",type:"select",options:["Positive","Neutral","Negative","No feedback yet"]},{key:"objections",label:"Any objections?",type:"text",placeholder:"Describe any concerns or objections raised by customer..."},{key:"nextSteps",label:"What are the next steps?",type:"select",options:["Waiting for customer decision","Revising offer","Scheduling closing meeting","Addressing objections","Other"]}],o=q(()=>{const S=t.opportunity.lastActivity||t.opportunity.createdAt;if(!S)return 0;const y=new Date(S),v=Math.abs(new Date-y);return Math.ceil(v/(1e3*60*60*24))}),p=()=>{n("create-contract",t.opportunity)},c=S=>{n("survey-completed",{opportunity:t.opportunity,responses:S})},x=()=>{n("survey-refused",{opportunity:t.opportunity})},b=()=>{n("not-responding",{opportunity:t.opportunity})};return(S,y)=>(a(),u("div",sn,[e("div",on,[e("div",null,[y[0]||(y[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Offer Feedback",-1)),e("p",ln,"This opportunity has been in negotiation for "+$(o.value)+" days without a contract. Consider creating a contract to finalize the deal.",1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:p,class:"bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Create Contract ")]),J(ve,{questions:d,onSurveyCompleted:c,onSurveyRefused:x,onNotResponding:b})]))}},an={class:"bg-green-50/50 border border-green-100 rounded-lg p-4 relative transition-all duration-300"},rn={class:"flex justify-between items-start mb-3"},dn={class:"text-xs text-gray-500 mt-0.5"},un={__name:"CFBWidget",props:{opportunity:{type:Object,required:!0}},emits:["prepare-delivery","pre-delivery-checklist","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"deliveryTimeline",label:"Delivery timeline confirmation?",type:"select",options:["On schedule","Delayed","Ahead of schedule","To be determined"]},{key:"concerns",label:"Any concerns?",type:"text",placeholder:"Document any concerns or special requests from customer..."},{key:"readiness",label:"Vehicle readiness status?",type:"select",options:["Ready","In preparation","Waiting for parts","Other"]}],o=q(()=>{var w;if(!((w=t.opportunity)!=null&&w.contractDate))return 0;const y=new Date(t.opportunity.contractDate),v=Math.abs(new Date-y);return Math.ceil(v/(1e3*60*60*24))}),p=()=>{n("prepare-delivery",t.opportunity)},c=()=>{n("pre-delivery-checklist",t.opportunity)},x=y=>{n("survey-completed",{opportunity:t.opportunity,responses:y})},b=()=>{n("survey-refused",{opportunity:t.opportunity})},S=()=>{n("not-responding",{opportunity:t.opportunity})};return(y,m)=>(a(),u("div",an,[e("div",rn,[e("div",null,[m[0]||(m[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Contract Feedback",-1)),e("p",dn,"Contract was signed "+$(o.value)+" days ago. Follow up on delivery status and collect customer feedback.",1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:p,class:"bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Prepare for Delivery "),e("button",{onClick:c,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"}," Pre-Delivery Checklist ")]),J(ve,{questions:d,onSurveyCompleted:x,onSurveyRefused:b,onNotResponding:S})]))}},cn={class:"bg-teal-50/50 border border-teal-100 rounded-lg p-4 relative transition-all duration-300"},pn={class:"flex justify-between items-start mb-3"},mn={class:"text-xs text-gray-500 mt-0.5"},yn={__name:"DFBWidget",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["delivery-feedback","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k,d=[{key:"satisfaction",label:"Satisfaction with vehicle?",type:"radio",options:["Very satisfied","Satisfied","Neutral","Dissatisfied","Very dissatisfied"]},{key:"deliveryExperience",label:"Delivery experience rating",type:"select",options:["Excellent","Good","Average","Poor","Very poor"]},{key:"issues",label:"Any issues or concerns?",type:"text",placeholder:"Document any issues or positive feedback from customer..."}],o=q(()=>{const S=t.activities.find(w=>{var A;return w.type==="delivery"||((A=w.action)==null?void 0:A.toLowerCase().includes("delivered"))});if(!S||!S.timestamp)return 0;const y=new Date(S.timestamp),v=Math.abs(new Date-y);return Math.ceil(v/(1e3*60*60*24))}),p=()=>{n("delivery-feedback",t.opportunity)},c=S=>{n("survey-completed",{opportunity:t.opportunity,responses:S})},x=()=>{n("survey-refused",{opportunity:t.opportunity})},b=()=>{n("not-responding",{opportunity:t.opportunity})};return(S,y)=>(a(),u("div",cn,[e("div",pn,[e("div",null,[y[0]||(y[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Delivery Feedback",-1)),e("p",mn,"Vehicle was delivered "+$(o.value)+" days ago. Ask the customer if they're satisfied with the vehicle.",1)])]),e("button",{onClick:p,class:"bg-teal-600 hover:bg-teal-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"}," Delivery Feedback "),J(ve,{questions:d,onSurveyCompleted:c,onSurveyRefused:x,onNotResponding:b})]))}},gn={class:"bg-yellow-50/50 border border-yellow-100 rounded-lg p-4 relative transition-all duration-300"},fn={class:"flex justify-between items-start mb-3"},vn={class:"font-bold text-slate-800 text-sm"},bn={class:"text-xs text-gray-500 mt-0.5"},xn={__name:"NSWidget",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["contact-customer","reschedule","survey-completed","survey-refused","not-responding","auto-close-lost","set-callback"],setup(s,{emit:k}){const t=s,n=k,d=q(()=>{var w;return((w=t.scheduledAppointment)==null?void 0:w.noShowCount)||0}),o=q(()=>{const w=d.value;return w===0?"No-Show Follow-up":w>=3?`No-Show #${w} - Final Warning`:`No-Show #${w} Follow-up`}),p=q(()=>{const w=d.value;return w>=3?"This is the third no-show. The opportunity will be automatically closed as lost if another appointment is not successfully completed.":w>=2?"This is the second no-show. Please make every effort to reach the customer and reschedule.":"Follow up with customer to understand the situation and book another appointment."}),c=[{key:"contactStatus",label:"Were you able to reach the customer?",type:"radio",options:["Yes","No","Left message"]},{key:"noShowReason",label:"Reason for no-show?",type:"select",options:["Emergency","Forgot","Changed mind","No response","Schedule conflict","Other"]},{key:"nextAction",label:"Next action?",type:"select",options:["Reschedule appointment","Customer will call back","Continue follow-up","Other"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Document the conversation and any relevant details..."}],x=q(()=>{var A;return(A=t.scheduledAppointment)!=null&&A.start?new Date(t.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"}),b=()=>{n("contact-customer",t.opportunity)},S=()=>{const w=d.value;if(w>=3)n("auto-close-lost",{opportunity:t.opportunity,reason:`Automatically closed after ${w} no-shows`});else if(w===1||w===2){const A=new Date;A.setDate(A.getDate()+2),n("set-callback",{opportunity:t.opportunity,callbackDate:A.toISOString()})}else n("reschedule",t.opportunity)},y=w=>{n("survey-completed",{opportunity:t.opportunity,responses:w})},m=()=>{n("survey-refused",{opportunity:t.opportunity})},v=()=>{n("not-responding",{opportunity:t.opportunity})};return(w,A)=>(a(),u("div",gn,[e("div",fn,[e("div",null,[e("h4",vn,$(o.value),1),e("p",bn,"Appointment was scheduled for "+$(x.value)+" but customer did not show up. "+$(p.value),1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:S,class:"bg-yellow-600 hover:bg-yellow-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"},[...A[0]||(A[0]=[e("i",{class:"fa-solid fa-calendar-plus"},null,-1),U(" Book Another Appointment ",-1)])]),e("button",{onClick:b,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...A[1]||(A[1]=[e("i",{class:"fa-solid fa-phone"},null,-1),U(" Contact Customer ",-1)])])]),J(ve,{questions:c,onSurveyCompleted:y,onSurveyRefused:m,onNotResponding:v})]))}},hn={class:"bg-gray-50/50 border border-gray-100 rounded-lg p-4 relative transition-all duration-300"},wn={class:"flex justify-between items-start mb-3"},kn={class:"text-xs text-gray-500 mt-0.5"},Cn={__name:"AbandonedWidget",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["reopen","close-lost","requalify","survey-completed","survey-refused","not-responding"],setup(s,{emit:k}){const t=s,n=k;we();const d=[{key:"abandonmentReason",label:"Why was this opportunity abandoned?",type:"select",options:["No response from customer","Customer lost interest","Competitor won","Budget constraints","Timing issues","Other"]},{key:"customerStatus",label:"Customer status?",type:"radio",options:["Still interested","Lost interest","Bought elsewhere","Unknown"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Document any relevant information about why this opportunity was abandoned..."}],o=q(()=>{const m=t.opportunity.lastActivity||t.opportunity.createdAt;if(!m)return 0;const v=new Date(m),A=Math.abs(new Date-v);return Math.ceil(A/(1e3*60*60*24))}),p=()=>{n("reopen",t.opportunity)},c=()=>{n("close-lost",{opportunity:t.opportunity,reason:"Abandoned - no activity for extended period"})},x=()=>{n("requalify",t.opportunity)},b=m=>{n("survey-completed",{opportunity:t.opportunity,responses:m})},S=()=>{n("survey-refused",{opportunity:t.opportunity})},y=()=>{n("not-responding",{opportunity:t.opportunity})};return(m,v)=>(a(),u("div",hn,[e("div",wn,[e("div",null,[v[0]||(v[0]=e("h4",{class:"font-bold text-slate-800 text-sm"},"Opportunity Abandoned",-1)),e("p",kn,"This opportunity has been inactive for "+$(o.value)+" days. Consider reopening it or closing as lost.",1)])]),e("div",{class:"flex gap-3 flex-wrap"},[e("button",{onClick:p,class:"bg-gray-600 hover:bg-gray-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"},[...v[1]||(v[1]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),U(" Reopen Opportunity ",-1)])]),e("button",{onClick:c,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...v[2]||(v[2]=[e("i",{class:"fa-solid fa-xmark"},null,-1),U(" Close as Lost ",-1)])]),e("button",{onClick:x,class:"bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...v[3]||(v[3]=[e("i",{class:"fa-solid fa-arrow-left"},null,-1),U(" Requalify as Lead ",-1)])])]),J(ve,{questions:d,onSurveyCompleted:b,onSurveyRefused:S,onNotResponding:y})]))}},Sn={OOFB:Gl,UFB:_l,NFU:tn,OFB:nn,CFB:un,DFB:yn,NS:xn,ABANDONED:Cn};function $n(s,k,t,n,d){const o=q(()=>{const m=Ue(s),v=Ue(k),w=Ue(t);return{opportunity:m,scheduledAppointment:v,activities:w,hasOffers:(w==null?void 0:w.some(A=>A.type==="offer"))||!1,stage:m.displayStage||m.stage,deliverySubstatus:m.deliverySubstatus||null,formatDateTime:d,hasActiveTaskWidget:!1}}),p=q(()=>{const m=o.value,v=Lt(m.stage,m);if(!v)return null;const w=Sn[v];return w?{type:v,component:w,props:{opportunity:m.opportunity,appointment:m.scheduledAppointment,activities:m.activities}}:(console.warn(`No component found for widget type: ${v}`),null)}),c=q(()=>({...o.value,hasActiveTaskWidget:!!p.value})),x=q(()=>{const m=c.value,v=It(m.stage,m);if(!v)return null;const w=n[v.key];return{...v,handler:w||(()=>console.warn(`No handler for action: ${v.key}`))}}),b=q(()=>{const m=c.value;return Ot(m.stage,m).map(w=>{const A=n[w.key];return{...w,handler:A||(()=>console.warn(`No handler for action: ${w.key}`))}})}),S=q(()=>{const m=o.value;return qt(m.stage)}),y=q(()=>!p.value||!p.value.type?"":Nt(p.value.type));return{primaryAction:x,secondaryActions:b,activeTaskWidget:p,taskWidgetTitle:y,isClosed:S}}const An=["disabled"],Dn={key:0,class:"absolute top-full right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden max-h-96 overflow-y-auto min-w-full",style:{"z-index":"9999"}},Tn=["onClick","disabled"],Ln={class:"flex-1"},In={class:"font-medium text-slate-700"},On={key:0,class:"text-xs text-gray-500 mt-0.5"},qn={key:0,class:"px-4 py-3 text-sm text-gray-500 text-center"},Nn={__name:"SecondaryActionsDropdown",props:{actions:{type:Array,default:()=>[]}},emits:["action-selected"],setup(s,{emit:k}){const t=k,n=I(!1),d=I(null),o=()=>{n.value=!n.value},p=()=>{n.value=!1},c=b=>{b.disabled||(p(),t("action-selected",b),b.handler&&typeof b.handler=="function"&&b.handler())},x=b=>{d.value&&!d.value.contains(b.target)&&p()};return Ne(()=>{document.addEventListener("click",x)}),Ct(()=>{document.removeEventListener("click",x)}),(b,S)=>(a(),u("div",{class:"relative",ref_key:"dropdownRef",ref:d},[e("button",{onClick:o,class:"w-auto bg-white hover:bg-gray-50 border border-gray-200 text-slate-700 font-medium px-4 py-2 rounded-lg text-sm flex items-center justify-between gap-2 transition-colors whitespace-nowrap",disabled:!s.actions||s.actions.length===0},[S[0]||(S[0]=e("span",null,"More actions",-1)),e("i",{class:B(["fa-solid fa-chevron-down text-xs transition-transform duration-200 flex-shrink-0",{"rotate-180":n.value}])},null,2)],8,An),J(rt,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:X(()=>[n.value?(a(),u("div",Dn,[(a(!0),u(ae,null,ie(s.actions,y=>(a(),u("button",{key:y.key,onClick:m=>c(y),class:B(["w-full px-4 py-3 text-left text-sm hover:bg-gray-50 flex items-start gap-3 border-b border-gray-100 last:border-b-0 transition-colors whitespace-nowrap",{"opacity-50 cursor-not-allowed":y.disabled}]),disabled:y.disabled},[e("i",{class:B([y.icon,"text-gray-400 mt-0.5 w-4 flex-shrink-0"])},null,2),e("div",Ln,[e("div",In,$(y.label),1),y.description?(a(),u("div",On,$(y.description),1)):D("",!0)])],10,Tn))),128)),!s.actions||s.actions.length===0?(a(),u("div",qn," No actions available ")):D("",!0)])):D("",!0)]),_:1})],512))}},Rn={class:"w-full h-28 bg-gray-100 rounded overflow-hidden mb-2"},Mn=["src","alt"],Fn={key:1,class:"w-full h-full flex items-center justify-center"},Vn={class:"flex items-center justify-between mb-1.5"},Bn={class:"text-sm font-bold text-gray-900"},Un={class:"font-bold text-xs text-gray-800 mb-0.5 line-clamp-1"},Wn={class:"text-[10px] text-gray-500 mb-1.5"},En={key:0,class:"text-[10px] text-green-600 font-medium mb-2"},jn={key:1,class:"text-[10px] text-orange-600 font-medium mb-2"},at={__name:"VehicleCard",props:{vehicle:{type:Object,required:!0},badge:{type:String,required:!0},stockDays:{type:Number,default:null},selected:{type:Boolean,default:!1}},emits:["select"],setup(s){const k=s,t=q(()=>({Requested:"blue",Recommended:"gray","In Stock":"green",Custom:"yellow"})[k.badge]||"gray"),n=d=>d?d.toLocaleString("en-US"):"0";return(d,o)=>(a(),u("div",{onClick:o[1]||(o[1]=p=>d.$emit("select")),class:B(["border border-gray-200 rounded-lg p-3 hover:border-blue-500 hover:shadow cursor-pointer transition-all bg-white",{"border-blue-500 shadow":s.selected}])},[e("div",Rn,[s.vehicle.image?(a(),u("img",{key:0,src:s.vehicle.image,alt:`${s.vehicle.brand} ${s.vehicle.model}`,class:"w-full h-full object-cover"},null,8,Mn)):(a(),u("div",Fn,[...o[2]||(o[2]=[e("i",{class:"fa-solid fa-car text-gray-300 text-2xl"},null,-1)])]))]),e("div",null,[e("div",Vn,[J(M(Fe),{text:s.badge,size:"small",theme:t.value},null,8,["text","theme"]),e("span",Bn,"â‚¬"+$(n(s.vehicle.price)),1)]),e("h4",Un,$(s.vehicle.brand)+" "+$(s.vehicle.model),1),e("p",Wn,$(s.vehicle.year),1),s.stockDays!==null&&s.stockDays!==void 0?(a(),u("div",En,[o[3]||(o[3]=e("i",{class:"fa-solid fa-check-circle mr-0.5"},null,-1)),U(" In stock ("+$(s.stockDays)+" days) ",1)])):(a(),u("div",jn,[...o[4]||(o[4]=[e("i",{class:"fa-solid fa-clock mr-0.5"},null,-1),U(" Out of stock ",-1)])])),e("button",{onClick:o[0]||(o[0]=fe(p=>d.$emit("select"),["stop"])),class:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-3 py-1.5 rounded text-xs transition-colors"}," Select ")])],2))}},Pn={class:"space-y-6 max-h-[75vh] overflow-y-auto px-2"},Hn={key:0},Qn={class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3"},zn={class:"mb-4"},Yn={class:"relative"},Kn={key:0,class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3"},Gn={key:1,class:"text-center py-8 text-gray-500"},Jn={class:"border border-gray-200 rounded-lg p-4 bg-gray-50"},Xn={key:0,class:"mt-4 space-y-3"},Zn={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"},_n={class:"flex justify-end"},ea=["disabled"],ta={__name:"VehicleSelectionModal",props:{show:{type:Boolean,required:!0},requestedVehicle:{type:Object,default:null},opportunityId:{type:Number,required:!0}},emits:["close","vehicle-selected"],setup(s,{emit:k}){const t=s,n=k,d=I(""),o=I(!1),p=I(null),c=I(null),x=I(null),b=I({brand:"",model:"",year:new Date().getFullYear(),price:0,stockDays:null,image:""}),S=q(()=>t.requestedVehicle&&t.requestedVehicle.stockDays!==null&&t.requestedVehicle.stockDays!==void 0),y=q(()=>{const T=[];if(t.requestedVehicle&&S.value&&T.push({...t.requestedVehicle,isRequested:!0}),he&&he.length>0){const i=he.filter(f=>t.requestedVehicle?f.brand!==t.requestedVehicle.brand||f.model!==t.requestedVehicle.model:!0),g=t.requestedVehicle&&S.value?3:4;T.push(...i.slice(0,g))}return T}),m=q(()=>{if(!he||he.length===0)return[];let T=[...he];if(d.value){const i=d.value.toLowerCase();T=T.filter(g=>g.brand.toLowerCase().includes(i)||g.model.toLowerCase().includes(i)||g.year.toString().includes(i))}return T}),v=q(()=>b.value.brand&&b.value.model&&b.value.year&&b.value.price>0),w=(T,i)=>{p.value=T,c.value=T.id||`custom-${Date.now()}`,x.value=i},A=()=>{if(!v.value)return;const T={...b.value,id:`custom-${Date.now()}`,isCustom:!0};w(T,"custom")},K=()=>{p.value&&(n("vehicle-selected",{vehicle:p.value,type:x.value}),n("close"),p.value=null,c.value=null,x.value=null,d.value="",o.value=!1,b.value={brand:"",model:"",year:new Date().getFullYear(),price:0,stockDays:null,image:""})};return(T,i)=>{const g=St("Button");return a(),G(ke,{show:s.show,onClose:i[6]||(i[6]=f=>T.$emit("close")),onCancel:i[7]||(i[7]=f=>T.$emit("close")),title:"Select Vehicle",size:"6xl"},{actions:X(()=>[p.value?(a(),G(g,{key:0,label:"Confirm Selection",variant:"primary",size:"small",class:"rounded-sm",onClick:K})):D("",!0)]),default:X(()=>[e("div",Pn,[y.value.length?(a(),u("div",Hn,[i[8]||(i[8]=e("h3",{class:"text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-sparkles text-purple-600"}),U(" Recommended Vehicles ")],-1)),e("div",Qn,[(a(!0),u(ae,null,ie(y.value,f=>(a(),G(at,{key:f.id,vehicle:f,badge:f.isRequested?"Requested":"Recommended","stock-days":f.stockDays,selected:c.value===f.id,onSelect:F=>w(f,f.isRequested?"requested":"recommended")},null,8,["vehicle","badge","stock-days","selected","onSelect"]))),128))])])):D("",!0),e("div",null,[i[11]||(i[11]=e("h3",{class:"text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-warehouse text-green-600"}),U(" Browse Stock ")],-1)),e("div",zn,[e("div",Yn,[i[9]||(i[9]=e("i",{class:"fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-sm"},null,-1)),z(e("input",{"onUpdate:modelValue":i[0]||(i[0]=f=>d.value=f),type:"text",placeholder:"Search by brand, model, year...",class:"w-full bg-white border border-gray-200 rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition-colors"},null,512),[[le,d.value]])])]),m.value.length?(a(),u("div",Kn,[(a(!0),u(ae,null,ie(m.value,f=>(a(),G(at,{key:f.id,vehicle:f,badge:"In Stock","stock-days":f.stockDays,selected:c.value===f.id,onSelect:F=>w(f,"stock")},null,8,["vehicle","stock-days","selected","onSelect"]))),128))])):(a(),u("div",Gn,[...i[10]||(i[10]=[e("i",{class:"fa-solid fa-search text-4xl text-gray-300 mb-3"},null,-1),e("p",{class:"text-sm font-medium"},"No vehicles found matching your search",-1),e("p",{class:"text-xs mt-1 text-gray-400"},"Try different keywords or clear the search",-1)])]))]),e("div",null,[i[19]||(i[19]=e("h3",{class:"text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-wrench text-orange-600"}),U(" Configure Custom Vehicle ")],-1)),e("div",Jn,[i[18]||(i[18]=e("p",{class:"text-xs text-gray-600 mb-3"}," Build a custom configuration with specific options and features ",-1)),e("button",{onClick:i[1]||(i[1]=f=>o.value=!o.value),class:"bg-orange-600 hover:bg-orange-700 text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors"},[i[12]||(i[12]=e("i",{class:"fa-solid fa-cog mr-2"},null,-1)),U(" "+$(o.value?"Hide Configuration":"Build Custom Configuration"),1)]),o.value?(a(),u("div",Xn,[e("div",Zn,[e("div",null,[i[13]||(i[13]=e("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"Brand",-1)),z(e("input",{"onUpdate:modelValue":i[2]||(i[2]=f=>b.value.brand=f),type:"text",class:"input",placeholder:"e.g., Audi"},null,512),[[le,b.value.brand]])]),e("div",null,[i[14]||(i[14]=e("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"Model",-1)),z(e("input",{"onUpdate:modelValue":i[3]||(i[3]=f=>b.value.model=f),type:"text",class:"input",placeholder:"e.g., e-tron GT"},null,512),[[le,b.value.model]])]),e("div",null,[i[15]||(i[15]=e("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"Year",-1)),z(e("input",{"onUpdate:modelValue":i[4]||(i[4]=f=>b.value.year=f),type:"number",class:"input",placeholder:"2024"},null,512),[[le,b.value.year]])]),e("div",null,[i[16]||(i[16]=e("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"Price (â‚¬)",-1)),z(e("input",{"onUpdate:modelValue":i[5]||(i[5]=f=>b.value.price=f),type:"number",class:"input",placeholder:"98000"},null,512),[[le,b.value.price]])])]),e("div",_n,[e("button",{onClick:A,disabled:!v.value,class:"bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors"},[...i[17]||(i[17]=[e("i",{class:"fa-solid fa-check mr-2"},null,-1),U(" Use Custom Configuration ",-1)])],8,ea)])])):D("",!0)])])])]),_:1},8,["show"])}}},sa={class:"space-y-4"},oa=["max"],la={__name:"ContractDateModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:k}){const t=s,n=k,d=I(""),o=I(""),p=I(""),c=q(()=>new Date().toISOString().split("T")[0]);de(()=>t.show,S=>{if(S){const y=new Date;d.value=y.toISOString().split("T")[0],o.value=y.toTimeString().slice(0,5),p.value=""}});const x=()=>{if(!d.value)return;const S=o.value?`${d.value}T${o.value}:00`:`${d.value}T12:00:00`;n("confirm",{contractDate:S,notes:p.value})},b=()=>{n("cancel")};return(S,y)=>(a(),G(ke,{show:s.show,title:"Set Contract Signing Date",subtitle:"Record when the contract was signed to track delivery timeline",onCancel:b},{actions:X(()=>[J(M(Ie),{label:"Set Contract Date",variant:"primary",size:"small",class:"rounded-sm !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!d.value,onClick:x},null,8,["disabled"])]),default:X(()=>[e("div",sa,[e("div",null,[y[3]||(y[3]=e("label",{class:"block label-upper mb-2"},"Contract Date",-1)),z(e("input",{type:"date","onUpdate:modelValue":y[0]||(y[0]=m=>d.value=m),max:c.value,class:"input"},null,8,oa),[[le,d.value]])]),e("div",null,[y[4]||(y[4]=e("label",{class:"block label-upper mb-2"},"Time (Optional)",-1)),z(e("input",{type:"time","onUpdate:modelValue":y[1]||(y[1]=m=>o.value=m),class:"input"},null,512),[[le,o.value]])]),e("div",null,[y[5]||(y[5]=e("label",{class:"block label-upper mb-2"},"Notes (Optional)",-1)),z(e("textarea",{"onUpdate:modelValue":y[2]||(y[2]=m=>p.value=m),rows:"3",placeholder:"Add any relevant notes about the contract signing...",class:"input resize-none"},null,512),[[le,p.value]])])])]),_:1},8,["show"]))}},na={class:"space-y-4"},aa=["max"],ia={__name:"DeliveryModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:k}){const t=s,n=k,d=I(""),o=I(""),p=I(""),c=I(""),x=q(()=>new Date().toISOString().split("T")[0]);de(()=>t.show,y=>{if(y){const m=new Date;d.value=m.toISOString().split("T")[0],o.value=m.toTimeString().slice(0,5),p.value="",c.value=""}});const b=()=>{if(!d.value||!p.value)return;const y=o.value?`${d.value}T${o.value}:00`:`${d.value}T12:00:00`;n("confirm",{deliveryDate:y,location:p.value,notes:c.value})},S=()=>{n("cancel")};return(y,m)=>(a(),G(ke,{show:s.show,title:"Mark as Delivered",subtitle:"Record the vehicle delivery date and details",onCancel:S},{actions:X(()=>[J(M(Ie),{label:"Mark as Delivered",variant:"primary",size:"small",class:"rounded-sm !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!d.value||!p.value,onClick:b},null,8,["disabled"])]),default:X(()=>[e("div",na,[e("div",null,[m[4]||(m[4]=e("label",{class:"block label-upper mb-2"},"Delivery Date",-1)),z(e("input",{type:"date","onUpdate:modelValue":m[0]||(m[0]=v=>d.value=v),max:x.value,class:"input"},null,8,aa),[[le,d.value]])]),e("div",null,[m[5]||(m[5]=e("label",{class:"block label-upper mb-2"},"Time (Optional)",-1)),z(e("input",{type:"time","onUpdate:modelValue":m[1]||(m[1]=v=>o.value=v),class:"input"},null,512),[[le,o.value]])]),e("div",null,[m[7]||(m[7]=e("label",{class:"block label-upper mb-2"},"Delivery Location",-1)),z(e("select",{"onUpdate:modelValue":m[2]||(m[2]=v=>p.value=v),class:"input"},[...m[6]||(m[6]=[e("option",{value:""},"Select location...",-1),e("option",{value:"Dealership"},"At Dealership",-1),e("option",{value:"Customer Address"},"Customer Address",-1),e("option",{value:"Other"},"Other Location",-1)])],512),[[me,p.value]])]),e("div",null,[m[8]||(m[8]=e("label",{class:"block label-upper mb-2"},"Delivery Notes",-1)),z(e("textarea",{"onUpdate:modelValue":m[3]||(m[3]=v=>c.value=v),rows:"3",placeholder:"Add any relevant delivery details, customer feedback, etc...",class:"input resize-none"},null,512),[[le,c.value]])])])]),_:1},8,["show"]))}},ra={class:"space-y-4"},da={__name:"CloseAsLostModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:k}){const t=s,n=k,d=I(""),o=I("");de(()=>t.show,x=>{x&&(d.value="",o.value="")});const p=()=>{d.value&&n("confirm",{reason:d.value,notes:o.value})},c=()=>{n("cancel")};return(x,b)=>(a(),G(ke,{show:s.show,title:"Close as Lost",subtitle:"Document why this opportunity didn't close",onCancel:c},{actions:X(()=>[J(M(Ie),{label:"Close as Lost",variant:"primary",size:"small",class:"rounded-sm !bg-red-600 !hover:bg-red-700 !border-red-600",disabled:!d.value,onClick:p},null,8,["disabled"])]),default:X(()=>[e("div",ra,[e("div",null,[b[3]||(b[3]=e("label",{class:"block label-upper mb-2"},"Reason",-1)),z(e("select",{"onUpdate:modelValue":b[0]||(b[0]=S=>d.value=S),class:"input"},[...b[2]||(b[2]=[e("option",{value:""},"Select a reason...",-1),e("option",{value:"Not interested"},"Not interested",-1),e("option",{value:"Budget constraints"},"Budget constraints",-1),e("option",{value:"Found better price"},"Found better price at competitor",-1),e("option",{value:"No response"},"Customer not responding",-1),e("option",{value:"Wrong timing"},"Timing not right",-1),e("option",{value:"Other"},"Other",-1)])],512),[[me,d.value]])]),e("div",null,[b[4]||(b[4]=e("label",{class:"block label-upper mb-2"},"Additional Notes",-1)),z(e("textarea",{"onUpdate:modelValue":b[1]||(b[1]=S=>o.value=S),rows:"4",placeholder:"Add any relevant details about why this opportunity was lost...",class:"input resize-none"},null,512),[[le,o.value]])])])]),_:1},8,["show"]))}},ua={__name:"RequalifyAsLeadModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s){return(k,t)=>(a(),G(ke,{show:s.show,title:"Requalify as Lead",subtitle:"This will convert the opportunity back to a lead. Some data will be lost.",size:"lg",onCancel:t[1]||(t[1]=n=>k.$emit("cancel"))},{actions:X(()=>[J(M(Ie),{label:"Confirm Requalification",variant:"primary",size:"small",class:"rounded-sm !bg-yellow-600 !hover:bg-yellow-700 !border-yellow-600",onClick:t[0]||(t[0]=n=>k.$emit("confirm"))})]),default:X(()=>[t[2]||(t[2]=e("div",{class:"space-y-6 max-h-[60vh] overflow-y-auto"},[e("div",{class:"flex items-start gap-4 mb-6"},[e("div",{class:"flex-shrink-0"},[e("div",{class:"w-12 h-12 rounded-sm bg-yellow-100 flex items-center justify-center border border-yellow-200"},[e("i",{class:"fa-solid fa-exclamation-triangle text-yellow-600 text-xl"})])]),e("div",{class:"flex-1"},[e("p",{class:"text-sm text-gray-600"}," Requalifying this opportunity will reset its stage and remove negotiation history. ")])]),e("div",null,[e("h4",{class:"text-sm font-bold text-red-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-times-circle"}),U(" What will be lost ")]),e("ul",{class:"space-y-2 text-sm text-gray-700"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity stage and expected close date")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity value and negotiation history")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Stock or configured vehicles added to the opportunity")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Offer history and negotiation data")])])]),e("div",null,[e("h4",{class:"text-sm font-bold text-green-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-check-circle"}),U(" What will be kept ")]),e("ul",{class:"space-y-2 text-sm text-gray-700"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Customer information and contact details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Original requested car details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"All activities (notes, calls, emails, etc.)")])])]),e("div",{class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4"},[e("p",{class:"text-sm text-yellow-800"},[e("i",{class:"fa-solid fa-info-circle mr-2"}),U(" This action cannot be undone. The opportunity will be permanently removed and replaced with a new lead. ")])])],-1))]),_:1},8,["show"]))}},ca={class:"flex justify-between items-start mb-3"},pa={class:"font-bold text-slate-800 text-sm"},ma={class:"text-xs text-gray-500 mt-0.5"},ya={class:"flex gap-3 flex-wrap"},ga={__name:"PrimaryActionWidget",props:{action:{type:Object,required:!0},colorScheme:{type:Object,required:!0}},emits:["action-clicked"],setup(s){return(k,t)=>(a(),u("div",{class:B(["rounded-lg p-4 relative transition-all duration-300 border",[s.colorScheme.background,s.colorScheme.border]])},[e("div",ca,[e("div",null,[e("h4",pa,$(s.action.title),1),e("p",ma,$(s.action.description),1)])]),e("div",ya,[e("button",{onClick:t[0]||(t[0]=n=>k.$emit("action-clicked")),class:B([s.action.buttonClass,"font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"])},[e("i",{class:B(s.action.icon)},null,2),U(" "+$(s.action.label),1)],2)])],2))}},fa={key:0,class:"bg-white border border-gray-200 rounded-xl shadow-sm mb-8"},va={class:"p-5 space-y-6"},ba={key:0,class:"bg-green-50/50 border border-green-100 rounded-lg p-4"},xa={class:"flex gap-3"},ha={key:2,class:"space-y-3"},wa={class:"flex items-center gap-2 pb-2 border-b border-gray-200"},ka={class:"font-semibold text-gray-900 text-sm"},Ca={key:3,class:"flex justify-end"},Sa={__name:"OpportunityManagementWidget",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,default:null},activities:{type:Array,default:()=>[]}},emits:["vehicle-selected","offer-created","appointment-scheduled"],setup(s,{emit:k}){const t=s,n=k,d=Ke(),o=Je(),p=I(!1),c=I(!1),x=I(!1),b=I(!1),S=I(!1),y=I(!1),m=I(!1),v=I(!1),w=I(!1),A=I(!1),K=I([]),T=q(()=>{var Q,E;return((Q=t.opportunity)==null?void 0:Q.displayStage)||((E=t.opportunity)==null?void 0:E.stage)||"Qualified"});q(()=>ze(T.value,"opportunity"));function i(Q){return Q?new Date(Q).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}):""}const g={"schedule-appointment":()=>{p.value=!0},"view-or-schedule-appointment":()=>{t.scheduledAppointment?w.value=!0:p.value=!0},"select-vehicle":()=>{m.value=!0},"create-offer":()=>{!t.opportunity.selectedVehicle&&!t.opportunity.vehicle?m.value=!0:c.value=!0},"call-prospect":()=>{v.value=!0},"follow-up-offer":()=>{v.value=!0},"request-decision":()=>{v.value=!0},"finalize-contract":()=>{b.value=!0},"schedule-delivery":()=>{S.value=!0},"confirm-delivery":()=>{S.value=!0},"collect-feedback":()=>{v.value=!0},reschedule:()=>{A.value=!0},"cancel-appointment":()=>{confirm("Are you sure you want to cancel this appointment?")&&be()},"close-won":()=>{b.value=!0},"add-offer":()=>{c.value=!0},"add-contract":()=>{b.value=!0},"extend-deadline":()=>{v.value=!0},"close-lost":()=>{x.value=!0},reopen:()=>{ce()},requalify:()=>{y.value=!0}},{primaryAction:f,secondaryActions:F,activeTaskWidget:Y,taskWidgetTitle:C,isClosed:O}=$n(We(t,"opportunity"),We(t,"scheduledAppointment"),We(t,"activities"),g,i);function P(Q){}function te(){}function W(Q){m.value=!1,n("vehicle-selected",Q),setTimeout(()=>{c.value=!0},300)}function ne(Q){c.value=!1,n("offer-created",Q)}function ye(Q){p.value=!1,n("appointment-scheduled",{...Q,opportunityId:t.opportunity.id,customer:t.opportunity.customer.name})}function be(){t.scheduledAppointment&&n("appointment-cancelled",t.scheduledAppointment.id)}function ue(Q){b.value=!1,o.modifyOpportunity(t.opportunity.id,{stage:"Closed Won",contractDate:Q.contractDate})}function pe(Q){S.value=!1,o.addActivity(t.opportunity.id,{type:"delivery",user:"You",action:"marked as delivered",data:Q})}function oe(Q){x.value=!1,o.modifyOpportunity(t.opportunity.id,{stage:"Closed Lost",lossReason:Q})}function ce(){o.modifyOpportunity(t.opportunity.id,{stage:"Qualified"})}function re(Q){y.value=!1,d.push(`/customer/${Q.id}?type=lead`)}function xe(Q){w.value=!1}function Ce(Q){A.value=!1}function Se(Q){o.modifyOpportunity(t.opportunity.id,{callbackDate:Q.callbackDate})}function $e(Q){o.modifyOpportunity(t.opportunity.id,{stage:"Closed Lost",lossReason:Q.reason||"Multiple no-shows (NS3)"})}return Ne(()=>{K.value=he.filter(Q=>Q.stockDays!==null&&Q.stockDays!==void 0).slice(0,5)}),(Q,E)=>s.opportunity?(a(),u("div",fa,[E[17]||(E[17]=e("div",{class:"p-4 border-b border-gray-100 bg-gray-50/50"},[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-clipboard-check text-gray-400 text-xs"}),e("h3",{class:"font-bold text-gray-800 text-sm"},"Manage next steps")])],-1)),e("div",va,[M(O)&&!M(Y)?(a(),u("div",ba,[E[15]||(E[15]=e("div",{class:"flex justify-between items-start mb-3"},[e("div",null,[e("h4",{class:"font-bold text-slate-800 text-sm"},"Opportunity Closed"),e("p",{class:"text-xs text-gray-500 mt-0.5"}," This opportunity has been closed. Reopen it to restart the management process, or requalify as a lead. ")])],-1)),e("div",xa,[e("button",{onClick:ce,class:"bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm"},[...E[13]||(E[13]=[U(" Reopen ",-1),e("i",{class:"fa-solid fa-rotate-left"},null,-1)])]),e("button",{onClick:E[0]||(E[0]=ee=>y.value=!0),class:"bg-white hover:bg-yellow-50 text-yellow-700 border border-yellow-300 font-medium px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors"},[...E[14]||(E[14]=[U(" Requalify as Lead ",-1),e("i",{class:"fa-solid fa-arrow-left"},null,-1)])])])])):D("",!0),!M(O)&&M(f)?(a(),G(ga,{key:1,action:M(f),"color-scheme":M(f).colorScheme,onActionClicked:E[1]||(E[1]=ee=>M(f).handler())},null,8,["action","color-scheme"])):D("",!0),M(Y)&&M(Y).component?(a(),u("div",ha,[e("div",wa,[E[16]||(E[16]=e("i",{class:"fa-solid fa-clipboard-check text-blue-600 text-sm"},null,-1)),e("h5",ka,$(M(C)),1)]),(a(),G($t(M(Y).component),Pe(M(Y).props,{onClose:te,onSetCallback:Se,onAutoCloseLost:$e}),null,16))])):D("",!0),M(F).length>0?(a(),u("div",Ca,[J(Nn,{actions:M(F),onActionSelected:P},null,8,["actions"])])):D("",!0),p.value?(a(),G(Ft,{key:4,show:p.value,customer:s.opportunity.customer,assignee:s.opportunity.assignee,"disabled-fields":["customer"],onCreate:ye,onCancel:E[2]||(E[2]=ee=>p.value=!1)},null,8,["show","customer","assignee"])):D("",!0)]),m.value?(a(),G(ta,{key:0,opportunity:s.opportunity,"requested-car":s.opportunity.requestedCar,"recommended-cars":K.value,onVehicleSelected:W,onClose:E[3]||(E[3]=ee=>m.value=!1)},null,8,["opportunity","requested-car","recommended-cars"])):D("",!0),c.value?(a(),G(Rt,{key:1,opportunity:s.opportunity,vehicle:s.opportunity.selectedVehicle||s.opportunity.vehicle||s.opportunity.requestedCar,onOfferCreated:ne,onClose:E[4]||(E[4]=ee=>c.value=!1)},null,8,["opportunity","vehicle"])):D("",!0),b.value?(a(),G(la,{key:2,opportunity:s.opportunity,onContractSet:ue,onClose:E[5]||(E[5]=ee=>b.value=!1)},null,8,["opportunity"])):D("",!0),S.value?(a(),G(ia,{key:3,opportunity:s.opportunity,onDelivered:pe,onClose:E[6]||(E[6]=ee=>S.value=!1)},null,8,["opportunity"])):D("",!0),x.value?(a(),G(da,{key:4,opportunity:s.opportunity,onClosed:oe,onClose:E[7]||(E[7]=ee=>x.value=!1)},null,8,["opportunity"])):D("",!0),y.value?(a(),G(ua,{key:5,opportunity:s.opportunity,onRequalified:re,onClose:E[8]||(E[8]=ee=>y.value=!1)},null,8,["opportunity"])):D("",!0),v.value?(a(),G(Mt,{key:6,onClose:E[9]||(E[9]=ee=>v.value=!1)})):D("",!0),w.value&&s.scheduledAppointment?(a(),G(Vt,{key:7,show:w.value,event:s.scheduledAppointment,onClose:E[10]||(E[10]=ee=>w.value=!1),onEdit:E[11]||(E[11]=ee=>{w.value=!1,A.value=!0}),onDelete:xe},null,8,["show","event"])):D("",!0),A.value&&s.scheduledAppointment?(a(),G(Bt,{key:8,show:A.value,event:s.scheduledAppointment,customer:s.opportunity.customer,"disabled-fields":["customer"],onSave:Ce,onCancel:E[12]||(E[12]=ee=>A.value=!1)},null,8,["show","event","customer"])):D("",!0)])):D("",!0)}};function $a(s){const k=Ge(),t=Je(),n=q(()=>s.value?s.value.type==="lead"?Ml:Sa:null),d=q(()=>s.value?s.value.type==="lead"?{currentActivities:q(()=>k.currentLeadActivities),addActivity:(p,c)=>k.addActivity(p,c),updateActivity:(p,c,x)=>k.updateActivity(p,c,x),deleteActivity:(p,c)=>k.deleteActivity(p,c),updateLead:(p,c)=>k.updateLead(p,c),loadLeadById:p=>k.loadLeadById(p)}:{currentActivities:q(()=>t.currentOpportunityActivities),addActivity:(p,c)=>t.addActivity(p,c),updateActivity:(p,c,x)=>t.updateActivity(p,c,x),deleteActivity:(p,c)=>t.deleteActivity(p,c),addVehicle:(p,c)=>t.addVehicle(p,c),createOffer:(p,c)=>t.createOffer(p,c),updateOpportunity:(p,c)=>t.updateOpportunity(p,c),loadOpportunityById:p=>t.loadOpportunityById(p)}:null),o=q(()=>s.value?{overviewActions:["financing","tradein","purchase"],tabActions:["note","call","email","sms","whatsapp","attachment"]}:{overviewActions:[],tabActions:[]});return{managementWidget:n,storeAdapter:d,addNewConfig:o}}const Aa={key:0,class:"mb-8"},Da={class:"flex items-center gap-2 mb-4"},Ta={class:"font-bold text-gray-800 text-sm"},La={class:"bg-white border border-gray-200 rounded-xl shadow-sm mb-6 overflow-hidden"},Ia={class:"p-4"},Oa={class:"flex items-center justify-between"},qa={class:"flex items-center gap-4"},Na={class:"w-16 h-12 bg-gray-200 rounded-md overflow-hidden shrink-0 border border-gray-100"},Ra=["src"],Ma={key:1,class:"fa-solid fa-car text-3xl text-gray-400 w-full h-full flex items-center justify-center"},Fa={class:"flex items-center gap-2"},Va={class:"font-bold text-slate-800 text-sm md:text-base"},Ba={class:"mt-1.5 flex items-center gap-2"},Ua={key:0,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-green-50 border border-green-100 text-green-700 text-[10px] font-semibold rounded-md"},Wa={key:1,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-orange-50 border border-orange-100 text-orange-700 text-[10px] font-semibold rounded-md"},Ea={key:2,class:"hidden sm:flex items-center gap-1.5 bg-gray-100 hover:bg-gray-200 border border-gray-200 text-slate-700 text-xs font-semibold px-3 py-1.5 rounded-full transition-colors group/btn"},ja={class:"flex items-center gap-4"},Pa={key:0,class:"text-right"},Ha={class:"font-bold text-slate-800"},Qa={key:0,class:"mt-4 pt-4 border-t border-gray-200"},za={class:"bg-gray-50 border border-gray-200 rounded-lg p-3"},Ya={class:"text-sm text-slate-700 leading-relaxed"},Ka={class:"border-t border-gray-200"},Ga={class:"font-medium"},Ja={key:0,class:"border-t border-gray-100 p-6 bg-gray-50/30 text-sm animate-fade-in"},Xa={class:"mb-6"},Za={class:"grid grid-cols-2 md:grid-cols-4 gap-y-4 gap-x-6"},_a={key:0},ei={class:"font-medium text-slate-700"},ti={key:1},si={class:"font-medium text-slate-700"},oi={key:2},li={class:"font-medium text-slate-700"},ni={class:"font-medium text-slate-700"},ai={class:"grid grid-cols-2 md:grid-cols-4 gap-y-4 gap-x-6"},ii={key:0},ri={class:"font-medium text-slate-700"},di={key:1},ui={class:"font-medium text-slate-700"},ci={key:2},pi={class:"font-medium text-slate-700"},mi={key:3},yi={class:"font-medium text-slate-700"},gi={key:4},fi={class:"font-mono text-xs bg-white border border-gray-200 px-2 py-1 rounded inline-block text-gray-600"},vi={key:5},bi={class:"font-medium text-slate-700"},xi={key:0,class:"mt-6 flex justify-end"},it={__name:"VehicleWidget",props:{show:{type:Boolean,default:!0},label:{type:String,default:"Requested Car"},brand:{type:String,required:!0},model:{type:String,required:!0},year:{type:[Number,String],required:!0},image:{type:String,default:""},price:{type:Number,default:null},requestMessage:{type:String,default:""},requestType:{type:String,default:""},source:{type:String,default:""},dealership:{type:String,default:""},registration:{type:String,default:""},kilometers:{type:Number,default:null},fuelType:{type:String,default:""},gearType:{type:String,default:""},vin:{type:String,default:""},stockDays:{type:Number,default:null},showOpenAd:{type:Boolean,default:!0},showTechnicalSpecs:{type:Boolean,default:!0},channel:{type:String,default:"Email"},adCampaign:{type:String,default:""},expectedPurchaseDate:{type:String,default:""},fiscalEntity:{type:String,default:""},sourceDetails:{type:String,default:""},adMedium:{type:String,default:""},adSource:{type:String,default:""}},setup(s){const k=I(!1),t=d=>new Intl.NumberFormat("en-US").format(d),n=d=>new Intl.NumberFormat("en-US").format(d);return(d,o)=>s.show?(a(),u("div",Aa,[e("div",Da,[o[1]||(o[1]=e("i",{class:"fa-solid fa-thumbtack text-gray-400 text-xs"},null,-1)),e("h3",Ta,$(s.label),1)]),e("div",La,[e("div",Ia,[e("div",Oa,[e("div",qa,[e("div",Na,[s.image?(a(),u("img",{key:0,src:s.image,alt:"Car",class:"w-full h-full object-cover"},null,8,Ra)):(a(),u("i",Ma))]),e("div",null,[e("div",Fa,[e("div",Va,$(s.brand)+" "+$(s.model)+" ("+$(s.year)+")",1)]),e("div",Ba,[s.stockDays!==void 0&&s.stockDays!==null?(a(),u("div",Ua,[o[2]||(o[2]=e("div",{class:"w-1 h-1 bg-green-500 rounded-full"},null,-1)),U(" In stock ("+$(s.stockDays)+" days) ",1)])):(a(),u("div",Wa,[...o[3]||(o[3]=[e("div",{class:"w-1 h-1 bg-orange-500 rounded-full"},null,-1),U(" Out of stock ",-1)])])),s.showOpenAd&&s.price?(a(),u("button",Ea,[...o[4]||(o[4]=[U(" Open Ad ",-1),e("i",{class:"fa-solid fa-arrow-up-right-from-square text-[10px] text-gray-400 group-hover/btn:text-gray-800"},null,-1)])])):D("",!0)])])]),e("div",ja,[s.price?(a(),u("div",Pa,[o[5]||(o[5]=e("div",{class:"text-xs text-gray-500 font-medium mb-0.5"},"Price",-1)),e("div",Ha,"â‚¬ "+$(t(s.price)),1)])):D("",!0)])]),s.requestMessage?(a(),u("div",Qa,[o[6]||(o[6]=e("div",{class:"text-xs text-gray-500 font-medium mb-2"},"Request Message",-1)),e("div",za,[e("p",Ya,$(s.requestMessage),1)])])):D("",!0)]),e("div",Ka,[e("button",{onClick:o[0]||(o[0]=p=>k.value=!k.value),class:"w-full p-3 flex items-center justify-center gap-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-colors"},[e("span",Ga,$(k.value?"Hide":"View")+" Details",1),e("i",{class:B(["fa-solid fa-chevron-down text-xs transition-transform duration-200",{"rotate-180":k.value}])},null,2)])]),k.value?(a(),u("div",Ja,[e("div",Xa,[o[17]||(o[17]=e("h4",{class:"text-xs font-bold uppercase text-gray-500 tracking-wider mb-4"},"REQUEST DETAILS",-1)),e("div",Za,[s.requestType?(a(),u("div",_a,[o[7]||(o[7]=e("div",{class:"text-xs text-gray-500 mb-1"},"Request type",-1)),e("div",ei,$(s.requestType),1)])):D("",!0),s.source?(a(),u("div",ti,[o[8]||(o[8]=e("div",{class:"text-xs text-gray-500 mb-1"},"Source",-1)),e("div",si,$(s.source),1)])):D("",!0),e("div",null,[o[9]||(o[9]=e("div",{class:"text-xs text-gray-500 mb-1"},"Source details",-1)),e("div",{class:B(["font-medium",s.sourceDetails?"text-slate-700":"text-gray-400"])},$(s.sourceDetails||"--"),3)]),s.dealership?(a(),u("div",oi,[o[10]||(o[10]=e("div",{class:"text-xs text-gray-500 mb-1"},"Dealership",-1)),e("div",li,$(s.dealership),1)])):D("",!0),e("div",null,[o[11]||(o[11]=e("div",{class:"text-xs text-gray-500 mb-1"},"Channel",-1)),e("div",ni,$(s.channel||"Email"),1)]),e("div",null,[o[12]||(o[12]=e("div",{class:"text-xs text-gray-500 mb-1"},"AdCampaign",-1)),e("div",{class:B(["font-medium",s.adCampaign?"text-slate-700":"text-gray-400"])},$(s.adCampaign||"--"),3)]),e("div",null,[o[13]||(o[13]=e("div",{class:"text-xs text-gray-500 mb-1"},"AdMedium",-1)),e("div",{class:B(["font-medium",s.adMedium?"text-slate-700":"text-gray-400"])},$(s.adMedium||"--"),3)]),e("div",null,[o[14]||(o[14]=e("div",{class:"text-xs text-gray-500 mb-1"},"AdSource",-1)),e("div",{class:B(["font-medium",s.adSource?"text-slate-700":"text-gray-400"])},$(s.adSource||"--"),3)]),e("div",null,[o[15]||(o[15]=e("div",{class:"text-xs text-gray-500 mb-1"},"Expected purchase date",-1)),e("div",{class:B(["font-medium",s.expectedPurchaseDate?"text-slate-700":"text-gray-400"])},$(s.expectedPurchaseDate||"--"),3)]),e("div",null,[o[16]||(o[16]=e("div",{class:"text-xs text-gray-500 mb-1"},"Fiscal entity",-1)),e("div",{class:B(["font-medium",s.fiscalEntity?"text-slate-700":"text-gray-400"])},$(s.fiscalEntity||"--"),3)])])]),o[26]||(o[26]=e("div",{class:"border-t border-gray-200 my-4"},null,-1)),e("div",null,[o[25]||(o[25]=e("div",{class:"flex justify-between items-center mb-4"},[e("h4",{class:"text-xs font-bold uppercase text-gray-500 tracking-wider"},"VEHICLE DETAILS")],-1)),e("div",ai,[s.registration?(a(),u("div",ii,[o[18]||(o[18]=e("div",{class:"text-xs text-gray-500 mb-1"},"Registration",-1)),e("div",ri,$(s.registration),1)])):D("",!0),s.kilometers!==void 0&&s.kilometers!==null?(a(),u("div",di,[o[19]||(o[19]=e("div",{class:"text-xs text-gray-500 mb-1"},"Kilometers",-1)),e("div",ui,$(n(s.kilometers))+" Km",1)])):D("",!0),s.fuelType?(a(),u("div",ci,[o[20]||(o[20]=e("div",{class:"text-xs text-gray-500 mb-1"},"Fuel type",-1)),e("div",pi,$(s.fuelType),1)])):D("",!0),s.gearType?(a(),u("div",mi,[o[21]||(o[21]=e("div",{class:"text-xs text-gray-500 mb-1"},"Gear type",-1)),e("div",yi,$(s.gearType),1)])):D("",!0),s.vin?(a(),u("div",gi,[o[22]||(o[22]=e("div",{class:"text-xs text-gray-500 mb-1"},"VIN Number",-1)),e("div",fi,$(s.vin),1)])):D("",!0),s.dealership?(a(),u("div",vi,[o[23]||(o[23]=e("div",{class:"text-xs text-gray-500 mb-1"},"Dealership",-1)),e("div",bi,$(s.dealership),1)])):D("",!0)]),s.showTechnicalSpecs?(a(),u("div",xi,[...o[24]||(o[24]=[e("button",{class:"bg-white border border-gray-200 text-slate-700 hover:text-blue-600 hover:border-blue-200 font-medium px-4 py-2 rounded-lg text-xs transition-colors flex items-center gap-2 group"},[e("i",{class:"fa-solid fa-list-check text-gray-400 group-hover:text-blue-500"}),U(" View technical specs ")],-1)])])):D("",!0)])])):D("",!0)])])):D("",!0)}},hi={class:"h-full flex flex-col lg:flex-row overflow-hidden bg-gray-50"},wi={key:0,class:"lg:hidden bg-gray-50 border-b border-gray-200 shrink-0"},ki={key:1,class:"flex-1 flex flex-col lg:flex-row overflow-hidden min-w-0"},Ci={key:0},Si={key:1},$i={key:0},Ai={key:1},Di={key:2},Ti=["onClick"],Li=["onClick"],Ii=["onClick"],Oi=["onClick"],qi={key:0,class:"flex-1 flex flex-col overflow-hidden lg:border-l border-gray-200"},Ni={key:1,class:"hidden lg:flex flex-1 flex-col overflow-hidden lg:border-l border-gray-200"},Ri={key:2,class:"flex-1 flex flex-col lg:flex-row overflow-hidden min-w-0"},Mi={key:0,class:"flex-1 flex flex-col overflow-hidden lg:border-l border-gray-200"},Fi={__name:"Tasks",setup(s){const k=At(),t=Ke(),n=Ge(),d=Je(),o=Ve(),p=Xe(),c=we(),x=I(localStorage.getItem("tasksViewMode")||"table"),b=q(()=>k.query.highlight||null);de(x,r=>{localStorage.setItem("tasksViewMode",r)});const S=r=>{x.value;const L=W.value;if(x.value=r,r==="table"&&L)t.push({path:"/tasks",query:{highlight:L.compositeId}});else if(r==="card"&&b.value){const[N,V]=b.value.split("-");t.push({path:`/tasks/${V}`,query:{type:N}})}else r==="card"&&!b.value&&!W.value&&t.push({path:"/tasks"})},y=r=>{if(!r)return"No deadline";const L=ut(r);return L.type==="overdue"?"OVERDUE":L.type==="today"||L.type==="urgent"?L.relativeTime:ct(r)},m=r=>{const L=r.type==="lead"?r.requestedCar:r.vehicle;return!L||!L.type?null:{New:{type:"new",label:"New"},"New 0km":{type:"0km",label:"New 0km"},Used:{type:"used",label:"Used"},Demo:{type:"demo",label:"Demo"}}[L.type]||{type:L.type.toLowerCase(),label:L.type}},v=r=>r?{new:"bg-green-50 text-green-700","0km":"bg-blue-50 text-blue-700",used:"bg-orange-50 text-orange-700",demo:"bg-purple-50 text-purple-700"}[r.type]||"bg-gray-50 text-gray-700":"",w=r=>{if(!r||!r.assignee)return{name:"Unassigned",initials:"?"};const L=r.assigneeInitials||r.assignee.split(" ").map(N=>N[0]).join("");return{name:r.assignee,initials:L}},A=r=>{if(!r||!r.customer||!r.customer.address)return null;const N=r.customer.address.split(",");return N.length>1&&N[N.length-1].trim().replace(/^\d+\s*/,"").trim()||null},K=r=>{const L=A(r),N=r.source||"Unknown";return L?`${L} â€¢ ${N}`:N},T=r=>{const L=r.type==="lead"?r.requestedCar:r.vehicle;if(!L)return"No vehicle";const N=m(r),V=N?N.label:L.type||"Unknown";let h="";return L.kilometers!==void 0&&L.kilometers!==null&&(L.kilometers>=1e3?h=`${(L.kilometers/1e3).toFixed(0)}k`:h=`${L.kilometers}`),h?`${V} / ${h}`:V},i=I("all"),g=I("none"),f=I(!1),F=I(null);I(!1);const Y=I(!1),C=I(null),O=q(()=>{const L=(f.value?n.leads:n.leads.filter(h=>!h.isDisqualified)).map(h=>{const H=Ye(h,"lead"),Z={...h,type:"lead",compositeId:`lead-${h.id}`,displayStage:H};return!Z.customer&&h.customer&&(Z.customer=h.customer),Z}),N=d.opportunities.map(h=>{const H={...h,type:"opportunity",compositeId:`opportunity-${h.id}`};return!H.customer&&h.customer&&(H.customer=h.customer),H});let V=[];return o.isOperator()?V=L:o.isSalesman()?V=N:V=[...L,...N],V}),P=q(()=>{let r=O.value;i.value!=="all"&&(r=r.filter(N=>N.type===i.value));const L=c.getSetting("urgencyEnabled")!==!1;if(L&&(r=r.map(N=>{if(N.type==="lead"&&!N.urgencyScore){const V=mt(N);return{...N,urgencyScore:V.score,urgencyLevel:V.level}}return N})),g.value==="urgent-first")L?r=[...r].sort((N,V)=>{if(N.type==="lead"&&V.type==="lead"){const Z=N.urgencyScore||0,ge=V.urgencyScore||0;if(Z!==ge)return ge-Z;const Re=new Date(N.createdAt||0);return new Date(V.createdAt||0)-Re}if(N.type==="lead"&&V.type==="opportunity")return-1;if(N.type==="opportunity"&&V.type==="lead")return 1;if(N.priority==="Hot"&&V.priority!=="Hot")return-1;if(N.priority!=="Hot"&&V.priority==="Hot")return 1;const h=new Date(N.lastActivity||N.createdAt||0);return new Date(V.lastActivity||V.createdAt||0)-h}):r=[...r].sort((N,V)=>{if(N.priority==="Hot"&&V.priority!=="Hot")return-1;if(N.priority!=="Hot"&&V.priority==="Hot")return 1;const h=new Date(N.lastActivity||N.createdAt||0);return new Date(V.lastActivity||V.createdAt||0)-h});else if(g.value==="assigned-to-me"){const N=o.currentUser.name;r=r.filter(V=>V.assignee===N),r=[...r].sort((V,h)=>{const H=new Date(V.lastActivity||V.createdAt||0);return new Date(h.lastActivity||h.createdAt||0)-H})}else if(g.value==="assigned-to-my-team"){const N=o.currentUser;let V=[];N.role==="manager"?V=p.users.map(h=>h.name):N.role==="salesman"?V=p.users.filter(h=>h.role==="salesman").map(h=>h.name):N.role==="operator"&&(V=p.users.filter(h=>h.role==="operator").map(h=>h.name)),r=r.filter(h=>V.includes(h.assignee)),r=[...r].sort((h,H)=>{const Z=new Date(h.lastActivity||h.createdAt||0);return new Date(H.lastActivity||H.createdAt||0)-Z})}else r=[...r].sort((N,V)=>{const h=new Date(N.lastActivity||N.createdAt||0);return new Date(V.lastActivity||V.createdAt||0)-h});return r}),te=q(()=>{const r=O.value.some(N=>N.type==="lead"),L=O.value.some(N=>N.type==="opportunity");return r&&L}),W=q(()=>{if(!k.params.id)return null;const r=parseInt(k.params.id);if(isNaN(r))return null;const L=k.query.type;if(L){const Z=`${L}-${r}`;return O.value.find(ge=>ge.compositeId===Z)||null}const N=i.value!=="all"?O.value.filter(Z=>Z.type===i.value):O.value,V=`lead-${r}`,h=`opportunity-${r}`,H=N.find(Z=>Z.compositeId===V||Z.compositeId===h);return H||O.value.find(Z=>Z.compositeId===V||Z.compositeId===h)||null});q(()=>W.value?W.value.type==="lead"?n.currentLeadActivities:d.currentOpportunityActivities:[]);const ne=q(()=>{if(!W.value)return null;let r=null;return W.value.type==="lead"&&W.value.requestedCar?r=W.value.requestedCar:W.value.type==="opportunity"&&(r=W.value.vehicle||W.value.requestedCar),!r||!r.brand||!r.model?null:{show:!0,label:"Requested Car",brand:r.brand,model:r.model,year:r.year,image:r.image||"",price:r.price||null,requestMessage:r.requestMessage||"",requestType:W.value.requestType||r.requestType||"",source:W.value.source||r.source||"",dealership:r.dealership||"",registration:r.registration||"",kilometers:r.kilometers!==void 0?r.kilometers:null,fuelType:r.fuelType||"",gearType:r.gearType||"",vin:r.vin||"",stockDays:r.stockDays!==void 0?r.stockDays:null,showOpenAd:!0,showTechnicalSpecs:!0,channel:"Email",adCampaign:W.value.sourceDetails||r.adCampaign||"",expectedPurchaseDate:r.expectedPurchaseDate||"",fiscalEntity:W.value.fiscalEntity||"",sourceDetails:W.value.sourceDetails||"",adMedium:r.adMedium||"",adSource:r.adSource||""}}),ye=$a(W),be=ye.managementWidget,ue=ye.storeAdapter,pe=ye.addNewConfig,oe=q(()=>r=>r.type==="lead"?"bg-white border border-gray-200 hover:border-blue-300":"bg-white border border-gray-200 hover:border-purple-300");Ne(()=>{n.loadLeads(),d.loadOpportunities();const r=k.params.id;r&&ce(r)}),de(()=>k.params.id,r=>{r&&ce(r)}),de(W,r=>{r&&(r.type==="lead"?n.loadLeadById(r.id):d.loadOpportunityById(r.id))},{immediate:!0});const ce=r=>{const L=parseInt(r),N=O.value.find(V=>V.id===L);N&&(N.type==="lead"?n.loadLeadById(L):d.loadOpportunityById(L))},re=r=>{const[L,N]=r.split("-");t.push({path:`/tasks/${N}`,query:{type:L}})},xe=()=>{t.push({path:"/tasks"})},Ce=r=>{F.value=F.value===r?null:r},Se=r=>{C.value=r,Y.value=!0,F.value=null},$e=r=>{g.value=r},Q=async r=>{if(!C.value)return;const L=C.value,N=r.name;L.type==="lead"?await n.modifyLead(L.id,{assignee:N,assigneeType:r.type,teamId:r.type==="team"?r.id:null}):L.type==="opportunity"&&await d.updateOpportunity(L.id,{assignee:N,assigneeType:r.type,teamId:r.type==="team"?r.id:null}),Y.value=!1,C.value=null},E=async r=>{F.value=null,r.type==="lead"?await n.modifyLead(r.id,{priority:"Hot"}):r.type==="opportunity"&&await d.modifyOpportunity(r.id,{priority:"Hot"})},ee=async r=>{F.value=null,r.type==="lead"?await n.modifyLead(r.id,{priority:"Normal"}):r.type==="opportunity"&&await d.modifyOpportunity(r.id,{priority:"Normal"})},Ae=async r=>{if(F.value=null,r.type==="lead")try{const L=r.displayStage||r.stage||se.NEW,N=se.NEW,V=He(L,N);if(V){const{updates:h,activities:H}=V(r);await n.modifyLead(r.id,h);for(const Z of H)await n.addActivity(r.id,Z)}else await n.modifyLead(r.id,{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open Lead",status:"Open",nextActionDue:null,scheduledAppointment:null}),await n.addActivity(r.id,{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"});await n.loadLeadById(r.id)}catch(L){console.error("Failed to reopen lead:",L)}},Be=r=>({Open:"bg-blue-50 text-blue-700","Open Opportunities":"bg-blue-50 text-blue-700","Open opportunity":"bg-blue-50 text-blue-700",Qualified:"bg-purple-50 text-purple-700","In Negotiation":"bg-orange-50 text-orange-700","Opportunity in negotiation":"bg-orange-50 text-orange-700",Registration:"bg-indigo-50 text-indigo-700",Closed:"bg-gray-100 text-gray-700","Closed opportunity":"bg-gray-100 text-gray-700","Closed Lost":"bg-red-50 text-red-700",Won:"bg-green-50 text-green-700",Lost:"bg-red-50 text-red-700",Valid:"bg-green-50 text-green-700","Not valid":"bg-red-50 text-red-700","To be validated":"bg-yellow-50 text-yellow-700","Not interested":"bg-gray-100 text-gray-700"})[r]||"bg-gray-100 text-gray-700";return(r,L)=>{var N,V;return a(),u("div",hi,[W.value?(a(),u("div",wi,[e("div",{class:"px-4 py-3 flex items-center justify-between gap-3"},[e("button",{onClick:xe,class:"w-11 h-11 flex items-center justify-center text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors shrink-0","aria-label":"Back to task list"},[...L[6]||(L[6]=[e("i",{class:"fa-solid fa-arrow-left text-lg"},null,-1)])])])])):D("",!0),x.value==="card"?(a(),u("div",ki,[e("div",{class:B(["flex flex-col overflow-hidden",W.value?"hidden lg:flex shrink-0":"w-full lg:w-auto lg:shrink-0"])},[J(Is,{title:"Tasks",items:P.value,"selected-id":(N=W.value)==null?void 0:N.compositeId,"type-filter":i.value,"view-mode":x.value,"selected-class":h=>h.type==="lead"?"bg-white border-2 border-blue-500 shadow-md":"bg-white border-2 border-purple-500 shadow-md","unselected-class":oe.value,"open-menu-id":F.value,getName:h=>{const H=h.customer;return H&&H.name?H.name:H&&!H.name&&H.email&&H.email.split("@")[0]||"Unknown"},getInitials:h=>{const H=h.customer;return H&&H.initials?H.initials:H&&H.name&&H.name.split(" ").map(ge=>ge[0]).filter(Boolean).join("").toUpperCase().slice(0,2)||"?"},getVehicleInfo:h=>h.type==="lead"?h.requestedCar?`${h.requestedCar.brand} ${h.requestedCar.model}`:"No vehicle specified":h.vehicle?`${h.vehicle.brand} ${h.vehicle.model}`:"No vehicle specified",avatarClass:h=>h.type==="lead"?"bg-orange-100 text-orange-600":"bg-purple-100 text-purple-600","show-mobile-close":!1,onSelect:re,onMenuClick:Ce,onMenuClose:L[0]||(L[0]=h=>F.value=null),onClose:xe,"show-type-filter":te.value,onFilterChange:L[1]||(L[1]=h=>i.value=h),onSortChange:$e,onViewChange:S},{badges:X(({item:h})=>[h&&h.type?(a(),G(M(Fe),{key:0,text:h.type==="lead"?"Lead":"Opportunity",size:"small",theme:h.type==="lead"?"blue":"gray"},null,8,["text","theme"])):D("",!0),h&&h.type==="lead"&&M(c).getSetting("urgencyEnabled")!==!1&&h.urgencyLevel?(a(),G(M(Fe),{key:1,text:`${M(yt)(h.urgencyLevel)} ${h.urgencyLevel}`,size:"small",class:B(M(gt)(h.urgencyLevel))},null,8,["text","class"])):D("",!0),h&&h.priority==="Hot"&&(M(c).getSetting("urgencyEnabled")===!1||h.type!=="lead")?(a(),G(M(Fe),{key:2,text:"HOT",size:"small",theme:"red"})):D("",!0)]),location:X(({item:h})=>[U($(K(h)),1)]),"vehicle-status":X(({item:h})=>[U($(T(h)),1)]),owner:X(({item:h})=>[h.assignee?(a(),u("span",Ci,$(h.assignee),1)):(a(),u("span",Si,"Unassigned"))]),dates:X(({item:h})=>[h.type==="lead"&&h.nextActionDue?(a(),u("span",$i,"Due: "+$(y(h.nextActionDue)),1)):h.type==="opportunity"&&h.nextActionDue?(a(),u("span",Ai,"Due: "+$(y(h.nextActionDue)),1)):(a(),u("span",Di,"Due: No deadline"))]),menu:X(({item:h})=>[h.type==="lead"&&(h.isDisqualified||h.stage&&h.stage.startsWith("Closed")||h.displayStage&&h.displayStage.startsWith("Closed"))?(a(),u("button",{key:0,onClick:fe(H=>Ae(h),["stop"]),class:"w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-gray-50 flex items-center gap-2"},[...L[7]||(L[7]=[e("i",{class:"fa-solid fa-rotate-left text-blue-500"},null,-1),U(" Reopen Lead ",-1)])],8,Ti)):D("",!0),e("button",{onClick:fe(H=>Se(h),["stop"]),class:"w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-gray-50 flex items-center gap-2"},[...L[8]||(L[8]=[e("i",{class:"fa-solid fa-share text-gray-400"},null,-1),U(" Reassign ",-1)])],8,Li),h.priority!=="Hot"?(a(),u("button",{key:1,onClick:fe(H=>E(h),["stop"]),class:"w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-gray-50 flex items-center gap-2"},[...L[9]||(L[9]=[e("i",{class:"fa-solid fa-fire text-orange-500"},null,-1),U(" Mark as hot ",-1)])],8,Ii)):(a(),u("button",{key:2,onClick:fe(H=>ee(h),["stop"]),class:"w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-gray-50 flex items-center gap-2"},[...L[10]||(L[10]=[e("i",{class:"fa-regular fa-snowflake text-gray-400"},null,-1),U(" Unmark as hot ",-1)])],8,Oi))]),_:1},8,["items","selected-id","type-filter","view-mode","selected-class","unselected-class","open-menu-id","getName","getInitials","getVehicleInfo","avatarClass","show-type-filter"])],2),W.value?(a(),u("div",qi,[J(ot,{task:W.value,type:W.value.type,"management-widget":M(be),"store-adapter":M(ue),"add-new-config":M(pe)},{"pinned-extra":X(({task:h})=>[ne.value?(a(),G(it,st(Pe({key:0},ne.value)),null,16)):D("",!0)]),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])])):D("",!0),W.value?D("",!0):(a(),u("div",Ni,[...L[11]||(L[11]=[e("div",{class:"flex-1 flex items-center justify-center"},[e("div",{class:"text-center"},[e("i",{class:"fa-solid fa-tasks text-6xl text-gray-300 mb-4"}),e("p",{class:"text-gray-500"},"Select a task to view details")])],-1)])]))])):D("",!0),x.value==="table"?(a(),u("div",Ri,[J(Vs,{tasks:P.value,"current-task-id":(V=W.value)==null?void 0:V.compositeId,"highlight-id":b.value,"type-filter":i.value,"sort-option":g.value,"show-type-filter":te.value,"show-closed":f.value,"show-mobile-close":!1,"open-menu-id":F.value,"get-vehicle-type":m,"get-vehicle-type-badge-class":v,"get-owner-info":w,"get-stage-badge-class":Be,"view-mode":x.value,onSelect:re,onMenuClick:Ce,onMenuClose:L[2]||(L[2]=h=>F.value=null),onFilterChange:L[3]||(L[3]=h=>i.value=h),onSortChange:$e,onToggleClosed:L[4]||(L[4]=h=>f.value=h),onReassign:Se,onClose:xe,onViewChange:S,class:B(W.value?"hidden lg:flex shrink-0":"flex-1 w-full")},null,8,["tasks","current-task-id","highlight-id","type-filter","sort-option","show-type-filter","show-closed","open-menu-id","view-mode","class"]),W.value?(a(),u("div",Mi,[J(ot,{task:W.value,type:W.value.type,"management-widget":M(be),"store-adapter":M(ue),"add-new-config":M(pe)},{"pinned-extra":X(({task:h})=>[ne.value?(a(),G(it,st(Pe({key:0},ne.value)),null,16)):D("",!0)]),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])])):D("",!0)])):D("",!0),J(Ut,{show:Y.value,onClose:L[5]||(L[5]=h=>Y.value=!1),onConfirm:Q},null,8,["show"])])}}},Xi=Qe(Fi,[["__scopeId","data-v-491d70ab"]]);export{Xi as default};
