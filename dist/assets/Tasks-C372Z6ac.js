import{H as Ce,I as Se,c as T,r as B,J as Oe,d as w,o as v,e as i,p as be,g as q,n as Y,t as R,w as xe,F as ee,i as te,s as V,B as z,T as Te,l as ge,y as S,K as lt,x as se,L as oe,M as $e,C as Be,N as A,S as Ue,k as me,G as ot,u as Re,O as rt,m as it,j as ut,h as ct,P as dt,Q as pt,R as Ae}from"./index-D-GV69Dn.js";import{u as Ve}from"./opportunities-D_EVVSI9.js";import{u as He}from"./users-D9zJDDml.js";import{n as re,z as Me}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-3RNqBGno.js";import{g as ke,f as Le,a as ft,b as gt,C as ze,c as We,d as je,e as mt}from"./OfferCarousel-YtLzEMp2.js";import{g as yt,_ as vt,u as ht,a as Ne,T as Fe,D as bt}from"./useTaskFilters-BT8gwLS4.js";import{y as xt}from"./components-D1kWShum.js";import{u as kt,U as wt,g as Ct}from"./useDataTableData-D7InczSP.js";import{u as St}from"./useTableRowSelection-BPyRhPA4.js";import{_ as $t}from"./ReassignUserModal-B8fbsoa_.js";import"./sparkles-DqOgHrLF.js";import"./vehicles-CLPlMvEC.js";import"./CreateEventModal-DtWwBW-0.js";import"./EditEventModal-Byz2Szq-.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=Ce("CircleIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=Ce("FlameIcon",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=Ce("LayoutGridIcon",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=Ce("TableIcon",[["path",{d:"M12 3v18",key:"108xh3"}],["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}]]),It={class:"absolute top-4 right-4 flex items-center gap-2 z-10"},Dt=["onClick"],Tt={class:"flex flex-col min-w-0 flex-1 pr-4"},At={class:"flex items-center gap-1 mb-0.5"},Mt={key:0,class:"font-bold text-foreground text-base truncate"},Lt={class:"flex items-center gap-2 overflow-hidden"},Nt={class:"text-muted-foreground text-sm truncate"},Ft={class:"mt-2"},qt={__name:"TaskCard",props:{item:{type:Object,required:!0},selected:{type:Boolean,default:!1},selectedClass:{type:[String,Function],default:"bg-white border-2 border-blue-500"},unselectedClass:{type:[String,Function],default:"bg-white border border-gray-200 hover:border-gray-300"},showMenu:{type:Boolean,default:!0},openMenuId:{type:[Number,String],default:null},getName:{type:Function,required:!0},getVehicleInfo:{type:Function,default:null},menuItems:{type:Array,default:null}},emits:["select","menu-click","menu-close"],setup(t,{emit:k}){const n=t,$=T(()=>n.item.compositeId||`${n.item.type||"task"}-${n.item.id}`||n.item.id),l=T(()=>n.selected),d=T(()=>l.value?typeof n.selectedClass=="function"?n.selectedClass(n.item):n.selectedClass:typeof n.unselectedClass=="function"?n.unselectedClass(n.item):n.unselectedClass),y=T(()=>{var u;return l.value?((u=n.item)==null?void 0:u.type)==="opportunity"?"task-card-selected task-card-selected-opportunity":"task-card-selected":""}),p=T(()=>yt(n.item)),g=T(()=>{const u=n.item.nextActionDue||n.item.dueDate;if(!u)return null;const h=ke(u);return{text:Le(u),status:h}}),m=T(()=>{if(n.item.type!=="opportunity"||!n.item.expectedCloseDate)return null;const u=n.item.expectedCloseDate,h=ke(u);return{text:Le(u),status:h}}),c=T(()=>n.item.type==="opportunity"&&m.value?m.value:g.value);T(()=>g.value?g.value.status.textClass.replace("text-","bg-"):""),T(()=>c.value?c.value.status.textClass.replace("text-","bg-"):"");const o=B(null);return(u,h)=>{const C=Oe("click-outside");return v(),w("div",{ref_key:"cardRef",ref:o,class:Y(["task-card bg-white rounded-xl p-4 flex items-center justify-between cursor-pointer relative transition-all border group",[d.value,y.value]]),onClick:h[2]||(h[2]=N=>u.$emit("select",$.value))},[i("div",It,[c.value?(v(),w("span",{key:0,class:Y(["text-xs font-bold uppercase leading-none shrink-0",c.value.status.textClass])},R(c.value.text),3)):q("",!0),t.showMenu?(v(),w("button",{key:1,onClick:h[0]||(h[0]=xe(N=>u.$emit("menu-click",t.item.id),["stop"])),class:"text-gray-300 hover:text-gray-600"},[...h[3]||(h[3]=[i("i",{class:"fa-solid fa-ellipsis-vertical"},null,-1)])])):q("",!0)]),t.openMenuId===t.item.id&&t.showMenu?be((v(),w("div",{key:0,class:"absolute right-4 top-10 z-50 w-40 bg-white border border-black/10 rounded-lg shadow-nsc-card py-1",onClick:h[1]||(h[1]=xe(()=>{},["stop"]))},[(v(!0),w(ee,null,te(t.menuItems,N=>(v(),w("button",{key:N.key,onClick:N.onClick,class:"w-full px-3 py-2 text-left text-xs text-foreground hover:bg-muted flex items-center gap-2"},R(N.label),9,Dt))),128))])),[[C,()=>u.$emit("menu-close")]]):q("",!0),i("div",Tt,[i("div",At,[p.value?(v(),w("h3",Mt,R(p.value),1)):q("",!0)]),i("div",Lt,[i("span",Nt,R(t.getName(t.item)),1)]),i("div",Ft,[V(vt,{task:t.item},null,8,["task"])])])],2)}}},Ot=Se(qt,[["__scopeId","data-v-4c09f0c4"]]),Bt={key:0,class:"flex flex-col gap-2"},Ut={class:"flex items-center gap-1.5 flex-wrap"},Rt={class:"relative",ref:"filterContainer"},Vt={key:0,class:"filter-indicator"},Ht=["onClick"],zt=["onClick"],Wt={key:0,class:"flex items-center gap-1.5 flex-wrap"},jt=["onClick"],Et={key:0,class:"task-filter-badge"},Pt={key:1,class:"relative",ref:"filterContainer"},Qt={key:0,class:"filter-indicator"},Gt=["onClick"],Kt=["onClick"],Yt={key:2,class:"flex items-center gap-1.5 flex-wrap"},Jt=["onClick"],Xt={key:0,class:"task-filter-badge"},qe={__name:"TaskFilters",props:{activeFilters:{type:Array,default:()=>[]},sortOption:{type:String,default:""},showClosed:{type:Boolean,default:!1},buttonOnly:{type:Boolean,default:!1},chipsOnly:{type:Boolean,default:!1}},emits:["filter-change","sort-change","toggle-closed"],setup(t,{emit:k}){const n=t,$=k,l=B(!1),d=()=>{l.value=!l.value},y=()=>{l.value=!1},p=[{key:"lead",label:"Leads",type:"type"},{key:"opportunity",label:"Opportunities",type:"type"},{key:"due-in-24h",label:"Due in 24 hours",type:"date"},{key:"to-be-called",label:"To be called again",type:"status"},{key:"leads-1h",label:"Leads created 1 hour ago",type:"date"},{key:"assigned-to-me",label:"Assigned to me",type:"assignee"}],g=F=>{const x=p.find(j=>j.key===F);return x?x.label:F},m=F=>{l.value=!1;const x=[...n.activeFilters],j=x.indexOf(F);j>-1?x.splice(j,1):x.push(F),$("filter-change",x)},c=F=>{const x=[...n.activeFilters],j=x.indexOf(F);j>-1&&(x.splice(j,1),$("filter-change",x))},o=F=>{l.value=!1,$("sort-change",F)},u=()=>{$("sort-change","")},h=T(()=>{const F=n.activeFilters.includes("lead");return[{key:"recent-first",label:"Most Recent First"},...F?[{key:"urgent-first",label:"Urgent first"}]:[],{key:"assigned-to-me",label:"Assigned to me"},{key:"assigned-to-my-team",label:"Assigned to my team"}]}),C=T(()=>n.sortOption&&n.sortOption!==""&&n.sortOption!=="none"),N=T(()=>{const F=h.value.find(x=>x.key===n.sortOption);return F?F.label:n.sortOption});return(F,x)=>{const j=Oe("click-outside");return!t.buttonOnly&&!t.chipsOnly?(v(),w("div",Bt,[i("div",Ut,[be((v(),w("div",Rt,[i("button",{onClick:d,class:"filter-dropdown-button"},[x[2]||(x[2]=i("i",{class:"fa-solid fa-arrow-down-wide-short text-sm"},null,-1)),t.activeFilters.length>0||t.sortOption?(v(),w("span",Vt)):q("",!0)]),V(Te,{name:"dropdown-fade"},{default:z(()=>[l.value?(v(),w("div",{key:0,class:"absolute left-0 mt-2 z-50 w-56 bg-white border border-black/10 rounded-lg shadow-nsc-card py-1",onClick:x[0]||(x[0]=xe(()=>{},["stop"]))},[(v(),w(ee,null,te(p,I=>i("button",{key:I.key,onClick:J=>m(I.key),class:Y(["w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted flex items-center gap-2 relative",{"bg-muted filter-item-selected":t.activeFilters.includes(I.key)}])},[i("span",null,R(I.label),1)],10,Ht)),64)),x[3]||(x[3]=i("div",{class:"border-t border-black/10 my-1"},null,-1)),(v(!0),w(ee,null,te(h.value,I=>(v(),w("button",{key:I.key,onClick:J=>o(I.key),class:Y(["w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted flex items-center gap-2 relative",{"bg-muted sort-item-selected":I.key===t.sortOption}])},[i("span",null,R(I.label),1)],10,zt))),128))])):q("",!0)]),_:1})])),[[j,y]]),t.activeFilters.length>0||C.value?(v(),w("div",Wt,[(v(!0),w(ee,null,te(t.activeFilters,I=>(v(),w("div",{key:I,class:"task-filter-badge"},[i("span",null,R(g(I)),1),i("button",{onClick:J=>c(I),class:"task-filter-badge-remove","aria-label":"Remove filter"},[...x[4]||(x[4]=[i("i",{class:"fa-solid fa-xmark"},null,-1)])],8,jt)]))),128)),C.value?(v(),w("div",Et,[i("span",null,R(N.value),1),i("button",{onClick:u,class:"task-filter-badge-remove","aria-label":"Remove sort"},[...x[5]||(x[5]=[i("i",{class:"fa-solid fa-xmark"},null,-1)])])])):q("",!0)])):q("",!0)])])):t.buttonOnly?be((v(),w("div",Pt,[i("button",{onClick:d,class:"filter-dropdown-button"},[x[6]||(x[6]=i("i",{class:"fa-solid fa-arrow-down-wide-short text-sm"},null,-1)),t.activeFilters.length>0||t.sortOption?(v(),w("span",Qt)):q("",!0)]),V(Te,{name:"dropdown-fade"},{default:z(()=>[l.value?(v(),w("div",{key:0,class:"absolute right-0 mt-2 z-50 w-56 bg-white border border-black/10 rounded-lg shadow-nsc-card py-1",onClick:x[1]||(x[1]=xe(()=>{},["stop"]))},[(v(),w(ee,null,te(p,I=>i("button",{key:I.key,onClick:J=>m(I.key),class:Y(["w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted flex items-center gap-2 relative",{"bg-muted filter-item-selected":t.activeFilters.includes(I.key)}])},[i("span",null,R(I.label),1)],10,Gt)),64)),x[7]||(x[7]=i("div",{class:"border-t border-black/10 my-1"},null,-1)),(v(!0),w(ee,null,te(h.value,I=>(v(),w("button",{key:I.key,onClick:J=>o(I.key),class:Y(["w-full px-4 py-2 text-left text-sm text-foreground hover:bg-muted flex items-center gap-2 relative",{"bg-muted sort-item-selected":I.key===t.sortOption}])},[i("span",null,R(I.label),1)],10,Kt))),128))])):q("",!0)]),_:1})])),[[j,y]]):t.chipsOnly&&(t.activeFilters.length>0||C.value)?(v(),w("div",Yt,[(v(!0),w(ee,null,te(t.activeFilters,I=>(v(),w("div",{key:I,class:"task-filter-badge"},[i("span",null,R(g(I)),1),i("button",{onClick:J=>c(I),class:"task-filter-badge-remove","aria-label":"Remove filter"},[...x[8]||(x[8]=[i("i",{class:"fa-solid fa-xmark"},null,-1)])],8,Jt)]))),128)),C.value?(v(),w("div",Xt,[i("span",null,R(N.value),1),i("button",{onClick:u,class:"task-filter-badge-remove","aria-label":"Remove sort"},[...x[9]||(x[9]=[i("i",{class:"fa-solid fa-xmark"},null,-1)])])])):q("",!0)])):q("",!0)}}},Zt={class:"tasks-list-container border-r border-border flex flex-col shrink-0 w-full lg:w-80 h-full"},_t={class:"page-header shrink-0"},es={class:"page-header-main"},ts={class:"page-header-content"},ss={class:"page-header-title-container"},ns={class:"page-header-title"},as={class:"page-header-actions"},ls={class:"bg-white border border-border p-0.5 rounded-btn inline-flex gap-0.5"},os={class:"px-5 py-3"},rs={class:"flex items-center gap-2"},is={class:"relative flex-1"},us=["placeholder"],cs={key:0,class:"mt-2"},ds={__name:"TasksList",props:{title:{type:String,default:"Tasks"},items:{type:Array,default:()=>[]},selectedId:{type:[String,Number],default:null},activeFilters:{type:Array,default:()=>[]},initialSearchQuery:{type:String,default:""},selectedClass:{type:[String,Function],default:""},unselectedClass:{type:[String,Function],default:""},openMenuId:{type:[String,Number],default:null},getName:{type:Function,default:t=>t.name||"Unknown"},getVehicleInfo:{type:Function,default:()=>"No vehicle specified"},getMenuItems:{type:Function,default:null},showMenu:{type:Boolean,default:!0},searchPlaceholder:{type:String,default:"Search tasks..."},viewMode:{type:String,default:"card"}},emits:["select","menu-click","menu-close","filter-change","sort-change","close","view-change"],setup(t,{emit:k}){const n=t,$=k,l=B(n.initialSearchQuery),d=B(null),y=B(""),p=T(()=>typeof n.title=="string"?n.title:typeof n.title=="function"?(console.warn("TasksList: title prop received a function instead of a string. Using default title."),"Tasks"):n.title||"Tasks");ge(()=>n.initialSearchQuery,o=>{l.value=o});const g=T(()=>{let o=n.items;const u=n.activeFilters.filter(C=>C==="lead"||C==="opportunity");if(u.length>0&&(o=o.filter(C=>!!(C.type&&u.includes(C.type)))),!l.value.trim())return o;const h=l.value.toLowerCase().trim();return o.filter(C=>{const N=n.getName(C).toLowerCase(),F=n.getVehicleInfo(C).toLowerCase();return N.includes(h)||F.includes(h)})}),m=o=>{if(!n.selectedId)return!1;const u=o.compositeId||`${o.type||"task"}-${o.id}`;return String(u)===String(n.selectedId)},c=o=>{y.value=o,$("sort-change",o)};return(o,u)=>(v(),w("div",Zt,[i("header",_t,[i("div",es,[i("div",ts,[i("div",ss,[i("h1",ns,R(p.value),1)]),i("div",as,[i("div",ls,[V(S(re),{variant:"secondary",size:"icon",onClick:u[0]||(u[0]=h=>o.$emit("view-change","card")),class:Y(["h-7 w-7",t.viewMode==="card"?"bg-brand-gray text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"]),title:"Card View","aria-pressed":t.viewMode==="card"},{default:z(()=>[V(S(Pe),{size:14})]),_:1},8,["class","aria-pressed"]),V(S(re),{variant:"secondary",size:"icon",onClick:u[1]||(u[1]=h=>o.$emit("view-change","table")),class:Y(["h-7 w-7",t.viewMode==="table"?"bg-brand-gray text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"]),title:"Table View","aria-pressed":t.viewMode==="table"},{default:z(()=>[V(S(Qe),{size:14})]),_:1},8,["class","aria-pressed"])])])])])]),i("div",os,[i("div",rs,[i("div",is,[u[8]||(u[8]=i("i",{class:"fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-muted-foreground text-sm"},null,-1)),be(i("input",{"onUpdate:modelValue":u[2]||(u[2]=h=>l.value=h),type:"text",placeholder:t.searchPlaceholder,class:"w-full bg-white border border-border rounded-btn pl-9 pr-3 py-2 text-sm"},null,8,us),[[lt,l.value]])]),V(qe,{"active-filters":t.activeFilters,"sort-option":y.value,"button-only":!0,onFilterChange:u[3]||(u[3]=h=>o.$emit("filter-change",h)),onSortChange:c},null,8,["active-filters","sort-option"])]),t.activeFilters.length>0?(v(),w("div",cs,[V(qe,{"active-filters":t.activeFilters,"sort-option":y.value,"chips-only":!0,onFilterChange:u[4]||(u[4]=h=>o.$emit("filter-change",h)),onSortChange:c},null,8,["active-filters","sort-option"])])):q("",!0)]),i("div",{ref_key:"scrollContainer",ref:d,class:"task-list-cards flex-1 overflow-y-auto px-5 space-y-3 pt-4 pb-6 scrollbar-hide"},[(v(!0),w(ee,null,te(g.value,h=>(v(),se(Ot,{key:h.compositeId||`${h.type||"task"}-${h.id}`,item:h,selected:m(h),"selected-class":t.selectedClass,"unselected-class":t.unselectedClass,"show-menu":t.showMenu,"open-menu-id":t.openMenuId,getName:t.getName,getVehicleInfo:t.getVehicleInfo,"menu-items":t.getMenuItems?t.getMenuItems(h):null,onSelect:u[5]||(u[5]=C=>o.$emit("select",C)),onMenuClick:u[6]||(u[6]=C=>o.$emit("menu-click",C)),onMenuClose:u[7]||(u[7]=C=>o.$emit("menu-close"))},{location:z(({item:C})=>[oe(o.$slots,"location",{item:C},void 0,!0)]),source:z(({item:C})=>[oe(o.$slots,"source",{item:C},void 0,!0)]),owner:z(({item:C})=>[oe(o.$slots,"owner",{item:C},void 0,!0)]),dates:z(({item:C})=>[oe(o.$slots,"dates",{item:C},void 0,!0)]),_:2},1032,["item","selected","selected-class","unselected-class","show-menu","open-menu-id","getName","getVehicleInfo","menu-items"]))),128))],512)]))}},ps=Se(ds,[["__scopeId","data-v-d0497207"]]);function Ge(t,k=[],n,$){const l=$e(),d=l.getSetting("urgencyWeights")||{intent:40,behavioral:35,temporal:25},y=l.getSetting("urgencyThresholds")||{hot:80,warm:50,standard:20},p=fs(t,k),g=gs(t,k),m=ms(t),c=ys(t),o=d.intent+d.behavioral+d.temporal,u={intent:d.intent/o*100,behavioral:d.behavioral/o*100,temporal:d.temporal/o*100},h=p/40*u.intent,C=g/35*u.behavioral,N=m/25*u.temporal,F=Math.min(100,Math.max(0,h+C+N+c));let x="COLD";return F>=y.hot?x="HOT":F>=y.warm?x="WARM":F>=y.standard&&(x="STANDARD"),{score:Math.round(F*10)/10,level:x,breakdown:{intent:Math.round(p*10)/10,behavioral:Math.round(g*10)/10,temporal:Math.round(m*10)/10,quality:Math.round(c*10)/10,total:Math.round(F*10)/10}}}function fs(t,k){var $;let n=0;return(t.requestType==="Test Drive"||(($=t.scheduledAppointment)==null?void 0:$.type)==="test-drive"||k.some(l=>l.type==="test-drive"||l.type==="appointment"))&&(n=Math.max(n,40)),k.some(l=>l.type==="financing")&&(n=Math.max(n,35)),k.some(l=>l.type==="tradein")&&(n=Math.max(n,30)),(t.source==="Walk-in"||k.some(l=>{var d,y,p;return((d=l.content)==null?void 0:d.toLowerCase().includes("location"))||((y=l.content)==null?void 0:y.toLowerCase().includes("dealership"))||((p=l.content)==null?void 0:p.toLowerCase().includes("visit"))}))&&(n=Math.max(n,25)),t.requestedCar&&(t.requestedCar.requestMessage||k.some(l=>{var d,y;return((d=l.content)==null?void 0:d.toLowerCase().includes("configur"))||l.type==="attachment"&&((y=l.fileName)==null?void 0:y.toLowerCase().includes("config"))}))&&(n=Math.max(n,20)),k.some(l=>{var y;const d=((y=l.content)==null?void 0:y.toLowerCase())||"";return d.includes("compare")||d.includes("versus")||d.includes("vs")||d.includes("alternative")})&&(n=Math.max(n,15)),Math.min(n,40)}function gs(t,k){let n=0;const $=new Set(k.map(p=>{if(!p.timestamp)return null;const g=new Date(p.timestamp);return`${g.getFullYear()}-${g.getMonth()}-${g.getDate()}`}).filter(Boolean)),l=Math.min($.size*10,35);n+=l,t.contactAttempts&&t.contactAttempts.length>1&&(n+=20);const d=k.reduce((p,g)=>{var m;return p+(((m=g.content)==null?void 0:m.length)||0)},0),y=Math.min(Math.floor(d/50),25);return n+=y,k.some(p=>{var g,m,c;return p.type==="attachment"&&(((g=p.fileName)==null?void 0:g.toLowerCase().includes("brochure"))||((m=p.fileName)==null?void 0:m.toLowerCase().includes("spec"))||((c=p.fileName)==null?void 0:c.toLowerCase().includes("pdf")))})&&(n+=15),Math.min(n,35)}function ms(t){let k=0;if(!t.createdAt)return 0;const n=new Date,$=new Date(t.createdAt),l=(n.getTime()-$.getTime())/(1e3*60*60);l<2?k+=25:l<24?k+=15:l<48?k+=5:k-=10;const d=$.getDay(),y=$.getHours();if((d===0||d===6||y<9||y>17)&&(k+=10),t.contactAttempts&&t.contactAttempts.length===3&&(k+=50),t.lastActivity){const p=new Date(t.lastActivity);(n.getTime()-p.getTime())/(1e3*60*60*24)>3&&(k+=20)}return Math.min(Math.max(k,0),25)}function ys(t){var n,$,l,d,y,p,g;let k=0;return(n=t.customer)!=null&&n.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.customer.email)&&(k+=10),($=t.customer)!=null&&$.phone&&/^\+?[\d\s\-()]+$/.test(t.customer.phone)&&t.customer.phone.length>=10&&(k+=10),(l=t.customer)!=null&&l.name&&((d=t.customer)!=null&&d.email)&&((y=t.customer)!=null&&y.phone)&&((p=t.customer)!=null&&p.address)&&(k+=5),(t.isDuplicate||t.isDisqualified||!((g=t.customer)!=null&&g.name))&&(k-=20),k}const vs={HOT:"Flame",WARM:"Sun",STANDARD:"CheckCircle",COLD:"Circle"};function Ke(t){return vs[t]??"Circle"}function Ye(t){switch(t){case"HOT":return"bg-red-50 text-red-700 border-red-200";case"WARM":return"bg-orange-50 text-orange-700 border-orange-200";case"STANDARD":return"bg-green-50 text-green-700 border-green-200";case"COLD":return"bg-gray-50 text-gray-700 border-gray-200";default:return"bg-gray-50 text-gray-700 border-gray-200"}}function hs({typeFilter:t,showTypeFilter:k,tasks:n}){return{filterDefinitions:T(()=>{const l=[];k.value&&l.push({key:"type",label:"Type",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"lead",label:"Lead"},{value:"opportunity",label:"Opportunity"}],aiHint:"Lead or Opportunity type",pinned:!0}),l.push({key:"status",label:"Status",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:[{value:"Valid",label:"Valid"},{value:"Not valid",label:"Not valid"},{value:"Qualified",label:"Qualified"},{value:"In Negotiation",label:"In Negotiation"},{value:"Won",label:"Won"},{value:"Lost",label:"Lost"},{value:"Not interested",label:"Not interested"},{value:"Open",label:"Open"}],aiHint:"Lead status or opportunity stage",pinned:!0}),l.push({key:"priority",label:"Priority",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"Hot",label:"High"},{value:"Normal",label:"Normal"}],aiHint:"Task priority level"}),t.value==="lead"&&l.push({key:"urgencyLevel",label:"Urgency",type:"select",operators:[{value:"eq",label:"is"}],options:[{value:"HOT",label:"ðŸ”¥ Hot"},{value:"WARM",label:"ðŸŸ¡ Warm"},{value:"STANDARD",label:"ðŸŸ¢ Standard"},{value:"COLD",label:"âšª Cold"}],aiHint:"Lead urgency level based on scoring",pinned:!0}),l.push({key:"source",label:"Source",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:[{value:"Marketing",label:"Marketing"},{value:"Website",label:"Website"},{value:"Referral",label:"Referral"},{value:"Walk-in",label:"Walk-in"}],aiHint:"Lead or opportunity source",pinned:!0});const d=[...new Set(n.value.map(p=>p.assignee).filter(Boolean))];d.length>0&&l.push({key:"assignee",label:"Assignee",type:"select",operators:[{value:"eq",label:"is"}],options:d.map(p=>({value:p,label:p})),aiHint:"Person assigned to the task",pinned:!0});const y=[...new Set(n.value.map(p=>{const g=p.type==="lead"?p.requestedCar:p.vehicle;return g==null?void 0:g.brand}).filter(Boolean))];return y.length>0&&l.push({key:"requestedCarBrand",label:"Requested car",type:"multiselect",operators:[{value:"in",label:"is any of"},{value:"notIn",label:"is none of"}],options:y.map(p=>({value:p,label:p})),aiHint:"Car brand requested by customer"}),l.push({key:"createdAt",label:"Creation date",type:"daterange",operators:[{value:"between",label:"is between"},{value:"gte",label:"is after"},{value:"lte",label:"is before"}],aiHint:"Date when the task was created"}),l})}}const bs={class:"page-container flex-1 flex flex-col overflow-hidden min-w-0"},xs={class:"page-header shrink-0"},ks={class:"page-header-main"},ws={class:"page-header-content"},Cs={class:"page-header-actions"},Ss={class:"bg-white border border-border p-0.5 rounded-btn inline-flex gap-0.5"},$s={class:"shrink-0 px-4 md:px-8 pt-4 pb-2 bg-white"},Is={class:"flex-1 overflow-y-auto px-4 md:px-8 pb-4 md:pb-8 bg-white min-h-0 data-table-inner table-search-wrapper"},Ds={key:0,class:"flex items-center gap-2"},Ts={class:"flex items-center gap-2 mr-1"},As={class:"flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full bg-blue-600 text-white text-xs font-medium"},Ms={__name:"TasksTableView",props:{tasks:{type:Array,required:!0},currentTaskId:{type:String,default:null},highlightId:{type:String,default:null},showClosed:{type:Boolean,default:!1},showMobileClose:{type:Boolean,default:!1},openMenuId:{type:[Number,String],default:null},searchPlaceholder:{type:String,default:"Search tasks..."},viewMode:{type:String,default:"table"},getVehicleType:{type:Function,required:!0},getVehicleTypeBadgeClass:{type:Function,required:!0},getOwnerInfo:{type:Function,required:!0},getStageBadgeClass:{type:Function,required:!0}},emits:["select","menu-click","menu-close","toggle-closed","reassign","close","view-change"],setup(t,{emit:k}){const n=t,$=k,l=$e(),d=Be(),y=Ve();B("");const{rowSelection:p,selectedCount:g,hasSelection:m,getSelectedRows:c,clearSelection:o}=St(s=>s.compositeId),u=B({pageIndex:0,pageSize:10}),h=B(""),C=B([]),N=B([]),F=B({}),{filterDefinitions:x}=hs({typeFilter:T(()=>"all"),showTypeFilter:T(()=>!0),tasks:T(()=>n.tasks)}),j=T(()=>[...new Set(n.tasks.map(e=>e.assignee).filter(Boolean))].map(e=>({value:e,label:e}))),I=[{value:"Test Drive",label:"Test Drive"},{value:"Quotation",label:"Quotation"},{value:"Generic sales",label:"Generic sales"}],J=T(()=>{var e,r;const s=(e=x.value)==null?void 0:e.find(M=>M.key==="status");return((r=s==null?void 0:s.options)==null?void 0:r.map(M=>({value:M.value,label:M.label})))??[]}),ie=T(()=>{var e,r;const s=(e=x.value)==null?void 0:e.find(M=>M.key==="source");return((r=s==null?void 0:s.options)==null?void 0:r.map(M=>({value:M.value,label:M.label})))??[]}),Q=s=>s.compositeId===n.currentTaskId||s.compositeId===n.highlightId,ne=s=>{if(s.type==="lead")return s.requestedCar?`${s.requestedCar.brand} ${s.requestedCar.model}`:"No vehicle specified";const e=s.vehicle||s.requestedCar;return e?`${e.brand} ${e.model}`:"No vehicle specified"},ae=s=>{if(!s)return"Not set";const e=new Date,r=new Date(s),M=new Date(e.getFullYear(),e.getMonth(),e.getDate()),P=new Date(r.getFullYear(),r.getMonth(),r.getDate())-M,W=Math.ceil(P/(1e3*60*60*24));return W===0?"Today":W===1?"Tomorrow":W===-1?"Yesterday":W>1&&W<=7?`In ${W} days`:W<-1&&W>=-7?`${Math.abs(W)} days ago`:We(s)},le=s=>{const e=s.type==="lead"?s.requestedCar:s.vehicle;if(!e)return{status:"N/A",class:"bg-muted text-muted-foreground"};const r=e.stockDays!==void 0&&e.stockDays!==null;return{status:r?"In Stock":"Out of Stock",class:r?"bg-green-100 text-green-700":"bg-muted text-muted-foreground"}},E=s=>{var e;return s.type==="lead"?((e=s.requestedCar)==null?void 0:e.requestType)||s.requestType||"N/A":s.requestType||"Opportunity"},G=s=>{const e=s.type==="lead"?s.requestedCar:s.vehicle||s.requestedCar;return e==null?void 0:e.price},ye=T(()=>[{id:"type",accessorKey:"type",header:"Task type",meta:{title:"Task type",onOpen:s=>ce(s.original)},cell:({row:s})=>{const e=s.original,r=e.type==="lead"?"bg-blue-50 text-blue-700":"bg-purple-50 text-purple-700";return A("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${r}`},e.type==="lead"?"Lead":"Opportunity")}},{id:"customer",accessorKey:"customer",header:"Customer",meta:{title:"Customer"},cell:({row:s})=>{const e=s.original;return A("div",{class:"flex items-center gap-2 md:gap-3"},[A("div",{class:`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold shrink-0 ${e.type==="lead"?"bg-orange-100 text-orange-600":"bg-purple-100 text-purple-600"}`},e.customer.initials),A("div",{class:"min-w-0"},[A("div",{class:"text-content font-semibold text-foreground truncate max-w-32 md:max-w-none"},e.customer.name),A("div",{class:"text-meta truncate hidden sm:block"},e.customer.phone||"N/A")])])}},{id:"carInfo",accessorKey:"carInfo",header:"Car Info",meta:{title:"Car Info"},cell:({row:s})=>{const e=s.original,r=ne(e),M=le(e),X=E(e),P=e.type==="lead"?e.requestedCar:e.vehicle||e.requestedCar;if(r==="No vehicle specified")return A("span",{class:"text-meta"},"N/A");const W=P!=null&&P.condition?P.condition.charAt(0).toUpperCase()+P.condition.slice(1).toLowerCase():null,Z=P!=null&&P.kilometers?`${P.kilometers.toLocaleString()} km`:null,de=e.quotationNumber||e.quotation||null,pe=X&&X!=="N/A"&&(X!=="Quotation"||de);return A("div",{class:"flex flex-col gap-1"},[A("div",{class:"flex items-center gap-2"},[A("i",{class:"fa-brands fa-volkswagen text-muted-foreground text-sm"}),A("span",{class:"text-content font-medium text-foreground truncate max-w-32"},r)]),A("div",{class:"flex items-center gap-2 flex-wrap"},[A("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${M.class}`},M.status),W&&A("span",{class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-50 text-blue-700"},W),Z&&A("span",{class:"text-meta text-xs"},Z),pe&&A("span",{class:"text-meta text-xs"},X)])])}},{id:"dueDate",accessorKey:"nextActionDue",header:"Due Date",meta:{title:"Due Date"},cell:({row:s})=>{const r=s.original.nextActionDue;if(!r)return A("span",{class:"text-meta"},"Not set");const M=ke(r);return A("span",{class:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border ${M.bgClass} ${M.textClass} ${M.borderClass}`},ae(r))}},{id:"price",accessorKey:"price",accessorFn:s=>G(s)??0,header:"Price",meta:{title:"Price"},cell:({row:s})=>{const e=s.original,r=G(e);return r==null||r===""?A("span",{class:"text-meta"},"â€”"):A("span",{class:"text-content font-medium text-foreground"},`â‚¬ ${ft(r)}`)}},{id:"source",accessorKey:"source",header:"Lead Source",meta:{title:"Lead Source"},cell:({row:s})=>{const e=s.original;return A("span",{class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-muted text-muted-foreground"},e.source||"N/A")}},{id:"contactAttempts",accessorKey:"contactAttempts",header:"Contact Attempts",meta:{title:"Contact Attempts"},cell:({row:s})=>{var M;const r=((M=s.original.contactAttempts)==null?void 0:M.length)||0;return A("span",{class:"text-content font-medium text-foreground"},r)}},{id:"assignee",accessorKey:"assignee",header:"Assignee",meta:{title:"Assignee"},cell:({row:s})=>{const e=s.original,r=n.getOwnerInfo(e);return A("div",{class:"flex items-center gap-2"},[A("div",{class:"w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-bold text-muted-foreground shrink-0"},r.initials),A("span",{class:"text-meta truncate max-w-20"},r.name)])}},{id:"createdAt",accessorKey:"createdAt",header:"Creation Date",meta:{title:"Creation Date"},cell:({row:s})=>{const e=s.original;return e.createdAt?A("span",{class:"text-meta"},gt(e.createdAt)):A("span",{class:"text-meta"},"N/A")}},{id:"status",accessorKey:"status",header:"Status",meta:{title:"Status"},cell:({row:s})=>{const e=s.original,r=e.type==="lead"?e.status:e.displayStage||e.stage,M=n.getStageBadgeClass(r);return A("span",{class:`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${M}`},r)}},...l.getSetting("urgencyEnabled")!==!1?[{id:"urgencyLevel",accessorKey:"urgencyLevel",header:"Urgency",meta:{title:"Urgency"},cell:({row:s})=>{const e=s.original;if(e.type!=="lead")return A("span",{class:"text-meta"},"â€”");let r=e.urgencyLevel;r||(r=Ge(e).level);const M=Ye(r),X=Ke(r),W={Flame:Ee,Sun:Ue,CheckCircle:ze,Circle:we}[X]||we;return A("span",{class:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border ${M}`},[A(W,{class:"size-3 shrink-0"}),A("span",{},r)])}}]:[]]),Ie=(s,e)=>{if(e==="requestedCarBrand"){const r=s.type==="lead"?s.requestedCar:s.vehicle;return r==null?void 0:r.brand}return e==="status"?s.type==="lead"?s.status:s.displayStage??s.stage:Ct(s,e)},{paginatedData:K,sortedData:H,totalFilteredCount:ue}=kt({rawData:T(()=>n.tasks),columns:ye,globalFilter:h,columnFilters:N,sorting:C,pagination:u,filterDefs:x,searchableFields:s=>{var e,r,M;return[(e=s.customer)==null?void 0:e.name,(r=s.customer)==null?void 0:r.email,(M=s.customer)==null?void 0:M.phone,s.type==="lead"?s.status:s.displayStage??s.stage,s.type,s.source,s.assignee,s.compositeId,s.id]},getFilterValue:Ie}),ce=s=>{h.value=String(s.id),$("select",s.compositeId)},ve=()=>{const s=c(H.value);s.length!==0&&confirm(`Are you sure you want to delete ${s.length} ${s.length===1?"task":"tasks"}?`)&&(s.forEach(e=>{e.type==="lead"?d.deleteLead(e.id):y.deleteOpportunity(e.id)}),o())},he=T(()=>({class:{tr:s=>{const e="cursor-pointer hover:bg-muted transition-colors",r=s.original;return Q(r)?`${e} bg-blue-50 border-l-4 border-l-blue-500`:e}}}));return(s,e)=>(v(),w("div",bs,[i("header",xs,[i("div",ks,[i("div",ws,[e[13]||(e[13]=i("div",{class:"page-header-title-container"},[i("h1",{class:"page-header-title"},"Tasks")],-1)),i("div",Cs,[i("div",Ss,[V(S(re),{variant:"secondary",size:"icon",onClick:e[0]||(e[0]=r=>s.$emit("view-change","card")),class:Y(["h-7 w-7",t.viewMode==="card"?"bg-brand-gray text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"]),title:"Card View","aria-pressed":t.viewMode==="card"},{default:z(()=>[V(S(Pe),{size:14})]),_:1},8,["class","aria-pressed"]),V(S(re),{variant:"secondary",size:"icon",onClick:e[1]||(e[1]=r=>s.$emit("view-change","table")),class:Y(["h-7 w-7",t.viewMode==="table"?"bg-brand-gray text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"]),title:"Table View","aria-pressed":t.viewMode==="table"},{default:z(()=>[V(S(Qe),{size:14})]),_:1},8,["class","aria-pressed"])]),i("button",{onClick:e[2]||(e[2]=r=>s.$emit("toggle-closed",!t.showClosed)),class:"group flex items-center gap-2 rounded-xl border border-border px-3 py-1.5 bg-surface text-sm font-medium text-muted-foreground hover:border-red-100 hover:bg-red-50 hover:text-brand-red transition-all"},[...e[12]||(e[12]=[i("i",{class:"fa-solid fa-eye-slash text-muted-foreground group-hover:text-brand-red"},null,-1),i("span",{class:"hidden sm:inline"},"Show Closed",-1)])])])])])]),i("div",$s,[V(wt,{"active-tab":"opportunities",placeholder:"Search tasks...",pagination:u.value,"assignee-options":j.value,"request-type-options":I,"status-options":J.value,"source-options":ie.value,"onUpdate:globalFilter":e[3]||(e[3]=r=>h.value=r),"onUpdate:columnFilters":e[4]||(e[4]=r=>N.value=r),"onUpdate:pagination":e[5]||(e[5]=r=>u.value=r)},null,8,["pagination","assignee-options","status-options","source-options"])]),i("div",Is,[V(S(xt),{data:S(K),columns:ye.value,meta:he.value,onRowClick:ce,columnFiltersOptions:{filterDefs:S(x)},pagination:u.value,"onUpdate:pagination":e[6]||(e[6]=r=>u.value=r),globalFilter:h.value,"onUpdate:globalFilter":e[7]||(e[7]=r=>h.value=r),sorting:C.value,"onUpdate:sorting":e[8]||(e[8]=r=>C.value=r),columnFilters:N.value,"onUpdate:columnFilters":e[9]||(e[9]=r=>N.value=r),columnVisibility:F.value,"onUpdate:columnVisibility":e[10]||(e[10]=r=>F.value=r),rowSelection:S(p),"onUpdate:rowSelection":e[11]||(e[11]=r=>ot(p)?p.value=r:null),paginationOptions:{rowCount:S(ue)},globalFilterOptions:{debounce:300,placeholder:"Q Search or ask a question",show:!0},class:"h-full"},{"empty-state":z(()=>[...e[14]||(e[14]=[i("div",{class:"empty-state"},[i("i",{class:"fa-solid fa-tasks empty-state-icon"}),i("p",{class:"empty-state-text"},"No tasks found")],-1)])]),"batch-action-bar":z(()=>[S(m)?(v(),w("div",Ds,[i("div",Ts,[i("div",As,R(S(g)),1),e[15]||(e[15]=i("span",{class:"text-white text-fluid-sm font-medium whitespace-nowrap"},"Items selected",-1))]),e[18]||(e[18]=i("div",{class:"h-4 w-px bg-greys-700"},null,-1)),V(S(re),{variant:"ghost",size:"sm",onClick:ve},{default:z(()=>[...e[16]||(e[16]=[i("i",{class:"fa-solid fa-trash mr-2"},null,-1),me(" Delete ",-1)])]),_:1}),V(S(re),{variant:"ghost",size:"sm",onClick:S(o)},{default:z(()=>[...e[17]||(e[17]=[i("i",{class:"fa-solid fa-x mr-2"},null,-1),me(" Close ",-1)])]),_:1},8,["onClick"])])):q("",!0)]),_:1},8,["data","columns","meta","columnFiltersOptions","pagination","globalFilter","sorting","columnFilters","columnVisibility","rowSelection","paginationOptions"])])]))}},Ls=Se(Ms,[["__scopeId","data-v-68930d31"]]),Ns={key:0,class:"lg:hidden border-b border shrink-0 bg-brand-gray"},Fs={class:"px-4 py-3 flex items-center justify-between gap-3"},qs=["aria-label"],Os={key:0,class:"flex-1 flex items-center justify-center"},Bs={key:1,class:"flex items-center gap-2"},Us={__name:"MobileDetailHeader",props:{show:{type:Boolean,required:!0},backLabel:{type:String,default:"Back"}},emits:["back"],setup(t,{emit:k}){const n=k,$=()=>{n("back")};return(l,d)=>t.show?(v(),w("div",Ns,[i("div",Fs,[i("button",{onClick:$,class:"w-11 h-11 flex items-center justify-center text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors shrink-0","aria-label":t.backLabel},[...d[0]||(d[0]=[i("i",{class:"fa-solid fa-arrow-left text-lg"},null,-1)])],8,qs),l.$slots.title?(v(),w("div",Os,[oe(l.$slots,"title")])):q("",!0),l.$slots.actions?(v(),w("div",Bs,[oe(l.$slots,"actions")])):q("",!0)])])):q("",!0)}};function Rs(){const t=c=>{if(!c)return"No deadline";const o=ke(c);return o.type==="overdue"?"OVERDUE":o.type==="today"||o.type==="urgent"?o.relativeTime:We(c)},k=c=>{const o=c.type==="lead"?c.requestedCar:c.vehicle;return!o||!o.type?null:{New:{type:"new",label:"New"},"New 0km":{type:"0km",label:"New 0km"},Used:{type:"used",label:"Used"},Demo:{type:"demo",label:"Demo"}}[o.type]||{type:o.type.toLowerCase(),label:o.type}},n=c=>c?{new:"bg-green-50 text-green-700","0km":"bg-blue-50 text-blue-700",used:"bg-orange-50 text-orange-700",demo:"bg-purple-50 text-purple-700"}[c.type]||"bg-gray-50 text-gray-700":"",$=c=>{if(!c||!c.assignee)return{name:"Unassigned",initials:"?"};const o=c.assigneeInitials||c.assignee.split(" ").map(u=>u[0]).join("");return{name:c.assignee,initials:o}},l=c=>{if(!c||!c.customer||!c.customer.address)return null;const u=c.customer.address.split(",");return u.length>1&&u[u.length-1].trim().replace(/^\d+\s*/,"").trim()||null};return{getDateDisplay:t,getVehicleType:k,getVehicleTypeBadgeClass:n,getOwnerInfo:$,getCustomerCity:l,getLocationDisplay:c=>{const o=l(c),u=c.source||"Unknown";return o?`${o} â€¢ ${u}`:u},getAssigneeInitials:c=>{if(!c)return"?";const o=c.split(" ");return o.length>=2?(o[0][0]+o[o.length-1][0]).toUpperCase():c.substring(0,2).toUpperCase()},getVehicleStatusDisplay:c=>{const o=c.type==="lead"?c.requestedCar:c.vehicle;if(!o)return"No vehicle";const u=k(c),h=u?u.label:o.type||"Unknown";let C="";return o.kilometers!==void 0&&o.kilometers!==null&&(o.kilometers>=1e3?C=`${(o.kilometers/1e3).toFixed(0)}k`:C=`${o.kilometers}`),C?`${h} / ${C}`:h},getTaskStatusDisplay:c=>c.type==="lead"?c.status||"Unknown":c.stage||"Unknown",getStageBadgeClass:je,getUnselectedClass:c=>c.type==="lead"?"bg-white border border-gray-200 hover:border-blue-300":"bg-white border border-gray-200 hover:border-purple-300"}}function Vs(){const t=Re(),k=He(),n=$e();return{sortTasks:(l,d)=>{if(!d||d===""||d==="none")return l;if(d==="recent-first")return[...l].sort((y,p)=>{const g=new Date(y.lastActivity||y.createdAt||0);return new Date(p.lastActivity||p.createdAt||0)-g});if(d==="urgent-first")return n.getSetting("urgencyEnabled")!==!1?[...l.map(g=>{if(g.type==="lead"&&!g.urgencyScore){const m=Ge(g);return{...g,urgencyScore:m.score,urgencyLevel:m.level}}return g})].sort((g,m)=>{if(g.type==="lead"&&m.type==="lead"){const u=g.urgencyScore||0,h=m.urgencyScore||0;if(u!==h)return h-u;const C=new Date(g.createdAt||0);return new Date(m.createdAt||0)-C}if(g.type==="lead"&&m.type==="opportunity")return-1;if(g.type==="opportunity"&&m.type==="lead")return 1;if(g.priority==="Hot"&&m.priority!=="Hot")return-1;if(g.priority!=="Hot"&&m.priority==="Hot")return 1;const c=new Date(g.lastActivity||g.createdAt||0);return new Date(m.lastActivity||m.createdAt||0)-c}):[...l].sort((p,g)=>{if(p.priority==="Hot"&&g.priority!=="Hot")return-1;if(p.priority!=="Hot"&&g.priority==="Hot")return 1;const m=new Date(p.lastActivity||p.createdAt||0);return new Date(g.lastActivity||g.createdAt||0)-m});if(d==="assigned-to-me"){const y=t.currentUser.name;return[...l.filter(g=>g.assignee===y)].sort((g,m)=>{const c=new Date(g.lastActivity||g.createdAt||0);return new Date(m.lastActivity||m.createdAt||0)-c})}if(d==="assigned-to-my-team"){const y=t.currentUser;let p=[];return y.role==="manager"?p=k.users.map(m=>m.name):y.role==="salesman"?p=k.users.filter(m=>m.role==="salesman").map(m=>m.name):y.role==="operator"&&(p=k.users.filter(m=>m.role==="operator").map(m=>m.name)),[...l.filter(m=>p.includes(m.assignee))].sort((m,c)=>{const o=new Date(m.lastActivity||m.createdAt||0);return new Date(c.lastActivity||c.createdAt||0)-o})}return l}}}const Hs={class:"h-full flex flex-col lg:flex-row overflow-hidden bg-surface"},zs={key:0,class:"flex-1 flex flex-col lg:flex-row overflow-hidden min-w-0"},Ws={key:0,class:"flex items-center gap-2"},js={class:"w-3 h-3 rounded-full bg-black text-white font-medium flex items-center justify-center text-xs shrink-0",style:{"font-size":"0.5rem"}},Es={class:"text-gray-600 font-medium"},Ps={key:1},Qs={key:0},Gs={key:1},Ks={key:2},Ys={key:1,class:"hidden lg:flex flex-1 flex-col overflow-hidden lg:border-l border"},Js={key:1,class:"flex-1 flex flex-col overflow-hidden min-w-0 relative"},Xs={__name:"Tasks",setup(t){const k={Flame:Ee,Sun:Ue,CheckCircle:ze,Circle:we};function n(a){return k[Ke(a)]||we}const $=rt(),l=ct(),d=Be(),y=Ve();Re(),He();const p=$e(),{getDateDisplay:g,getVehicleType:m,getVehicleTypeBadgeClass:c,getOwnerInfo:o,getCustomerCity:u,getAssigneeInitials:h,getUnselectedClass:C}=Rs(),N=B(localStorage.getItem("tasksViewMode")||"table"),F=B(""),x=T(()=>$.query.highlight||null);ge(N,a=>{localStorage.setItem("tasksViewMode",a)});const j=(a,b="")=>{N.value;const D=H.value;if(N.value=a,a==="card"&&b&&(F.value=b),a==="table"&&D)F.value="",l.push({path:"/tasks",query:{highlight:D.compositeId}});else if(a==="card"&&x.value){const[U,f]=x.value.split("-");l.push({path:`/tasks/${f}`,query:{type:U}})}else a==="card"&&!x.value&&!H.value&&l.push({path:"/tasks"})},I=B([]),J=B(""),ie=B(!1),Q=B(null);B(!1);const ne=B(!1),ae=B(null),le=B(!1),E=B(null),{allTasks:G,applyFilters:ye}=ht(ie),{sortTasks:Ie}=Vs(),K=T(()=>{let a=ye(G.value,I.value);return a=Ie(a,J.value),a}),H=T(()=>{if(!$.params.id)return null;const a=parseInt($.params.id);if(isNaN(a))return null;const b=$.query.type;if(b){const O=`${b}-${a}`;return G.value.find(fe=>fe.compositeId===O)||null}const D=I.value.filter(O=>O==="lead"||O==="opportunity"),U=D.length>0?G.value.filter(O=>D.includes(O.type)):G.value,f=`lead-${a}`,L=`opportunity-${a}`,_=U.find(O=>O.compositeId===f||O.compositeId===L);return _||G.value.find(O=>O.compositeId===f||O.compositeId===L)||null});T(()=>H.value?H.value.type==="lead"?d.currentLeadActivities:y.currentOpportunityActivities:[]);const ue=Ne(H),ce=ue.managementWidget,ve=ue.storeAdapter,he=ue.addNewConfig,s=T(()=>E.value),e=Ne(s),r=T(()=>e.managementWidget.value),M=T(()=>e.storeAdapter.value),X=T(()=>e.addNewConfig.value),P=C;it(()=>{d.fetchLeads(),y.fetchOpportunities();const a=$.params.id;a&&W(a)}),ge(()=>$.params.id,a=>{a&&W(a)}),ge(H,a=>{a&&(a.type==="lead"?d.fetchLeadById(a.id):y.fetchOpportunityById(a.id))},{immediate:!0}),ge(E,a=>{a&&(a.type==="lead"?d.fetchLeadById(a.id):y.fetchOpportunityById(a.id))},{immediate:!0});const W=a=>{const b=parseInt(a),D=G.value.find(U=>U.id===b);D&&(D.type==="lead"?d.fetchLeadById(b):y.fetchOpportunityById(b))},Z=a=>{const[b,D]=a.split("-");if(N.value==="table"){const U=G.value.find(f=>f.compositeId===a);U&&(E.value=U,le.value=!0,U.type==="lead"?d.fetchLeadById(U.id):y.fetchOpportunityById(U.id));return}N.value="card",l.push({path:`/tasks/${D}`,query:{type:b}})},de=()=>{if(le.value){pe();return}l.push({path:"/tasks"})},pe=()=>{pt(()=>{le.value=!1,E.value=null})},Je=a=>{if(!H.value)return;const b=K.value.findIndex(D=>{const U=H.value.compositeId||`${H.value.type}-${H.value.id}`;return(D.compositeId||`${D.type}-${D.id}`)===U});if(b!==-1){if(a==="previous"&&b>0){const D=K.value[b-1];Z(D.compositeId)}else if(a==="next"&&b<K.value.length-1){const D=K.value[b+1];Z(D.compositeId)}}},Xe=a=>{if(!E.value)return;const b=K.value.findIndex(D=>{const U=E.value.compositeId||`${E.value.type}-${E.value.id}`;return(D.compositeId||`${D.type}-${D.id}`)===U});if(b!==-1){if(a==="previous"&&b>0){const D=K.value[b-1];Z(D.compositeId)}else if(a==="next"&&b<K.value.length-1){const D=K.value[b+1];Z(D.compositeId)}}},De=a=>{Q.value=Q.value===a?null:a},Ze=a=>{ae.value=a,ne.value=!0,Q.value=null},_e=a=>{J.value=a},et=async a=>{if(!ae.value)return;const b=ae.value,D=a.name;b.type==="lead"?await d.updateLead(b.id,{assignee:D,assigneeType:a.type,teamId:a.type==="team"?a.id:null}):b.type==="opportunity"&&await y.updateOpportunity(b.id,{assignee:D,assigneeType:a.type,teamId:a.type==="team"?a.id:null}),ne.value=!1,ae.value=null},tt=async a=>{Q.value=null,a.type==="lead"?await d.updateLead(a.id,{priority:"Hot"}):a.type==="opportunity"&&await y.updateOpportunity(a.id,{priority:"Hot"})},st=async a=>{Q.value=null,a.type==="lead"?await d.updateLead(a.id,{priority:"Normal"}):a.type==="opportunity"&&await y.updateOpportunity(a.id,{priority:"Normal"})},nt=async a=>{if(Q.value=null,a.type==="lead")try{const b=a.displayStage||a.stage||Ae.NEW,D=Ae.NEW,U=mt(b,D);if(U){const{updates:f,activities:L}=U(a);await d.updateLead(a.id,f);for(const _ of L)await d.addActivity(a.id,_)}else await d.updateLead(a.id,{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open",status:"Open",nextActionDue:null,scheduledAppointment:null}),await d.addActivity(a.id,{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"});await d.fetchLeadById(a.id)}catch(b){console.error("Failed to reopen lead:",b)}},at=a=>{const b=[];return a.type==="lead"&&a.isDisqualified===!0&&b.push({key:"reopen",label:"Reopen Lead",onClick:()=>nt(a)}),a.priority!=="Hot"?b.push({key:"mark-hot",label:"Mark as hot",onClick:()=>tt(a)}):b.push({key:"unmark-hot",label:"Unmark as hot",onClick:()=>st(a)}),b};return(a,b)=>{var D,U;return v(),w("div",Hs,[V(Us,{show:!!H.value||N.value==="table"&&!!E.value,"back-label":"Back to task list",onBack:de},null,8,["show"]),N.value==="card"?(v(),w("div",zs,[i("div",{class:Y(["flex flex-col overflow-hidden",H.value?"hidden lg:flex shrink-0":"w-full lg:w-auto lg:shrink-0"])},[V(ps,{title:"Tasks",items:K.value,"selected-id":H.value?String(H.value.compositeId):null,"view-mode":N.value,"initial-search-query":F.value,onViewChange:j,"selected-class":f=>f.type==="lead"?"bg-surface border-2 border-blue-500":"bg-surface border-2 border-purple-500","unselected-class":S(P),"open-menu-id":Q.value,getName:f=>{const L=f.customer;return L&&L.name?L.name:L&&!L.name&&L.email&&L.email.split("@")[0]||"Unknown"},getInitials:f=>{const L=f.customer;return L&&L.initials?L.initials:L&&L.name&&L.name.split(" ").map(O=>O[0]).filter(Boolean).join("").toUpperCase().slice(0,2)||"?"},getVehicleInfo:f=>{if(f.type==="lead"){if(!f.requestedCar)return"No vehicle specified";const O=f.requestedCar,fe=[`${O.brand} ${O.model}`];return O.kilometers!==void 0&&O.kilometers!==null&&fe.push(`${O.kilometers} km`),O.status&&fe.push(O.status),fe.join(" â€¢ ")}const L=f.vehicle||f.requestedCar;if(!L)return"No vehicle specified";const _=[`${L.brand} ${L.model}`];return L.kilometers!==void 0&&L.kilometers!==null&&_.push(`${L.kilometers} km`),L.status&&_.push(L.status),_.join(" â€¢ ")},avatarClass:f=>f.type==="lead"?"bg-orange-100 text-orange-600":"bg-purple-100 text-purple-600","get-menu-items":at,"show-mobile-close":!1,onSelect:Z,onMenuClick:De,onMenuClose:b[0]||(b[0]=f=>Q.value=null),onClose:de,"active-filters":I.value,onFilterChange:b[1]||(b[1]=f=>I.value=f),onSortChange:_e},{badges:z(({item:f})=>[f&&f.type?(v(),se(S(Me),{key:0,text:f.type==="lead"?"Lead":"Opportunity",size:"small",theme:f.type==="lead"?"blue":"gray"},null,8,["text","theme"])):q("",!0),f&&f.type==="lead"&&S(p).getSetting("urgencyEnabled")!==!1&&f.urgencyLevel?(v(),w("span",{key:1,class:Y(["inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border",S(Ye)(f.urgencyLevel)])},[(v(),se(dt(n(f.urgencyLevel)),{class:"size-3 shrink-0"})),me(" "+R(f.urgencyLevel),1)],2)):q("",!0),f&&f.priority==="Hot"&&(S(p).getSetting("urgencyEnabled")===!1||f.type!=="lead")?(v(),se(S(Me),{key:2,text:"HOT",size:"small",theme:"red"})):q("",!0)]),location:z(({item:f})=>[me(R(S(u)(f)||"Unknown"),1)]),source:z(({item:f})=>{var L;return[me(R(f.source||((L=f.customer)==null?void 0:L.source)||"Unknown"),1)]}),owner:z(({item:f})=>[f.assignee?(v(),w("div",Ws,[i("div",js,R(S(h)(f.assignee)),1),i("span",Es,R(f.assignee),1)])):(v(),w("span",Ps,"Unassigned"))]),dates:z(({item:f})=>[f.type==="lead"&&f.nextActionDue?(v(),w("span",Qs,"Due: "+R(S(g)(f.nextActionDue)),1)):f.type==="opportunity"&&f.nextActionDue?(v(),w("span",Gs,"Due: "+R(S(g)(f.nextActionDue)),1)):(v(),w("span",Ks,"Due: No deadline"))]),_:1},8,["items","selected-id","view-mode","initial-search-query","selected-class","unselected-class","open-menu-id","getName","getInitials","getVehicleInfo","avatarClass","active-filters"])],2),H.value&&S(ce)&&S(ve)&&S(he)?(v(),se(Fe,{key:((D=H.value)==null?void 0:D.compositeId)||"card-empty",task:H.value,"management-widget":S(ce),"store-adapter":S(ve),"add-new-config":S(he),"filtered-tasks":K.value,onTaskNavigate:Je},null,8,["task","management-widget","store-adapter","add-new-config","filtered-tasks"])):q("",!0),H.value?q("",!0):(v(),w("div",Ys,[...b[5]||(b[5]=[ut('<div class="flex-1 flex items-center justify-center p-8" data-v-ef109631><div class="text-center max-w-sm" data-v-ef109631><div class="w-16 h-16 mx-auto mb-4 rounded-lg bg-muted flex items-center justify-center" data-v-ef109631><i class="fa-solid fa-tasks text-2xl text-muted-foreground" data-v-ef109631></i></div><h3 class="text-content-bold mb-2" data-v-ef109631>No task selected</h3><p class="text-meta" data-v-ef109631>Select a task from the list to view its details and manage activities</p></div></div>',1)])]))])):q("",!0),N.value==="table"?(v(),w("div",Js,[V(Ls,{tasks:S(G),"current-task-id":(U=E.value)==null?void 0:U.compositeId,"highlight-id":x.value,"show-closed":ie.value,"show-mobile-close":!1,"open-menu-id":Q.value,"get-vehicle-type":S(m),"get-vehicle-type-badge-class":S(c),"get-owner-info":S(o),"get-stage-badge-class":S(je),"view-mode":N.value,onSelect:Z,onMenuClick:De,onMenuClose:b[2]||(b[2]=f=>Q.value=null),onToggleClosed:b[3]||(b[3]=f=>ie.value=f),onReassign:Ze,onClose:de,onViewChange:j,class:"flex-1 w-full"},null,8,["tasks","current-task-id","highlight-id","show-closed","open-menu-id","get-vehicle-type","get-vehicle-type-badge-class","get-owner-info","get-stage-badge-class","view-mode"])])):q("",!0),N.value==="table"?(v(),se(bt,{key:2,show:le.value,onClose:pe},{default:z(()=>{var f;return[E.value&&r.value&&M.value&&X.value?(v(),se(Fe,{key:((f=E.value)==null?void 0:f.compositeId)||"drawer-empty",task:E.value,"management-widget":r.value,"store-adapter":M.value,"add-new-config":X.value,"filtered-tasks":S(G),"is-drawer-view":!0,onTaskNavigate:Xe,onClose:pe},null,8,["task","management-widget","store-adapter","add-new-config","filtered-tasks"])):q("",!0)]}),_:1},8,["show"])):q("",!0),V($t,{show:ne.value,onClose:b[4]||(b[4]=f=>ne.value=!1),onConfirm:et},null,8,["show"])])}}},fn=Se(Xs,[["__scopeId","data-v-ef109631"]]);export{fn as default};
