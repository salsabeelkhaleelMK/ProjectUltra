import{a0 as V,r as f,c as C,W as I,a8 as H,a9 as D,aa as E,H as N,ab as R,ac as T,ad as U,ae as j,af as q,ag as z,ah as G}from"./index-DhXdPUMX.js";const Q=V("opportunities",()=>{const i=f([]),n=f(null),l=f(!1),r=f(null),x=C(()=>n.value?I.filter(e=>e.opportunityId===n.value.id):[]),$=C(()=>i.value.filter(e=>e.priority==="Hot"&&e.stage!=="Closed Lost")),B=async(e={})=>await O(e),O=async(e={})=>{l.value=!0,r.value=null;try{const t=await H(e);return i.value=t.data||t,t}catch(t){throw r.value=t.message,t}finally{l.value=!1}},p=async e=>await h(e),h=async e=>{l.value=!0,r.value=null;try{return n.value=await D(e),n.value}catch(t){throw r.value=t.message,t}finally{l.value=!1}},b=async e=>{l.value=!0,r.value=null;try{const t=await E(e);return i.value.push(t),t}catch(t){throw r.value=t.message,t}finally{l.value=!1}},W=async(e,t)=>await w(e,t),w=async(e,t)=>{var u,a;l.value=!0,r.value=null;try{const v=N().getSetting("autoCloseWidgetsOnClose"),y=((u=n.value)==null?void 0:u.id)===e?n.value:i.value.find(c=>c.id===e);if(v&&t.stage&&(t.stage==="Closed Won"||t.stage==="Closed Lost")){const c=y==null?void 0:y.stage;if(c&&c!=="Closed Won"&&c!=="Closed Lost"){const L=I.filter(o=>{var A,S;return o.opportunityId===parseInt(e)&&(o.type==="nfu-task"||o.type==="ofb-task"||((A=o.action)==null?void 0:A.includes("NFU"))||((S=o.action)==null?void 0:S.includes("OFB")))});for(const o of L)o.completed||await g(e,o.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${t.stage}`})}}const d=await R(e,t),m=i.value.findIndex(c=>c.id===e);return m!==-1&&(i.value[m]=d),((a=n.value)==null?void 0:a.id)===e&&(n.value=d),d}catch(s){throw r.value=s.message,s}finally{l.value=!1}},k=async e=>{l.value=!0,r.value=null;try{await T(e),i.value=i.value.filter(t=>t.id!==e)}catch(t){throw r.value=t.message,t}finally{l.value=!1}},F=async(e,t)=>{var u;l.value=!0,r.value=null;try{const a=await U(e,t);return((u=n.value)==null?void 0:u.id)===parseInt(e)&&await p(e),a}catch(a){throw r.value=a.message,a}finally{l.value=!1}},g=async(e,t,u)=>{var a;l.value=!0,r.value=null;try{const s=await j(e,t,u);return((a=n.value)==null?void 0:a.id)===parseInt(e)&&await p(e),s}catch(s){throw r.value=s.message,s}finally{l.value=!1}};return{opportunities:i,currentOpportunity:n,loading:l,error:r,currentOpportunityActivities:x,hotOpportunities:$,loadOpportunities:B,fetchOpportunities:O,loadOpportunityById:p,fetchOpportunityById:h,createOpportunity:b,modifyOpportunity:W,updateOpportunity:w,deleteOpportunity:k,addActivity:F,updateActivity:g,deleteActivity:async(e,t)=>{var u;l.value=!0,r.value=null;try{return await G(e,t),((u=n.value)==null?void 0:u.id)===parseInt(e)&&await p(e),{success:!0}}catch(a){throw r.value=a.message,a}finally{l.value=!1}},addVehicle:async(e,t)=>{var u;l.value=!0,r.value=null;try{const a=await q(e,t),s=i.value.findIndex(v=>v.id===parseInt(e));return s!==-1&&(i.value[s]=a),((u=n.value)==null?void 0:u.id)===parseInt(e)&&(n.value=a),a}catch(a){throw r.value=a.message,a}finally{l.value=!1}},createOffer:async(e,t)=>{var u;l.value=!0,r.value=null;try{const a=await z(e,t),s=i.value.findIndex(v=>v.id===parseInt(e));return s!==-1&&(i.value[s]=a.opportunity),((u=n.value)==null?void 0:u.id)===parseInt(e)&&(n.value=a.opportunity),a}catch(a){throw r.value=a.message,a}finally{l.value=!1}}}});export{Q as u};
