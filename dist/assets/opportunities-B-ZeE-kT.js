const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-5RjyxMFD.js","assets/index-OK7kJjN3.css"])))=>i.map(i=>d[i]);
import{L as l,a1 as d,d as Y,r as f,c as m,a2 as Q}from"./index-5RjyxMFD.js";const p=(t=300)=>new Promise(r=>setTimeout(r,t)),V=async(t={})=>{await p();let r=[...l];if(t.stage&&(r=r.filter(s=>s.stage===t.stage)),t.assignee&&(r=r.filter(s=>s.assignee===t.assignee)),t.search){const s=t.search.toLowerCase();r=r.filter(i=>i.customer.name.toLowerCase().includes(s)||i.vehicle.brand.toLowerCase().includes(s)||i.vehicle.model.toLowerCase().includes(s))}return{data:r,total:r.length}},x=async t=>{await p();const r=l.find(s=>s.id===parseInt(t));if(!r)throw new Error("Opportunity not found");return r},A=async t=>(await p(),d.filter(r=>r.opportunityId===parseInt(t))),W=async t=>{await p();const r={id:l.length+1,...t,createdAt:new Date().toISOString()};return l.push(r),r},g=async(t,r)=>{await p();const s=l.findIndex(i=>i.id===parseInt(t));if(s===-1)throw new Error("Opportunity not found");return l[s]={...l[s],...r},l[s]},$=async t=>{await p();const r=l.findIndex(s=>s.id===parseInt(t));if(r===-1)throw new Error("Opportunity not found");return l.splice(r,1),{success:!0}},j=async(t,r)=>{await p();const s={id:d.length+1,opportunityId:parseInt(t),timestamp:new Date().toISOString(),...r};return d.push(s),s},z=async(t,r,s)=>{await p();const i=d.find(u=>u.id===parseInt(r)&&u.opportunityId===parseInt(t));if(!i)throw new Error("Activity not found");return Object.assign(i,s,{timestamp:new Date().toISOString()}),i},G=async(t,r)=>{await p();const s=d.findIndex(i=>i.id===parseInt(r)&&i.opportunityId===parseInt(t));if(s===-1)throw new Error("Activity not found");return d.splice(s,1),{success:!0}},H=()=>l.length>0?Math.max(...l.map(t=>t.id))+1:1,J=async(t,r)=>{var i;await p();const s={id:H(),customer:t.customer,requestedCar:t.requestedCar,vehicle:{...t.requestedCar},stage:"Qualified",tags:t.tags||[],probability:50,value:((i=t.requestedCar)==null?void 0:i.price)||0,expectedCloseDate:new Date(Date.now()+90*24*60*60*1e3).toISOString().split("T")[0],assignee:t.assignee||"Michael Thomas",source:t.source||"Marketing",fiscalEntity:t.fiscalEntity||"",sourceDetails:t.sourceDetails||"",createdAt:new Date().toISOString(),lastActivity:new Date().toISOString()};l.unshift(s);for(const u of r){const y={id:d.length+1,opportunityId:s.id,leadId:void 0,timestamp:u.timestamp,type:u.type,user:u.user,action:u.action,content:u.content,data:u.data};d.push(y)}return s},N=Y("opportunities",()=>{const t=f([]),r=f(null),s=f([]),i=f(!1),u=f(null),y=f({stage:null,assignee:null,search:""}),S=m(()=>t.value.length),b=m(()=>{const e={};return t.value.forEach(n=>{e[n.stage]||(e[n.stage]=[]),e[n.stage].push(n)}),e}),L=m(()=>t.value.reduce((e,n)=>e+n.value,0));async function O(){i.value=!0,u.value=null;try{const e=await V(y.value);t.value=e.data}catch(e){u.value=e.message}finally{i.value=!1}}async function C(e){i.value=!0,u.value=null;try{r.value=await x(e),s.value=await A(e);const n=t.value.findIndex(a=>a.id===parseInt(e));n!==-1&&(t.value[n]=r.value)}catch(n){u.value=n.message}finally{i.value=!1}}async function E(e){i.value=!0,u.value=null;try{const n=await W(e);return t.value.unshift(n),n}catch(n){throw u.value=n.message,n}finally{i.value=!1}}async function k(e,n){i.value=!0,u.value=null;try{const a=await g(e,n),o=t.value.findIndex(c=>c.id===e);return o!==-1&&(t.value[o]=a),a}catch(a){throw u.value=a.message,a}finally{i.value=!1}}async function I(e){i.value=!0,u.value=null;try{await $(e),t.value=t.value.filter(n=>n.id!==e)}catch(n){throw u.value=n.message,n}finally{i.value=!1}}async function h(e,n){try{const a=await j(e,n);return s.value.unshift(a),a}catch(a){throw u.value=a.message,a}}async function _(e,n,a){try{const o=await z(e,n,a),c=s.value.findIndex(v=>v.id===parseInt(n));return c!==-1&&(s.value[c]=o),o}catch(o){throw u.value=o.message,o}}async function F(e,n){try{return await G(e,n),s.value=s.value.filter(a=>a.id!==parseInt(n)),{success:!0}}catch(a){throw u.value=a.message,a}}function T(e){y.value={...y.value,...e},O()}async function q(e){var n;i.value=!0,u.value=null;try{const a=t.value.find(w=>w.id===e)||r.value,o={stage:"Qualified"};((a==null?void 0:a.probability)===0||(a==null?void 0:a.probability)===100)&&(o.probability=50);const c=await g(e,o),v=t.value.findIndex(w=>w.id===e);return v!==-1&&(t.value[v]=c),((n=r.value)==null?void 0:n.id)===e&&(r.value=c),await h(e,{type:"note",user:"You",action:"reopened opportunity",content:`Opportunity has been reopened and moved back to ${c.stage} stage`}),c}catch(a){throw u.value=a.message,a}finally{i.value=!1}}async function R(e){var n;i.value=!0,u.value=null;try{const a=await g(e,{stage:"Registration"}),o=t.value.findIndex(c=>c.id===e);return o!==-1&&(t.value[o]=a),((n=r.value)==null?void 0:n.id)===e&&(r.value=a),await h(e,{type:"note",user:"You",action:"marked as registration",content:"Opportunity moved to Registration stage - administrative phase before delivery"}),a}catch(a){throw u.value=a.message,a}finally{i.value=!1}}async function B(e){var n;i.value=!0,u.value=null;try{const a=await g(e,{stage:"Closed",probability:100}),o=t.value.findIndex(c=>c.id===e);return o!==-1&&(t.value[o]=a),((n=r.value)==null?void 0:n.id)===e&&(r.value=a),await h(e,{type:"note",user:"You",action:"marked as closed won",content:"Opportunity marked as Closed Won - contract signed and deal completed"}),a}catch(a){throw u.value=a.message,a}finally{i.value=!1}}async function D(e,n){i.value=!0,u.value=null;try{const a=await J(e,n);return t.value.unshift(a),a}catch(a){throw u.value=a.message,a}finally{i.value=!1}}async function M(e){i.value=!0,u.value=null;try{const n=await x(e),a=await A(e),{useLeadsStore:o}=await Q(async()=>{const{useLeadsStore:w}=await import("./index-5RjyxMFD.js").then(P=>P.a3);return{useLeadsStore:w}},__vite__mapDeps([0,1])),v=await o().createLeadFromOpportunity(n,a);return await I(e),v.id}catch(n){throw u.value=n.message,n}finally{i.value=!1}}return{opportunities:t,currentOpportunity:r,currentOpportunityActivities:s,loading:i,error:u,filters:y,totalOpportunities:S,opportunitiesByStage:b,totalValue:L,loadOpportunities:O,loadOpportunityById:C,addOpportunity:E,modifyOpportunity:k,removeOpportunity:I,addActivity:h,updateActivity:_,deleteActivity:F,setFilters:T,reopenOpportunity:q,markAsRegistration:R,markAsClosedWon:B,createOpportunityFromLead:D,convertOpportunityToLead:M}});export{N as useOpportunitiesStore};
