import{D,r as p,c as A,l as V,af as j,ag as E,ah as H,P as N,a6 as y,ai as P,aj as R,ae as T,ac as U,ak as q,al as z,am as G}from"./index-Db_3peLd.js";const M=D("opportunities",()=>{const n=p([]),r=p(null),c=p([]),l=p(!1),s=p(null),S=A(()=>n.value.filter(e=>e.priority==="Hot"&&e.stage!=="Closed Lost"));V(r,async(e,t)=>{if(e){if(!t||t.id!==e.id)try{c.value=await y(e.id)}catch(u){console.error("Failed to load opportunity activities:",u),c.value=[]}}else c.value=[]},{immediate:!0});const x=async(e={})=>{l.value=!0,s.value=null;try{const t=await j(e);return n.value=t.data||t,t}catch(t){throw s.value=t.message,t}finally{l.value=!1}},C=async e=>{l.value=!0,s.value=null;try{const t=await E(e);r.value=t;const u=n.value.findIndex(a=>a.id===parseInt(e));return u!==-1&&(n.value[u]=t),r.value}catch(t){throw s.value=t.message,t}finally{l.value=!1}},I=async e=>{l.value=!0,s.value=null;try{const t=await H(e);return n.value.push(t),t}catch(t){throw s.value=t.message,t}finally{l.value=!1}},$=async(e,t)=>{var u,a;l.value=!0,s.value=null;try{const f=N().getSetting("autoCloseWidgetsOnClose"),d=((u=r.value)==null?void 0:u.id)===e?r.value:n.value.find(o=>o.id===e);if(f&&t.stage&&(t.stage==="Closed Won"||t.stage==="Closed Lost")){const o=d==null?void 0:d.stage;if(o&&o!=="Closed Won"&&o!=="Closed Lost"){const W=(await y(e)).filter(v=>{var g,m;return v.type==="nfu-task"||v.type==="ofb-task"||((g=v.action)==null?void 0:g.includes("NFU"))||((m=v.action)==null?void 0:m.includes("OFB"))});for(const v of W)v.completed||await O(e,v.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${t.stage}`})}}const h=await P(e,t),w=n.value.findIndex(o=>o.id===e);return w!==-1&&(n.value[w]=h),((a=r.value)==null?void 0:a.id)===e&&(r.value=h),h}catch(i){throw s.value=i.message,i}finally{l.value=!1}},B=async e=>{l.value=!0,s.value=null;try{await R(e),n.value=n.value.filter(t=>t.id!==e)}catch(t){throw s.value=t.message,t}finally{l.value=!1}},F=async(e,t)=>{var u;l.value=!0,s.value=null;try{const a=await T(e,t);return((u=r.value)==null?void 0:u.id)===parseInt(e)&&(c.value=await y(e)),a}catch(a){throw s.value=a.message,a}finally{l.value=!1}},O=async(e,t,u)=>{var a;l.value=!0,s.value=null;try{const i=await U(e,t,u);return((a=r.value)==null?void 0:a.id)===parseInt(e)&&(c.value=await y(e)),i}catch(i){throw s.value=i.message,i}finally{l.value=!1}},b=async(e,t)=>{var u;l.value=!0,s.value=null;try{const a=await q(e,t),i=n.value.findIndex(f=>f.id===parseInt(e));return i!==-1&&(n.value[i]=a),((u=r.value)==null?void 0:u.id)===parseInt(e)&&(r.value=a),a}catch(a){throw s.value=a.message,a}finally{l.value=!1}},k=async(e,t)=>{var u;l.value=!0,s.value=null;try{const a=await z(e,t),i=n.value.findIndex(f=>f.id===parseInt(e));return i!==-1&&(n.value[i]=a.opportunity),((u=r.value)==null?void 0:u.id)===parseInt(e)&&(r.value=a.opportunity),a}catch(a){throw s.value=a.message,a}finally{l.value=!1}},L=async(e,t)=>{var u;l.value=!0,s.value=null;try{return await G(e,t),((u=r.value)==null?void 0:u.id)===parseInt(e)&&(c.value=await y(e)),{success:!0}}catch(a){throw s.value=a.message,a}finally{l.value=!1}};return{opportunities:n,currentOpportunity:r,loading:l,error:s,currentOpportunityActivities:A(()=>c.value),hotOpportunities:S,fetchOpportunities:x,fetchOpportunityById:C,createOpportunity:I,updateOpportunity:$,deleteOpportunity:B,addActivity:F,updateActivity:O,deleteActivity:L,addVehicle:b,createOffer:k}});export{M as u};
