const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/contacts-Doz8YZdN.js","assets/index-D-GV69Dn.js","assets/index-C6dtcYjV.css","assets/users-D9zJDDml.js"])))=>i.map(i=>d[i]);
import{z as po,i as ks,n as J,u as Ss,k as Cs,l as Ja,m as Ka,$ as vo,b as go,Z as Pa,X as Ma,a as yo,p as Ht,Q as W,f as It,F as Vt,L as bt,g as ht,h as xt,d as wt,W as Dt,U as At,H as Tt,j as ge,G as Ot,q as Ue,c as Oe,o as He,C as Ut,V as bo,D as Ra,r as Ea,K as ho}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-3RNqBGno.js";import{H as Gt,W as hn,X as Za,c as $,d as k,o as f,e,g as N,t as U,n as re,Y as xo,Z as As,r as T,p as Se,K as ss,y as t,F as pe,i as Ie,I as on,u as Jt,C as rn,J as Ts,s as n,x as ee,w as ln,$ as Xs,B as o,a0 as xs,k as D,a1 as Xa,a2 as el,a3 as na,P as sa,h as aa,j as tl,T as $s,L as qt,M as Os,a4 as ws,R as bs,q as nl,l as ve,m as Mn,a5 as wo,a6 as sl,a7 as as,G as an,a8 as ct,a9 as $t,Q as la,_ as Cn,aa as ko,ab as So,ac as Co,ad as $o,ae as Is,D as Do,af as ja,ag as ea,ah as Ao,ai as To,aj as hs,ak as Oo}from"./index-D-GV69Dn.js";import{u as Bt}from"./opportunities-D_EVVSI9.js";import{L as Io,O as Vo,f as Ba,I as al,h as ll,_ as Fo,i as ol,E as Lo,M as il,j as No,k as qo,l as Uo,T as Po,m as rl,n as Mo,o as Ro,p as Eo,q as jo,r as oa,s as ia,t as ra,u as Bo,v as zo,w as Wo,x as _o,y as Yo,z as Ho,A as Qo,B as Go,e as za,b as $n,D as ns,P as Jo,g as Ko,c as Zo,F as Xo,G as ei,H as ti,J as ni,K as si,N as ai,Q as Wa,R as li,S as qn,U as _a,V as oi,W as ii,X as ri}from"./OfferCarousel-YtLzEMp2.js";import{u as xn,c as Gs}from"./users-D9zJDDml.js";import{_ as ul}from"./CreateEventModal-DtWwBW-0.js";import{S as vt}from"./components-D1kWShum.js";import{_ as ui}from"./ReassignUserModal-B8fbsoa_.js";import{S as dl}from"./sparkles-DqOgHrLF.js";import{f as cl}from"./vehicles-CLPlMvEC.js";import{_ as di,a as ci}from"./EditEventModal-Byz2Szq-.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ya=Gt("AlertCircleIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=Gt("CheckIcon",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mi=Gt("ChevronRightIcon",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fi=Gt("LockIcon",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ml=Gt("PackageIcon",[["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pi=Gt("PenLineIcon",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vi=Gt("PhoneOffIcon",[["path",{d:"M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91",key:"z86iuo"}],["line",{x1:"22",x2:"2",y1:"2",y2:"22",key:"11kh81"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gi=Gt("RotateCcwIcon",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yi=Gt("ThumbsDownIcon",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z",key:"s6e0r"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bi=Gt("ZapIcon",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]);function hi(s){if(!s)return null;if(s.title)return s.title;const C=s.type||(s.customer?"opportunity":"lead"),a=hn(s,C);if(C==="lead"){if(s.scheduledAppointment&&s.scheduledAppointment.title)return s.scheduledAppointment.title;const i=Io[a];if(!i||!i.primaryAction)return null;const l=i.primaryAction,u={lead:s,displayStage:a},d=typeof l=="function"?l(u):l;if(!d)return null;const S=typeof d.label=="function"?d.label(u):d.label,V=typeof d.title=="function"?d.title(u):d.title;return S||V||null}if(C==="opportunity"){if(s.scheduledAppointment&&s.scheduledAppointment.title)return s.scheduledAppointment.title;const i=Vo[a];if(!i||!i.primaryAction)return null;const l=i.primaryAction,u={deliverySubstatus:s.deliverySubstatus||Za(s,s.activities||[]),hasOffers:!!(s.offers&&s.offers.length>0)||!!(s.activities&&s.activities.some(A=>A.type==="offer")),scheduledAppointment:s.scheduledAppointment,opportunity:s,formatDateTime:A=>new Date(A).toLocaleDateString()},d=typeof l=="function"?l(u):l;if(!d)return null;const S=typeof d.label=="function"?d.label(u):d.label,V=typeof d.title=="function"?d.title(u):d.title;return S||V||null}return null}const xi={class:"flex flex-wrap items-center gap-2"},wi={key:2,class:"px-1.5 py-0.5 rounded text-xs font-bold uppercase bg-red-50 text-red-700 border border-red-200 leading-none"},ki={__name:"TaskBadges",props:{task:{type:Object,required:!0}},setup(s){const C=s,a=$(()=>C.task.type==="lead"?"Lead":"Opportunity"),i=$(()=>C.task.type==="lead"?"bg-blue-50 text-blue-700 border-blue-200":"bg-purple-50 text-purple-700 border-purple-200"),l=y=>y?y.stage||y.currentStage||"New":"",u=y=>{if(!y||y.type!=="opportunity")return null;try{return hn(y,"opportunity")}catch{return y.displayStage||y.stage||null}},d=$(()=>!C.task||C.task.type!=="opportunity"?null:l(C.task)),S=$(()=>C.task?C.task.type==="opportunity"?u(C.task)||l(C.task)||"New":C.task.stage||C.task.currentStage||C.task.displayStage||"New":""),V=$(()=>{if(!C.task||C.task.type!=="opportunity")return null;const y=d.value,b=S.value;if(!b||!y||b===y)return null;const h=y.toLowerCase().trim();if(b.toLowerCase().trim().startsWith(h+" - ")){const x=y+" - ";if(b.startsWith(x))return b.substring(x.length)}return null}),A=$(()=>!!V.value),w=$(()=>V.value||S.value),g=y=>{if(!y)return"bg-gray-50 text-gray-700 border-gray-200";if(C.task.type==="opportunity")try{const h=xo(y,"opportunity");return h.includes("blue")?h+" border-blue-200":h.includes("purple")?h+" border-purple-200":h.includes("yellow")?h+" border-yellow-200":h.includes("pink")?h+" border-pink-200":h.includes("indigo")?h+" border-indigo-200":h.includes("emerald")?h+" border-emerald-200":h.includes("green")?h+" border-green-200":h.includes("red")?h+" border-red-200":(h.includes("gray"),h+" border-gray-200")}catch{}const b=y.toLowerCase();return b.includes("new")?"bg-blue-50 text-blue-600 border-blue-200":b.includes("qualif")?"bg-green-50 text-green-600 border-green-200":b.includes("negotiat")?"bg-purple-50 text-purple-600 border-purple-200":b.includes("close")?"bg-muted text-muted-foreground border-border":"bg-gray-50 text-gray-700 border-gray-200"};return(y,b)=>(f(),k("div",xi,[e("span",{class:re(["px-1.5 py-0.5 rounded text-xs font-bold uppercase border leading-none",i.value])},U(a.value),3),d.value&&A.value?(f(),k("span",{key:0,class:re(["px-1.5 py-0.5 rounded text-xs font-bold uppercase border leading-none",g(d.value)])},U(d.value),3)):N("",!0),w.value?(f(),k("span",{key:1,class:re(["px-1.5 py-0.5 rounded text-xs font-bold uppercase border leading-none",g(w.value)])},U(w.value),3)):N("",!0),s.task.priority==="Hot"?(f(),k("span",wi," Hot ")):N("",!0)]))}},Si={class:"flex flex-col min-w-64 max-w-sm w-full bg-white rounded-lg shadow-nsc-card overflow-hidden"},Ci={class:"p-2 border-b border-border shrink-0"},$i=["placeholder"],Di={class:"max-h-96 overflow-y-auto p-2"},Ai={class:"text-xs font-medium text-muted-foreground uppercase tracking-wide px-2 py-1 mb-1"},Ti=["onClick"],Oi={key:0,class:"fa-solid fa-users text-xs"},Ii={key:1},Vi={class:"min-w-0 flex-1"},Fi={class:"font-medium text-sm text-foreground truncate"},Li={key:0,class:"text-xs text-muted-foreground truncate capitalize"},Ni={key:1,class:"text-center py-8"},qi={class:"text-sm text-muted-foreground"},Ds={__name:"AssigneeDropdownContent",emits:["select"],setup(s,{emit:C}){const{t:a}=As(),i=C,l=xn(),u=T(""),d=$(()=>l.assignableUsers||[]),S=$(()=>l.assignableTeams||[]),V=$(()=>{const c=S.value.map(F=>F.name),x=[...new Set(d.value.map(F=>F.team).filter(Boolean))],p=new Set(c);return x.forEach(F=>{p.has(F)||(p.add(F),c.push(F))}),c}),A=$(()=>{const c=[],x=S.value.map(p=>({...p,type:"team",team:p.name}));return x.length>0&&c.push({key:"teams",label:"Teams",items:x}),V.value.forEach(p=>{const F=d.value.filter(R=>R.team===p);F.length>0&&c.push({key:`team-${p}`,label:p,items:F.map(R=>({...R,type:"user"}))})}),c}),w=(c,x)=>{const p=x.toLowerCase(),F=(c.name||"").toLowerCase(),R=(c.email||"").toLowerCase(),P=(c.role||"").toLowerCase(),z=(c.team||"").toLowerCase();return F.includes(p)||R.includes(p)||P.includes(p)||z.includes(p)},g=$(()=>{const c=u.value.trim();return c?A.value.map(x=>({...x,items:x.items.filter(p=>w(p,c))})).filter(x=>x.items.length>0):A.value}),y=$(()=>g.value.some(c=>c.items.length>0));function b(c){return{manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"}[c]||"bg-muted text-muted-foreground"}function h(c){const x=c.type==="team"?{...c,team:c.name,role:void 0,email:void 0,initials:void 0}:c;i("select",x)}return(c,x)=>(f(),k("div",Si,[e("div",Ci,[Se(e("input",{"onUpdate:modelValue":x[0]||(x[0]=p=>u.value=p),type:"text",placeholder:t(a)("common.assignee.searchPlaceholder"),class:"w-full h-10 min-h-10 px-3 border border-border rounded-lg text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/15"},null,8,$i),[[ss,u.value]])]),e("div",Di,[y.value?(f(!0),k(pe,{key:0},Ie(g.value,p=>(f(),k("div",{key:p.key,class:"mb-3 last:mb-0"},[e("p",Ai,U(p.label),1),(f(!0),k(pe,null,Ie(p.items,F=>(f(),k("button",{key:`${F.type}-${F.id}`,type:"button",onClick:R=>h(F),class:"w-full flex items-center gap-3 p-2 rounded-lg border border-border hover:bg-muted hover:border-brand-dark/30 transition-colors text-left"},[e("div",{class:re(["w-8 h-8 rounded-full flex items-center justify-center font-semibold text-xs shrink-0",F.type==="team"?"bg-green-100 text-green-700":b(F.role)])},[F.type==="team"?(f(),k("i",Oi)):(f(),k("span",Ii,U(F.initials||"?"),1))],2),e("div",Vi,[e("p",Fi,U(F.name),1),F.type==="user"?(f(),k("p",Li,U(F.role)+" • "+U(F.email),1)):N("",!0)])],8,Ti))),128))]))),128)):(f(),k("div",Ni,[x[1]||(x[1]=e("i",{class:"fa-solid fa-search text-2xl text-muted-foreground mb-2"},null,-1)),e("p",qi,U(t(a)("common.assignee.noAssigneesFound")),1)]))])]))}},Ui={class:"border-b border-border bg-white px-6 h-16 min-h-16 shrink-0"},Pi={class:"flex items-center justify-between gap-4 w-full h-full"},Mi={class:"flex flex-col min-w-0"},Ri={class:"flex items-center gap-2 min-w-0 flex-wrap"},Ei={key:0,class:"text-lg font-medium text-foreground truncate"},ji={key:1,class:"text-lg font-medium text-foreground truncate"},Bi={key:2,class:"text-lg font-medium text-foreground"},zi={key:3,class:"shrink-0"},Wi={key:4,class:"flex items-center gap-1.5 shrink-0"},_i={key:0,class:"flex items-center gap-1.5 mt-0.5 flex-wrap"},Yi={key:0,class:"flex items-center gap-1.5"},Hi={class:"text-xs font-medium text-foreground truncate"},Qi={key:1,class:"flex items-center gap-1.5"},Gi={key:0,class:"flex items-center gap-1.5 text-xs text-muted-foreground"},Ji={key:1,class:"relative"},Ki=["aria-expanded"],Zi=["disabled","onClick"],Xi={class:"flex items-center gap-3 shrink-0"},er={__name:"TaskDetailHeader",props:{task:{type:Object,default:null},filteredTasks:{type:Array,default:()=>[]},isDrawerView:{type:Boolean,default:!1}},emits:["previous","next","close","postpone-expected-close","tag-updated","reassigned"],setup(s,{emit:C}){const a=s,i=C,l=T(!1),u=T(!1),d=T(!1),S=xn(),V=Jt(),A=rn(),w=Bt(),g=$(()=>V.currentUser),y=$(()=>{var E,O,G;return!!((E=a.task)!=null&&E.assignee||(O=a.task)!=null&&O.owner||(G=a.task)!=null&&G.assignedTo)}),b=$(()=>{var G,De,be,Ne,ot,ze,it,mt;const E=((G=a.task)==null?void 0:G.assignee)||((De=a.task)==null?void 0:De.owner)||((be=a.task)==null?void 0:be.assignedTo)||"Unassigned",O=(Ne=S.users)==null?void 0:Ne.find(Ke=>Ke.name===E);return{name:E,team:(O==null?void 0:O.team)||((ot=a.task)==null?void 0:ot.assigneeTeam)||((ze=a.task)==null?void 0:ze.team)||"No team",dealership:(O==null?void 0:O.dealership)||((it=a.task)==null?void 0:it.assigneeDealership)||"MotorK Dealership",role:(O==null?void 0:O.role)||((mt=a.task)==null?void 0:mt.assigneeRole)||"salesman"}}),h=E=>!E||E==="Unassigned"?"?":E.split(" ").map(O=>O[0]).join("").toUpperCase().substring(0,2),c=E=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[E]||"bg-muted text-muted-foreground",x=async()=>{if(!(!g.value||!a.task))try{a.task.type==="lead"?await A.updateLead(a.task.id,{assignee:g.value.name,assigneeType:"user",assigneeTeam:g.value.team,assigneeDealership:g.value.dealership,assigneeRole:g.value.role}):a.task.type==="opportunity"&&await w.updateOpportunity(a.task.id,{assignee:g.value.name,assigneeType:"user",assigneeTeam:g.value.team,assigneeDealership:g.value.dealership,assigneeRole:g.value.role}),i("reassigned",g.value)}catch(E){console.error("Error assigning to self:",E)}};async function p(E){if(!a.task)return;const O={assignee:E.name,assigneeType:E.type,assigneeTeam:E.team??E.name,assigneeDealership:E.dealership,assigneeRole:E.role};E.type==="team"&&(O.teamId=E.id),a.task.type==="lead"?await A.updateLead(a.task.id,O):a.task.type==="opportunity"&&await w.updateOpportunity(a.task.id,O),i("reassigned",E)}function F(E){p(E).catch(O=>console.error("Error assigning:",O)),d.value=!1}const R=$(()=>{var E,O;return((E=a.task)==null?void 0:E.type)==="lead"&&((O=a.task)==null?void 0:O.nextActionDue)&&!q.value}),P=$(()=>"Due Date"),z=$(()=>{var E;return(E=a.task)!=null&&E.nextActionDue?Ba(a.task.nextActionDue):""}),H=$(()=>{var E,O;return((E=a.task)==null?void 0:E.type)==="opportunity"&&((O=a.task)==null?void 0:O.expectedCloseDate)}),L=$(()=>{var E;return(E=a.task)!=null&&E.expectedCloseDate?Ba(a.task.expectedCloseDate):""}),q=$(()=>{var E,O,G;return((E=a.task)==null?void 0:E.stage)==="Closed Won"||((O=a.task)==null?void 0:O.stage)==="Closed Lost"||((G=a.task)==null?void 0:G.isClosed)}),K=$(()=>{var E;return((E=a.task)==null?void 0:E.type)!=="opportunity"?[]:[{key:"postpone",label:"Postpone",onClick:()=>{l.value=!1,i("postpone-expected-close")}}]}),_=$(()=>!a.task||!a.filteredTasks.length?!1:a.filteredTasks.findIndex(O=>{const G=a.task.compositeId||a.task.id;return(O.compositeId||O.id)===G})>0),Q=$(()=>{if(!a.task||!a.filteredTasks.length)return!1;const E=a.filteredTasks.findIndex(O=>{const G=a.task.compositeId||a.task.id;return(O.compositeId||O.id)===G});return E>=0&&E<a.filteredTasks.length-1}),ue=$(()=>a.task?hi(a.task):null),ne=async E=>{if(!a.task)return;const O=a.task.tags||[];if(O.includes(E)){u.value=!1;return}const G=[...O,E];try{i("tag-updated",{taskId:a.task.id,taskType:a.task.type,tags:G}),u.value=!1}catch(De){console.error("Error adding tag:",De)}};return(E,O)=>{var De;const G=Ts("click-outside");return f(),k("div",Ui,[e("div",Pi,[e("div",Mi,[e("div",Ri,[s.task&&ue.value?(f(),k("h2",Ei,U(ue.value),1)):s.task?(f(),k("h2",ji,U(s.task.type==="lead"?"Lead Qualification Task":"Opportunity Management Task"),1)):(f(),k("h2",Bi," No task selected ")),s.task?(f(),k("div",zi,[n(ki,{task:s.task},null,8,["task"])])):N("",!0),s.task?(f(),k("div",Wi,[(f(!0),k(pe,null,Ie(s.task.tags||[],be=>(f(),ee(t(po),{key:be,text:be,size:"small",theme:"blue"},null,8,["text"]))),128)),e("button",{onClick:O[0]||(O[0]=ln(be=>u.value=!0,["stop"])),class:"text-xs text-muted-foreground hover:text-primary font-medium hover:underline flex items-center gap-1 transition-colors whitespace-nowrap"},[n(t(Xs),{class:"w-3 h-3"}),O[9]||(O[9]=e("span",null,"tag",-1))])])):N("",!0)]),s.task?(f(),k("div",_i,[y.value?(f(),k("div",Yi,[e("div",{class:re(["w-5 h-5 rounded-full flex items-center justify-center font-bold text-[8px] shrink-0",c(b.value.role)])},U(h(b.value.name)),3),e("span",Hi,U(b.value.name),1),n(t(Cs),{open:d.value,"onUpdate:open":O[1]||(O[1]=be=>d.value=be)},{default:o(()=>[n(t(ks),{"as-child":""},{default:o(()=>[n(t(J),{variant:"ghost",size:"icon-sm",class:"h-5 w-5","aria-label":"Change assignee"},{default:o(()=>[n(t(xs),{size:10,"stroke-width":"2","aria-hidden":"true"})]),_:1})]),_:1}),n(t(Ss),{class:"w-auto p-0 border border-border rounded-lg shadow-nsc-card bg-white",side:"bottom",align:"end"},{default:o(()=>[n(Ds,{onSelect:F})]),_:1})]),_:1},8,["open"])])):(f(),k("div",Qi,[n(t(al),{size:12,class:"shrink-0 text-muted-foreground","stroke-width":"2"}),O[11]||(O[11]=e("span",{class:"text-xs text-muted-foreground"},"Unassigned",-1)),n(t(Ka),{class:"flex items-stretch gap-0 rounded-lg overflow-hidden"},{default:o(()=>[n(t(J),{variant:"default",size:"sm",class:"rounded-r-none border-r border-white/20 bg-primary text-xs h-6 px-2",onClick:x},{default:o(()=>[...O[10]||(O[10]=[D(" Assign to me ",-1)])]),_:1}),n(t(Ja)),n(t(Cs),{open:d.value,"onUpdate:open":O[2]||(O[2]=be=>d.value=be)},{default:o(()=>[n(t(ks),{"as-child":""},{default:o(()=>[n(t(J),{variant:"ghost",size:"icon-sm",class:"rounded-l-none border-0 -ml-px h-5 w-5","aria-label":"Assign to someone"},{default:o(()=>[n(t(xs),{size:10,"stroke-width":"2","aria-hidden":"true"})]),_:1})]),_:1}),n(t(Ss),{class:"w-auto p-0 border border-border rounded-lg shadow-nsc-card bg-white",side:"bottom",align:"start"},{default:o(()=>[n(Ds,{onSelect:F})]),_:1})]),_:1},8,["open"])]),_:1})])),R.value||H.value?(f(),k(pe,{key:2},[O[14]||(O[14]=e("span",{class:"text-muted-foreground"},"|",-1)),R.value?(f(),k("div",Gi,[O[12]||(O[12]=e("i",{class:"fa-solid fa-calendar-day text-xs"},null,-1)),e("span",null,U(P.value)+": "+U(z.value),1)])):N("",!0),H.value?(f(),k("div",Ji,[e("button",{type:"button",class:re(["flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors",{"cursor-default":q.value}]),"aria-expanded":l.value&&!q.value,"aria-haspopup":"true","aria-label":"Expected close date",onClick:O[3]||(O[3]=ln(be=>!q.value&&(l.value=!l.value),["stop"]))},[O[13]||(O[13]=e("i",{class:"fa-solid fa-calendar-day text-xs"},null,-1)),e("span",null,"Expected Close: "+U(L.value),1),q.value?N("",!0):(f(),ee(t(xs),{key:0,size:10,"stroke-width":"2",class:re(["shrink-0 transition-transform ml-1",{"rotate-180":l.value}])},null,8,["class"]))],10,Ki),l.value&&!q.value&&K.value.length>0?Se((f(),k("div",{key:0,class:"absolute left-0 top-full mt-2 z-50 w-56 bg-white border border-border rounded-lg shadow-nsc-card py-1",onClick:O[4]||(O[4]=ln(()=>{},["stop"]))},[(f(!0),k(pe,null,Ie(K.value,be=>(f(),k("button",{key:be.key,type:"button",class:"w-full px-3 py-2 text-left text-xs text-foreground hover:bg-muted flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!!be.disabled,onClick:Ne=>be.onClick()},U(be.label),9,Zi))),128))])),[[G,()=>l.value=!1]]):N("",!0)])):N("",!0)],64)):N("",!0)])):N("",!0)]),e("div",Xi,[n(t(J),{variant:"secondary",size:"icon",onClick:O[5]||(O[5]=be=>E.$emit("previous")),disabled:!_.value},{default:o(()=>[n(t(ll),{size:16,class:"text-muted-foreground"})]),_:1},8,["disabled"]),n(t(J),{variant:"secondary",size:"icon",onClick:O[6]||(O[6]=be=>E.$emit("next")),disabled:!Q.value},{default:o(()=>[n(t(mi),{size:16,class:"text-muted-foreground"})]),_:1},8,["disabled"]),s.isDrawerView?(f(),ee(t(J),{key:0,variant:"secondary",size:"icon",onClick:O[7]||(O[7]=be=>E.$emit("close")),class:"ml-1"},{default:o(()=>[n(t(Xa),{size:16,class:"text-muted-foreground"})]),_:1})):N("",!0)])]),n(Fo,{show:u.value,"existing-tags":((De=s.task)==null?void 0:De.tags)||[],onClose:O[8]||(O[8]=be=>u.value=!1),onAdd:ne},null,8,["show","existing-tags"])])}}},tr=on(er,[["__scopeId","data-v-60129da2"]]),nr=Object.assign({inheritAttrs:!1},{__name:"TaskManagementCard",props:{task:{type:Object,required:!0},type:{type:String,required:!0,validator:s=>["lead","opportunity"].includes(s)},managementWidget:{type:Object,default:null},activities:{type:Array,default:()=>[]}},setup(s){const C=s,a=el(),i=$(()=>{const l={...a};return C.type==="opportunity"&&"lead"in l&&delete l.lead,l});return(l,u)=>(f(),k("div",null,[s.managementWidget?(f(),ee(sa(s.managementWidget),na({key:0,lead:s.type==="lead"?s.task:void 0,opportunity:s.type==="opportunity"?s.task:void 0,activities:s.activities},i.value),null,16,["lead","opportunity","activities"])):N("",!0)]))}}),sr=on(nr,[["__scopeId","data-v-7d989f79"]]),ar={key:0,class:"overflow-hidden p-4",style:{"border-radius":"var(--border-radius-rounded-lg, 10px)",background:"var(--base-card, #FFF)","box-shadow":"var(--nsc-card-shadow)"}},lr={class:"space-y-3"},or=["onClick"],ir={class:"text-sm font-medium text-foreground truncate shrink-0 min-w-0"},rr={class:"text-sm text-muted-foreground truncate flex-1 min-w-0"},ur={key:0,class:"text-sm font-bold text-foreground shrink-0"},dr={class:"text-sm text-muted-foreground shrink-0"},cr={__name:"OtherCustomerRequestsCard",props:{task:{type:Object,required:!0}},setup(s){const C=s,a=aa(),i=rn(),l=Bt(),u=$(()=>{if(!C.task.customer)return[];const g=C.task.customer.email,y=C.task.customer.phone,b=C.task.compositeId;return[...(i.leads||[]).map(c=>({...c,type:"lead",compositeId:`lead-${c.id}`})),...(l.opportunities||[]).map(c=>({...c,type:"opportunity",compositeId:`opportunity-${c.id}`}))].filter(c=>c.compositeId===b||!c.customer?!1:c.customer.email===g||c.customer.phone===y).sort((c,x)=>new Date(x.createdAt||0)-new Date(c.createdAt||0)).slice(0,3)}),d=g=>{const[y,b]=g.compositeId.split("-");a.push({path:`/tasks/${b}`,query:{type:y}})},S=g=>g.stage||g.currentStage||"Unknown",V=g=>{const y=g.createdAt||g.nextActionDue||g.updatedAt;if(!y)return"";try{return new Date(y).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"2-digit"})}catch{return""}},A=g=>{const y=g.requestedCar||g.vehicle;if(!y)return"No vehicle";const b=y.brand||"",h=y.model||"",c=y.year?`(${y.year})`:"";return`${b} ${h} ${c}`.trim()||"Vehicle info N/A"},w=g=>g?g>=1e3?"€"+(g/1e3).toFixed(0)+"k":"€"+g:"€0";return(g,y)=>u.value.length>0?(f(),k("div",ar,[y[0]||(y[0]=e("h3",{class:"text-base font-medium text-foreground mb-4 leading-6"},"Other customer requests",-1)),e("div",lr,[(f(!0),k(pe,null,Ie(u.value,b=>(f(),k("div",{key:b.compositeId,onClick:h=>d(b),class:"group rounded-lg border border-transparent hover:border-brand-blue/30 hover:bg-blue-50/20 transition-all cursor-pointer flex items-center gap-2"},[e("span",{class:re(["text-sm font-bold uppercase px-1 py-0.5 rounded leading-normal shrink-0",b.type==="lead"?"bg-blue-50 text-blue-600":"bg-purple-50 text-purple-600"])},U(b.type==="lead"?"Lead":"Opp"),3),e("span",ir,U(S(b)),1),e("span",rr,U(A(b)),1),b.type==="opportunity"&&b.estimatedValue?(f(),k("span",ur,U(w(b.estimatedValue)),1)):N("",!0),e("span",dr,U(V(b)),1)],8,or))),128))])])):N("",!0)}},mr={class:"overflow-hidden p-4 rounded-lg bg-white shadow-nsc-card"},fr={class:"flex items-center justify-between mb-4"},pr={key:0,class:"text-sm text-muted-foreground"},vr={class:"flex gap-4"},gr={class:"w-24 shrink-0 aspect-3/2 rounded-lg overflow-hidden bg-surfaceTertiary"},yr=["src","alt"],br={key:1,class:"w-full h-full flex items-center justify-center"},hr={class:"min-w-0 flex-1 flex flex-col justify-center"},xr={class:"text-sm font-semibold text-foreground truncate"},wr={key:0,class:"flex items-center gap-2 mt-1 text-sm text-foreground flex-wrap"},kr={key:0,class:"font-semibold"},Sr={key:1,class:"flex gap-3 mt-0.5 text-xs text-muted-foreground"},Cr={key:0},$r={key:1},Dr={key:0,class:"mt-4 pt-4 border-t border-border"},Ar={class:"text-sm text-foreground leading-5"},Tr={class:"flex gap-2 pt-3 mt-3 border-t border-border"},Or={class:"relative"},Ir={key:0,class:"absolute right-0 top-full mt-1 z-50"},Vr={__name:"VehicleRequestCard",props:{vehicle:{type:Object,required:!0},requestMessage:{type:String,default:""},source:{type:String,default:""},imageUrl:{type:String,default:""}},emits:["open-ad","more-actions","edit-vehicle","remove-vehicle"],setup(s,{emit:C}){const a=s,i=C,l=T(!1),u=T(!1),d=()=>{u.value=!u.value},S=()=>{u.value=!1},V=$(()=>[{key:"edit",label:"Edit vehicle",onClick:()=>{i("edit-vehicle"),S()}},{key:"remove",label:"Remove vehicle",onClick:()=>{i("remove-vehicle"),S()}}]),A=$(()=>{const h=[];return a.vehicle.brand&&h.push(a.vehicle.brand),a.vehicle.model&&h.push(a.vehicle.model),a.vehicle.variant&&h.push(a.vehicle.variant),h.join(" ")||"Vehicle Details"}),w=$(()=>{const h=A.value;return a.vehicle.year?`${h} (${a.vehicle.year})`:h}),g=h=>{if(!h)return"0";const c=typeof h=="string"?parseFloat(h):h;return new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).format(c)},y=h=>{if(!h)return"0";const c=typeof h=="string"?parseFloat(h):h;return new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).format(c)},b=()=>{l.value=!0};return(h,c)=>{const x=Ts("click-outside");return f(),k("div",mr,[e("div",fr,[c[1]||(c[1]=e("h3",{class:"text-base font-medium text-foreground leading-6"},"Requested Car",-1)),s.source?(f(),k("p",pr,U(s.source),1)):N("",!0)]),e("div",vr,[e("div",gr,[s.imageUrl&&!l.value?(f(),k("img",{key:0,src:s.imageUrl,alt:`${s.vehicle.brand} ${s.vehicle.model}`,class:"w-full h-full object-cover",onError:b},null,40,yr)):(f(),k("div",br,[n(t(ol),{size:32,class:"text-muted-foreground"})]))]),e("div",hr,[e("p",xr,U(w.value),1),s.vehicle.price?(f(),k("div",wr,[s.vehicle.price?(f(),k("span",kr," €"+U(g(s.vehicle.price)),1)):N("",!0)])):N("",!0),s.vehicle.mileage||s.vehicle.fuelType?(f(),k("div",Sr,[s.vehicle.mileage?(f(),k("span",Cr,U(y(s.vehicle.mileage))+" km",1)):N("",!0),s.vehicle.fuelType?(f(),k("span",$r,U(s.vehicle.fuelType),1)):N("",!0)])):N("",!0)])]),s.requestMessage?(f(),k("div",Dr,[e("p",Ar,' "'+U(s.requestMessage)+'" ',1)])):N("",!0),e("div",Tr,[n(t(J),{variant:"secondary",size:"sm",class:"flex-1",onClick:c[0]||(c[0]=p=>h.$emit("open-ad"))},{default:o(()=>[n(t(Lo),{size:16}),c[2]||(c[2]=e("span",null,"Open Ad",-1))]),_:1}),e("div",Or,[n(t(J),{variant:"secondary",size:"icon-sm",onClick:ln(d,["stop"])},{default:o(()=>[n(t(il),{size:16})]),_:1}),u.value?Se((f(),k("div",Ir,[n(t(vo),{items:V.value,className:"w-48"},null,8,["items"])])),[[x,S]]):N("",!0)])])])}}},Fr={class:"relative flex-1 flex flex-col min-h-0 min-w-0 overflow-hidden"},Lr={key:0,class:"flex flex-col flex-1 min-h-0 min-w-0 overflow-hidden"},Nr={class:"flex flex-1 min-h-0 overflow-hidden"},qr={class:"flex-1 flex flex-col min-h-0 overflow-hidden bg-white min-w-0"},Ur={class:"flex-1 min-h-0 overflow-y-auto"},Pr={class:"p-2"},Mr={class:"right-sidebar flex flex-col min-h-0 overflow-hidden shrink-0 border-l border-border bg-surface"},Rr={key:1,class:"absolute bottom-0 left-0 right-0 h-[2px] bg-primary z-10"},Er={key:1,class:"absolute bottom-0 left-0 right-0 h-[2px] bg-primary z-10"},jr={class:"flex-1 min-h-0 flex flex-col overflow-y-auto bg-muted"},Br={key:1,class:"flex-1 flex items-center justify-center bg-surface"},zr={__name:"TaskDetailView",props:{task:{type:Object,default:null},managementWidget:{type:Object,default:null},storeAdapter:{type:Object,default:null},addNewConfig:{type:Object,default:null},filteredTasks:{type:Array,default:()=>[]},isDrawerView:{type:Boolean,default:!1}},emits:["task-navigate","close","postpone-expected-close"],setup(s,{emit:C}){const a=s,i=C,l=rn(),u=Bt(),d=T("request"),S=T({}),V=T(!1),A=T(!1),w=T(!1),g=T(!1),y=T(!1),b=T(!1),h=T(!1),c=T(!1),x=T(!1),p=T(!1),F=T(null);function R(){i("postpone-expected-close",a.task)}const P=$(()=>{var Z;return a.storeAdapter?((Z=a.storeAdapter.currentActivities)==null?void 0:Z.value)||[]:[]}),z=$(()=>P.value.length),H=$(()=>{var te;if(!((te=a.task)!=null&&te.customer))return 0;const Z=a.task.customer.email,B=a.task.customer.phone,Y=a.task.compositeId||`${a.task.type}-${a.task.id}`;return[...(l.leads||[]).map(le=>({...le,type:"lead",compositeId:`lead-${le.id}`})),...(u.opportunities||[]).map(le=>({...le,type:"opportunity",compositeId:`opportunity-${le.id}`}))].filter(le=>le.compositeId===Y||!le.customer?!1:le.customer.email===Z||le.customer.phone===B).length}),L=()=>{i("task-navigate","previous")},q=()=>{i("task-navigate","next")},K=Z=>{d.value!=="activity"&&(d.value="activity")},_=Z=>{S.value[Z]=!S.value[Z]},Q=Z=>Z&&(Z.image||Z.imageUrl)||"",ue=()=>{},ne=()=>{},E=()=>{},O=Z=>{Z==="note"?V.value=!0:Z==="attachment"?A.value=!0:Z==="whatsapp"?w.value=!0:Z==="sms"?g.value=!0:Z==="email"?y.value=!0:Z==="call"?b.value=!0:Z==="financing"?h.value=!0:Z==="tradein"?c.value=!0:Z==="purchase"?x.value=!0:Z==="appointment"&&(p.value=!0)},G=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"note",content:Z.content||Z.message,message:Z.content||Z.message,timestamp:new Date().toISOString()}),V.value=!1}catch(B){console.error("Error saving note:",B)}};async function De(Z){var B,Y,se,X,te,le,ce,Ce;if(!(!a.storeAdapter||!a.task))try{const Ae=[...a.task.tradeIns||[],Z];a.task.type==="lead"?(await((Y=(B=a.storeAdapter).updateLead)==null?void 0:Y.call(B,a.task.id,{tradeIns:Ae})),await((X=(se=a.storeAdapter).loadLeadById)==null?void 0:X.call(se,a.task.id))):(await((le=(te=a.storeAdapter).updateOpportunity)==null?void 0:le.call(te,a.task.id,{tradeIns:Ae})),await((Ce=(ce=a.storeAdapter).loadOpportunityById)==null?void 0:Ce.call(ce,a.task.id)))}catch(Ae){console.error("Error adding trade-in:",Ae)}}async function be(Z){var B,Y,se,X,te,le,ce,Ce;if(!(!a.storeAdapter||!a.task))try{const Ae=[...a.task.financingOptions||[],Z];a.task.type==="lead"?(await((Y=(B=a.storeAdapter).updateLead)==null?void 0:Y.call(B,a.task.id,{financingOptions:Ae})),await((X=(se=a.storeAdapter).loadLeadById)==null?void 0:X.call(se,a.task.id))):(await((le=(te=a.storeAdapter).updateOpportunity)==null?void 0:le.call(te,a.task.id,{financingOptions:Ae})),await((Ce=(ce=a.storeAdapter).loadOpportunityById)==null?void 0:Ce.call(ce,a.task.id)))}catch(Ae){console.error("Error adding financing option:",Ae)}}const Ne=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"attachment",fileName:Z.fileName,file:Z.file,content:`Attachment: ${Z.fileName}`,timestamp:new Date().toISOString()}),A.value=!1}catch(B){console.error("Error saving attachment:",B)}},ot=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"whatsapp",message:Z.message,content:Z.message,template:Z.template,timestamp:new Date().toISOString()}),w.value=!1}catch(B){console.error("Error saving WhatsApp:",B)}},ze=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"sms",message:Z.message,content:Z.message,template:Z.template,timestamp:new Date().toISOString()}),g.value=!1}catch(B){console.error("Error saving SMS:",B)}},it=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"email",subject:Z.subject,message:Z.message,content:Z.message,template:Z.template,timestamp:new Date().toISOString()}),y.value=!1}catch(B){console.error("Error saving email:",B)}},mt=async Z=>{var B;if(!(!a.storeAdapter||!a.task))try{const Y=Z.type==="FIN"?"Captive Financing":Z.type==="LEA"?"Leasing":Z.type==="LTR"?"Long-Term Rental":Z.type||"Financing",se=((B=Z.fields)==null?void 0:B.duration)??null,X=se?`${Y} ${se} months`:Y;await a.storeAdapter.addActivity(a.task.id,{type:"financing",action:"added a financing proposal",content:Z.successMessage||X,data:{type:Z.type,...Z.fields},timestamp:new Date().toISOString()});const te=se?`${Z.type||"Financing"} ${se} months`:Y||"Financing";await be({id:`fo-${Date.now()}`,label:te,termMonths:se||null}),h.value=!1}catch(Y){console.error("Error saving financing:",Y)}},Ke=async Z=>{var B;if(!(!a.storeAdapter||!a.task))try{const Y=Z.vehicle||{},se=[Y.brand,Y.model].filter(Boolean),X=(se.length?se.join(" ")+(Y.year?` (${Y.year})`:""):"Trade-in")||"Trade-in",te=((B=Z.valuation)==null?void 0:B.tradeInPrice)??0;await a.storeAdapter.addActivity(a.task.id,{type:"tradein",action:"added a trade-in",content:X,data:{vehicle:Z.vehicle,valuation:Z.valuation},timestamp:new Date().toISOString()}),await De({id:`ti-${Date.now()}`,label:X||"Trade-in",valuation:typeof te=="number"?te:parseFloat(te)||0}),c.value=!1}catch(Y){console.error("Error saving trade-in:",Y)}},kt=async Z=>{var B;if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"offer",action:Z.action||"created an offer",content:Z.content||`Offer: €${((B=Z.data)==null?void 0:B.price)||0}`,data:Z.data,timestamp:new Date().toISOString()}),x.value=!1}catch(Y){console.error("Error saving offer:",Y)}},Pt=async Z=>{if(!(!a.storeAdapter||!a.task))try{await a.storeAdapter.addActivity(a.task.id,{type:"appointment",action:"scheduled an appointment",content:`Appointment: ${Z.type||"Meeting"} on ${Z.date||""}`,data:Z,timestamp:new Date().toISOString()}),p.value=!1}catch(B){console.error("Error saving appointment:",B)}},Ft=async Z=>{var B,Y,se,X;if(!(!a.storeAdapter||!a.task))try{const{tags:te}=Z;a.task.type==="lead"?(await((Y=(B=a.storeAdapter).updateLead)==null?void 0:Y.call(B,a.task.id,{tags:te})),a.storeAdapter.loadLeadById&&await a.storeAdapter.loadLeadById(a.task.id)):a.task.type==="opportunity"&&(await((X=(se=a.storeAdapter).updateOpportunity)==null?void 0:X.call(se,a.task.id,{tags:te})),a.storeAdapter.loadOpportunityById&&await a.storeAdapter.loadOpportunityById(a.task.id))}catch(te){console.error("Error updating tag:",te)}},rt=async Z=>{if(!(!a.storeAdapter||!a.task))try{a.task.type==="lead"&&a.storeAdapter.loadLeadById?await a.storeAdapter.loadLeadById(a.task.id):a.task.type==="opportunity"&&a.storeAdapter.loadOpportunityById&&await a.storeAdapter.loadOpportunityById(a.task.id)}catch(B){console.error("Error reloading task after reassignment:",B)}};return(Z,B)=>{var Y,se,X,te,le,ce,Ce,Ae,Ze,Qe,Je,Ge,Pe;return f(),k("div",Fr,[s.task?(f(),k("div",Lr,[n(tr,{task:s.task,"filtered-tasks":s.filteredTasks,"is-drawer-view":s.isDrawerView,onPrevious:L,onNext:q,onClose:B[0]||(B[0]=Ve=>Z.$emit("close")),onPostponeExpectedClose:R,onTagUpdated:Ft,onReassigned:rt},null,8,["task","filtered-tasks","is-drawer-view"]),e("div",Nr,[e("div",qr,[e("div",Ur,[e("div",Pr,[s.managementWidget&&s.storeAdapter?(f(),ee(sr,na({key:0,ref_key:"managementCardRef",ref:F,task:s.task,type:s.task.type,"management-widget":s.managementWidget,activities:P.value},Z.$attrs),null,16,["task","type","management-widget","activities"])):N("",!0)])])]),e("div",Mr,[n(t(yo),{modelValue:d.value,"onUpdate:modelValue":B[3]||(B[3]=Ve=>d.value=Ve),class:"flex flex-col flex-1 min-h-0 overflow-hidden"},{default:o(()=>[n(t(go),{class:"flex shrink-0 border-b border-border bg-white rounded-none w-full relative h-full"},{default:o(()=>[n(t(Pa),{value:"request",class:re(["flex items-center gap-2 text-sm font-medium transition-all relative flex-1 justify-center bg-transparent outline-none h-full",d.value==="request"?"text-foreground":"text-muted-foreground hover:text-muted-foreground"])},{default:o(()=>[B[14]||(B[14]=e("span",null,"Request",-1)),H.value>0?(f(),k("span",{key:0,class:re(["flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full text-xs font-bold leading-none",d.value==="request"?"bg-primary text-white":"bg-gray-200 text-foreground"])},U(H.value),3)):N("",!0),d.value==="request"?(f(),k("span",Rr)):N("",!0)]),_:1},8,["class"]),n(t(Pa),{value:"activity",class:re(["flex items-center gap-2 text-sm font-medium transition-all relative flex-1 justify-center bg-transparent outline-none h-full",d.value==="activity"?"text-foreground":"text-muted-foreground hover:text-muted-foreground"])},{default:o(()=>[B[15]||(B[15]=e("span",null,"Activity",-1)),z.value>0?(f(),k("span",{key:0,class:re(["flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full text-xs font-bold leading-none",d.value==="activity"?"bg-primary text-white":"bg-gray-200 text-foreground"])},U(z.value),3)):N("",!0),d.value==="activity"?(f(),k("span",Er)):N("",!0)]),_:1},8,["class"])]),_:1}),e("div",jr,[n(t(Ma),{value:"request",class:"space-y-2 p-2 mt-0 flex-1 min-h-full"},{default:o(()=>{var Ve,nt;return[n(No,{task:s.task,"task-type":s.task.type,"customer-id":s.task.customerId||((Ve=s.task.customer)==null?void 0:Ve.id),onAction:E},null,8,["task","task-type","customer-id"]),s.task.requestedCar||s.task.vehicle?(f(),ee(Vr,{key:0,vehicle:s.task.requestedCar||s.task.vehicle,"request-message":s.task.requestMessage||((nt=s.task.requestedCar)==null?void 0:nt.requestMessage),source:s.task.source,"image-url":Q(s.task.requestedCar||s.task.vehicle),onOpenAd:ue,onMoreActions:ne},null,8,["vehicle","request-message","source","image-url"])):N("",!0),n(cr,{task:s.task},null,8,["task"]),n(qo,{items:s.task.tradeIns||[],onOpenAdd:B[1]||(B[1]=fe=>c.value=!0)},null,8,["items"]),n(Uo,{items:s.task.financingOptions||[],onOpenAdd:B[2]||(B[2]=fe=>h.value=!0)},null,8,["items"])]}),_:1}),n(t(Ma),{value:"activity",class:"p-2 flex-1 overflow-hidden h-full flex flex-col mt-0"},{default:o(()=>[n(Po,{activities:P.value,"expanded-summaries":S.value,onActivityClick:K,onToggleSummaryExpanded:_,onAddActivity:O},null,8,["activities","expanded-summaries"])]),_:1})])]),_:1},8,["modelValue"])])])])):(f(),k("div",Br,[...B[16]||(B[16]=[tl('<div class="text-center max-w-sm p-8" data-v-fce61bca><div class="w-16 h-16 mx-auto mb-4 rounded-lg bg-muted flex items-center justify-center" data-v-fce61bca><i class="fa-solid fa-tasks text-2xl text-muted-foreground" data-v-fce61bca></i></div><h3 class="text-lg font-bold text-foreground mb-2" data-v-fce61bca>No task selected</h3><p class="text-sm text-muted-foreground" data-v-fce61bca>Select a task from the list to view its details and manage activities</p></div>',1)])])),n(rl,{modal:"",show:V.value,"task-type":((Y=s.task)==null?void 0:Y.type)||"lead","task-id":(se=s.task)==null?void 0:se.id,onSave:G,onClose:B[4]||(B[4]=Ve=>V.value=!1)},null,8,["show","task-type","task-id"]),n(Mo,{modal:"",show:A.value,"task-type":((X=s.task)==null?void 0:X.type)||"lead","task-id":(te=s.task)==null?void 0:te.id,onSave:Ne,onClose:B[5]||(B[5]=Ve=>A.value=!1)},null,8,["show","task-type","task-id"]),n(Ro,{show:w.value,onSave:ot,onClose:B[6]||(B[6]=Ve=>w.value=!1)},null,8,["show"]),n(Eo,{show:g.value,onSave:ze,onClose:B[7]||(B[7]=Ve=>g.value=!1)},null,8,["show"]),n(jo,{show:y.value,onSave:it,onClose:B[8]||(B[8]=Ve=>y.value=!1)},null,8,["show"]),n(oa,{show:b.value,title:"Call Feature",onClose:B[9]||(B[9]=Ve=>b.value=!1)},null,8,["show"]),n(ia,{show:h.value,"task-type":((le=s.task)==null?void 0:le.type)||"lead","task-id":(ce=s.task)==null?void 0:ce.id,onSave:mt,onClose:B[10]||(B[10]=Ve=>h.value=!1)},null,8,["show","task-type","task-id"]),n(ra,{show:c.value,mode:"tradein","task-type":((Ce=s.task)==null?void 0:Ce.type)||"lead","task-id":(Ae=s.task)==null?void 0:Ae.id,onSave:Ke,onClose:B[11]||(B[11]=Ve=>c.value=!1)},null,8,["show","task-type","task-id"]),n(Bo,{show:x.value,"task-type":((Ze=s.task)==null?void 0:Ze.type)||"lead","task-id":(Qe=s.task)==null?void 0:Qe.id,customer:(Je=s.task)==null?void 0:Je.customer,onSave:kt,onClose:B[12]||(B[12]=Ve=>x.value=!1)},null,8,["show","task-type","task-id","customer"]),n(ul,{show:p.value,customer:(Ge=s.task)==null?void 0:Ge.customer,assignee:(Pe=s.task)==null?void 0:Pe.assignee,onCreate:Pt,onCancel:B[13]||(B[13]=Ve=>p.value=!1)},null,8,["show","customer","assignee"])])}}},e0=on(zr,[["__scopeId","data-v-fce61bca"]]),Wr={key:0,class:"fixed top-0 right-0 bottom-0 w-full lg:w-4/5 xl:w-3/4 bg-white z-50 shadow-xl flex flex-col overflow-hidden"},_r={class:"flex-1 min-h-0 flex flex-col overflow-hidden"},Yr={__name:"DrawerContainer",props:{show:{type:Boolean,required:!0}},emits:["close"],setup(s,{emit:C}){const a=C,i=()=>{a("close")};return(l,u)=>(f(),k(pe,null,[n($s,{name:"fade"},{default:o(()=>[s.show?(f(),k("div",{key:0,class:"fixed inset-0 bg-black/50 z-40",onClick:i})):N("",!0)]),_:1}),n($s,{name:"slide-right"},{default:o(()=>[s.show?(f(),k("div",Wr,[e("div",_r,[qt(l.$slots,"default",{},void 0,!0)])])):N("",!0)]),_:3})],64))}},t0=on(Yr,[["__scopeId","data-v-ff23c65a"]]);function fl(s,C={}){const a=Os(),i=$(()=>{const x=typeof s=="function"?s():ws(s);return{lead:x,displayStage:x?hn(x,"lead"):null}}),l=$(()=>i.value.displayStage||"New"),u=$(()=>{const x=i.value;return zo(x)}),d=$(()=>{const x=i.value,p=Wo(x);if(!p)return null;const F=C[p.key];return{...p,handler:F||(()=>{})}}),S=$(()=>{const x=i.value;return _o(x).map(F=>{const R=C[F.key];return{...F,handler:R||(()=>{})}})}),V=$(()=>{const x=i.value;return Yo(x)}),A=$(()=>{const x=i.value;return Ho(x)}),w=$(()=>{const x=i.value;return Qo(x)}),g=$(()=>{const x=i.value;return Go(x)}),y=$(()=>{const p=i.value.lead;return((p==null?void 0:p.contactAttempts)||[]).length||0}),b=$(()=>a.getSetting("maxContactAttempts")),h=$(()=>y.value+1>=b.value),c=$(()=>!0);return{displayStage:l,isClosed:u,primaryAction:d,secondaryActions:S,showLQWidget:V,showDeadlineBanner:A,canPostpone:w,canReassign:c,lqWidgetMode:g,contactAttempts:y,maxContactAttempts:b,shouldShowAutoDisqualifyWarning:h}}function Hr({getLead:s,leadState:C,emit:a}){const i=aa(),l=rn(),u=Jt();async function d(p){var R;const F=s();if(F&&C.canPostpone.value)try{const P=new Date(`${p.date}T${p.time}:00`),z=P.toISOString(),H={nextActionDue:z};if((p.assigneeId||p.teamId)&&(H.assignee=p.assignee||null,H.assigneeId=p.assigneeId||null,H.assigneeType=p.assigneeType||"user",H.teamId=p.teamId||null,H.team=p.team||null),await l.updateLead(F.id,H),p.createAppointment){const L=new Date(P);L.setHours(L.getHours()+1),await l.updateLead(F.id,{scheduledAppointment:{id:Date.now(),title:`Follow-up Call - ${F.customer.name}`,start:z,end:L.toISOString(),type:"Call",assignee:p.assignee||F.assignee,assigneeId:p.assigneeId||F.assigneeId,assigneeType:p.assigneeType||F.assigneeType||"user",teamId:p.teamId||F.teamId,team:p.team||F.team,status:"scheduled"}}),await l.addActivity(F.id,{type:"appointment",user:((R=u.currentUser)==null?void 0:R.name)||"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${$n(P)} at ${ns(P)}`,data:{type:"Call",date:p.date,time:p.time,assignee:p.assignee||F.assignee}})}await l.addActivity(F.id,{type:"note",user:"You",action:"postponed lead qualification task",content:`Task postponed to ${$n(P)} at ${ns(P)}${p.assignee?` and reassigned to ${p.assignee}`:""}`}),await l.fetchLeadById(F.id)}catch(P){console.error("Failed to postpone lead task:",P)}}async function S(p){const F=s();if(F)try{if(await l.updateLead(F.id,{stage:"Validated"}),await l.addActivity(F.id,{type:"note",user:"You",action:"validated lead",content:"Lead has been validated and is ready for follow-up"}),p.scheduleFollowUp&&p.appointmentData){const R=new Date(`${p.appointmentData.date}T${p.appointmentData.time}:00`);await l.scheduleFollowUp(F.id,{dateTime:R.toISOString(),assignee:p.appointmentData.assignee||F.assignee,assigneeId:p.appointmentData.assigneeId||null,assigneeType:p.appointmentData.assigneeType||"user",teamId:p.appointmentData.teamId||null,team:p.appointmentData.team||null}),await l.addActivity(F.id,{type:"appointment",user:"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${$n(R)} at ${ns(R)}`})}await l.fetchLeadById(F.id)}catch(R){console.error("Failed to validate lead:",R)}}async function V(p){var R,P,z;const F=s();if(F)try{if((R=p==null?void 0:p.assignment)!=null&&R.assignee){const L=p.assignment.assignee,q={assignee:L.name||L.label||null,assigneeId:L.id||null,assigneeType:L.type||"user"};L.type==="team"&&(q.teamId=L.id||null,q.team=L.name||null),p.assignment.salesperson&&(q.assignee=p.assignment.salesperson.name||p.assignment.salesperson,q.assigneeId=p.assignment.salesperson.id||null,q.assigneeType="user",q.teamId=L.id||null,q.team=L.name||null),await l.updateLead(F.id,q);const K=((P=p.assignment.salesperson)==null?void 0:P.name)||L.name||"Unassigned";await l.addActivity(F.id,{type:"note",user:((z=u.currentUser)==null?void 0:z.name)||"You",action:"assigned lead",content:`Lead assigned to ${K}${p.assignment.salesperson&&L.name?` (${L.name} team)`:""}`,timestamp:new Date().toISOString()})}const H=await l.convertLeadToOpportunity(F.id);u.canAccessOpportunities()?i.push({path:`/tasks/${H}`,query:{type:"opportunity"}}):i.push("/tasks")}catch(H){console.error("Failed to qualify lead:",H)}}async function A(p){const F=s();if(F)try{const R=F.contactAttempts||[];await l.updateLead(F.id,{contactAttempts:[...R,p],lastContactAttempt:p.timestamp,totalContactAttempts:R.length+1}),await l.addActivity(F.id,{type:"call",user:"You",action:`logged call attempt - ${p.outcome}`,content:p.notes||`Call attempt via ${p.channel}`,data:{outcome:p.outcome,channel:p.channel,duration:p.duration}}),await l.fetchLeadById(F.id)}catch(R){console.error("Failed to log call attempt:",R)}}async function w(p){const F=s();if(F)try{await l.addActivity(F.id,{type:"note",user:"You",action:"added a note",content:p.content||p.text||"",data:p}),await l.fetchLeadById(F.id)}catch(R){console.error("Failed to save note:",R)}}function g(){a("open-purchase-method")}function y(){a("open-trade-in")}async function b(p){var R;const F=s();if(F)try{const P=p.datetime?new Date(p.datetime).toISOString().split("T")[0]+"T"+p.time+":00":`${p.date}T${p.time}:00`,z=new Date(P),H=p.duration||60;z.setMinutes(z.getMinutes()+H);const L={scheduledAppointment:{id:Date.now(),title:`${p.type} - ${F.customer.name}`,start:P,end:z.toISOString(),type:p.type,assignee:p.assignee,assigneeId:p.assigneeId||p.salespersonId||p.teamId,assigneeType:p.assigneeType||(p.salespersonId?"user":"team"),teamId:p.teamId||null,team:p.team||null,salesperson:p.salesperson||null,salespersonId:p.salespersonId||null,status:"scheduled",location:p.location||"",notes:p.notes||""}};(p.assigneeId||p.salespersonId||p.teamId)&&(L.assignee=p.assignee||p.salesperson||p.team,L.assigneeId=p.assigneeId||p.salespersonId||p.teamId,L.assigneeType=p.assigneeType||(p.salespersonId?"user":"team"),p.teamId&&(L.teamId=p.teamId,L.team=p.team)),await l.updateLead(F.id,L),await l.addActivity(F.id,{type:"appointment",user:((R=u.currentUser)==null?void 0:R.name)||"You",action:"scheduled an appointment",content:`${p.type} scheduled for ${$n(new Date(P))} at ${p.time}`,data:{type:p.type,date:p.date||$n(new Date(P)),time:p.time,assignee:p.assignee,assigneeId:p.assigneeId,team:p.team,salesperson:p.salesperson}}),await l.fetchLeadById(F.id)}catch(P){console.error("Failed to schedule appointment:",P)}}async function h(p){const F=s();if(F&&!(C.isClosed.value&&!p.force))try{const R=C.displayStage.value,P=p.reason==="Duplicate"?bs.CLOSED_DUPLICATE:p.category==="Not Interested"?bs.CLOSED_NOT_INTERESTED:bs.CLOSED_INVALID,z=za(R,P);if(z){const{updates:H,activities:L}=z(F,P,p);await l.updateLead(F.id,H);for(const q of L)await l.addActivity(F.id,q)}else{const H=p.reason==="Duplicate";await l.updateLead(F.id,{isDisqualified:!0,disqualifyReason:p.reason,isDuplicate:H,stage:H?"Closed Failed":"Not Valid",status:"Disqualified",scheduledAppointment:null,nextActionDue:null}),await l.addActivity(F.id,{type:"note",user:"You",action:"disqualified lead",content:`Lead disqualified - Category: ${p.category}, Reason: ${p.reason}`})}i.push("/tasks")}catch(R){console.error("Failed to disqualify lead:",R)}}async function c(){const p=s();if(p)try{const F=C.displayStage.value,R=bs.NEW,P=za(F,R);if(P){const{updates:z,activities:H}=P(p);await l.updateLead(p.id,z);for(const L of H)await l.addActivity(p.id,L)}else await l.updateLead(p.id,{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open",status:"Open",nextActionDue:null,scheduledAppointment:null}),await l.addActivity(p.id,{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"});await l.fetchLeadById(p.id)}catch(F){console.error("Failed to reopen lead:",F)}}function x(){const p=s();p&&p.opportunityId&&i.push({path:`/tasks/${p.opportunityId}`,query:{type:"opportunity"}})}return{handlePostponed:d,handleValidated:S,handleQualified:V,handleCallAttemptLogged:A,handleNoteSaved:w,handleOpenPurchaseMethod:g,handleOpenTradeIn:y,handleAppointmentScheduled:b,handleDisqualified:h,handleReopen:c,viewOpportunity:x}}const Qr={key:0,class:"px-4 py-4 flex items-center justify-between shrink-0"},Gr={class:"space-y-6"},pl={__name:"TaskManagementWidget",props:{task:{type:Object,required:!0},containerClass:{type:String,default:""},hideTitle:{type:Boolean,default:!1},hideBorder:{type:Boolean,default:!1}},setup(s){return(C,a)=>s.task?(f(),k("div",{key:0,class:re(["rounded-lg flex flex-col bg-muted",s.containerClass])},[s.hideTitle?N("",!0):(f(),k("div",Qr,[...a[0]||(a[0]=[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-clipboard-check text-foreground"}),e("h2",{class:"text-sm font-medium text-foreground leading-5"},"Manage next steps")],-1)])])),e("div",{class:re(["bg-white rounded-lg p-2 flex flex-col",s.hideBorder?"shadow-none":"shadow-nsc-card"])},[qt(C.$slots,"deadline-banner"),e("div",Gr,[qt(C.$slots,"primary-action"),qt(C.$slots,"task-widgets"),qt(C.$slots,"closed-state"),qt(C.$slots,"secondary-actions")])],2)],2)):N("",!0)}},Jr={class:"flex justify-between items-start mb-3"},Kr={class:"font-bold text-gray-900 text-sm"},Zr={class:"text-xs text-gray-500 mt-0.5"},Xr={class:"flex gap-3 flex-wrap"},vl={__name:"PrimaryActionWidget",props:{action:{type:Object,required:!0},colorScheme:{type:Object,required:!0}},emits:["action-clicked"],setup(s){return(C,a)=>(f(),k("div",{class:re(["rounded-lg p-4 relative transition-all duration-300 border",[s.colorScheme.background,s.colorScheme.border]])},[e("div",Jr,[e("div",null,[e("h4",Kr,U(s.action.title),1),e("p",Zr,U(s.action.description),1)])]),e("div",Xr,[e("button",{onClick:a[0]||(a[0]=i=>C.$emit("action-clicked")),class:re([s.action.buttonClass,"font-medium px-4 py-2 rounded-lg text-xs flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"])},[e("i",{class:re(s.action.icon)},null,2),D(" "+U(s.action.label),1)],2)])],2))}},eu={key:0,class:"flex items-center justify-between gap-2 w-full"},tu={class:"flex items-center gap-2 min-w-0 flex-1"},nu={class:"min-w-0 flex-1"},su={class:"text-sm font-semibold text-foreground truncate leading-tight"},au={class:"font-normal text-muted-foreground"},lu={class:"text-xs text-muted-foreground truncate leading-tight"},ou={class:"flex items-center gap-2 min-w-0 flex-1"},iu={class:"text-sm font-medium text-foreground"},ru=Object.assign({inheritAttrs:!1},{__name:"TaskAssignee",props:{task:{type:Object,required:!0},taskType:{type:String,default:"lead"},readonly:{type:Boolean,default:!1}},emits:["reassigned"],setup(s,{emit:C}){const{t:a}=As(),i=el(),l=s,u=C,d=xn(),S=Jt(),V=rn(),A=Bt(),w=T(!1),g=$(()=>S.currentUser),y=$(()=>!!(l.task.assignee||l.task.owner||l.task.assignedTo)),b=$(()=>{var z;const R=l.task.assignee||l.task.owner||l.task.assignedTo||"Unassigned",P=(z=d.users)==null?void 0:z.find(H=>H.name===R);return{name:R,team:(P==null?void 0:P.team)||l.task.assigneeTeam||l.task.team||"No team",dealership:(P==null?void 0:P.dealership)||l.task.assigneeDealership||"MotorK Dealership",role:(P==null?void 0:P.role)||l.task.assigneeRole||"salesman"}}),h=R=>!R||R==="Unassigned"?"?":R.split(" ").map(P=>P[0]).join("").toUpperCase().substring(0,2),c=R=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[R]||"bg-muted text-muted-foreground",x=async()=>{if(!(!g.value||l.readonly))try{l.taskType==="lead"?await V.updateLead(l.task.id,{assignee:g.value.name,assigneeType:"user",assigneeTeam:g.value.team,assigneeDealership:g.value.dealership,assigneeRole:g.value.role}):l.taskType==="opportunity"&&await A.updateOpportunity(l.task.id,{assignee:g.value.name,assigneeType:"user",assigneeTeam:g.value.team,assigneeDealership:g.value.dealership,assigneeRole:g.value.role}),u("reassigned",g.value)}catch(R){console.error("Error assigning to self:",R)}};async function p(R){if(l.readonly)return;const P={assignee:R.name,assigneeType:R.type,assigneeTeam:R.team??R.name,assigneeDealership:R.dealership,assigneeRole:R.role};R.type==="team"&&(P.teamId=R.id),l.taskType==="lead"?await V.updateLead(l.task.id,P):l.taskType==="opportunity"&&await A.updateOpportunity(l.task.id,P),u("reassigned",R)}function F(R){p(R).catch(P=>console.error("Error assigning:",P)),w.value=!1}return(R,P)=>(f(),k("div",{class:re(["rounded-lg",[y.value?"bg-muted":"bg-blue-50",t(i).class]]),style:nl(y.value?void 0:{borderWidth:"1px",borderStyle:"solid",borderColor:"var(--brand-primary)"})},[e("div",{class:re(["rounded-lg px-3 py-2 shadow-nsc-card flex items-center justify-between gap-2 flex-wrap",y.value?"bg-white border border-border":"bg-transparent"])},[y.value?(f(),k("div",eu,[e("div",tu,[e("div",{class:re(["w-7 h-7 rounded-full flex items-center justify-center font-bold text-xs shrink-0",c(b.value.role)])},U(h(b.value.name)),3),e("div",nu,[e("p",su,[D(U(b.value.name)+" ",1),e("span",au,"• "+U(b.value.team),1)]),e("p",lu,U(b.value.dealership),1)])]),n(t(Cs),{open:w.value,"onUpdate:open":P[0]||(P[0]=z=>w.value=z)},{default:o(()=>[n(t(ks),{"as-child":""},{default:o(()=>[s.readonly?N("",!0):(f(),ee(t(J),{key:0,variant:"ghost",size:"sm",class:"shrink-0 text-xs px-2 py-1"},{default:o(()=>[...P[2]||(P[2]=[D(" Change ",-1)])]),_:1}))]),_:1}),n(t(Ss),{class:"w-auto p-0 border border-border rounded-lg shadow-nsc-card bg-white",side:"bottom",align:"end"},{default:o(()=>[n(Ds,{onSelect:F})]),_:1})]),_:1},8,["open"])])):(f(),k(pe,{key:1},[e("div",ou,[n(t(al),{size:14,class:"shrink-0","aria-hidden":"true","stroke-width":"2",style:{color:"var(--brand-primary)"}}),e("p",iu,U(t(a)("common.assignee.taskUnassigned")),1)]),s.readonly?N("",!0):(f(),ee(t(Ka),{key:0,class:"assignee-button-group flex items-stretch gap-0 rounded-lg overflow-hidden"},{default:o(()=>[n(t(J),{variant:"default",size:"sm",class:"rounded-r-none border-r border-white/20 bg-primary",onClick:x},{default:o(()=>[D(U(t(a)("common.assignee.assignToMe")),1)]),_:1}),n(t(Ja)),n(t(Cs),{open:w.value,"onUpdate:open":P[1]||(P[1]=z=>w.value=z)},{default:o(()=>[n(t(ks),{"as-child":""},{default:o(()=>[n(t(J),{variant:"default",size:"icon-sm",class:"rounded-l-none border-0 bg-primary -ml-px","aria-label":t(a)("common.assignee.assignToSomeone")},{default:o(()=>[n(t(xs),{size:14,"stroke-width":"2","aria-hidden":"true"})]),_:1},8,["aria-label"])]),_:1}),n(t(Ss),{class:"w-auto p-0 border border-border rounded-lg shadow-nsc-card bg-white",side:"bottom",align:"end"},{default:o(()=>[n(Ds,{onSelect:F})]),_:1})]),_:1},8,["open"])]),_:1}))],64))],2)],6))}}),gl=on(ru,[["__scopeId","data-v-98f04dba"]]),Un=(s,C)=>{if(!s||!C)return[];const a=new Date(C).getDay();if(a===0||a===6)return[];const[l,u]=s.split("-"),d=parseInt(u);return l==="team"?du(d,C):l==="user"?uu(d,C,a):[]},uu=(s,C,a)=>{const i={1:{1:["09:00","09:30","10:00","10:30","11:00"],2:["09:00","10:00","11:00","14:00","15:00"],3:["09:00","09:30","10:30","11:00"],4:["09:00","10:00","11:00","14:00","16:00"],5:["09:00","10:00","11:00"]},2:{1:["14:00","14:30","15:00","15:30","16:00"],2:["13:00","14:00","15:00","16:00","17:00"],3:["14:00","15:00","16:00","17:00"],4:["13:00","14:30","15:00","16:00"],5:["14:00","15:00","16:00"]},3:{1:["09:00","10:30","14:00","15:30"],2:["09:30","11:00","14:00","16:00"],3:["10:00","11:30","14:30","16:00"],4:["09:00","11:00","14:00","15:00"],5:["10:00","11:00","14:00","15:00"]},4:{1:["09:00","10:00","11:00","13:00","14:00","15:00","16:00"],2:["09:00","10:30","11:30","14:00","15:00","16:30"],3:["09:30","10:00","11:00","14:00","15:30","16:00"],4:["09:00","10:00","11:30","13:30","15:00","16:00"],5:["09:00","10:00","11:00","14:00","15:00"]}};return(i[s]||i[1])[a]||[]},du=(s,C)=>{const a=new Date(C).getDay(),i=["09:00","09:30","10:00","10:30","11:00","11:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00"];return s===1?a===1||a===4?["09:00","11:00","14:00","16:00"]:["10:00","14:00","15:00"]:s===2?i.filter((l,u)=>u%2===0):i},cu={class:"bg-white rounded-lg p-4 shadow-nsc-card"},mu={class:"space-y-4"},fu={class:"flex items-center gap-3"},pu={class:"flex items-center gap-3"},vu={class:"text-sm font-medium text-foreground"},yl={__name:"AppointmentCommunications",props:{appointment:{type:Object,required:!0},customer:{type:Object,required:!0},salesperson:{type:Object,default:null},team:{type:Object,default:null},dealership:{type:Object,default:null}},emits:["update"],setup(s,{emit:C}){const a=C,i=[{value:"email",label:"via Email"},{value:"sms",label:"via SMS"},{value:"whatsapp",label:"via WhatsApp"}],l=T({immediateConfirmationEnabled:!0,immediateConfirmationChannels:["email"],reminderEnabled:!0,reminderChannels:["email"],salespersonNotification:!0});return ve(l,u=>{var S,V;const d={immediateConfirmation:{enabled:u.immediateConfirmationEnabled,channels:u.immediateConfirmationEnabled&&((S=u.immediateConfirmationChannels)==null?void 0:S.length)>0?u.immediateConfirmationChannels:[]},reminder:{enabled:u.reminderEnabled,channels:u.reminderEnabled&&((V=u.reminderChannels)==null?void 0:V.length)>0?u.reminderChannels:[]},salespersonNotification:{enabled:u.salespersonNotification}};a("update",d)},{deep:!0}),(u,d)=>(f(),k("div",cu,[d[7]||(d[7]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Send confirmations and reminders",-1)),e("div",mu,[e("div",fu,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"immediate-confirmation",modelValue:l.value.immediateConfirmationEnabled,"onUpdate:modelValue":d[0]||(d[0]=S=>l.value.immediateConfirmationEnabled=S)},null,8,["modelValue"]),d[5]||(d[5]=e("span",{class:"text-sm font-medium text-foreground"},"Send immediate confirmation to customer",-1))]),_:1}),l.value.immediateConfirmationEnabled?(f(),ee(t(vt),{key:0,modelValue:l.value.immediateConfirmationChannels,"onUpdate:modelValue":d[1]||(d[1]=S=>l.value.immediateConfirmationChannels=S),items:i,multiple:!0,placeholder:"Select channels",class:"w-48"},null,8,["modelValue"])):N("",!0)]),e("div",pu,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"reminder",modelValue:l.value.reminderEnabled,"onUpdate:modelValue":d[2]||(d[2]=S=>l.value.reminderEnabled=S)},null,8,["modelValue"]),d[6]||(d[6]=e("span",{class:"text-sm font-medium text-foreground"},"Send reminder the day before appointment",-1))]),_:1}),l.value.reminderEnabled?(f(),ee(t(vt),{key:0,modelValue:l.value.reminderChannels,"onUpdate:modelValue":d[3]||(d[3]=S=>l.value.reminderChannels=S),items:i,multiple:!0,placeholder:"Select channels",class:"w-48"},null,8,["modelValue"])):N("",!0)]),n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors"},{default:o(()=>[n(t(Ht),{id:"salesperson-notification",modelValue:l.value.salespersonNotification,"onUpdate:modelValue":d[4]||(d[4]=S=>l.value.salespersonNotification=S)},null,8,["modelValue"]),e("span",vu," Notify "+U(s.salesperson?s.salesperson.name:s.team?s.team.name:"salesperson")+" about appointment ",1)]),_:1})]),qt(u.$slots,"actions")]))}},gu={class:"space-y-4"},yu={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},bu={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},hu={class:"grid grid-cols-2 gap-4"},xu={class:"flex items-center gap-2"},wu={class:"text-muted-foreground"},ku={class:"font-medium text-foreground"},Su={class:"flex items-center gap-2"},Cu={class:"font-medium text-foreground"},$u={key:1,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Du={class:"bg-white border border-border rounded-lg overflow-hidden"},Au={class:"grid grid-cols-1 md:grid-cols-2 divide-x divide-black/5"},Tu={class:"p-6"},Ou={class:"flex items-center justify-between mb-4"},Iu={class:"text-sm font-semibold text-foreground"},Vu={class:"grid grid-cols-7 gap-1 mb-2"},Fu={class:"grid grid-cols-7 gap-1"},Lu=["onClick"],Nu={class:"p-6"},qu={class:"text-sm font-semibold text-foreground mb-4"},Uu={key:0,class:"space-y-2"},Pu=["onClick"],Mu={key:1,class:"text-sm text-muted-foreground py-4 text-center"},Ru={key:2,class:"text-sm text-muted-foreground py-4 text-center"},Eu={class:"flex justify-end gap-2 px-4 pb-4 pt-3"},ls={__name:"OpportunityScheduleForm",props:{opportunity:{type:Object,required:!0},mode:{type:String,validator:s=>["schedule","reschedule"].includes(s),default:"schedule"},initialAppointment:{type:Object,default:null}},emits:["submit","cancel"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=xn(),d=T(""),S=T(null),V=T(""),A=T(null),w=T(null),g=T(null),y=T(""),b=T(new Date().getMonth()),h=T(new Date().getFullYear()),c=T({immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}),x=[{value:"appointment-on-phone",label:"Appointment on the phone (15m)"},{value:"appointment-at-dealership",label:"Appointment at the dealership (30m)"},{value:"recall-internal",label:"Recall - internal (15m)"},{value:"appointment-at-dealership-test-drive",label:"Appointment at the dealership + Test drive (1h)"},{value:"appointment-at-workshop",label:"Appointment at the workshop (15m)"},{value:"appointment-at-customer-site",label:"Appointment at customer's site (1h 40m)"},{value:"appointment-at-customer-site-test-drive",label:"Appointment at customer's site + Test drive (5h)"}],p={"appointment-on-phone":15,"appointment-at-dealership":30,"recall-internal":15,"appointment-at-dealership-test-drive":60,"appointment-at-workshop":15,"appointment-at-customer-site":100,"appointment-at-customer-site-test-drive":300},F=$(()=>x.map(B=>({value:B.value,label:B.label}))),R=$(()=>{const B=[];for(let Y=9*60;Y<=18*60;Y+=30){const se=String(Math.floor(Y/60)).padStart(2,"0"),X=String(Y%60).padStart(2,"0");B.push(`${se}:${X}`)}return B}),P=$(()=>{if(g.value!=null)return g.value;const B=parseInt(y.value,10);return Number.isFinite(B)&&B>0?B:null}),z=$(()=>i.mode==="reschedule"?"Reschedule and Save":"Schedule and Save"),H=$(()=>!!(d.value&&S.value&&V.value&&A.value)),L=["MON","TUE","WED","THU","FRI","SAT","SUN"],q=$(()=>new Date(h.value,b.value).toLocaleDateString("en-US",{month:"long",year:"numeric"})),K=$(()=>{const B=new Date(h.value,b.value,1),se=new Date(h.value,b.value+1,0).getDate(),X=B.getDay()===0?6:B.getDay()-1,te=[];for(let le=0;le<X;le++)te.push(null);for(let le=1;le<=se;le++)te.push(le);return te}),_=$(()=>{if(!S.value)return"Select a date";const B=S.value,Y=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],se=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${Y[B.getDay()]}, ${se[B.getMonth()]} ${B.getDate()}`}),Q=$(()=>u.assignableUsers),ue=$(()=>u.assignableTeams),ne=$(()=>ue.value.map(B=>({...B,label:`${B.dealership||"No location"} → ${B.name}`,value:B.id}))),E=$(()=>{var se;if(!A.value)return[];const B=A.value;return(((se=Q.value)==null?void 0:se.filter(X=>X.team===B.name||X.teamId===B.id))||[]).map(X=>({...X,label:X.name,value:X.id}))}),O=$({get:()=>{var B;return((B=A.value)==null?void 0:B.id)||null},set:B=>{var se;if(!B){A.value=null,w.value=null;return}const Y=(se=ue.value)==null?void 0:se.find(X=>X.id===B);A.value=Y||null,Y&&Ke(`team-${Y.id}`)}}),G=$({get:()=>{var B;return((B=w.value)==null?void 0:B.id)||null},set:B=>{if(!B){w.value=null;return}const Y=E.value.find(se=>se.id===B);w.value=Y||null,Y&&Ke(`user-${Y.id}`)}}),De=$(()=>{if(!S.value)return[];const B=S.value.toISOString().split("T")[0];if(w.value){const Y=Un(`user-${w.value.id}`,B);return R.value.filter(se=>Y.includes(se))}if(A.value){const Y=Un(`team-${A.value.id}`,B);return R.value.filter(se=>Y.includes(se))}return R.value||[]});function be(B){return B?B.split(" ").map(Y=>Y[0]).join("").toUpperCase().substring(0,2):"?"}function Ne(B){return{manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"}[B]||"bg-muted text-muted-foreground"}function ot(B){if(!B)return;const Y=new Date(h.value,b.value,B);S.value=Y,V.value=""}function ze(B){if(!B||!S.value)return!1;const Y=S.value;return Y.getDate()===B&&Y.getMonth()===b.value&&Y.getFullYear()===h.value}function it(){b.value===0?(b.value=11,h.value--):b.value--}function mt(){b.value===11?(b.value=0,h.value++):b.value++}function Ke(B){const Y=new Date;Y.setHours(0,0,0,0);for(let se=0;se<30;se++){const X=new Date(Y);if(X.setDate(Y.getDate()+se),X.getDay()===0||X.getDay()===6)continue;const te=X.toISOString().split("T")[0],le=Un(B,te);if(le!=null&&le.length){S.value=X,b.value=X.getMonth(),h.value=X.getFullYear();const ce=R.value.filter(Ce=>le.includes(Ce));ce.length&&(V.value=ce[0]);break}}}function kt(B){c.value=B}function Pt(){Ft(),l("cancel")}function Ft(){d.value="",S.value=null,V.value="",A.value=null,w.value=null,g.value=null,y.value="",c.value={immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}}function rt(B){var Y,se,X;if(B){if(d.value=B.type||"",B.assignee){const te=(Y=Q.value)==null?void 0:Y.find(ce=>ce.name===B.assignee),le=(se=ue.value)==null?void 0:se.find(ce=>ce.name===B.assignee);if(te){const ce=(X=ue.value)==null?void 0:X.find(Ce=>Ce.name===te.team||Ce.id===te.teamId);ce&&(A.value=ce,w.value=te)}else le&&(A.value=le)}if(B.start){const te=new Date(B.start),le=new Date(te.getFullYear(),te.getMonth(),te.getDate());S.value=le,b.value=te.getMonth(),h.value=te.getFullYear();const ce=te.getHours(),Ce=te.getMinutes(),Ae=Ce<15?0:Ce<45?30:60,Ze=Ae===60?ce+1:ce,Qe=Ae===60?0:Ae,Je=`${String(Ze).padStart(2,"0")}:${String(Qe).padStart(2,"0")}`;if(R.value.includes(Je))V.value=Je;else{const Ge=Ze*60+Qe,Pe=R.value.reduce((Ve,nt)=>{const[fe,me]=nt.split(":").map(Number),ye=fe*60+me;if(!Ve)return nt;const[xe,ke]=Ve.split(":").map(Number),Me=xe*60+ke;return Math.abs(ye-Ge)<Math.abs(Me-Ge)?nt:Ve},null);V.value=Pe||R.value[0]||""}}if(B.duration){const te=B.duration;te===15?g.value=15:te===30?g.value=30:te===60?g.value=60:(g.value=null,y.value=String(te))}}}ve(d,B=>{if(!B)return;const Y=p[B];if(Y&&(Y===15?g.value=15:Y===30?g.value=30:Y===60?g.value=60:(g.value=null,y.value=String(Y)),!S.value)){const se=new Date;se.setHours(0,0,0,0),S.value=se,b.value=se.getMonth(),h.value=se.getFullYear()}}),ve(S,()=>{V.value=""}),ve(()=>i.opportunity.assignee,B=>{var X,te,le;if(!B||A.value||w.value)return;const Y=(X=Q.value)==null?void 0:X.find(ce=>ce.name===B),se=(te=ue.value)==null?void 0:te.find(ce=>ce.name===B);if(Y){const ce=(le=ue.value)==null?void 0:le.find(Ce=>Ce.name===Y.team||Ce.id===Y.teamId);ce&&(A.value=ce,w.value=Y)}else se&&(A.value=se)},{immediate:!0}),Mn(()=>{i.mode==="reschedule"&&i.initialAppointment&&rt(i.initialAppointment)});function Z(){H.value&&l("submit",{eventType:d.value,selectedDate:S.value,selectedSlot:V.value,selectedTeam:A.value,selectedSalesman:w.value,durationValue:P.value,communicationPreferences:c.value})}return C({resetForm:Ft}),(B,Y)=>{var se;return f(),k("div",gu,[e("div",yu,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...Y[3]||(Y[3]=[D("Event type ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(vt),{modelValue:d.value,"onUpdate:modelValue":Y[0]||(Y[0]=X=>d.value=X),items:F.value,placeholder:"Select event type...","value-key":"value",class:"w-full"},{item:o(({item:X})=>[e("span",null,U(X.label),1)]),_:1},8,["modelValue","items"])]),d.value?(f(),k("div",bu,[Y[7]||(Y[7]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",hu,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...Y[4]||(Y[4]=[D("Team",-1)])]),_:1}),n(t(vt),{modelValue:O.value,"onUpdate:modelValue":Y[1]||(Y[1]=X=>O.value=X),items:ne.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:X})=>[e("div",xu,[e("span",wu,U(X.dealership||"No location"),1),Y[5]||(Y[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",ku,U(X.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...Y[6]||(Y[6]=[D("Salesperson (optional)",-1)])]),_:1}),n(t(vt),{modelValue:G.value,"onUpdate:modelValue":Y[2]||(Y[2]=X=>G.value=X),items:E.value,disabled:!A.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:X})=>[e("div",Su,[e("div",{class:re(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",Ne(X.role)])},U(be(X.name)),3),e("span",Cu,U(X.name),1)])]),_:1},8,["modelValue","items","disabled"])])])])):N("",!0),d.value&&A.value?(f(),k("div",$u,[Y[10]||(Y[10]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},[D("Schedule "),e("span",{class:"text-red-600"},"*")],-1)),e("div",Du,[e("div",Au,[e("div",Tu,[e("div",Ou,[e("button",{type:"button",onClick:it,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...Y[8]||(Y[8]=[e("i",{class:"fa-solid fa-chevron-left text-sm text-muted-foreground"},null,-1)])]),e("h6",Iu,U(q.value),1),e("button",{type:"button",onClick:mt,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...Y[9]||(Y[9]=[e("i",{class:"fa-solid fa-chevron-right text-sm text-muted-foreground"},null,-1)])])]),e("div",Vu,[(f(),k(pe,null,Ie(L,X=>e("div",{key:X,class:"text-center text-xs font-semibold text-muted-foreground py-1"},U(X),1)),64))]),e("div",Fu,[(f(!0),k(pe,null,Ie(K.value,(X,te)=>(f(),k("div",{key:te,onClick:le=>X&&ot(X),class:re(["aspect-square flex items-center justify-center text-sm font-medium rounded-lg transition-all",ze(X)?"bg-primary text-white cursor-pointer":X?"text-muted-foreground hover:bg-muted cursor-pointer":"text-transparent"])},U(X),11,Lu))),128))])]),e("div",Nu,[e("h6",qu,U(_.value),1),S.value&&De.value.length>0?(f(),k("div",Uu,[(f(!0),k(pe,null,Ie(De.value,X=>(f(),k("button",{key:X,type:"button",onClick:te=>V.value=X,class:re(["w-full py-2 px-4 border-2 rounded-lg text-sm font-medium transition-all cursor-pointer",V.value===X?"border-primary bg-muted text-foreground":"border-border text-muted-foreground hover:border-primary/30"])},U(X),11,Pu))),128))])):S.value&&De.value.length===0?(f(),k("div",Mu," No available time slots for this date ")):(f(),k("div",Ru," Select a date to see available time slots "))])])])])):N("",!0),d.value&&A.value?(f(),ee(yl,{key:2,appointment:{type:d.value,date:S.value,time:V.value,duration:P.value},customer:s.opportunity.customer,salesperson:w.value,team:A.value,dealership:(se=A.value)!=null&&se.dealership?{name:A.value.dealership}:null,onUpdate:kt},null,8,["appointment","customer","salesperson","team","dealership"])):N("",!0),e("div",Eu,[n(t(J),{variant:"secondary",onClick:Pt},{default:o(()=>[...Y[11]||(Y[11]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!H.value,onClick:Z},{default:o(()=>[D(U(z.value),1)]),_:1},8,["disabled"])])])}}},ju={class:"flex-1 overflow-y-auto px-4 py-4 w-full"},Bu={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},zu={class:"p-6"},Wu={__name:"ScheduleAppointmentModal",props:{show:{type:Boolean,required:!0},opportunity:{type:Object,required:!1,default:null},lead:{type:Object,required:!1,default:null},mode:{type:String,validator:s=>["schedule","reschedule"].includes(s),default:"schedule"},initialAppointment:{type:Object,default:null},preselectedAssignee:{type:String,default:null}},emits:["submit","cancel","confirm","close"],setup(s,{emit:C}){const a=s,i=C,l=T(0);ve(()=>a.show,V=>{V&&(l.value+=1)});const u=V=>{V||S()},d=V=>{i("submit",V),i("confirm",V)},S=()=>{i("cancel"),i("close")};return(V,A)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":u},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-4xl max-h-[calc(100vh-4rem)] flex flex-col bg-muted"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...A[0]||(A[0]=[D("Schedule Appointment",-1)])]),_:1})]),_:1}),e("div",ju,[e("div",Bu,[e("div",zu,[s.opportunity||s.lead?(f(),ee(ls,{key:l.value,opportunity:s.opportunity||s.lead,mode:s.mode,"initial-appointment":s.initialAppointment,onSubmit:d,onCancel:S},null,8,["opportunity","mode","initial-appointment"])):N("",!0)])])])]),_:1})]),_:1})]),_:1},8,["open"]))}};function bl(){const s=wo(),C=T(!1),a=T(!1),i=T(0),l=T(""),u=T(null),d=T({}),S=T(null),V={leadLines:["Yes, this is Josh Adams speaking.","Oh, hi Michael! Yes, I was waiting for your call.","That sounds great. I'm definitely interested in seeing it."],salesLines:["Hi Josh, Michael here regarding your Audi A6 inquiry.","Great. I see you're interested in the Allroad. Do you have a vehicle you'd like to trade in?"]},A=$(()=>{const c=Math.floor(i.value/60),x=i.value%60;return`${c.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`}),w=()=>{C.value=!0,i.value=0,a.value=!1,l.value="",u.value=setInterval(()=>{i.value++,i.value>=20&&g()},1e3)},g=()=>{u.value&&(clearInterval(u.value),u.value=null),C.value=!1,a.value=!0,d.value={duration:i.value,notes:l.value,transcription:V,channel:"phone"}},y=async c=>{try{await navigator.clipboard.writeText(c),s.pushToast("success","Phone number copied to clipboard!")}catch{s.pushToast("error","Failed to copy phone number")}},b=c=>(S.value={tradeIn:V.leadLines.some(x=>x.toLowerCase().includes("trade")||x.toLowerCase().includes("exchange"))||!1,financing:V.leadLines.some(x=>x.toLowerCase().includes("financ")||x.toLowerCase().includes("payment")||x.toLowerCase().includes("loan"))||!1},S.value.tradeIn&&c&&(c.value.tradeIn=!0),S.value.financing&&c&&(c.value.financing=!0),S.value),h=()=>{C.value=!1,a.value=!1,i.value=0,l.value="",d.value={},u.value&&(clearInterval(u.value),u.value=null)};return sl(()=>{u.value&&clearInterval(u.value)}),{isCallActive:C,callEnded:a,callDuration:i,callNotes:l,callData:d,extractedData:S,mockTranscription:V,formattedCallDuration:A,startCall:w,endCall:g,copyNumber:y,extractInformation:b,resetCall:h}}function _u(s,C,a,i,l,u){var Pe,Ve,nt;const d=T(!0),S=T(null),V=T(!1),A=T(!1),w=T(!1),g=T(""),y=T(null),b=[{value:"whatsapp",label:"WhatsApp"},{value:"sms",label:"SMS"},{value:"email",label:"Email"},{value:"dont-send",label:"Don't send"}],h=T("whatsapp"),c=T("followup-1"),x=T(null),p=T(""),F=T("09:00"),R=T(null),P=T("Not Interested"),z=T(""),H=T({dealership:((Ve=(Pe=s.value)==null?void 0:Pe.requestedCar)==null?void 0:Ve.dealership)||"Barcelona",team:"Audi Sales (New)",assigneeId:((nt=u==null?void 0:u.value)==null?void 0:nt.id)||null}),L=T(null),q=T(null),K=T({immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}),_=$(()=>{var me,ye;if(!((me=s.value)!=null&&me.requestedCar))return null;const fe=(ye=s.value.requestedCar.condition)==null?void 0:ye.toLowerCase();return fe==="used"?{id:7,name:"Sales (Used)",dealershipId:2,dealership:"Firenze"}:fe==="new"?{id:5,name:"Sales (New)",dealershipId:3,dealership:"Milano"}:null}),Q=T({tradeIn:!1,financing:!1,contactAvailability:!1}),ue=T(!1),ne=T(null),E=T(!0),O=T(null),G=T(null),De=T("assign-and-schedule"),be=T(""),Ne=T(null),ot=T(""),ze=T(null),it=T(""),mt=T(""),Ke=T(null),kt=T(""),Pt=fe=>{kt.value=fe},Ft=$(()=>{const fe=[];for(let me=9*60;me<=18*60;me+=30){const ye=String(Math.floor(me/60)).padStart(2,"0"),xe=String(me%60).padStart(2,"0");fe.push(`${ye}:${xe}`)}return fe}),rt=$(()=>{if(Ne.value!=null)return Ne.value;const fe=parseInt(ot.value,10);return Number.isFinite(fe)&&fe>0?fe:null}),Z=$(()=>{if(!ze.value)return[];const fe=[],me=new Date;if(me.setHours(0,0,0,0),ze.value==="tomorrow"){const ye=new Date(me);ye.setDate(ye.getDate()+1),ye.getDay()!==0&&ye.getDay()!==6&&fe.push(ye)}else if(ze.value==="this-week"){const ye=me.getDay(),xe=new Date(me);xe.setDate(me.getDate()-(ye===0?6:ye-1));for(let ke=0;ke<5;ke++){const Me=new Date(xe);Me.setDate(xe.getDate()+ke),Me>=me&&fe.push(Me)}}else if(ze.value==="custom"&&it.value&&mt.value){const ye=new Date(it.value),xe=new Date(mt.value),ke=new Date(ye);for(;ke<=xe;)ke.getDay()!==0&&ke.getDay()!==6&&fe.push(new Date(ke)),ke.setDate(ke.getDate()+1)}return fe}),B=$(()=>{var xe,ke,Me,ut,St,Te,qe;const fe=((Me=(ke=(xe=s.value)==null?void 0:xe.customer)==null?void 0:ke.name)==null?void 0:Me.split(" ")[0])||"",me=((St=(ut=s.value)==null?void 0:ut.requestedCar)==null?void 0:St.brand)||"",ye=((qe=(Te=s.value)==null?void 0:Te.requestedCar)==null?void 0:qe.model)||"";return{"followup-1":`Hi ${fe}! I tried calling you earlier but couldn't reach you. When would be a good time to discuss the ${me} ${ye}?`,"followup-2":`Hello ${fe}, this is regarding your inquiry about the ${me} ${ye}. Please let me know when you're available for a call.`,custom:""}}),Y=$(()=>c.value==="custom"?"Type your custom message...":B.value[c.value]||""),se=$(()=>{var fe;return!!((fe=s.value)!=null&&fe.scheduledAppointment)}),X=()=>{const fe=new Date,me=fe.getHours(),ye=fe.getDay();let xe=new Date,ke="10:00",Me="";if(ye===5&&me>=15)xe.setDate(fe.getDate()+3),ke="10:00",Me="Optimal time after weekend, customer likely refreshed";else if(ye===6||ye===0)xe.setDate(fe.getDate()+(ye===6?2:1)),ke="10:00",Me="Weekend follow-up avoided, better response rate on weekdays";else if(me>=17)xe.setDate(fe.getDate()+1),ke="10:00",Me="Business hours preferred, higher engagement rate";else if(me<9)xe=new Date(fe),xe.setHours(10,0,0,0),ke="10:00",Me="Peak response time, customers more available mid-morning";else if(me<14){xe=new Date(fe);const Te=me+2;xe.setHours(Te,0,0,0),ke=`${String(Te).padStart(2,"0")}:00`,Me="Follow-up within same day increases conversion likelihood"}else xe.setDate(fe.getDate()+1),xe.setHours(10,0,0,0),ke="10:00",Me="Next morning follow-up maintains momentum";const ut=xe.toISOString().split("T")[0],St=`${ut}T${ke}:00`;return{date:ut,time:ke,dateTime:St,reason:Me,formattedDate:xe.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}};return{showOutcomeSelection:d,selectedOutcome:S,showNoteModal:V,showScheduleAppointmentModal:A,followupChannels:b,followupChannel:h,selectedTemplate:c,rescheduleTime:x,customDate:p,customTime:F,disqualifyCategory:P,disqualifyReason:z,assignment:H,preferences:Q,surveyCompleted:ue,surveyResponses:ne,showSurvey:E,aiSuggestionData:R,showCallLogForm:w,callLogDateTime:g,callLogAssignee:y,qualificationSelectedTeam:L,qualificationSelectedSalesman:q,suggestedTeam:_,communicationPreferences:K,messageTemplates:B,messagePreview:Y,hasExistingAppointment:se,selectOutcome:fe=>{if(S.value=fe,!g.value){const me=new Date,ye=me.getFullYear(),xe=String(me.getMonth()+1).padStart(2,"0"),ke=String(me.getDate()).padStart(2,"0"),Me=String(me.getHours()).padStart(2,"0"),ut=String(me.getMinutes()).padStart(2,"0");g.value=`${ye}-${xe}-${ke}T${Me}:${ut}`}!y.value&&(u!=null&&u.value)&&(y.value=u.value),fe==="interested"&&(ue.value=!1,ne.value=null,E.value=!0,a!=null&&a.value&&(Q.value.tradeIn=a.value.tradeIn||!1,Q.value.financing=a.value.financing||!1))},cancelOutcome:()=>{S.value=null,w.value=!1},calculateNextCallDate:()=>{if(x.value==="tomorrow-9am"){const me=new Date;return me.setDate(me.getDate()+1),me.setHours(9,0,0,0),me.toISOString()}else if(x.value==="monday"){if(R.value)return new Date(R.value.dateTime).toISOString();const me=new Date,ye=(8-me.getDay())%7||7;return me.setDate(me.getDate()+ye),me.setHours(9,0,0,0),me.toISOString()}else if(x.value==="custom"&&p.value&&F.value)return new Date(`${p.value}T${F.value}:00`).toISOString();const fe=new Date;return fe.setDate(fe.getDate()+1),fe.setHours(9,0,0,0),fe.toISOString()},calculateAISuggestion:X,handleAISuggestionClick:()=>{x.value="monday",R.value=X()},resetOutcomeState:()=>{S.value=null,d.value=!0,h.value="whatsapp",c.value="followup-1",x.value=null,p.value="",F.value="09:00",P.value="Not Interested",z.value="",ue.value=!1,ne.value=null,E.value=!0,R.value=null,w.value=!1,g.value="",y.value=null,O.value=null,G.value=null,De.value="assign-only",be.value="",ze.value=null,it.value="",mt.value="",Ke.value=null,kt.value="",L.value=null,q.value=null,Ne.value=null,ot.value=""},initCallLogForm:(fe=!1)=>{if(O.value)return;const me=new Date,ye=me.getFullYear(),xe=String(me.getMonth()+1).padStart(2,"0"),ke=String(me.getDate()).padStart(2,"0"),Me=String(me.getHours()).padStart(2,"0"),ut=String(me.getMinutes()).padStart(2,"0");g.value=`${ye}-${xe}-${ke}T${Me}:${ut}`,u!=null&&u.value&&(y.value=u.value),w.value=!0},confirmCallLogForm:()=>{},cancelCallLogForm:()=>{w.value=!1,g.value="",y.value=null},clearSuccessState:()=>{O.value=null,G.value=null},successState:O,successPerformedAt:G,qualificationMethod:De,qualificationEventType:be,qualificationDurationMinutes:Ne,qualificationCustomDuration:ot,qualificationDateRange:ze,qualificationCustomDateStart:it,qualificationCustomDateEnd:mt,availableDatesForRange:Z,qualificationSelectedDate:Ke,qualificationSelectedSlot:kt,setQualificationSelectedSlot:Pt,qualificationScheduleSlotOptions:Ft,qualificationDurationValue:rt}}function Yu(s,C,a,i,l,u,d,S,V=null){const{callData:A}=C,{showOutcomeSelection:w,selectedOutcome:g,assignment:y,preferences:b,cancelOutcome:h,calculateNextCallDate:c,showScheduleAppointmentModal:x,surveyCompleted:p,surveyResponses:F,showSurvey:R,initCallLogForm:P,callLogDateTime:z,callLogAssignee:H,successState:L,successPerformedAt:q,rescheduleTime:K,aiSuggestionData:_,customDate:Q,customTime:ue,qualificationMethod:ne,qualificationEventType:E,qualificationDurationValue:O,qualificationSelectedDate:G,qualificationSelectedSlot:De,qualificationSelectedTeam:be,qualificationSelectedSalesman:Ne,communicationPreferences:ot}=a,ze=()=>{var te;return((te=S==null?void 0:S.value)==null?void 0:te.name)||"Unknown"},it=()=>K.value==="tomorrow-9am"?"Tomorrow 9:00 AM":K.value==="monday"&&_.value?`${_.value.formattedDate} at ${_.value.time}`:K.value==="monday"?"Monday":K.value==="custom"&&Q.value&&ue.value?`${Q.value} ${ue.value}`:"selected time";return{logManualCall:()=>{A.value={channel:"external",notes:"",transcription:null},P(!0)},handleScheduleAppointmentConfirm:async te=>{x.value=!1,s("appointment-scheduled",te)},handleQualify:async()=>{var Ge,Pe,Ve,nt,fe,me,ye,xe,ke,Me,ut,St,Te,qe,$e,Xe,zt,Kt,pt,_e,un,st,We,dn,cn;const te={timestamp:new Date().toISOString(),outcome:"interested",channel:((Ge=A.value)==null?void 0:Ge.channel)||"phone",notes:((Pe=A.value)==null?void 0:Pe.notes)||"",transcription:((Ve=A.value)==null?void 0:Ve.transcription)||null};s("call-attempt-logged",te),s("validated",{scheduleFollowUp:!1});let le="Unassigned";ne.value==="assign-and-schedule"?Ne.value?le=Ne.value.name:be.value&&(le=be.value.name):le=((fe=(nt=y.value)==null?void 0:nt.assignee)==null?void 0:fe.name)||"Unassigned";let ce=null,Ce=!1,Ae=null;if(ne.value==="assign-and-schedule"&&G.value&&De.value){const dt=G.value,Ye=dt.toLocaleDateString(void 0,{month:"long",day:"numeric"}),et={"test-drive":"Test Drive","in-store-visit":"In-Store Visit"}[E.value]||E.value;Ce=!0;const Zt=dt.getFullYear(),at=String(dt.getMonth()+1).padStart(2,"0"),Rn=String(dt.getDate()).padStart(2,"0"),os=`${Zt}-${at}-${Rn}`;if(Ae={datetime:dt,date:os,time:De.value,type:et,assignee:le,assigneeId:((me=Ne.value)==null?void 0:me.id)||((ye=be.value)==null?void 0:ye.id)||null,assigneeType:Ne.value?"user":"team",duration:O.value,team:((xe=be.value)==null?void 0:xe.name)||null,teamId:((ke=be.value)==null?void 0:ke.id)||null,salesperson:((Me=Ne.value)==null?void 0:Me.name)||null,salespersonId:((ut=Ne.value)==null?void 0:ut.id)||null},ce={date:Ye,time:De.value,title:et,name:((Te=(St=i.value)==null?void 0:St.customer)==null?void 0:Te.name)||"",location:le},s("appointment-scheduled",Ae),ot.value){const gt=ot.value;if((qe=gt.immediateConfirmation)!=null&&qe.enabled&&((Xe=($e=gt.immediateConfirmation)==null?void 0:$e.channels)==null?void 0:Xe.length)>0){for(const ft of gt.immediateConfirmation.channels)if(d&&((zt=i.value)!=null&&zt.id))try{await d.addActivity(i.value.id,{type:ft,user:ze(),action:`sent ${ft} confirmation`,content:`Appointment confirmed: ${et} on ${Ye} at ${De.value}`,timestamp:new Date().toISOString()})}catch(Mt){console.error(`Failed to log ${ft} confirmation:`,Mt)}}if((Kt=gt.reminder)!=null&&Kt.enabled&&((_e=(pt=gt.reminder)==null?void 0:pt.channels)==null?void 0:_e.length)>0){const ft=new Date(dt);ft.setDate(ft.getDate()-1);const Mt=ft.toISOString().split("T")[0];if(d&&((un=i.value)!=null&&un.id))try{await d.addActivity(i.value.id,{type:"reminder-scheduled",user:ze(),action:"scheduled reminder",content:`Reminder scheduled for ${Mt} via ${gt.reminder.channels.join(", ")}`,timestamp:new Date().toISOString(),data:{reminderDate:Mt,channels:gt.reminder.channels}})}catch(Re){console.error("Failed to schedule reminder:",Re)}}if((st=gt.salespersonNotification)!=null&&st.enabled){const ft=((We=Ne.value)==null?void 0:We.name)||((dn=be.value)==null?void 0:dn.name)||"Team";if(d&&((cn=i.value)!=null&&cn.id))try{await d.addActivity(i.value.id,{type:"notification",user:ze(),action:"sent notification",content:`Notification sent to ${ft} about appointment`,timestamp:new Date().toISOString()})}catch(Mt){console.error("Failed to send notification:",Mt)}}}}ne.value==="assign-and-schedule"&&(Ne.value?y.value={...y.value,assignee:{...Ne.value,type:"user"},assigneeId:Ne.value.id,salesperson:Ne.value}:be.value&&(y.value={...y.value,assignee:{...be.value,type:"team"},team:be.value}));const Ze=ne.value==="assign-and-schedule"?{assignee:Ne.value||be.value,salesperson:Ne.value||null,team:be.value||null}:y.value;let Qe=null;if(V!=null&&V.value){const dt=V.value;Qe={interestLevel:dt.interestLevel,purchaseTimeline:dt.purchaseTimeline,budgetRange:dt.budgetRange,hasTradeIn:dt.hasTradeIn,tradeInModel:dt.tradeInModel,financingOption:dt.financingOption,additionalNotes:dt.additionalNotes}}else p.value&&F.value&&(Qe=F.value);s("qualified",{assignment:Ze,preferences:b.value,scheduleAppointment:Ce,appointmentData:Ae,surveyData:Qe});let Je=`Qualified - Assigned to ${le}`;ce&&(Je=`Qualified - Assigned to ${le}, meeting on ${ce.date} ${ce.time}`),L.value={kind:"qualified",statusText:Je,meeting:ce,actorName:ze()},q.value=new Date,h()},handleDisqualifyFromInterested:()=>{var le,ce,Ce;const te={timestamp:new Date().toISOString(),outcome:"interested",channel:((le=A.value)==null?void 0:le.channel)||"phone",notes:((ce=A.value)==null?void 0:ce.notes)||"",transcription:((Ce=A.value)==null?void 0:Ce.transcription)||null};s("call-attempt-logged",te),g.value="not-valid"},handleNoAnswerConfirm:async()=>{var Ze,Qe,Je,Ge;const te={timestamp:new Date().toISOString(),outcome:"no-answer",channel:((Ze=A.value)==null?void 0:Ze.channel)||"phone",notes:((Qe=A.value)==null?void 0:Qe.notes)||"",transcription:((Je=A.value)==null?void 0:Je.transcription)||null};s("call-attempt-logged",te);const le=c(),ce=le.split("T")[0],Ce=new Date(le).toTimeString().slice(0,5);if(d&&((Ge=i.value)!=null&&Ge.id))try{await d.updateLead(i.value.id,{nextActionDue:le,status:"Pending"})}catch(Pe){console.error('Failed to update lead status to "to be called back":',Pe)}s("postponed",{date:ce,time:Ce,createAppointment:!0}),(l==null?void 0:l.value)+1>=(u==null?void 0:u.value)&&s("disqualified",{category:"Not Interested",reason:"Unreachable"});const Ae=it();L.value={kind:"no-answer",statusText:`Message sent - Rescheduled to ${Ae}`,actorName:ze()},q.value=new Date,h()},handleNotValidConfirm:()=>{var le,ce,Ce;const te={timestamp:new Date().toISOString(),outcome:"not-valid",channel:((le=A.value)==null?void 0:le.channel)||"phone",notes:((ce=A.value)==null?void 0:ce.notes)||"",transcription:((Ce=A.value)==null?void 0:Ce.transcription)||null};s("call-attempt-logged",te),s("disqualified",{category:a.disqualifyCategory.value,reason:a.disqualifyReason.value}),L.value={kind:"not-interested",statusText:"Closed - Not interested",reason:a.disqualifyReason.value||null,actorName:ze()},q.value=new Date,h()},handleNoteSave:te=>{a.showNoteModal.value=!1,s("note-saved",te)},handleSurveyCompleted:async te=>{var le;if(F.value=te,p.value=!0,R.value=!1,d&&((le=i.value)!=null&&le.id))try{await d.addActivity(i.value.id,{type:"survey",action:"Lead Qualification Survey",content:JSON.stringify(te),timestamp:new Date().toISOString()})}catch(ce){console.error("Failed to save survey activity:",ce)}s("survey-completed",{lead:i.value,responses:te})},handleSurveyRefused:async()=>{var te;if(R.value=!1,d&&((te=i.value)!=null&&te.id))try{await d.addActivity(i.value.id,{type:"survey",action:"Lead Qualification Survey",content:"Customer refused to complete survey",timestamp:new Date().toISOString()})}catch(le){console.error("Failed to save survey refusal activity:",le)}s("survey-refused",{lead:i.value})},handleNotResponding:async()=>{var te;if(R.value=!1,d&&((te=i.value)!=null&&te.id))try{await d.addActivity(i.value.id,{type:"survey",action:"Lead Qualification Survey",content:"Customer not responding to survey",timestamp:new Date().toISOString()})}catch(le){console.error("Failed to save survey not responding activity:",le)}s("not-responding",{lead:i.value})},handleReopen:()=>{a.clearSuccessState(),a.resetOutcomeState()}}}const Hu=["disabled"],Qu={__name:"AIButton",props:{label:{type:String,required:!0},size:{type:String,default:"medium",validator:s=>["small","medium"].includes(s)},disabled:{type:Boolean,default:!1}},emits:["click"],setup(s){return(C,a)=>(f(),k("button",{class:re(["flex items-center gap-2 rounded-lg text-white font-medium transition-all","hover:opacity-90 active:scale-95",s.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer",s.size==="small"?"px-3 py-1.5 text-xs":"px-4 py-2 text-sm"]),disabled:s.disabled,style:{background:"linear-gradient(135deg, #6B21A8, #9333EA, #A855F7)"},onClick:a[0]||(a[0]=i=>C.$emit("click",i))},[n(t(dl),{size:s.size==="small"?14:16,class:"text-white shrink-0"},null,8,["size"]),e("span",null,U(s.label),1)],10,Hu))}},Gu={key:0,class:"flex gap-2 items-center mb-4"},Ju={key:1,class:"mb-4 space-y-4"},Ku={key:0,class:"bg-slate-900 text-white rounded-lg"},Zu={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700"},Xu={class:"flex items-center gap-2"},ed={class:"text-xs font-bold uppercase tracking-wider"},td={class:"flex items-center gap-3"},nd={class:"flex items-center gap-2 text-red-400"},sd={class:"text-xs font-mono"},ad={class:"text-xs font-mono text-red-200"},ld={key:0,class:"p-4 space-y-4"},od={key:0,class:"space-y-1"},id={class:"space-y-3 text-sm font-mono"},rd={class:"ml-2"},ud={class:"ml-2"},dd={key:0},cd={class:"ml-2"},md={key:1},fd={class:"ml-2"},pd={key:2},vd={class:"ml-2"},gd={key:1,class:"pt-4 border-t border-slate-700"},yd=["model-value"],bd={key:1,class:"bg-blue-50 rounded-lg p-4"},hd={class:"flex items-center justify-between"},xd={class:"flex gap-2"},hl={__name:"CallInterface",props:{isCallActive:{type:Boolean,required:!0},callEnded:{type:Boolean,required:!0},callDuration:{type:Number,required:!0},callNotes:{type:String,required:!0},formattedCallDuration:{type:String,required:!0},mockTranscription:{type:Object,required:!0},contactAttempts:{type:Number,required:!0},maxContactAttempts:{type:Number,required:!0},hideButton:{type:Boolean,default:!1}},emits:["start-call","end-call","log-manual-call","extract-information","update:call-notes","copy-number"],setup(s){const C=s,a=T(!1);return ve(()=>C.isCallActive,(i,l)=>{if(i&&!l){a.value=!1;return}i||(a.value=!1)}),(i,l)=>(f(),k("div",null,[!s.hideButton&&!s.isCallActive?(f(),k("div",Gu,[n(t(J),{variant:"default",disabled:s.isCallActive,class:"inline-flex items-center gap-2",onClick:l[0]||(l[0]=u=>i.$emit("start-call"))},{default:o(()=>[n(t(Jo),{size:16,class:"shrink-0","aria-hidden":"true"}),D(" "+U(s.contactAttempts>0?"Call Again":"Initiate Call"),1)]),_:1},8,["disabled"])])):N("",!0),s.isCallActive||s.callEnded?(f(),k("div",Ju,[s.isCallActive||s.callEnded?(f(),k("div",Ku,[e("div",Zu,[e("div",Xu,[l[6]||(l[6]=e("i",{class:"fa-solid fa-waveform-lines text-blue-400 animate-pulse"},null,-1)),e("span",ed,U(s.isCallActive?"TRANSCRIBING":"CALL SUMMARY"),1)]),e("div",td,[s.isCallActive?(f(),k(pe,{key:0},[e("div",nd,[l[7]||(l[7]=e("span",{class:"w-2 h-2 bg-red-500 rounded-full animate-pulse"},null,-1)),e("span",sd,"REC "+U(s.formattedCallDuration),1)]),e("button",{onClick:l[1]||(l[1]=u=>i.$emit("end-call")),class:"px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold rounded-lg flex items-center gap-2 transition-colors cursor-pointer"},[...l[8]||(l[8]=[e("i",{class:"fa-solid fa-stop text-xs cursor-pointer"},null,-1),D(" Stop Call ",-1)])]),e("button",{type:"button",class:"flex items-center justify-center px-3 h-8 rounded-btn border border-slate-600 bg-slate-800/80 hover:bg-slate-700 cursor-pointer",onClick:l[2]||(l[2]=u=>a.value=!a.value)},[e("i",{class:re(["fa-solid text-xs cursor-pointer",a.value?"fa-chevron-up":"fa-chevron-down"])},null,2)])],64)):(f(),k(pe,{key:1},[e("span",ad," Call duration "+U(s.formattedCallDuration),1),e("button",{type:"button",class:"px-3 h-8 rounded-btn border border-slate-600 bg-slate-800/80 hover:bg-slate-700 text-xs font-semibold cursor-pointer",onClick:l[3]||(l[3]=u=>a.value=!a.value)}," See transcription ")],64))])]),a.value?(f(),k("div",ld,[s.callEnded&&!s.isCallActive?(f(),k("div",od,[...l[9]||(l[9]=[e("h4",{class:"text-xs font-bold uppercase tracking-wider text-slate-300"},"Summary",-1),e("p",{class:"text-sm text-slate-100"}," Lead confirmed their details and the call covered the main inquiry discussed in the transcript below. ",-1)])])):N("",!0),e("div",id,[e("div",null,[l[10]||(l[10]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",rd,U(s.mockTranscription.leadLines[0]),1)]),e("div",null,[l[11]||(l[11]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",ud,U(s.mockTranscription.salesLines[0]),1)]),s.callDuration>=5?(f(),k("div",dd,[l[12]||(l[12]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",cd,U(s.mockTranscription.leadLines[1]),1)])):N("",!0),s.callDuration>=8?(f(),k("div",md,[l[13]||(l[13]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",fd,U(s.mockTranscription.salesLines[1]),1)])):N("",!0),s.callDuration>=12?(f(),k("div",pd,[l[14]||(l[14]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",vd,U(s.mockTranscription.leadLines[2]),1)])):N("",!0)]),s.isCallActive?(f(),k("div",gd,[e("textarea",{"model-value":s.callNotes,"onUpdate:modelValue":l[4]||(l[4]=u=>i.$emit("update:call-notes",u)),placeholder:"Add a quick note about this call...",class:"w-full p-3 bg-slate-800 border border-slate-700 rounded-btn text-white text-sm placeholder-gray-500 focus:outline-none focus:border-blue-500 resize-none",rows:"3"},null,8,yd)])):N("",!0)])):N("",!0)])):N("",!0),s.callEnded&&!s.isCallActive?(f(),k("div",bd,[e("div",hd,[l[15]||(l[15]=e("div",null,[e("h4",{class:"font-bold text-foreground mb-1 text-sm"},"Call Ended"),e("p",{class:"text-xs text-gray-600"},"Extract information from the transcription")],-1)),e("div",xd,[n(Qu,{label:"Extract information",size:"small",onClick:l[5]||(l[5]=u=>i.$emit("extract-information"))})])])])):N("",!0)])):N("",!0)]))}},wd={class:"flex items-center gap-2.5 min-w-0"},kd={class:"flex items-center gap-2 min-w-0"},xl={__name:"DeadlineBanner",props:{nextActionDue:{type:String,default:null},isClosed:{type:Boolean,default:!1},showDeadlineBanner:{type:Boolean,default:!0},taskId:{type:[String,Number],required:!0}},emits:["dismissed"],setup(s,{emit:C}){const a=s,i=C,l=T(!1),u=$(()=>Ko(a.nextActionDue)),d=$(()=>u.value.type==="overdue"?Ya:u.value.type==="urgent"?bi:Ya),S=$(()=>a.isClosed||!a.showDeadlineBanner||l.value?!1:u.value.type==="overdue"||u.value.type==="urgent"),V=()=>{l.value=!0,i("dismissed")};return(A,w)=>S.value?(f(),k("div",{key:0,class:re(["flex items-center justify-between px-4 py-2 border-b transition-all duration-200",[u.value.bgClass,u.value.borderClass]])},[e("div",wd,[e("div",{class:re(["flex items-center justify-center rounded-full w-5 h-5 shrink-0",u.value.type==="overdue"?"bg-red-100":"bg-orange-100"])},[(f(),ee(sa(d.value),{size:12,class:re(u.value.textClass)},null,8,["class"]))],2),e("div",kd,[e("span",{class:re(["text-xs font-bold uppercase tracking-wider",u.value.textClass])},U(u.value.type==="overdue"?"Overdue":"Urgent"),3),w[0]||(w[0]=e("span",{class:"text-xs text-muted-foreground opacity-30"},"•",-1)),e("span",{class:re(["text-xs font-medium truncate",u.value.textClass])}," Next Action: "+U(t(Zo)(s.nextActionDue)),3)])]),e("button",{onClick:V,class:re(["p-1 rounded-md transition-colors shrink-0",[u.value.textClass,"hover:bg-black/5"]]),title:"Dismiss"},[n(t(Xa),{size:14})],2)],2)):N("",!0)}},Sd={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Vs={__name:"CloseAsLostForm",props:{showMultipleNoShows:{type:Boolean,default:!1},preselectedReason:{type:String,default:""},closeButtonLabel:{type:String,default:"Close"}},emits:["close","cancel","update:reason"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(i.preselectedReason||"");ve(()=>i.preselectedReason,V=>{V&&(u.value=V)}),ve(u,V=>{l("update:reason",V)});const d=$(()=>!!u.value);function S(){d.value&&l("close",u.value)}return C({reason:u,canSubmit:d,submit:S}),(V,A)=>(f(),k("div",Sd,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...A[1]||(A[1]=[D("Reason",-1)])]),_:1}),n(t(Ot),{modelValue:u.value,"onUpdate:modelValue":A[0]||(A[0]=w=>u.value=w)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select a reason..."})]),_:1}),n(t(Tt),null,{default:o(()=>[s.showMultipleNoShows?(f(),ee(t(ge),{key:0,value:"Multiple no shows"},{default:o(()=>[...A[2]||(A[2]=[D("Multiple no shows",-1)])]),_:1})):N("",!0),n(t(ge),{value:"Data cleanup"},{default:o(()=>[...A[3]||(A[3]=[D("Data cleanup",-1)])]),_:1}),n(t(ge),{value:"Unreachable"},{default:o(()=>[...A[4]||(A[4]=[D("Unreachable",-1)])]),_:1}),n(t(ge),{value:"Purchase postponed"},{default:o(()=>[...A[5]||(A[5]=[D("Purchase postponed",-1)])]),_:1}),n(t(ge),{value:"Vehicle sold"},{default:o(()=>[...A[6]||(A[6]=[D("Vehicle sold",-1)])]),_:1}),n(t(ge),{value:"Out of budget"},{default:o(()=>[...A[7]||(A[7]=[D("Out of budget",-1)])]),_:1}),n(t(ge),{value:"Financing rejected"},{default:o(()=>[...A[8]||(A[8]=[D("Financing rejected",-1)])]),_:1}),n(t(ge),{value:"Duplicate"},{default:o(()=>[...A[9]||(A[9]=[D("Duplicate",-1)])]),_:1}),n(t(ge),{value:"Bought elsewhere"},{default:o(()=>[...A[10]||(A[10]=[D("Bought elsewhere",-1)])]),_:1}),n(t(ge),{value:"Not interested"},{default:o(()=>[...A[11]||(A[11]=[D("Not interested",-1)])]),_:1}),n(t(ge),{value:"Budget constraints"},{default:o(()=>[...A[12]||(A[12]=[D("Budget constraints",-1)])]),_:1}),n(t(ge),{value:"Found better price"},{default:o(()=>[...A[13]||(A[13]=[D("Found better price at competitor",-1)])]),_:1}),n(t(ge),{value:"No response"},{default:o(()=>[...A[14]||(A[14]=[D("Customer not responding",-1)])]),_:1}),n(t(ge),{value:"Wrong timing"},{default:o(()=>[...A[15]||(A[15]=[D("Timing not right",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...A[16]||(A[16]=[D("Other",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])])]))}},Cd={class:"rounded-lg flex flex-col bg-muted"},$d={class:"pt-1 px-1"},Dd={class:"bg-white rounded-lg p-4 shadow-nsc-card flex flex-col relative"},Ad={class:"flex items-center gap-3"},Td={class:"size-8 rounded-lg bg-green-100 flex items-center justify-center shrink-0"},Od={class:"flex-1 pr-10 min-w-0"},Id={class:"text-sm font-medium text-foreground"},Vd={key:0,class:"text-sm text-muted-foreground mt-1"},Fd={key:0,class:"mt-4 bg-white rounded-lg shadow-nsc-card overflow-hidden"},Ld={class:"grid grid-cols-2 gap-3 p-4 text-sm"},Nd={class:"ml-2 font-medium text-foreground"},qd={class:"ml-2 font-medium text-foreground"},Ud={class:"ml-2 font-medium text-foreground capitalize"},Pd={class:"ml-2 font-medium text-foreground"},Md={class:"flex justify-end mt-4"},Rd={class:"px-4 py-2 flex items-center justify-between text-sm text-muted-foreground"},Ed={class:"tabular-nums"},jd={class:"pt-1 px-1"},Bd={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},zd={class:"p-4"},Wd={class:"flex justify-between items-start mb-3"},_d={class:"text-base leading-normal font-medium text-foreground"},Yd={class:"text-sm leading-normal font-normal text-muted-foreground mt-0.5"},Hd={key:0,class:"mb-3 bg-muted border border-border rounded-lg p-3"},Qd={class:"flex items-center justify-between gap-4 flex-wrap"},Gd={key:0,class:"flex items-center gap-2"},Jd={class:"flex items-center gap-2"},Kd={class:"text-sm text-muted-foreground"},Zd={key:1,class:"flex items-center gap-2"},Xd={class:"text-sm font-semibold text-foreground"},ec={key:0,class:"text-sm text-orange-600 font-medium flex items-center gap-1 ml-2"},tc={class:"px-4 py-4 space-y-3"},nc={key:0,class:"space-y-4"},sc={class:"outcome-toggle-group flex flex-wrap gap-3"},ac={key:0,class:"space-y-4"},lc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},oc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},ic={class:"followup-channel-toggle-group flex flex-wrap gap-2 mb-4"},rc={key:0,class:"space-y-3"},uc=["value"],dc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},cc={class:"reschedule-toggle-group flex flex-wrap gap-2"},mc={key:0,class:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"},fc={class:"flex items-start gap-2"},pc={class:"flex-1"},vc={class:"text-sm font-semibold text-foreground mb-1"},gc={class:"text-xs text-muted-foreground"},yc={key:1,class:"mt-3 grid grid-cols-2 gap-3"},bc={key:1,class:"space-y-4"},hc={class:"bg-white rounded-lg p-4 shadow-nsc-card"},xc={key:2,class:"space-y-4"},wc={class:"bg-white rounded-lg p-4 shadow-nsc-card"},kc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Sc={class:"space-y-4"},Cc={class:"flex gap-4"},$c={class:"space-y-2"},Dc={class:"flex items-center gap-2 cursor-pointer"},Ac={class:"flex justify-end gap-2 mt-4"},Tc={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Oc={class:"space-y-2"},Ic={key:0,class:"space-y-4"},Vc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Fc={class:"grid grid-cols-2 gap-4"},Lc={class:"flex items-center gap-2"},Nc={class:"text-muted-foreground"},qc={class:"font-medium text-foreground"},Uc={class:"flex items-center gap-2"},Pc={class:"font-medium text-foreground"},Mc={key:1,class:"space-y-4"},Rc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Ec={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},jc={class:"grid grid-cols-2 gap-4"},Bc={class:"flex items-center gap-2"},zc={class:"text-muted-foreground"},Wc={class:"font-medium text-foreground"},_c={class:"flex items-center gap-2"},Yc={class:"font-medium text-foreground"},Hc={key:1,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Qc={class:"font-semibold text-foreground text-sm mb-4"},Gc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},Jc={class:"grid grid-cols-1 md:grid-cols-2 divide-x divide-black/5"},Kc={class:"p-6"},Zc={class:"flex items-center justify-between mb-4"},Xc={class:"text-sm font-semibold text-foreground"},em={class:"grid grid-cols-7 gap-1 mb-2"},tm={class:"grid grid-cols-7 gap-1"},nm=["onClick"],sm={class:"p-6"},am={class:"text-sm font-semibold text-foreground mb-4"},lm={key:0,class:"schedule-slot-toggle-group flex flex-col gap-2 w-full space-y-2"},om={key:1,class:"text-sm text-muted-foreground py-4 text-center"},im={key:2,class:"text-sm text-muted-foreground py-4 text-center"},rm={key:2,class:"bg-blue-50 border border-blue-200 rounded-lg p-6"},um={class:"grid grid-cols-2 gap-3 text-sm mb-3"},dm={class:"ml-2 font-medium text-foreground"},cm={class:"ml-2 font-medium text-foreground"},mm={class:"ml-2 font-medium text-foreground capitalize"},fm={class:"ml-2 font-medium text-foreground"},pm={key:1,class:"flex justify-end gap-2 px-4 pb-4 pt-3"},vm={__name:"LQTask",props:{lead:{type:Object,required:!0},activities:{type:Array,default:()=>[]},showDeadlineBanner:{type:Boolean,default:!0}},emits:["postponed","validated","qualified","disqualified","call-attempt-logged","note-saved","open-purchase-method","appointment-scheduled","survey-completed","survey-refused","not-responding"],setup(s,{emit:C}){const{t:a}=As(),i=s,l=C,u=xn(),d=Jt();Os();const S=rn(),V=fl(()=>i.lead,{}),A=bl(),{isCallActive:w,callEnded:g,callDuration:y,callNotes:b,callData:h,extractedData:c,mockTranscription:x,formattedCallDuration:p,startCall:F,endCall:R,copyNumber:P}=A,z=T(null),H=T(!1),L=T(!1),q=T(!1),K=T(!1),_=$(()=>u.assignableUsers),Q=$(()=>u.assignableTeams),ue=$(()=>d.currentUser),ne=T({interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""}),E=T(""),O=T(""),G=T(""),De=T("");$(()=>{var v;const M=new Set;return(v=Q.value)==null||v.forEach(ie=>{ie.dealership&&M.add(ie.dealership)}),Array.from(M).sort()}),$(()=>{var M;return E.value?((M=Q.value)==null?void 0:M.filter(v=>v.dealership===E.value))||[]:Q.value||[]}),$(()=>{var v,ie;if(!O.value)return _.value||[];const M=(v=Q.value)==null?void 0:v.find(j=>j.id===O.value);return M?((ie=_.value)==null?void 0:ie.filter(j=>j.team===M.name||j.teamId===M.id))||[]:_.value||[]});const be=M=>M?M.split(" ").map(v=>v[0]).join("").toUpperCase().substring(0,2):"?",Ne=M=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[M]||"bg-muted text-muted-foreground",ot=M=>{Pe.value.assignee=M,M.type==="team"&&(Lt.value=null),H.value=!1};$(()=>!!Xe.value),$(()=>{if(_e.value)return _e.value.statusText;const M=i.activities.filter(v=>v.type==="call"||v.type==="outcome").sort((v,ie)=>new Date(ie.timestamp)-new Date(v.timestamp))[0];return M?M.outcome||M.content||"Outcome logged":null});const ze=async()=>{var M;try{const v=ne.value,ie=[];if(v.interestLevel&&ie.push(`Interest level: ${v.interestLevel}`),v.purchaseTimeline&&ie.push(`Purchase timeline: ${v.purchaseTimeline}`),v.budgetRange&&ie.push(`Budget range: ${v.budgetRange}`),v.hasTradeIn&&v.tradeInModel&&ie.push(`Trade-in: ${v.tradeInModel}`),v.financingOption){const Le={FIN:"Captive Financing",LEA:"Leasing",LTR:"Long-Term Rental"};ie.push(`Financing: ${Le[v.financingOption]||v.financingOption}`)}v.additionalNotes&&ie.push(v.additionalNotes);const j=ie.join(`
`);if(j.trim()&&(await S.addActivity(i.lead.id,{type:"note",user:((M=ue.value)==null?void 0:M.name)||"You",action:"enriched lead information",content:j,timestamp:new Date().toISOString()}),l("note-saved",{type:"note",content:j,timestamp:new Date().toISOString(),enrichData:{...v}})),v.interestLevel||v.purchaseTimeline||v.budgetRange){const Le={interestLevel:v.interestLevel,purchaseTimeline:v.purchaseTimeline,budgetRange:v.budgetRange};await S.addActivity(i.lead.id,{type:"survey",action:"Lead Qualification Survey",content:JSON.stringify(Le),timestamp:new Date().toISOString()}),l("survey-completed",{lead:i.lead,responses:Le})}ne.value={interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""}}catch(v){console.error("Error saving enriched lead data:",v)}},it=()=>{F(),pt(!1)},mt=()=>{P(i.lead.customer.phone)},Ke=M=>{b.value=M},kt=$(()=>{var M;return((M=V.primaryAction.value)==null?void 0:M.title)||"Call to Verify Contact Details"}),Pt=$(()=>{var M;return((M=V.primaryAction.value)==null?void 0:M.description)||"Begin lead qualification by verifying customer contact information."});$(()=>i.lead.scheduledAppointment?new Date(i.lead.scheduledAppointment.start)<new Date:!1);const Ft=$(()=>!!i.lead.scheduledAppointment),rt=V.contactAttempts,Z=V.maxContactAttempts,B=_u(as(i,"lead"),h,c,rt,Z,ue),{showOutcomeSelection:Y,selectedOutcome:se,showNoteModal:X,showScheduleAppointmentModal:te,followupChannels:le,followupChannel:ce,selectedTemplate:Ce,rescheduleTime:Ae,customDate:Ze,customTime:Qe,disqualifyCategory:Je,disqualifyReason:Ge,assignment:Pe,preferences:Ve,messageTemplates:nt,messagePreview:fe,hasExistingAppointment:me,selectOutcome:ye,cancelOutcome:xe,calculateNextCallDate:ke,surveyCompleted:Me,surveyResponses:ut,showSurvey:St,aiSuggestionData:Te,handleAISuggestionClick:qe,callLogDateTime:$e,callLogAssignee:Xe,confirmCallLogForm:zt,cancelCallLogForm:Kt,initCallLogForm:pt,successState:_e,successPerformedAt:un,qualificationMethod:st,qualificationEventType:We,qualificationDurationMinutes:dn,qualificationCustomDuration:cn,qualificationCalendarMonth:dt,qualificationSelectedDate:Ye,qualificationSelectedSlot:et,setQualificationSelectedSlot:Zt,qualificationDateRange:at,qualificationCustomDateStart:Rn,qualificationCustomDateEnd:os,availableDatesForRange:gt,qualificationScheduleSlotOptions:ft,qualificationDurationValue:Mt,qualificationSelectedTeam:Re,qualificationSelectedSalesman:Lt,suggestedTeam:En,communicationPreferences:mn}=B;function fn(M){ce.value=M}function pn(M){if(!M){Ae.value=null;return}M==="monday"?qe():Ae.value=M}function An(M){Ge.value=M}const Wt=M=>{mn.value=M},Rt=$(()=>{if(!Ye.value)return[];const M=Ye.value.toISOString().split("T")[0];if(Lt.value){const v=Un(`user-${Lt.value.id}`,M);return ft.value.filter(ie=>v.includes(ie))}if(Re.value){const v=Un(`team-${Re.value.id}`,M);return ft.value.filter(ie=>v.includes(ie))}return ft.value||[]});ve(Ye,()=>{et.value=""}),$(()=>i.activities.filter(M=>M.type==="note"));const _t=$(()=>(Q.value||[]).slice(0,3)),vn=$(()=>{if(!Q.value)return[];const M=[...Q.value];if(Re.value){const v=M.findIndex(ie=>ie.id===Re.value.id);if(v>0){const ie=M.splice(v,1)[0];M.unshift(ie)}}return M}),Xt=$(()=>vn.value.map(M=>({...M,label:`${M.dealership||"No location"} → ${M.name}`,value:M.id}))),wn=$(()=>{var ie;if(!Re.value)return[];const M=Re.value;return(((ie=_.value)==null?void 0:ie.filter(j=>j.team===M.name||j.teamId===M.id))||[]).map(j=>({...j,label:j.name,value:j.id}))}),Ct=$({get:()=>{var M;return((M=Re.value)==null?void 0:M.id)||null},set:M=>{var ie;if(!M){Re.value=null;return}const v=(ie=Q.value)==null?void 0:ie.find(j=>j.id===M);Re.value=v||null}}),en=$({get:()=>{var M;return((M=Lt.value)==null?void 0:M.id)||null},set:M=>{if(!M){Lt.value=null;return}const v=wn.value.find(ie=>ie.id===M);Lt.value=v||null}});function gn(){if(!We.value||Re.value)return;const M=Q.value;if(!(M!=null&&M.length))return;const v=En.value;if(v){const ie=M.find(j=>j.id===v.id);if(ie){Re.value=ie;return}}if(i.lead.assignee){const ie=M.find(j=>j.name===i.lead.assignee);ie&&(Re.value=ie)}}ve(()=>[We.value,En.value,(Q.value??[]).length,i.lead.assignee],()=>{gn()},{immediate:!0}),ve(()=>We.value&&!Re.value,M=>{M&&la(gn)},{immediate:!0}),ve(We,M=>{if(M&&!Ye.value){const v=new Date;v.setHours(0,0,0,0),Ye.value=v,lt.value=v.getMonth(),yt.value=v.getFullYear(),et.value=""}},{immediate:!0}),ve(se,M=>{var v,ie,j;if(M==="interested"&&st.value==="assign-only"&&!((v=Pe.value)!=null&&v.assignee))if(i.lead.assignee){const Fe=(ie=_.value)==null?void 0:ie.find(nn=>nn.name===i.lead.assignee),Le=(j=Q.value)==null?void 0:j.find(nn=>nn.name===i.lead.assignee);Fe?Pe.value={...Pe.value,assignee:{...Fe,type:"user"}}:Le&&(Pe.value={...Pe.value,assignee:{...Le,type:"team"}})}else _t.value.length>0&&(Pe.value={...Pe.value,assignee:{..._t.value[0],type:"team"}})}),ve(()=>{var M;return(M=Pe.value)==null?void 0:M.assignee},M=>{(M==null?void 0:M.type)!=="team"&&(Lt.value=null)}),ve(Re,M=>{Lt.value=null,M&&We.value&&yn(`team-${M.id}`)}),ve(Lt,M=>{M?yn(`user-${M.id}`):Re.value&&yn(`team-${Re.value.id}`)}),ve(Ye,()=>{et.value=""});const yn=M=>{const v=new Date;v.setHours(0,0,0,0);for(let ie=0;ie<30;ie++){const j=new Date(v);if(j.setDate(v.getDate()+ie),j.getDay()===0||j.getDay()===6)continue;const Fe=j.toISOString().split("T")[0],Le=Un(M,Fe);if(Le&&Le.length>0){Ye.value=j,lt.value=j.getMonth(),yt.value=j.getFullYear(),setTimeout(()=>{const nn=ft.value.filter(js=>Le.includes(js));nn.length>0&&(et.value=nn[0])},0);break}}},tn=$(()=>!(se.value!=="no-answer"||!ce.value||ce.value!=="dont-send"&&!Ce.value||!Ae.value||Ae.value==="custom"&&(!Ze.value||!Qe.value)));ve(se,M=>{M!=="interested"&&(ne.value={interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""},E.value="",O.value="",G.value="")}),ve(G,M=>{var v,ie;if(M){const j=(v=_.value)==null?void 0:v.find(Fe=>Fe.id===M);if(j){const Fe=(ie=Q.value)==null?void 0:ie.find(Le=>Le.name===j.team||Le.id===j.teamId);Fe&&(O.value=Fe.id,Fe.dealership&&(E.value=Fe.dealership))}}}),ve(O,M=>{var v,ie;if(M&&G.value){const j=(v=_.value)==null?void 0:v.find(Le=>Le.id===G.value),Fe=(ie=Q.value)==null?void 0:ie.find(Le=>Le.id===M);j&&Fe&&j.team!==Fe.name&&j.teamId!==Fe.id&&(G.value="")}}),ve(E,M=>{var v;if(M&&O.value){const ie=(v=Q.value)==null?void 0:v.find(j=>j.id===O.value);ie&&ie.dealership!==M&&(O.value="",G.value="")}}),ve(g,M=>{M&&!_e.value&&pt(!1)});const kn=[{value:"appointment-on-phone",label:"Appointment on the phone (15m)"},{value:"appointment-at-dealership",label:"Appointment at the dealership (30m)"},{value:"recall-internal",label:"Recall - internal (15m)"},{value:"appointment-at-dealership-test-drive",label:"Appointment at the dealership + Test drive (1h)"},{value:"appointment-at-workshop",label:"Appointment at the workshop (15m)"},{value:"appointment-at-customer-site",label:"Appointment at customer's site (1h 40m)"},{value:"appointment-at-customer-site-test-drive",label:"Appointment at customer's site + Test drive (5h)"}],Tn=$(()=>kn.map(M=>({value:M.value,label:M.label}))),lt=T(new Date().getMonth()),yt=T(new Date().getFullYear()),jn=["MON","TUE","WED","THU","FRI","SAT","SUN"],is=$(()=>new Date(yt.value,lt.value).toLocaleDateString("en-US",{month:"long",year:"numeric"})),Bn=$(()=>{const M=new Date(yt.value,lt.value,1),ie=new Date(yt.value,lt.value+1,0).getDate(),j=M.getDay()===0?6:M.getDay()-1,Fe=[];for(let Le=0;Le<j;Le++)Fe.push(null);for(let Le=1;Le<=ie;Le++)Fe.push(Le);return Fe}),zn=$(()=>{if(!Ye.value)return a("forms.schedule.timeSlots.selectDate");const M=Ye.value,v=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ie=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${v[M.getDay()]}, ${ie[M.getMonth()]} ${M.getDate()}`}),Wn=M=>{if(!M||!Ye.value)return!1;const v=Ye.value;return v.getDate()===M&&v.getMonth()===lt.value&&v.getFullYear()===yt.value},bn=M=>{if(!M)return;const v=new Date(yt.value,lt.value,M);Ye.value=v,et.value=""},rs=()=>{lt.value===0?(lt.value=11,yt.value--):lt.value--},us=()=>{lt.value===11?(lt.value=0,yt.value++):lt.value++},ds={"appointment-on-phone":15,"appointment-at-dealership":30,"recall-internal":15,"appointment-at-dealership-test-drive":60,"appointment-at-workshop":15,"appointment-at-customer-site":100,"appointment-at-customer-site-test-drive":300},_n=M=>{dn.value=M,cn.value=""};ve(cn,M=>{M&&(dn.value=null)}),ve(We,M=>{if(!M)return;const v=ds[M];v&&(v===15?_n(15):v===30?_n(30):v===60?_n(60):(dn.value=null,cn.value=v.toString()))});const cs=$(()=>st.value==="assign-only"?!!(We.value&&Re.value):!!(We.value&&Mt.value&&Ye.value&&et.value&&Re.value)),Nt=$(()=>!!Ge.value);function Ee(M){Ge.value=M,Je.value||(Je.value="Not Valid"),ps()}const ms=$(()=>se.value==="no-answer"?ce.value==="dont-send"?"Postpone":"Send and postpone":se.value==="not-valid"?Je.value?`Close as ${Je.value}`:"Close":se.value==="interested"?"Schedule and qualify":""),Yn=$(()=>se.value==="no-answer"?tn.value:se.value==="not-valid"?Nt.value:se.value==="interested"?cs.value:!1),On=()=>{se.value==="no-answer"?qs():se.value==="not-valid"?ps():se.value==="interested"&&Ns()},Yt=Yu(l,A,B,as(i,"lead"),rt,Z,S,ue,ne),{logManualCall:Ls,handleScheduleAppointmentConfirm:fs,handleQualify:Ns,handleNoAnswerConfirm:qs,handleNotValidConfirm:ps,handleNoteSave:vs,handleReopen:Us}=Yt,Ps=$(()=>{if(!un.value)return"";const M=un.value,v=String(M.getDate()).padStart(2,"0"),ie=String(M.getMonth()+1).padStart(2,"0"),j=String(M.getFullYear()),Fe=String(M.getHours()).padStart(2,"0"),Le=String(M.getMinutes()).padStart(2,"0");return`${v}/${ie}/${j} ${Fe}:${Le}`}),{saveTradeInVehicle:Ms}=Xo(),Rs=async M=>{var v,ie,j;try{L.value=!1,Ve.value.financing=!0;const Fe=M.type==="FIN"?"Captive Financing":M.type==="LEA"?"Leasing":"Long-Term Rental",Le=((v=M.fields)==null?void 0:v.monthlyInstalment)||0;await S.addActivity(i.lead.id,{type:"purchase-method",user:((ie=ue.value)==null?void 0:ie.name)||"You",action:`added a ${Fe} purchase method`,content:`${Fe}: €${Le.toLocaleString()}/month for ${((j=M.fields)==null?void 0:j.duration)||0} months`,data:{purchaseMethodId:M.id,type:M.type,...M.fields},timestamp:new Date().toISOString()}),l("note-saved",{type:"purchase-method",...M})}catch(Fe){console.error("Error saving purchase method:",Fe)}},Es=async M=>{try{if(q.value=!1,M.vehicleType==="tradein"||i.mode==="tradein"){const v=await Ms("lead",i.lead.id,M.vehicle,M.valuation||{});Ve.value.tradeIn=!0,l("note-saved",{type:"tradein",id:v.activity.id,action:"added a trade-in",vehicleId:v.vehicle.id,data:v.activity.data,timestamp:v.activity.timestamp})}else{const{addVehicleToCustomer:v}=await Cn(async()=>{const{addVehicleToCustomer:ie}=await import("./contacts-Doz8YZdN.js");return{addVehicleToCustomer:ie}},__vite__mapDeps([0,1,2]));await v(i.lead.customerId,M.vehicle),l("note-saved",{type:"vehicle",vehicleType:M.vehicleType,...M.vehicle})}}catch(v){console.error("Error saving vehicle:",v)}};return(M,v)=>{var ie;return f(),k("div",Cd,[t(_e)?(f(),k(pe,{key:0},[e("div",$d,[e("div",Dd,[e("div",Ad,[e("div",Td,[n(t(ta),{size:16,class:"text-green-600"})]),e("div",Od,[e("p",Id,U(t(_e).statusText),1),t(_e).reason?(f(),k("p",Vd,U(t(_e).reason),1)):N("",!0)])]),t(_e).meeting?(f(),k("div",Fd,[e("div",Ld,[e("div",null,[v[42]||(v[42]=e("span",{class:"text-muted-foreground"},"Date:",-1)),e("span",Nd,U(t(_e).meeting.date),1)]),e("div",null,[v[43]||(v[43]=e("span",{class:"text-muted-foreground"},"Time:",-1)),e("span",qd,U(t(_e).meeting.time),1)]),e("div",null,[v[44]||(v[44]=e("span",{class:"text-muted-foreground"},"Type:",-1)),e("span",Ud,U(t(_e).meeting.title),1)]),e("div",null,[v[45]||(v[45]=e("span",{class:"text-muted-foreground"},"Assigned to:",-1)),e("span",Pd,U(t(_e).meeting.location),1)])])])):N("",!0),e("div",Md,[n(t(J),{variant:"outline",size:"small",class:"flex items-center gap-2 cursor-pointer",onClick:t(Us)},{default:o(()=>[n(t(gi),{size:14}),v[46]||(v[46]=D(" Re-open ",-1))]),_:1},8,["onClick"])])])]),e("div",Rd,[e("span",null,"Updated by "+U(t(_e).actorName||"Unknown"),1),e("span",Ed,U(Ps.value),1)])],64)):(f(),k(pe,{key:1},[e("div",jd,[e("div",Bd,[n(xl,{"next-action-due":s.lead.nextActionDue,"show-deadline-banner":s.showDeadlineBanner,"task-id":s.lead.id},null,8,["next-action-due","show-deadline-banner","task-id"]),e("div",zd,[e("div",Wd,[e("div",null,[e("h4",_d,U(kt.value),1),e("p",Yd,U(Pt.value),1)])]),Ft.value||t(rt)>0?(f(),k("div",Hd,[e("div",Qd,[Ft.value?(f(),k("div",Gd,[v[48]||(v[48]=e("i",{class:"fa-solid fa-calendar-check text-blue-600 text-sm"},null,-1)),e("div",Jd,[v[47]||(v[47]=e("span",{class:"text-sm font-semibold text-foreground"},"Scheduled Follow-up Call:",-1)),e("span",Kd,U(t($n)(s.lead.scheduledAppointment.start))+" at "+U(t(ns)(s.lead.scheduledAppointment.start)),1)])])):N("",!0),t(rt)>0?(f(),k("div",Zd,[v[50]||(v[50]=e("i",{class:"fa-solid fa-phone text-muted-foreground text-sm"},null,-1)),v[51]||(v[51]=e("span",{class:"text-sm font-semibold text-muted-foreground"},"Contact Attempts:",-1)),e("span",Xd,U(t(rt))+" / "+U(t(Z)),1),t(rt)>=t(Z)-1?(f(),k("div",ec,[...v[49]||(v[49]=[e("i",{class:"fa-solid fa-exclamation-triangle"},null,-1),e("span",null,"One more attempt before auto-disqualification",-1)])])):N("",!0)])):N("",!0)])])):N("",!0),n(hl,{"is-call-active":t(w),"call-ended":t(g),"call-duration":t(y),"call-notes":t(b),"formatted-call-duration":t(p),"mock-transcription":t(x),"contact-attempts":t(rt),"max-contact-attempts":t(Z),onStartCall:it,onEndCall:t(R),onLogManualCall:t(Ls),onExtractInformation:v[0]||(v[0]=j=>K.value=!0),"onUpdate:callNotes":Ke,onCopyNumber:mt},null,8,["is-call-active","call-ended","call-duration","call-notes","formatted-call-duration","mock-transcription","contact-attempts","max-contact-attempts","onEndCall","onLogManualCall"])])])]),e("div",tc,[t(_e)?N("",!0):(f(),k("div",nc,[e("div",null,[v[55]||(v[55]=e("p",{class:"text-sm font-medium text-foreground leading-normal mb-3"},"Log what is happening?",-1)),e("div",sc,[n(t(Ue),{variant:"outline","model-value":t(se)==="no-answer","onUpdate:modelValue":v[1]||(v[1]=j=>t(ye)(j?"no-answer":null)),class:"outcome-toggle-item"},{default:o(()=>[n(t(vi),{size:18,class:"shrink-0"}),v[52]||(v[52]=e("span",null,"No answer",-1))]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(se)==="not-valid","onUpdate:modelValue":v[2]||(v[2]=j=>t(ye)(j?"not-valid":null)),class:"outcome-toggle-item"},{default:o(()=>[n(t(yi),{size:18,class:"shrink-0"}),v[53]||(v[53]=e("span",null,"Not valid",-1))]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(se)==="interested","onUpdate:modelValue":v[3]||(v[3]=j=>t(ye)(j?"interested":null)),class:"outcome-toggle-item"},{default:o(()=>[n(t(ta),{size:18,class:"shrink-0"}),v[54]||(v[54]=e("span",null,"Interested",-1))]),_:1},8,["model-value"])])]),t(se)==="no-answer"?(f(),k("div",ac,[e("div",lc,[n(t(W),{class:"form-label"},{default:o(()=>[...v[56]||(v[56]=[D("When did you call?",-1)])]),_:1}),n(t(Oe),{type:"datetime-local",modelValue:t($e),"onUpdate:modelValue":v[4]||(v[4]=j=>an($e)?$e.value=j:null),class:"w-full"},null,8,["modelValue"])]),e("div",oc,[v[65]||(v[65]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Send follow-up message",-1)),e("div",ic,[n(t(Ue),{variant:"outline","model-value":t(ce)==="whatsapp","onUpdate:modelValue":v[5]||(v[5]=j=>j&&fn("whatsapp")),class:"followup-toggle-item"},{default:o(()=>[...v[57]||(v[57]=[e("i",{class:"fa-brands fa-whatsapp text-xs"},null,-1),e("span",null,"WhatsApp",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(ce)==="sms","onUpdate:modelValue":v[6]||(v[6]=j=>j&&fn("sms")),class:"followup-toggle-item"},{default:o(()=>[...v[58]||(v[58]=[e("i",{class:"fa-solid fa-message text-xs"},null,-1),e("span",null,"SMS",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(ce)==="email","onUpdate:modelValue":v[7]||(v[7]=j=>j&&fn("email")),class:"followup-toggle-item"},{default:o(()=>[...v[59]||(v[59]=[e("i",{class:"fa-solid fa-envelope text-xs"},null,-1),e("span",null,"Email",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(ce)==="dont-send","onUpdate:modelValue":v[8]||(v[8]=j=>j&&fn("dont-send")),class:"followup-toggle-item"},{default:o(()=>[...v[60]||(v[60]=[e("i",{class:"fa-solid fa-xmark text-xs"},null,-1),e("span",null,"Don't send",-1)])]),_:1},8,["model-value"])]),t(ce)&&t(ce)!=="dont-send"?(f(),k("div",rc,[e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[61]||(v[61]=[D("Template",-1)])]),_:1}),n(t(Ot),{modelValue:t(Ce),"onUpdate:modelValue":v[9]||(v[9]=j=>an(Ce)?Ce.value=j:null)},{default:o(()=>[n(t(Dt),{class:"w-full h-10 min-h-10"},{default:o(()=>[n(t(At),{placeholder:"Select template"})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"followup-1"},{default:o(()=>[...v[62]||(v[62]=[D("Follow-up 1",-1)])]),_:1}),n(t(ge),{value:"followup-2"},{default:o(()=>[...v[63]||(v[63]=[D("Follow-up 2",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[64]||(v[64]=[D("Message preview",-1)])]),_:1}),e("textarea",{value:t(fe),rows:"4",class:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm text-muted-foreground bg-white resize-none",readonly:""},null,8,uc)])])):N("",!0)]),e("div",dc,[v[72]||(v[72]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Next call attempt",-1)),e("div",cc,[n(t(Ue),{variant:"outline","model-value":t(Ae)==="tomorrow-9am","onUpdate:modelValue":v[10]||(v[10]=j=>j&&pn("tomorrow-9am")),class:"followup-toggle-item"},{default:o(()=>[...v[66]||(v[66]=[D(" Tomorrow 9:00 AM ",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(Ae)==="monday","onUpdate:modelValue":v[11]||(v[11]=j=>j&&pn("monday")),class:"followup-toggle-item"},{default:o(()=>[...v[67]||(v[67]=[e("i",{class:"fa-solid fa-sparkles text-xs"},null,-1),D(" AI suggestion ",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":t(Ae)==="custom","onUpdate:modelValue":v[12]||(v[12]=j=>j&&pn("custom")),class:"followup-toggle-item"},{default:o(()=>[...v[68]||(v[68]=[D(" Select time ",-1)])]),_:1},8,["model-value"])]),t(Ae)==="monday"&&t(Te)?(f(),k("div",mc,[e("div",fc,[v[69]||(v[69]=e("i",{class:"fa-solid fa-lightbulb text-blue-600 text-sm mt-0.5"},null,-1)),e("div",pc,[e("p",vc,U(t(Te).formattedDate)+" at "+U(t(Te).time),1),e("p",gc,U(t(Te).reason),1)])])])):N("",!0),t(Ae)==="custom"?(f(),k("div",yc,[e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[70]||(v[70]=[D("Date",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:t(Ze),"onUpdate:modelValue":v[13]||(v[13]=j=>an(Ze)?Ze.value=j:null),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[71]||(v[71]=[D("Time",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:t(Qe),"onUpdate:modelValue":v[14]||(v[14]=j=>an(Qe)?Qe.value=j:null),class:"w-full"},null,8,["modelValue"])])])):N("",!0)])])):N("",!0),t(se)==="not-valid"?(f(),k("div",bc,[e("div",hc,[n(t(W),{class:"form-label"},{default:o(()=>[...v[73]||(v[73]=[D("When did you call?",-1)])]),_:1}),n(t(Oe),{type:"datetime-local",modelValue:t($e),"onUpdate:modelValue":v[15]||(v[15]=j=>an($e)?$e.value=j:null),class:"w-full"},null,8,["modelValue"])]),n(Vs,{"preselected-reason":t(Ge),"close-button-label":"Close as not valid",onClose:Ee,onCancel:t(xe),"onUpdate:reason":An},null,8,["preselected-reason","onCancel"])])):N("",!0),t(se)==="interested"?(f(),k("div",xc,[v[119]||(v[119]=e("div",{class:"text-xs text-muted-foreground px-2"},[e("span",{class:"text-red-600"},"*"),D(" Required fields ")],-1)),e("div",wc,[n(t(W),{class:"form-label"},{default:o(()=>[...v[74]||(v[74]=[D("When did you call?",-1)])]),_:1}),n(t(Oe),{type:"datetime-local",modelValue:t($e),"onUpdate:modelValue":v[16]||(v[16]=j=>an($e)?$e.value=j:null),class:"w-full"},null,8,["modelValue"])]),e("div",kc,[v[97]||(v[97]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Enrich lead",-1)),e("div",Sc,[e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[75]||(v[75]=[D("Customer interest level?",-1)])]),_:1}),e("div",Cc,[n(t(W),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[Se(e("input",{type:"radio","onUpdate:modelValue":v[17]||(v[17]=j=>ne.value.interestLevel=j),value:"High",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[ct,ne.value.interestLevel]]),v[76]||(v[76]=e("span",{class:"text-sm text-muted-foreground"},"High",-1))]),_:1}),n(t(W),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[Se(e("input",{type:"radio","onUpdate:modelValue":v[18]||(v[18]=j=>ne.value.interestLevel=j),value:"Medium",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[ct,ne.value.interestLevel]]),v[77]||(v[77]=e("span",{class:"text-sm text-muted-foreground"},"Medium",-1))]),_:1}),n(t(W),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[Se(e("input",{type:"radio","onUpdate:modelValue":v[19]||(v[19]=j=>ne.value.interestLevel=j),value:"Low",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[ct,ne.value.interestLevel]]),v[78]||(v[78]=e("span",{class:"text-sm text-muted-foreground"},"Low",-1))]),_:1})])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[79]||(v[79]=[D("Expected purchase timeline?",-1)])]),_:1}),n(t(Ot),{modelValue:ne.value.purchaseTimeline,"onUpdate:modelValue":v[20]||(v[20]=j=>ne.value.purchaseTimeline=j)},{default:o(()=>[n(t(Dt),{class:"w-full h-10 min-h-10"},{default:o(()=>[n(t(At),{placeholder:"Select timeline"})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Immediate"},{default:o(()=>[...v[80]||(v[80]=[D("Immediate",-1)])]),_:1}),n(t(ge),{value:"Within 1 month"},{default:o(()=>[...v[81]||(v[81]=[D("Within 1 month",-1)])]),_:1}),n(t(ge),{value:"Within 3 months"},{default:o(()=>[...v[82]||(v[82]=[D("Within 3 months",-1)])]),_:1}),n(t(ge),{value:"Within 6 months"},{default:o(()=>[...v[83]||(v[83]=[D("Within 6 months",-1)])]),_:1}),n(t(ge),{value:"Just browsing"},{default:o(()=>[...v[84]||(v[84]=[D("Just browsing",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[85]||(v[85]=[D("Budget range (if discussed)?",-1)])]),_:1}),n(t(Ot),{modelValue:ne.value.budgetRange,"onUpdate:modelValue":v[21]||(v[21]=j=>ne.value.budgetRange=j)},{default:o(()=>[n(t(Dt),{class:"w-full h-10 min-h-10"},{default:o(()=>[n(t(At),{placeholder:"Select budget range"})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Under €30k"},{default:o(()=>[...v[86]||(v[86]=[D("Under €30k",-1)])]),_:1}),n(t(ge),{value:"€30k-€50k"},{default:o(()=>[...v[87]||(v[87]=[D("€30k-€50k",-1)])]),_:1}),n(t(ge),{value:"€50k-€80k"},{default:o(()=>[...v[88]||(v[88]=[D("€50k-€80k",-1)])]),_:1}),n(t(ge),{value:"€80k+"},{default:o(()=>[...v[89]||(v[89]=[D("€80k+",-1)])]),_:1}),n(t(ge),{value:"Not discussed"},{default:o(()=>[...v[90]||(v[90]=[D("Not discussed",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",$c,[e("label",Dc,[Se(e("input",{type:"checkbox","onUpdate:modelValue":v[22]||(v[22]=j=>ne.value.hasTradeIn=j),class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,512),[[$t,ne.value.hasTradeIn]]),v[91]||(v[91]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Trade in?",-1))]),n(t(Oe),{modelValue:ne.value.tradeInModel,"onUpdate:modelValue":v[23]||(v[23]=j=>ne.value.tradeInModel=j),disabled:!ne.value.hasTradeIn,placeholder:"Car brand and model",class:"w-full h-10 min-h-10"},null,8,["modelValue","disabled"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[92]||(v[92]=[D("Financing?",-1)])]),_:1}),n(t(Ot),{modelValue:ne.value.financingOption,"onUpdate:modelValue":v[24]||(v[24]=j=>ne.value.financingOption=j)},{default:o(()=>[n(t(Dt),{class:"w-full h-10 min-h-10"},{default:o(()=>[n(t(At),{placeholder:"Select financing option"})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"FIN"},{default:o(()=>[...v[93]||(v[93]=[D("Captive Financing",-1)])]),_:1}),n(t(ge),{value:"LEA"},{default:o(()=>[...v[94]||(v[94]=[D("Leasing",-1)])]),_:1}),n(t(ge),{value:"LTR"},{default:o(()=>[...v[95]||(v[95]=[D("Long-Term Rental",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[96]||(v[96]=[D("Additional notes",-1)])]),_:1}),n(t(He),{modelValue:ne.value.additionalNotes,"onUpdate:modelValue":v[25]||(v[25]=j=>ne.value.additionalNotes=j),rows:"4",class:"w-full",placeholder:"Any relevant information about customer interest or preferences..."},null,8,["modelValue"])])]),e("div",Ac,[n(t(J),{label:"Save",variant:"primary",size:"small",onClick:ze})])]),e("div",Tc,[v[100]||(v[100]=e("h5",{class:"font-semibold text-foreground text-sm mb-3"},[D("Qualification method "),e("span",{class:"text-red-600"},"*")],-1)),e("div",Oc,[e("label",{class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",t(st)==="assign-only"?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":v[26]||(v[26]=j=>an(st)?st.value=j:null),type:"radio",value:"assign-only",class:"shrink-0"},null,512),[[ct,t(st)]]),v[98]||(v[98]=e("span",{class:"text-sm text-foreground"},"Assign only",-1))],2),e("label",{class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",t(st)==="assign-and-schedule"?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":v[27]||(v[27]=j=>an(st)?st.value=j:null),type:"radio",value:"assign-and-schedule",class:"shrink-0"},null,512),[[ct,t(st)]]),v[99]||(v[99]=e("span",{class:"text-sm text-foreground"},"Assign and schedule",-1))],2)])]),t(st)==="assign-only"?(f(),k("div",Ic,[e("div",Vc,[v[105]||(v[105]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",Fc,[e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[101]||(v[101]=[D("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(vt),{modelValue:Ct.value,"onUpdate:modelValue":v[28]||(v[28]=j=>Ct.value=j),items:Xt.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:j})=>[e("div",Lc,[e("span",Nc,U(j.dealership||"No location"),1),v[102]||(v[102]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",qc,U(j.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[103]||(v[103]=[D("Salesperson ",-1),e("span",{class:"optional"},"(optional)",-1)])]),_:1}),n(t(vt),{modelValue:en.value,"onUpdate:modelValue":v[29]||(v[29]=j=>en.value=j),items:wn.value,disabled:!t(Re),placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:j})=>[e("div",Uc,[e("div",{class:re(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",Ne(j.role)])},U(be(j.name)),3),e("span",Pc,U(j.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[104]||(v[104]=[D("Notes for assignee",-1)])]),_:1}),n(t(He),{modelValue:De.value,"onUpdate:modelValue":v[30]||(v[30]=j=>De.value=j),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])])):N("",!0),t(st)==="assign-and-schedule"?(f(),k("div",Mc,[e("div",Rc,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...v[106]||(v[106]=[D("Event type ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(vt),{modelValue:t(We),"onUpdate:modelValue":v[31]||(v[31]=j=>an(We)?We.value=j:null),items:Tn.value,placeholder:t(a)("forms.schedule.eventType.placeholder"),"value-key":"value",class:"w-full"},{item:o(({item:j})=>[e("span",null,U(j.label),1)]),_:1},8,["modelValue","items","placeholder"])]),t(We)?(f(),k("div",Ec,[v[110]||(v[110]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",jc,[e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[107]||(v[107]=[D("Team",-1)])]),_:1}),n(t(vt),{modelValue:Ct.value,"onUpdate:modelValue":v[32]||(v[32]=j=>Ct.value=j),items:Xt.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:j})=>[e("div",Bc,[e("span",zc,U(j.dealership||"No location"),1),v[108]||(v[108]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",Wc,U(j.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[n(t(W),{class:"form-label"},{default:o(()=>[...v[109]||(v[109]=[D("Salesperson ",-1),e("span",{class:"optional"},"(optional)",-1)])]),_:1}),n(t(vt),{modelValue:en.value,"onUpdate:modelValue":v[33]||(v[33]=j=>en.value=j),items:wn.value,disabled:!t(Re),placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:j})=>[e("div",_c,[e("div",{class:re(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",Ne(j.role)])},U(be(j.name)),3),e("span",Yc,U(j.name),1)])]),_:1},8,["modelValue","items","disabled"])])])])):N("",!0),t(We)&&t(Re)?(f(),k("div",Hc,[e("h5",Qc,[D(U(t(a)("forms.schedule.title"))+" ",1),v[111]||(v[111]=e("span",{class:"text-red-600"},"*",-1))]),e("div",Gc,[e("div",Jc,[e("div",Kc,[e("div",Zc,[e("button",{onClick:rs,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...v[112]||(v[112]=[e("i",{class:"fa-solid fa-chevron-left text-sm text-muted-foreground"},null,-1)])]),e("h6",Xc,U(is.value),1),e("button",{onClick:us,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...v[113]||(v[113]=[e("i",{class:"fa-solid fa-chevron-right text-sm text-muted-foreground"},null,-1)])])]),e("div",em,[(f(),k(pe,null,Ie(jn,j=>e("div",{key:j,class:"text-center text-xs font-medium text-muted-foreground py-2"},U(j),1)),64))]),e("div",tm,[(f(!0),k(pe,null,Ie(Bn.value,(j,Fe)=>(f(),k("div",{key:Fe,onClick:Le=>bn(j),class:re(["aspect-square flex items-center justify-center text-sm font-medium rounded-lg transition-all",Wn(j)?"bg-primary text-white cursor-pointer":j?"text-muted-foreground hover:bg-muted cursor-pointer":"text-transparent"])},U(j),11,nm))),128))])]),e("div",sm,[e("h6",am,U(zn.value),1),t(Ye)&&Rt.value.length>0?(f(),k("div",lm,[(f(!0),k(pe,null,Ie(Rt.value,j=>(f(),ee(t(Ue),{key:j,variant:"outline","model-value":t(et)===j,"onUpdate:modelValue":Fe=>t(Zt)(Fe?j:""),class:"schedule-slot-toggle-item"},{default:o(()=>[D(U(j),1)]),_:2},1032,["model-value","onUpdate:modelValue"]))),128))])):t(Ye)&&Rt.value.length===0?(f(),k("div",om,U(t(a)("forms.schedule.timeSlots.noSlots")),1)):(f(),k("div",im,U(t(a)("forms.schedule.timeSlots.selectDate")),1))])])])])):N("",!0),n(yl,{appointment:{type:t(We),date:t(Ye),time:t(et),duration:t(Mt)},customer:s.lead.customer,salesperson:t(Lt),team:t(Re),dealership:(ie=t(Re))!=null&&ie.dealership?{name:t(Re).dealership}:null,onUpdate:Wt},null,8,["appointment","customer","salesperson","team","dealership"])])):N("",!0),t(me)&&t(st)==="assign-only"?(f(),k("div",rm,[v[118]||(v[118]=tl('<div class="flex items-start justify-between mb-3"><div class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-blue-600"></i><h5 class="font-semibold text-foreground text-sm">Existing Appointment</h5></div><span class="text-sm font-semibold text-blue-600 uppercase">Scheduled</span></div>',1)),e("div",um,[e("div",null,[v[114]||(v[114]=e("span",{class:"text-muted-foreground"},"Date:",-1)),e("span",dm,U(t($n)(s.lead.scheduledAppointment.start)),1)]),e("div",null,[v[115]||(v[115]=e("span",{class:"text-muted-foreground"},"Time:",-1)),e("span",cm,U(t(ns)(s.lead.scheduledAppointment.start)),1)]),e("div",null,[v[116]||(v[116]=e("span",{class:"text-muted-foreground"},"Type:",-1)),e("span",mm,U(s.lead.scheduledAppointment.type),1)]),e("div",null,[v[117]||(v[117]=e("span",{class:"text-muted-foreground"},"Assigned to:",-1)),e("span",fm,U(s.lead.scheduledAppointment.assignee),1)])]),n(t(J),{label:"Reschedule Appointment",variant:"outline",size:"small",onClick:v[34]||(v[34]=j=>te.value=!0)})])):N("",!0)])):N("",!0)])),t(se)&&!t(_e)?(f(),k("div",pm,[n(t(J),{variant:"secondary",onClick:t(xe)},{default:o(()=>[...v[120]||(v[120]=[D(" Cancel ",-1)])]),_:1},8,["onClick"]),n(t(J),{variant:"primary",disabled:!Yn.value,onClick:On,class:"bg-primary text-white"},{default:o(()=>[D(U(ms.value),1)]),_:1},8,["disabled"])])):N("",!0)])],64)),n(rl,{ref_key:"noteWidgetRef",ref:z,modal:"",show:t(X),item:null,"task-type":"lead","task-id":s.lead.id,onSave:t(vs),onClose:v[35]||(v[35]=j=>X.value=!1),onCancel:v[36]||(v[36]=j=>X.value=!1)},null,8,["show","task-id","onSave"]),n(Wu,{show:t(te),"preselected-assignee":t(Pe).assignee,onConfirm:t(fs),onClose:v[37]||(v[37]=j=>te.value=!1)},null,8,["show","preselected-assignee","onConfirm"]),n(ui,{show:H.value,title:"Assign to salesman","confirm-label":"Assign",onConfirm:ot,onClose:v[38]||(v[38]=j=>H.value=!1)},null,8,["show"]),n(ia,{show:L.value,"task-type":"lead","task-id":s.lead.id,onSave:Rs,onClose:v[39]||(v[39]=j=>L.value=!1)},null,8,["show","task-id"]),n(ra,{show:q.value,mode:"tradein","task-type":"lead","task-id":s.lead.id,"customer-id":s.lead.customerId,onClose:v[40]||(v[40]=j=>q.value=!1),onSave:Es},null,8,["show","task-id","customer-id"]),n(oa,{show:K.value,title:"AI Information Extraction",onClose:v[41]||(v[41]=j=>K.value=!1)},null,8,["show"])])}}},gm={key:0,class:"bg-muted/50 border border-border rounded-lg p-4"},ym={class:"flex justify-between items-start mb-3"},bm={class:"text-xs text-muted-foreground mt-0.5"},hm={key:0},xm={__name:"LeadManagementWidget",props:{lead:{type:Object,required:!0}},emits:["open-purchase-method","open-trade-in"],setup(s,{emit:C}){const a=s,i=C,l=rn(),u=()=>{var P;const R=l.currentLead;return R&&R.id===((P=a.lead)==null?void 0:P.id)?R:a.lead},d={"call-to-verify":()=>{},"call-prospect":()=>{},"complete-conversion":()=>{},reopen:()=>{}},S=fl(as(a,"lead"),d),{handlePostponed:V,handleValidated:A,handleQualified:w,handleCallAttemptLogged:g,handleNoteSaved:y,handleOpenPurchaseMethod:b,handleOpenTradeIn:h,handleAppointmentScheduled:c,handleDisqualified:x,handleReopen:p}=Hr({getLead:u,leadState:S,emit:i}),F=async R=>{var P;(P=a.lead)!=null&&P.id&&await l.loadLeadById(a.lead.id)};return(R,P)=>(f(),ee(pl,{task:s.lead,"hide-title":"","hide-border":""},{"primary-action":o(()=>[t(S).isClosed.value?N("",!0):(f(),ee(gl,{key:0,task:s.lead,"task-type":"lead",onReassigned:F,class:"mb-3"},null,8,["task"])),!t(S).isClosed.value&&t(S).showLQWidget.value?(f(),ee(vm,{key:s.lead.id,lead:s.lead,"show-deadline-banner":t(S).showDeadlineBanner.value,onPostponed:t(V),onValidated:t(A),onQualified:t(w),onDisqualified:t(x),onCallAttemptLogged:t(g),onNoteSaved:t(y),onOpenPurchaseMethod:t(b),onOpenTradeIn:t(h),onAppointmentScheduled:t(c)},null,8,["lead","show-deadline-banner","onPostponed","onValidated","onQualified","onDisqualified","onCallAttemptLogged","onNoteSaved","onOpenPurchaseMethod","onOpenTradeIn","onAppointmentScheduled"])):!t(S).isClosed.value&&t(S).primaryAction.value?(f(),ee(vl,{key:2,action:t(S).primaryAction.value,"color-scheme":t(S).primaryAction.value.colorScheme,onActionClicked:t(S).primaryAction.value.handler},null,8,["action","color-scheme","onActionClicked"])):N("",!0)]),"task-widgets":o(()=>[...P[0]||(P[0]=[])]),"closed-state":o(()=>[t(S).isClosed.value?(f(),k("div",gm,[e("div",ym,[e("div",null,[P[1]||(P[1]=e("h4",{class:"font-bold text-foreground text-sm"},"Lead Closed",-1)),e("p",bm,[D(" Status: "+U(t(S).displayStage.value)+" ",1),s.lead.disqualifyReason?(f(),k("span",hm," - "+U(s.lead.disqualifyReason),1)):N("",!0)])])]),n(t(J),{variant:"primary",size:"small",onClick:t(p),class:"flex items-center gap-2"},{default:o(()=>[...P[2]||(P[2]=[e("span",null,"Reopen Lead",-1),e("i",{class:"fa-solid fa-rotate-left"},null,-1)])]),_:1},8,["onClick"])])):N("",!0)]),_:1},8,["task"]))}};function ts(s,C,a=null){if(!s.value[C]){const i=new Date;s.value[C]=a||i.toISOString().split("T")[0]}}function Js(){return new Date().toISOString().split("T")[0]}const wm={class:"rounded-lg flex flex-col bg-muted"},km={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},Sm={class:"p-4"},Cm={class:"flex justify-between items-start mb-3"},$m={class:"font-bold text-foreground text-sm"},Dm={class:"text-xs text-muted-foreground mt-0.5"},Am={class:"flex gap-3 flex-wrap"},ua={__name:"BaseTaskWidget",props:{title:{type:String,required:!0},description:{type:String,required:!0},colorScheme:{type:Object,required:!1,default:()=>({background:"",border:""})},showPostpone:{type:Boolean,default:!0}},emits:["postpone"],setup(s){return(C,a)=>(f(),k("div",wm,[e("div",km,[e("div",Sm,[e("div",Cm,[e("div",null,[e("h4",$m,U(s.title),1),e("p",Dm,U(s.description),1)]),qt(C.$slots,"badge")]),e("div",Am,[qt(C.$slots,"actions"),s.showPostpone?(f(),k("button",{key:0,onClick:a[0]||(a[0]=i=>C.$emit("postpone")),class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"},[...a[1]||(a[1]=[e("i",{class:"fa-solid fa-clock"},null,-1),e("span",null,"Postpone",-1)])])):N("",!0)]),qt(C.$slots,"survey"),qt(C.$slots,"content")])])]))}},Tm={key:1,class:"space-y-4"},Om={class:"flex items-center justify-between"},Im={class:"space-y-4"},Vm={class:"block text-sm font-medium text-muted-foreground"},Fm=["onUpdate:modelValue","placeholder"],Lm={key:2,class:"space-y-2"},Nm=["onUpdate:modelValue","value"],qm={class:"flex gap-2 flex-wrap justify-end pt-2"},da={__name:"SurveyWidget",props:{questions:{type:Array,required:!0},initialExpanded:{type:Boolean,default:!1}},emits:["survey-completed","survey-refused","not-responding"],setup(s,{emit:C}){const a=s,i=C,l=T(a.initialExpanded),u=T({});ve(()=>a.questions,w=>{const g={};w.forEach(y=>{g[y.key]=""}),u.value=g},{immediate:!0});const d=()=>{i("survey-completed",{...u.value}),A()},S=()=>{i("survey-refused"),A()},V=()=>{i("not-responding"),A()},A=()=>{l.value=!1;const w={};a.questions.forEach(g=>{w[g.key]=""}),u.value=w};return(w,g)=>(f(),k("div",null,[l.value?(f(),k("div",Tm,[e("div",Om,[g[4]||(g[4]=e("h5",{class:"text-sm font-semibold text-foreground"},"Lead Qualification Survey",-1)),e("button",{onClick:g[1]||(g[1]=y=>l.value=!1),class:"text-xs text-muted-foreground hover:text-muted-foreground transition-colors"},[...g[3]||(g[3]=[e("i",{class:"fa-solid fa-chevron-up"},null,-1)])])]),e("div",Im,[(f(!0),k(pe,null,Ie(s.questions,(y,b)=>(f(),k("div",{key:b,class:"space-y-2"},[e("label",Vm,U(y.label),1),y.type==="text"?Se((f(),k("textarea",{key:0,"onUpdate:modelValue":h=>u.value[y.key]=h,placeholder:y.placeholder,rows:"3",class:"input resize-none text-sm py-2 px-3 w-full"},null,8,Fm)),[[ss,u.value[y.key]]]):y.type==="select"?(f(),ee(t(Ot),{key:1,modelValue:u.value[y.key],"onUpdate:modelValue":h=>u.value[y.key]=h},{default:o(()=>[n(t(Dt),{class:"w-full h-10 min-h-10"},{default:o(()=>[n(t(At),{placeholder:"Select an option..."})]),_:1}),n(t(Tt),null,{default:o(()=>[(f(!0),k(pe,null,Ie(y.options,h=>(f(),ee(t(ge),{key:h,value:h},{default:o(()=>[D(U(h),1)]),_:2},1032,["value"]))),128))]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue"])):y.type==="radio"?(f(),k("div",Lm,[(f(!0),k(pe,null,Ie(y.options,h=>(f(),k("label",{key:h,class:"flex items-center text-sm text-muted-foreground cursor-pointer"},[Se(e("input",{type:"radio","onUpdate:modelValue":c=>u.value[y.key]=c,value:h,class:"mr-2 w-4 h-4 text-brand-red focus:ring-brand-red border-gray-300"},null,8,Nm),[[ct,u.value[y.key]]]),D(" "+U(h),1)]))),128))])):N("",!0)]))),128)),e("div",qm,[n(t(J),{label:"Complete Survey",variant:"primary",size:"small",onClick:d,class:"!bg-green-600 !hover:bg-green-700 !text-white !border-green-600"}),n(t(J),{label:"Customer Refused",variant:"outline",size:"small",onClick:S}),n(t(J),{label:"Not Responding",variant:"outline",size:"small",onClick:V})])])])):(f(),k("button",{key:0,onClick:g[0]||(g[0]=y=>l.value=!0),class:"w-full flex items-center justify-between text-sm text-muted-foreground hover:text-foreground py-2 transition-colors"},[...g[2]||(g[2]=[e("span",{class:"font-medium"},"Lead Qualification Survey",-1),e("i",{class:"fa-solid fa-chevron-down text-xs text-muted-foreground"},null,-1)])]))]))}},Um={__name:"OOFBTask",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","review","survey-completed","survey-refused","not-responding","postpone"],setup(s,{emit:C}){const a=s,i=C,l=[{key:"offerStatus",label:"Why hasn't an offer been created?",type:"select",options:["Still gathering information","Awaiting customer response","Vehicle unavailable","Pricing concerns","Other"]},{key:"customerInterest",label:"Is customer still interested?",type:"radio",options:["Yes","Maybe","No"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Any relevant feedback or next steps..."}],u=$(()=>{if(!a.opportunity.createdAt)return 0;const g=new Date(a.opportunity.createdAt),b=Math.abs(new Date-g);return Math.ceil(b/(1e3*60*60*24))}),d=()=>{i("create-offer",a.opportunity)},S=()=>{i("review",a.opportunity)},V=g=>{i("survey-completed",{opportunity:a.opportunity,responses:g})},A=()=>{i("survey-refused",{opportunity:a.opportunity})},w=()=>{i("not-responding",{opportunity:a.opportunity})};return(g,y)=>(f(),ee(ua,{title:"Open Opportunity Feedback",description:`This opportunity has been open for ${u.value} days without any offer. Consider creating an offer to move forward.`,"color-scheme":{background:"bg-orange-50/50",border:"border-orange-100"},onPostpone:y[0]||(y[0]=b=>g.$emit("postpone","oofb"))},{actions:o(()=>[e("button",{onClick:d,class:"bg-orange-600 hover:bg-orange-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"}," Create Offer "),e("button",{onClick:S,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"}," Review Opportunity ")]),survey:o(()=>[n(da,{questions:l,onSurveyCompleted:V,onSurveyRefused:A,onNotResponding:w})]),_:1},8,["description"]))}},Pm={__name:"UFBTask",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","survey-completed","survey-refused","not-responding","postpone"],setup(s,{emit:C}){const a=s,i=C,l=[{key:"lostInterest",label:"Has customer lost interest?",type:"radio",options:["Yes","Maybe","No","Unknown"]},{key:"blockers",label:"What are the blockers?",type:"select",options:["Pricing","Availability","Financing","No response","Changed mind","Found competitor","Other"]},{key:"notes",label:"Additional feedback",type:"text",placeholder:"Describe the situation and any relevant details..."}],u=$(()=>{if(!a.opportunity.createdAt)return 0;const w=new Date(a.opportunity.createdAt),y=Math.abs(new Date-w);return Math.ceil(y/(1e3*60*60*24))}),d=()=>{i("create-offer",a.opportunity)},S=w=>{i("survey-completed",{opportunity:a.opportunity,responses:w})},V=()=>{i("survey-refused",{opportunity:a.opportunity})},A=()=>{i("not-responding",{opportunity:a.opportunity})};return(w,g)=>(f(),ee(ua,{title:"Unsold Feedback",description:`This opportunity has been open for ${u.value} days without any offer. This is a follow-up to ensure progress. Consider creating an offer or closing the opportunity.`,"color-scheme":{background:"bg-red-50/50",border:"border-red-100"},onPostpone:g[0]||(g[0]=y=>w.$emit("postpone","ufb"))},{actions:o(()=>[e("button",{onClick:d,class:"bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"}," Create Offer ")]),survey:o(()=>[n(da,{questions:l,onSurveyCompleted:S,onSurveyRefused:V,onNotResponding:A})]),_:1},8,["description"]))}},Mm={class:"space-y-4"},Rm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Em={class:"flex justify-between items-start mb-1"},jm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Bm={class:"flex flex-wrap gap-3"},zm={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Wm={key:1},_m={__name:"NFUTask",props:{opportunity:{type:Object,required:!0}},emits:["appointment-scheduled","close-as-lost","cancel","postpone"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(null),d=T(null),S=$(()=>{var w;return u.value==="schedule"?!1:u.value==="close-lost"&&((w=d.value)==null?void 0:w.canSubmit)||!1});async function V(){var w;u.value==="schedule"?l("appointment-scheduled",{opportunity:i.opportunity}):u.value==="close-lost"&&((w=d.value)==null||w.submit())}function A(w){l("close-as-lost",{opportunity:i.opportunity,reason:w.reason})}return C({canSubmit:S,submit:V}),(w,g)=>(f(),k("div",Mm,[e("div",Rm,[e("div",Em,[g[4]||(g[4]=e("div",{class:"flex-1"},[e("h4",{class:"font-bold text-foreground text-sm mb-1"},"No Follow-Up Task"),e("p",{class:"text-sm text-muted-foreground"}," 5+ days in negotiation with no future appointment scheduled. Schedule an appointment to move forward or close as lost. ")],-1)),e("button",{onClick:g[0]||(g[0]=y=>w.$emit("postpone","nfu")),class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted ml-4"},[...g[3]||(g[3]=[e("i",{class:"fa-solid fa-clock"},null,-1),e("span",null,"Postpone",-1)])])])]),e("div",jm,[g[7]||(g[7]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Choose Action",-1)),e("div",Bm,[n(t(J),{variant:"outline",onClick:g[1]||(g[1]=y=>u.value="schedule"),class:re(["flex-1",u.value==="schedule"?"border-purple-500 bg-purple-50 text-purple-700":""])},{default:o(()=>[...g[5]||(g[5]=[e("i",{class:"fa-solid fa-calendar-plus mr-2"},null,-1),D(" Schedule Appointment ",-1)])]),_:1},8,["class"]),n(t(J),{variant:"outline",onClick:g[2]||(g[2]=y=>u.value="close-lost"),class:re(["flex-1",u.value==="close-lost"?"border-red-500 bg-red-50 text-red-700":""])},{default:o(()=>[...g[6]||(g[6]=[e("i",{class:"fa-solid fa-xmark mr-2"},null,-1),D(" Close as Lost ",-1)])]),_:1},8,["class"])])]),u.value==="schedule"?(f(),k("div",zm,[...g[8]||(g[8]=[e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Schedule Appointment",-1),e("p",{class:"text-sm text-muted-foreground"}," This will reuse the full schedule appointment form from the Awaiting Appointment stage. ",-1)])])):N("",!0),u.value==="close-lost"?(f(),k("div",Wm,[n(Vs,{ref_key:"closeFormRef",ref:d,item:s.opportunity,"item-type":"opportunity",onClose:A},null,8,["item"])])):N("",!0)]))}},Ym={class:"space-y-6"},Hm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Qm={class:"space-y-6"},Gm={class:"space-y-2"},Jm=["value"],Km={class:"text-sm text-foreground"},Zm={class:"space-y-2"},Xm=["value"],ef={class:"text-sm text-foreground"},tf={class:"space-y-2"},nf=["value"],sf={class:"text-sm text-foreground"},af={key:0},lf={class:"space-y-2"},of=["value"],rf={class:"text-sm text-foreground"},wl={__name:"OFBTask",props:{opportunity:{type:Object,required:!0}},emits:["submit","postpone","cancel"],setup(s,{expose:C,emit:a}){const i=a,l=T({q1:"",q2:"",q3:"",q4:"",q5:""}),u=[{value:"yes",label:"Yes"},{value:"no",label:"No"},{value:"not-yet",label:"Not yet"}],d=[{value:"yes",label:"Yes"},{value:"no",label:"No"}],S=[{value:"yes",label:"Yes"},{value:"no",label:"No"},{value:"maybe",label:"Maybe"}],V=[{value:"send-revised-offer",label:"Send revised offer"},{value:"close-opportunity",label:"Close this opportunity"},{value:"follow-up-later",label:"Follow up later"}],A=$(()=>l.value.q3==="no"),w=$(()=>!(!l.value.q1||!l.value.q2||!l.value.q3||!l.value.q5));return C({submit:()=>{if(!w.value)return;const y={responses:{...l.value},timestamp:new Date().toISOString()};i("submit",y)},isValid:w}),(y,b)=>(f(),k("div",Ym,[e("div",Hm,[b[10]||(b[10]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Questions to ask customer",-1)),e("div",Qm,[e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...b[5]||(b[5]=[D(" 1. Did you review the offer? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",Gm,[(f(),k(pe,null,Ie(u,h=>e("label",{key:h.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q1===h.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":b[0]||(b[0]=c=>l.value.q1=c),type:"radio",value:h.value,class:"shrink-0"},null,8,Jm),[[ct,l.value.q1]]),e("span",Km,U(h.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...b[6]||(b[6]=[D(" 2. Do you have questions about the offer? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",Zm,[(f(),k(pe,null,Ie(d,h=>e("label",{key:h.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q2===h.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":b[1]||(b[1]=c=>l.value.q2=c),type:"radio",value:h.value,class:"shrink-0"},null,8,Xm),[[ct,l.value.q2]]),e("span",ef,U(h.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...b[7]||(b[7]=[D(" 3. Are you interested in this offer? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",tf,[(f(),k(pe,null,Ie(S,h=>e("label",{key:h.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q3===h.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":b[2]||(b[2]=c=>l.value.q3=c),type:"radio",value:h.value,class:"shrink-0"},null,8,nf),[[ct,l.value.q3]]),e("span",sf,U(h.label),1)],2)),64))])]),A.value?(f(),k("div",af,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...b[8]||(b[8]=[D(" 4. If no, why? ",-1),e("span",{class:"text-xs text-muted-foreground ml-1"},"(optional notes)",-1)])]),_:1}),n(t(He),{modelValue:l.value.q4,"onUpdate:modelValue":b[3]||(b[3]=h=>l.value.q4=h),rows:"4",placeholder:"Describe the reason...",class:"w-full"},null,8,["modelValue"])])):N("",!0),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...b[9]||(b[9]=[D(" 5. Next steps? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",lf,[(f(),k(pe,null,Ie(V,h=>e("label",{key:h.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q5===h.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":b[4]||(b[4]=c=>l.value.q5=c),type:"radio",value:h.value,class:"shrink-0"},null,8,of),[[ct,l.value.q5]]),e("span",rf,U(h.label),1)],2)),64))])])])])]))}},uf={class:"border border-border rounded-lg overflow-hidden"},df={class:"font-semibold text-foreground text-sm"},cf={key:0,class:"px-4 pb-4"},mf={__name:"CollapsibleSection",props:{title:{type:String,required:!0},isExpanded:{type:Boolean,default:!1}},emits:["toggle"],setup(s){return(C,a)=>(f(),k("div",uf,[e("button",{onClick:a[0]||(a[0]=i=>C.$emit("toggle")),class:"w-full flex items-center justify-between px-4 py-3 bg-muted/30 hover:bg-muted/50 transition-colors"},[e("h6",df,U(s.title),1),e("i",{class:re(["fa-solid fa-chevron-down text-xs text-muted-foreground transition-transform duration-200",{"rotate-180":s.isExpanded}])},null,2)]),n($s,{name:"expand"},{default:o(()=>[s.isExpanded?(f(),k("div",cf,[qt(C.$slots,"default",{},void 0,!0)])):N("",!0)]),_:3})]))}},Ks=on(mf,[["__scopeId","data-v-b43b0b36"]]),ff={class:"space-y-6"},pf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},vf={class:"space-y-4"},gf={class:"space-y-6 pt-4"},yf={class:"space-y-2"},bf=["value"],hf={class:"text-sm text-foreground"},xf={class:"space-y-2"},wf=["value"],kf={class:"text-sm text-foreground"},Sf={key:0},Cf={class:"space-y-2"},$f=["value"],Df={class:"text-sm text-foreground"},Af={class:"flex items-center gap-2 mt-2"},Tf={class:"space-y-6 pt-4"},Of={class:"flex items-center gap-2"},If=["onClick"],Vf={key:0,class:"text-sm text-muted-foreground ml-2"},Ff={class:"space-y-2"},Lf=["value"],Nf={class:"text-sm text-foreground"},qf={class:"space-y-6 pt-4"},Uf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Pf={class:"space-y-4"},Mf={class:"flex items-center gap-3"},Rf={class:"flex items-center gap-3"},Ef={class:"flex items-center gap-3"},jf={__name:"ContractFeedbackSurvey",props:{opportunity:{type:Object,required:!0}},emits:["submit","cancel"],setup(s,{expose:C,emit:a}){const i=a,l=T({contractExperience:!0,serviceQuality:!1,internalNotes:!1}),u=T({q1:"",q2:"",q3:[],q3Other:!1,q3OtherText:"",q5:null,q6:"",q7:""}),d=T({negativeSatisfaction:!1,documentClarity:!1,poorSupport:!1}),S=[{value:"very-satisfied",label:"Very Satisfied - smooth and quick process"},{value:"satisfied",label:"Satisfied - minor delays but resolved"},{value:"neutral",label:"Neutral - took longer than expected"},{value:"unsatisfied",label:"Unsatisfied - had concerns about terms"},{value:"very-unsatisfied",label:"Very Unsatisfied - significant issues with contract"}],V=[{value:"crystal-clear",label:"Yes, everything was crystal clear"},{value:"mostly-clear",label:"Mostly clear, had a few questions"},{value:"some-confusion",label:"Some confusion, needed clarification"},{value:"not-clear",label:"Not clear at all, had many questions"},{value:"didnt-review",label:"I didn't review it thoroughly"}],A=[{value:"pricing",label:"Pricing or final price discrepancies"},{value:"payment-terms",label:"Payment terms unclear"},{value:"warranty",label:"Warranty or insurance terms"},{value:"delivery-timeline",label:"Delivery timeline not specified"},{value:"trade-in",label:"Trade-in valuation"},{value:"additional-fees",label:"Additional fees or charges"}],w=[{value:"definitely",label:"Definitely (9-10) - Excellent experience"},{value:"probably",label:"Probably (7-8) - Good experience"},{value:"unsure",label:"Unsure (5-6) - Mixed experience"},{value:"unlikely",label:"Unlikely (3-4) - Poor experience"},{value:"not-at-all",label:"Not at all (0-2) - Very negative experience"}],g=$(()=>u.value.q1==="unsatisfied"||u.value.q1==="very-unsatisfied");ve(()=>u.value.q1,h=>{h==="very-unsatisfied"?d.value.negativeSatisfaction=!0:d.value.negativeSatisfaction=!1}),ve(()=>u.value.q2,h=>{h==="not-clear"?d.value.documentClarity=!0:d.value.documentClarity=!1}),ve(()=>u.value.q5,h=>{h===1?d.value.poorSupport=!0:d.value.poorSupport=!1});const y=$(()=>{var h;return!(!u.value.q1||!u.value.q2||g.value&&(!u.value.q3||u.value.q3.length===0)&&!u.value.q3Other||g.value&&u.value.q3Other&&!((h=u.value.q3OtherText)!=null&&h.trim()))});return C({submit:()=>{if(!y.value)return;const h={responses:{...u.value},triggerActions:{...d.value},timestamp:new Date().toISOString()};i("submit",h)},isValid:y}),(h,c)=>{const x=ko("Input");return f(),k("div",ff,[e("div",pf,[c[20]||(c[20]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Post-Contract Customer Experience Survey",-1)),e("div",vf,[n(Ks,{"is-expanded":l.value.contractExperience,onToggle:c[5]||(c[5]=p=>l.value.contractExperience=!l.value.contractExperience),title:"Contract Experience"},{default:o(()=>[e("div",gf,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[13]||(c[13]=[D(" How satisfied are you with the contract signing process? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",yf,[(f(),k(pe,null,Ie(S,p=>e("label",{key:p.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q1===p.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[0]||(c[0]=F=>u.value.q1=F),type:"radio",value:p.value,class:"shrink-0"},null,8,bf),[[ct,u.value.q1]]),e("span",hf,U(p.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[14]||(c[14]=[D(" Were all contract terms and conditions clearly explained to you? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",xf,[(f(),k(pe,null,Ie(V,p=>e("label",{key:p.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q2===p.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[1]||(c[1]=F=>u.value.q2=F),type:"radio",value:p.value,class:"shrink-0"},null,8,wf),[[ct,u.value.q2]]),e("span",kf,U(p.label),1)],2)),64))])]),g.value?(f(),k("div",Sf,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[15]||(c[15]=[D(" Which aspects of the contract concerned you? (Select all that apply) ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",Cf,[(f(),k(pe,null,Ie(A,p=>e("label",{key:p.value,class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors"},[Se(e("input",{"onUpdate:modelValue":c[2]||(c[2]=F=>u.value.q3=F),type:"checkbox",value:p.value,class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,8,$f),[[$t,u.value.q3]]),e("span",Df,U(p.label),1)])),64)),e("div",Af,[Se(e("input",{"onUpdate:modelValue":c[3]||(c[3]=p=>u.value.q3Other=p),type:"checkbox",class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,512),[[$t,u.value.q3Other]]),c[16]||(c[16]=e("span",{class:"text-sm text-foreground"},"Other:",-1)),u.value.q3Other?(f(),ee(x,{key:0,modelValue:u.value.q3OtherText,"onUpdate:modelValue":c[4]||(c[4]=p=>u.value.q3OtherText=p),placeholder:"Specify other concern",class:"flex-1"},null,8,["modelValue"])):N("",!0)])])])):N("",!0)])]),_:1},8,["is-expanded"]),n(Ks,{"is-expanded":l.value.serviceQuality,onToggle:c[7]||(c[7]=p=>l.value.serviceQuality=!l.value.serviceQuality),title:"Service Quality"},{default:o(()=>[e("div",Tf,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[17]||(c[17]=[D(" How well did your salesperson support you through the contract process? ",-1)])]),_:1}),e("div",Of,[(f(),k(pe,null,Ie(5,p=>e("button",{key:p,onClick:F=>u.value.q5=p,class:re(["text-2xl transition-colors",u.value.q5>=p?"text-yellow-500":"text-gray-300"])}," ⭐ ",10,If)),64)),u.value.q5?(f(),k("span",Vf,U(u.value.q5)+" "+U(u.value.q5===1?"star":"stars"),1)):N("",!0)])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[18]||(c[18]=[D(" How likely are you to recommend our dealership to friends and family? ",-1)])]),_:1}),e("div",Ff,[(f(),k(pe,null,Ie(w,p=>e("label",{key:p.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q6===p.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[6]||(c[6]=F=>u.value.q6=F),type:"radio",value:p.value,class:"shrink-0"},null,8,Lf),[[ct,u.value.q6]]),e("span",Nf,U(p.label),1)],2)),64))])])])]),_:1},8,["is-expanded"]),n(Ks,{"is-expanded":l.value.internalNotes,onToggle:c[9]||(c[9]=p=>l.value.internalNotes=!l.value.internalNotes),title:"Internal Notes"},{default:o(()=>[e("div",qf,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...c[19]||(c[19]=[D(" Notes for follow-up actions: ",-1),e("span",{class:"text-xs text-muted-foreground ml-1"},"(Private - only for internal staff)",-1)])]),_:1}),n(t(He),{modelValue:u.value.q7,"onUpdate:modelValue":c[8]||(c[8]=p=>u.value.q7=p),rows:"4",placeholder:"Add any notes or instructions for follow-up actions...",class:"w-full"},null,8,["modelValue"])])])]),_:1},8,["is-expanded"])])]),e("div",Uf,[c[27]||(c[27]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Trigger Actions (Email Notifications)",-1)),e("div",Pf,[e("div",Mf,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-negative-satisfaction",modelValue:d.value.negativeSatisfaction,"onUpdate:modelValue":c[10]||(c[10]=p=>d.value.negativeSatisfaction=p)},null,8,["modelValue"]),c[21]||(c[21]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Sales Manager + Regional Manager ",-1))]),_:1}),c[22]||(c[22]=e("span",{class:"text-xs text-muted-foreground"},"(Q1 = Very Unsatisfied)",-1))]),e("div",Rf,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-document-clarity",modelValue:d.value.documentClarity,"onUpdate:modelValue":c[11]||(c[11]=p=>d.value.documentClarity=p)},null,8,["modelValue"]),c[23]||(c[23]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Compliance/Legal team ",-1))]),_:1}),c[24]||(c[24]=e("span",{class:"text-xs text-muted-foreground"},"(Q2 = Not clear at all)",-1))]),e("div",Ef,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-poor-support",modelValue:d.value.poorSupport,"onUpdate:modelValue":c[12]||(c[12]=p=>d.value.poorSupport=p)},null,8,["modelValue"]),c[25]||(c[25]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Sales Manager for coaching ",-1))]),_:1}),c[26]||(c[26]=e("span",{class:"text-xs text-muted-foreground"},"(Q5 = 1 star)",-1))])])])])}}},Bf={class:"rounded-lg flex flex-col bg-muted"},zf={class:"pt-1 px-1"},Wf={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},_f={class:"p-6"},Yf={class:"mb-3"},Hf={class:"flex justify-between items-start"},Qf={class:"flex-1"},Gf={class:"text-sm text-muted-foreground mt-0.5"},Jf={class:"flex flex-wrap gap-3 items-center"},Kf={key:0,class:"px-4 py-4 space-y-4"},Zf={class:"flex justify-between items-center pt-3"},Xf={class:"flex gap-2"},ep={__name:"CFBTask",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["close","survey-submitted","survey-cancelled","postpone"],setup(s,{emit:C}){const a=s,i=C,l=Bt(),u=Jt(),d=T(!1),S=T(null),V=$(()=>{var h;return((h=S.value)==null?void 0:h.isValid)||!1}),A=$(()=>{var p;if(!((p=a.opportunity)!=null&&p.contractDate))return 0;const h=new Date(a.opportunity.contractDate),x=Math.abs(new Date-h);return Math.ceil(x/(1e3*60*60*24))}),w=async h=>{var c,x,p,F;try{const R=a.opportunity,{responses:P,triggerActions:z}=h;await l.addActivity(R.id,{type:"contract-feedback-survey",user:((c=u.currentUser)==null?void 0:c.name)||"You",action:"completed post-contract customer experience survey",content:"Post-Contract Customer Experience Survey completed",data:{responses:P,triggerActions:z,timestamp:h.timestamp},timestamp:h.timestamp});const H=[];z.negativeSatisfaction&&H.push(l.addActivity(R.id,{type:"survey-trigger",user:((x=u.currentUser)==null?void 0:x.name)||"You",action:"triggered email notification",content:"Email sent to Sales Manager + Regional Manager (Negative satisfaction)",data:{trigger:"negative-satisfaction",recipients:["Sales Manager","Regional Manager"],surveyResponse:P.q1},timestamp:new Date().toISOString()})),z.documentClarity&&H.push(l.addActivity(R.id,{type:"survey-trigger",user:((p=u.currentUser)==null?void 0:p.name)||"You",action:"triggered email notification",content:"Email sent to Compliance/Legal team (Document clarity issues)",data:{trigger:"document-clarity",recipients:["Compliance/Legal team"],surveyResponse:P.q2},timestamp:new Date().toISOString()})),z.poorSupport&&H.push(l.addActivity(R.id,{type:"survey-trigger",user:((F=u.currentUser)==null?void 0:F.name)||"You",action:"triggered email notification",content:"Email sent to Sales Manager for coaching (Poor salesperson support)",data:{trigger:"poor-support",recipients:["Sales Manager"],surveyResponse:P.q5},timestamp:new Date().toISOString()})),await Promise.all(H),d.value=!1,i("survey-submitted",{opportunity:R,surveyData:h})}catch(R){console.error("Failed to submit survey:",R)}},g=()=>{S.value&&S.value.submit()},y=()=>{d.value=!1,i("survey-cancelled",{opportunity:a.opportunity})},b=(h,c)=>{d.value=!1,c&&(d.value=!0)};return(h,c)=>(f(),k("div",Bf,[e("div",zf,[e("div",Wf,[e("div",_f,[e("div",Yf,[e("div",Hf,[e("div",Qf,[c[2]||(c[2]=e("h4",{class:"font-bold text-foreground text-sm"},"Contract Feedback",-1)),e("p",Gf," Contract was signed "+U(A.value)+" days ago. Follow up on delivery status and collect customer feedback. ",1)])])]),e("div",Jf,[n(t(Ue),{variant:"outline","model-value":d.value,"onUpdate:modelValue":c[0]||(c[0]=x=>b("survey",x)),class:"outcome-toggle-item"},{default:o(()=>[...c[3]||(c[3]=[e("i",{class:"fa-solid fa-clipboard-list"},null,-1),e("span",null,"Complete Survey",-1)])]),_:1},8,["model-value"])])])])]),d.value?(f(),k("div",Kf,[n(jf,{ref_key:"surveyRef",ref:S,opportunity:s.opportunity,onSubmit:w,onCancel:y},null,8,["opportunity"]),e("div",Zf,[n(t(J),{variant:"secondary",onClick:c[1]||(c[1]=x=>h.$emit("postpone","cfb")),class:"flex items-center gap-2"},{default:o(()=>[...c[4]||(c[4]=[e("i",{class:"fa-solid fa-clock"},null,-1),e("span",null,"Postpone",-1)])]),_:1}),e("div",Xf,[n(t(J),{variant:"secondary",onClick:y},{default:o(()=>[...c[5]||(c[5]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!V.value,onClick:g},{default:o(()=>[...c[6]||(c[6]=[D(" Submit Survey ",-1)])]),_:1},8,["disabled"])])])])):N("",!0)]))}},tp={class:"space-y-6"},np={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},sp={class:"space-y-6"},ap={class:"space-y-2"},lp=["value"],op={class:"text-sm text-foreground"},ip={class:"space-y-2"},rp=["value"],up={class:"text-sm text-foreground"},dp={key:0},cp={class:"space-y-2"},mp=["value"],fp={class:"text-sm text-foreground"},pp={class:"flex items-center gap-2"},vp=["onClick"],gp={key:0,class:"text-sm text-muted-foreground ml-2"},yp={class:"space-y-2"},bp=["value"],hp={class:"text-sm text-foreground"},xp={class:"flex items-center gap-2 mt-2"},wp={class:"space-y-2"},kp=["value"],Sp={class:"text-sm text-foreground"},Cp={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},$p={class:"space-y-4"},Dp={class:"flex items-center gap-3"},Ap={class:"flex items-center gap-3"},Tp={class:"flex items-center gap-3"},Op={class:"flex items-center gap-3"},Ip={__name:"PostDeliverySurvey",props:{opportunity:{type:Object,required:!0}},emits:["submit","cancel"],setup(s,{expose:C,emit:a}){const i=a,l=T({q1:"",q2:"",q3:"",q4:"",q5:null,q6:[],q6Other:!1,q6OtherText:"",q7:"",q8:""}),u=T({negativeSatisfaction:!1,issuesReported:!1,deliveryDelay:!1,highNPS:!1}),d=[{value:"very-satisfied",label:"Very Satisfied"},{value:"satisfied",label:"Satisfied"},{value:"neutral",label:"Neutral"},{value:"unsatisfied",label:"Unsatisfied"},{value:"very-unsatisfied",label:"Very Unsatisfied"}],S=[{value:"perfect",label:"Yes, perfect condition"},{value:"acceptable",label:"Yes, acceptable"},{value:"minor-issues",label:"There are minor issues"},{value:"major-issues",label:"There are major issues"}],V=[{value:"on-time",label:"Yes, on time"},{value:"early",label:"Yes, early"},{value:"delayed-minor",label:"No, delayed (minor - 1-3 days)"},{value:"delayed-major",label:"No, delayed (major - more than 3 days)"}],A=[{value:"keys",label:"Vehicle keys"},{value:"manual",label:"Owner's manual"},{value:"registration",label:"Registration documents"},{value:"warranty",label:"Service warranty information"},{value:"insurance",label:"Insurance documents"}],w=[{value:"definitely-yes",label:"Definitely Yes"},{value:"probably-yes",label:"Probably Yes"},{value:"not-sure",label:"Not Sure"},{value:"probably-not",label:"Probably Not"},{value:"definitely-not",label:"Definitely Not"}],g=$(()=>l.value.q2==="minor-issues"||l.value.q2==="major-issues");ve(()=>l.value.q1,h=>{h==="very-unsatisfied"||h==="unsatisfied"?u.value.negativeSatisfaction=!0:u.value.negativeSatisfaction=!1}),ve(()=>l.value.q3,h=>{h&&h.trim().length>0?u.value.issuesReported=!0:u.value.issuesReported=!1}),ve(()=>l.value.q4,h=>{h==="delayed-major"?u.value.deliveryDelay=!0:u.value.deliveryDelay=!1}),ve(()=>l.value.q7,h=>{h==="definitely-yes"?u.value.highNPS=!0:u.value.highNPS=!1});const y=$(()=>{var x,p;if(!l.value.q1||!l.value.q2||g.value&&!((x=l.value.q3)!=null&&x.trim()))return!1;const h=l.value.q6&&l.value.q6.length>0,c=l.value.q6Other&&((p=l.value.q6OtherText)==null?void 0:p.trim());return!(!h&&!c)});return C({submit:()=>{if(!y.value)return;const h={responses:{...l.value},triggerActions:{...u.value},timestamp:new Date().toISOString()};i("submit",h)},isValid:y}),(h,c)=>(f(),k("div",tp,[e("div",np,[c[22]||(c[22]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Post-Delivery Customer Satisfaction Survey",-1)),e("div",sp,[e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[13]||(c[13]=[D(" How satisfied are you with your new vehicle delivery experience? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",ap,[(f(),k(pe,null,Ie(d,x=>e("label",{key:x.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q1===x.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[0]||(c[0]=p=>l.value.q1=p),type:"radio",value:x.value,class:"shrink-0"},null,8,lp),[[ct,l.value.q1]]),e("span",op,U(x.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[14]||(c[14]=[D(" Is the vehicle in the condition you expected? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",ip,[(f(),k(pe,null,Ie(S,x=>e("label",{key:x.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q2===x.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[1]||(c[1]=p=>l.value.q2=p),type:"radio",value:x.value,class:"shrink-0"},null,8,rp),[[ct,l.value.q2]]),e("span",up,U(x.label),1)],2)),64))])]),g.value?(f(),k("div",dp,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[15]||(c[15]=[D(" Please describe the issues you found: ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(He),{modelValue:l.value.q3,"onUpdate:modelValue":c[2]||(c[2]=x=>l.value.q3=x),rows:"4",placeholder:"Describe the issues...",class:"w-full"},null,8,["modelValue"])])):N("",!0),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[16]||(c[16]=[D(" Was the vehicle delivered on the scheduled date? ",-1)])]),_:1}),e("div",cp,[(f(),k(pe,null,Ie(V,x=>e("label",{key:x.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q4===x.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[3]||(c[3]=p=>l.value.q4=p),type:"radio",value:x.value,class:"shrink-0"},null,8,mp),[[ct,l.value.q4]]),e("span",fp,U(x.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[17]||(c[17]=[D(" How would you rate the professionalism of our sales team during delivery? ",-1)])]),_:1}),e("div",pp,[(f(),k(pe,null,Ie(5,x=>e("button",{key:x,onClick:p=>l.value.q5=x,class:re(["text-2xl transition-colors",l.value.q5>=x?"text-yellow-500":"text-gray-300"])}," ⭐ ",10,vp)),64)),l.value.q5?(f(),k("span",gp,U(l.value.q5)+" "+U(l.value.q5===1?"star":"stars"),1)):N("",!0)])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[18]||(c[18]=[D(" Did you receive all the required items? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",yp,[(f(),k(pe,null,Ie(A,x=>e("label",{key:x.value,class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors"},[Se(e("input",{"onUpdate:modelValue":c[4]||(c[4]=p=>l.value.q6=p),type:"checkbox",value:x.value,class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,8,bp),[[$t,l.value.q6]]),e("span",hp,U(x.label),1)])),64)),e("div",xp,[Se(e("input",{"onUpdate:modelValue":c[5]||(c[5]=x=>l.value.q6Other=x),type:"checkbox",class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,512),[[$t,l.value.q6Other]]),c[19]||(c[19]=e("span",{class:"text-sm text-foreground"},"Other:",-1)),l.value.q6Other?(f(),ee(t(Oe),{key:0,modelValue:l.value.q6OtherText,"onUpdate:modelValue":c[6]||(c[6]=x=>l.value.q6OtherText=x),placeholder:"Specify other item",class:"flex-1"},null,8,["modelValue"])):N("",!0)])])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[20]||(c[20]=[D(" Would you recommend our dealership to friends and family? ",-1)])]),_:1}),e("div",wp,[(f(),k(pe,null,Ie(w,x=>e("label",{key:x.value,class:re(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",l.value.q7===x.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[Se(e("input",{"onUpdate:modelValue":c[7]||(c[7]=p=>l.value.q7=p),type:"radio",value:x.value,class:"shrink-0"},null,8,kp),[[ct,l.value.q7]]),e("span",Sp,U(x.label),1)],2)),64))])]),e("div",null,[n(t(W),{class:"form-label mb-2"},{default:o(()=>[...c[21]||(c[21]=[D(" Internal notes for follow-up actions: ",-1),e("span",{class:"text-xs text-muted-foreground ml-1"},"(Private - only for internal staff)",-1)])]),_:1}),n(t(He),{modelValue:l.value.q8,"onUpdate:modelValue":c[8]||(c[8]=x=>l.value.q8=x),rows:"4",placeholder:"Add internal notes...",class:"w-full"},null,8,["modelValue"])])])]),e("div",Cp,[c[31]||(c[31]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Trigger Actions (Email Notifications)",-1)),e("div",$p,[e("div",Dp,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-negative-satisfaction",modelValue:u.value.negativeSatisfaction,"onUpdate:modelValue":c[9]||(c[9]=x=>u.value.negativeSatisfaction=x)},null,8,["modelValue"]),c[23]||(c[23]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Sales Manager + Branch Manager ",-1))]),_:1}),c[24]||(c[24]=e("span",{class:"text-xs text-muted-foreground"},"(Q1 = Very Unsatisfied/Unsatisfied)",-1))]),e("div",Ap,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-issues",modelValue:u.value.issuesReported,"onUpdate:modelValue":c[10]||(c[10]=x=>u.value.issuesReported=x)},null,8,["modelValue"]),c[25]||(c[25]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Service Department ",-1))]),_:1}),c[26]||(c[26]=e("span",{class:"text-xs text-muted-foreground"},"(Q3 = Issues reported)",-1))]),e("div",Tp,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-delay",modelValue:u.value.deliveryDelay,"onUpdate:modelValue":c[11]||(c[11]=x=>u.value.deliveryDelay=x)},null,8,["modelValue"]),c[27]||(c[27]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Delivery Coordinator ",-1))]),_:1}),c[28]||(c[28]=e("span",{class:"text-xs text-muted-foreground"},"(Q4 = Delayed major)",-1))]),e("div",Op,[n(t(W),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[n(t(Ht),{id:"trigger-nps",modelValue:u.value.highNPS,"onUpdate:modelValue":c[12]||(c[12]=x=>u.value.highNPS=x)},null,8,["modelValue"]),c[29]||(c[29]=e("span",{class:"text-sm font-medium text-foreground"}," ✅ Email to Marketing ",-1))]),_:1}),c[30]||(c[30]=e("span",{class:"text-xs text-muted-foreground"},"(Q7 = Definitely Yes)",-1))])])])]))}},Vp={class:"rounded-lg flex flex-col bg-muted"},Fp={class:"pt-1 px-1"},Lp={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Np={class:"p-6"},qp={class:"mb-3"},Up={class:"flex justify-between items-start"},Pp={class:"flex-1"},Mp={class:"font-bold text-foreground text-sm"},Rp={class:"text-sm text-muted-foreground mt-0.5"},Ep={class:"flex flex-wrap gap-3 items-center"},jp={key:0,class:"px-4 py-4 space-y-4"},Bp={class:"flex justify-end gap-2 pt-3"},zp={key:1,class:"px-4 py-4 space-y-4"},Wp={class:"space-y-4"},_p=["min"],Yp={class:"flex justify-end gap-2 pt-3"},Hp={__name:"DFBTask",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["close","survey-submitted","survey-cancelled","postpone","reschedule-delivery"],setup(s,{emit:C}){const a=s,i=C,l=Bt(),u=Jt(),d=T(!1),S=T(!1),V=T(null),A=$(()=>Za(a.opportunity,a.activities)),w=$(()=>A.value==="Awaiting Delivery"),g=$(()=>{var P;return((P=V.value)==null?void 0:P.isValid)||!1}),y=T({newDeliveryDate:"",reason:""}),b=$(()=>{const P=new Date;return P.setDate(P.getDate()+1),P.toISOString().split("T")[0]}),h=$(()=>!!y.value.newDeliveryDate),c=async P=>{var z,H,L,q,K;try{const _=a.opportunity,{responses:Q,triggerActions:ue}=P;await l.addActivity(_.id,{type:"post-delivery-survey",user:((z=u.currentUser)==null?void 0:z.name)||"You",action:"completed post-delivery customer satisfaction survey",content:"Post-Delivery Customer Satisfaction Survey completed",data:{responses:Q,triggerActions:ue,timestamp:P.timestamp},timestamp:P.timestamp});const ne=[];ue.negativeSatisfaction&&ne.push(l.addActivity(_.id,{type:"survey-trigger",user:((H=u.currentUser)==null?void 0:H.name)||"You",action:"triggered email notification",content:"Email sent to Sales Manager + Branch Manager (Negative satisfaction)",data:{trigger:"negative-satisfaction",recipients:["Sales Manager","Branch Manager"],surveyResponse:Q.q1},timestamp:new Date().toISOString()})),ue.issuesReported&&ne.push(l.addActivity(_.id,{type:"survey-trigger",user:((L=u.currentUser)==null?void 0:L.name)||"You",action:"triggered email notification",content:"Email sent to Service Department (Issues reported)",data:{trigger:"issues-reported",recipients:["Service Department"],issueDescription:Q.q3},timestamp:new Date().toISOString()})),ue.deliveryDelay&&ne.push(l.addActivity(_.id,{type:"survey-trigger",user:((q=u.currentUser)==null?void 0:q.name)||"You",action:"triggered email notification",content:"Email sent to Delivery Coordinator (Major delivery delay)",data:{trigger:"delivery-delay",recipients:["Delivery Coordinator"],surveyResponse:Q.q4},timestamp:new Date().toISOString()})),ue.highNPS&&ne.push(l.addActivity(_.id,{type:"survey-trigger",user:((K=u.currentUser)==null?void 0:K.name)||"You",action:"triggered email notification",content:"Email sent to Marketing (High NPS - Definitely Yes)",data:{trigger:"high-nps",recipients:["Marketing"],surveyResponse:Q.q7},timestamp:new Date().toISOString()})),await Promise.all(ne),d.value=!1,i("survey-submitted",{opportunity:_,surveyData:P})}catch(_){console.error("Failed to submit survey:",_)}},x=()=>{V.value&&V.value.submit()},p=()=>{d.value=!1,i("survey-cancelled",{opportunity:a.opportunity})},F=()=>{S.value=!1,y.value={newDeliveryDate:"",reason:""}},R=async()=>{try{i("reschedule-delivery",{opportunity:a.opportunity,newDeliveryDate:y.value.newDeliveryDate,reason:y.value.reason}),S.value=!1,y.value={newDeliveryDate:"",reason:""}}catch(P){console.error("Failed to reschedule delivery:",P)}};return(P,z)=>(f(),k("div",Vp,[e("div",Fp,[e("div",Lp,[e("div",Np,[e("div",qp,[e("div",Up,[e("div",Pp,[e("h4",Mp,U(w.value?"Delivery Delay Feedback":"Post-Delivery Customer Satisfaction Survey"),1),e("p",Rp,U(w.value?"Get feedback on delivery delay and check progress":"Collect feedback from the customer about their delivery experience"),1)]),e("button",{onClick:z[0]||(z[0]=H=>P.$emit("postpone","dfb")),class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted ml-4"},[...z[5]||(z[5]=[e("i",{class:"fa-solid fa-clock"},null,-1),e("span",null,"Postpone",-1)])])])]),e("div",Ep,[n(t(Ue),{variant:"outline","model-value":d.value,"onUpdate:modelValue":z[1]||(z[1]=H=>d.value=H),class:"outcome-toggle-item"},{default:o(()=>[...z[6]||(z[6]=[e("i",{class:"fa-solid fa-clipboard-list"},null,-1),e("span",null,"Complete Survey",-1)])]),_:1},8,["model-value"]),w.value?(f(),ee(t(Ue),{key:0,variant:"outline","model-value":S.value,"onUpdate:modelValue":z[2]||(z[2]=H=>S.value=H),class:"outcome-toggle-item"},{default:o(()=>[...z[7]||(z[7]=[e("i",{class:"fa-solid fa-calendar-days"},null,-1),e("span",null,"Reschedule Delivery",-1)])]),_:1},8,["model-value"])):N("",!0)])])])]),d.value?(f(),k("div",jp,[n(Ip,{ref_key:"surveyRef",ref:V,opportunity:s.opportunity,onSubmit:c,onCancel:p},null,8,["opportunity"]),e("div",Bp,[n(t(J),{variant:"secondary",onClick:p},{default:o(()=>[...z[8]||(z[8]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!g.value,onClick:x},{default:o(()=>[...z[9]||(z[9]=[D(" Submit Survey ",-1)])]),_:1},8,["disabled"])])])):N("",!0),S.value?(f(),k("div",zp,[e("div",Wp,[e("div",null,[z[10]||(z[10]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"New Delivery Date",-1)),Se(e("input",{"onUpdate:modelValue":z[3]||(z[3]=H=>y.value.newDeliveryDate=H),type:"date",min:b.value,class:"w-full px-3 py-2 border border-border rounded-md bg-background text-foreground"},null,8,_p),[[ss,y.value.newDeliveryDate]])]),e("div",null,[z[11]||(z[11]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Reason (Optional)",-1)),Se(e("textarea",{"onUpdate:modelValue":z[4]||(z[4]=H=>y.value.reason=H),rows:"3",class:"w-full px-3 py-2 border border-border rounded-md bg-background text-foreground",placeholder:"Reason for rescheduling..."},null,512),[[ss,y.value.reason]])])]),e("div",Yp,[n(t(J),{variant:"secondary",onClick:F},{default:o(()=>[...z[12]||(z[12]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!h.value,onClick:R},{default:o(()=>[...z[13]||(z[13]=[D(" Reschedule Delivery ",-1)])]),_:1},8,["disabled"])])])):N("",!0)]))}},Qp={__name:"AbandonedTask",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["reopen","close-lost","requalify","survey-completed","survey-refused","not-responding"],setup(s,{emit:C}){const a=s,i=C;Os();const l=[{key:"abandonmentReason",label:"Why was this opportunity abandoned?",type:"select",options:["No response from customer","Customer lost interest","Competitor won","Budget constraints","Timing issues","Other"]},{key:"customerStatus",label:"Customer status?",type:"radio",options:["Still interested","Lost interest","Bought elsewhere","Unknown"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Document any relevant information about why this opportunity was abandoned..."}],u=$(()=>{const y=a.opportunity.lastActivity||a.opportunity.createdAt;if(!y)return 0;const b=new Date(y),c=Math.abs(new Date-b);return Math.ceil(c/(1e3*60*60*24))}),d=()=>{i("reopen",a.opportunity)},S=()=>{i("close-lost",{opportunity:a.opportunity,reason:"Abandoned - no activity for extended period"})},V=()=>{i("requalify",a.opportunity)},A=y=>{i("survey-completed",{opportunity:a.opportunity,responses:y})},w=()=>{i("survey-refused",{opportunity:a.opportunity})},g=()=>{i("not-responding",{opportunity:a.opportunity})};return(y,b)=>(f(),ee(ua,{title:"Opportunity Abandoned",description:`This opportunity has been inactive for ${u.value} days. Consider reopening it or closing as lost.`,"color-scheme":{background:"bg-muted/50",border:"border"}},{actions:o(()=>[e("button",{onClick:d,class:"bg-gray-600 hover:bg-gray-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"},[...b[0]||(b[0]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),D(" Reopen Opportunity ",-1)])]),e("button",{onClick:S,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"},[...b[1]||(b[1]=[e("i",{class:"fa-solid fa-xmark"},null,-1),D(" Close as Lost ",-1)])]),e("button",{onClick:V,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"},[...b[2]||(b[2]=[e("i",{class:"fa-solid fa-arrow-left"},null,-1),D(" Requalify as Lead ",-1)])])]),survey:o(()=>[n(da,{questions:l,onSurveyCompleted:A,onSurveyRefused:w,onNotResponding:g})]),_:1},8,["description"]))}},Gp={OOFB:Um,UFB:Pm,NFU:_m,OFB:wl,CFB:ep,DFB:Hp,ABANDONED:Qp};function Jp(s,C,a,i,l){const u=$(()=>{const y=ws(s),b=ws(C),h=ws(a);return{opportunity:y,scheduledAppointment:b,activities:h,hasOffers:y.offers&&y.offers.length>0||(h==null?void 0:h.some(c=>c.type==="offer"))||!1,stage:y.displayStage||y.stage,deliverySubstatus:y.deliverySubstatus||null,formatDateTime:l,hasActiveTaskWidget:!1}}),d=$(()=>{const y=u.value,b=ei(y.stage,y);if(!b)return null;const h=Gp[b];return h?{type:b,component:h,props:{opportunity:y.opportunity,appointment:y.scheduledAppointment,activities:y.activities}}:null}),S=$(()=>({...u.value,hasActiveTaskWidget:!!d.value})),V=$(()=>{const y=S.value,b=ti(y.stage,y);if(!b)return null;const h=i[b.key];return{...b,handler:h||(()=>{})}}),A=$(()=>{var c;const y=S.value,b=ni(y.stage,y),h=(c=V.value)==null?void 0:c.key;return b.filter(x=>x.key!==h).map(x=>{const p=i[x.key];return{...x,handler:p||(()=>{})}})}),w=$(()=>{const y=u.value;return si(y.stage)}),g=$(()=>!d.value||!d.value.type?"":ai(d.value.type));return{primaryAction:V,secondaryActions:A,activeTaskWidget:d,taskWidgetTitle:g,isClosed:w}}const Kp={name:"MotorK Dealership",address:{street:"123 Automotive Boulevard",city:"Berlin",postalCode:"10115",country:"Germany"},phone:"+49 30 12345678",email:"info@motork.de",vatNumber:"DE123456789",registrationNumber:"HRB 12345 B",website:"www.motork.de"},Zp=[{id:"contract-classic",name:"Contract - Classic",type:"contract",style:"classic",description:"Detailed contract with comprehensive information and legal sections"},{id:"contract-express",name:"Contract - Express",type:"contract",style:"express",description:"Streamlined contract with essential information"},{id:"offer-classic",name:"Offer - Classic",type:"offer",style:"classic",description:"Detailed offer with VAT table, trade-in section, and vehicle images"},{id:"offer-express",name:"Offer - Express",type:"offer",style:"express",description:"Simplified offer with condensed layout for stock vehicles"}];function Zs(){const s=`%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/MediaBox [0 0 612 792]
/Contents 4 0 R
/Resources <<
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
>>
>>
>>
endobj
4 0 obj
<<
/Length 44
>>
stream
BT
/F1 12 Tf
100 700 Td
(Mock PDF Document) Tj
ET
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000306 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
390
%%EOF`;return new Blob([s],{type:"application/pdf"})}class kl extends So{constructor(){super([])}async generatePDF(C){await new Promise(u=>setTimeout(u,1500));const a=`pdf-${Date.now()}`,i=Zs(),l=URL.createObjectURL(i);return{id:a,url:l,blob:i,template:C.template,language:C.language,generatedAt:new Date().toISOString(),expiresAt:new Date(Date.now()+24*60*60*1e3).toISOString()}}async previewPDF(C){await new Promise(l=>setTimeout(l,1200));const a=Zs();return{previewUrl:URL.createObjectURL(a),blob:a,template:C.template,language:C.language,expiresAt:new Date(Date.now()+60*60*1e3).toISOString()}}async getTemplates(){return await new Promise(C=>setTimeout(C,300)),[...Zp]}async sendPDFByEmail(C,a){return await new Promise(i=>setTimeout(i,800)),{success:!0,pdfId:C,sentTo:a.to,sentAt:new Date().toISOString()}}async downloadPDF(C){return await new Promise(a=>setTimeout(a,500)),Zs()}async getSellerInfo(){return await new Promise(C=>setTimeout(C,200)),{...Kp}}}const Xp=Object.freeze(Object.defineProperty({__proto__:null,ContractRepository:kl},Symbol.toStringTag,{value:"Module"})),Nn=new kl,Ha=new Co,Qa=new $o;class ev{async prepareContractData(C,a={}){if(!C)throw new Error("Opportunity is required");const i=await Nn.getSellerInfo(),l=Ha.findByIdSync(C.customerId);if(!l)throw new Error("Customer not found");const u=await Qa.findAllByOpportunityId(C.id),d=u.find(b=>b.type==="trade-in"),S=u.find(b=>b.type==="financing"),V=C.selectedVehicle||C.vehicle||C.requestedCar,A=this.formatPricing(C,null,d),w=this.formatPaymentTerms(S,C),g=this.getEquipment(V);return{seller:{name:i.name,address:i.address,phone:i.phone,email:i.email,vatNumber:i.vatNumber,registrationNumber:i.registrationNumber,website:i.website},buyer:{name:l.name,email:l.email,phone:l.phone,address:l.address||"",company:l.company||null},vehicle:V?{brand:V.brand,model:V.model,year:V.year,fuelType:V.fuelType,gearType:V.gearType,kilometers:V.kilometers||0,vin:V.vin||"",image:V.image||null,color:V.color||"",status:V.status||"New"}:null,pricing:A,paymentTerms:w,equipment:g,termsAndConditions:a.includeTermsAndConditions?this.getTermsAndConditions(a.language):null,contractDate:C.contractDate||new Date().toISOString().split("T")[0],signatureArea:!0}}async prepareOfferData(C,a,i={}){if(!C)throw new Error("Opportunity is required");if(!a)throw new Error("Offer is required");const l=await Nn.getSellerInfo(),u=Ha.findByIdSync(C.customerId);if(!u)throw new Error("Customer not found");const d=await Qa.findAllByOpportunityId(C.id),S=d.find(h=>h.type==="trade-in"),V=d.find(h=>h.type==="financing"),A=a.data||a.vehicle||a,w=this.formatPricing(C,a,S),g=this.formatPaymentTerms(V,C),y=this.getEquipment(A);return{seller:{name:l.name,address:l.address,phone:l.phone,email:l.email,vatNumber:l.vatNumber,registrationNumber:l.registrationNumber,website:l.website},buyer:{name:u.name,email:u.email,phone:u.phone,address:u.address||"",company:u.company||null},vehicle:{brand:A.brand,model:A.model,year:A.year,fuelType:A.fuelType,gearType:A.gearType,kilometers:A.kilometers||0,vin:A.vin||"",image:A.image||null,color:A.color||"",status:A.status||"New"},pricing:w,paymentTerms:g,equipment:y,termsAndConditions:i.includeTermsAndConditions?this.getTermsAndConditions(i.language):null,contractDate:null,signatureArea:!1}}formatPricing(C,a=null,i=null){var w,g,y;const l=(a==null?void 0:a.price)||((w=a==null?void 0:a.data)==null?void 0:w.price)||C.value||0,u=.19,d=l*u,S=l+d,V=((g=i==null?void 0:i.data)==null?void 0:g.tradeInValue)||((y=i==null?void 0:i.data)==null?void 0:y.value)||0,A=S-V;return{basePrice:l,vatRate:u*100,vatAmount:d,totalWithVAT:S,tradeInValue:V,netAmount:A,currency:"EUR"}}formatPaymentTerms(C=null,a=null){if(!C||!C.data)return{method:"cash",deposit:0,loanAmount:0,productName:null,startDate:null,expDate:null};const i=C.data;return{method:"financing",deposit:i.deposit||0,loanAmount:i.loanAmount||i.total||0,productName:i.productName||i.product||null,startDate:i.startDate||null,expDate:i.expDate||null}}getEquipment(C){if(!C)return[];const a=[];return C.equipment&&Array.isArray(C.equipment)?C.equipment:(C.options&&Object.entries(C.options).forEach(([i,l])=>{l&&a.push({name:i,value:l})}),a)}getTermsAndConditions(C="en"){const a={en:"Terms and conditions apply. Please refer to the full contract for detailed terms.",de:"Es gelten die Allgemeinen Geschäftsbedingungen. Bitte beachten Sie den vollständigen Vertrag für detaillierte Bedingungen.",fr:"Les termes et conditions s'appliquent. Veuillez vous référer au contrat complet pour les termes détaillés.",it:"Si applicano i termini e le condizioni. Si prega di fare riferimento al contratto completo per i termini dettagliati.",nl:"Algemene voorwaarden zijn van toepassing. Raadpleeg het volledige contract voor gedetailleerde voorwaarden."};return a[C]||a.en}async generatePDF(C,a,i){return await Nn.generatePDF({template:C,language:a,data:i})}async previewPDF(C,a,i){return await Nn.previewPDF({template:C,language:a,data:i})}async getTemplates(){return await Nn.getTemplates()}async sendPDFByEmail(C,a){return await Nn.sendPDFByEmail(C,a)}}const Qt=new ev,Dn=(s=300)=>new Promise(C=>setTimeout(C,s)),tv=async(s,C={})=>{await Dn();const a=await Is.findById(s);if(!a)throw new Error("Opportunity not found");const i=await Qt.prepareContractData(a,C),l=`contract-${C.template||"classic"}`;return await Qt.generatePDF(l,C.language||"en",i)},nv=async(s,C,a={})=>{await Dn();const i=await Is.findById(s);if(!i)throw new Error("Opportunity not found");let l=null;if(i.offers&&Array.isArray(i.offers)&&(l=i.offers.find(S=>S.id===C||S.id===String(C))),!l&&i.activities){const S=i.activities.find(V=>V.type==="offer"&&(V.id===C||V.id===String(C)));S&&(l=S)}if(!l)throw new Error("Offer not found");const u=await Qt.prepareOfferData(i,l,a),d=`offer-${a.template||"classic"}`;return await Qt.generatePDF(d,a.language||"en",u)},sv=async(s,C={})=>{await Dn();const a=await Is.findById(s);if(!a)throw new Error("Opportunity not found");const i=await Qt.prepareContractData(a,C),l=`contract-${C.template||"classic"}`;return await Qt.previewPDF(l,C.language||"en",i)},av=async(s,C,a={})=>{await Dn();const i=await Is.findById(s);if(!i)throw new Error("Opportunity not found");let l=null;if(i.offers&&Array.isArray(i.offers)&&(l=i.offers.find(S=>S.id===C||S.id===String(C))),!l&&i.activities){const S=i.activities.find(V=>V.type==="offer"&&(V.id===C||V.id===String(C)));S&&(l=S)}if(!l)throw new Error("Offer not found");const u=await Qt.prepareOfferData(i,l,a),d=`offer-${a.template||"classic"}`;return await Qt.previewPDF(d,a.language||"en",u)},lv=async()=>(await Dn(),await Qt.getTemplates()),ov=async(s,C)=>(await Dn(),await Qt.sendPDFByEmail(s,C)),iv=async s=>{await Dn();const{ContractRepository:C}=await Cn(async()=>{const{ContractRepository:i}=await Promise.resolve().then(()=>Xp);return{ContractRepository:i}},void 0);return await new C().downloadPDF(s)},rv=Do("contracts",()=>{const s=T([]),C=T([]),a=T(!1),i=T(null),l=T(null),u=$(()=>C.value),d=$(()=>C.value.length>0),S=$(()=>a.value);return{generatedPDFs:s,templates:C,loading:a,error:i,previewPDF:l,availableTemplates:u,hasTemplates:d,isLoading:S,fetchTemplates:async()=>{a.value=!0,i.value=null;try{return C.value=await lv(),C.value}catch(p){throw i.value=p.message,p}finally{a.value=!1}},generateContractPDF:async(p,F={})=>{a.value=!0,i.value=null;try{const R=await tv(p,F);return s.value.push({id:R.id,opportunityId:p,type:"contract",...R,options:F}),R}catch(R){throw i.value=R.message,R}finally{a.value=!1}},generateOfferPDF:async(p,F,R={})=>{a.value=!0,i.value=null;try{const P=await nv(p,F,R);return s.value.push({id:P.id,opportunityId:p,offerId:F,type:"offer",...P,options:R}),P}catch(P){throw i.value=P.message,P}finally{a.value=!1}},previewContractPDF:async(p,F={})=>{a.value=!0,i.value=null;try{const R=await sv(p,F);return l.value={opportunityId:p,type:"contract",...R,options:F},R}catch(R){throw i.value=R.message,R}finally{a.value=!1}},previewOfferPDF:async(p,F,R={})=>{a.value=!0,i.value=null;try{const P=await av(p,F,R);return l.value={opportunityId:p,offerId:F,type:"offer",...P,options:R},P}catch(P){throw i.value=P.message,P}finally{a.value=!1}},downloadPDF:async p=>{a.value=!0,i.value=null;try{const F=await iv(p),R=URL.createObjectURL(F),P=document.createElement("a");P.href=R,P.download=`contract-${p}.pdf`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(R)}catch(F){throw i.value=F.message,F}finally{a.value=!1}},sendPDFByEmail:async(p,F)=>{a.value=!0,i.value=null;try{return await ov(p,F)}catch(R){throw i.value=R.message,R}finally{a.value=!1}},clearPreview:()=>{var p;(p=l.value)!=null&&p.previewUrl&&URL.revokeObjectURL(l.value.previewUrl),l.value=null},clearError:()=>{i.value=null}}});function Fs(){const s=rv(),C=Os(),a=T(!1),i=T(!1),l=T(null),u=()=>{const c=C.settings;return{template:c.defaultPDFTemplate||"classic",language:c.defaultPDFLanguage||"en",includeTermsAndConditions:c.defaultIncludeTermsAndConditions??!0,includeDisclaimerPage:c.defaultIncludeDisclaimerPage??!0}},d=async(c,x={})=>{a.value=!0,l.value=null;try{const p={...u(),...x};return await s.generateContractPDF(c,p)}catch(p){throw l.value=p.message,p}finally{a.value=!1}},S=async(c,x,p={})=>{a.value=!0,l.value=null;try{const F={...u(),...p,includeDisclaimerPage:!1};return await s.generateOfferPDF(c,x,F)}catch(F){throw l.value=F.message,F}finally{a.value=!1}},V=async(c,x={})=>{i.value=!0,l.value=null;try{const p={...u(),...x};return await s.previewContractPDF(c,p)}catch(p){throw l.value=p.message,p}finally{i.value=!1}},A=async(c,x,p={})=>{i.value=!0,l.value=null;try{const F={...u(),...p,includeDisclaimerPage:!1};return await s.previewOfferPDF(c,x,F)}catch(F){throw l.value=F.message,F}finally{i.value=!1}},w=async c=>{try{await s.downloadPDF(c)}catch(x){throw l.value=x.message,x}},g=async(c,x)=>{try{return await s.sendPDFByEmail(c,x)}catch(p){throw l.value=p.message,p}},y=()=>{l.value=null,s.clearError()},b=()=>{s.clearPreview()},h=async()=>{s.hasTemplates||await s.fetchTemplates()};return{isGenerating:$(()=>a.value),isPreviewing:$(()=>i.value),isLoading:$(()=>s.isLoading),error:$(()=>l.value||s.error),previewPDF:$(()=>s.previewPDF),templates:$(()=>s.availableTemplates),generateContractPDF:d,generateOfferPDF:S,previewContractPDF:V,previewOfferPDF:A,downloadPDF:w,sendPDFByEmail:g,clearError:y,clearPreview:b,ensureTemplatesLoaded:h,getDefaultOptions:u}}function Sl(s="",C=""){const a=T(s),i=T(C),l=T(null);function u(){var d;a.value="",i.value="",(d=l.value)==null||d.reset()}return{reason:a,notes:i,cardRef:l,reset:u}}const uv={class:"relative"},dv=["disabled"],cv=["onClick","disabled"],Pn={__name:"SecondaryActionsDropdown",props:{actions:{type:Array,default:()=>[]}},emits:["action-selected"],setup(s,{emit:C}){const a=s,i=C,l=T(!1),u=()=>{l.value=!l.value},d=()=>{l.value=!1},S=A=>{A.disabled||(d(),i("action-selected",A),A.handler&&typeof A.handler=="function"&&A.handler())},V=$(()=>(a.actions||[]).map(A=>({key:A.key,label:A.label,disabled:!!A.disabled,onClick:()=>S(A)})));return(A,w)=>{const g=Ts("click-outside");return f(),k("div",uv,[e("button",{onClick:ln(u,["stop"]),class:"w-auto bg-surface hover:bg-muted border border-border text-muted-foreground font-medium px-4 py-2 rounded-lg text-xs flex items-center justify-between gap-2 transition-colors whitespace-nowrap",disabled:!s.actions||s.actions.length===0},[w[1]||(w[1]=e("span",null,"More actions",-1)),e("i",{class:re(["fa-solid fa-chevron-down text-xs transition-transform duration-200 flex-shrink-0",{"rotate-180":l.value}])},null,2)],8,dv),l.value&&V.value.length>0?Se((f(),k("div",{key:0,class:"absolute right-0 top-full mt-2 z-50 w-56 bg-white border border-black/10 rounded-lg shadow-nsc-card py-1",onClick:w[0]||(w[0]=ln(()=>{},["stop"]))},[(f(!0),k(pe,null,Ie(V.value,y=>(f(),k("button",{key:y.key,onClick:y.onClick,disabled:y.disabled,class:"w-full px-3 py-2 text-left text-xs text-foreground hover:bg-muted flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"},U(y.label),9,cv))),128))])),[[g,d]]):N("",!0)])}}},mv={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},fv={key:0,class:"space-y-3"},pv={class:"text-sm font-bold text-foreground flex items-center gap-2"},vv={class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3"},gv={class:"space-y-3"},yv={class:"text-sm font-bold text-foreground flex items-center gap-2"},bv={class:"flex gap-2"},hv={class:"relative flex-1"},xv={key:0,class:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3"},wv={key:1,class:"rounded-lg border border-border bg-muted py-12 text-center"},kv={key:1,class:"space-y-4"},Sv={class:"text-sm font-bold text-foreground flex items-center gap-2"},Cv={class:"rounded-lg border border-border bg-muted p-4 space-y-4"},$v={key:0,class:"flex justify-start"},Dv={key:1,class:"space-y-4"},Av={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},Tv={class:"space-y-2"},Ov={class:"space-y-2"},Iv={class:"space-y-2"},Vv={class:"space-y-2"},Fv={class:"flex flex-wrap gap-2"},Lv={__name:"VehicleSelectionModal",props:{show:{type:Boolean,required:!0},requestedVehicle:{type:Object,default:null},requestedCar:{type:Object,default:null},opportunity:{type:Object,default:null},opportunityId:{type:[Number,String],default:null},mode:{type:String,default:"full"}},emits:["close","vehicle-selected"],setup(s,{emit:C}){const a=s,i=$(()=>{var H,L,q;return a.requestedVehicle||a.requestedCar||((H=a.opportunity)==null?void 0:H.selectedVehicle)||((L=a.opportunity)==null?void 0:L.vehicle)||((q=a.opportunity)==null?void 0:q.requestedCar)||null});$(()=>{var H;return a.opportunityId??((H=a.opportunity)==null?void 0:H.id)??null});const l=C,u=H=>{H||l("close")},d=$(()=>a.mode==="full"||a.mode==="stock"),S=$(()=>a.mode==="full"||a.mode==="configure");ve(()=>a.show,H=>{H&&a.mode==="configure"&&(A.value=!0)});const V=T(""),A=T(a.mode==="configure"),w=T(null),g=T(null),y=T(null),b=T([]),h=T({brand:"",model:"",year:new Date().getFullYear(),price:0,stockDays:null,image:""});Mn(async()=>{try{const H=await cl({});b.value=H.data||[]}catch(H){console.error("Failed to load vehicles:",H),b.value=[]}});const c=$(()=>{const H=i.value;return H&&H.stockDays!=null}),x=$(()=>{var q;const H=i.value,L=[];if(H&&c.value&&L.push({...H,isRequested:!0}),(q=b.value)!=null&&q.length){const K=b.value.filter(Q=>H?Q.brand!==H.brand||Q.model!==H.model:!0),_=H&&c.value?3:4;L.push(...K.slice(0,_))}return L}),p=$(()=>{if(!b.value||b.value.length===0)return[];let H=[...b.value];if(V.value){const L=V.value.toLowerCase();H=H.filter(q=>q.brand.toLowerCase().includes(L)||q.model.toLowerCase().includes(L)||q.year.toString().includes(L))}return H}),F=$(()=>h.value.brand&&h.value.model&&h.value.year&&h.value.price>0),R=(H,L)=>{w.value=H,g.value=H.id||`custom-${Date.now()}`,y.value=L},P=()=>{if(!F.value)return;const H={...h.value,id:`custom-${Date.now()}`,isCustom:!0};R(H,"custom")},z=()=>{w.value&&(l("vehicle-selected",{vehicle:w.value,type:y.value}),l("close"),w.value=null,g.value=null,y.value=null,V.value="",A.value=!1,h.value={brand:"",model:"",year:new Date().getFullYear(),price:0,stockDays:null,image:""})};return(H,L)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":u},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-6xl max-h-[90vh] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0 px-6 pt-6 pb-4 border-b border-border"},{default:o(()=>[n(t(xt),{class:"text-foreground"},{default:o(()=>[...L[8]||(L[8]=[D("Select Vehicle",-1)])]),_:1})]),_:1}),e("div",mv,[d.value?(f(),k(pe,{key:0},[x.value.length?(f(),k("div",fv,[e("h3",pv,[n(t(dl),{class:"size-4 text-primary"}),L[9]||(L[9]=D(" Recommended Vehicles ",-1))]),e("div",vv,[(f(!0),k(pe,null,Ie(x.value,q=>(f(),ee(Wa,{key:q.id,vehicle:q,badge:q.isRequested?"Requested":"Recommended","stock-days":q.stockDays,selected:g.value===q.id,onSelect:K=>R(q,q.isRequested?"requested":"recommended")},null,8,["vehicle","badge","stock-days","selected","onSelect"]))),128))])])):N("",!0),e("div",gv,[e("h3",yv,[n(t(ml),{class:"size-4 text-primary"}),L[10]||(L[10]=D(" Browse Stock ",-1))]),e("div",bv,[e("div",hv,[n(t(ja),{class:"pointer-events-none absolute left-3 top-1/2 size-4 -translate-y-1/2 text-muted-foreground"}),n(t(Oe),{modelValue:V.value,"onUpdate:modelValue":L[0]||(L[0]=q=>V.value=q),type:"text",placeholder:"Search by brand, model, year...",class:"w-full pl-9 bg-background border-border"},null,8,["modelValue"])])]),p.value.length?(f(),k("div",xv,[(f(!0),k(pe,null,Ie(p.value,q=>(f(),ee(Wa,{key:q.id,vehicle:q,badge:"In Stock","stock-days":q.stockDays,selected:g.value===q.id,onSelect:K=>R(q,"stock")},null,8,["vehicle","stock-days","selected","onSelect"]))),128))])):(f(),k("div",wv,[n(t(ja),{class:"mx-auto mb-3 size-10 text-muted-foreground"}),L[11]||(L[11]=e("p",{class:"text-sm font-medium text-foreground"},"No vehicles found",-1)),L[12]||(L[12]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Try different keywords or clear the search",-1))]))])],64)):N("",!0),S.value?(f(),k("div",kv,[e("h3",Sv,[n(t(ea),{class:"size-4 text-primary"}),L[13]||(L[13]=D(" Configure Custom Vehicle ",-1))]),e("div",Cv,[L[21]||(L[21]=e("p",{class:"text-sm text-muted-foreground"}," Build a custom configuration with specific options and features. ",-1)),A.value?(f(),k("div",Dv,[e("div",Av,[e("div",Tv,[n(t(W),{class:"text-sm font-medium text-foreground"},{default:o(()=>[...L[15]||(L[15]=[D("Brand",-1)])]),_:1}),n(t(Oe),{modelValue:h.value.brand,"onUpdate:modelValue":L[2]||(L[2]=q=>h.value.brand=q),type:"text",placeholder:"e.g., Audi",class:"w-full bg-background border-border"},null,8,["modelValue"])]),e("div",Ov,[n(t(W),{class:"text-sm font-medium text-foreground"},{default:o(()=>[...L[16]||(L[16]=[D("Model",-1)])]),_:1}),n(t(Oe),{modelValue:h.value.model,"onUpdate:modelValue":L[3]||(L[3]=q=>h.value.model=q),type:"text",placeholder:"e.g., e-tron GT",class:"w-full bg-background border-border"},null,8,["modelValue"])]),e("div",Iv,[n(t(W),{class:"text-sm font-medium text-foreground"},{default:o(()=>[...L[17]||(L[17]=[D("Year",-1)])]),_:1}),n(t(Oe),{modelValue:h.value.year,"onUpdate:modelValue":L[4]||(L[4]=q=>h.value.year=q),type:"number",placeholder:"2024",class:"w-full bg-background border-border"},null,8,["modelValue"])]),e("div",Vv,[n(t(W),{class:"text-sm font-medium text-foreground"},{default:o(()=>[...L[18]||(L[18]=[D("Price (€)",-1)])]),_:1}),n(t(Oe),{modelValue:h.value.price,"onUpdate:modelValue":L[5]||(L[5]=q=>h.value.price=q),type:"number",placeholder:"98000",class:"w-full bg-background border-border"},null,8,["modelValue"])])]),e("div",Fv,[n(t(J),{variant:"secondary",size:"sm",onClick:L[6]||(L[6]=q=>A.value=!1)},{default:o(()=>[...L[19]||(L[19]=[D(" Hide ",-1)])]),_:1}),n(t(J),{variant:"default",size:"sm",class:"gap-2",disabled:!F.value,onClick:P},{default:o(()=>[n(t(ta),{class:"size-4"}),L[20]||(L[20]=D(" Use Custom Configuration ",-1))]),_:1},8,["disabled"])])])):(f(),k("div",$v,[n(t(J),{variant:"default",size:"sm",class:"gap-2",onClick:L[1]||(L[1]=q=>A.value=!0)},{default:o(()=>[n(t(ea),{class:"size-4"}),L[14]||(L[14]=D(" Build Custom Configuration ",-1))]),_:1})]))])])):N("",!0)]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3 px-6 py-4 border-t border-border"},{default:o(()=>[n(t(J),{variant:"outline",size:"sm",class:"w-full sm:w-auto",onClick:L[7]||(L[7]=q=>H.$emit("close"))},{default:o(()=>[...L[22]||(L[22]=[D(" Cancel ",-1)])]),_:1}),w.value?(f(),ee(t(J),{key:0,variant:"default",size:"sm",class:"w-full sm:w-auto",onClick:z},{default:o(()=>[...L[23]||(L[23]=[D(" Confirm Selection ",-1)])]),_:1})):N("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Nv={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},qv={class:"space-y-2"},Uv={class:"space-y-2"},Pv={class:"space-y-2"},Mv={__name:"ContractDateModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:C}){const a=s,i=C,l=T(""),u=T(""),d=T(""),S=$(()=>new Date().toISOString().split("T")[0]);ve(()=>a.show,g=>{if(g){const y=new Date;l.value=y.toISOString().split("T")[0],u.value=y.toTimeString().slice(0,5),d.value=""}});const V=()=>{if(!l.value)return;const g=u.value?`${l.value}T${u.value}:00`:`${l.value}T12:00:00`;i("confirm",{contractDate:g,notes:d.value})},A=()=>{i("cancel")},w=g=>{g||A()};return(g,y)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":w},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...y[3]||(y[3]=[D("Set Contract Signing Date",-1)])]),_:1})]),_:1}),e("div",Nv,[e("div",qv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...y[4]||(y[4]=[D("Contract Date",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:l.value,"onUpdate:modelValue":y[0]||(y[0]=b=>l.value=b),max:S.value,class:"w-full h-10"},null,8,["modelValue","max"])]),e("div",Uv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...y[5]||(y[5]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:u.value,"onUpdate:modelValue":y[1]||(y[1]=b=>u.value=b),class:"w-full h-10"},null,8,["modelValue"])]),e("div",Pv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...y[6]||(y[6]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:d.value,"onUpdate:modelValue":y[2]||(y[2]=b=>d.value=b),rows:"4",placeholder:"Add any relevant notes about the contract signing...",class:"w-full min-h-[100px] resize-none"},null,8,["modelValue"])])]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:A}),n(t(J),{label:"Set Contract Date",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!l.value,onClick:V},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Rv={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},Ev={class:"space-y-2"},jv={class:"space-y-2"},Bv={class:"space-y-2"},zv={class:"space-y-2"},Wv={__name:"DeliveryModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:C}){const a=s,i=C,l=T(""),u=T(""),d=T(""),S=T(""),V=$(()=>new Date().toISOString().split("T")[0]);ve(()=>a.show,y=>{if(y){const b=new Date;l.value=b.toISOString().split("T")[0],u.value=b.toTimeString().slice(0,5),d.value="",S.value=""}});const A=()=>{if(!l.value||!d.value)return;const y=u.value?`${l.value}T${u.value}:00`:`${l.value}T12:00:00`;i("confirm",{deliveryDate:y,location:d.value,notes:S.value})},w=()=>{i("cancel")},g=y=>{y||w()};return(y,b)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":g},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...b[4]||(b[4]=[D("Mark as Delivered",-1)])]),_:1})]),_:1}),e("div",Rv,[e("div",Ev,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...b[5]||(b[5]=[D("Delivery Date",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:l.value,"onUpdate:modelValue":b[0]||(b[0]=h=>l.value=h),max:V.value,class:"w-full h-10"},null,8,["modelValue","max"])]),e("div",jv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...b[6]||(b[6]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:u.value,"onUpdate:modelValue":b[1]||(b[1]=h=>u.value=h),class:"w-full h-10"},null,8,["modelValue"])]),e("div",Bv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...b[7]||(b[7]=[D("Delivery Location",-1)])]),_:1}),n(t(Ot),{modelValue:d.value,"onUpdate:modelValue":b[2]||(b[2]=h=>d.value=h)},{default:o(()=>[n(t(Dt),{class:"w-full h-10"},{default:o(()=>[n(t(At),{placeholder:"Select location..."})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Dealership"},{default:o(()=>[...b[8]||(b[8]=[D("At Dealership",-1)])]),_:1}),n(t(ge),{value:"Customer Address"},{default:o(()=>[...b[9]||(b[9]=[D("Customer Address",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...b[10]||(b[10]=[D("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",zv,[n(t(W),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...b[11]||(b[11]=[D("Delivery Notes",-1)])]),_:1}),n(t(He),{modelValue:S.value,"onUpdate:modelValue":b[3]||(b[3]=h=>S.value=h),rows:"4",placeholder:"Add any relevant delivery details, customer feedback, etc...",class:"w-full min-h-[100px] resize-none"},null,8,["modelValue"])])]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:w}),n(t(J),{label:"Mark as Delivered",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!l.value||!d.value,onClick:A},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},_v={class:"space-y-4"},Yv={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Hv={class:"space-y-4"},Qv={class:"flex justify-end gap-2"},ca={__name:"CloseAsLostCard",props:{preselectedReason:{type:String,default:""},preselectedNotes:{type:String,default:""}},emits:["cancel","confirm"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(null),d=T(i.preselectedReason||""),S=T(i.preselectedNotes||"");ve(()=>i.preselectedReason,y=>{y&&(d.value=y)}),ve(()=>i.preselectedNotes,y=>{y&&(S.value=y)});const V=$(()=>!!d.value);function A(){d.value="",S.value="",l("cancel")}function w(){V.value&&l("confirm",{reason:d.value,notes:S.value})}function g(){d.value="",S.value=""}return C({closeAsLostFormRef:u,reason:d,notes:S,canSubmit:V,reset:g}),(y,b)=>(f(),k("div",_v,[e("div",Yv,[b[3]||(b[3]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Close Opportunity as Lost",-1)),e("div",Hv,[n(Vs,{ref_key:"closeAsLostFormRef",ref:u,"preselected-reason":d.value,"onUpdate:reason":b[0]||(b[0]=h=>{d.value.value=h})},null,8,["preselected-reason"]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[2]||(b[2]=[D("Additional Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:S.value,"onUpdate:modelValue":b[1]||(b[1]=h=>S.value=h),rows:"4",placeholder:"Add any relevant details about why this opportunity was lost...",class:"w-full"},null,8,["modelValue"])])])]),e("div",Qv,[n(t(J),{variant:"secondary",onClick:A},{default:o(()=>[...b[4]||(b[4]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!V.value,onClick:w,class:"!bg-red-600 !hover:bg-red-700 !text-white"},{default:o(()=>[...b[5]||(b[5]=[D(" Close as Lost ",-1)])]),_:1},8,["disabled"])])]))}},Gv={__name:"RequalifyAsLeadModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(s,{emit:C}){const a=C,i=l=>{l||a("cancel")};return(l,u)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":i},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...u[2]||(u[2]=[D("Requalify as Lead",-1)])]),_:1})]),_:1}),u[3]||(u[3]=e("div",{class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},[e("div",{class:"flex items-start gap-4 mb-6"},[e("div",{class:"flex-shrink-0"},[e("div",{class:"w-12 h-12 rounded-sm bg-yellow-100 flex items-center justify-center border border-yellow-200"},[e("i",{class:"fa-solid fa-exclamation-triangle text-yellow-600 text-xl"})])]),e("div",{class:"flex-1"},[e("p",{class:"text-meta"}," Requalifying this opportunity will reset its stage and remove negotiation history. ")])]),e("div",null,[e("h4",{class:"text-sm font-bold text-red-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-times-circle"}),D(" What will be lost ")]),e("ul",{class:"space-y-2 text-sm text-muted-foreground"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity stage and expected close date")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity value and negotiation history")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Stock or configured vehicles added to the opportunity")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Offer history and negotiation data")])])]),e("div",null,[e("h4",{class:"text-sm font-bold text-green-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-check-circle"}),D(" What will be kept ")]),e("ul",{class:"space-y-2 text-sm text-muted-foreground"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Customer information and contact details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Original requested car details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"All activities (notes, calls, emails, etc.)")])])]),e("div",{class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4"},[e("p",{class:"text-sm text-yellow-800"},[e("i",{class:"fa-solid fa-info-circle mr-2"}),D(" This action cannot be undone. The opportunity will be permanently removed and replaced with a new lead. ")])])],-1)),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:u[0]||(u[0]=d=>l.$emit("cancel"))}),n(t(J),{label:"Confirm Requalification",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-yellow-600 !hover:bg-yellow-700 !border-yellow-600",onClick:u[1]||(u[1]=d=>l.$emit("confirm"))})]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Jv={class:"flex-1 overflow-y-auto p-6 w-full space-y-6"},Kv={key:0,class:"bg-muted rounded-lg p-4 border border-border"},Zv={class:"space-y-2 text-sm"},Xv={class:"flex items-center gap-2"},eg={class:"text-foreground"},tg={key:0,class:"flex items-center gap-2"},ng={class:"text-foreground"},sg={key:1,class:"flex items-center gap-2"},ag={class:"text-foreground"},lg={key:1,class:"bg-muted rounded-lg p-4 border border-border"},og={class:"space-y-2 text-sm"},ig={class:"flex items-center gap-2"},rg={class:"text-foreground"},ug={class:"flex items-center gap-2"},dg={class:"text-foreground font-semibold"},cg={key:0,class:"flex items-center gap-2"},mg={class:"text-foreground"},fg={class:"flex items-start gap-3"},pg=["id"],vg=["for"],gg={key:0},yg={class:"grid grid-cols-2 gap-3"},bg={key:1},hg={class:"grid grid-cols-2 gap-3"},xg={class:"space-y-4"},wg={class:"flex items-start gap-3"},kg=["id"],Sg=["for"],Cg={class:"flex items-start gap-3"},$g=["id"],Dg=["for"],Ag={key:2,class:"p-3 bg-red-50 border border-red-200 rounded-lg"},Tg={class:"text-sm text-red-600"},Og={__name:"PDFGenerationModal",props:{show:{type:Boolean,required:!0},opportunityId:{type:[String,Number],required:!0},documentType:{type:String,default:null,validator:s=>!s||["contract","offer"].includes(s)},offerId:{type:[String,Number],default:null},availableOffers:{type:Array,default:()=>[]},customer:{type:Object,default:null}},emits:["close","generate","preview","send"],setup(s,{emit:C}){var ne;const a=s,i=C,{isGenerating:l,isPreviewing:u,error:d,getDefaultOptions:S,ensureTemplatesLoaded:V}=Fs(),A=$(()=>a.documentType!==null),w=T(a.documentType||"contract"),g=T(a.offerId),y=T(((ne=a.customer)==null?void 0:ne.email)||""),b=T(""),h=T(!1),c=T({template:"classic",language:"en",includeTermsAndConditions:!0,includeDisclaimerPage:!0}),x=$(()=>{var E;return w.value!=="offer"||!g.value?null:((E=a.availableOffers)==null?void 0:E.find(O=>O.id===g.value))||null});ve(()=>a.customer,E=>{E!=null&&E.email&&w.value==="offer"&&(y.value=E.email)},{immediate:!0});const p=$(()=>d.value);Mn(async()=>{await V();const E=S();c.value={...E,...c.value}}),ve(()=>a.documentType,E=>{E&&(w.value=E)}),ve(()=>a.offerId,E=>{E&&(g.value=E)},{immediate:!0}),ve(()=>[a.availableOffers,w.value],([E,O])=>{O==="offer"&&E&&E.length===1&&!g.value&&(g.value=E[0].id)},{immediate:!0});const F=$(()=>w.value==="offer"?g.value!==null&&g.value!==void 0:!0),R=$(()=>w.value!=="offer"?!1:F.value&&y.value&&y.value.includes("@")),P=E=>{if(E.data){const O=E.data;return`${O.brand||""} ${O.model||""} (${O.year||""})`}return E.vehicleBrand?`${E.vehicleBrand} ${E.vehicleModel} (${E.vehicleYear})`:"Vehicle"},z=E=>{var O;return E.price||((O=E.data)==null?void 0:O.price)||0},H=E=>E?new Intl.NumberFormat("en-US").format(E):"0",L=E=>E?new Date(E).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"",q=E=>{if(E.data){const O=E.data;return`${O.brand||""} ${O.model||""} (${O.year||""}) - €${(O.price||0).toLocaleString()}`}return E.vehicleBrand?`${E.vehicleBrand} ${E.vehicleModel} (${E.vehicleYear}) - €${(E.price||0).toLocaleString()}`:`Offer #${E.id}`},K=E=>{E||i("close")},_=async()=>{if(F.value)try{const E={...c.value,includeDisclaimerPage:w.value==="contract"?c.value.includeDisclaimerPage:!1};if(w.value==="contract")i("generate",{type:"contract",opportunityId:a.opportunityId,options:E});else{if(!g.value){p.value="Please select an offer";return}i("generate",{type:"offer",opportunityId:a.opportunityId,offerId:g.value,options:E})}}catch(E){console.error("Error generating PDF:",E)}},Q=async()=>{if(F.value)try{const E={...c.value,includeDisclaimerPage:w.value==="contract"?c.value.includeDisclaimerPage:!1};if(w.value==="contract")i("preview",{type:"contract",opportunityId:a.opportunityId,options:E});else{if(!g.value){p.value="Please select an offer";return}i("preview",{type:"offer",opportunityId:a.opportunityId,offerId:g.value,options:E})}}catch(E){console.error("Error previewing PDF:",E)}},ue=async()=>{if(R.value){h.value=!0;try{const E={...c.value,includeDisclaimerPage:!1};if(!g.value){p.value="Please select an offer";return}i("send",{type:"offer",opportunityId:a.opportunityId,offerId:g.value,email:y.value,message:b.value,options:E})}catch(E){console.error("Error sending PDF:",E),p.value=E.message||"Failed to send PDF"}finally{h.value=!1}}};return(E,O)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":K},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-2xl max-h-[calc(100vh-4rem)] flex flex-col p-0"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0 p-6 pb-4 border-b border"},{default:o(()=>[n(t(xt),null,{default:o(()=>[D(U(w.value==="contract"?"Generate Contract PDF":"Send Offer PDF"),1)]),_:1})]),_:1}),e("div",Jv,[w.value==="offer"?(f(),k(pe,{key:0},[s.customer?(f(),k("div",Kv,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[12]||(O[12]=[D("Customer Details",-1)])]),_:1}),e("div",Zv,[e("div",Xv,[O[13]||(O[13]=e("span",{class:"text-muted-foreground font-medium w-24"},"Name:",-1)),e("span",eg,U(s.customer.name||"N/A"),1)]),s.customer.phone?(f(),k("div",tg,[O[14]||(O[14]=e("span",{class:"text-muted-foreground font-medium w-24"},"Phone:",-1)),e("span",ng,U(s.customer.phone),1)])):N("",!0),s.customer.address?(f(),k("div",sg,[O[15]||(O[15]=e("span",{class:"text-muted-foreground font-medium w-24"},"Address:",-1)),e("span",ag,U(s.customer.address),1)])):N("",!0)])])):N("",!0),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-2 block"},{default:o(()=>[...O[16]||(O[16]=[D("Email Address ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{modelValue:y.value,"onUpdate:modelValue":O[0]||(O[0]=G=>y.value=G),type:"email",placeholder:"customer@example.com",class:"w-full"},null,8,["modelValue"])]),x.value?(f(),k("div",lg,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[17]||(O[17]=[D("Offer Details",-1)])]),_:1}),e("div",og,[e("div",ig,[O[18]||(O[18]=e("span",{class:"text-muted-foreground font-medium w-24"},"Vehicle:",-1)),e("span",rg,U(P(x.value)),1)]),e("div",ug,[O[19]||(O[19]=e("span",{class:"text-muted-foreground font-medium w-24"},"Price:",-1)),e("span",dg,"€ "+U(H(z(x.value))),1)]),x.value.createdAt?(f(),k("div",cg,[O[20]||(O[20]=e("span",{class:"text-muted-foreground font-medium w-24"},"Created:",-1)),e("span",mg,U(L(x.value.createdAt)),1)])):N("",!0)])])):N("",!0),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-2 block"},{default:o(()=>[...O[21]||(O[21]=[D("Message (Optional)",-1)])]),_:1}),n(t(He),{modelValue:b.value,"onUpdate:modelValue":O[1]||(O[1]=G=>b.value=G),rows:"4",placeholder:"Add a personal message to accompany the offer...",class:"w-full"},null,8,["modelValue"])]),e("div",fg,[Se(e("input",{type:"checkbox",id:"terms-offer-"+E._uid,"onUpdate:modelValue":O[2]||(O[2]=G=>c.value.includeTermsAndConditions=G),class:"mt-1"},null,8,pg),[[$t,c.value.includeTermsAndConditions]]),e("label",{for:"terms-offer-"+E._uid,class:"text-sm text-foreground cursor-pointer"}," Include Terms & Conditions ",8,vg)])],64)):(f(),k(pe,{key:1},[A.value?N("",!0):(f(),k("div",gg,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[22]||(O[22]=[D("Document Type",-1)])]),_:1}),e("div",yg,[e("button",{type:"button",class:re(["p-4 border-2 rounded-lg text-left transition-all",w.value==="contract"?"border-primary bg-primary/5":"border-border hover:border-primary/50"]),onClick:O[3]||(O[3]=G=>w.value="contract")},[...O[23]||(O[23]=[e("div",{class:"font-semibold text-sm text-foreground mb-1"},"Contract",-1),e("div",{class:"text-xs text-muted-foreground"},"Formal contract with signature area",-1)])],2),e("button",{type:"button",class:re(["p-4 border-2 rounded-lg text-left transition-all",w.value==="offer"?"border-primary bg-primary/5":"border-border hover:border-primary/50"]),onClick:O[4]||(O[4]=G=>w.value="offer")},[...O[24]||(O[24]=[e("div",{class:"font-semibold text-sm text-foreground mb-1"},"Offer",-1),e("div",{class:"text-xs text-muted-foreground"},"Purchase proposal for customer",-1)])],2)])])),w.value==="offer"&&s.availableOffers&&s.availableOffers.length>1?(f(),k("div",bg,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[25]||(O[25]=[D("Select Offer",-1)])]),_:1}),n(t(Ot),{modelValue:g.value,"onUpdate:modelValue":O[5]||(O[5]=G=>g.value=G)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select an offer..."})]),_:1}),n(t(Tt),null,{default:o(()=>[(f(!0),k(pe,null,Ie(s.availableOffers,G=>(f(),ee(t(ge),{key:G.id,value:G.id},{default:o(()=>[D(U(q(G)),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])])):N("",!0),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[26]||(O[26]=[D("Language",-1)])]),_:1}),n(t(Ot),{modelValue:c.value.language,"onUpdate:modelValue":O[6]||(O[6]=G=>c.value.language=G)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At))]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"en"},{default:o(()=>[...O[27]||(O[27]=[D("English",-1)])]),_:1}),n(t(ge),{value:"de"},{default:o(()=>[...O[28]||(O[28]=[D("Deutsch",-1)])]),_:1}),n(t(ge),{value:"fr"},{default:o(()=>[...O[29]||(O[29]=[D("Français",-1)])]),_:1}),n(t(ge),{value:"it"},{default:o(()=>[...O[30]||(O[30]=[D("Italiano",-1)])]),_:1}),n(t(ge),{value:"nl"},{default:o(()=>[...O[31]||(O[31]=[D("Nederlands",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-3 block"},{default:o(()=>[...O[32]||(O[32]=[D("Template Style",-1)])]),_:1}),e("div",hg,[e("button",{type:"button",class:re(["p-4 border-2 rounded-lg text-left transition-all",c.value.template==="classic"?"border-primary bg-primary/5":"border-border hover:border-primary/50"]),onClick:O[7]||(O[7]=G=>c.value.template="classic")},[...O[33]||(O[33]=[e("div",{class:"font-semibold text-sm text-foreground mb-1"},"Classic",-1),e("div",{class:"text-xs text-muted-foreground"}," Detailed with comprehensive information and legal sections ",-1)])],2),e("button",{type:"button",class:re(["p-4 border-2 rounded-lg text-left transition-all",c.value.template==="express"?"border-primary bg-primary/5":"border-border hover:border-primary/50"]),onClick:O[8]||(O[8]=G=>c.value.template="express")},[...O[34]||(O[34]=[e("div",{class:"font-semibold text-sm text-foreground mb-1"},"Express",-1),e("div",{class:"text-xs text-muted-foreground"}," Streamlined with essential information ",-1)])],2)])]),e("div",xg,[n(t(W),{class:"text-sm font-semibold text-foreground block"},{default:o(()=>[...O[35]||(O[35]=[D("Options",-1)])]),_:1}),e("div",wg,[Se(e("input",{type:"checkbox",id:"terms-"+E._uid,"onUpdate:modelValue":O[9]||(O[9]=G=>c.value.includeTermsAndConditions=G),class:"mt-1"},null,8,kg),[[$t,c.value.includeTermsAndConditions]]),e("label",{for:"terms-"+E._uid,class:"text-sm text-foreground cursor-pointer"}," Include Terms & Conditions ",8,Sg)]),e("div",Cg,[Se(e("input",{type:"checkbox",id:"disclaimer-"+E._uid,"onUpdate:modelValue":O[10]||(O[10]=G=>c.value.includeDisclaimerPage=G),class:"mt-1"},null,8,$g),[[$t,c.value.includeDisclaimerPage]]),e("label",{for:"disclaimer-"+E._uid,class:"text-sm text-foreground cursor-pointer"}," Include Disclaimer Page (last page) ",8,Dg)])])],64)),p.value?(f(),k("div",Ag,[e("p",Tg,U(p.value),1)])):N("",!0)]),n(t(Ut),{class:"flex-shrink-0 p-6 pt-4 bg-muted flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3 border-t border"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:t(l)||t(u)||h.value,onClick:O[11]||(O[11]=G=>E.$emit("close"))},null,8,["disabled"]),w.value==="offer"?(f(),ee(t(J),{key:0,label:"Send Offer PDF",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:!R.value||t(l)||t(u)||h.value,onClick:ue},{default:o(()=>[h.value?(f(),k(pe,{key:0},[O[36]||(O[36]=e("i",{class:"fa-solid fa-spinner fa-spin mr-2"},null,-1)),O[37]||(O[37]=D(" Sending... ",-1))],64)):(f(),k(pe,{key:1},[O[38]||(O[38]=e("i",{class:"fa-solid fa-paper-plane mr-2"},null,-1)),O[39]||(O[39]=D(" Send ",-1))],64))]),_:1},8,["disabled"])):(f(),k(pe,{key:1},[n(t(J),{label:"Preview",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!F.value||t(l)||t(u),onClick:Q},null,8,["disabled"]),n(t(J),{label:"Generate PDF",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:!F.value||t(l)||t(u),onClick:_},{default:o(()=>[t(l)?(f(),k(pe,{key:0},[O[40]||(O[40]=e("i",{class:"fa-solid fa-spinner fa-spin mr-2"},null,-1)),O[41]||(O[41]=D(" Generating... ",-1))],64)):N("",!0)]),_:1},8,["disabled"])],64))]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Ig={class:"flex-1 overflow-hidden flex flex-col"},Vg={class:"flex-1 overflow-auto bg-muted p-4"},Fg={key:0,class:"flex items-center justify-center h-full"},Lg={key:1,class:"flex items-center justify-center h-full"},Ng={class:"text-center p-6 bg-red-50 border border-red-200 rounded-lg"},qg={class:"text-xs text-red-500"},Ug={key:2,class:"bg-white rounded-lg shadow-lg overflow-hidden"},Pg=["src"],Mg={key:3,class:"flex items-center justify-center h-full"},Rg={__name:"PDFPreviewModal",props:{show:{type:Boolean,required:!0},pdfUrl:{type:String,default:null},pdfId:{type:String,default:null},loading:{type:Boolean,default:!1},error:{type:String,default:null}},emits:["close","regenerate","download","email","print"],setup(s,{emit:C}){const a=s,i=C,{downloadPDF:l}=Fs(),u=w=>{w||i("close")},d=()=>{i("regenerate")},S=async()=>{if(a.pdfId)try{await l(a.pdfId),i("download",a.pdfId)}catch(w){console.error("Error downloading PDF:",w)}else if(a.pdfUrl){const w=document.createElement("a");w.href=a.pdfUrl,w.download="contract.pdf",document.body.appendChild(w),w.click(),document.body.removeChild(w),i("download",a.pdfUrl)}},V=()=>{i("email",{pdfId:a.pdfId,pdfUrl:a.pdfUrl})},A=()=>{if(a.pdfUrl){const w=window.open(a.pdfUrl,"_blank");w&&(w.onload=()=>{w.print()}),i("print",a.pdfUrl)}};return sl(()=>{}),(w,g)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":u},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-6xl max-h-[calc(100vh-4rem)] flex flex-col p-0"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0 p-6 pb-4 border-b border"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...g[0]||(g[0]=[D("PDF Preview",-1)])]),_:1})]),_:1}),e("div",Ig,[e("div",Vg,[s.loading?(f(),k("div",Fg,[...g[1]||(g[1]=[e("div",{class:"text-center"},[e("i",{class:"fa-solid fa-spinner fa-spin text-4xl text-muted-foreground mb-4"}),e("p",{class:"text-sm text-muted-foreground"},"Loading PDF preview...")],-1)])])):s.error?(f(),k("div",Lg,[e("div",Ng,[g[2]||(g[2]=e("i",{class:"fa-solid fa-exclamation-circle text-4xl text-red-600 mb-4"},null,-1)),g[3]||(g[3]=e("p",{class:"text-sm text-red-600 font-semibold mb-2"},"Failed to load PDF",-1)),e("p",qg,U(s.error),1)])])):s.pdfUrl?(f(),k("div",Ug,[e("iframe",{src:s.pdfUrl,class:"w-full h-full min-h-[600px] border-0",title:"PDF Preview"},null,8,Pg)])):(f(),k("div",Mg,[...g[4]||(g[4]=[e("p",{class:"text-sm text-muted-foreground"},"No PDF to preview",-1)])]))])]),n(t(Ut),{class:"flex-shrink-0 p-6 pt-4 bg-muted flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3 border-t border"},{default:o(()=>[n(t(J),{label:"Regenerate",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:s.loading,onClick:d},null,8,["disabled"]),n(t(J),{label:"Print",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!s.pdfUrl||s.loading,onClick:A},{default:o(()=>[...g[5]||(g[5]=[e("i",{class:"fa-solid fa-print mr-2"},null,-1)])]),_:1},8,["disabled"]),n(t(J),{label:"Email",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!s.pdfUrl||s.loading,onClick:V},{default:o(()=>[...g[6]||(g[6]=[e("i",{class:"fa-solid fa-envelope mr-2"},null,-1)])]),_:1},8,["disabled"]),n(t(J),{label:"Download",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:!s.pdfUrl||s.loading,onClick:S},{default:o(()=>[...g[7]||(g[7]=[e("i",{class:"fa-solid fa-download mr-2"},null,-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Eg={class:"flex-1 overflow-y-auto p-6 w-full space-y-4"},jg=["disabled"],Bg={key:0,class:"p-3 bg-red-50 border border-red-200 rounded-lg"},zg={class:"text-sm text-red-600"},Wg={key:1,class:"p-3 bg-green-50 border border-green-200 rounded-lg"},_g={key:1,class:"fa-solid fa-envelope mr-2"},Yg={__name:"EmailPDFModal",props:{show:{type:Boolean,required:!0},pdfId:{type:String,required:!0},recipientEmail:{type:String,default:""},defaultSubject:{type:String,default:"Contract/Offer Document"}},emits:["close","sent"],setup(s,{emit:C}){const a=s,i=C,{sendPDFByEmail:l}=Fs(),u=T({to:"",subject:"",message:""}),d=T(!1),S=T(null),V=T(!1),A=$(()=>u.value.to&&u.value.to.includes("@")&&u.value.subject);ve(()=>a.show,y=>{y&&(u.value={to:a.recipientEmail||"",subject:a.defaultSubject||"Contract/Offer Document",message:""},S.value=null,V.value=!1)});const w=y=>{y||i("close")},g=async()=>{if(A.value){d.value=!0,S.value=null,V.value=!1;try{await l(a.pdfId,{to:u.value.to,subject:u.value.subject,message:u.value.message||void 0}),V.value=!0,setTimeout(()=>{i("sent",{pdfId:a.pdfId,email:u.value.to}),i("close")},1500)}catch(y){S.value=y.message||"Failed to send email. Please try again."}finally{d.value=!1}}};return(y,b)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":w},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col p-0"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0 p-6 pb-4 border-b border"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...b[4]||(b[4]=[D("Send PDF by Email",-1)])]),_:1})]),_:1}),e("div",Eg,[e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-2 block"},{default:o(()=>[...b[5]||(b[5]=[D(" Recipient Email ",-1),e("span",{class:"text-red-500"},"*",-1)])]),_:1}),n(t(Oe),{modelValue:u.value.to,"onUpdate:modelValue":b[0]||(b[0]=h=>u.value.to=h),type:"email",placeholder:"customer@example.com",required:"",disabled:d.value},null,8,["modelValue","disabled"])]),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-2 block"},{default:o(()=>[...b[6]||(b[6]=[D(" Subject ",-1),e("span",{class:"text-red-500"},"*",-1)])]),_:1}),n(t(Oe),{modelValue:u.value.subject,"onUpdate:modelValue":b[1]||(b[1]=h=>u.value.subject=h),type:"text",placeholder:"Contract/Offer Document",required:"",disabled:d.value},null,8,["modelValue","disabled"])]),e("div",null,[n(t(W),{class:"text-sm font-semibold text-foreground mb-2 block"},{default:o(()=>[...b[7]||(b[7]=[D(" Message (Optional) ",-1)])]),_:1}),Se(e("textarea",{"onUpdate:modelValue":b[2]||(b[2]=h=>u.value.message=h),class:"w-full min-h-[100px] px-3 py-2 border border-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Add a personal message to the email...",disabled:d.value},null,8,jg),[[ss,u.value.message]])]),S.value?(f(),k("div",Bg,[e("p",zg,U(S.value),1)])):N("",!0),V.value?(f(),k("div",Wg,[...b[8]||(b[8]=[e("p",{class:"text-sm text-green-600"},[e("i",{class:"fa-solid fa-check-circle mr-2"}),D(" PDF sent successfully! ")],-1)])])):N("",!0)]),n(t(Ut),{class:"flex-shrink-0 p-6 pt-4 bg-muted flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3 border-t border"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:d.value,onClick:b[3]||(b[3]=h=>y.$emit("close"))},null,8,["disabled"]),n(t(J),{label:"Send Email",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:!A.value||d.value,onClick:g},{default:o(()=>[d.value?(f(),k(pe,{key:0},[b[9]||(b[9]=e("i",{class:"fa-solid fa-spinner fa-spin mr-2"},null,-1)),b[10]||(b[10]=D(" Sending... ",-1))],64)):(f(),k("i",_g))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Hg={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-4"},Qg={__name:"PostponeTaskDialog",props:{show:{type:Boolean,default:!1},taskType:{type:String,required:!0}},emits:["close","confirm"],setup(s,{emit:C}){const a=s,i=C,l=T({date:"",time:"",reason:""}),u=$(()=>new Date().toISOString().split("T")[0]),d=$(()=>!!l.value.date);ve(()=>a.show,w=>{if(w){const g=new Date;l.value.date=g.toISOString().split("T")[0],l.value.time=g.toTimeString().slice(0,5),l.value.reason=""}});const S=w=>{w||i("close")},V=()=>{i("close")},A=()=>{if(!d.value)return;const w=l.value.time?`${l.value.date}T${l.value.time}:00`:`${l.value.date}T12:00:00`;i("confirm",{taskType:a.taskType,date:l.value.date,time:l.value.time||"12:00",dateTime:w,reason:l.value.reason}),i("close")};return(w,g)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":S},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-md max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...g[3]||(g[3]=[D("Postpone Task",-1)])]),_:1})]),_:1}),e("div",Hg,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-foreground mb-2"},{default:o(()=>[...g[4]||(g[4]=[D("Postpone Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:l.value.date,"onUpdate:modelValue":g[0]||(g[0]=y=>l.value.date=y),min:u.value,class:"w-full"},null,8,["modelValue","min"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-foreground mb-2"},{default:o(()=>[...g[5]||(g[5]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:l.value.time,"onUpdate:modelValue":g[1]||(g[1]=y=>l.value.time=y),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-foreground mb-2"},{default:o(()=>[...g[6]||(g[6]=[D("Reason (Optional)",-1)])]),_:1}),n(t(He),{modelValue:l.value.reason,"onUpdate:modelValue":g[2]||(g[2]=y=>l.value.reason=y),rows:"3",placeholder:"Why are you postponing this task?",class:"w-full"},null,8,["modelValue"])])]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:V},{default:o(()=>[...g[7]||(g[7]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!d.value,onClick:A},{default:o(()=>[...g[8]||(g[8]=[D(" Postpone Task ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Gg={class:"flex-1 overflow-y-auto min-h-0"},Jg={__name:"EditExpectedCloseDateModal",props:{show:{type:Boolean,default:!1},opportunity:{type:Object,required:!0}},emits:["close","confirm"],setup(s,{emit:C}){const a=s,i=C,l=T(""),u=T(""),d=$(()=>new Date().toISOString().split("T")[0]),S=$(()=>!!l.value);ve(()=>a.show,g=>{if(g){const y=a.opportunity.expectedCloseDate?new Date(a.opportunity.expectedCloseDate):new Date;if(y<new Date){const b=new Date;b.setDate(b.getDate()+1),l.value=b.toISOString().split("T")[0]}else l.value=y.toISOString().split("T")[0];u.value=""}});function V(g){g||i("close")}function A(){i("close")}function w(){S.value&&(i("confirm",{expectedCloseDate:l.value,reason:u.value}),i("close"))}return(g,y)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":V},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt)),n(t(bt),{class:"flex flex-col max-h-screen w-full sm:max-w-md"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...y[2]||(y[2]=[D("Extend Expected Close Date",-1)])]),_:1})]),_:1}),e("div",Gg,[n(t(bo),{class:"gap-4"},{default:o(()=>[n(t(Ra),null,{default:o(()=>[n(t(Ea),{for:"extend-expected-close-date"},{default:o(()=>[...y[3]||(y[3]=[D("Expected Close Date",-1)])]),_:1}),n(t(Oe),{id:"extend-expected-close-date",type:"date",modelValue:l.value,"onUpdate:modelValue":y[0]||(y[0]=b=>l.value=b),min:d.value},null,8,["modelValue","min"])]),_:1}),n(t(Ra),null,{default:o(()=>[n(t(Ea),{for:"extend-expected-close-reason"},{default:o(()=>[...y[4]||(y[4]=[D("Reason (optional)",-1)])]),_:1}),n(t(He),{id:"extend-expected-close-reason",modelValue:u.value,"onUpdate:modelValue":y[1]||(y[1]=b=>u.value=b),rows:4,placeholder:"Why are you extending the expected close date?"},null,8,["modelValue"])]),_:1})]),_:1})]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end gap-3"},{default:o(()=>[n(t(J),{variant:"outline",size:"small",onClick:A},{default:o(()=>[...y[5]||(y[5]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",size:"small",disabled:!S.value,onClick:w},{default:o(()=>[...y[6]||(y[6]=[D(" Save ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Kg={class:"space-y-4"},Zg={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Xg={class:"text-sm text-muted-foreground"},ey={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},ty={class:"grid grid-cols-2 gap-4"},ny={class:"flex items-center gap-2"},sy={class:"text-muted-foreground"},ay={class:"font-medium text-foreground"},ly={class:"flex items-center gap-2"},oy={class:"font-medium text-foreground"},iy={class:"mt-4"},ry={__name:"NS1Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["assigned","cancel"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=xn(),d=Jt(),S=Bt(),V=T(null),A=T(null),w=T(""),g=$(()=>u.assignableUsers),y=$(()=>u.assignableTeams),b=$(()=>y.value.map(L=>({...L,label:`${L.dealership||"No location"} → ${L.name}`,value:L.id}))),h=$(()=>{var K;if(!V.value)return[];const L=V.value;return(((K=g.value)==null?void 0:K.filter(_=>_.team===L.name||_.teamId===L.id))||[]).map(_=>({..._,label:_.name,value:_.id}))}),c=$({get:()=>{var L;return((L=V.value)==null?void 0:L.id)||null},set:L=>{var K;if(!L){V.value=null;return}const q=(K=y.value)==null?void 0:K.find(_=>_.id===L);V.value=q||null,q&&(A.value=null)}}),x=$({get:()=>{var L;return((L=A.value)==null?void 0:L.id)||null},set:L=>{if(!L){A.value=null;return}const q=h.value.find(K=>K.id===L);A.value=q||null}}),p=L=>L?L.split(" ").map(q=>q[0]).join("").toUpperCase().substring(0,2):"?",F=L=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[L]||"bg-muted text-muted-foreground",R=$(()=>!!V.value);async function P(){var K,_,Q;if(!R.value)return;const L=((K=A.value)==null?void 0:K.name)||((_=V.value)==null?void 0:_.name),q={assignee:L};w.value&&(q.assignmentNote=w.value),await S.updateOpportunity(i.opportunity.id,q),await S.addActivity(i.opportunity.id,{type:"assignment",user:((Q=d.currentUser)==null?void 0:Q.name)||"You",action:"assigned opportunity",content:`Opportunity assigned to ${L}${w.value?` with note: ${w.value}`:""}`,timestamp:new Date().toISOString()}),l("assigned",{opportunity:i.opportunity,assignee:L,note:w.value})}C({canSubmit:R,submit:P});const z=$(()=>"Follow up with customer to understand the situation and book another appointment."),H=$(()=>{var q;return(q=i.scheduledAppointment)!=null&&q.start?new Date(i.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"});return Mn(()=>{var L,q,K;if(i.opportunity.assignee&&!V.value&&!A.value){const _=(L=g.value)==null?void 0:L.find(ue=>ue.name===i.opportunity.assignee),Q=(q=y.value)==null?void 0:q.find(ue=>ue.name===i.opportunity.assignee);if(_){const ue=(K=y.value)==null?void 0:K.find(ne=>ne.name===_.team||ne.id===_.teamId);ue&&(V.value=ue,A.value=_)}else Q&&(V.value=Q)}i.opportunity.assignmentNote&&(w.value=i.opportunity.assignmentNote)}),ve(()=>i.opportunity.assignee,L=>{var q,K,_;if(L&&!V.value&&!A.value){const Q=(q=g.value)==null?void 0:q.find(ne=>ne.name===L),ue=(K=y.value)==null?void 0:K.find(ne=>ne.name===L);if(Q){const ne=(_=y.value)==null?void 0:_.find(E=>E.name===Q.team||E.id===Q.teamId);ne&&(V.value=ne,A.value=Q)}else ue&&(V.value=ue)}}),(L,q)=>(f(),k("div",Kg,[e("div",Zg,[q[3]||(q[3]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"1st No-Show Follow-up Task",-1)),e("p",Xg," Appointment was scheduled for "+U(H.value)+" but customer did not show up. "+U(z.value),1)]),e("div",ey,[q[8]||(q[8]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign to",-1)),e("div",ty,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[4]||(q[4]=[D("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(vt),{modelValue:c.value,"onUpdate:modelValue":q[0]||(q[0]=K=>c.value=K),items:b.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",ny,[e("span",sy,U(K.dealership||"No location"),1),q[5]||(q[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",ay,U(K.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[6]||(q[6]=[D("Salesperson ",-1),e("span",{class:"text-muted-foreground text-xs"},"(optional)",-1)])]),_:1}),n(t(vt),{modelValue:x.value,"onUpdate:modelValue":q[1]||(q[1]=K=>x.value=K),items:h.value,disabled:!V.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",ly,[e("div",{class:re(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",F(K.role)])},U(p(K.name)),3),e("span",oy,U(K.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",iy,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[7]||(q[7]=[D("Notes for assignee",-1)])]),_:1}),n(t(He),{modelValue:w.value,"onUpdate:modelValue":q[2]||(q[2]=K=>w.value=K),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])]))}},uy={class:"space-y-4"},dy={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},cy={class:"text-sm text-muted-foreground"},my={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},fy={class:"grid grid-cols-2 gap-4"},py={class:"flex items-center gap-2"},vy={class:"text-muted-foreground"},gy={class:"font-medium text-foreground"},yy={class:"flex items-center gap-2"},by={class:"font-medium text-foreground"},hy={class:"mt-4"},xy={__name:"NS2Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["assigned","cancel"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=xn(),d=Jt(),S=Bt(),V=T(null),A=T(null),w=T(""),g=$(()=>u.assignableUsers),y=$(()=>u.assignableTeams),b=$(()=>y.value.map(L=>({...L,label:`${L.dealership||"No location"} → ${L.name}`,value:L.id}))),h=$(()=>{var K;if(!V.value)return[];const L=V.value;return(((K=g.value)==null?void 0:K.filter(_=>_.team===L.name||_.teamId===L.id))||[]).map(_=>({..._,label:_.name,value:_.id}))}),c=$({get:()=>{var L;return((L=V.value)==null?void 0:L.id)||null},set:L=>{var K;if(!L){V.value=null;return}const q=(K=y.value)==null?void 0:K.find(_=>_.id===L);V.value=q||null,q&&(A.value=null)}}),x=$({get:()=>{var L;return((L=A.value)==null?void 0:L.id)||null},set:L=>{if(!L){A.value=null;return}const q=h.value.find(K=>K.id===L);A.value=q||null}}),p=L=>L?L.split(" ").map(q=>q[0]).join("").toUpperCase().substring(0,2):"?",F=L=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[L]||"bg-muted text-muted-foreground",R=$(()=>!!V.value);async function P(){var K,_,Q;if(!R.value)return;const L=((K=A.value)==null?void 0:K.name)||((_=V.value)==null?void 0:_.name),q={assignee:L};w.value&&(q.assignmentNote=w.value),await S.updateOpportunity(i.opportunity.id,q),await S.addActivity(i.opportunity.id,{type:"assignment",user:((Q=d.currentUser)==null?void 0:Q.name)||"You",action:"assigned opportunity",content:`Opportunity assigned to ${L}${w.value?` with note: ${w.value}`:""}`,timestamp:new Date().toISOString()}),l("assigned",{opportunity:i.opportunity,assignee:L,note:w.value})}C({canSubmit:R,submit:P});const z=$(()=>"This is the second no-show. Please make every effort to reach the customer and reschedule."),H=$(()=>{var q;return(q=i.scheduledAppointment)!=null&&q.start?new Date(i.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"});return Mn(()=>{var L,q,K;if(i.opportunity.assignee&&!V.value&&!A.value){const _=(L=g.value)==null?void 0:L.find(ue=>ue.name===i.opportunity.assignee),Q=(q=y.value)==null?void 0:q.find(ue=>ue.name===i.opportunity.assignee);if(_){const ue=(K=y.value)==null?void 0:K.find(ne=>ne.name===_.team||ne.id===_.teamId);ue&&(V.value=ue,A.value=_)}else Q&&(V.value=Q)}i.opportunity.assignmentNote&&(w.value=i.opportunity.assignmentNote)}),ve(()=>i.opportunity.assignee,L=>{var q,K,_;if(L&&!V.value&&!A.value){const Q=(q=g.value)==null?void 0:q.find(ne=>ne.name===L),ue=(K=y.value)==null?void 0:K.find(ne=>ne.name===L);if(Q){const ne=(_=y.value)==null?void 0:_.find(E=>E.name===Q.team||E.id===Q.teamId);ne&&(V.value=ne,A.value=Q)}else ue&&(V.value=ue)}}),(L,q)=>(f(),k("div",uy,[e("div",dy,[q[3]||(q[3]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"2nd No-Show Follow-up Task",-1)),e("p",cy," Appointment was scheduled for "+U(H.value)+" but customer did not show up. "+U(z.value),1)]),e("div",my,[q[8]||(q[8]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign to",-1)),e("div",fy,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[4]||(q[4]=[D("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(vt),{modelValue:c.value,"onUpdate:modelValue":q[0]||(q[0]=K=>c.value=K),items:b.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",py,[e("span",vy,U(K.dealership||"No location"),1),q[5]||(q[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",gy,U(K.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[6]||(q[6]=[D("Salesperson ",-1),e("span",{class:"text-muted-foreground text-xs"},"(optional)",-1)])]),_:1}),n(t(vt),{modelValue:x.value,"onUpdate:modelValue":q[1]||(q[1]=K=>x.value=K),items:h.value,disabled:!V.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",yy,[e("div",{class:re(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",F(K.role)])},U(p(K.name)),3),e("span",by,U(K.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",hy,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...q[7]||(q[7]=[D("Notes for assignee",-1)])]),_:1}),n(t(He),{modelValue:w.value,"onUpdate:modelValue":q[2]||(q[2]=K=>w.value=K),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])]))}},wy={class:"space-y-4"},ky={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Sy={class:"text-sm text-muted-foreground"},Cy={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},$y={__name:"NS3Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["close-as-lost","cancel"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(null),d=$(()=>"This is the third no-show. The opportunity will be automatically closed as lost if another appointment is not successfully completed."),S=$(()=>{var y;return(y=i.scheduledAppointment)!=null&&y.start?new Date(i.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"}),V=$(()=>{var g;return((g=u.value)==null?void 0:g.canSubmit)||!1});function A(){var g;(g=u.value)==null||g.submit()}function w(g){l("close-as-lost",{opportunity:i.opportunity,reason:g})}return C({canSubmit:V,submit:A}),(g,y)=>(f(),k("div",wy,[e("div",ky,[y[0]||(y[0]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"3rd No-Show Follow-up Task",-1)),e("p",Sy," Appointment was scheduled for "+U(S.value)+" but customer did not show up. "+U(d.value),1)]),e("div",Cy,[y[1]||(y[1]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Close Opportunity as Lost",-1)),n(Vs,{ref_key:"closeFormRef",ref:u,"show-multiple-no-shows":!0,"preselected-reason":"Multiple no shows","close-button-label":"Close as Lost",onClose:w},null,512)])]))}},Dy={class:"space-y-4"},Ay={class:"flex justify-end gap-2"},Ty={__name:"OfferAssignmentTask",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["offer-created","cancel","open-create-offer-modal"],setup(s){return(C,a)=>(f(),k("div",Dy,[a[4]||(a[4]=e("div",{class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},[e("h4",{class:"font-bold text-foreground text-sm mb-1"},"Create Offer"),e("p",{class:"text-sm text-muted-foreground"}," Customer showed up for the appointment. Create an offer to proceed with the opportunity. ")],-1)),e("div",Ay,[n(t(J),{variant:"outline",size:"small",onClick:a[0]||(a[0]=i=>C.$emit("cancel"))},{default:o(()=>[...a[2]||(a[2]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",size:"small",onClick:a[1]||(a[1]=i=>C.$emit("open-create-offer-modal"))},{default:o(()=>[...a[3]||(a[3]=[D(" Create Offer ",-1)])]),_:1})])]))}},Oy={key:0,class:"absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center rounded-lg"},Iy={key:2,class:"absolute top-1 right-1 z-30"},Vy=["onClick"],Fy={class:"flex-1 space-y-1"},Ly={class:"flex flex-col"},Ny={key:0,class:"text-[10px] text-muted-foreground line-clamp-2 mt-0.5 leading-tight"},qy={key:1,class:"mt-2 p-1.5 bg-muted/50 rounded border border-border/50"},Uy={class:"flex items-center gap-1 mb-1"},Py={class:"space-y-0.5"},My={key:0,class:"flex items-center gap-1 text-[9px] text-foreground font-medium"},Ry={class:"line-clamp-1"},Ey={key:1,class:"flex items-center gap-1 text-[9px] text-foreground font-medium"},jy={class:"line-clamp-1"},By={class:"mt-auto pt-1"},zy={key:4,class:"absolute bottom-0 left-0 right-0 z-10 bg-green-600/90 text-white text-[10px] font-medium px-2 py-1.5 flex items-center justify-between pointer-events-none"},Wy={key:0,class:"opacity-90"},_y={__name:"ContractCard",props:{contract:{type:Object,required:!0},variant:{type:String,default:"carousel",validator:s=>["carousel","feed"].includes(s)},showStatusBadge:{type:Boolean,default:!0},showMenu:{type:Boolean,default:!0},showDate:{type:Boolean,default:!0},showSignedBadge:{type:Boolean,default:!0},menuItems:{type:Array,default:()=>[]},containerClass:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["menu-action"],setup(s,{emit:C}){const a=s,i=$(()=>a.contract.id||a.contract.contractDate||`contract-${Math.random()}`),l=T(null),u=T({}),d=T({}),S=$(()=>a.contract.contractSigned||a.contract.esignatureCollectedDate),V=$(()=>(a.variant==="carousel","h-16")),A=$(()=>a.variant==="carousel"?"p-2":"p-3"),w=$(()=>a.variant==="carousel"?"h-[105px]":""),g=$(()=>a.variant==="carousel"?"text-xs":"text-sm"),y=$(()=>(a.variant==="carousel","text-xs")),b=(_,Q)=>{Q&&(u.value[_]=Q)},h=()=>{if(a.menuItems.length===0)return 120;const _=document.createElement("span");_.style.visibility="hidden",_.style.position="absolute",_.style.fontSize="0.75rem",_.style.padding="0 12px",_.style.whiteSpace="nowrap",document.body.appendChild(_);let Q=0;return a.menuItems.forEach(ue=>{_.textContent=ue.label;const ne=_.offsetWidth;ne>Q&&(Q=ne)}),document.body.removeChild(_),Math.max(Q+24,120)},c=_=>{const Q=u.value[_];if(!Q)return;const ue=Q.getBoundingClientRect(),ne=h();d.value[_]={top:ue.bottom+4,left:ue.right-ne,width:ne}},x=async _=>{l.value===_?(l.value=null,delete d.value[_]):(l.value=_,await la(),c(_))},p=()=>{l.value=null,d.value={}};let F=null,R=null;ve(l,_=>{if(F&&(window.removeEventListener("scroll",F,!0),window.removeEventListener("resize",R),F=null,R=null),_){const Q=()=>{_&&u.value[_]&&c(_)};F=Q,R=Q,window.addEventListener("scroll",F,!0),window.addEventListener("resize",R)}});const P=_=>{if(!_)return"";const Q=new Date(_),ne=Math.abs(new Date-Q),E=Math.ceil(ne/(1e3*60*60*24));return E===0?"today":E===1?"yesterday":E<7?`${E} days ago`:Q.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})},z=_=>({active:"Active",signed:"Signed",draft:"Draft",archived:"Archived"})[_]||"Active",H=_=>({active:"bg-blue-600",signed:"bg-green-600",draft:"bg-gray-500",archived:"bg-gray-600"})[_]||"bg-gray-600",L=_=>S.value?"border-green-500 border-2":"border-border",q=_=>_.status==="archived"?"opacity-60":"",K=_=>_.version?`Contract v${_.version}`:_.contractDate?`Contract - ${new Date(_.contractDate).toLocaleDateString("en-US",{month:"short",day:"numeric"})}`:"Contract";return(_,Q)=>{const ue=Ts("click-outside");return f(),k("div",{class:re(["bg-white border rounded-lg shadow-nsc-card overflow-visible transition-shadow relative",L(s.contract),q(s.contract),s.containerClass,{"pointer-events-none opacity-60":s.loading}])},[s.loading?(f(),k("div",Oy,[...Q[2]||(Q[2]=[e("div",{class:"flex flex-col items-center gap-2"},[e("div",{class:"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e("span",{class:"text-xs text-muted-foreground"},"Updating...")],-1)])])):N("",!0),s.showStatusBadge&&!(S.value&&s.showSignedBadge)?(f(),k("div",{key:1,class:re(["absolute top-1 left-1 z-10 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm uppercase tracking-wider",H(s.contract.status)])},U(z(s.contract.status)),3)):N("",!0),s.showMenu?(f(),k("div",Iy,[e("button",{ref:ne=>b(i.value,ne),onClick:Q[0]||(Q[0]=ln(ne=>x(i.value),["stop"])),title:"Contract actions",class:"relative z-30 w-6 h-6 flex items-center justify-center text-foreground hover:bg-black/10 bg-white/60 backdrop-blur-sm rounded-md transition-colors shadow-sm border border-black/5"},[n(t(il),{size:14})],512)])):N("",!0),s.showMenu?(f(),ee(Ao,{key:3,to:"body"},[l.value===i.value&&d.value[i.value]?Se((f(),k("div",{key:0,class:"fixed z-[9999] bg-white border border-black/10 rounded-lg shadow-nsc-card py-1",style:nl({top:`${d.value[i.value].top}px`,left:`${d.value[i.value].left}px`,width:`${d.value[i.value].width}px`,minWidth:"120px"}),onClick:Q[1]||(Q[1]=ln(()=>{},["stop"]))},[(f(!0),k(pe,null,Ie(s.menuItems,ne=>(f(),k("button",{key:ne.key,onClick:()=>{ne.onClick(),p()},class:"w-full px-3 py-2 text-left text-xs text-foreground hover:bg-muted flex items-center gap-2",style:{"font-size":"0.75rem","line-height":"1.5"}},U(ne.label),9,Vy))),128))],4)),[[ue,p]]):N("",!0)])):N("",!0),e("div",{class:re(["w-full bg-muted flex items-center justify-center overflow-hidden",V.value])},[...Q[3]||(Q[3]=[e("i",{class:"fa-solid fa-file-signature text-base text-muted-foreground"},null,-1)])],2),e("div",{class:re(["flex flex-col",A.value,w.value,{"pb-10":S.value}])},[e("div",Fy,[e("h4",{class:re(["font-bold text-foreground leading-tight line-clamp-2",g.value])},U(K(s.contract)),3),e("div",Ly,[s.contract.contractNotes?(f(),k("p",Ny,U(s.contract.contractNotes),1)):N("",!0),s.contract.lockedTradeInLabel||s.contract.lockedFinancingLabel?(f(),k("div",qy,[e("div",Uy,[n(t(fi),{size:8,class:"text-amber-600"}),Q[4]||(Q[4]=e("span",{class:"text-[8px] font-bold text-amber-700 uppercase tracking-tighter"},"Locked Terms",-1))]),e("div",Py,[s.contract.lockedFinancingLabel?(f(),k("div",My,[n(t(li),{size:8,class:"text-purple-600"}),e("span",Ry,U(s.contract.lockedFinancingLabel),1)])):N("",!0),s.contract.lockedTradeInLabel?(f(),k("div",Ey,[n(t(To),{size:8,class:"text-blue-600"}),e("span",jy,U(s.contract.lockedTradeInLabel),1)])):N("",!0)])])):N("",!0)])]),e("div",By,[s.showDate&&s.contract.contractDate&&!(S.value&&s.showSignedBadge)?(f(),k("p",{key:0,class:re(["text-muted-foreground",y.value])},U(P(s.contract.contractDate)),3)):N("",!0)])],2),s.showSignedBadge&&S.value?(f(),k("div",zy,[Q[5]||(Q[5]=e("span",{class:"flex items-center gap-1"},[e("i",{class:"fa-solid fa-check-circle"}),D(" Signed ")],-1)),s.contract.esignatureCollectedDate?(f(),k("span",Wy,U(P(s.contract.esignatureCollectedDate)),1)):N("",!0)])):N("",!0)],2)}}},Yy={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},Hy={class:"space-y-4"},Qy={__name:"CollectESignaturesModal",props:{show:{type:Boolean,required:!0},contract:{type:Object,default:null},maxContractDate:{type:String,default:""}},emits:["confirm","cancel"],setup(s,{emit:C}){const a=s,i=C,l=T(""),u=T(""),d=T(""),S=$(()=>a.maxContractDate?a.maxContractDate:new Date().toISOString().split("T")[0]),V=$(()=>!!l.value);ve(()=>a.show,y=>{var b,h;if(y){const c=new Date;if(l.value=c.toISOString().split("T")[0],u.value=c.toTimeString().slice(0,5),d.value="",(b=a.contract)!=null&&b.contractDate){const x=new Date(a.contract.contractDate);if(l.value=x.toISOString().split("T")[0],x.getHours()||x.getMinutes()){const p=String(x.getHours()).padStart(2,"0"),F=String(x.getMinutes()).padStart(2,"0");u.value=`${p}:${F}`}}(h=a.contract)!=null&&h.contractNotes&&(d.value=a.contract.contractNotes)}});const A=()=>{if(!l.value)return;const y=u.value?`${l.value}T${u.value}:00`:`${l.value}T12:00:00`;i("confirm",{contractDate:y,contractTime:u.value,notes:d.value})},w=()=>{i("cancel")},g=y=>{y||w()};return(y,b)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":g},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...b[3]||(b[3]=[D("Collect e-signatures, finalize contract",-1)])]),_:1}),b[4]||(b[4]=e("p",{class:"text-sm text-muted-foreground mt-1"}," Get the formal contract signed electronically by the customer. Finalize all contractual terms and conditions. Ensure all required signatures are collected. Set the official Contract Date when customer signs. ",-1))]),_:1}),e("div",Yy,[e("div",Hy,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[5]||(b[5]=[D("Contract Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:l.value,"onUpdate:modelValue":b[0]||(b[0]=h=>l.value=h),max:S.value,class:"w-full"},null,8,["modelValue","max"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[6]||(b[6]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:u.value,"onUpdate:modelValue":b[1]||(b[1]=h=>u.value=h),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[7]||(b[7]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:d.value,"onUpdate:modelValue":b[2]||(b[2]=h=>d.value=h),rows:"4",placeholder:"Add any relevant notes about the contract signing...",class:"w-full"},null,8,["modelValue"])])])]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:w}),n(t(J),{label:"Collect e-signatures",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!V.value,onClick:A},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Gy={key:0},Jy={class:"flex items-center justify-between mb-2"},Ky={class:"flex items-center gap-2"},Zy={class:"font-semibold text-foreground text-sm"},Xy={class:"relative"},e1={class:"flex overflow-x-auto space-x-2 pb-2 scrollbar-hide scroll-smooth snap-x snap-mandatory",style:{"scrollbar-width":"thin"}},t1={class:"w-8 h-8 rounded-full bg-background border border-border flex items-center justify-center text-muted-foreground group-hover:text-foreground transition-colors shadow-sm"},n1={key:1,class:"flex flex-col items-center justify-center py-6 px-3 bg-muted border border-border rounded-lg gap-3"},s1={__name:"ContractCarousel",props:{contracts:{type:Array,default:()=>[]},opportunityId:{type:[Number,String],required:!0},maxContractDate:{type:String,default:""}},emits:["generate-pdf","contract-activated","collect-esignatures","add"],setup(s,{expose:C,emit:a}){const i=a,l=T(new Set),u=T(!1),d=T(null),S=(g,y)=>{y?l.value.add(g):l.value.delete(g)},V=g=>{const y=[];return!g.contractSigned&&!g.esignatureCollectedDate&&y.push({key:"collect-esignatures",label:"Collect e-signatures",onClick:()=>{d.value=g,u.value=!0}}),y.push({key:"generate-contract-pdf",label:"Generate Contract PDF",onClick:()=>{i("generate-pdf",g)}}),y},A=g=>{d.value&&(S(d.value.id||d.value.contractDate,!0),i("collect-esignatures",{contract:d.value,formData:g})),u.value=!1,d.value=null},w=()=>{u.value=!1,d.value=null};return C({setContractLoading:S}),(g,y)=>(f(),k(pe,null,[s.contracts&&s.contracts.length>0?(f(),k("div",Gy,[e("div",Jy,[e("div",Ky,[e("h3",Zy,"Contracts ("+U(s.contracts.length)+")",1)])]),e("div",Xy,[e("div",e1,[(f(!0),k(pe,null,Ie(s.contracts,b=>(f(),ee(_y,{key:`contract-${b.id||b.contractDate}-${b.version||"v1"}`,contract:b,variant:"carousel","menu-items":V(b),loading:l.value.has(b.id||b.contractDate),"container-class":"flex-none w-36 snap-start"},null,8,["contract","menu-items","loading"]))),128)),e("button",{class:"flex-none w-36 h-[171px] snap-start bg-muted/50 border-2 border-dashed border-border rounded-lg flex flex-col items-center justify-center gap-2 hover:bg-muted/80 transition-colors group",onClick:y[0]||(y[0]=b=>g.$emit("add"))},[e("div",t1,[n(t(Xs),{size:20})]),y[2]||(y[2]=e("span",{class:"text-[10px] font-medium text-muted-foreground group-hover:text-foreground uppercase tracking-wider"},"New Contract",-1))])])])])):(f(),k("div",n1,[y[3]||(y[3]=e("i",{class:"fa-solid fa-file-contract text-2xl text-muted-foreground"},null,-1)),y[4]||(y[4]=e("p",{class:"text-xs font-medium text-muted-foreground"},"No contracts created yet",-1)),y[5]||(y[5]=e("p",{class:"text-xs text-muted-foreground"},"Create a contract to track versions",-1)),e("button",{class:"inline-flex items-center justify-center gap-2 w-10 h-10 rounded-full bg-background border-2 border-dashed border-border text-muted-foreground hover:border-foreground hover:text-foreground transition-colors",onClick:y[1]||(y[1]=b=>g.$emit("add")),title:"Add contract"},[n(t(Xs),{size:20})])])),n(Qy,{show:u.value,contract:d.value,"max-contract-date":s.maxContractDate,onConfirm:A,onCancel:w},null,8,["show","contract","max-contract-date"])],64))}},Ga=on(s1,[["__scopeId","data-v-ca533735"]]),a1={class:"rounded-lg flex flex-col bg-muted"},l1={class:"pt-1 px-1"},o1={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},i1={class:"p-6"},r1={class:"mb-3"},u1={class:"text-sm text-muted-foreground mt-0.5"},d1={key:0,class:"ml-2"},c1=["href"],m1={class:"flex flex-wrap gap-3 items-center"},f1={class:"outcome-toggle-group flex flex-wrap gap-3"},p1={class:"px-4 py-4 space-y-4"},v1={key:0},g1={key:2},y1={key:3,class:"flex justify-end gap-2 px-4 pb-4 pt-3"},b1={key:0,class:"mt-4"},h1={__name:"AppointmentManagementSection",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,default:null},showRescheduleSection:{type:Boolean,default:!1},showNsTaskSection:{type:Boolean,default:!1},showOfferAssignmentSection:{type:Boolean,default:!1},nsTaskCount:{type:Number,default:0},canSubmitNsTask:{type:Boolean,default:!1},nsTaskButtonLabel:{type:String,default:"Assign"},canCreateOffer:{type:Boolean,default:!1},secondaryActions:{type:Array,default:()=>[]},customerName:{type:String,default:""},customerProfileUrl:{type:String,default:""},isAppointmentToday:{type:Boolean,default:!1}},emits:["confirm-appointment","update:show-reschedule-section","update:show-ns-task-section","update:show-offer-assignment-section","mark-no-show","mark-showed-up","reschedule-submit","reschedule-cancel","ns-assigned","ns-cancel","ns-confirm","ns-close-as-lost","offer-assignment-created","offer-assignment-cancel","offer-assignment-confirm","open-create-offer-modal","secondary-action","customer-click","close-as-lost-confirmed"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(null),d=T(null),S=T(null),V=T(null),A=T(null),w=T(null),{reason:g,notes:y,cardRef:b,reset:h}=Sl(),c=["close-lost"];function x(P){l("customer-click",P)}function p(P){c.includes(P.key)?w.value===P.key?w.value=null:(w.value=P.key,l("update:show-reschedule-section",!1),l("update:show-ns-task-section",!1),l("update:show-offer-assignment-section",!1),P.key==="close-lost"&&h()):l("secondary-action",P)}function F(){w.value=null,h()}function R(P){l("close-as-lost-confirmed",{reason:P.reason,notes:P.notes}),w.value=null,g.value="",y.value=""}return ve(()=>i.showRescheduleSection,P=>{P&&(w.value=null)}),ve(()=>i.showNsTaskSection,P=>{P&&(w.value=null)}),ve(()=>i.showOfferAssignmentSection,P=>{P&&(w.value=null)}),C({scheduleFormRef:u,ns1TaskRef:d,ns2TaskRef:S,ns3TaskRef:V,offerAssignmentTaskRef:A,closeAsLostCardRef:b}),(P,z)=>{var H,L;return f(),k("div",a1,[e("div",l1,[e("div",o1,[e("div",i1,[e("div",r1,[z[18]||(z[18]=e("h4",{class:"font-bold text-foreground text-sm"},"Manage Appointment",-1)),e("p",u1,[D(" Appointment scheduled for "+U((H=s.scheduledAppointment)!=null&&H.start?t(qn)(s.scheduledAppointment.start):"TBD")+" ",1),s.opportunity.customer||s.opportunity.customerId?(f(),k("span",d1,[z[17]||(z[17]=D(" with ",-1)),e("a",{href:s.customerProfileUrl,target:"_blank",onClick:ln(x,["stop"]),class:"text-primary hover:underline font-medium"},U(s.customerName),9,c1)])):N("",!0)])]),e("div",m1,[((L=s.scheduledAppointment)==null?void 0:L.status)==="pending_confirmation"?(f(),ee(t(J),{key:0,variant:"outline",onClick:z[0]||(z[0]=q=>P.$emit("confirm-appointment")),class:"inline-flex items-center gap-2 cursor-pointer"},{default:o(()=>[...z[19]||(z[19]=[e("i",{class:"fa-solid fa-calendar-check"},null,-1),e("span",null,"Confirm appointment",-1)])]),_:1})):N("",!0),e("div",f1,[s.isAppointmentToday?N("",!0):(f(),ee(t(Ue),{key:0,variant:"outline","model-value":s.showRescheduleSection,"onUpdate:modelValue":z[1]||(z[1]=q=>{P.$emit("update:show-reschedule-section",q),q&&(P.$emit("update:show-ns-task-section",!1),P.$emit("update:show-offer-assignment-section",!1),w.value.value=null)}),class:"outcome-toggle-item"},{default:o(()=>[...z[20]||(z[20]=[e("i",{class:"fa-solid fa-calendar-days"},null,-1),e("span",null,"Reschedule",-1)])]),_:1},8,["model-value"])),s.isAppointmentToday?(f(),ee(t(Ue),{key:1,variant:"outline","model-value":s.showNsTaskSection,"onUpdate:modelValue":z[2]||(z[2]=q=>{q?(P.$emit("mark-no-show"),w.value.value=null):P.$emit("update:show-ns-task-section",!1)}),class:"outcome-toggle-item"},{default:o(()=>[...z[21]||(z[21]=[e("i",{class:"fa-solid fa-user-slash"},null,-1),e("span",null,"Mark No-Show",-1)])]),_:1},8,["model-value"])):N("",!0),s.isAppointmentToday?(f(),ee(t(Ue),{key:2,variant:"outline","model-value":s.showOfferAssignmentSection,"onUpdate:modelValue":z[3]||(z[3]=q=>{q?(P.$emit("mark-showed-up"),w.value.value=null):P.$emit("update:show-offer-assignment-section",!1)}),class:"outcome-toggle-item"},{default:o(()=>[...z[22]||(z[22]=[e("i",{class:"fa-solid fa-user-check"},null,-1),e("span",null,"Mark Showed Up",-1)])]),_:1},8,["model-value"])):N("",!0)]),s.secondaryActions&&s.secondaryActions.length>0?(f(),ee(Pn,{key:1,actions:s.secondaryActions,onActionSelected:p},null,8,["actions"])):N("",!0)])])])]),e("div",p1,[s.showRescheduleSection?(f(),k("div",v1,[n(ls,{ref_key:"scheduleFormRef",ref:u,opportunity:s.opportunity,mode:"reschedule","initial-appointment":s.scheduledAppointment,onSubmit:z[4]||(z[4]=q=>P.$emit("reschedule-submit",q)),onCancel:z[5]||(z[5]=q=>P.$emit("reschedule-cancel"))},null,8,["opportunity","initial-appointment"])])):N("",!0),w.value==="close-lost"?(f(),ee(ca,{key:1,ref_key:"closeAsLostCardRef",ref:b,"preselected-reason":t(g),"preselected-notes":t(y),onCancel:F,onConfirm:R},null,8,["preselected-reason","preselected-notes"])):N("",!0),s.showNsTaskSection?(f(),k("div",g1,[s.nsTaskCount===1?(f(),ee(ry,{key:0,ref_key:"ns1TaskRef",ref:d,opportunity:s.opportunity,"scheduled-appointment":s.scheduledAppointment,onAssigned:z[6]||(z[6]=q=>P.$emit("ns-assigned",q)),onCancel:z[7]||(z[7]=q=>P.$emit("ns-cancel"))},null,8,["opportunity","scheduled-appointment"])):s.nsTaskCount===2?(f(),ee(xy,{key:1,ref_key:"ns2TaskRef",ref:S,opportunity:s.opportunity,"scheduled-appointment":s.scheduledAppointment,onAssigned:z[8]||(z[8]=q=>P.$emit("ns-assigned",q)),onCancel:z[9]||(z[9]=q=>P.$emit("ns-cancel"))},null,8,["opportunity","scheduled-appointment"])):s.nsTaskCount>=3?(f(),ee($y,{key:2,ref_key:"ns3TaskRef",ref:V,opportunity:s.opportunity,"scheduled-appointment":s.scheduledAppointment,onCloseAsLost:z[10]||(z[10]=q=>P.$emit("ns-close-as-lost",q)),onCancel:z[11]||(z[11]=q=>P.$emit("ns-cancel"))},null,8,["opportunity","scheduled-appointment"])):N("",!0)])):N("",!0),s.showNsTaskSection?(f(),k("div",y1,[n(t(J),{variant:"secondary",onClick:z[12]||(z[12]=q=>P.$emit("ns-cancel"))},{default:o(()=>[...z[23]||(z[23]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"primary",disabled:!s.canSubmitNsTask,onClick:z[13]||(z[13]=q=>P.$emit("ns-confirm")),class:"bg-primary"},{default:o(()=>[D(U(s.nsTaskButtonLabel),1)]),_:1},8,["disabled"])])):N("",!0),n($s,{name:"expand"},{default:o(()=>[s.showOfferAssignmentSection?(f(),k("div",b1,[n(Ty,{ref_key:"offerAssignmentTaskRef",ref:A,opportunity:s.opportunity,"scheduled-appointment":s.scheduledAppointment,onOfferCreated:z[14]||(z[14]=q=>P.$emit("offer-assignment-created",q)),onCancel:z[15]||(z[15]=q=>P.$emit("offer-assignment-cancel")),onOpenCreateOfferModal:z[16]||(z[16]=q=>P.$emit("open-create-offer-modal"))},null,8,["opportunity","scheduled-appointment"])])):N("",!0)]),_:1})])])}}},x1=on(h1,[["__scopeId","data-v-13928b4b"]]),w1={class:"rounded-lg flex flex-col bg-muted"},k1={class:"pt-1 px-1"},S1={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},C1={class:"p-6"},$1={class:"mb-3"},D1={class:"text-sm text-muted-foreground mt-0.5"},A1={key:0,class:"mb-4 p-4 bg-muted rounded-lg"},T1={class:"flex flex-wrap gap-3 items-center"},O1={key:0,class:"outcome-toggle-group flex flex-wrap gap-3"},I1={key:1,class:"outcome-toggle-group flex flex-wrap gap-3"},V1={class:"px-4 py-4 space-y-4"},F1={key:0,class:"space-y-4"},L1={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},N1={class:"followup-channel-toggle-group flex flex-wrap gap-2 mb-4"},q1={key:0,class:"space-y-3"},U1={key:0},P1={class:"flex items-center justify-between gap-2"},M1={class:"text-muted-foreground text-xs"},R1={key:1,class:"flex justify-end gap-2 pt-3"},E1={key:2,class:"space-y-4"},j1={class:"flex justify-between items-center pt-3"},B1={class:"flex gap-2"},z1={__name:"NegotiationManagementSection",props:{opportunity:{type:Object,required:!0},showNegotiationSection:{type:Boolean,default:!1},showAddOfferSection:{type:Boolean,default:!1},showSurveySection:{type:Boolean,default:!1},negotiationChannel:{type:String,default:null},negotiationMessage:{type:String,default:""},negotiationSelectedOfferId:{type:String,default:null},offerSelectOptions:{type:Array,default:()=>[]},canSendNegotiationMessage:{type:Boolean,default:!1},secondaryActions:{type:Array,default:()=>[]}},emits:["update:show-negotiation-section","update:show-add-offer-section","update:show-survey-section","update:negotiation-channel","update:negotiation-message","update:negotiation-selected-offer-id","reset-negotiation-form","send-negotiation-message","cancel-negotiation","offer-created","cancel-add-offer","open-add-offer-modal","open-add-tradein","open-add-financing","offer-accepted","mark-offer-accepted","secondary-action","ofb-postpone","survey-submitted","survey-cancelled"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=T(null);$(()=>{var c;return((c=i.opportunity)==null?void 0:c.offers)&&i.opportunity.offers.length>0});const d=$(()=>{const c=i.opportunity.lastActivity||i.opportunity.createdAt;if(!c)return 0;const x=new Date(c),F=Math.abs(new Date-x);return Math.ceil(F/(1e3*60*60*24))}),S=$(()=>{var c;return((c=u.value)==null?void 0:c.isValid)||!1}),V=()=>{u.value&&u.value.submit()},A=c=>{l("survey-submitted",{opportunity:i.opportunity,surveyData:c}),l("update:show-survey-section",!1)},w=()=>{l("update:show-survey-section",!1),l("survey-cancelled",{opportunity:i.opportunity})},g=c=>{l("ofb-postpone",c),l("update:show-survey-section",!1)},y=c=>{const x=["add-offer","create-offer"],p=["follow-up","request-feedback","collect-feedback","reassign","schedule-appointment","close-lost"];if(x.includes(c.key)){l("open-add-offer-modal");return}if(p.includes(c.key)){const F=!i.showNegotiationSection;l("update:show-negotiation-section",F),F?(l("update:show-add-offer-section",!1),l("update:show-survey-section",!1)):l("reset-negotiation-form")}else{const F=!i.showNegotiationSection;l("update:show-negotiation-section",F),F?(l("update:show-add-offer-section",!1),l("update:show-survey-section",!1)):l("reset-negotiation-form")}l("secondary-action",c)},b=$(()=>{var p,F;if(((p=i.opportunity)==null?void 0:p.negotiationSubstatus)!=="Offer Sent")return!1;const x={opportunity:i.opportunity,hasOffers:((F=i.opportunity)==null?void 0:F.offers)&&i.opportunity.offers.length>0,stage:"In Negotiation",activities:[]};return _a["negotiation-5-plus-days-no-contract-has-offers"](x)});$(()=>{var F,R,P;if(!(((F=i.opportunity)==null?void 0:F.id)===33)&&!i.showNegotiationSection||((R=i.opportunity)==null?void 0:R.negotiationSubstatus)!=="Offer Sent")return!1;const p={opportunity:i.opportunity,hasOffers:((P=i.opportunity)==null?void 0:P.offers)&&i.opportunity.offers.length>0,stage:"In Negotiation",activities:[]};return _a["negotiation-5-plus-days-no-contract-has-offers"](p)});function h(c){return new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(c).replace("€","€")}return C({ofbTaskRef:u}),(c,x)=>(f(),k("div",w1,[e("div",k1,[e("div",S1,[e("div",C1,[e("div",$1,[x[14]||(x[14]=e("h4",{class:"font-bold text-foreground text-sm"},"Manage Offers & Follow Up",-1)),e("p",D1,[s.opportunity.offers&&s.opportunity.offers.length>0?(f(),k(pe,{key:0},[b.value?(f(),k(pe,{key:0},[D(" This opportunity has been in negotiation for "+U(d.value)+" days without a contract. Follow up with customer to get feedback and move forward. ",1)],64)):(f(),k(pe,{key:1},[D(" Follow up with customer about offers ")],64))],64)):(f(),k(pe,{key:1},[D(" Create an offer to continue negotiation ")],64))])]),!s.opportunity.offers||s.opportunity.offers.length===0?(f(),k("div",A1,[...x[15]||(x[15]=[e("p",{class:"text-sm text-muted-foreground"},"No offers yet. Create your first offer to continue.",-1)])])):N("",!0),e("div",T1,[s.opportunity.negotiationSubstatus==="Offer Sent"?(f(),k("div",O1,[n(t(Ue),{variant:"outline","model-value":s.showNegotiationSection,"onUpdate:modelValue":x[0]||(x[0]=p=>{c.$emit("update:show-negotiation-section",p),p?(c.$emit("update:show-add-offer-section",!1),c.$emit("update:show-survey-section",!1)):c.$emit("reset-negotiation-form")}),class:"outcome-toggle-item"},{default:o(()=>[...x[16]||(x[16]=[e("i",{class:"fa-solid fa-phone-volume"},null,-1),e("span",null,"Follow Up",-1)])]),_:1},8,["model-value"]),b.value?(f(),ee(t(Ue),{key:0,variant:"outline","model-value":s.showSurveySection,"onUpdate:modelValue":x[1]||(x[1]=p=>{c.$emit("update:show-survey-section",p),p&&(c.$emit("update:show-negotiation-section",!1),c.$emit("update:show-add-offer-section",!1))}),class:"outcome-toggle-item"},{default:o(()=>[...x[17]||(x[17]=[e("i",{class:"fa-solid fa-clipboard-list"},null,-1),e("span",null,"Complete Survey",-1)])]),_:1},8,["model-value"])):N("",!0)])):(f(),k("div",I1,[n(t(Ue),{variant:"outline","model-value":s.showNegotiationSection,"onUpdate:modelValue":x[2]||(x[2]=p=>{c.$emit("update:show-negotiation-section",p),p?(c.$emit("update:show-add-offer-section",!1),c.$emit("update:show-survey-section",!1)):c.$emit("reset-negotiation-form")}),class:"outcome-toggle-item"},{default:o(()=>[x[18]||(x[18]=e("i",{class:"fa-solid fa-phone-volume"},null,-1)),e("span",null,U(s.opportunity.negotiationSubstatus==="Offer Feedback"?"Request Feedback":"Follow Up"),1)]),_:1},8,["model-value"]),n(t(J),{variant:"outline",size:"small",class:"gap-2",onClick:x[3]||(x[3]=p=>c.$emit("open-add-offer-modal"))},{default:o(()=>[...x[19]||(x[19]=[e("i",{class:"fa-solid fa-plus"},null,-1),e("span",null,"Add Offer",-1)])]),_:1}),b.value?(f(),ee(t(Ue),{key:0,variant:"outline","model-value":s.showSurveySection,"onUpdate:modelValue":x[4]||(x[4]=p=>{c.$emit("update:show-survey-section",p),p&&(c.$emit("update:show-negotiation-section",!1),c.$emit("update:show-add-offer-section",!1))}),class:"outcome-toggle-item"},{default:o(()=>[...x[20]||(x[20]=[e("i",{class:"fa-solid fa-clipboard-list"},null,-1),e("span",null,"Complete Survey",-1)])]),_:1},8,["model-value"])):N("",!0)])),s.secondaryActions&&s.secondaryActions.length>0?(f(),ee(Pn,{key:2,actions:s.secondaryActions,onActionSelected:y},null,8,["actions"])):N("",!0)])])])]),e("div",V1,[s.showNegotiationSection?(f(),k("div",F1,[e("div",L1,[x[27]||(x[27]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Contact Customer",-1)),e("div",N1,[n(t(Ue),{variant:"outline","model-value":s.negotiationChannel==="call","onUpdate:modelValue":x[5]||(x[5]=p=>p&&c.$emit("update:negotiation-channel","call")),class:"followup-toggle-item"},{default:o(()=>[...x[21]||(x[21]=[e("i",{class:"fa-solid fa-phone text-xs"},null,-1),e("span",null,"Call",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":s.negotiationChannel==="whatsapp","onUpdate:modelValue":x[6]||(x[6]=p=>p&&c.$emit("update:negotiation-channel","whatsapp")),class:"followup-toggle-item"},{default:o(()=>[...x[22]||(x[22]=[e("i",{class:"fa-brands fa-whatsapp text-xs"},null,-1),e("span",null,"WhatsApp",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":s.negotiationChannel==="sms","onUpdate:modelValue":x[7]||(x[7]=p=>p&&c.$emit("update:negotiation-channel","sms")),class:"followup-toggle-item"},{default:o(()=>[...x[23]||(x[23]=[e("i",{class:"fa-solid fa-message text-xs"},null,-1),e("span",null,"SMS",-1)])]),_:1},8,["model-value"]),n(t(Ue),{variant:"outline","model-value":s.negotiationChannel==="email","onUpdate:modelValue":x[8]||(x[8]=p=>p&&c.$emit("update:negotiation-channel","email")),class:"followup-toggle-item"},{default:o(()=>[...x[24]||(x[24]=[e("i",{class:"fa-solid fa-envelope text-xs"},null,-1),e("span",null,"Email",-1)])]),_:1},8,["model-value"])]),s.negotiationChannel?(f(),k("div",q1,[s.offerSelectOptions.length>0?(f(),k("div",U1,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...x[25]||(x[25]=[D("Select offer to reference (Optional)",-1)])]),_:1}),n(t(vt),{"model-value":s.negotiationSelectedOfferId,"onUpdate:modelValue":x[9]||(x[9]=p=>c.$emit("update:negotiation-selected-offer-id",p)),items:s.offerSelectOptions,placeholder:"Select an offer...","value-key":"id",class:"w-full"},{item:o(({item:p})=>[e("div",P1,[e("span",null,U(p.label),1),e("span",M1,"€ "+U(h(p.price)),1)])]),_:1},8,["model-value","items"])])):N("",!0),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...x[26]||(x[26]=[D("Message",-1)])]),_:1}),n(t(He),{"model-value":s.negotiationMessage,"onUpdate:modelValue":x[10]||(x[10]=p=>c.$emit("update:negotiation-message",p)),rows:"4",placeholder:"Type your message here...",class:"w-full"},null,8,["model-value"])])])):N("",!0)])])):N("",!0),s.showNegotiationSection?(f(),k("div",R1,[n(t(J),{variant:"secondary",onClick:x[11]||(x[11]=p=>c.$emit("cancel-negotiation"))},{default:o(()=>[...x[28]||(x[28]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!s.canSendNegotiationMessage,onClick:x[12]||(x[12]=p=>c.$emit("send-negotiation-message"))},{default:o(()=>[...x[29]||(x[29]=[D(" Send Message ",-1)])]),_:1},8,["disabled"])])):N("",!0),s.showSurveySection&&b.value?(f(),k("div",E1,[n(wl,{ref_key:"ofbTaskRef",ref:u,opportunity:s.opportunity,onSubmit:A,onPostpone:g},null,8,["opportunity"]),e("div",j1,[n(t(J),{variant:"secondary",onClick:x[13]||(x[13]=p=>c.$emit("ofb-postpone","ofb")),class:"flex items-center gap-2"},{default:o(()=>[...x[30]||(x[30]=[e("i",{class:"fa-solid fa-clock"},null,-1),e("span",null,"Postpone",-1)])]),_:1}),e("div",B1,[n(t(J),{variant:"secondary",onClick:w},{default:o(()=>[...x[31]||(x[31]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!S.value,onClick:V},{default:o(()=>[...x[32]||(x[32]=[D(" Submit Survey ",-1)])]),_:1},8,["disabled"])])])])):N("",!0)])]))}},W1={class:"rounded-lg flex flex-col bg-muted"},_1={class:"pt-1 px-1"},Y1={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},H1={class:"p-6"},Q1={class:"flex flex-wrap gap-3 items-center"},G1={key:1,class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},J1={class:"p-6"},K1={class:"flex flex-wrap gap-3 items-center"},Z1={class:"outcome-toggle-group flex flex-wrap gap-3"},X1={class:"px-4 py-4 space-y-4"},eb={key:0},tb={key:1},nb={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},sb={class:"space-y-4"},ab={class:"flex justify-end gap-2 mt-4"},lb={key:2},ob={__name:"ContractPendingManagementSection",props:{opportunity:{type:Object,required:!0},hasContracts:{type:Boolean,default:!1},showCloseAsLostSection:{type:Boolean,default:!1},showScheduleAppointmentContractPendingSection:{type:Boolean,default:!1},showSetDeliveryDateSection:{type:Boolean,default:!1},closeAsLostReason:{type:String,default:""},closeAsLostNotes:{type:String,default:""},deliveryDateForm:{type:Object,required:!0},hasDeliveryDate:{type:Boolean,default:!1},minDeliveryDate:{type:String,default:""},canSubmitSetDeliveryDate:{type:Boolean,default:!1},contractPendingActions:{type:Array,default:()=>[]}},emits:["update:show-schedule-appointment-contract-pending-section","update:show-set-delivery-date-section","update:delivery-date-form","confirm-set-delivery-date","cancel-set-delivery-date","schedule-appointment-contract-pending-submit","cancel-schedule-appointment-contract-pending","contract-pending-action","close-as-lost-cancel","close-as-lost-confirm"],setup(s,{expose:C}){const a=T(null),i=T(null);return C({scheduleAppointmentContractPendingFormRef:a,closeAsLostCardRef:i}),(l,u)=>(f(),k("div",W1,[e("div",_1,[s.hasContracts?(f(),k("div",G1,[e("div",J1,[u[15]||(u[15]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Set Delivery Date"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Schedule vehicle delivery with the customer. Set the delivery date, time, and location. ")],-1)),e("div",K1,[e("div",Z1,[s.hasDeliveryDate?N("",!0):(f(),ee(t(Ue),{key:0,variant:"outline","model-value":s.showSetDeliveryDateSection,"onUpdate:modelValue":u[1]||(u[1]=d=>l.$emit("update:show-set-delivery-date-section",d)),class:"outcome-toggle-item"},{default:o(()=>[...u[14]||(u[14]=[e("i",{class:"fa-solid fa-truck"},null,-1),e("span",null,"Set Delivery Date",-1)])]),_:1},8,["model-value"]))]),n(Pn,{actions:s.contractPendingActions,onActionSelected:u[2]||(u[2]=d=>l.$emit("contract-pending-action",d))},null,8,["actions"])])])])):(f(),k("div",Y1,[e("div",H1,[u[13]||(u[13]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Add contract"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Create a new contract to track versions. Use the + button on the carousel above to add a contract. ")],-1)),e("div",Q1,[n(Pn,{actions:s.contractPendingActions,onActionSelected:u[0]||(u[0]=d=>l.$emit("contract-pending-action",d))},null,8,["actions"])])])]))]),e("div",X1,[s.showCloseAsLostSection?(f(),k("div",eb,[n(ca,{ref_key:"closeAsLostCardRef",ref:i,"preselected-reason":s.closeAsLostReason,"preselected-notes":s.closeAsLostNotes,onCancel:u[3]||(u[3]=d=>l.$emit("close-as-lost-cancel")),onConfirm:u[4]||(u[4]=d=>l.$emit("close-as-lost-confirm",d))},null,8,["preselected-reason","preselected-notes"])])):N("",!0),s.showSetDeliveryDateSection?(f(),k("div",tb,[e("div",nb,[u[23]||(u[23]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Set Delivery Date",-1)),e("div",sb,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...u[16]||(u[16]=[D("Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date","model-value":s.deliveryDateForm.deliveryDate,"onUpdate:modelValue":u[5]||(u[5]=d=>l.$emit("update:delivery-date-form",{...s.deliveryDateForm,deliveryDate:d})),min:s.minDeliveryDate,class:"w-full"},null,8,["model-value","min"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...u[17]||(u[17]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time","model-value":s.deliveryDateForm.deliveryTime,"onUpdate:modelValue":u[6]||(u[6]=d=>l.$emit("update:delivery-date-form",{...s.deliveryDateForm,deliveryTime:d})),class:"w-full"},null,8,["model-value"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...u[18]||(u[18]=[D("Delivery Location",-1)])]),_:1}),n(t(Ot),{"model-value":s.deliveryDateForm.deliveryLocation,"onUpdate:modelValue":u[7]||(u[7]=d=>l.$emit("update:delivery-date-form",{...s.deliveryDateForm,deliveryLocation:d}))},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select location..."})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Dealership"},{default:o(()=>[...u[19]||(u[19]=[D("At Dealership",-1)])]),_:1}),n(t(ge),{value:"Customer Address"},{default:o(()=>[...u[20]||(u[20]=[D("Customer Address",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...u[21]||(u[21]=[D("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["model-value"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...u[22]||(u[22]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{"model-value":s.deliveryDateForm.notes,"onUpdate:modelValue":u[8]||(u[8]=d=>l.$emit("update:delivery-date-form",{...s.deliveryDateForm,notes:d})),rows:"4",placeholder:"Add any relevant delivery details...",class:"w-full"},null,8,["model-value"])])])]),e("div",ab,[n(t(J),{variant:"secondary",onClick:u[9]||(u[9]=d=>l.$emit("cancel-set-delivery-date"))},{default:o(()=>[...u[24]||(u[24]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!s.canSubmitSetDeliveryDate,onClick:u[10]||(u[10]=d=>l.$emit("confirm-set-delivery-date"))},{default:o(()=>[...u[25]||(u[25]=[D(" Set Delivery Date ",-1)])]),_:1},8,["disabled"])])])):N("",!0),s.showScheduleAppointmentContractPendingSection?(f(),k("div",lb,[n(ls,{ref_key:"scheduleAppointmentContractPendingFormRef",ref:a,opportunity:s.opportunity,mode:"schedule",onSubmit:u[11]||(u[11]=d=>l.$emit("schedule-appointment-contract-pending-submit",d)),onCancel:u[12]||(u[12]=d=>l.$emit("cancel-schedule-appointment-contract-pending"))},null,8,["opportunity"])])):N("",!0)])]))}},ib={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},rb={class:"space-y-4"},ub={__name:"CreateContractModal",props:{show:{type:Boolean,required:!0},maxContractDate:{type:String,default:""}},emits:["confirm","cancel"],setup(s,{emit:C}){const a=s,i=C,l=T(""),u=T(""),d=T(""),S=$(()=>a.maxContractDate?a.maxContractDate:new Date().toISOString().split("T")[0]),V=$(()=>!!l.value);ve(()=>a.show,y=>{if(y){const b=new Date;l.value=b.toISOString().split("T")[0],u.value=b.toTimeString().slice(0,5),d.value=""}});function A(){V.value&&i("confirm",{contractDate:l.value,contractTime:u.value,notes:d.value})}function w(){i("cancel")}function g(y){y||w()}return(y,b)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":g},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0"},{default:o(()=>[n(t(xt),null,{default:o(()=>[...b[3]||(b[3]=[D("Create contract",-1)])]),_:1}),b[4]||(b[4]=e("p",{class:"text-sm text-muted-foreground mt-1"}," Create a new contract to track versions. Set the contract date and optional notes. ",-1))]),_:1}),e("div",ib,[e("div",rb,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[5]||(b[5]=[D("Contract Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{modelValue:l.value,"onUpdate:modelValue":b[0]||(b[0]=h=>l.value=h),type:"date",max:S.value,class:"w-full"},null,8,["modelValue","max"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[6]||(b[6]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{modelValue:u.value,"onUpdate:modelValue":b[1]||(b[1]=h=>u.value=h),type:"time",class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...b[7]||(b[7]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:d.value,"onUpdate:modelValue":b[2]||(b[2]=h=>d.value=h),rows:"4",placeholder:"Add any relevant notes about the contract...",class:"w-full"},null,8,["modelValue"])])])]),n(t(Ut),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[n(t(J),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:w}),n(t(J),{label:"Create contract",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto",disabled:!V.value,onClick:A},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},db={class:"flex-1 overflow-y-auto px-6 py-4"},cb={class:"flex items-center justify-center gap-2 mb-4","aria-label":"Steps"},mb={class:"flex items-center gap-2"},fb={key:0,class:"space-y-4"},pb={key:0,class:"space-y-4"},vb={class:"grid gap-3 sm:grid-cols-1"},gb={class:"flex size-10 shrink-0 items-center justify-center rounded-lg bg-muted overflow-hidden"},yb=["src","alt"],bb={class:"min-w-0"},hb={class:"text-xs text-muted-foreground mt-0.5"},xb={class:"flex size-10 shrink-0 items-center justify-center rounded-lg bg-muted"},wb={class:"flex size-10 shrink-0 items-center justify-center rounded-lg bg-muted"},kb={class:"flex size-10 shrink-0 items-center justify-center rounded-lg bg-muted"},Sb={key:1},Cb={key:1,class:"space-y-4"},$b={class:"flex justify-end sm:justify-start order-1 min-w-0"},Db={class:"flex flex-col-reverse sm:flex-row gap-2 order-2"},Ab={__name:"AddOfferModal",props:{show:{type:Boolean,required:!0},opportunity:{type:Object,default:null}},emits:["confirm","cancel","open-add-tradein","open-add-financing"],setup(s,{emit:C}){const a=s,i=C,l=T("vehicle"),u=T("choice"),d=T(null),S=T(null),V=T(null),A=T(!1),w=$(()=>{var O;return((O=a.opportunity)==null?void 0:O.id)??null}),g=$(()=>{var O;return((O=a.opportunity)==null?void 0:O.customer)??null}),y=$(()=>{var O;return((O=a.opportunity)==null?void 0:O.tradeIns)??[]}),b=$(()=>{var O;return((O=a.opportunity)==null?void 0:O.financingOptions)??[]}),h=$(()=>{var O,G,De;return((O=a.opportunity)==null?void 0:O.selectedVehicle)||((G=a.opportunity)==null?void 0:G.vehicle)||((De=a.opportunity)==null?void 0:De.requestedCar)||null}),c=$(()=>{var O;return((O=a.opportunity)==null?void 0:O.id)??null}),x=$(()=>{var O;return!!((O=S.value)!=null&&O.isValid)}),p=$(()=>l.value==="form"||l.value!=="vehicle"?!1:u.value==="stock"?!A.value:!1);ve(()=>a.show,async O=>{O&&(await la(),F())});function F(){l.value="vehicle",u.value="choice",d.value=null,A.value=!1}function R(O){return O==null?"0":(typeof O=="string"?parseFloat(O):O).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}function P(){d.value={...h.value},l.value="form"}function z({hasSelection:O}){A.value=!!O}function H(){if(l.value==="form"){ue();return}if(l.value==="vehicle"){if(u.value==="choice"){ue();return}if(u.value==="stock"&&A.value&&V.value){V.value.confirmSelection();return}ue()}}function L({vehicle:O}){d.value={...O},l.value="form"}function q(){d.value=null,l.value="form"}function K(){l.value==="form"&&(l.value="vehicle",u.value="choice",d.value=null,A.value=!1)}function _(){if(l.value==="form"){K();return}if(l.value==="vehicle"&&(u.value==="stock"||u.value==="configure")){u.value="choice",A.value=!1;return}ue()}function Q(O){i("confirm",O)}function ue(){i("cancel")}function ne(O){O||ue()}function E(){!x.value||!S.value||S.value.submit()}return(O,G)=>(f(),ee(t(wt),{open:s.show,"onUpdate:open":ne},{default:o(()=>[n(t(It),null,{default:o(()=>[n(t(Vt),{class:"fixed inset-0 z-50 bg-black/50"}),n(t(bt),{class:"flex w-full max-w-[90rem] flex-col max-h-[90vh] p-0"},{default:o(()=>[n(t(ht),{class:"flex-shrink-0 border-b border-border px-6 py-4"},{default:o(()=>[n(t(xt),{class:"text-foreground"},{default:o(()=>[...G[5]||(G[5]=[D("Create offer",-1)])]),_:1})]),_:1}),e("div",db,[e("nav",cb,[e("ol",mb,[e("li",{class:re(["flex items-center gap-1.5",l.value==="vehicle"?"text-foreground font-medium":"text-muted-foreground"])},[e("span",{class:re(["flex size-6 shrink-0 items-center justify-center rounded-full text-xs",l.value==="vehicle"?"bg-primary text-primary-foreground":"bg-muted"])}," 1 ",2),G[6]||(G[6]=e("span",null,"Vehicle",-1))],2),G[8]||(G[8]=e("li",{class:"h-px w-4 shrink-0 bg-border","aria-hidden":"true"},null,-1)),e("li",{class:re(["flex items-center gap-1.5",l.value==="form"?"text-foreground font-medium":"text-muted-foreground"])},[e("span",{class:re(["flex size-6 shrink-0 items-center justify-center rounded-full text-xs",l.value==="form"?"bg-primary text-primary-foreground":"bg-muted"])}," 2 ",2),G[7]||(G[7]=e("span",null,"Offer",-1))],2)])]),l.value==="vehicle"?(f(),k("div",fb,[u.value==="choice"?(f(),k("div",pb,[e("div",vb,[h.value?(f(),ee(t(J),{key:0,variant:"outline",class:"h-auto w-full justify-start gap-3 px-4 py-3 text-left",onClick:P},{default:o(()=>[e("div",gb,[h.value.image?(f(),k("img",{key:0,src:h.value.image,alt:`${h.value.brand} ${h.value.model}`,class:"size-full object-cover"},null,8,yb)):(f(),ee(t(ol),{key:1,class:"size-5 text-foreground"}))]),e("div",bb,[G[9]||(G[9]=e("span",{class:"font-medium text-foreground"},"Use requested vehicle",-1)),e("p",hb,U(h.value.brand)+" "+U(h.value.model)+" ("+U(h.value.year)+") — € "+U(R(h.value.price)),1)])]),_:1})):N("",!0),n(t(J),{variant:"outline",class:"h-auto w-full justify-start gap-3 px-4 py-3 text-left",onClick:G[0]||(G[0]=De=>u.value="stock")},{default:o(()=>[e("div",xb,[n(t(ml),{class:"size-5 text-foreground"})]),G[10]||(G[10]=e("div",{class:"min-w-0"},[e("span",{class:"font-medium text-foreground"},"Add from Stock"),e("p",{class:"text-xs text-muted-foreground mt-0.5"}," Search and select an existing vehicle from inventory ")],-1))]),_:1}),n(t(J),{variant:"outline",class:"h-auto w-full justify-start gap-3 px-4 py-3 text-left",onClick:G[1]||(G[1]=De=>u.value="configure")},{default:o(()=>[e("div",wb,[n(t(ea),{class:"size-5 text-foreground"})]),G[11]||(G[11]=e("div",{class:"min-w-0"},[e("span",{class:"font-medium text-foreground"},"Configure Vehicle"),e("p",{class:"text-xs text-muted-foreground mt-0.5"},"Build or customize a new vehicle")],-1))]),_:1}),n(t(J),{variant:"outline",class:"h-auto w-full justify-start gap-3 px-4 py-3 text-left",onClick:q},{default:o(()=>[e("div",kb,[n(t(pi),{class:"size-5 text-foreground"})]),G[12]||(G[12]=e("div",{class:"min-w-0"},[e("span",{class:"font-medium text-foreground"},"Skip & Enter Manually"),e("p",{class:"text-xs text-muted-foreground mt-0.5"},"Create vehicle data from scratch")],-1))]),_:1})])])):N("",!0),u.value==="stock"||u.value==="configure"?(f(),k("div",Sb,[n(oi,{ref_key:"vehicleSelectionRef",ref:V,"requested-vehicle":h.value,"opportunity-id":c.value,mode:u.value==="stock"?"stock":"configure","show-back":"","hide-back":"",onVehicleSelected:L,onBack:G[2]||(G[2]=De=>u.value="choice"),onSelectionChange:z},null,8,["requested-vehicle","opportunity-id","mode"])])):N("",!0)])):N("",!0),l.value==="form"?(f(),k("div",Cb,[n(ii,{ref_key:"offerWidgetRef",ref:S,"task-id":w.value,"task-type":"opportunity",customer:g.value,"selected-vehicle":d.value,"trade-ins":y.value,"financing-options":b.value,"hide-header":"","hide-actions":"","hide-vehicle-selection":"","initial-vehicle-step":d.value?"select":"manual",onSave:Q,onCancel:ue,onOpenAddTradein:G[3]||(G[3]=De=>O.$emit("open-add-tradein")),onOpenAddFinancing:G[4]||(G[4]=De=>O.$emit("open-add-financing"))},null,8,["task-id","customer","selected-vehicle","trade-ins","financing-options","initial-vehicle-step"])])):N("",!0)]),n(t(Ut),{class:"flex-shrink-0 flex flex-col-reverse sm:flex-row gap-2 border-t border-border px-6 py-4 sm:justify-between sm:items-center"},{default:o(()=>[e("div",$b,[n(t(J),{variant:"ghost",size:"sm",class:"gap-2",onClick:_},{default:o(()=>[n(t(ll),{class:"size-4"}),G[13]||(G[13]=D(" Back ",-1))]),_:1})]),e("div",Db,[n(t(J),{variant:"outline",size:"sm",class:"w-full sm:w-auto",disabled:p.value,onClick:H},{default:o(()=>[...G[14]||(G[14]=[D(" Next ",-1)])]),_:1},8,["disabled"]),l.value==="form"?(f(),ee(t(J),{key:0,variant:"default",size:"sm",class:"w-full sm:w-auto",disabled:!x.value,onClick:E},{default:o(()=>[...G[15]||(G[15]=[D(" Create offer ",-1)])]),_:1},8,["disabled"])):N("",!0)])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Tb={class:"px-4 pt-4"},Ob={key:1,class:"mt-4"},Ib={key:0,class:"mb-4"},Vb={key:1,class:"space-y-4"},Fb={key:0,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},Lb={class:"flex items-start gap-3"},Nb={class:"flex-1"},qb={class:"text-sm text-muted-foreground whitespace-pre-wrap"},Ub={class:"rounded-lg flex flex-col bg-muted"},Pb={class:"pt-1 px-1"},Mb={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},Rb={class:"p-6"},Eb={class:"px-4 py-4"},jb={key:2,class:"rounded-lg flex flex-col bg-muted"},Bb={class:"pt-1 px-1"},zb={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Wb={class:"p-6"},_b={class:"mb-3"},Yb={class:"font-bold text-foreground text-sm"},Hb={class:"text-sm text-muted-foreground mt-0.5"},Qb={class:"flex flex-wrap gap-3 items-center"},Gb={class:"outcome-toggle-group flex flex-wrap gap-3"},Jb={class:"px-4 py-4 space-y-4"},Kb={key:0},Zb={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Xb={class:"space-y-4"},eh={class:"flex justify-end gap-2 mt-4"},th={key:1},nh={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},sh={class:"text-sm text-muted-foreground mb-4"},ah={class:"space-y-4"},lh={class:"flex justify-end gap-2 mt-4"},oh={key:2},ih={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},rh={class:"text-sm text-muted-foreground mb-4"},uh={class:"space-y-4"},dh={class:"flex justify-end gap-2 mt-4"},ch={key:3,class:"px-4 py-4"},mh={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},fh={class:"space-y-4"},ph={class:"space-y-3"},vh={class:"flex items-center gap-3"},gh={class:"flex items-center gap-3"},yh={class:"flex items-center gap-3"},bh={class:"flex items-center gap-3"},hh={class:"flex items-center gap-3"},xh={class:"flex justify-end gap-2 mt-4"},wh={key:3,class:"rounded-lg flex flex-col bg-muted"},kh={class:"pt-1 px-1"},Sh={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Ch={class:"p-6"},$h={class:"mb-3"},Dh={class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},Ah={class:"flex items-start gap-2"},Th={class:"flex-1"},Oh={class:"text-sm text-red-700 mt-1"},Ih={key:0,class:"text-sm text-red-600 mt-2"},Vh={class:"flex flex-wrap gap-3 items-center"},Fh={class:"outcome-toggle-group flex flex-wrap gap-3"},Lh={class:"px-4 py-4 space-y-4"},Nh={key:0},qh={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Uh={class:"flex justify-end gap-2 pt-3"},Ph={key:5,class:"rounded-lg flex flex-col bg-muted"},Mh={class:"px-4 py-4"},Rh={key:6,class:"space-y-3"},Eh={class:"flex justify-end gap-2 mt-4"},jh={__name:"OpportunityManagementWidget",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,default:null},activities:{type:Array,default:()=>[]}},emits:["vehicle-selected","offer-created","appointment-scheduled","appointment-cancelled","appointment-no-show"],setup(s,{expose:C,emit:a}){const i=s,l=a,u=aa(),d=Bt();xn();const S=Jt(),{t:V}=As(),A=()=>{var r;const m=d.currentOpportunity;return m&&m.id===((r=i.opportunity)==null?void 0:r.id)?m:i.opportunity},w=$(()=>A()),g=$(()=>{var m;return i.scheduledAppointment||((m=i.opportunity)==null?void 0:m.scheduledAppointment)||null}),y=$(()=>{if(g.value&&g.value.start)return!1;const m=Ee.displayStage.value,r=m===hs.QUALIFIED,I=m===hs.AWAITING_APPOINTMENT;return(r||I)&&!Ee.isClosed.value});$(()=>!g.value||!g.value.start?!1:new Date(g.value.start)<new Date&&g.value.status!=="completed");const b=$(()=>{if(!g.value||!g.value.start)return!1;const m=new Date(g.value.start),r=new Date;return m.getFullYear()===r.getFullYear()&&m.getMonth()===r.getMonth()&&m.getDate()===r.getDate()}),h=$(()=>i.opportunity.customer?typeof i.opportunity.customer=="string"?i.opportunity.customer:i.opportunity.customer.name:"Customer"),c=$(()=>{const m=i.opportunity.customerId||(i.opportunity.customer&&typeof i.opportunity.customer=="object"?i.opportunity.customer.id:null);return m?u.resolve(`/customer/${m}`).href:"#"}),x=m=>{m.preventDefault();const r=i.opportunity.customerId||(i.opportunity.customer&&typeof i.opportunity.customer=="object"?i.opportunity.customer.id:null);r&&window.open(u.resolve(`/customer/${r}`).href,"_blank")},p=$(()=>{const m=i.opportunity,r=Ee.displayStage.value;return m.stage==="Closed Won"||r==="Closed Won"}),F=$(()=>{const m=i.opportunity;return Array.isArray(m.contracts)&&m.contracts.length>0?m.contracts:m.contractDate?[{id:m.id||`contract-${m.contractDate}`,contractDate:m.contractDate,contractNotes:m.contractNotes,contractSigned:m.contractSigned,esignatureCollectedDate:m.esignatureCollectedDate,version:m.contractVersion||1,status:m.contractSigned||m.esignatureCollectedDate?"signed":"active"}]:[]}),R=$(()=>{const m=i.opportunity,r=Ee.displayStage.value;return m.stage==="Closed Lost"||r==="Closed Lost"}),P=$(()=>R.value||!p.value?!1:i.opportunity.deliverySubstatus!=="Delivered"),z=$(()=>!!i.opportunity.deliveryDate),H=$(()=>i.opportunity.deliverySubstatus==="Delivered"),L=$(()=>z.value?"Confirm Delivery":"Schedule Delivery"),q=$(()=>z.value?"Delivery scheduled. Confirm that the delivery has been completed":"Contract signed! Schedule vehicle delivery with the customer"),K=bl(),{isCallActive:_,callEnded:Q,callDuration:ue,callNotes:ne,mockTranscription:E,formattedCallDuration:O,startCall:G,endCall:De,copyNumber:be}=K,Ne=()=>{G()},ot=()=>{De()},ze=()=>{var m;be(((m=i.opportunity.customer)==null?void 0:m.phone)||"")},it=m=>{ne.value=m},mt=()=>{K.callData.value={channel:"external",notes:"",transcription:null}},Ke=T(null),kt=$(()=>{var m;return(m=Ke.value)==null?void 0:m.scheduleFormRef}),Pt=T(null),Ft=()=>{X.value=!1},rt=()=>{var m;(m=kt.value)==null||m.resetForm()},Z=()=>{var m;(m=Pt.value)==null||m.resetForm(),te.value=!1};async function B(m,r){var Kn,Zn,Ln,Xn,es;const{eventType:I,selectedDate:ae,selectedSlot:de,selectedTeam:oe,selectedSalesman:we,durationValue:je,communicationPreferences:he}=m,Be=i.opportunity,tt=ae,[Fn,Et]=de.split(":").map(Number),jt=new Date(tt);jt.setHours(Fn,Et,0,0);const sn=je||30,Sn=new Date(jt.getTime()+sn*6e4),Qn=(we==null?void 0:we.name)||(oe==null?void 0:oe.name)||Be.assignee||"Unassigned",Gn=(we==null?void 0:we.id)||(oe==null?void 0:oe.id)||null,Jn=we?"user":"team";try{if(r==="reschedule"){const gs={title:`Appointment - ${((Kn=Be.customer)==null?void 0:Kn.name)||"Customer"}`,start:jt.toISOString(),end:Sn.toISOString(),type:I,assignee:Qn,customerId:Be.customerId,opportunityId:Be.id,duration:sn,status:"pending_confirmation"};let ys={...gs};if((Zn=g.value)!=null&&Zn.id){const{updateCalendarEvent:Qs}=await Cn(async()=>{const{updateCalendarEvent:mo}=await import("./users-D9zJDDml.js").then(fo=>fo.i);return{updateCalendarEvent:mo}},__vite__mapDeps([3,1,2]));await Qs(g.value.id,{...gs,status:"pending_confirmation"}),ys.id=g.value.id}else{const Qs=await Gs({...gs,status:"pending_confirmation"});ys={...gs,id:Qs.id,status:"pending_confirmation"}}await d.updateOpportunity(Be.id,{scheduledAppointment:ys}),l("appointment-scheduled",ys),X.value=!1,te.value=!1;return}const Hs={customerId:Be.customerId||((Ln=Be.customer)==null?void 0:Ln.id),customer:((Xn=Be.customer)==null?void 0:Xn.name)||"Unknown",start:jt.toISOString(),end:Sn.toISOString(),type:I,title:`${I} - ${((es=Be.customer)==null?void 0:es.name)||"Customer"}`,assigneeId:Gn,assigneeType:Jn,teamId:(oe==null?void 0:oe.id)||null,team:(oe==null?void 0:oe.name)||null,salesperson:(we==null?void 0:we.name)||null,salespersonId:(we==null?void 0:we.id)||null,duration:sn,opportunityId:Be.id},qa=await Gs(Hs),Ua={id:qa.id,start:jt.toISOString(),end:Sn.toISOString(),type:I,assignee:Qn,assigneeId:Gn,assigneeType:Jn,duration:sn,team:(oe==null?void 0:oe.name)||null,teamId:(oe==null?void 0:oe.id)||null,salesperson:(we==null?void 0:we.name)||null,salespersonId:(we==null?void 0:we.id)||null,communications:he,status:"confirmed"};await d.updateOpportunity(Be.id,{scheduledAppointment:Ua}),l("appointment-scheduled",{...Ua,calendarEventId:qa.id}),rt(),te.value=!1}catch(Hs){console.error("Failed to schedule/reschedule appointment:",Hs)}}async function Y(){if(g.value)try{const m={...g.value,status:"confirmed"};if(g.value.id){const{updateCalendarEvent:r}=await Cn(async()=>{const{updateCalendarEvent:I}=await import("./users-D9zJDDml.js").then(ae=>ae.i);return{updateCalendarEvent:I}},__vite__mapDeps([3,1,2]));await r(g.value.id,{status:"confirmed"})}await d.updateOpportunity(i.opportunity.id,{scheduledAppointment:m}),l("appointment-scheduled",m)}catch(m){console.error("Failed to confirm appointment:",m)}}const se=T(!1),X=T(!1),te=T(!1),le=T(!1),ce=T(!1),Ce=T(null),Ae=T(null),Ze=$(()=>{var m;return(m=Ke.value)==null?void 0:m.ns1TaskRef}),Qe=$(()=>{var m;return(m=Ke.value)==null?void 0:m.ns2TaskRef}),Je=$(()=>{var m;return(m=Ke.value)==null?void 0:m.ns3TaskRef}),Ge=$(()=>{var m;return(m=Ke.value)==null?void 0:m.offerAssignmentTaskRef}),Pe=T(!1),Ve=T(!1),nt=T(!1),fe=T(null),me=T(""),ye=T(null),xe=T(!1),ke=T(!1),Me=T(!1),ut=T(!1),St=T(!1),Te=T({deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}),qe=T({actualDeliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}),$e=T({deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}),Xe=T({vehicleInspected:!1,documentsProvided:!1,paymentReceived:!1,warrantyExplained:!1,keysHandedOver:!1}),zt=T(""),Kt=T(!1),pt=T(!1),{reason:_e,notes:un,cardRef:st,reset:We}=Sl(),dn=T(!1),cn=T(!1),dt=T(!1),Ye=T(!1),et=T(!1),Zt=T(!1),at=T({deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""});$(()=>{var m;return(m=Ae.value)==null?void 0:m.scheduleAppointmentContractPendingFormRef});const Rn=$(()=>{const m=[];return On.value||m.push({key:"add-offer",label:"Add offer",handler:()=>{Vn()}}),m.push({key:"close-as-lost",label:"Close as Lost",handler:()=>{Ye.value=!1,et.value=!1,Zt.value=!1,pt.value=!0,We()}},{key:"schedule-appointment",label:"Schedule appointment",handler:()=>_l()}),m});$(()=>(Ee.secondaryActions.value||[]).map(m=>({key:m.key,label:m.label,disabled:!!m.disabled,onClick:()=>{dn.value=!1,cn.value=!1,Hn(m)}}))),$(()=>(Rn.value||[]).map(m=>({key:m.key,label:m.label,disabled:!!m.disabled,onClick:()=>{dt.value=!1,m.handler&&m.handler()}})));function os(m){}const gt=$(()=>{var r;const m=((r=g.value)==null?void 0:r.noShowCount)||0;return m===0&&le.value?1:m}),ft=$(()=>{var I;const r={1:Ze,2:Qe,3:Je}[gt.value];return((I=r==null?void 0:r.value)==null?void 0:I.canSubmit)||!1}),Mt=$(()=>gt.value===3?"Close as Lost":"Assign and Save"),Re=$(()=>{var m;return((m=Ge==null?void 0:Ge.value)==null?void 0:m.canSubmit)||!1}),Lt=$(()=>{const m=w.value;return!(m!=null&&m.offers)||m.offers.length===0?[]:m.offers.filter(r=>r.status==="active").map(r=>({id:r.id,label:`${r.vehicleBrand} ${r.vehicleModel} (${r.vehicleYear})`,price:r.price,value:r.id}))}),En=$(()=>fe.value&&me.value.trim().length>0),mn=T(!1),fn=T(!1),pn=T(!1),An=T(!1),Wt=T(!1),Rt=T(!1),_t=T(!1),vn=T(!1),Xt=T(!1),wn=T([]),Ct=T(!1),en=T(!1),gn=T(!1),yn=T("default"),tn=T(!1),kn=T(!1),Tn=T(!1),lt=T(null),yt=T(!1),jn=T(null),is=T(null),Bn=T(null),zn=T(null),Wn=T(!1),bn=T(null),rs=T(null),us=T(""),ds=T("Contract/Offer Document");function _n(){yt.value=!0}C({openPostponeExpectedCloseModal:_n});const cs={"schedule-appointment":()=>{te.value=!0,X.value=!1},"manage-appointment":()=>{g.value&&(Rt.value=!0)},"view-or-schedule-appointment":()=>{g.value?Rt.value=!0:(te.value=!0,X.value=!1)},reschedule:()=>{g.value&&(_t.value=!0)},"cancel-appointment":()=>{j()},"mark-no-show":()=>{Ta()},"select-vehicle":()=>{An.value=!0},"create-offer":()=>{Vn()},"call-prospect":()=>{Wt.value=!0},"follow-up-offer":()=>{Wt.value=!0},"request-decision":()=>{Wt.value=!0},"finalize-contract":()=>{mn.value=!0},"schedule-delivery":()=>{P.value&&(xe.value=!0,ke.value=!1,ts(Te,"deliveryDate"))},"confirm-delivery":()=>{P.value&&(ke.value=!0,xe.value=!1,ts(qe,"actualDeliveryDate"))},"collect-feedback":()=>{Wt.value=!0},reschedule:()=>{_t.value=!0},"cancel-appointment":()=>{j()},"close-won":()=>{mn.value=!0},"add-offer":()=>{Vn()},"add-contract":()=>{mn.value=!0},"create-contract":()=>{Ca()},"extend-deadline":()=>{Wt.value=!0},"close-lost":()=>{pt.value=!0,We()},reopen:()=>{zs()},requalify:()=>{pn.value=!0},"reschedule-delivery":()=>{if(p.value&&z.value&&(Me.value=!0,xe.value=!1,ke.value=!1,i.opportunity.deliveryDate)){const m=new Date(i.opportunity.deliveryDate);$e.value.deliveryDate=m.toISOString().split("T")[0],$e.value.deliveryTime=m.toTimeString().slice(0,5),$e.value.deliveryLocation=i.opportunity.deliveryLocation||"",$e.value.notes=i.opportunity.deliveryNotes||""}},"complete-checklist":()=>{p.value&&H.value&&(ut.value=!0)},archive:()=>{p.value&&H.value&&(St.value=!0)}},Nt=Jp(as(i,"opportunity"),g,as(i,"activities"),cs,qn),Ee={isClosed:Nt.isClosed,primaryAction:$(()=>y.value||g.value&&g.value.start&&(Ee.displayStage.value===hs.APPOINTMENT_SCHEDULED||Ee.displayStage.value===hs.AWAITING_APPOINTMENT)||Nt.isClosed.value?null:Nt.primaryAction.value),secondaryActions:$(()=>{const r=(Nt.secondaryActions.value||[]).filter(ae=>!(ae.key==="close-lost"&&R.value));return!r.some(ae=>ae.key==="close-lost")&&!R.value?[...r,{key:"close-lost",label:"Close as Lost",handler:()=>{pt.value=!0,We()}}]:r}),activeTaskWidget:$(()=>{if(y.value)return null;const m=Nt.activeTaskWidget.value;return m&&m.type==="NS"?null:m}),taskWidgetTitle:Nt.taskWidgetTitle,displayStage:$(()=>hn(i.opportunity,"opportunity")),showDeadlineBanner:$(()=>{var m;return!Nt.isClosed.value&&!!((m=i.opportunity)!=null&&m.nextActionDue)})},ms=$(()=>{const m=i.opportunity;return!(!m||Nt.isClosed.value||m.stage!=="In Negotiation"||Ee.displayStage.value==="In Negotiation - Contract Pending")}),Yn=$(()=>Ee.displayStage.value==="In Negotiation - Contract Pending"),On=$(()=>{var m;return((m=i.opportunity)==null?void 0:m.offers)&&Array.isArray(i.opportunity.offers)&&i.opportunity.offers.length>0}),Yt=$(()=>{const m=Ee.secondaryActions.value||[];let r=m;return On.value&&(r=m.filter(ae=>ae.key!=="add-offer"&&ae.key!=="create-offer")),r.some(ae=>ae.key==="schedule-appointment")||(r=[...r,{key:"schedule-appointment",label:"Schedule Appointment",icon:"fa-solid fa-calendar-plus",description:"Schedule a new appointment",handler:()=>{te.value=!0,X.value=!1}}]),r}),Ls=async m=>{var r;(r=i.opportunity)!=null&&r.id&&await d.fetchOpportunityById(i.opportunity.id)};function fs(){}function Ns(m){}async function qs(m){var r;try{const{opportunity:I,surveyData:ae}=m,{responses:de}=ae;await d.addActivity(I.id,{type:"offer-feedback-survey",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"completed offer feedback survey",content:"Offer Feedback Survey completed",data:{responses:de,timestamp:ae.timestamp},timestamp:ae.timestamp}),nt.value=!1}catch(I){console.error("Failed to submit survey:",I)}}function ps(m){nt.value=!1}async function vs(m){lt.value=m.toLowerCase(),Tn.value=!0}async function Us(m){var r;try{const I=A(),ae=I.postponedTasks||{};ae[m.taskType]=m.dateTime,await d.updateOpportunity(I.id,{postponedTasks:ae}),await d.addActivity(I.id,{type:"task-postponed",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"postponed task",content:`Task ${m.taskType.toUpperCase()} postponed to ${new Date(m.dateTime).toLocaleString()}${m.reason?`: ${m.reason}`:""}`,data:{taskType:m.taskType,dateTime:m.dateTime,reason:m.reason},timestamp:new Date().toISOString()}),Tn.value=!1,lt.value=null}catch(I){console.error("Failed to postpone task:",I)}}function Ps(){Tn.value=!1,lt.value=null}async function Ms(m){var r;try{const I=A();await d.updateOpportunity(I.id,{expectedCloseDate:m.expectedCloseDate}),await d.addActivity(I.id,{type:"expected-close-date-extension",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"extended expected close date",content:`Expected close date extended to ${new Date(m.expectedCloseDate).toLocaleDateString()}${m.reason?`: ${m.reason}`:""}`,data:{expectedCloseDate:m.expectedCloseDate,reason:m.reason},timestamp:new Date().toISOString()}),yt.value=!1}catch(I){console.error("Failed to extend expected close date:",I)}}function Rs(){yt.value=!1}function Es(m){An.value=!1,l("vehicle-selected",m),setTimeout(()=>{Vn()},300)}async function M(m){var r,I;try{const ae=A(),de=m.type==="FIN"?"Captive Financing":m.type==="LEA"?"Leasing":m.type==="LTR"?"Long-Term Rental":m.type||"Financing",oe=((r=m.fields)==null?void 0:r.duration)??null,we=oe?`${de} ${oe} months`:de;await d.addActivity(ae.id,{type:"financing",user:((I=S.currentUser)==null?void 0:I.name)||"You",action:"added a financing proposal",content:m.successMessage||we,data:{type:m.type,...m.fields},timestamp:new Date().toISOString()});const je=oe?`${m.type||"Financing"} ${oe} months`:de||"Financing",he=[...ae.financingOptions||[],{id:`fo-${Date.now()}`,label:je,termMonths:oe||null}];await d.updateOpportunity(ae.id,{financingOptions:he}),await d.fetchOpportunityById(ae.id),Xt.value=!1}catch(ae){console.error("Failed to save financing:",ae)}}async function v(m){var r,I;try{const ae=A(),de=m.vehicle||{},oe=[de.brand,de.model].filter(Boolean),we=(oe.length?oe.join(" ")+(de.year?` (${de.year})`:""):"Trade-in")||"Trade-in",je=((r=m.valuation)==null?void 0:r.tradeInPrice)??0;await d.addActivity(ae.id,{type:"tradein",user:((I=S.currentUser)==null?void 0:I.name)||"You",action:"added a trade-in",content:we,data:{vehicle:m.vehicle,valuation:m.valuation},timestamp:new Date().toISOString()});const he=[...ae.tradeIns||[],{id:`ti-${Date.now()}`,label:we||"Trade-in",valuation:typeof je=="number"?je:parseFloat(je)||0}];await d.updateOpportunity(ae.id,{tradeIns:he}),await d.fetchOpportunityById(ae.id),vn.value=!1}catch(ae){console.error("Failed to save trade-in:",ae)}}function ie(m){se.value=!1,l("appointment-scheduled",{...m,opportunityId:i.opportunity.id,customer:i.opportunity.customer.name})}async function j(){if(g.value&&confirm("Are you sure you want to cancel this appointment?"))try{if(g.value.id){const{deleteCalendarEvent:m}=await Cn(async()=>{const{deleteCalendarEvent:r}=await import("./users-D9zJDDml.js").then(I=>I.i);return{deleteCalendarEvent:r}},__vite__mapDeps([3,1,2]));await m(g.value.id)}await d.updateOpportunity(i.opportunity.id,{scheduledAppointment:null}),l("appointment-cancelled",g.value.id)}catch(m){console.error("Failed to cancel appointment:",m)}}function Fe(m){mn.value=!1,d.updateOpportunity(i.opportunity.id,{stage:"Closed Won",contractDate:m.contractDate})}async function Le(m){var r;fn.value=!1;try{const I=A();await d.updateOpportunity(I.id,{deliveryDate:m.deliveryDate,deliverySubstatus:"Delivered",actualDeliveryDate:m.deliveryDate,deliveryLocation:m.location,deliveryNotes:m.notes}),await d.addActivity(I.id,{type:"delivery",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"marked as delivered",content:`Delivery confirmed on ${new Date(m.deliveryDate).toLocaleString()} at ${m.location||"N/A"}`,data:m,timestamp:new Date().toISOString()})}catch(I){console.error("Failed to mark as delivered:",I)}}function nn(){xe.value=!1,Te.value={deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}async function js(){var m;if(xa.value)try{const r=A(),I=Te.value.deliveryTime?`${Te.value.deliveryDate}T${Te.value.deliveryTime}:00`:`${Te.value.deliveryDate}T12:00:00`,ae=hn(r,"opportunity")==="In Negotiation - Contract Pending",de={deliveryDate:I,deliveryLocation:Te.value.deliveryLocation,deliveryNotes:Te.value.notes};ae&&!r.deliveryDateSetDate&&(de.deliveryDateSetDate=new Date().toISOString()),r.stage==="Closed Won"&&(de.deliverySubstatus="Awaiting Delivery"),await d.updateOpportunity(r.id,de),await d.addActivity(r.id,{type:"delivery-scheduled",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:ae?"set delivery date (step 1 of 2)":"scheduled delivery",content:`Delivery scheduled for ${new Date(I).toLocaleString()} at ${Te.value.deliveryLocation}`,data:{deliveryDate:I,location:Te.value.deliveryLocation,notes:Te.value.notes,step:ae?1:null,totalSteps:ae?2:null},timestamp:new Date().toISOString()}),nn()}catch(r){console.error("Failed to schedule delivery:",r)}}function ma(){ke.value=!1,qe.value={actualDeliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}function fa(){Me.value=!1,$e.value={deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}async function Cl(){var m;if(ka.value)try{const r=A(),I=$e.value.deliveryTime?`${$e.value.deliveryDate}T${$e.value.deliveryTime}:00`:`${$e.value.deliveryDate}T12:00:00`;await d.updateOpportunity(r.id,{deliveryDate:I,deliveryLocation:$e.value.deliveryLocation,deliveryNotes:$e.value.notes}),await d.addActivity(r.id,{type:"delivery",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:"rescheduled delivery",content:`Delivery rescheduled to ${new Date(I).toLocaleString()} at ${$e.value.deliveryLocation}. Previous date: ${qn(r.deliveryDate)}`,data:{newDeliveryDate:I,previousDeliveryDate:r.deliveryDate,location:$e.value.deliveryLocation,notes:$e.value.notes},timestamp:new Date().toISOString()}),fa()}catch(r){console.error("Failed to reschedule delivery:",r)}}function pa(){ut.value=!1,Xe.value={vehicleInspected:!1,documentsProvided:!1,paymentReceived:!1,warrantyExplained:!1,keysHandedOver:!1},zt.value=""}async function $l(){var m;if(Sa.value)try{const r=A();await d.addActivity(r.id,{type:"delivery",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:"completed delivery checklist",content:`Delivery checklist completed. Items checked: ${Object.values(Xe.value).filter(I=>I).length}/5${zt.value?`. Notes: ${zt.value}`:""}`,data:{checklistItems:Xe.value,notes:zt.value,completedAt:new Date().toISOString()},timestamp:new Date().toISOString()}),pa()}catch(r){console.error("Failed to complete checklist:",r)}}async function Dl(){var m;try{const r=A();await d.addActivity(r.id,{type:"note",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:"archived opportunity",content:"Opportunity archived after successful delivery completion",timestamp:new Date().toISOString()}),St.value=!1}catch(r){console.error("Failed to archive opportunity:",r)}}async function Al(){var m;if(wa.value)try{const r=A(),I=qe.value.deliveryTime?`${qe.value.actualDeliveryDate}T${qe.value.deliveryTime}:00`:`${qe.value.actualDeliveryDate}T12:00:00`;await d.updateOpportunity(r.id,{deliveryDate:I,deliverySubstatus:"Delivered",actualDeliveryDate:I,deliveryLocation:qe.value.deliveryLocation,deliveryNotes:qe.value.notes}),await d.addActivity(r.id,{type:"delivery",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:"confirmed delivery",content:`Delivery confirmed on ${new Date(I).toLocaleString()} at ${qe.value.deliveryLocation}`,data:{actualDeliveryDate:I,scheduledDeliveryDate:r.deliveryDate,location:qe.value.deliveryLocation,notes:qe.value.notes},timestamp:new Date().toISOString()}),ma()}catch(r){console.error("Failed to confirm delivery:",r)}}function va(m){const r=typeof m=="string"?m:m.reason||m,I=typeof m=="object"?m.notes:"";d.updateOpportunity(i.opportunity.id,{stage:"Closed Lost",lossReason:r,lossNotes:I})}function Bs(){pt.value=!1,We()}async function ga(m){var r;try{await va({reason:m.reason,notes:m.notes}),await d.addActivity(i.opportunity.id,{type:"close-lost",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"closed opportunity as lost",content:`Opportunity closed as lost. Reason: ${m.reason}${m.notes?`. Notes: ${m.notes}`:""}`,data:{reason:m.reason,notes:m.notes},timestamp:new Date().toISOString()}),Bs()}catch(I){console.error("Failed to close opportunity as lost:",I)}}async function Tl(m){var r;try{await va({reason:m.reason,notes:m.notes}),await d.addActivity(i.opportunity.id,{type:"close-lost",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"closed opportunity as lost",content:`Opportunity closed as lost. Reason: ${m.reason}${m.notes?`. Notes: ${m.notes}`:""}`,data:{reason:m.reason,notes:m.notes},timestamp:new Date().toISOString()})}catch(I){console.error("Failed to close opportunity as lost:",I)}}async function zs(){const m=A(),r=m.stage==="Closed Won",I=m.offers&&m.offers.length>0;Kt.value=!1;let ae="Qualified",de=null;I&&(ae="In Negotiation",m.offers.filter(oe=>oe.status==="active").sort((oe,we)=>new Date(we.createdAt)-new Date(oe.createdAt))[0],de="Offer Sent"),r?(await d.updateOpportunity(m.id,{stage:ae,negotiationSubstatus:de,skipTaskReTrigger:!0}),setTimeout(async()=>{await d.updateOpportunity(m.id,{skipTaskReTrigger:!1})},2e3)):await d.updateOpportunity(m.id,{stage:ae,negotiationSubstatus:de})}function Ol(m){pn.value=!1,u.push(`/customer/${m.id}?type=lead`)}function Il(m){Rt.value=!1}function Vl(m){_t.value=!1}function Fl({opportunity:m,assignee:r,note:I}){}function Ll(){var I;const r={1:Ze,2:Qe,3:Je}[gt.value];(I=r==null?void 0:r.value)==null||I.submit()}function Nl(){le.value=!1}async function ya({opportunity:m,offerData:r}){var I,ae,de,oe,we,je,he,Be,tt,Fn;try{if((I=g.value)!=null&&I.id){const{updateCalendarEvent:jt}=await Cn(async()=>{const{updateCalendarEvent:sn}=await import("./users-D9zJDDml.js").then(Sn=>Sn.i);return{updateCalendarEvent:sn}},__vite__mapDeps([3,1,2]));await jt(g.value.id,{status:"completed"})}const Et=w.value;await d.addOffer(Et.id,{vehicleBrand:((ae=r.data)==null?void 0:ae.brand)||"",vehicleModel:((de=r.data)==null?void 0:de.model)||"",vehicleYear:((oe=r.data)==null?void 0:oe.year)||"",price:((we=r.data)==null?void 0:we.price)||0,data:r.data}),await d.addActivity(Et.id,{type:"offer",user:((je=S.currentUser)==null?void 0:je.name)||"You",action:"created an offer",content:`Offer created: ${(he=r.data)==null?void 0:he.brand} ${(Be=r.data)==null?void 0:Be.model} (${(tt=r.data)==null?void 0:tt.year}) - € ${(((Fn=r.data)==null?void 0:Fn.price)||0).toLocaleString()}`,data:r.data,timestamp:new Date().toISOString()}),ce.value=!1}catch(Et){console.error("Failed to create offer:",Et)}}function ql(){ce.value=!1}const ba=T(null),In=T(null);async function Ul(m){var I;const r=A();try{await d.activateOffer(r.id,m.id),await d.addActivity(r.id,{type:"offer-activation",user:((I=S.currentUser)==null?void 0:I.name)||"You",action:"activated offer",content:`Offer activated: ${m.vehicleBrand} ${m.vehicleModel} (${m.vehicleYear})`,data:{offerId:m.id},timestamp:new Date().toISOString()})}catch(ae){console.error("Failed to activate offer:",ae),alert("Failed to activate offer. Please try again.")}finally{r.offers&&r.offers.forEach(ae=>{var de;(de=ba.value)==null||de.setOfferLoading(ae.id,!1)})}}async function Pl(){var m,r;if(En.value)try{const I=w.value,ae=(m=I==null?void 0:I.offers)==null?void 0:m.find(oe=>oe.id===ye.value),de=ae?`${ae.vehicleBrand} ${ae.vehicleModel} (€${ae.price.toLocaleString()})`:"offer";await d.addActivity(I.id,{type:fe.value,user:((r=S.currentUser)==null?void 0:r.name)||"You",action:`sent ${fe.value}`,content:me.value,data:{channel:fe.value,offerId:ye.value,offerReference:de},timestamp:new Date().toISOString()}),Pe.value=!1,fe.value=null,me.value="",ye.value=null}catch(I){console.error("Failed to send negotiation message:",I)}}function Ml(){Pe.value=!1,fe.value=null,me.value="",ye.value=null}async function Rl(m){var r,I,ae,de,oe,we,je,he,Be;if(m!=null&&m.data)try{const tt=w.value;await d.addOffer(tt.id,{vehicleBrand:((r=m.data)==null?void 0:r.brand)||"",vehicleModel:((I=m.data)==null?void 0:I.model)||"",vehicleYear:((ae=m.data)==null?void 0:ae.year)||"",price:((de=m.data)==null?void 0:de.price)||0,data:m.data}),await d.addActivity(tt.id,{type:"offer",user:((oe=S.currentUser)==null?void 0:oe.name)||"You",action:"created an offer",content:`Offer created: ${(we=m.data)==null?void 0:we.brand} ${(je=m.data)==null?void 0:je.model} (${(he=m.data)==null?void 0:he.year}) - € ${(((Be=m.data)==null?void 0:Be.price)||0).toLocaleString()}`,data:m.data,timestamp:new Date().toISOString()}),Ve.value=!1}catch(tt){console.error("Failed to create offer:",tt)}}function El(){Ve.value=!1}const Ws=$(()=>Js()),ha=$(()=>!!at.value.deliveryDate&&!!at.value.deliveryLocation),_s=$(()=>Js()),jl=$(()=>Js()),xa=$(()=>!!Te.value.deliveryDate&&!!Te.value.deliveryLocation),wa=$(()=>!!qe.value.actualDeliveryDate&&!!qe.value.deliveryLocation),ka=$(()=>!!$e.value.deliveryDate&&!!$e.value.deliveryLocation),Sa=$(()=>Object.values(Xe.value).some(m=>m===!0));function Ca(){en.value=!0}function $a(){en.value=!1}function Vn(){yn.value="default",gn.value=!0}function Bl(){yn.value="assignment",gn.value=!0}function Ys(){gn.value=!1,yn.value="default"}async function zl(m){var r,I,ae,de,oe,we,je,he,Be;if(m!=null&&m.data)try{if(yn.value==="assignment"){await ya({opportunity:w.value,offerData:m}),Ys();return}const tt=w.value;await d.addOffer(tt.id,{vehicleBrand:((r=m.data)==null?void 0:r.brand)||"",vehicleModel:((I=m.data)==null?void 0:I.model)||"",vehicleYear:((ae=m.data)==null?void 0:ae.year)||"",price:((de=m.data)==null?void 0:de.price)||0,data:m.data}),await d.addActivity(tt.id,{type:"offer",user:((oe=S.currentUser)==null?void 0:oe.name)||"You",action:"created an offer",content:`Offer created: ${(we=m.data)==null?void 0:we.brand} ${(je=m.data)==null?void 0:je.model} (${(he=m.data)==null?void 0:he.year}) - € ${(((Be=m.data)==null?void 0:Be.price)||0).toLocaleString()}`,data:m.data,timestamp:new Date().toISOString()}),Ys()}catch(tt){console.error("Failed to create offer:",tt)}}async function Wl(m){var r,I,ae,de,oe,we;if(m!=null&&m.contractDate)try{const je=A(),he=(r=je.offers)==null?void 0:r.find(tt=>tt.status==="accepted"||tt.acceptance_status==="accepted");await d.addContract(je.id,{contractDate:m.contractDate,contractTime:m.contractTime,notes:m.notes,lockedOfferId:he==null?void 0:he.id,lockedTradeInLabel:(I=he==null?void 0:he.data)==null?void 0:I.selectedTradeInLabel,lockedFinancingLabel:(ae=he==null?void 0:he.data)==null?void 0:ae.selectedFinancingLabel,lockedPrice:he==null?void 0:he.price});const Be=m.contractTime?`${m.contractDate}T${m.contractTime}:00`:`${m.contractDate}T12:00:00`;await d.addActivity(je.id,{type:"contract",user:((de=S.currentUser)==null?void 0:de.name)||"You",action:"created a contract",content:`Contract created: ${new Date(Be).toLocaleString()}${he?` (Locked terms from Offer #${he.id})`:""}`,data:{contractDate:Be,notes:m.notes,lockedOfferId:he==null?void 0:he.id,lockedTerms:he?{tradeIn:(oe=he.data)==null?void 0:oe.selectedTradeInLabel,financing:(we=he.data)==null?void 0:we.selectedFinancingLabel,price:he.price}:null},timestamp:new Date().toISOString()}),$a()}catch(je){console.error("Failed to create contract:",je)}}function _l(){Ye.value=!1,pt.value=!1,Zt.value=!1,et.value=!et.value}function Da(){Zt.value=!1,at.value={deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}async function Yl(){var m;if(ha.value)try{const r=A(),I=at.value.deliveryTime?`${at.value.deliveryDate}T${at.value.deliveryTime}:00`:`${at.value.deliveryDate}T12:00:00`,ae={deliveryDate:I,deliveryLocation:at.value.deliveryLocation,deliveryNotes:at.value.notes};r.deliveryDateSetDate||(ae.deliveryDateSetDate=new Date().toISOString()),await d.updateOpportunity(r.id,ae),await d.addActivity(r.id,{type:"delivery-scheduled",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:"set delivery date (step 1 of 2)",content:`Delivery scheduled for ${new Date(I).toLocaleString()} at ${at.value.deliveryLocation}`,data:{deliveryDate:I,location:at.value.deliveryLocation,notes:at.value.notes,step:1,totalSteps:2},timestamp:new Date().toISOString()}),Da()}catch(r){console.error("Failed to set delivery date:",r)}}function Aa(){et.value=!1}async function Hl(m){var Jn,Kn,Zn;const{eventType:r,selectedDate:I,selectedSlot:ae,selectedTeam:de,selectedSalesman:oe,durationValue:we,communicationPreferences:je}=m,he=A(),Be=I,[tt,Fn]=ae.split(":").map(Number),Et=new Date(Be);Et.setHours(tt,Fn,0,0);const jt=we||30,sn=new Date(Et.getTime()+jt*6e4),Sn=(oe==null?void 0:oe.name)||(de==null?void 0:de.name)||he.assignee||"Unassigned",Qn=(oe==null?void 0:oe.id)||(de==null?void 0:de.id)||null,Gn=oe?"user":"team";try{const Ln={customerId:he.customerId||((Jn=he.customer)==null?void 0:Jn.id),customer:((Kn=he.customer)==null?void 0:Kn.name)||"Unknown",start:Et.toISOString(),end:sn.toISOString(),type:r,title:`${r} - ${((Zn=he.customer)==null?void 0:Zn.name)||"Customer"}`,assigneeId:Qn,assigneeType:Gn,teamId:(de==null?void 0:de.id)||null,team:(de==null?void 0:de.name)||null,salesperson:(oe==null?void 0:oe.name)||null,salespersonId:(oe==null?void 0:oe.id)||null,duration:jt,opportunityId:he.id},Xn=await Gs(Ln),es={id:Xn.id,start:Et.toISOString(),end:sn.toISOString(),type:r,assignee:Sn,assigneeId:Qn,assigneeType:Gn,duration:jt,team:(de==null?void 0:de.name)||null,teamId:(de==null?void 0:de.id)||null,salesperson:(oe==null?void 0:oe.name)||null,salespersonId:(oe==null?void 0:oe.id)||null,communications:je,status:"confirmed"};await d.updateOpportunity(he.id,{scheduledAppointment:es}),l("appointment-scheduled",{...es,calendarEventId:Xn.id}),Aa()}catch(Ln){console.error("Failed to schedule appointment:",Ln)}}function Ta(){g.value&&(X.value=!1,ce.value=!1,le.value=!0,g.value.status!=="no-show"&&Gl())}function Ql(){g.value&&(X.value=!1,le.value=!1,ce.value=!0)}async function Gl(){var m;if(g.value)try{const I=(g.value.noShowCount||0)+1,ae=I===1?"NS1":I===2?"NS2":"NS3";if(g.value.id){const{updateCalendarEvent:oe}=await Cn(async()=>{const{updateCalendarEvent:we}=await import("./users-D9zJDDml.js").then(je=>je.i);return{updateCalendarEvent:we}},__vite__mapDeps([3,1,2]));await oe(g.value.id,{status:"no-show"})}const de={...g.value,status:"no-show",noShowCount:I};await d.updateOpportunity(i.opportunity.id,{scheduledAppointment:de}),await d.addActivity(i.opportunity.id,{type:"ns-task",user:((m=S.currentUser)==null?void 0:m.name)||"You",action:`${ae} - marked appointment as no-show`,content:`${ae}: Appointment on ${new Date(g.value.start).toLocaleString()} marked as no-show. This is the ${I===1?"first":I===2?"second":"third"} no-show.`,data:{appointmentId:g.value.id,noShowCount:I,nsLabel:ae},timestamp:new Date().toISOString()}),l("appointment-no-show",{appointmentId:g.value.id,noShowCount:I,nsLabel:ae})}catch(r){console.error("Failed to mark appointment as no-show:",r)}}function Jl({opportunity:m,reason:r}){pt.value=!0,We(),r&&(_e.value=r)}async function Kl({opportunity:m,reason:r}){var I;le.value=!1,await d.updateOpportunity(m.id,{stage:"Closed Lost",lossReason:r}),await d.addActivity(m.id,{type:"close-lost",user:((I=S.currentUser)==null?void 0:I.name)||"You",action:"closed opportunity as lost",content:`Opportunity closed as lost. Reason: ${r||"N/A"}`,data:{reason:r},timestamp:new Date().toISOString()})}function Hn(m){if(m&&m.handler)m.handler();else if(m&&m.key){const r=cs[m.key];r&&r()}}const{generateContractPDF:Oa,generateOfferPDF:Ia,previewContractPDF:Zl,previewOfferPDF:Xl,downloadPDF:eo,sendPDFByEmail:to}=Fs(),no=$(()=>{const m=w.value;return!(m!=null&&m.offers)||!Array.isArray(m.offers)?[]:m.offers.filter(r=>r.status==="active"||!r.status)});function Va(m=null,r=null){jn.value=m,is.value=r,Ct.value=!0}async function so(m){try{let r;m.type==="contract"?r=await Oa(m.opportunityId,m.options):r=await Ia(m.opportunityId,m.offerId,m.options),Bn.value=r.url,zn.value=r.id,Ct.value=!1,tn.value=!0}catch(r){console.error("Error generating PDF:",r),bn.value=r.message||"Failed to generate PDF"}}async function ao(m){Wn.value=!0,bn.value=null;try{let r;m.type==="contract"?r=await Zl(m.opportunityId,m.options):r=await Xl(m.opportunityId,m.offerId,m.options),Bn.value=r.previewUrl,zn.value=null,Ct.value=!1,tn.value=!0}catch(r){console.error("Error previewing PDF:",r),bn.value=r.message||"Failed to preview PDF"}finally{Wn.value=!1}}async function lo(m){var r;try{let I;m.type==="offer"?I=await Ia(m.opportunityId,m.offerId,m.options):I=await Oa(m.opportunityId,m.options),await to({pdfId:I.id,email:m.email,message:m.message||"",opportunityId:m.opportunityId}),Ct.value=!1,await d.addActivity(m.opportunityId,{type:"communication",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"sent offer PDF",content:`Offer PDF sent to ${m.email}${m.message?`. Message: ${m.message}`:""}`,data:{email:m.email,message:m.message,pdfId:I.id,offerId:m.offerId},timestamp:new Date().toISOString()})}catch(I){console.error("Error sending PDF:",I),bn.value=I.message||"Failed to send PDF"}}function oo(){tn.value=!1,Ct.value=!0}async function io(m){if(m)try{await eo(m)}catch(r){console.error("Error downloading PDF:",r),bn.value=r.message||"Failed to download PDF"}}function ro(m){var r,I;rs.value=m.pdfId,us.value=((I=(r=w.value)==null?void 0:r.customer)==null?void 0:I.email)||"",ds.value=`${jn.value==="contract"?"Contract":"Offer"} Document`,tn.value=!1,kn.value=!0}function uo(){}function co(m){kn.value=!1}function Fa(m){Va("offer",m.id)}function La(m){Va("contract")}async function Na(m){var r;try{const I=i.opportunity,ae=m.contract||m,de=m.formData||{},oe={contractSigned:!0};de.contractDate&&(oe.contractDate=de.contractDate),I.esignatureCollectedDate||(oe.esignatureCollectedDate=de.contractDate||new Date().toISOString()),de.notes&&(oe.contractNotes=de.notes),await d.updateOpportunity(I.id,oe),await d.addActivity(I.id,{type:"contract",user:((r=S.currentUser)==null?void 0:r.name)||"You",action:"collected e-signatures",content:`E-signatures collected for contract${ae.version?` v${ae.version}`:""}`,data:{contractDate:de.contractDate||ae.contractDate||I.contractDate,contractVersion:ae.version,esignatureCollectedDate:oe.esignatureCollectedDate,notes:de.notes},timestamp:new Date().toISOString()}),In.value&&In.value.setContractLoading(ae.id||ae.contractDate,!1)}catch(I){console.error("Failed to collect e-signatures:",I);const ae=m.contract||m;In.value&&In.value.setContractLoading(ae.id||ae.contractDate,!1)}}return Mn(async()=>{try{const r=(await cl({})).data||[];wn.value=r.filter(I=>I.stockDays!==null&&I.stockDays!==void 0).slice(0,5)}catch(m){console.error("Failed to load recommended cars:",m),wn.value=[]}g.value&&g.value.status==="no-show"&&(le.value=!0)}),(m,r)=>(f(),k(pe,null,[n(pl,{task:w.value,"hide-title":"","hide-border":""},{"deadline-banner":o(()=>[e("div",Tb,[Ee.isClosed.value?N("",!0):(f(),ee(xl,{key:0,"next-action-due":w.value.nextActionDue,"show-deadline-banner":Ee.showDeadlineBanner.value,"task-id":w.value.id},null,8,["next-action-due","show-deadline-banner","task-id"]))])]),"primary-action":o(()=>[n(gl,{task:w.value,"task-type":"opportunity",readonly:Ee.isClosed.value,onReassigned:Ls,class:"mb-3"},null,8,["task","readonly"]),!Ee.isClosed.value&&!ms.value&&!Yn.value&&Ee.primaryAction.value?(f(),ee(vl,{key:0,action:Ee.primaryAction.value,"color-scheme":Ee.primaryAction.value.colorScheme,onActionClicked:Ee.primaryAction.value.handler},null,8,["action","color-scheme","onActionClicked"])):N("",!0),Se((f(),k("div",{class:"mt-4",key:`offers-wrapper-${w.value.id}`},[On.value?(f(),ee(ri,{ref_key:"offerCarouselRef",ref:ba,key:`carousel-${w.value.id}`,offers:w.value.offers||[],"opportunity-id":w.value.id,onOfferActivated:Ul,onGeneratePdf:Fa,onAdd:Vn},null,8,["offers","opportunity-id"])):N("",!0)])),[[Oo,On.value]]),Yn.value&&!t(Nt).isClosed.value?(f(),k("div",Ob,[n(Ga,{ref_key:"contractCarouselRef",ref:In,contracts:F.value,"opportunity-id":w.value.id,"max-contract-date":Ws.value,onGeneratePdf:La,onCollectEsignatures:Na,onAdd:Ca},null,8,["contracts","opportunity-id","max-contract-date"])])):N("",!0),!t(Nt).isClosed.value&&w.value.stage==="In Negotiation"&&t(hn)(w.value,"opportunity")==="In Negotiation - Contract Pending"?(f(),ee(ob,{key:2,ref_key:"contractPendingManagementSectionRef",ref:Ae,opportunity:w.value,"has-contracts":F.value.length>0,"show-close-as-lost-section":pt.value,"show-schedule-appointment-contract-pending-section":et.value,"show-set-delivery-date-section":Zt.value,"close-as-lost-reason":t(_e),"close-as-lost-notes":t(un),"delivery-date-form":at.value,"has-delivery-date":z.value,"contract-pending-actions":Rn.value,"can-submit-set-delivery-date":ha.value,"min-delivery-date":_s.value,"onUpdate:showScheduleAppointmentContractPendingSection":r[0]||(r[0]=I=>et.value=I),"onUpdate:showSetDeliveryDateSection":r[1]||(r[1]=I=>{Zt.value.value=I,I&&(pt.value.value=!1,t(ts)(at.value,"deliveryDate"))}),"onUpdate:deliveryDateForm":r[2]||(r[2]=I=>at.value=I),onConfirmSetDeliveryDate:Yl,onCancelSetDeliveryDate:Da,onScheduleAppointmentContractPendingSubmit:Hl,onCancelScheduleAppointmentContractPending:Aa,onContractPendingAction:os,onCloseAsLostCancel:Bs,onCloseAsLostConfirm:ga,class:"mt-4"},null,8,["opportunity","has-contracts","show-close-as-lost-section","show-schedule-appointment-contract-pending-section","show-set-delivery-date-section","close-as-lost-reason","close-as-lost-notes","delivery-date-form","has-delivery-date","contract-pending-actions","can-submit-set-delivery-date","min-delivery-date"])):N("",!0),ms.value?(f(),ee(z1,{key:3,ref_key:"negotiationManagementSectionRef",ref:Ce,opportunity:w.value,"show-negotiation-section":Pe.value,"show-add-offer-section":Ve.value,"show-survey-section":nt.value,"negotiation-channel":fe.value,"negotiation-message":me.value,"negotiation-selected-offer-id":ye.value,"offer-select-options":Lt.value,"can-send-negotiation-message":En.value,"secondary-actions":Yt.value,"onUpdate:showNegotiationSection":r[3]||(r[3]=I=>Pe.value=I),"onUpdate:showAddOfferSection":r[4]||(r[4]=I=>Ve.value=I),"onUpdate:showSurveySection":r[5]||(r[5]=I=>nt.value=I),"onUpdate:negotiationChannel":r[6]||(r[6]=I=>fe.value=I),"onUpdate:negotiationMessage":r[7]||(r[7]=I=>me.value=I),"onUpdate:negotiationSelectedOfferId":r[8]||(r[8]=I=>ye.value=I),onResetNegotiationForm:r[9]||(r[9]=I=>{fe.value=null,me.value="",ye.value=null}),onSendNegotiationMessage:Pl,onCancelNegotiation:Ml,onOfferCreated:Rl,onCancelAddOffer:El,onOpenAddOfferModal:Vn,onOpenAddTradein:r[10]||(r[10]=I=>vn.value=!0),onOpenAddFinancing:r[11]||(r[11]=I=>Xt.value=!0),onOfbPostpone:vs,onGeneratePdf:Fa,onSecondaryAction:Hn,onSurveySubmitted:qs,onSurveyCancelled:ps},null,8,["opportunity","show-negotiation-section","show-add-offer-section","show-survey-section","negotiation-channel","negotiation-message","negotiation-selected-offer-id","offer-select-options","can-send-negotiation-message","secondary-actions"])):N("",!0),!Ee.isClosed.value&&g.value&&g.value.start?(f(),ee(x1,{key:4,ref_key:"appointmentManagementSectionRef",ref:Ke,opportunity:w.value,"scheduled-appointment":g.value,"show-reschedule-section":X.value,"show-ns-task-section":le.value,"show-offer-assignment-section":ce.value,"ns-task-count":gt.value,"can-submit-ns-task":ft.value,"ns-task-button-label":Mt.value,"can-create-offer":Re.value,"secondary-actions":Yt.value,"customer-name":h.value,"customer-profile-url":c.value,"is-appointment-today":b.value,onConfirmAppointment:Y,"onUpdate:showRescheduleSection":r[12]||(r[12]=I=>X.value=I),"onUpdate:showNsTaskSection":r[13]||(r[13]=I=>le.value=I),"onUpdate:showOfferAssignmentSection":r[14]||(r[14]=I=>ce.value=I),onMarkNoShow:Ta,onMarkShowedUp:Ql,onRescheduleSubmit:r[15]||(r[15]=I=>B(I,"reschedule")),onRescheduleCancel:Ft,onNsAssigned:Fl,onNsCancel:Nl,onNsConfirm:Ll,onNsCloseAsLost:Kl,onOfferAssignmentCreated:ya,onOfferAssignmentCancel:ql,onOpenCreateOfferModal:Bl,onSecondaryAction:Hn,onCloseAsLostConfirmed:Tl,onCustomerClick:x,class:"mt-4"},null,8,["opportunity","scheduled-appointment","show-reschedule-section","show-ns-task-section","show-offer-assignment-section","ns-task-count","can-submit-ns-task","ns-task-button-label","can-create-offer","secondary-actions","customer-name","customer-profile-url","is-appointment-today"])):N("",!0)]),"task-widgets":o(()=>[p.value&&F.value.length>0?(f(),k("div",Ib,[n(Ga,{ref_key:"contractCarouselRef",ref:In,contracts:F.value,"opportunity-id":w.value.id,"max-contract-date":Ws.value,onGeneratePdf:La,onCollectEsignatures:Na},null,8,["contracts","opportunity-id","max-contract-date"])])):N("",!0),y.value?(f(),k("div",Vb,[w.value.assignmentNote?(f(),k("div",Fb,[e("div",Lb,[r[59]||(r[59]=e("i",{class:"fa-solid fa-sticky-note text-blue-600 text-sm mt-0.5"},null,-1)),e("div",Nb,[r[58]||(r[58]=e("h5",{class:"font-semibold text-foreground text-sm mb-1"},"Note from Assigner",-1)),e("p",qb,U(w.value.assignmentNote),1)])])])):N("",!0),e("div",Ub,[e("div",Pb,[e("div",Mb,[e("div",Rb,[r[60]||(r[60]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Call to Schedule Appointment"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Contact the customer to schedule an appointment ")],-1)),n(hl,{"is-call-active":t(_),"call-ended":t(Q),"call-duration":t(ue),"call-notes":t(ne),"formatted-call-duration":t(O),"mock-transcription":t(E),"contact-attempts":0,"max-contact-attempts":3,onStartCall:Ne,onEndCall:ot,onLogManualCall:mt,onExtractInformation:r[16]||(r[16]=I=>Wt.value=!0),"onUpdate:callNotes":it,onCopyNumber:ze},null,8,["is-call-active","call-ended","call-duration","call-notes","formatted-call-duration","mock-transcription"])])])]),e("div",Eb,[n(ls,{ref_key:"scheduleFormRef",ref:kt,opportunity:w.value,mode:"schedule",onSubmit:r[17]||(r[17]=I=>B(I,"schedule")),onCancel:rt},null,8,["opportunity"])])])])):N("",!0),P.value?(f(),k("div",jb,[e("div",Bb,[e("div",zb,[e("div",Wb,[e("div",_b,[e("h4",Yb,U(L.value),1),e("p",Hb,U(q.value),1)]),e("div",Qb,[e("div",Gb,[z.value?N("",!0):(f(),ee(t(Ue),{key:0,variant:"outline","model-value":xe.value,"onUpdate:modelValue":r[18]||(r[18]=I=>{xe.value=I,I&&(ke.value=!1,t(ts)(Te.value,"deliveryDate"))}),class:"outcome-toggle-item"},{default:o(()=>[...r[61]||(r[61]=[e("i",{class:"fa-solid fa-truck"},null,-1),e("span",null,"Schedule Delivery",-1)])]),_:1},8,["model-value"])),z.value&&!H.value?(f(),ee(t(Ue),{key:1,variant:"outline","model-value":ke.value,"onUpdate:modelValue":r[19]||(r[19]=I=>{ke.value=I,I&&(xe.value=!1,t(ts)(qe.value,"actualDeliveryDate"))}),class:"outcome-toggle-item"},{default:o(()=>[...r[62]||(r[62]=[e("i",{class:"fa-solid fa-calendar-check"},null,-1),e("span",null,"Confirm Delivery",-1)])]),_:1},8,["model-value"])):N("",!0)]),n(t(J),{variant:"outline",onClick:zs,class:"inline-flex items-center gap-2 cursor-pointer"},{default:o(()=>[...r[63]||(r[63]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),e("span",null,"Reopen Opportunity",-1)])]),_:1}),Yt.value&&Yt.value.length>0?(f(),ee(Pn,{key:0,actions:Yt.value,onActionSelected:Hn},null,8,["actions"])):N("",!0)])])])]),e("div",Jb,[xe.value?(f(),k("div",Kb,[e("div",Zb,[r[71]||(r[71]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Schedule Delivery",-1)),e("div",Xb,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[64]||(r[64]=[D("Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:Te.value.deliveryDate,"onUpdate:modelValue":r[20]||(r[20]=I=>Te.value.deliveryDate=I),min:_s.value,class:"w-full"},null,8,["modelValue","min"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[65]||(r[65]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:Te.value.deliveryTime,"onUpdate:modelValue":r[21]||(r[21]=I=>Te.value.deliveryTime=I),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[66]||(r[66]=[D("Delivery Location",-1)])]),_:1}),n(t(Ot),{modelValue:Te.value.deliveryLocation,"onUpdate:modelValue":r[22]||(r[22]=I=>Te.value.deliveryLocation=I)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select location..."})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Dealership"},{default:o(()=>[...r[67]||(r[67]=[D("At Dealership",-1)])]),_:1}),n(t(ge),{value:"Customer Address"},{default:o(()=>[...r[68]||(r[68]=[D("Customer Address",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...r[69]||(r[69]=[D("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[70]||(r[70]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:Te.value.notes,"onUpdate:modelValue":r[23]||(r[23]=I=>Te.value.notes=I),rows:"4",placeholder:"Add any relevant delivery details...",class:"w-full"},null,8,["modelValue"])])])]),e("div",eh,[n(t(J),{variant:"secondary",onClick:nn},{default:o(()=>[...r[72]||(r[72]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!xa.value,onClick:js},{default:o(()=>[...r[73]||(r[73]=[D(" Schedule Delivery ",-1)])]),_:1},8,["disabled"])])])):N("",!0),ke.value?(f(),k("div",th,[e("div",nh,[r[82]||(r[82]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Confirm Delivery",-1)),e("p",sh," Delivery was scheduled for "+U(t(qn)(w.value.deliveryDate))+". Confirm that the delivery has been completed. ",1),e("div",ah,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[74]||(r[74]=[D("Scheduled Delivery Date",-1)])]),_:1}),n(t(Oe),{type:"text",value:t(qn)(w.value.deliveryDate),disabled:"",class:"w-full"},null,8,["value"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[75]||(r[75]=[D("Actual Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:qe.value.actualDeliveryDate,"onUpdate:modelValue":r[24]||(r[24]=I=>qe.value.actualDeliveryDate=I),max:jl.value,class:"w-full"},null,8,["modelValue","max"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[76]||(r[76]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:qe.value.deliveryTime,"onUpdate:modelValue":r[25]||(r[25]=I=>qe.value.deliveryTime=I),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[77]||(r[77]=[D("Delivery Location",-1)])]),_:1}),n(t(Ot),{modelValue:qe.value.deliveryLocation,"onUpdate:modelValue":r[26]||(r[26]=I=>qe.value.deliveryLocation=I)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select location..."})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Dealership"},{default:o(()=>[...r[78]||(r[78]=[D("At Dealership",-1)])]),_:1}),n(t(ge),{value:"Customer Address"},{default:o(()=>[...r[79]||(r[79]=[D("Customer Address",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...r[80]||(r[80]=[D("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[81]||(r[81]=[D("Delivery Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:qe.value.notes,"onUpdate:modelValue":r[27]||(r[27]=I=>qe.value.notes=I),rows:"4",placeholder:"Add any relevant delivery details, customer feedback, etc...",class:"w-full"},null,8,["modelValue"])])])]),e("div",lh,[n(t(J),{variant:"secondary",onClick:ma},{default:o(()=>[...r[83]||(r[83]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!wa.value,onClick:Al},{default:o(()=>[...r[84]||(r[84]=[D(" Mark as Delivered ",-1)])]),_:1},8,["disabled"])])])):N("",!0),Me.value?(f(),k("div",oh,[e("div",ih,[r[92]||(r[92]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Reschedule Delivery",-1)),e("p",rh," Current delivery scheduled for "+U(t(qn)(w.value.deliveryDate))+". Update the delivery date and time. ",1),e("div",uh,[e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[85]||(r[85]=[D("New Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),n(t(Oe),{type:"date",modelValue:$e.value.deliveryDate,"onUpdate:modelValue":r[28]||(r[28]=I=>$e.value.deliveryDate=I),min:_s.value,class:"w-full"},null,8,["modelValue","min"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[86]||(r[86]=[D("Time (Optional)",-1)])]),_:1}),n(t(Oe),{type:"time",modelValue:$e.value.deliveryTime,"onUpdate:modelValue":r[29]||(r[29]=I=>$e.value.deliveryTime=I),class:"w-full"},null,8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[87]||(r[87]=[D("Delivery Location",-1)])]),_:1}),n(t(Ot),{modelValue:$e.value.deliveryLocation,"onUpdate:modelValue":r[30]||(r[30]=I=>$e.value.deliveryLocation=I)},{default:o(()=>[n(t(Dt),{class:"w-full"},{default:o(()=>[n(t(At),{placeholder:"Select location..."})]),_:1}),n(t(Tt),null,{default:o(()=>[n(t(ge),{value:"Dealership"},{default:o(()=>[...r[88]||(r[88]=[D("At Dealership",-1)])]),_:1}),n(t(ge),{value:"Customer Address"},{default:o(()=>[...r[89]||(r[89]=[D("Customer Address",-1)])]),_:1}),n(t(ge),{value:"Other"},{default:o(()=>[...r[90]||(r[90]=[D("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[91]||(r[91]=[D("Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:$e.value.notes,"onUpdate:modelValue":r[31]||(r[31]=I=>$e.value.notes=I),rows:"4",placeholder:"Add reason for rescheduling or any relevant details...",class:"w-full"},null,8,["modelValue"])])])]),e("div",dh,[n(t(J),{variant:"secondary",onClick:fa},{default:o(()=>[...r[93]||(r[93]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!ka.value,onClick:Cl},{default:o(()=>[...r[94]||(r[94]=[D(" Reschedule Delivery ",-1)])]),_:1},8,["disabled"])])])):N("",!0),ut.value?(f(),k("div",ch,[e("div",mh,[r[101]||(r[101]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Complete Delivery Checklist",-1)),r[102]||(r[102]=e("p",{class:"text-sm text-muted-foreground mb-4"}," Complete the post-delivery checklist to finalize the delivery process. ",-1)),e("div",fh,[e("div",ph,[e("div",vh,[Se(e("input",{type:"checkbox",id:"checklist-vehicle","onUpdate:modelValue":r[32]||(r[32]=I=>Xe.value.vehicleInspected=I),class:"rounded border-gray-300"},null,512),[[$t,Xe.value.vehicleInspected]]),n(t(W),{for:"checklist-vehicle",class:"text-sm text-foreground cursor-pointer"},{default:o(()=>[...r[95]||(r[95]=[D("Vehicle inspected and in good condition",-1)])]),_:1})]),e("div",gh,[Se(e("input",{type:"checkbox",id:"checklist-documents","onUpdate:modelValue":r[33]||(r[33]=I=>Xe.value.documentsProvided=I),class:"rounded border-gray-300"},null,512),[[$t,Xe.value.documentsProvided]]),n(t(W),{for:"checklist-documents",class:"text-sm text-foreground cursor-pointer"},{default:o(()=>[...r[96]||(r[96]=[D("All documents provided to customer",-1)])]),_:1})]),e("div",yh,[Se(e("input",{type:"checkbox",id:"checklist-payment","onUpdate:modelValue":r[34]||(r[34]=I=>Xe.value.paymentReceived=I),class:"rounded border-gray-300"},null,512),[[$t,Xe.value.paymentReceived]]),n(t(W),{for:"checklist-payment",class:"text-sm text-foreground cursor-pointer"},{default:o(()=>[...r[97]||(r[97]=[D("Payment received and processed",-1)])]),_:1})]),e("div",bh,[Se(e("input",{type:"checkbox",id:"checklist-warranty","onUpdate:modelValue":r[35]||(r[35]=I=>Xe.value.warrantyExplained=I),class:"rounded border-gray-300"},null,512),[[$t,Xe.value.warrantyExplained]]),n(t(W),{for:"checklist-warranty",class:"text-sm text-foreground cursor-pointer"},{default:o(()=>[...r[98]||(r[98]=[D("Warranty and service information explained",-1)])]),_:1})]),e("div",hh,[Se(e("input",{type:"checkbox",id:"checklist-keys","onUpdate:modelValue":r[36]||(r[36]=I=>Xe.value.keysHandedOver=I),class:"rounded border-gray-300"},null,512),[[$t,Xe.value.keysHandedOver]]),n(t(W),{for:"checklist-keys",class:"text-sm text-foreground cursor-pointer"},{default:o(()=>[...r[99]||(r[99]=[D("Keys and accessories handed over",-1)])]),_:1})])]),e("div",null,[n(t(W),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...r[100]||(r[100]=[D("Additional Notes (Optional)",-1)])]),_:1}),n(t(He),{modelValue:zt.value,"onUpdate:modelValue":r[37]||(r[37]=I=>zt.value=I),rows:"4",placeholder:"Add any additional notes or observations...",class:"w-full"},null,8,["modelValue"])])])]),e("div",xh,[n(t(J),{variant:"secondary",onClick:pa},{default:o(()=>[...r[103]||(r[103]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",disabled:!Sa.value,onClick:$l},{default:o(()=>[...r[104]||(r[104]=[D(" Complete Checklist ",-1)])]),_:1},8,["disabled"])])])):N("",!0)])])):N("",!0),R.value?(f(),k("div",wh,[e("div",kh,[e("div",Sh,[e("div",Ch,[e("div",$h,[r[107]||(r[107]=e("h4",{class:"font-bold text-foreground text-sm"},"Opportunity Closed as Lost",-1)),r[108]||(r[108]=e("p",{class:"text-sm text-muted-foreground mt-0.5"}," This opportunity was closed as lost. You can reopen it to continue the sales process or requalify it as a lead. ",-1)),e("div",Dh,[e("div",Ah,[r[106]||(r[106]=e("i",{class:"fa-solid fa-info-circle text-red-600 text-sm mt-0.5"},null,-1)),e("div",Th,[r[105]||(r[105]=e("p",{class:"text-sm font-medium text-red-900"},"Reason for Closing",-1)),e("p",Oh,U(w.value.lossReason||"No reason provided"),1),w.value.lossNotes?(f(),k("p",Ih,U(w.value.lossNotes),1)):N("",!0)])])])]),e("div",Vh,[e("div",Fh,[n(t(Ue),{variant:"outline","model-value":Kt.value,"onUpdate:modelValue":r[38]||(r[38]=I=>Kt.value=I),class:"outcome-toggle-item"},{default:o(()=>[...r[109]||(r[109]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),e("span",null,"Reopen Opportunity",-1)])]),_:1},8,["model-value"])]),Yt.value&&Yt.value.length>0?(f(),ee(Pn,{key:0,actions:Yt.value,onActionSelected:Hn},null,8,["actions"])):N("",!0)])])])]),e("div",Lh,[Kt.value?(f(),k("div",Nh,[e("div",qh,[r[112]||(r[112]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Reopen Opportunity",-1)),r[113]||(r[113]=e("p",{class:"text-sm text-muted-foreground mb-4"},' Reopening this opportunity will restore it to an active state. The opportunity will return to the appropriate stage based on its current state (e.g., if it has offers, it will return to "In Negotiation"). ',-1)),e("div",Uh,[n(t(J),{variant:"secondary",onClick:r[39]||(r[39]=I=>Kt.value=!1)},{default:o(()=>[...r[110]||(r[110]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",onClick:zs},{default:o(()=>[...r[111]||(r[111]=[D(" Reopen Opportunity ",-1)])]),_:1})])])])):N("",!0)])])):N("",!0),pt.value&&!Ee.isClosed.value&&!(g.value&&g.value.start)&&!Yn.value?(f(),ee(ca,{key:4,ref_key:"closeAsLostCardRef",ref:st,"preselected-reason":t(_e),"preselected-notes":t(un),onCancel:Bs,onConfirm:ga},null,8,["preselected-reason","preselected-notes"])):N("",!0),te.value&&!Ee.isClosed.value?(f(),k("div",Ph,[e("div",Mh,[n(ls,{ref_key:"inlineScheduleFormRef",ref:Pt,opportunity:w.value,mode:"schedule",onSubmit:r[40]||(r[40]=I=>B(I,"schedule")),onCancel:Z},null,8,["opportunity"])])])):Ee.activeTaskWidget.value&&Ee.activeTaskWidget.value.component?(f(),k("div",Rh,[(f(),ee(sa(Ee.activeTaskWidget.value.component),na(Ee.activeTaskWidget.value.props,{onClose:fs,onAutoCloseLost:Jl,onSurveySubmitted:Ns,onSurveyCancelled:fs,onPostpone:vs,onRescheduleDelivery:m.handleRescheduleDeliveryFromTask}),null,16,["onRescheduleDelivery"]))])):N("",!0)]),"secondary-actions":o(()=>[...r[114]||(r[114]=[])]),_:1},8,["task"]),se.value?(f(),ee(ul,{key:0,show:se.value,customer:w.value.customer,assignee:w.value.assignee,"disabled-fields":["customer"],onCreate:ie,onCancel:r[41]||(r[41]=I=>se.value=!1)},null,8,["show","customer","assignee"])):N("",!0),An.value?(f(),ee(Lv,{key:1,opportunity:w.value,"requested-car":w.value.requestedCar,"recommended-cars":wn.value,onVehicleSelected:Es,onClose:r[42]||(r[42]=I=>An.value=!1)},null,8,["opportunity","requested-car","recommended-cars"])):N("",!0),mn.value?(f(),ee(Mv,{key:2,opportunity:w.value,onContractSet:Fe,onClose:r[43]||(r[43]=I=>mn.value=!1)},null,8,["opportunity"])):N("",!0),fn.value?(f(),ee(Wv,{key:3,opportunity:w.value,onDelivered:Le,onClose:r[44]||(r[44]=I=>fn.value=!1)},null,8,["opportunity"])):N("",!0),pn.value?(f(),ee(Gv,{key:4,opportunity:w.value,onRequalified:Ol,onClose:r[45]||(r[45]=I=>pn.value=!1)},null,8,["opportunity"])):N("",!0),Wt.value?(f(),ee(oa,{key:5,onClose:r[46]||(r[46]=I=>Wt.value=!1)})):N("",!0),Rt.value&&g.value?(f(),ee(di,{key:6,show:Rt.value,event:g.value,onClose:r[47]||(r[47]=I=>Rt.value=!1),onEdit:r[48]||(r[48]=I=>{Rt.value=!1,_t.value=!0}),onDelete:Il},null,8,["show","event"])):N("",!0),_t.value&&g.value?(f(),ee(ci,{key:7,show:_t.value,event:g.value,customer:w.value.customer,"disabled-fields":["customer"],onSave:Vl,onCancel:r[49]||(r[49]=I=>_t.value=!1)},null,8,["show","event","customer"])):N("",!0),Ct.value?(f(),ee(Og,{key:8,show:Ct.value,"opportunity-id":w.value.id,"document-type":jn.value,"offer-id":is.value,"available-offers":no.value,customer:w.value.customer,onClose:r[50]||(r[50]=I=>Ct.value=!1),onGenerate:so,onPreview:ao,onSend:lo},null,8,["show","opportunity-id","document-type","offer-id","available-offers","customer"])):N("",!0),Xt.value?(f(),ee(ia,{key:9,show:Xt.value,"task-type":"opportunity","task-id":w.value.id,onSave:M,onClose:r[51]||(r[51]=I=>Xt.value=!1)},null,8,["show","task-id"])):N("",!0),vn.value?(f(),ee(ra,{key:10,show:vn.value,mode:"tradein","task-type":"opportunity","task-id":w.value.id,onSave:v,onClose:r[52]||(r[52]=I=>vn.value=!1)},null,8,["show","task-id"])):N("",!0),tn.value?(f(),ee(Rg,{key:11,show:tn.value,"pdf-url":Bn.value,"pdf-id":zn.value,loading:Wn.value,error:bn.value,onClose:r[53]||(r[53]=I=>tn.value=!1),onRegenerate:oo,onDownload:io,onEmail:ro,onPrint:uo},null,8,["show","pdf-url","pdf-id","loading","error"])):N("",!0),en.value?(f(),ee(ub,{key:12,show:en.value,"max-contract-date":Ws.value,onConfirm:Wl,onCancel:$a},null,8,["show","max-contract-date"])):N("",!0),gn.value?(f(),ee(Ab,{key:13,show:gn.value,opportunity:w.value,onConfirm:zl,onCancel:Ys,onOpenAddTradein:r[54]||(r[54]=I=>vn.value=!0),onOpenAddFinancing:r[55]||(r[55]=I=>Xt.value=!0)},null,8,["show","opportunity"])):N("",!0),n(Qg,{show:Tn.value,"task-type":lt.value||"",onClose:Ps,onConfirm:Us},null,8,["show","task-type"]),n(Jg,{show:yt.value,opportunity:w.value,onClose:Rs,onConfirm:Ms},null,8,["show","opportunity"]),kn.value?(f(),ee(Yg,{key:14,show:kn.value,"pdf-id":rs.value,"recipient-email":us.value,"default-subject":ds.value,onClose:r[56]||(r[56]=I=>kn.value=!1),onSent:co},null,8,["show","pdf-id","recipient-email","default-subject"])):N("",!0),St.value?(f(),ee(t(wt),{key:15},{default:o(()=>[n(t(bt),null,{default:o(()=>[n(t(ht),null,{default:o(()=>[n(t(xt),null,{default:o(()=>[...r[115]||(r[115]=[D("Archive Opportunity",-1)])]),_:1}),n(t(ho),null,{default:o(()=>[...r[116]||(r[116]=[D(" Are you sure you want to archive this opportunity? This action will mark it as completed and archived. ",-1)])]),_:1})]),_:1}),e("div",Eh,[n(t(J),{variant:"secondary",onClick:r[57]||(r[57]=I=>St.value=!1)},{default:o(()=>[...r[117]||(r[117]=[D(" Cancel ",-1)])]),_:1}),n(t(J),{variant:"default",onClick:Dl},{default:o(()=>[...r[118]||(r[118]=[D(" Archive ",-1)])]),_:1})])]),_:1})]),_:1})):N("",!0)],64))}},Bh=on(jh,[["__scopeId","data-v-8ad9f6d1"]]);function n0(s){const C=rn(),a=Bt(),i=$(()=>s.value?s.value.type==="lead"?xm:Bh:null),l=$(()=>s.value?s.value.type==="lead"?{currentActivities:$(()=>C.currentLeadActivities),addActivity:(d,S)=>C.addActivity(d,S),updateActivity:(d,S,V)=>C.updateActivity(d,S,V),deleteActivity:(d,S)=>C.deleteActivity(d,S),updateLead:(d,S)=>C.updateLead(d,S),loadLeadById:d=>C.fetchLeadById(d)}:{currentActivities:$(()=>a.currentOpportunityActivities),addActivity:(d,S)=>a.addActivity(d,S),updateActivity:(d,S,V)=>a.updateActivity(d,S,V),deleteActivity:(d,S)=>a.deleteActivity(d,S),addVehicle:(d,S)=>a.addVehicle(d,S),createOffer:(d,S)=>a.createOffer(d,S),updateOpportunity:(d,S)=>a.updateOpportunity(d,S),loadOpportunityById:d=>a.fetchOpportunityById(d)}:null),u=$(()=>s.value?{overviewActions:["financing","tradein","purchase"],tabActions:["note","call","email","sms","whatsapp","attachment"]}:{overviewActions:[],tabActions:[]});return{managementWidget:i,storeAdapter:l,addNewConfig:u}}function s0(s){const C=rn(),a=Bt(),i=Jt(),l=$(()=>{const b=(s.value?C.leads:C.leads.filter(x=>!x.isDisqualified)).map(x=>{const p=hn(x,"lead"),F={...x,type:"lead",compositeId:`lead-${x.id}`,displayStage:p};return!F.customer&&x.customer&&(F.customer=x.customer),F}),h=a.opportunities.map(x=>{const p=hn(x,"opportunity"),F={...x,type:"opportunity",compositeId:`opportunity-${x.id}`,displayStage:p};return!F.customer&&x.customer&&(F.customer=x.customer),F});let c=[];return i.isOperator()?c=b:i.isSalesman()?c=h:c=[...b,...h],c}),u=(y,b)=>!b||b.length===0?y:Array.isArray(b)?y.filter(h=>b.includes(h.type)):b==="all"?y:y.filter(h=>h.type===b),d=y=>{const b=new Date,h=new Date(b.getTime()+24*60*60*1e3);return y.filter(c=>{if(!c.nextActionDue)return!1;const x=new Date(c.nextActionDue);return x>=b&&x<=h})},S=y=>y.filter(b=>b.nextActionDue!=null),V=y=>{const b=new Date(Date.now()-36e5);return y.filter(h=>h.type!=="lead"||!h.createdAt?!1:new Date(h.createdAt)>=b)},A=y=>{var h;const b=(h=i.currentUser)==null?void 0:h.name;return b?y.filter(c=>c.assignee===b):[]},w=(y,b)=>{if(!b||b.length===0)return y;let h=[...y];const c=b.filter(x=>x==="lead"||x==="opportunity");return c.length>0&&(h=u(h,c)),b.forEach(x=>{switch(x){case"due-in-24h":h=d(h);break;case"to-be-called":h=S(h);break;case"leads-1h":h=V(h);break;case"assigned-to-me":h=A(h);break}}),h},g=$(()=>{const y=l.value.some(h=>h.type==="lead"),b=l.value.some(h=>h.type==="opportunity");return y&&b});return{allTasks:l,filterByType:u,filterByDueIn24Hours:d,filterByToBeCalled:S,filterByLeadsCreated1Hour:V,filterByAssignedToMe:A,applyFilters:w,shouldShowTypeFilter:g}}export{t0 as D,e0 as T,ki as _,n0 as a,hi as g,s0 as u};
