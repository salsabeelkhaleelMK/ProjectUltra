import{d as i,o as r,e,g as w,n as F,t as c,I as G,w as ne,k as V,h as H,x as q,D as O,F as j,i as U,_ as re,r as T,s as A,c as C,y as L,Q as X,C as le,Z as ie,m as de,l as ue,$ as ce,a0 as pe,a1 as me}from"./index-Bh03WcOC.js";import{u as fe}from"./opportunities-BTZM9yyg.js";import{u as be,f as ye,a as ve,b as ge,c as he}from"./customers-CgUo4kg6.js";import{l as xe,r as we,g as ke,m as _e,_ as Ce}from"./ComingSoonModal-RE8dbRfU.js";import{z as $e,F as Ae,L as Se,H as Ee,j as Te,K as De,C as Be,W as Le}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-DA4kdAII.js";import{_ as Oe}from"./UnifiedAddForm-DtPYK7zs.js";import"./ReassignUserModal-Ccn5hxL3.js";import"./users-C5eDhXwU.js";import"./CreateEventModal-CDTj2y2Y.js";const Fe={class:"bg-surface border border-black/5 rounded-xl shadow-mk-dashboard-card mb-6"},Ie={class:"p-4 border-b border-black/5 bg-surfaceSecondary/50 flex justify-between items-center"},Ne={class:"flex items-center gap-2"},qe={class:"heading-sub text-fluid-sm font-medium"},je={class:"flex items-center gap-2"},Ue={key:0,class:"p-6 text-center text-sub"},Me={class:"text-content text-fluid-base"},Re={key:1,class:"p-4"},ee={__name:"SectionCard",props:{title:{type:String,required:!0},icon:{type:String,default:""},count:{type:Number,default:void 0},countColorClass:{type:String,default:""},showAddButton:{type:Boolean,default:!1},addButtonLabel:{type:String,default:"Add"},addButtonColorClass:{type:String,default:""},emptyStateMessage:{type:String,default:""},hasEmptyState:{type:Boolean,default:!1}},emits:["add"],setup(d){return(y,m)=>(r(),i("div",Fe,[e("div",Ie,[e("div",Ne,[d.icon?(r(),i("i",{key:0,class:F([d.icon,"text-sub text-fluid-xs"])},null,2)):w("",!0),e("h3",qe,c(d.title),1),d.count!==void 0&&d.count>0?(r(),i("span",{key:1,class:F(["text-fluid-xs font-bold px-2 py-0.5 rounded",d.countColorClass||"bg-surfaceSecondary text-body"])},c(d.count),3)):w("",!0)]),e("div",je,[G(y.$slots,"header-actions"),d.showAddButton?(r(),i("button",{key:0,onClick:m[0]||(m[0]=ne(p=>y.$emit("add"),["stop"])),class:F(["text-fluid-xs font-bold flex items-center gap-1 transition-colors",d.addButtonColorClass||"text-blue-600 hover:text-blue-700"])},[m[1]||(m[1]=e("i",{class:"fa-solid fa-plus-circle"},null,-1)),V(" "+c(d.addButtonLabel||"Add"),1)],2)):w("",!0)])]),d.hasEmptyState?(r(),i("div",Ue,[G(y.$slots,"empty-state",{},()=>[m[2]||(m[2]=e("i",{class:"fa-solid fa-inbox text-2xl mb-2"},null,-1)),e("p",Me,c(d.emptyStateMessage||"No items found"),1)])])):(r(),i("div",Re,[G(y.$slots,"content")]))]))}},Ve={class:"space-y-3"},We=["onClick"],ze={class:"flex items-center justify-between mb-2"},Pe={class:"flex-1 min-w-0"},Qe={class:"flex items-center gap-2 mb-1"},Ye={class:"font-semibold text-heading text-content"},He={class:"flex items-center gap-3 text-meta"},Ke={key:0},Ze={key:1},Ge={key:0,class:"mt-2 space-y-2 border-t border pt-2"},Je={class:"flex items-center gap-2"},Xe={class:"text-meta text-body font-medium"},et={__name:"CustomerLeadsWidget",props:{leads:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]}},emits:["add-lead"],setup(d,{emit:y}){const m=d,p=H(),o=s=>{if(!s)return 0;const t=new Date(s),f=Math.abs(new Date-t);return Math.ceil(f/(1e3*60*60*24))},h=s=>{const t=[];return m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(f=>f.leadId===s.id).forEach(f=>{t.push({id:f.id,type:f.title||"Task",description:f.description||f.title})}),s.stage==="Open Lead"&&o(s.createdAt)>=0&&t.push({id:`lead-${s.id}-lq`,type:"LQ",description:"Call to Verify Contact Details"}),t},b=s=>({LQ:"bg-orange-100 text-orange-700 border border-orange-200"})[s]||"bg-surfaceSecondary text-body border border-E5E7EB",S=s=>({"Open Lead":"bg-orange-100 text-orange-700 border border-orange-200",Validated:"bg-blue-100 text-blue-700 border border-blue-200",Contacted:"bg-blue-100 text-blue-700 border border-blue-200"})[s]||"bg-surfaceSecondary text-body border border-E5E7EB",x=s=>{const t=p.resolve({path:`/tasks/${s.id}`,query:{type:"lead"}});window.open(t.href,"_blank")};return(s,t)=>(r(),q(ee,{title:"Leads",icon:"fa-solid fa-user-circle",count:d.leads.length,"count-color-class":"bg-blue-100 text-blue-700","show-add-button":"","add-button-label":"Add Lead","add-button-color-class":"text-blue-600 hover:text-blue-700","has-empty-state":d.leads.length===0,"empty-state-message":"No leads associated with this customer",onAdd:t[0]||(t[0]=l=>s.$emit("add-lead"))},{content:O(()=>[e("div",Ve,[(r(!0),i(j,null,U(d.leads,l=>(r(),i("div",{key:l.id,class:"flex flex-col p-3 bg-surfaceSecondary hover:bg-surfaceSecondary border border-E5E7EB rounded-lg cursor-pointer transition-colors",onClick:f=>x(l)},[e("div",ze,[e("div",Pe,[e("div",Qe,[e("span",Ye,"Lead #"+c(l.id),1),e("span",{class:F(["text-xs px-2 py-0.5 rounded-full font-medium",S(l.stage)])},c(l.stage),3)]),e("div",He,[l.assignee?(r(),i("span",Ke,c(l.assignee),1)):w("",!0),l.requestedCar?(r(),i("span",Ze,c(l.requestedCar.brand)+" "+c(l.requestedCar.model),1)):w("",!0)])]),t[1]||(t[1]=e("i",{class:"fa-solid fa-external-link text-gray-400 text-xs ml-2"},null,-1))]),h(l).length>0?(r(),i("div",Ge,[(r(!0),i(j,null,U(h(l),f=>(r(),i("div",{key:f.id,class:"flex items-center justify-between p-2 bg-surface border border-E5E7EB rounded-md shadow-sm"},[e("div",Je,[e("span",{class:F(["text-xs px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider",b(f.type)])},c(f.type),3),e("span",Xe,c(f.description),1)]),t[2]||(t[2]=e("i",{class:"fa-solid fa-chevron-right text-xs text-gray-300"},null,-1))]))),128))])):w("",!0)],8,We))),128))])]),_:1},8,["count","has-empty-state"]))}},tt={class:"space-y-3"},st=["onClick"],at={class:"flex items-center justify-between mb-2"},ot={class:"flex-1 min-w-0"},nt={class:"flex items-center gap-2 mb-1"},rt={class:"font-semibold text-heading text-content"},lt={class:"flex items-center gap-3 text-meta"},it={key:0},dt={key:1},ut={key:2},ct={key:0,class:"mt-2 space-y-2 border-t border pt-2"},pt={class:"flex items-center gap-2"},mt={class:"text-meta text-body font-medium"},ft={__name:"CustomerOpportunitiesWidget",props:{opportunities:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]},activities:{type:Array,default:()=>[]}},emits:["add-opportunity"],setup(d,{emit:y}){const m=d,p=H(),o=s=>{const t=[];m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(_=>_.opportunityId===s.id).forEach(_=>{t.push({id:_.id,type:_.title||"Task",description:_.description||_.title})});const l=m.activities.filter(E=>E.opportunityId===s.id),f={opportunity:s,scheduledAppointment:s.scheduledAppointment||null,activities:l,hasOffers:l.some(E=>E.type==="offer")||!1,stage:s.displayStage||s.stage,deliverySubstatus:s.deliverySubstatus||null},k=xe(f.stage,f);if(k){const E={OOFB:"Open Opportunity Feedback",UFB:"Unsold Feedback",NFU:"No Follow-Up",OFB:"Offer Feedback",CFB:"Contract Feedback",DFB:"Delivery Feedback",NS:"No-Show Follow-up"};t.push({id:`opp-${s.id}-${k}`,type:k,description:E[k]||k})}return t},h=s=>({OOFB:"bg-blue-100 text-blue-700 border border-blue-200",UFB:"bg-purple-100 text-purple-700 border border-purple-200",NFU:"bg-red-100 text-red-700 border border-red-200",OFB:"bg-yellow-100 text-yellow-700 border border-yellow-200",CFB:"bg-green-100 text-green-700 border border-green-200",DFB:"bg-teal-100 text-teal-700 border border-teal-200",NS:"bg-pink-100 text-pink-700 border border-pink-200"})[s]||"bg-surfaceSecondary text-body border border-E5E7EB",b=s=>new Intl.NumberFormat("en-US").format(s),S=s=>({Qualified:"bg-purple-100 text-purple-700 border border-purple-200","In Negotiation":"bg-blue-100 text-blue-700 border border-blue-200","Closed Won":"bg-green-100 text-green-700 border border-green-200","Closed Lost":"bg-red-100 text-red-700 border border-red-200"})[s]||"bg-surfaceSecondary text-body border border-E5E7EB",x=s=>{const t=p.resolve({path:`/tasks/${s.id}`,query:{type:"opportunity"}});window.open(t.href,"_blank")};return(s,t)=>(r(),q(ee,{title:"Opportunities",icon:"fa-solid fa-briefcase",count:d.opportunities.length,"count-color-class":"bg-purple-100 text-purple-700","show-add-button":"","add-button-label":"Add Opportunity","add-button-color-class":"text-purple-600 hover:text-purple-700","has-empty-state":d.opportunities.length===0,"empty-state-message":"No opportunities associated with this customer",onAdd:t[0]||(t[0]=l=>s.$emit("add-opportunity"))},{content:O(()=>[e("div",tt,[(r(!0),i(j,null,U(d.opportunities,l=>(r(),i("div",{key:l.id,class:"flex flex-col p-3 bg-surfaceSecondary hover:bg-surfaceSecondary border border-E5E7EB rounded-lg cursor-pointer transition-colors",onClick:f=>x(l)},[e("div",at,[e("div",ot,[e("div",nt,[e("span",rt,"Opportunity #"+c(l.id),1),e("span",{class:F(["text-xs px-2 py-0.5 rounded-full font-medium",S(l.stage)])},c(l.displayStage||l.stage),3)]),e("div",lt,[l.assignee?(r(),i("span",it,c(l.assignee),1)):w("",!0),l.value?(r(),i("span",dt,"€ "+c(b(l.value)),1)):w("",!0),l.vehicle?(r(),i("span",ut,c(l.vehicle.brand)+" "+c(l.vehicle.model),1)):w("",!0)])]),t[1]||(t[1]=e("i",{class:"fa-solid fa-external-link text-gray-400 text-xs ml-2"},null,-1))]),o(l).length>0?(r(),i("div",ct,[(r(!0),i(j,null,U(o(l),f=>(r(),i("div",{key:f.id,class:"flex items-center justify-between p-2 bg-surface border border-E5E7EB rounded-md shadow-sm"},[e("div",pt,[e("span",{class:F(["text-xs px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider",h(f.type)])},c(f.type),3),e("span",mt,c(f.description),1)]),t[2]||(t[2]=e("i",{class:"fa-solid fa-chevron-right text-xs text-gray-300"},null,-1))]))),128))])):w("",!0)],8,st))),128))])]),_:1},8,["count","has-empty-state"]))}},bt={key:0,class:"mb-8"},yt={class:"relative"},vt={class:"flex overflow-x-auto space-x-4 pb-4 scrollbar-hide scroll-smooth snap-x snap-mandatory",style:{"scrollbar-width":"thin"}},gt=["onClick"],ht={class:"w-full h-36 bg-surfaceTertiary flex items-center justify-center overflow-hidden"},xt=["src"],wt={key:1,class:"fa-solid fa-car text-4xl text-sub"},kt={class:"p-6"},_t={class:"font-bold text-heading text-sm mb-1"},Ct={key:0,class:"text-xs text-sub mb-2"},$t={key:1,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-green-50 border border-green-100 text-green-700 text-xs font-semibold rounded-md mb-2"},At={__name:"VehiclesCarousel",props:{cars:{type:Array,default:()=>[]}},emits:["car-click"],setup(d,{emit:y}){const m=y,p=T(!1),o=x=>new Intl.NumberFormat("en-US").format(x),h=x=>({requested:"Requested",offered:"Offered",drove:"Drove",purchased:"Purchased"})[x]||"Car",b=x=>({requested:"bg-blue-600",offered:"bg-purple-600",drove:"bg-green-600",purchased:"bg-teal-600"})[x]||"bg-gray-600",S=x=>{m("car-click",x),p.value=!0};return(x,s)=>d.cars.length>0?(r(),i("div",bt,[s[2]||(s[2]=e("div",{class:"flex items-center gap-2 mb-4"},[e("i",{class:"fa-solid fa-thumbtack text-sub text-xs"}),e("h3",{class:"font-bold text-heading text-sm"},"Cars")],-1)),e("div",yt,[e("div",vt,[(r(!0),i(j,null,U(d.cars,(t,l)=>(r(),i("div",{key:t.id,class:"flex-none w-64 snap-start bg-surface border border-E5E7EB rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow cursor-pointer relative",onClick:f=>S(t)},[e("div",{class:F(["absolute top-2 right-2 z-10 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm",b(t.type)])},c(h(t.type)),3),e("div",ht,[t.image?(r(),i("img",{key:0,src:t.image,alt:"Car",class:"w-full h-full object-cover"},null,8,xt)):(r(),i("i",wt))]),e("div",kt,[e("h4",_t,c(t.brand)+" "+c(t.model)+" ("+c(t.year)+")",1),t.price?(r(),i("p",Ct,"€ "+c(o(t.price)),1)):w("",!0),t.stockDays!==null&&t.stockDays!==void 0?(r(),i("div",$t,[s[1]||(s[1]=e("div",{class:"w-1 h-1 bg-green-500 rounded-full"},null,-1)),V(" In stock ("+c(t.stockDays)+" days) ",1)])):w("",!0)])],8,gt))),128))])]),A(we,{show:p.value,title:"Car Details",onClose:s[0]||(s[0]=t=>p.value=!1)},null,8,["show"])])):w("",!0)}},St=re(At,[["__scopeId","data-v-b4e6eb55"]]),Et={__name:"AddLeadOpportunityModal",props:{show:{type:Boolean,default:!1},type:{type:String,required:!0},contact:{type:Object,required:!0}},emits:["close","save"],setup(d,{emit:y}){const m=d,p=y,o=T(null),h=C(()=>m.type==="lead"?"Add New Lead":"Add New Opportunity"),b=C(()=>`Create a ${m.type} for ${m.contact.name}`),S=s=>{s||p("close")},x=s=>{p("save",s)};return(s,t)=>(r(),q(L(Le),{open:d.show,"onUpdate:open":S},{default:O(()=>[A(L($e),null,{default:O(()=>[A(L(Ae),{class:"fixed inset-0 z-50 bg-black/50"}),A(L(Se),{class:"w-full sm:max-w-lg"},{default:O(()=>[A(L(Ee),null,{default:O(()=>[A(L(Te),null,{default:O(()=>[V(c(h.value),1)]),_:1}),A(L(De),null,{default:O(()=>[V(c(b.value),1)]),_:1})]),_:1}),A(Oe,{ref_key:"formRef",ref:o,"initial-contact":d.contact,"hide-contact-selection":!0,"force-type":d.type,onSubmit:x},null,8,["initial-contact","force-type"]),A(L(Be),{class:"flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:O(()=>{var l,f,k,E;return[A(L(X),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:t[0]||(t[0]=_=>s.$emit("close"))}),A(L(X),{label:(l=o.value)!=null&&l.isSubmitting?"Saving...":"Save",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:((f=o.value)==null?void 0:f.isSubmitting)||!((k=o.value)!=null&&k.canSubmit),onClick:(E=o.value)==null?void 0:E.submit},null,8,["label","disabled","onClick"])]}),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Tt={class:"bg-surface border border-E5E7EB p-6 mb-6"},Dt={class:"flex items-start gap-3 mb-4"},Bt={class:"flex-1"},Lt={key:0,class:"text-sm text-body leading-relaxed whitespace-pre-line"},Ot={key:1,class:"text-meta italic"},Ft={key:0,class:"flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-100"},It={__name:"CustomerSummaryWidget",props:{summary:{type:String,default:null},preferences:{type:Array,default:()=>[]},customerData:{type:Object,default:null}},setup(d){const y=d,m=C(()=>{if(y.preferences&&y.preferences.length>0)return y.preferences;const p=[],o=y.customerData;if(!o)return p;if(o.preferredVehicleType&&p.push({icon:"fa-solid fa-car",label:`Prefers ${o.preferredVehicleType}s`}),o.preferredChannel){const h={whatsapp:"fa-brands fa-whatsapp",phone:"fa-solid fa-phone",email:"fa-solid fa-envelope",sms:"fa-solid fa-message"};p.push({icon:h[o.preferredChannel.toLowerCase()]||"fa-solid fa-comment",label:`Prefers ${o.preferredChannel}`})}return o.preferredContactTime&&p.push({icon:"fa-solid fa-clock",label:o.preferredContactTime}),o.budgetRange&&p.push({icon:"fa-solid fa-dollar-sign",label:o.budgetRange}),p});return(p,o)=>(r(),i("div",Tt,[e("div",Dt,[o[1]||(o[1]=e("div",{class:"flex-shrink-0 mt-1"},[e("i",{class:"fa-solid fa-lightbulb text-2xl text-amber-500"})],-1)),e("div",Bt,[o[0]||(o[0]=e("h3",{class:"text-lg font-semibold text-heading mb-2"},"Customer Insights",-1)),d.summary?(r(),i("p",Lt,c(d.summary),1)):(r(),i("p",Ot," No customer insights available yet. Insights will appear as we learn more about this customer's preferences and behavior. "))])]),m.value&&m.value.length>0?(r(),i("div",Ft,[(r(!0),i(j,null,U(m.value,(h,b)=>(r(),i("span",{key:b,class:"inline-flex items-center gap-1.5 px-3 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-full"},[e("i",{class:F([h.icon,"text-xs"])},null,2),V(" "+c(h.label),1)]))),128))])):w("",!0)]))}},Nt={class:"bg-surface border border-E5E7EB rounded-card p-6 mb-6"},qt={class:"space-y-4"},jt={key:0,class:"flex items-start justify-between gap-4 p-4 bg-surfaceSecondary rounded-lg border border-E5E7EB"},Ut={class:"flex items-start gap-3 flex-1 min-w-0"},Mt={class:"flex-1 min-w-0"},Rt={class:"text-sm text-body"},Vt={class:"text-xs text-sub mt-1"},Wt={key:1,class:"flex items-start justify-between gap-4 p-4 bg-surfaceSecondary rounded-lg border border-E5E7EB"},zt={class:"flex items-start gap-3 flex-1 min-w-0"},Pt={class:"w-10 h-10 rounded bg-brand-slate/10 flex items-center justify-center shrink-0"},Qt={class:"flex-1 min-w-0"},Yt={class:"text-sm text-body line-clamp-2"},Ht={class:"text-xs text-sub mt-1"},Kt={key:2,class:"flex items-start justify-between gap-4 p-4 bg-surfaceSecondary rounded-lg border border-E5E7EB"},Zt={class:"flex items-start gap-3 flex-1 min-w-0"},Gt={class:"flex-1 min-w-0"},Jt={class:"text-sm text-body"},Xt={class:"text-xs text-sub mt-1"},es={key:3,class:"flex items-start justify-between gap-4 p-4 bg-surfaceSecondary rounded-lg border border-E5E7EB"},ts={class:"flex items-start gap-3 flex-1 min-w-0"},ss={class:"flex-1 min-w-0"},as={class:"text-sm text-body"},os={class:"text-xs text-sub mt-1"},ns={key:4,class:"text-center py-8 text-sub"},rs={__name:"RecentActivitiesWidget",props:{nextAppointment:{type:Object,default:null},activities:{type:Array,default:()=>[]},leads:{type:Array,default:()=>[]},opportunities:{type:Array,default:()=>[]},customerId:{type:[Number,String],default:null}},setup(d){const y=d,m=H(),p=C(()=>{const a=["email","sms","whatsapp","call"],n=y.activities.filter(g=>a.includes(g.type)).sort((g,D)=>new Date(D.timestamp)-new Date(g.timestamp));return n.length>0?n[0]:null}),o=C(()=>{const a=y.leads.filter(n=>{var g;return!n.isDisqualified&&n.status!=="Disqualified"&&!((g=n.stage)!=null&&g.includes("Closed"))});return a.length>0?a[0]:null}),h=C(()=>{if(!o.value)return null;try{return ke({lead:o.value,displayStage:o.value.stage})}catch(a){return console.error("Error getting lead next action:",a),null}}),b=C(()=>{const a=y.opportunities.filter(n=>n.stage!=="Closed Won"&&n.stage!=="Closed Lost");return a.length>0?a[0]:null}),S=C(()=>{if(!b.value)return null;try{const a=y.activities.filter(g=>g.opportunityId===b.value.id)||[];return _e(b.value.stage,{opportunity:b.value,scheduledAppointment:b.value.scheduledAppointment||null,activities:a,hasOffers:a.some(g=>g.type==="offer")||!1,stage:b.value.stage,deliverySubstatus:b.value.deliverySubstatus||null,formatDateTime:g=>g?new Date(g).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):""})}catch(a){return console.error("Error getting opportunity next action:",a),null}}),x=a=>({email:"fa-solid fa-envelope",sms:"fa-solid fa-message",whatsapp:"fa-brands fa-whatsapp",call:"fa-solid fa-phone"})[a]||"fa-solid fa-comment",s=a=>a.type==="call"?a.content||`Call with ${a.user||"customer"}`:a.type==="email"?a.subject||a.content||"Email communication":a.type==="sms"||a.type==="whatsapp"?a.content||`${a.type.toUpperCase()} message`:a.content||"Communication",t=a=>{if(!a)return"";const n=new Date(a),g=new Date,D=Math.abs(g-n),$=Math.ceil(D/(1e3*60*60*24));return $===1?"Today":$===2?"Yesterday":$<=7?`${$-1} days ago`:n.toLocaleDateString("en-US",{month:"short",day:"numeric",year:n.getFullYear()!==g.getFullYear()?"numeric":void 0})},l=a=>{if(!a)return"";const n=new Date(a),g=new Date;if(n.toDateString()===g.toDateString())return`Today at ${n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}`;const $=new Date(g);return $.setDate($.getDate()+1),n.toDateString()===$.toDateString()?`Tomorrow at ${n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}`:n.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},f=()=>{var a,n;(a=y.nextAppointment)!=null&&a.opportunityId?m.push({path:`/tasks/${y.nextAppointment.opportunityId}`,query:{type:"opportunity"}}):(n=y.nextAppointment)!=null&&n.leadId?m.push({path:`/tasks/${y.nextAppointment.leadId}`,query:{type:"lead"}}):m.push({path:"/calendar"})},k=()=>{var a,n;(a=p.value)!=null&&a.opportunityId?m.push({path:`/tasks/${p.value.opportunityId}`,query:{type:"opportunity"}}):(n=p.value)!=null&&n.leadId&&m.push({path:`/tasks/${p.value.leadId}`,query:{type:"lead"}})},E=()=>{var a;(a=o.value)!=null&&a.id&&m.push({path:`/tasks/${o.value.id}`,query:{type:"lead"}})},_=()=>{var a;(a=b.value)!=null&&a.id&&m.push({path:`/tasks/${b.value.id}`,query:{type:"opportunity"}})};return(a,n)=>{var g,D,$,M,W,z;return r(),i("div",Nt,[n[8]||(n[8]=e("h3",{class:"text-h3-card text-heading mb-4"},"Recent Activities",-1)),e("div",qt,[d.nextAppointment?(r(),i("div",jt,[e("div",Ut,[n[1]||(n[1]=e("div",{class:"w-10 h-10 rounded bg-brand-blue/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-calendar-check text-brand-blue text-lg"})],-1)),e("div",Mt,[n[0]||(n[0]=e("div",{class:"text-sm font-semibold text-heading mb-1"},"Next Appointment",-1)),e("div",Rt,c(l(d.nextAppointment.start)),1),e("div",Vt,c(d.nextAppointment.title||"Appointment"),1)])]),e("button",{onClick:f,class:"px-4 py-2 bg-brand-red text-white rounded-btn hover:brightness-90 transition-all shrink-0 text-sm font-medium"}," View Details ")])):w("",!0),p.value?(r(),i("div",Wt,[e("div",zt,[e("div",Pt,[e("i",{class:F([x(p.value.type),"text-brand-slate text-lg"])},null,2)]),e("div",Qt,[n[2]||(n[2]=e("div",{class:"text-sm font-semibold text-heading mb-1"},"Last Communication",-1)),e("div",Yt,c(s(p.value)),1),e("div",Ht,c(t(p.value.timestamp)),1)])]),e("button",{onClick:k,class:"px-4 py-2 bg-brand-red text-white rounded-btn hover:brightness-90 transition-all shrink-0 text-sm font-medium"}," View Details ")])):w("",!0),o.value?(r(),i("div",Kt,[e("div",Zt,[n[4]||(n[4]=e("div",{class:"w-10 h-10 rounded bg-brand-red/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-user-clock text-brand-red text-lg"})],-1)),e("div",Gt,[n[3]||(n[3]=e("div",{class:"text-sm font-semibold text-heading mb-1"},"Active Lead Request",-1)),e("div",Jt,c(((g=h.value)==null?void 0:g.label)||"No action defined"),1),e("div",Xt,c((D=o.value.requestedCar)==null?void 0:D.brand)+" "+c(($=o.value.requestedCar)==null?void 0:$.model),1)])]),e("button",{onClick:E,class:"px-4 py-2 bg-brand-red text-white rounded-btn hover:brightness-90 transition-all shrink-0 text-sm font-medium"}," View Details ")])):w("",!0),b.value?(r(),i("div",es,[e("div",ts,[n[6]||(n[6]=e("div",{class:"w-10 h-10 rounded bg-brand-blue/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-handshake text-brand-blue text-lg"})],-1)),e("div",ss,[n[5]||(n[5]=e("div",{class:"text-sm font-semibold text-heading mb-1"},"Active Opportunity",-1)),e("div",as,c(((M=S.value)==null?void 0:M.label)||"No action defined"),1),e("div",os,c((W=b.value.vehicle)==null?void 0:W.brand)+" "+c((z=b.value.vehicle)==null?void 0:z.model)+" - "+c(b.value.stage),1)])]),e("button",{onClick:_,class:"px-4 py-2 bg-brand-red text-white rounded-btn hover:brightness-90 transition-all shrink-0 text-sm font-medium"}," View Details ")])):w("",!0),!d.nextAppointment&&!p.value&&!o.value&&!b.value?(r(),i("div",ns,[...n[7]||(n[7]=[e("i",{class:"fa-solid fa-inbox text-3xl mb-2 opacity-50"},null,-1),e("p",{class:"text-sm"},"No recent activities available",-1)])])):w("",!0)])])}}},ls={class:"h-full flex flex-col overflow-hidden bg-surface"},is={key:0,class:"flex-1 flex items-center justify-center"},ds={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},hs={__name:"Customer",setup(d){const y=ie(),m=H();le(),fe();const p=be(),o=T(!1),h=T(null),b=T(null),S=T([]),x=T([]),s=T([]),t=T([]),l=T([]),f=T(null),k=C(()=>parseInt(y.params.id)),E=C(()=>"contact"),_=C(()=>{const u=b.value||p.currentCustomer;return u?{...u,id:u.id,type:"contact",customer:{id:u.id,name:u.name,email:u.email,phone:u.phone,address:u.address||"",initials:u.initials},source:u.source||"Direct",tags:u.tags||[],stage:"Contact",assignee:null,assigneeId:null}:null}),a=C(()=>null),n=C(()=>({currentActivities:C(()=>[]),addActivity:async()=>{},updateActivity:async()=>{},deleteActivity:async()=>{}})),g=C(()=>({overviewActions:[],tabActions:["note","email","sms","whatsapp","attachment"]})),D=async(u=null)=>{const v=u||k.value;if(v)try{const B=y.query.type==="account"?"account":"contact",[Q,Y,K,ae,oe]=await Promise.all([p.fetchCustomerById(v,B),ye(v),ve(v),ge(v),he(v)]);b.value=Q||p.currentCustomer,S.value=Y.data||[],x.value=K.data||[],s.value=ae.data||[],t.value=oe.data||[];const Z=[];for(const I of S.value)try{const N=await ce(I.id);Z.push(...N)}catch(N){console.error(`Failed to load activities for lead ${I.id}:`,N)}for(const I of x.value)try{const N=await pe(I.id);Z.push(...N)}catch(N){console.error(`Failed to load activities for opportunity ${I.id}:`,N)}l.value=Z;try{f.value=await me(v)}catch(I){console.error("Failed to load next appointment:",I),f.value=null}}catch(B){console.error("Error loading customer data:",B)}},$=async()=>{if(!k.value){h.value="No task ID provided";return}o.value=!0,h.value=null;try{await D()}catch(u){h.value=u.message||"Failed to load task",console.error("Error loading task:",u)}finally{o.value=!1}},M=async u=>{var v;try{const B=((v=_.value)==null?void 0:v.type)==="contact"?"contact":"account";await p.addRequestedCar(k.value,u),await $()}catch(B){console.error("Error adding car to customer:",B),h.value=B.message||"Failed to add car"}},W=async()=>{try{o.value=!0;const u=await p.convertToLead(k.value);m.push({path:`/tasks/${u.id}`,query:{type:"lead"}})}catch(u){console.error("Error converting to lead:",u),h.value=u.message||"Failed to convert to lead",o.value=!1}},z=async()=>{try{o.value=!0;const u=await p.convertToOpportunity(k.value);m.push({path:`/tasks/${u.id}`,query:{type:"opportunity"}})}catch(u){console.error("Error converting to opportunity:",u),h.value=u.message||"Failed to convert to opportunity",o.value=!1}},P=T(!1),R=T("lead"),te=C(()=>{if(!_.value)return{id:null,name:"Unknown",email:"",phone:"",initials:"?"};const u=_.value;return{id:u.id,name:u.name||"Unknown",email:u.email||"",phone:u.phone||"",initials:u.initials||"?"}}),J=u=>{R.value=u,P.value=!0},se=async u=>{try{o.value=!0,P.value=!1;const v=k.value;if(!v)throw new Error("Customer ID not found");R.value==="lead"?await p.convertToLead(v):await p.convertToOpportunity(v),await D(v),o.value=!1}catch(v){console.error(`Error adding ${R.value}:`,v),h.value=v.message||`Failed to add ${R.value}`,o.value=!1}};return de(async()=>{await $()}),ue(()=>y.params.id,u=>{u&&$()}),(u,v)=>(r(),i("div",ls,[o.value||!_.value||_.value&&_.value.id!==k.value?(r(),i("div",is,[...v[3]||(v[3]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1)])])):(r(),q(Ce,{key:1,task:_.value,type:E.value,"management-widget":a.value,"store-adapter":n.value,"add-new-config":g.value,onCarAdded:M,onConvertToLead:W,onConvertToOpportunity:z},{"pinned-extra":O(({task:B})=>{var Q,Y;return[A(It,{summary:B.summary||((Q=b.value)==null?void 0:Q.summary),preferences:B.preferences||((Y=b.value)==null?void 0:Y.preferences),"customer-data":b.value},null,8,["summary","preferences","customer-data"]),A(rs,{"next-appointment":f.value,activities:l.value,leads:S.value,opportunities:x.value,"customer-id":k.value},null,8,["next-appointment","activities","leads","opportunities","customer-id"]),t.value.length>0?(r(),q(St,{key:0,cars:t.value},null,8,["cars"])):w("",!0),e("div",ds,[A(et,{leads:S.value,"all-tasks":s.value,onAddLead:v[0]||(v[0]=K=>J("lead"))},null,8,["leads","all-tasks"]),A(ft,{opportunities:x.value,"all-tasks":s.value,activities:l.value,onAddOpportunity:v[1]||(v[1]=K=>J("opportunity"))},null,8,["opportunities","all-tasks","activities"])])]}),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])),_.value?(r(),q(Et,{key:2,show:P.value,type:R.value,contact:te.value,onClose:v[2]||(v[2]=B=>P.value=!1),onSave:se},null,8,["show","type","contact"])):w("",!0)]))}};export{hs as default};
