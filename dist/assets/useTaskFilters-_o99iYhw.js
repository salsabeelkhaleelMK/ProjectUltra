const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/contacts-CvrS-If3.js","assets/index-BSxt259F.js","assets/index-jg_8NBCO.css","assets/users-i2L6lO-2.js"])))=>i.map(i=>d[i]);
import{n as ee,b as gl,Z as En,X as jn,a as yl,i as hl,k as bl,l as xl,u as wl,m as kl,f as $s,F as Ds,L as As,g as Ts,h as Os,Q as H,C as Is,d as Vs,p as Yt,W as At,U as Tt,H as Ot,j as fe,G as It,q as Be,c as tt,o as dt,$ as Sl}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-CK4ymTFf.js";import{H as Ct,K as Qt,c as w,d as k,o as f,e,g as q,t as I,n as ae,s,x as re,B as o,y as t,Y as Yn,I as Et,M as Cl,Z as Vn,U as Nn,r as T,C as Jt,j as Hn,T as On,O as St,F as Le,P as Ln,$ as Gs,h as Qn,u as Vt,V as Qs,k as C,a0 as Ns,p as lt,N as Jn,i as Je,a1 as $l,q as Dl,l as Ce,a2 as bt,a3 as Al,a4 as Tl,a5 as Cs,G as Mt,a6 as In,a7 as Ol,_ as ns,w as Mn,m as Ls,L as Il,a8 as Js}from"./index-BSxt259F.js";import{u as qt}from"./opportunities-C7VMVq_4.js";import{E as Vl,_ as Nl,T as Ll,h as Gn,i as Ml,j as ql,k as Ul,l as _l,m as qn,P as Zn,n as Kn,o as Fl,p as Rl,q as El,r as jl,s as Wl,t as Bl,u as Pl,v as zl,e as Wn,b as zt,w as Ss,x as Yl,g as Hl,c as Ql,f as Jl,y as Gl,z as Zl,A as Kl,B as Xl,C as ea,D as ta,F as Zs,G as sa}from"./opportunityRules-DVPgyxsv.js";import{_ as Xn}from"./CreateEventModal-DQDakbY_.js";import{_ as el}from"./ReassignUserModal-8Wfd_b4T.js";import{u as Ut,c as An}from"./users-i2L6lO-2.js";import{S as st}from"./components-WJKgpbNX.js";import{S as na}from"./sparkles-ByigpcXa.js";import{f as la}from"./vehicles-sZbJG44U.js";import{_ as aa,a as oa}from"./EditEventModal-_ABol0cZ.js";/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bn=Ct("AlertCircleIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ia=Ct("CarIcon",[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pn=Ct("CheckIcon",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ra=Ct("ChevronLeftIcon",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ua=Ct("ChevronRightIcon",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const da=Ct("InfoIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ca=Ct("MoreVerticalIcon",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ma=Ct("PhoneOffIcon",[["path",{d:"M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91",key:"z86iuo"}],["line",{x1:"22",x2:"2",y1:"2",y2:"22",key:"11kh81"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=Ct("RotateCcwIcon",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=Ct("ThumbsDownIcon",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z",key:"s6e0r"}]]);/**
 * @license lucide-vue-next v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const va=Ct("ZapIcon",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]),ga={class:"border-b border-border bg-white px-6 h-16 min-h-16 shrink-0"},ya={class:"flex items-center justify-between gap-4 w-full h-full"},ha={class:"flex flex-col min-w-0"},ba={class:"flex items-center gap-2 min-w-0"},xa={key:0,class:"text-lg font-medium text-foreground truncate"},wa={key:1,class:"text-lg font-medium text-foreground"},ka={key:2,class:"flex items-center gap-1.5 shrink-0"},Sa={key:0,class:"px-1.5 py-0.5 rounded text-xs font-bold uppercase bg-red-50 text-red-700 border border-red-200 leading-none"},Ca={key:0,class:"text-sm text-muted-foreground truncate leading-normal mt-0.5"},$a={key:1,class:"text-sm text-muted-foreground"},Da={class:"flex items-center gap-2 shrink-0"},Aa={__name:"TaskDetailHeader",props:{task:{type:Object,default:null},filteredTasks:{type:Array,default:()=>[]},isDrawerView:{type:Boolean,default:!1}},emits:["previous","next","close"],setup(l){const L=l,r=w(()=>!L.task||!L.filteredTasks.length?!1:L.filteredTasks.findIndex(h=>{const y=L.task.compositeId||L.task.id;return(h.compositeId||h.id)===y})>0),p=w(()=>{if(!L.task||!L.filteredTasks.length)return!1;const m=L.filteredTasks.findIndex(h=>{const y=L.task.compositeId||L.task.id;return(h.compositeId||h.id)===y});return m>=0&&m<L.filteredTasks.length-1}),u=m=>m?m.type==="lead"?"Lead Qualification Task":m.type==="opportunity"?"Opportunity Management Task":"Task Details":"No task selected",d=m=>{var y;if(!m)return"";const h=[];if(m.vehicle||m.requestedCar){const v=m.vehicle||m.requestedCar;v.brand&&v.model?h.push(`${v.brand} ${v.model} (${v.year||"N/A"})`):v.model&&h.push(`${v.model} (${v.year||"N/A"})`)}return m.source&&h.push(m.source),(y=m.customer)!=null&&y.name?h.push(m.customer.name):m.customerName&&h.push(m.customerName),h.join(" • ")},x=m=>{if(!m)return"";if(m.type==="opportunity"){const h=S(m)||m.stage||m.currentStage||"New";b(m);const y=i(m);return y&&y!==h?y:h}return m.stage||m.currentStage||m.displayStage||"New"},b=m=>m?m.stage||m.currentStage||"New":"",S=m=>{if(!m||m.type!=="opportunity")return null;try{return Et(m,"opportunity")}catch{return m.displayStage||m.stage||null}},i=m=>{if(!m||m.type!=="opportunity")return"";const h=b(m),y=S(m);if(!y||!h)return y||"";const v=h.toLowerCase().trim();if(y.toLowerCase().trim().startsWith(v+" - ")){const g=h+" - ";if(y.startsWith(g))return y.substring(g.length)}return y},$=m=>{if(!m)return"bg-gray-50 text-gray-700 border-gray-200";if(m.type==="opportunity"){const y=S(m)||b(m);return D(y,"opportunity")}const h=x(m).toLowerCase();return h.includes("new")?"bg-blue-50 text-blue-600 border-blue-200":h.includes("qualif")?"bg-green-50 text-green-600 border-green-200":h.includes("negotiat")?"bg-purple-50 text-purple-600 border-purple-200":h.includes("close")?"bg-muted text-muted-foreground border-border":"bg-blue-50 text-blue-600 border-blue-200"},D=(m,h="opportunity")=>{if(!m)return"bg-gray-50 text-gray-700 border-gray-200";try{const y=Cl(m,h);return y.includes("blue")?y+" border-blue-200":y.includes("purple")?y+" border-purple-200":y.includes("yellow")?y+" border-yellow-200":y.includes("pink")?y+" border-pink-200":y.includes("indigo")?y+" border-indigo-200":y.includes("emerald")?y+" border-emerald-200":y.includes("green")?y+" border-green-200":y.includes("red")?y+" border-red-200":(y.includes("gray"),y+" border-gray-200")}catch{const v=m.toLowerCase();return v.includes("new")?"bg-blue-50 text-blue-600 border-blue-200":v.includes("qualif")?"bg-green-50 text-green-600 border-green-200":v.includes("negotiat")?"bg-purple-50 text-purple-600 border-purple-200":v.includes("close")?"bg-muted text-muted-foreground border-border":"bg-gray-50 text-gray-700 border-gray-200"}};return(m,h)=>(f(),k("div",ga,[e("div",ya,[e("div",ha,[e("div",ba,[l.task?(f(),k("h2",xa,I(u(l.task)),1)):(f(),k("h2",wa," No task selected ")),l.task?(f(),k("div",ka,[e("span",{class:ae(["px-1.5 py-0.5 rounded text-xs font-bold uppercase border leading-none",l.task.type==="lead"?"bg-blue-50 text-blue-700 border-blue-200":"bg-purple-50 text-purple-700 border-purple-200"])},I(l.task.type==="lead"?"Lead":"Opportunity"),3),e("span",{class:ae(["px-1.5 py-0.5 rounded text-xs font-bold uppercase border leading-none",$(l.task)])},I(x(l.task)),3),l.task.priority==="Hot"?(f(),k("span",Sa," Hot ")):q("",!0)])):q("",!0)]),l.task?(f(),k("p",Ca,I(d(l.task)),1)):(f(),k("p",$a," Select a task to view details "))]),e("div",Da,[s(t(ee),{variant:"secondary",size:"icon",onClick:h[0]||(h[0]=y=>m.$emit("previous")),disabled:!r.value},{default:o(()=>[s(t(ra),{size:16,class:"text-muted-foreground"})]),_:1},8,["disabled"]),s(t(ee),{variant:"secondary",size:"icon",onClick:h[1]||(h[1]=y=>m.$emit("next")),disabled:!p.value},{default:o(()=>[s(t(ua),{size:16,class:"text-muted-foreground"})]),_:1},8,["disabled"]),l.isDrawerView?(f(),re(t(ee),{key:0,variant:"secondary",size:"icon",onClick:h[2]||(h[2]=y=>m.$emit("close")),class:"ml-1"},{default:o(()=>[s(t(Yn),{size:16,class:"text-muted-foreground"})]),_:1})):q("",!0)])])]))}},Ta=Qt(Aa,[["__scopeId","data-v-d6cc3389"]]),Oa=Object.assign({inheritAttrs:!1},{__name:"TaskManagementCard",props:{task:{type:Object,required:!0},type:{type:String,required:!0,validator:l=>["lead","opportunity"].includes(l)},managementWidget:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},setup(l){return(L,r)=>(f(),k("div",null,[l.managementWidget?(f(),re(Nn(l.managementWidget),Vn({key:0,lead:l.type==="lead"?l.task:void 0,opportunity:l.type==="opportunity"?l.task:void 0,activities:l.activities},L.$attrs),null,16,["lead","opportunity","activities"])):q("",!0)]))}}),Ia=Qt(Oa,[["__scopeId","data-v-f5db9491"]]),Va={class:"overflow-hidden p-4 rounded-lg bg-white shadow-nsc-card"},Na={class:"flex gap-4"},La={class:"w-24 shrink-0 aspect-3/2 rounded-lg overflow-hidden bg-surfaceTertiary"},Ma=["src","alt"],qa={key:1,class:"w-full h-full flex items-center justify-center"},Ua={class:"min-w-0 flex-1 flex flex-col justify-center"},_a={class:"text-sm font-semibold text-foreground truncate"},Fa={key:0,class:"flex items-center gap-2 mt-1 text-sm text-foreground flex-wrap"},Ra={key:0,class:"font-semibold"},Ea={key:1,class:"h-3 w-px bg-border shrink-0","aria-hidden":"true"},ja={key:2,class:"text-muted-foreground truncate"},Wa={key:1,class:"flex gap-3 mt-0.5 text-xs text-muted-foreground"},Ba={key:0},Pa={key:1},za={key:0,class:"rounded-lg p-3 mt-3 bg-muted"},Ya={class:"text-sm text-foreground"},Ha={class:"flex gap-2 pt-3 mt-3 border-t border-border"},Qa={__name:"VehicleRequestCard",props:{vehicle:{type:Object,required:!0},requestMessage:{type:String,default:""},source:{type:String,default:""},imageUrl:{type:String,default:""}},emits:["open-ad","more-actions"],setup(l){const L=l,r=T(!1),p=w(()=>{const S=[];return L.vehicle.brand&&S.push(L.vehicle.brand),L.vehicle.model&&S.push(L.vehicle.model),L.vehicle.variant&&S.push(L.vehicle.variant),S.join(" ")||"Vehicle Details"}),u=w(()=>{const S=p.value;return L.vehicle.year?`${S} (${L.vehicle.year})`:S}),d=S=>{if(!S)return"0";const i=typeof S=="string"?parseFloat(S):S;return new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).format(i)},x=S=>{if(!S)return"0";const i=typeof S=="string"?parseFloat(S):S;return new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).format(i)},b=()=>{r.value=!0};return(S,i)=>(f(),k("div",Va,[i[4]||(i[4]=e("h3",{class:"text-base font-medium text-foreground leading-6 mb-4"},"Requested Car",-1)),e("div",Na,[e("div",La,[l.imageUrl&&!r.value?(f(),k("img",{key:0,src:l.imageUrl,alt:`${l.vehicle.brand} ${l.vehicle.model}`,class:"w-full h-full object-cover",onError:b},null,40,Ma)):(f(),k("div",qa,[s(t(ia),{size:32,class:"text-muted-foreground"})]))]),e("div",Ua,[e("p",_a,I(u.value),1),l.vehicle.price||l.source?(f(),k("div",Fa,[l.vehicle.price?(f(),k("span",Ra," €"+I(d(l.vehicle.price)),1)):q("",!0),l.vehicle.price&&l.source?(f(),k("span",Ea)):q("",!0),l.source?(f(),k("span",ja,I(l.source),1)):q("",!0)])):q("",!0),l.vehicle.mileage||l.vehicle.fuelType?(f(),k("div",Wa,[l.vehicle.mileage?(f(),k("span",Ba,I(x(l.vehicle.mileage))+" km",1)):q("",!0),l.vehicle.fuelType?(f(),k("span",Pa,I(l.vehicle.fuelType),1)):q("",!0)])):q("",!0)])]),l.requestMessage?(f(),k("div",za,[i[2]||(i[2]=e("p",{class:"text-xs text-muted-foreground mb-0.5"},"Request message",-1)),e("p",Ya,I(l.requestMessage),1)])):q("",!0),e("div",Ha,[s(t(ee),{variant:"secondary",size:"sm",class:"flex-1",onClick:i[0]||(i[0]=$=>S.$emit("open-ad"))},{default:o(()=>[s(t(Vl),{size:16}),i[3]||(i[3]=e("span",null,"Open Ad",-1))]),_:1}),s(t(ee),{variant:"secondary",size:"icon-sm",onClick:i[1]||(i[1]=$=>S.$emit("more-actions"))},{default:o(()=>[s(t(ca),{size:16})]),_:1})])]))}},Ja={class:"relative flex-1 flex flex-col min-h-0 min-w-0 overflow-hidden"},Ga={key:0,class:"flex flex-col flex-1 min-h-0 min-w-0 overflow-hidden"},Za={class:"flex flex-1 min-h-0 overflow-hidden"},Ka={class:"flex-1 flex flex-col min-h-0 overflow-hidden bg-white min-w-0"},Xa={class:"flex-1 min-h-0 overflow-y-auto"},eo={class:"p-2"},to={class:"right-sidebar flex flex-col min-h-0 overflow-hidden shrink-0 border-l border-border bg-surface"},so={key:1,class:"absolute bottom-0 left-0 right-0 h-[2px] bg-primary z-10"},no={key:1,class:"absolute bottom-0 left-0 right-0 h-[2px] bg-primary z-10"},lo={class:"flex-1 min-h-0 flex flex-col overflow-y-auto bg-muted"},ao={key:1,class:"flex-1 flex items-center justify-center bg-surface"},oo={__name:"TaskDetailView",props:{task:{type:Object,default:null},managementWidget:{type:Object,required:!0},storeAdapter:{type:Object,required:!0},addNewConfig:{type:Object,required:!0},filteredTasks:{type:Array,default:()=>[]},isDrawerView:{type:Boolean,default:!1}},emits:["task-navigate","close"],setup(l,{emit:L}){const r=l,p=L,u=Jt(),d=qt(),x=T("request"),b=T({}),S=T(!1),i=T(!1),$=T(!1),D=T(!1),m=T(!1),h=T(!1),y=T(!1),v=T(!1),A=T(!1),g=T(!1),M=w(()=>{var z;return((z=r.storeAdapter.currentActivities)==null?void 0:z.value)||[]}),B=w(()=>M.value.length),R=w(()=>{var _e;if(!((_e=r.task)!=null&&_e.customer))return 0;const z=r.task.customer.email,X=r.task.customer.phone,Xe=r.task.compositeId||`${r.task.type}-${r.task.id}`;return[...(u.leads||[]).map(Ve=>({...Ve,type:"lead",compositeId:`lead-${Ve.id}`})),...(d.opportunities||[]).map(Ve=>({...Ve,type:"opportunity",compositeId:`opportunity-${Ve.id}`}))].filter(Ve=>Ve.compositeId===Xe||!Ve.customer?!1:Ve.customer.email===z||Ve.customer.phone===X).length}),J=()=>{p("task-navigate","previous")},ce=()=>{p("task-navigate","next")},_=z=>{x.value!=="activity"&&(x.value="activity"),console.log("Activity clicked:",z)},V=z=>{b.value[z]=!b.value[z]},F=z=>z&&(z.image||z.imageUrl)||"",E=()=>{console.log("Open ad clicked")},Q=()=>{console.log("More actions clicked")},oe=z=>{console.log("Contact action:",z)},G=z=>{z==="note"?S.value=!0:z==="attachment"?i.value=!0:z==="whatsapp"?$.value=!0:z==="sms"?D.value=!0:z==="email"?m.value=!0:z==="call"?h.value=!0:z==="financing"?y.value=!0:z==="tradein"?v.value=!0:z==="purchase"?A.value=!0:z==="appointment"&&(g.value=!0)},$e=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"note",content:z.content||z.message,message:z.content||z.message,timestamp:new Date().toISOString()}),S.value=!1}catch(X){console.error("Error saving note:",X)}},qe=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"attachment",fileName:z.fileName,file:z.file,content:`Attachment: ${z.fileName}`,timestamp:new Date().toISOString()}),i.value=!1}catch(X){console.error("Error saving attachment:",X)}},me=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"whatsapp",message:z.message,content:z.message,template:z.template,timestamp:new Date().toISOString()}),$.value=!1}catch(X){console.error("Error saving WhatsApp:",X)}},se=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"sms",message:z.message,content:z.message,template:z.template,timestamp:new Date().toISOString()}),D.value=!1}catch(X){console.error("Error saving SMS:",X)}},ne=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"email",subject:z.subject,message:z.message,content:z.message,template:z.template,timestamp:new Date().toISOString()}),m.value=!1}catch(X){console.error("Error saving email:",X)}},ke=async z=>{var X;try{await r.storeAdapter.addActivity(r.task.id,{type:"financing",action:z.action||"added a financing proposal",content:z.content||`Financing: ${((X=z.data)==null?void 0:X.product)||"Unknown"}`,data:z.data,timestamp:new Date().toISOString()}),y.value=!1}catch(Xe){console.error("Error saving financing:",Xe)}},Ue=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"tradein",action:"added a trade-in",content:z.content||"Trade-in vehicle added",data:z.data,timestamp:new Date().toISOString()}),v.value=!1}catch(X){console.error("Error saving trade-in:",X)}},Me=async z=>{var X;try{await r.storeAdapter.addActivity(r.task.id,{type:"offer",action:z.action||"created an offer",content:z.content||`Offer: €${((X=z.data)==null?void 0:X.price)||0}`,data:z.data,timestamp:new Date().toISOString()}),A.value=!1}catch(Xe){console.error("Error saving offer:",Xe)}},ft=async z=>{try{await r.storeAdapter.addActivity(r.task.id,{type:"appointment",action:"scheduled an appointment",content:`Appointment: ${z.type||"Meeting"} on ${z.date||""}`,data:z,timestamp:new Date().toISOString()}),g.value=!1}catch(X){console.error("Error saving appointment:",X)}};return(z,X)=>{var Xe,at,Ge,_e,Ve,j,W,pe,K,P,te,ue,he;return f(),k("div",Ja,[l.task?(f(),k("div",Ga,[s(Ta,{task:l.task,"filtered-tasks":l.filteredTasks,"is-drawer-view":l.isDrawerView,onPrevious:J,onNext:ce,onClose:X[0]||(X[0]=ve=>z.$emit("close"))},null,8,["task","filtered-tasks","is-drawer-view"]),e("div",Za,[e("div",Ka,[e("div",Xa,[e("div",eo,[s(Ia,Vn({task:l.task,type:l.task.type,"management-widget":l.managementWidget,activities:M.value},z.$attrs),null,16,["task","type","management-widget","activities"])])])]),e("div",to,[s(t(yl),{modelValue:x.value,"onUpdate:modelValue":X[1]||(X[1]=ve=>x.value=ve),class:"flex flex-col flex-1 min-h-0 overflow-hidden"},{default:o(()=>[s(t(gl),{class:"flex shrink-0 border-b border-border bg-white rounded-none w-full relative h-full"},{default:o(()=>[s(t(En),{value:"request",class:ae(["flex items-center gap-2 text-sm font-medium transition-all relative flex-1 justify-center bg-transparent outline-none h-full",x.value==="request"?"text-foreground":"text-muted-foreground hover:text-muted-foreground"])},{default:o(()=>[X[12]||(X[12]=e("span",null,"Request",-1)),R.value>0?(f(),k("span",{key:0,class:ae(["flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full text-xs font-bold leading-none",x.value==="request"?"bg-primary text-white":"bg-gray-200 text-foreground"])},I(R.value),3)):q("",!0),x.value==="request"?(f(),k("span",so)):q("",!0)]),_:1},8,["class"]),s(t(En),{value:"activity",class:ae(["flex items-center gap-2 text-sm font-medium transition-all relative flex-1 justify-center bg-transparent outline-none h-full",x.value==="activity"?"text-foreground":"text-muted-foreground hover:text-muted-foreground"])},{default:o(()=>[X[13]||(X[13]=e("span",null,"Activity",-1)),B.value>0?(f(),k("span",{key:0,class:ae(["flex items-center justify-center min-w-5 h-5 px-1.5 rounded-full text-xs font-bold leading-none",x.value==="activity"?"bg-primary text-white":"bg-gray-200 text-foreground"])},I(B.value),3)):q("",!0),x.value==="activity"?(f(),k("span",no)):q("",!0)]),_:1},8,["class"])]),_:1}),e("div",lo,[s(t(jn),{value:"request",class:"space-y-2 p-2 mt-0 flex-1 min-h-full"},{default:o(()=>{var ve,je;return[s(Nl,{task:l.task,"task-type":l.task.type,"customer-id":l.task.customerId||((ve=l.task.customer)==null?void 0:ve.id),onAction:oe},null,8,["task","task-type","customer-id"]),l.task.requestedCar||l.task.vehicle?(f(),re(Qa,{key:0,vehicle:l.task.requestedCar||l.task.vehicle,"request-message":l.task.requestMessage||((je=l.task.requestedCar)==null?void 0:je.requestMessage),source:l.task.source,"image-url":F(l.task.requestedCar||l.task.vehicle),onOpenAd:E,onMoreActions:Q},null,8,["vehicle","request-message","source","image-url"])):q("",!0)]}),_:1}),s(t(jn),{value:"activity",class:"p-2 flex-1 overflow-hidden h-full flex flex-col mt-0"},{default:o(()=>[s(Ll,{activities:M.value,"expanded-summaries":b.value,onActivityClick:_,onToggleSummaryExpanded:V,onAddActivity:G},null,8,["activities","expanded-summaries"])]),_:1})])]),_:1},8,["modelValue"])])])])):(f(),k("div",ao,[...X[14]||(X[14]=[Hn('<div class="text-center max-w-sm p-8" data-v-7d01ef2a><div class="w-16 h-16 mx-auto mb-4 rounded-lg bg-muted flex items-center justify-center" data-v-7d01ef2a><i class="fa-solid fa-tasks text-2xl text-muted-foreground" data-v-7d01ef2a></i></div><h3 class="text-lg font-bold text-foreground mb-2" data-v-7d01ef2a>No task selected</h3><p class="text-sm text-muted-foreground" data-v-7d01ef2a>Select a task from the list to view its details and manage activities</p></div>',1)])])),s(Gn,{modal:"",show:S.value,"task-type":((Xe=l.task)==null?void 0:Xe.type)||"lead","task-id":(at=l.task)==null?void 0:at.id,onSave:$e,onClose:X[2]||(X[2]=ve=>S.value=!1)},null,8,["show","task-type","task-id"]),s(Ml,{modal:"",show:i.value,"task-type":((Ge=l.task)==null?void 0:Ge.type)||"lead","task-id":(_e=l.task)==null?void 0:_e.id,onSave:qe,onClose:X[3]||(X[3]=ve=>i.value=!1)},null,8,["show","task-type","task-id"]),s(ql,{show:$.value,onSave:me,onClose:X[4]||(X[4]=ve=>$.value=!1)},null,8,["show"]),s(Ul,{show:D.value,onSave:se,onClose:X[5]||(X[5]=ve=>D.value=!1)},null,8,["show"]),s(_l,{show:m.value,onSave:ne,onClose:X[6]||(X[6]=ve=>m.value=!1)},null,8,["show"]),s(qn,{show:h.value,title:"Call Feature",onClose:X[7]||(X[7]=ve=>h.value=!1)},null,8,["show"]),s(Zn,{show:y.value,"task-type":((Ve=l.task)==null?void 0:Ve.type)||"lead","task-id":(j=l.task)==null?void 0:j.id,onSave:ke,onClose:X[8]||(X[8]=ve=>y.value=!1)},null,8,["show","task-type","task-id"]),s(Kn,{show:v.value,mode:"tradein","task-type":((W=l.task)==null?void 0:W.type)||"lead","task-id":(pe=l.task)==null?void 0:pe.id,onSave:Ue,onClose:X[9]||(X[9]=ve=>v.value=!1)},null,8,["show","task-type","task-id"]),s(Fl,{show:A.value,"task-type":((K=l.task)==null?void 0:K.type)||"lead","task-id":(P=l.task)==null?void 0:P.id,customer:(te=l.task)==null?void 0:te.customer,onSave:Me,onClose:X[10]||(X[10]=ve=>A.value=!1)},null,8,["show","task-type","task-id","customer"]),s(Xn,{show:g.value,customer:(ue=l.task)==null?void 0:ue.customer,assignee:(he=l.task)==null?void 0:he.assignee,onCreate:ft,onCancel:X[11]||(X[11]=ve=>g.value=!1)},null,8,["show","customer","assignee"])])}}},bv=Qt(oo,[["__scopeId","data-v-7d01ef2a"]]),io={key:0,class:"fixed top-0 right-0 bottom-0 w-full lg:w-4/5 xl:w-3/4 bg-white z-50 shadow-xl flex flex-col overflow-hidden"},ro={class:"flex-1 min-h-0 flex flex-col overflow-hidden"},uo={__name:"DrawerContainer",props:{show:{type:Boolean,required:!0}},emits:["close"],setup(l,{emit:L}){const r=L,p=()=>{r("close")};return(u,d)=>(f(),k(Le,null,[s(On,{name:"fade"},{default:o(()=>[l.show?(f(),k("div",{key:0,class:"fixed inset-0 bg-black/50 z-40",onClick:p})):q("",!0)]),_:1}),s(On,{name:"slide-right"},{default:o(()=>[l.show?(f(),k("div",io,[e("div",ro,[St(u.$slots,"default",{},void 0,!0)])])):q("",!0)]),_:3})],64))}},xv=Qt(uo,[["__scopeId","data-v-ff23c65a"]]);function tl(l,L={}){const r=Ln(),p=w(()=>{const A=typeof l=="function"?l():Gs(l);return{lead:A,displayStage:A?Et(A,"lead"):null}}),u=w(()=>p.value.displayStage||"New"),d=w(()=>{const A=p.value;return Rl(A)}),x=w(()=>{const A=p.value,g=El(A);if(!g)return null;const M=L[g.key];return{...g,handler:M||(()=>{})}}),b=w(()=>{const A=p.value;return jl(A).map(M=>{const B=L[M.key];return{...M,handler:B||(()=>{})}})}),S=w(()=>{const A=p.value;return Wl(A)}),i=w(()=>{const A=p.value;return Bl(A)}),$=w(()=>{const A=p.value;return Pl(A)}),D=w(()=>{const A=p.value;return zl(A)}),m=w(()=>{const g=p.value.lead;return((g==null?void 0:g.contactAttempts)||[]).length||0}),h=w(()=>r.getSetting("maxContactAttempts")),y=w(()=>m.value+1>=h.value),v=w(()=>!0);return{displayStage:u,isClosed:d,primaryAction:x,secondaryActions:b,showLQWidget:S,showDeadlineBanner:i,canPostpone:$,canReassign:v,lqWidgetMode:D,contactAttempts:m,maxContactAttempts:h,shouldShowAutoDisqualifyWarning:y}}function co({getLead:l,leadState:L,emit:r}){const p=Qn(),u=Jt(),d=Vt();async function x(g){var B;const M=l();if(M&&L.canPostpone.value)try{const R=new Date(`${g.date}T${g.time}:00`),J=R.toISOString(),ce={nextActionDue:J};if((g.assigneeId||g.teamId)&&(ce.assignee=g.assignee||null,ce.assigneeId=g.assigneeId||null,ce.assigneeType=g.assigneeType||"user",ce.teamId=g.teamId||null,ce.team=g.team||null),await u.updateLead(M.id,ce),g.createAppointment){const _=new Date(R);_.setHours(_.getHours()+1),await u.updateLead(M.id,{scheduledAppointment:{id:Date.now(),title:`Follow-up Call - ${M.customer.name}`,start:J,end:_.toISOString(),type:"Call",assignee:g.assignee||M.assignee,assigneeId:g.assigneeId||M.assigneeId,assigneeType:g.assigneeType||M.assigneeType||"user",teamId:g.teamId||M.teamId,team:g.team||M.team,status:"scheduled"}}),await u.addActivity(M.id,{type:"appointment",user:((B=d.currentUser)==null?void 0:B.name)||"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${zt(R)} at ${Ss(R)}`,data:{type:"Call",date:g.date,time:g.time,assignee:g.assignee||M.assignee}})}await u.addActivity(M.id,{type:"note",user:"You",action:"postponed lead qualification task",content:`Task postponed to ${zt(R)} at ${Ss(R)}${g.assignee?` and reassigned to ${g.assignee}`:""}`}),await u.fetchLeadById(M.id)}catch(R){console.error("Failed to postpone lead task:",R)}}async function b(g){const M=l();if(M)try{if(await u.updateLead(M.id,{stage:"Validated"}),await u.addActivity(M.id,{type:"note",user:"You",action:"validated lead",content:"Lead has been validated and is ready for follow-up"}),g.scheduleFollowUp&&g.appointmentData){const B=new Date(`${g.appointmentData.date}T${g.appointmentData.time}:00`);await u.scheduleFollowUp(M.id,{dateTime:B.toISOString(),assignee:g.appointmentData.assignee||M.assignee,assigneeId:g.appointmentData.assigneeId||null,assigneeType:g.appointmentData.assigneeType||"user",teamId:g.appointmentData.teamId||null,team:g.appointmentData.team||null}),await u.addActivity(M.id,{type:"appointment",user:"You",action:"scheduled follow-up call",content:`Follow-up call scheduled for ${zt(B)} at ${Ss(B)}`})}await u.fetchLeadById(M.id)}catch(B){console.error("Failed to validate lead:",B)}}async function S(g){var B,R,J;const M=l();if(M)try{if((B=g==null?void 0:g.assignment)!=null&&B.assignee){const _=g.assignment.assignee,V={assignee:_.name||_.label||null,assigneeId:_.id||null,assigneeType:_.type||"user"};_.type==="team"&&(V.teamId=_.id||null,V.team=_.name||null),g.assignment.salesperson&&(V.assignee=g.assignment.salesperson.name||g.assignment.salesperson,V.assigneeId=g.assignment.salesperson.id||null,V.assigneeType="user",V.teamId=_.id||null,V.team=_.name||null),await u.updateLead(M.id,V);const F=((R=g.assignment.salesperson)==null?void 0:R.name)||_.name||"Unassigned";await u.addActivity(M.id,{type:"note",user:((J=d.currentUser)==null?void 0:J.name)||"You",action:"assigned lead",content:`Lead assigned to ${F}${g.assignment.salesperson&&_.name?` (${_.name} team)`:""}`,timestamp:new Date().toISOString()})}const ce=await u.convertLeadToOpportunity(M.id);d.canAccessOpportunities()?p.push({path:`/tasks/${ce}`,query:{type:"opportunity"}}):p.push("/tasks")}catch(ce){console.error("Failed to qualify lead:",ce)}}async function i(g){const M=l();if(M)try{const B=M.contactAttempts||[];await u.updateLead(M.id,{contactAttempts:[...B,g],lastContactAttempt:g.timestamp,totalContactAttempts:B.length+1}),await u.addActivity(M.id,{type:"call",user:"You",action:`logged call attempt - ${g.outcome}`,content:g.notes||`Call attempt via ${g.channel}`,data:{outcome:g.outcome,channel:g.channel,duration:g.duration}}),await u.fetchLeadById(M.id)}catch(B){console.error("Failed to log call attempt:",B)}}async function $(g){const M=l();if(M)try{await u.addActivity(M.id,{type:"note",user:"You",action:"added a note",content:g.content||g.text||"",data:g}),await u.fetchLeadById(M.id)}catch(B){console.error("Failed to save note:",B)}}function D(){r("open-purchase-method")}function m(){r("open-trade-in")}async function h(g){var B;const M=l();if(M)try{const R=g.datetime?new Date(g.datetime).toISOString().split("T")[0]+"T"+g.time+":00":`${g.date}T${g.time}:00`,J=new Date(R),ce=g.duration||60;J.setMinutes(J.getMinutes()+ce);const _={scheduledAppointment:{id:Date.now(),title:`${g.type} - ${M.customer.name}`,start:R,end:J.toISOString(),type:g.type,assignee:g.assignee,assigneeId:g.assigneeId||g.salespersonId||g.teamId,assigneeType:g.assigneeType||(g.salespersonId?"user":"team"),teamId:g.teamId||null,team:g.team||null,salesperson:g.salesperson||null,salespersonId:g.salespersonId||null,status:"scheduled",location:g.location||"",notes:g.notes||""}};(g.assigneeId||g.salespersonId||g.teamId)&&(_.assignee=g.assignee||g.salesperson||g.team,_.assigneeId=g.assigneeId||g.salespersonId||g.teamId,_.assigneeType=g.assigneeType||(g.salespersonId?"user":"team"),g.teamId&&(_.teamId=g.teamId,_.team=g.team)),await u.updateLead(M.id,_),await u.addActivity(M.id,{type:"appointment",user:((B=d.currentUser)==null?void 0:B.name)||"You",action:"scheduled an appointment",content:`${g.type} scheduled for ${zt(new Date(R))} at ${g.time}`,data:{type:g.type,date:g.date||zt(new Date(R)),time:g.time,assignee:g.assignee,assigneeId:g.assigneeId,team:g.team,salesperson:g.salesperson}}),await u.fetchLeadById(M.id)}catch(R){console.error("Failed to schedule appointment:",R)}}async function y(g){const M=l();if(M&&!(L.isClosed.value&&!g.force))try{const B=L.displayStage.value,R=g.reason==="Duplicate"?Qs.CLOSED_DUPLICATE:g.category==="Not Interested"?Qs.CLOSED_NOT_INTERESTED:Qs.CLOSED_INVALID,J=Wn(B,R);if(J){const{updates:ce,activities:_}=J(M,R,g);await u.updateLead(M.id,ce);for(const V of _)await u.addActivity(M.id,V)}else{const ce=g.reason==="Duplicate";await u.updateLead(M.id,{isDisqualified:!0,disqualifyReason:g.reason,isDuplicate:ce,stage:ce?"Closed Failed":"Not Valid",status:"Disqualified",scheduledAppointment:null,nextActionDue:null}),await u.addActivity(M.id,{type:"note",user:"You",action:"disqualified lead",content:`Lead disqualified - Category: ${g.category}, Reason: ${g.reason}`})}p.push("/tasks")}catch(B){console.error("Failed to disqualify lead:",B)}}async function v(){const g=l();if(g)try{const M=L.displayStage.value,B=Qs.NEW,R=Wn(M,B);if(R){const{updates:J,activities:ce}=R(g);await u.updateLead(g.id,J);for(const _ of ce)await u.addActivity(g.id,_)}else await u.updateLead(g.id,{isDisqualified:!1,disqualifyReason:null,disqualifyCategory:null,isDuplicate:!1,stage:"Open Lead",status:"Open",nextActionDue:null,scheduledAppointment:null}),await u.addActivity(g.id,{type:"note",user:"You",action:"reopened lead",content:"Lead has been reopened for qualification"});await u.fetchLeadById(g.id)}catch(M){console.error("Failed to reopen lead:",M)}}function A(){const g=l();g&&g.opportunityId&&p.push({path:`/tasks/${g.opportunityId}`,query:{type:"opportunity"}})}return{handlePostponed:x,handleValidated:b,handleQualified:S,handleCallAttemptLogged:i,handleNoteSaved:$,handleOpenPurchaseMethod:D,handleOpenTradeIn:m,handleAppointmentScheduled:h,handleDisqualified:y,handleReopen:v,viewOpportunity:A}}const mo={key:0,class:"px-4 py-4 flex items-center justify-between shrink-0"},po={class:"space-y-6"},sl={__name:"TaskManagementWidget",props:{task:{type:Object,required:!0},containerClass:{type:String,default:""},hideTitle:{type:Boolean,default:!1},hideBorder:{type:Boolean,default:!1}},setup(l){return(L,r)=>l.task?(f(),k("div",{key:0,class:ae(["rounded-lg flex flex-col bg-muted",l.containerClass])},[l.hideTitle?q("",!0):(f(),k("div",mo,[...r[0]||(r[0]=[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-clipboard-check text-foreground"}),e("h2",{class:"text-sm font-medium text-foreground leading-5"},"Manage next steps")],-1)])])),e("div",{class:ae(["bg-white rounded-lg p-2 flex flex-col",l.hideBorder?"shadow-none":"shadow-nsc-card"])},[St(L.$slots,"deadline-banner"),e("div",po,[St(L.$slots,"primary-action"),St(L.$slots,"task-widgets"),St(L.$slots,"closed-state"),St(L.$slots,"secondary-actions")])],2)],2)):q("",!0)}},fo={class:"flex justify-between items-start mb-3"},vo={class:"font-bold text-gray-900 text-sm"},go={class:"text-xs text-gray-500 mt-0.5"},yo={class:"flex gap-3 flex-wrap"},nl={__name:"PrimaryActionWidget",props:{action:{type:Object,required:!0},colorScheme:{type:Object,required:!0}},emits:["action-clicked"],setup(l){return(L,r)=>(f(),k("div",{class:ae(["rounded-lg p-4 relative transition-all duration-300 border",[l.colorScheme.background,l.colorScheme.border]])},[e("div",fo,[e("div",null,[e("h4",vo,I(l.action.title),1),e("p",go,I(l.action.description),1)])]),e("div",yo,[e("button",{onClick:r[0]||(r[0]=p=>L.$emit("action-clicked")),class:ae([l.action.buttonClass,"font-medium px-4 py-2 rounded-lg text-xs flex items-center gap-2 transition-colors shadow-sm shadow-gray-200"])},[e("i",{class:ae(l.action.icon)},null,2),C(" "+I(l.action.label),1)],2)])],2))}},ho={class:"flex flex-col min-w-64 max-w-sm w-full bg-white rounded-lg shadow-nsc-card overflow-hidden"},bo={class:"p-2 border-b border-border shrink-0"},xo=["placeholder"],wo={class:"max-h-96 overflow-y-auto p-2"},ko={class:"text-xs font-medium text-muted-foreground uppercase tracking-wide px-2 py-1 mb-1"},So=["onClick"],Co={key:0,class:"fa-solid fa-users text-xs"},$o={key:1},Do={class:"min-w-0 flex-1"},Ao={class:"font-medium text-sm text-foreground truncate"},To={key:0,class:"text-xs text-muted-foreground truncate capitalize"},Oo={key:1,class:"text-center py-8"},Io={class:"text-sm text-muted-foreground"},Vo={__name:"AssigneeDropdownContent",emits:["select"],setup(l,{emit:L}){const{t:r}=Ns(),p=L,u=Ut(),d=T(""),x=w(()=>u.assignableUsers||[]),b=w(()=>u.assignableTeams||[]),S=w(()=>{const v=b.value.map(M=>M.name),A=[...new Set(x.value.map(M=>M.team).filter(Boolean))],g=new Set(v);return A.forEach(M=>{g.has(M)||(g.add(M),v.push(M))}),v}),i=w(()=>{const v=[],A=b.value.map(g=>({...g,type:"team",team:g.name}));return A.length>0&&v.push({key:"teams",label:"Teams",items:A}),S.value.forEach(g=>{const M=x.value.filter(B=>B.team===g);M.length>0&&v.push({key:`team-${g}`,label:g,items:M.map(B=>({...B,type:"user"}))})}),v}),$=(v,A)=>{const g=A.toLowerCase(),M=(v.name||"").toLowerCase(),B=(v.email||"").toLowerCase(),R=(v.role||"").toLowerCase(),J=(v.team||"").toLowerCase();return M.includes(g)||B.includes(g)||R.includes(g)||J.includes(g)},D=w(()=>{const v=d.value.trim();return v?i.value.map(A=>({...A,items:A.items.filter(g=>$(g,v))})).filter(A=>A.items.length>0):i.value}),m=w(()=>D.value.some(v=>v.items.length>0));function h(v){return{manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"}[v]||"bg-muted text-muted-foreground"}function y(v){const A=v.type==="team"?{...v,team:v.name,role:void 0,email:void 0,initials:void 0}:v;p("select",A)}return(v,A)=>(f(),k("div",ho,[e("div",bo,[lt(e("input",{"onUpdate:modelValue":A[0]||(A[0]=g=>d.value=g),type:"text",placeholder:t(r)("common.assignee.searchPlaceholder"),class:"w-full h-10 min-h-10 px-3 border border-border rounded-lg text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:border-brand-dark focus:ring-2 focus:ring-brand-dark/15"},null,8,xo),[[Jn,d.value]])]),e("div",wo,[m.value?(f(!0),k(Le,{key:0},Je(D.value,g=>(f(),k("div",{key:g.key,class:"mb-3 last:mb-0"},[e("p",ko,I(g.label),1),(f(!0),k(Le,null,Je(g.items,M=>(f(),k("button",{key:`${M.type}-${M.id}`,type:"button",onClick:B=>y(M),class:"w-full flex items-center gap-3 p-2 rounded-lg border border-border hover:bg-muted hover:border-brand-dark/30 transition-colors text-left"},[e("div",{class:ae(["w-8 h-8 rounded-full flex items-center justify-center font-semibold text-xs shrink-0",M.type==="team"?"bg-green-100 text-green-700":h(M.role)])},[M.type==="team"?(f(),k("i",Co)):(f(),k("span",$o,I(M.initials||"?"),1))],2),e("div",Do,[e("p",Ao,I(M.name),1),M.type==="user"?(f(),k("p",To,I(M.role)+" • "+I(M.email),1)):q("",!0)])],8,So))),128))]))),128)):(f(),k("div",Oo,[A[1]||(A[1]=e("i",{class:"fa-solid fa-search text-2xl text-muted-foreground mb-2"},null,-1)),e("p",Io,I(t(r)("common.assignee.noAssigneesFound")),1)]))])]))}},No={key:0,class:"flex items-center justify-between gap-2 w-full"},Lo={class:"flex items-center gap-2 min-w-0 flex-1"},Mo={class:"min-w-0 flex-1"},qo={class:"text-sm font-semibold text-foreground truncate leading-tight"},Uo={class:"font-normal text-muted-foreground"},_o={class:"text-xs text-muted-foreground truncate leading-tight"},Fo={class:"flex items-center gap-2 min-w-0 flex-1"},Ro={class:"text-sm font-medium text-foreground"},Eo={__name:"TaskAssignee",props:{task:{type:Object,required:!0},taskType:{type:String,default:"lead"}},emits:["reassigned"],setup(l,{emit:L}){const{t:r}=Ns(),p=l,u=L,d=Ut(),x=Vt(),b=Jt(),S=qt(),i=T(!1),$=T(!1),D=w(()=>x.currentUser),m=w(()=>!!(p.task.assignee||p.task.owner||p.task.assignedTo)),h=w(()=>{var ce;const R=p.task.assignee||p.task.owner||p.task.assignedTo||"Unassigned",J=(ce=d.users)==null?void 0:ce.find(_=>_.name===R);return{name:R,team:(J==null?void 0:J.team)||p.task.assigneeTeam||p.task.team||"No team",dealership:(J==null?void 0:J.dealership)||p.task.assigneeDealership||"MotorK Dealership",role:(J==null?void 0:J.role)||p.task.assigneeRole||"salesman"}}),y=R=>!R||R==="Unassigned"?"?":R.split(" ").map(J=>J[0]).join("").toUpperCase().substring(0,2),v=R=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[R]||"bg-muted text-muted-foreground",A=async()=>{if(D.value)try{p.taskType==="lead"?await b.updateLead(p.task.id,{assignee:D.value.name,assigneeType:"user",assigneeTeam:D.value.team,assigneeDealership:D.value.dealership,assigneeRole:D.value.role}):p.taskType==="opportunity"&&await S.updateOpportunity(p.task.id,{assignee:D.value.name,assigneeType:"user",assigneeTeam:D.value.team,assigneeDealership:D.value.dealership,assigneeRole:D.value.role}),u("reassigned",D.value)}catch(R){console.error("Error assigning to self:",R)}};async function g(R){const J={assignee:R.name,assigneeType:R.type,assigneeTeam:R.team??R.name,assigneeDealership:R.dealership,assigneeRole:R.role};R.type==="team"&&(J.teamId=R.id),p.taskType==="lead"?await b.updateLead(p.task.id,J):p.taskType==="opportunity"&&await S.updateOpportunity(p.task.id,J),u("reassigned",R)}function M(R){g(R).catch(J=>console.error("Error assigning:",J)),$.value=!1}async function B(R){try{await g(R),i.value=!1}catch(J){console.error("Error reassigning:",J)}}return(R,J)=>(f(),k(Le,null,[e("div",{class:ae(["rounded-lg",m.value?"bg-muted":"bg-blue-50"]),style:Dl(m.value?void 0:{borderWidth:"1px",borderStyle:"solid",borderColor:"var(--brand-primary)"})},[e("div",{class:ae(["rounded-lg px-3 py-2 shadow-nsc-card flex items-center justify-between gap-2 flex-wrap",m.value?"bg-white border border-border":"bg-transparent"])},[m.value?(f(),k("div",No,[e("div",Lo,[e("div",{class:ae(["w-7 h-7 rounded-full flex items-center justify-center font-bold text-xs shrink-0",v(h.value.role)])},I(y(h.value.name)),3),e("div",Mo,[e("p",qo,[C(I(h.value.name)+" ",1),e("span",Uo,"• "+I(h.value.team),1)]),e("p",_o,I(h.value.dealership),1)])]),s(t(ee),{variant:"ghost",size:"sm",onClick:J[0]||(J[0]=ce=>i.value=!0),class:"shrink-0 text-xs px-2 py-1"},{default:o(()=>[...J[3]||(J[3]=[C(" Change ",-1)])]),_:1})])):(f(),k(Le,{key:1},[e("div",Fo,[s(t(da),{size:14,class:"shrink-0","aria-hidden":"true","stroke-width":"2",style:{color:"var(--brand-primary)"}}),e("p",Ro,I(t(r)("common.assignee.taskUnassigned")),1)]),s(t(kl),{class:"assignee-button-group flex items-stretch gap-0 rounded-lg overflow-hidden"},{default:o(()=>[s(t(ee),{variant:"default",size:"sm",class:"rounded-r-none border-r border-white/20 bg-primary",onClick:A},{default:o(()=>[C(I(t(r)("common.assignee.assignToMe")),1)]),_:1}),s(t(hl)),s(t(bl),{open:$.value,"onUpdate:open":J[1]||(J[1]=ce=>$.value=ce)},{default:o(()=>[s(t(xl),{"as-child":""},{default:o(()=>[s(t(ee),{variant:"default",size:"icon-sm",class:"rounded-l-none border-0 bg-primary -ml-px","aria-label":t(r)("common.assignee.assignToSomeone")},{default:o(()=>[s(t($l),{size:14,"stroke-width":"2","aria-hidden":"true"})]),_:1},8,["aria-label"])]),_:1}),s(t(wl),{class:"w-auto p-0 border border-border rounded-lg shadow-nsc-card bg-white",side:"bottom",align:"end"},{default:o(()=>[s(Vo,{onSelect:M})]),_:1})]),_:1},8,["open"])]),_:1})],64))],2)],6),s(el,{show:i.value,title:m.value?"Reassign task":"Assign task","confirm-label":m.value?"Reassign":"Assign",onClose:J[2]||(J[2]=ce=>i.value=!1),onConfirm:B},null,8,["show","title","confirm-label"])],64))}},ll=Qt(Eo,[["__scopeId","data-v-9a49d8b2"]]),Ht=(l,L)=>{if(!l||!L)return[];const r=new Date(L).getDay();if(r===0||r===6)return[];const[u,d]=l.split("-"),x=parseInt(d);return u==="team"?Wo(x,L):u==="user"?jo(x,L,r):[]},jo=(l,L,r)=>{const p={1:{1:["09:00","09:30","10:00","10:30","11:00"],2:["09:00","10:00","11:00","14:00","15:00"],3:["09:00","09:30","10:30","11:00"],4:["09:00","10:00","11:00","14:00","16:00"],5:["09:00","10:00","11:00"]},2:{1:["14:00","14:30","15:00","15:30","16:00"],2:["13:00","14:00","15:00","16:00","17:00"],3:["14:00","15:00","16:00","17:00"],4:["13:00","14:30","15:00","16:00"],5:["14:00","15:00","16:00"]},3:{1:["09:00","10:30","14:00","15:30"],2:["09:30","11:00","14:00","16:00"],3:["10:00","11:30","14:30","16:00"],4:["09:00","11:00","14:00","15:00"],5:["10:00","11:00","14:00","15:00"]},4:{1:["09:00","10:00","11:00","13:00","14:00","15:00","16:00"],2:["09:00","10:30","11:30","14:00","15:00","16:30"],3:["09:30","10:00","11:00","14:00","15:30","16:00"],4:["09:00","10:00","11:30","13:30","15:00","16:00"],5:["09:00","10:00","11:00","14:00","15:00"]}};return(p[l]||p[1])[r]||[]},Wo=(l,L)=>{const r=new Date(L).getDay(),p=["09:00","09:30","10:00","10:30","11:00","11:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00"];return l===1?r===1||r===4?["09:00","11:00","14:00","16:00"]:["10:00","14:00","15:00"]:l===2?p.filter((u,d)=>d%2===0):p},Bo={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},Po={class:"space-y-3"},zo={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Yo={class:"font-semibold text-foreground text-sm mb-4"},Ho={class:"mb-4"},Qo={class:"mb-4"},Jo={class:"flex gap-2"},Go={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Zo={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ko={class:"flex items-center justify-between mb-4"},Xo={class:"text-sm font-semibold text-foreground"},ei={class:"grid grid-cols-7 gap-1 mb-2"},ti={class:"grid grid-cols-7 gap-1"},si=["onClick"],ni={class:"text-sm font-semibold text-foreground mb-4"},li={key:0,class:"space-y-2"},ai=["onClick"],oi={key:1,class:"text-sm text-muted-foreground py-4 text-center"},ii={key:2,class:"text-sm text-muted-foreground py-4 text-center"},ri={__name:"ScheduleAppointmentModal",props:{show:{type:Boolean,required:!0},preselectedAssignee:{type:Object,default:null}},emits:["close","confirm"],setup(l,{emit:L}){const{t:r}=Ns(),p=l,u=L,d=Vt(),x=Ut(),b=T("assign-and-schedule"),S=T(""),i=T(null),$=T(""),D=T(""),m=T("30min"),h=T(new Date().getMonth()),y=T(new Date().getFullYear()),v=T(null);w(()=>x.assignableUsers),w(()=>x.assignableTeams);const A=w(()=>new Date(y.value,h.value).toLocaleDateString("en-US",{month:"long",year:"numeric"})),g=w(()=>{const me=new Date(y.value,h.value,1),ne=new Date(y.value,h.value+1,0).getDate(),ke=me.getDay()===0?6:me.getDay()-1,Ue=[];for(let Me=0;Me<ke;Me++)Ue.push(null);for(let Me=1;Me<=ne;Me++)Ue.push(Me);return Ue}),M=w(()=>[{value:"Showroom Visit",label:r("forms.schedule.eventType.options.showroomVisit")},{value:"Test Drive",label:r("forms.schedule.eventType.options.testDrive")},{value:"Video Call",label:r("forms.schedule.eventType.options.videoCall")},{value:"Home Visit",label:r("forms.schedule.eventType.options.homeVisit")},{value:"Closing Meeting",label:r("forms.schedule.eventType.options.closingMeeting")}]),B=["MON","TUE","WED","THU","FRI","SAT","SUN"],R=w(()=>{if(!v.value||!$.value)return r("forms.schedule.timeSlots.selectDate");const me=new Date($.value),se=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ne=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${se[me.getDay()]}, ${ne[me.getMonth()]} ${me.getDate()}`}),J=me=>{if(!me||!$.value)return!1;const se=new Date($.value);return se.getDate()===me&&se.getMonth()===h.value&&se.getFullYear()===y.value},ce=me=>{if(!me)return;const se=new Date(y.value,h.value,me);$.value=se.toISOString().split("T")[0],v.value=me,D.value=""},_=()=>{h.value===0?(h.value=11,y.value--):h.value--},V=()=>{h.value===11?(h.value=0,y.value++):h.value++},F=w(()=>!$.value||!i.value?[]:Ht(i.value,$.value)),E=()=>{var me;if(p.preselectedAssignee){const{type:se,id:ne}=p.preselectedAssignee;i.value=`${se}-${ne}`}else i.value=`user-${((me=d.currentUser)==null?void 0:me.id)||1}`};E();const Q=w(()=>b.value==="assign-only"?!0:!!(S.value&&$.value&&D.value&&i.value));Ce(()=>p.show,me=>{me?E():oe()}),Ce($,()=>{D.value=""});const oe=()=>{b.value="assign-and-schedule",S.value="",$.value="",D.value="",m.value="30min",v.value=null;const me=new Date;h.value=me.getMonth(),y.value=me.getFullYear()},G=me=>{me||u("close")},$e=()=>{if(!Q.value)return;const me=i.value.startsWith("team-"),se=parseInt(i.value.split("-")[1]);let ne={};if(me){const Ue=x.getTeamById(se);ne={assigneeType:"team",teamId:se,team:(Ue==null?void 0:Ue.name)||"Unknown Team",assignee:null,assigneeId:null}}else{const Ue=x.getUserById(se);ne={assigneeType:"user",assigneeId:se,assignee:(Ue==null?void 0:Ue.name)||"Unknown",teamId:null,team:null}}const ke={...ne};b.value==="assign-and-schedule"&&(ke.type=S.value,ke.date=$.value,ke.time=D.value,ke.duration=m.value),u("confirm",ke),u("close")},qe=()=>{u("close")};return(me,se)=>(f(),re(t(Vs),{open:l.show,"onUpdate:open":G},{default:o(()=>[s(t($s),null,{default:o(()=>[s(t(Ds),{class:"fixed inset-0 z-50 bg-black/50"}),s(t(As),{class:"w-full sm:max-w-4xl max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[s(t(Ts),{class:"flex-shrink-0"},{default:o(()=>[s(t(Os),{class:"text-lg"},{default:o(()=>[...se[6]||(se[6]=[C("Schedule Appointment",-1)])]),_:1})]),_:1}),e("div",Bo,[e("div",Po,[e("label",{class:ae(["flex items-center gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all",b.value==="assign-only"?"border-green-600 bg-green-50":"border-border hover:border-green-600/30"])},[lt(e("input",{type:"radio","onUpdate:modelValue":se[0]||(se[0]=ne=>b.value=ne),value:"assign-only",class:"w-4 h-4 text-green-600 focus:ring-green-600 border-gray-300"},null,512),[[bt,b.value]]),se[7]||(se[7]=e("span",{class:"text-sm font-medium text-foreground"},"Assign only",-1))],2),e("label",{class:ae(["flex items-center gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all",b.value==="assign-and-schedule"?"border-green-600 bg-green-50":"border-border hover:border-green-600/30"])},[lt(e("input",{type:"radio","onUpdate:modelValue":se[1]||(se[1]=ne=>b.value=ne),value:"assign-and-schedule",class:"w-4 h-4 text-green-600 focus:ring-green-600 border-gray-300"},null,512),[[bt,b.value]]),se[8]||(se[8]=e("span",{class:"text-sm font-medium text-foreground"},"Assign and schedule",-1))],2)]),b.value==="assign-and-schedule"?(f(),k("div",zo,[e("h5",Yo,I(t(r)("forms.schedule.title")),1),e("div",Ho,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[C(I(t(r)("forms.schedule.eventType.label")),1)]),_:1}),s(t(st),{modelValue:S.value,"onUpdate:modelValue":se[2]||(se[2]=ne=>S.value=ne),items:M.value,placeholder:t(r)("forms.schedule.eventType.placeholder"),"value-key":"value",class:"w-full"},{item:o(({item:ne})=>[e("span",null,I(ne.label),1)]),_:1},8,["modelValue","items","placeholder"])]),e("div",Qo,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[C(I(t(r)("forms.schedule.duration.label")),1)]),_:1}),e("div",Jo,[e("button",{onClick:se[3]||(se[3]=ne=>m.value="30min"),class:ae(["px-4 py-2 border-2 rounded-lg text-sm font-medium transition-all",m.value==="30min"?"border-primary bg-muted text-foreground":"border-border text-muted-foreground hover:border-primary/30"])},I(t(r)("forms.schedule.duration.30min")),3),e("button",{onClick:se[4]||(se[4]=ne=>m.value="60min"),class:ae(["px-4 py-2 border-2 rounded-lg text-sm font-medium transition-all",m.value==="60min"?"border-primary bg-muted text-foreground":"border-border text-muted-foreground hover:border-primary/30"])},I(t(r)("forms.schedule.duration.60min")),3),e("button",{onClick:se[5]||(se[5]=ne=>m.value="custom"),class:ae(["px-4 py-2 border-2 rounded-lg text-sm font-medium transition-all",m.value==="custom"?"border-primary bg-muted text-foreground":"border-border text-muted-foreground hover:border-primary/30"])},I(t(r)("forms.schedule.duration.custom")),3)])]),e("div",Go,[e("div",Zo,[e("div",null,[e("div",Ko,[e("button",{onClick:_,class:"p-1 hover:bg-muted rounded transition-colors"},[...se[9]||(se[9]=[e("i",{class:"fa-solid fa-chevron-left text-sm text-muted-foreground"},null,-1)])]),e("h6",Xo,I(A.value),1),e("button",{onClick:V,class:"p-1 hover:bg-muted rounded transition-colors"},[...se[10]||(se[10]=[e("i",{class:"fa-solid fa-chevron-right text-sm text-muted-foreground"},null,-1)])])]),e("div",ei,[(f(),k(Le,null,Je(B,ne=>e("div",{key:ne,class:"text-center text-xs font-medium text-muted-foreground py-2"},I(ne),1)),64))]),e("div",ti,[(f(!0),k(Le,null,Je(g.value,(ne,ke)=>(f(),k("div",{key:ke,onClick:Ue=>ce(ne),class:ae(["aspect-square flex items-center justify-center text-sm font-medium rounded-lg cursor-pointer transition-all",J(ne)?"bg-primary text-white":ne?"text-muted-foreground hover:bg-muted":"text-transparent"])},I(ne),11,si))),128))])]),e("div",null,[e("h6",ni,I(R.value),1),$.value&&F.value.length>0?(f(),k("div",li,[(f(!0),k(Le,null,Je(F.value,ne=>(f(),k("button",{key:ne,onClick:ke=>D.value=ne,class:ae(["w-full py-2 px-4 bg-white border border-border rounded-lg shadow-sm text-sm font-medium text-center transition-all",D.value===ne?"border-primary bg-muted text-foreground":"text-muted-foreground hover:border-primary/30"])},I(ne),11,ai))),128))])):$.value&&F.value.length===0?(f(),k("div",oi,I(t(r)("forms.schedule.timeSlots.noSlots")),1)):(f(),k("div",ii,I(t(r)("forms.schedule.timeSlots.selectDate")),1))])])])])):q("",!0)]),s(t(Is),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3 mt-6"},{default:o(()=>[s(t(ee),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto text-sm",onClick:qe}),s(t(ee),{label:"Confirm Appointment",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto text-sm !bg-brand-black !hover:bg-brand-darkDarker !text-white !border-brand-black",disabled:!Q.value,onClick:$e},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}};function al(){const l=Al(),L=T(!1),r=T(!1),p=T(0),u=T(""),d=T(null),x=T({}),b=T(null),S={leadLines:["Yes, this is Josh Adams speaking.","Oh, hi Michael! Yes, I was waiting for your call.","That sounds great. I'm definitely interested in seeing it."],salesLines:["Hi Josh, Michael here regarding your Audi A6 inquiry.","Great. I see you're interested in the Allroad. Do you have a vehicle you'd like to trade in?"]},i=w(()=>{const v=Math.floor(p.value/60),A=p.value%60;return`${v.toString().padStart(2,"0")}:${A.toString().padStart(2,"0")}`}),$=()=>{L.value=!0,p.value=0,r.value=!1,u.value="",d.value=setInterval(()=>{p.value++,p.value>=20&&D()},1e3)},D=()=>{d.value&&(clearInterval(d.value),d.value=null),L.value=!1,r.value=!0,x.value={duration:p.value,notes:u.value,transcription:S,channel:"phone"}},m=async v=>{try{await navigator.clipboard.writeText(v),l.pushToast("success","Phone number copied to clipboard!")}catch{l.pushToast("error","Failed to copy phone number")}},h=v=>(b.value={tradeIn:S.leadLines.some(A=>A.toLowerCase().includes("trade")||A.toLowerCase().includes("exchange"))||!1,financing:S.leadLines.some(A=>A.toLowerCase().includes("financ")||A.toLowerCase().includes("payment")||A.toLowerCase().includes("loan"))||!1},b.value.tradeIn&&v&&(v.value.tradeIn=!0),b.value.financing&&v&&(v.value.financing=!0),b.value),y=()=>{L.value=!1,r.value=!1,p.value=0,u.value="",x.value={},d.value&&(clearInterval(d.value),d.value=null)};return Tl(()=>{d.value&&clearInterval(d.value)}),{isCallActive:L,callEnded:r,callDuration:p,callNotes:u,callData:x,extractedData:b,mockTranscription:S,formattedCallDuration:i,startCall:$,endCall:D,copyNumber:m,extractInformation:h,resetCall:y}}function ui(l,L,r,p,u,d){var xe,we,Ee;const x=T(!0),b=T(null),S=T(!1),i=T(!1),$=T(!1),D=T(""),m=T(null),h=[{value:"whatsapp",label:"WhatsApp"},{value:"sms",label:"SMS"},{value:"email",label:"Email"},{value:"dont-send",label:"Don't send"}],y=T("whatsapp"),v=T("followup-1"),A=T(null),g=T(""),M=T("09:00"),B=T(null),R=T("Not Interested"),J=T(""),ce=T({dealership:((we=(xe=l.value)==null?void 0:xe.requestedCar)==null?void 0:we.dealership)||"Barcelona",team:"Audi Sales (New)",assigneeId:((Ee=d==null?void 0:d.value)==null?void 0:Ee.id)||null}),_=T(null),V=T(null),F=T({immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}),E=w(()=>{var ie,Se;if(!((ie=l.value)!=null&&ie.requestedCar))return null;const de=(Se=l.value.requestedCar.condition)==null?void 0:Se.toLowerCase();return de==="used"?{id:7,name:"Sales (Used)",dealershipId:2,dealership:"Firenze"}:de==="new"?{id:5,name:"Sales (New)",dealershipId:3,dealership:"Milano"}:null}),Q=T({tradeIn:!1,financing:!1,contactAvailability:!1}),oe=T(!1),G=T(null),$e=T(!0),qe=T(null),me=T(null),se=T("assign-and-schedule"),ne=T(""),ke=T(null),Ue=T(""),Me=T(null),ft=T(""),z=T(""),X=T(null),Xe=T(""),at=de=>{Xe.value=de},Ge=w(()=>{const de=[];for(let ie=9*60;ie<=18*60;ie+=30){const Se=String(Math.floor(ie/60)).padStart(2,"0"),be=String(ie%60).padStart(2,"0");de.push(`${Se}:${be}`)}return de}),_e=w(()=>{if(ke.value!=null)return ke.value;const de=parseInt(Ue.value,10);return Number.isFinite(de)&&de>0?de:null}),Ve=w(()=>{if(!Me.value)return[];const de=[],ie=new Date;if(ie.setHours(0,0,0,0),Me.value==="tomorrow"){const Se=new Date(ie);Se.setDate(Se.getDate()+1),Se.getDay()!==0&&Se.getDay()!==6&&de.push(Se)}else if(Me.value==="this-week"){const Se=ie.getDay(),be=new Date(ie);be.setDate(ie.getDate()-(Se===0?6:Se-1));for(let ge=0;ge<5;ge++){const Ae=new Date(be);Ae.setDate(be.getDate()+ge),Ae>=ie&&de.push(Ae)}}else if(Me.value==="custom"&&ft.value&&z.value){const Se=new Date(ft.value),be=new Date(z.value),ge=new Date(Se);for(;ge<=be;)ge.getDay()!==0&&ge.getDay()!==6&&de.push(new Date(ge)),ge.setDate(ge.getDate()+1)}return de}),j=w(()=>{var be,ge,Ae,nt,rt,Fe,Ze;const de=((Ae=(ge=(be=l.value)==null?void 0:be.customer)==null?void 0:ge.name)==null?void 0:Ae.split(" ")[0])||"",ie=((rt=(nt=l.value)==null?void 0:nt.requestedCar)==null?void 0:rt.brand)||"",Se=((Ze=(Fe=l.value)==null?void 0:Fe.requestedCar)==null?void 0:Ze.model)||"";return{"followup-1":`Hi ${de}! I tried calling you earlier but couldn't reach you. When would be a good time to discuss the ${ie} ${Se}?`,"followup-2":`Hello ${de}, this is regarding your inquiry about the ${ie} ${Se}. Please let me know when you're available for a call.`,custom:""}}),W=w(()=>v.value==="custom"?"Type your custom message...":j.value[v.value]||""),pe=w(()=>{var de;return!!((de=l.value)!=null&&de.scheduledAppointment)}),K=()=>{const de=new Date,ie=de.getHours(),Se=de.getDay();let be=new Date,ge="10:00",Ae="";if(Se===5&&ie>=15)be.setDate(de.getDate()+3),ge="10:00",Ae="Optimal time after weekend, customer likely refreshed";else if(Se===6||Se===0)be.setDate(de.getDate()+(Se===6?2:1)),ge="10:00",Ae="Weekend follow-up avoided, better response rate on weekdays";else if(ie>=17)be.setDate(de.getDate()+1),ge="10:00",Ae="Business hours preferred, higher engagement rate";else if(ie<9)be=new Date(de),be.setHours(10,0,0,0),ge="10:00",Ae="Peak response time, customers more available mid-morning";else if(ie<14){be=new Date(de);const Fe=ie+2;be.setHours(Fe,0,0,0),ge=`${String(Fe).padStart(2,"0")}:00`,Ae="Follow-up within same day increases conversion likelihood"}else be.setDate(de.getDate()+1),be.setHours(10,0,0,0),ge="10:00",Ae="Next morning follow-up maintains momentum";const nt=be.toISOString().split("T")[0],rt=`${nt}T${ge}:00`;return{date:nt,time:ge,dateTime:rt,reason:Ae,formattedDate:be.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}};return{showOutcomeSelection:x,selectedOutcome:b,showNoteModal:S,showScheduleAppointmentModal:i,followupChannels:h,followupChannel:y,selectedTemplate:v,rescheduleTime:A,customDate:g,customTime:M,disqualifyCategory:R,disqualifyReason:J,assignment:ce,preferences:Q,surveyCompleted:oe,surveyResponses:G,showSurvey:$e,aiSuggestionData:B,showCallLogForm:$,callLogDateTime:D,callLogAssignee:m,qualificationSelectedTeam:_,qualificationSelectedSalesman:V,suggestedTeam:E,communicationPreferences:F,messageTemplates:j,messagePreview:W,hasExistingAppointment:pe,selectOutcome:de=>{if(b.value=de,!D.value){const ie=new Date,Se=ie.getFullYear(),be=String(ie.getMonth()+1).padStart(2,"0"),ge=String(ie.getDate()).padStart(2,"0"),Ae=String(ie.getHours()).padStart(2,"0"),nt=String(ie.getMinutes()).padStart(2,"0");D.value=`${Se}-${be}-${ge}T${Ae}:${nt}`}!m.value&&(d!=null&&d.value)&&(m.value=d.value),de==="interested"&&(oe.value=!1,G.value=null,$e.value=!0,r!=null&&r.value&&(Q.value.tradeIn=r.value.tradeIn||!1,Q.value.financing=r.value.financing||!1))},cancelOutcome:()=>{b.value=null,$.value=!1},calculateNextCallDate:()=>{if(A.value==="tomorrow-9am"){const ie=new Date;return ie.setDate(ie.getDate()+1),ie.setHours(9,0,0,0),ie.toISOString()}else if(A.value==="monday"){if(B.value)return new Date(B.value.dateTime).toISOString();const ie=new Date,Se=(8-ie.getDay())%7||7;return ie.setDate(ie.getDate()+Se),ie.setHours(9,0,0,0),ie.toISOString()}else if(A.value==="custom"&&g.value&&M.value)return new Date(`${g.value}T${M.value}:00`).toISOString();const de=new Date;return de.setDate(de.getDate()+1),de.setHours(9,0,0,0),de.toISOString()},calculateAISuggestion:K,handleAISuggestionClick:()=>{A.value="monday",B.value=K()},resetOutcomeState:()=>{b.value=null,x.value=!0,y.value="whatsapp",v.value="followup-1",A.value=null,g.value="",M.value="09:00",R.value="Not Interested",J.value="",oe.value=!1,G.value=null,$e.value=!0,B.value=null,$.value=!1,D.value="",m.value=null,qe.value=null,me.value=null,se.value="assign-only",ne.value="",Me.value=null,ft.value="",z.value="",X.value=null,Xe.value="",_.value=null,V.value=null,ke.value=null,Ue.value=""},initCallLogForm:(de=!1)=>{if(qe.value)return;const ie=new Date,Se=ie.getFullYear(),be=String(ie.getMonth()+1).padStart(2,"0"),ge=String(ie.getDate()).padStart(2,"0"),Ae=String(ie.getHours()).padStart(2,"0"),nt=String(ie.getMinutes()).padStart(2,"0");D.value=`${Se}-${be}-${ge}T${Ae}:${nt}`,d!=null&&d.value&&(m.value=d.value),$.value=!0},confirmCallLogForm:()=>{},cancelCallLogForm:()=>{$.value=!1,D.value="",m.value=null},clearSuccessState:()=>{qe.value=null,me.value=null},successState:qe,successPerformedAt:me,qualificationMethod:se,qualificationEventType:ne,qualificationDurationMinutes:ke,qualificationCustomDuration:Ue,qualificationDateRange:Me,qualificationCustomDateStart:ft,qualificationCustomDateEnd:z,availableDatesForRange:Ve,qualificationSelectedDate:X,qualificationSelectedSlot:Xe,setQualificationSelectedSlot:at,qualificationScheduleSlotOptions:Ge,qualificationDurationValue:_e}}function di(l,L,r,p,u,d,x,b,S=null){const{callData:i}=L,{showOutcomeSelection:$,selectedOutcome:D,assignment:m,preferences:h,cancelOutcome:y,calculateNextCallDate:v,showScheduleAppointmentModal:A,surveyCompleted:g,surveyResponses:M,showSurvey:B,initCallLogForm:R,callLogDateTime:J,callLogAssignee:ce,successState:_,successPerformedAt:V,rescheduleTime:F,aiSuggestionData:E,customDate:Q,customTime:oe,qualificationMethod:G,qualificationEventType:$e,qualificationDurationValue:qe,qualificationSelectedDate:me,qualificationSelectedSlot:se,qualificationSelectedTeam:ne,qualificationSelectedSalesman:ke,communicationPreferences:Ue}=r,Me=()=>{var P;return((P=b==null?void 0:b.value)==null?void 0:P.name)||"Unknown"},ft=()=>F.value==="tomorrow-9am"?"Tomorrow 9:00 AM":F.value==="monday"&&E.value?`${E.value.formattedDate} at ${E.value.time}`:F.value==="monday"?"Monday":F.value==="custom"&&Q.value&&oe.value?`${Q.value} ${oe.value}`:"selected time";return{logManualCall:()=>{i.value={channel:"external",notes:"",transcription:null},R(!0)},handleScheduleAppointmentConfirm:async P=>{A.value=!1,l("appointment-scheduled",P)},handleQualify:async()=>{var He,xe,we,Ee,de,ie,Se,be,ge,Ae,nt,rt,Fe,Ze,yt,Gt,ct,Zt,xt,ls,jt,Ke,_t,et,Pe;const P={timestamp:new Date().toISOString(),outcome:"interested",channel:((He=i.value)==null?void 0:He.channel)||"phone",notes:((xe=i.value)==null?void 0:xe.notes)||"",transcription:((we=i.value)==null?void 0:we.transcription)||null};l("call-attempt-logged",P),l("validated",{scheduleFollowUp:!1});let te="Unassigned";G.value==="assign-and-schedule"?ke.value?te=ke.value.name:ne.value&&(te=ne.value.name):te=((de=(Ee=m.value)==null?void 0:Ee.assignee)==null?void 0:de.name)||"Unassigned";let ue=null,he=!1,ve=null;if(G.value==="assign-and-schedule"&&me.value&&se.value){const We=me.value,gt=We.toLocaleDateString(void 0,{month:"long",day:"numeric"}),Ft={"test-drive":"Test Drive","in-store-visit":"In-Store Visit"}[$e.value]||$e.value;he=!0;const ze=We.getFullYear(),ut=String(We.getMonth()+1).padStart(2,"0"),ht=String(We.getDate()).padStart(2,"0"),$t=`${ze}-${ut}-${ht}`;if(ve={datetime:We,date:$t,time:se.value,type:Ft,assignee:te,assigneeId:((ie=ke.value)==null?void 0:ie.id)||((Se=ne.value)==null?void 0:Se.id)||null,assigneeType:ke.value?"user":"team",duration:qe.value,team:((be=ne.value)==null?void 0:be.name)||null,teamId:((ge=ne.value)==null?void 0:ge.id)||null,salesperson:((Ae=ke.value)==null?void 0:Ae.name)||null,salespersonId:((nt=ke.value)==null?void 0:nt.id)||null},ue={date:gt,time:se.value,title:Ft,name:((Fe=(rt=p.value)==null?void 0:rt.customer)==null?void 0:Fe.name)||"",location:te},l("appointment-scheduled",ve),Ue.value){const ot=Ue.value;if((Ze=ot.immediateConfirmation)!=null&&Ze.enabled&&((Gt=(yt=ot.immediateConfirmation)==null?void 0:yt.channels)==null?void 0:Gt.length)>0){for(const vt of ot.immediateConfirmation.channels)if(x&&((ct=p.value)!=null&&ct.id))try{await x.addActivity(p.value.id,{type:vt,user:Me(),action:`sent ${vt} confirmation`,content:`Appointment confirmed: ${Ft} on ${gt} at ${se.value}`,timestamp:new Date().toISOString()})}catch(Nt){console.error(`Failed to log ${vt} confirmation:`,Nt)}}if((Zt=ot.reminder)!=null&&Zt.enabled&&((ls=(xt=ot.reminder)==null?void 0:xt.channels)==null?void 0:ls.length)>0){const vt=new Date(We);vt.setDate(vt.getDate()-1);const Nt=vt.toISOString().split("T")[0];if(x&&((jt=p.value)!=null&&jt.id))try{await x.addActivity(p.value.id,{type:"reminder-scheduled",user:Me(),action:"scheduled reminder",content:`Reminder scheduled for ${Nt} via ${ot.reminder.channels.join(", ")}`,timestamp:new Date().toISOString(),data:{reminderDate:Nt,channels:ot.reminder.channels}})}catch(wt){console.error("Failed to schedule reminder:",wt)}}if((Ke=ot.salespersonNotification)!=null&&Ke.enabled){const vt=((_t=ke.value)==null?void 0:_t.name)||((et=ne.value)==null?void 0:et.name)||"Team";if(x&&((Pe=p.value)!=null&&Pe.id))try{await x.addActivity(p.value.id,{type:"notification",user:Me(),action:"sent notification",content:`Notification sent to ${vt} about appointment`,timestamp:new Date().toISOString()})}catch(Nt){console.error("Failed to send notification:",Nt)}}}}G.value==="assign-and-schedule"&&(ke.value?m.value={...m.value,assignee:{...ke.value,type:"user"},assigneeId:ke.value.id,salesperson:ke.value}:ne.value&&(m.value={...m.value,assignee:{...ne.value,type:"team"},team:ne.value}));const je=G.value==="assign-and-schedule"?{assignee:ke.value||ne.value,salesperson:ke.value||null,team:ne.value||null}:m.value;let Re=null;if(S!=null&&S.value){const We=S.value;Re={interestLevel:We.interestLevel,purchaseTimeline:We.purchaseTimeline,budgetRange:We.budgetRange,hasTradeIn:We.hasTradeIn,tradeInModel:We.tradeInModel,financingOption:We.financingOption,additionalNotes:We.additionalNotes}}else g.value&&M.value&&(Re=M.value);l("qualified",{assignment:je,preferences:h.value,scheduleAppointment:he,appointmentData:ve,surveyData:Re});let Ye=`Qualified - Assigned to ${te}`;ue&&(Ye=`Qualified - Assigned to ${te}, meeting on ${ue.date} ${ue.time}`),_.value={kind:"qualified",statusText:Ye,meeting:ue,actorName:Me()},V.value=new Date,y()},handleDisqualifyFromInterested:()=>{var te,ue,he;const P={timestamp:new Date().toISOString(),outcome:"interested",channel:((te=i.value)==null?void 0:te.channel)||"phone",notes:((ue=i.value)==null?void 0:ue.notes)||"",transcription:((he=i.value)==null?void 0:he.transcription)||null};l("call-attempt-logged",P),D.value="not-valid"},handleNoAnswerConfirm:async()=>{var je,Re,Ye,He;const P={timestamp:new Date().toISOString(),outcome:"no-answer",channel:((je=i.value)==null?void 0:je.channel)||"phone",notes:((Re=i.value)==null?void 0:Re.notes)||"",transcription:((Ye=i.value)==null?void 0:Ye.transcription)||null};l("call-attempt-logged",P);const te=v(),ue=te.split("T")[0],he=new Date(te).toTimeString().slice(0,5);if(x&&((He=p.value)!=null&&He.id))try{await x.updateLead(p.value.id,{nextActionDue:te,status:"Pending"})}catch(xe){console.error('Failed to update lead status to "to be called back":',xe)}l("postponed",{date:ue,time:he,createAppointment:!0}),(u==null?void 0:u.value)+1>=(d==null?void 0:d.value)&&l("disqualified",{category:"Not Interested",reason:"Unreachable"});const ve=ft();_.value={kind:"no-answer",statusText:`Message sent - Rescheduled to ${ve}`,actorName:Me()},V.value=new Date,y()},handleNotValidConfirm:()=>{var te,ue,he;const P={timestamp:new Date().toISOString(),outcome:"not-valid",channel:((te=i.value)==null?void 0:te.channel)||"phone",notes:((ue=i.value)==null?void 0:ue.notes)||"",transcription:((he=i.value)==null?void 0:he.transcription)||null};l("call-attempt-logged",P),l("disqualified",{category:r.disqualifyCategory.value,reason:r.disqualifyReason.value}),_.value={kind:"not-interested",statusText:"Closed - Not interested",reason:r.disqualifyReason.value||null,actorName:Me()},V.value=new Date,y()},handleNoteSave:P=>{r.showNoteModal.value=!1,l("note-saved",P)},handleSurveyCompleted:async P=>{var te;if(M.value=P,g.value=!0,B.value=!1,x&&((te=p.value)!=null&&te.id))try{await x.addActivity(p.value.id,{type:"survey",action:"Lead Qualification Survey",content:JSON.stringify(P),timestamp:new Date().toISOString()})}catch(ue){console.error("Failed to save survey activity:",ue)}l("survey-completed",{lead:p.value,responses:P})},handleSurveyRefused:async()=>{var P;if(B.value=!1,x&&((P=p.value)!=null&&P.id))try{await x.addActivity(p.value.id,{type:"survey",action:"Lead Qualification Survey",content:"Customer refused to complete survey",timestamp:new Date().toISOString()})}catch(te){console.error("Failed to save survey refusal activity:",te)}l("survey-refused",{lead:p.value})},handleNotResponding:async()=>{var P;if(B.value=!1,x&&((P=p.value)!=null&&P.id))try{await x.addActivity(p.value.id,{type:"survey",action:"Lead Qualification Survey",content:"Customer not responding to survey",timestamp:new Date().toISOString()})}catch(te){console.error("Failed to save survey not responding activity:",te)}l("not-responding",{lead:p.value})},handleReopen:()=>{r.clearSuccessState(),r.resetOutcomeState()}}}const ci=["disabled"],mi={__name:"AIButton",props:{label:{type:String,required:!0},size:{type:String,default:"medium",validator:l=>["small","medium"].includes(l)},disabled:{type:Boolean,default:!1}},emits:["click"],setup(l){return(L,r)=>(f(),k("button",{class:ae(["flex items-center gap-2 rounded-lg text-white font-medium transition-all","hover:opacity-90 active:scale-95",l.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer",l.size==="small"?"px-3 py-1.5 text-xs":"px-4 py-2 text-sm"]),disabled:l.disabled,style:{background:"linear-gradient(135deg, #6B21A8, #9333EA, #A855F7)"},onClick:r[0]||(r[0]=p=>L.$emit("click",p))},[s(t(na),{size:l.size==="small"?14:16,class:"text-white shrink-0"},null,8,["size"]),e("span",null,I(l.label),1)],10,ci))}},pi={key:0,class:"flex gap-2 items-center mb-4"},fi={key:1,class:"mb-4 space-y-4"},vi={key:0,class:"bg-slate-900 text-white rounded-lg"},gi={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700"},yi={class:"flex items-center gap-2"},hi={class:"text-xs font-bold uppercase tracking-wider"},bi={class:"flex items-center gap-3"},xi={class:"flex items-center gap-2 text-red-400"},wi={class:"text-xs font-mono"},ki={class:"text-xs font-mono text-red-200"},Si={key:0,class:"p-4 space-y-4"},Ci={key:0,class:"space-y-1"},$i={class:"space-y-3 text-sm font-mono"},Di={class:"ml-2"},Ai={class:"ml-2"},Ti={key:0},Oi={class:"ml-2"},Ii={key:1},Vi={class:"ml-2"},Ni={key:2},Li={class:"ml-2"},Mi={key:1,class:"pt-4 border-t border-slate-700"},qi=["model-value"],Ui={key:1,class:"bg-blue-50 rounded-lg p-4"},_i={class:"flex items-center justify-between"},Fi={class:"flex gap-2"},ol={__name:"CallInterface",props:{isCallActive:{type:Boolean,required:!0},callEnded:{type:Boolean,required:!0},callDuration:{type:Number,required:!0},callNotes:{type:String,required:!0},formattedCallDuration:{type:String,required:!0},mockTranscription:{type:Object,required:!0},contactAttempts:{type:Number,required:!0},maxContactAttempts:{type:Number,required:!0},hideButton:{type:Boolean,default:!1}},emits:["start-call","end-call","log-manual-call","extract-information","update:call-notes","copy-number"],setup(l){const L=l,r=T(!1);return Ce(()=>L.isCallActive,(p,u)=>{if(p&&!u){r.value=!1;return}p||(r.value=!1)}),(p,u)=>(f(),k("div",null,[!l.hideButton&&!l.isCallActive?(f(),k("div",pi,[s(t(ee),{variant:"default",disabled:l.isCallActive,class:"inline-flex items-center gap-2",onClick:u[0]||(u[0]=d=>p.$emit("start-call"))},{default:o(()=>[s(t(Yl),{size:16,class:"shrink-0","aria-hidden":"true"}),C(" "+I(l.contactAttempts>0?"Call Again":"Initiate Call"),1)]),_:1},8,["disabled"])])):q("",!0),l.isCallActive||l.callEnded?(f(),k("div",fi,[l.isCallActive||l.callEnded?(f(),k("div",vi,[e("div",gi,[e("div",yi,[u[6]||(u[6]=e("i",{class:"fa-solid fa-waveform-lines text-blue-400 animate-pulse"},null,-1)),e("span",hi,I(l.isCallActive?"TRANSCRIBING":"CALL SUMMARY"),1)]),e("div",bi,[l.isCallActive?(f(),k(Le,{key:0},[e("div",xi,[u[7]||(u[7]=e("span",{class:"w-2 h-2 bg-red-500 rounded-full animate-pulse"},null,-1)),e("span",wi,"REC "+I(l.formattedCallDuration),1)]),e("button",{onClick:u[1]||(u[1]=d=>p.$emit("end-call")),class:"px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold rounded-lg flex items-center gap-2 transition-colors cursor-pointer"},[...u[8]||(u[8]=[e("i",{class:"fa-solid fa-stop text-xs cursor-pointer"},null,-1),C(" Stop Call ",-1)])]),e("button",{type:"button",class:"flex items-center justify-center px-3 h-8 rounded-btn border border-slate-600 bg-slate-800/80 hover:bg-slate-700 cursor-pointer",onClick:u[2]||(u[2]=d=>r.value=!r.value)},[e("i",{class:ae(["fa-solid text-xs cursor-pointer",r.value?"fa-chevron-up":"fa-chevron-down"])},null,2)])],64)):(f(),k(Le,{key:1},[e("span",ki," Call duration "+I(l.formattedCallDuration),1),e("button",{type:"button",class:"px-3 h-8 rounded-btn border border-slate-600 bg-slate-800/80 hover:bg-slate-700 text-xs font-semibold cursor-pointer",onClick:u[3]||(u[3]=d=>r.value=!r.value)}," See transcription ")],64))])]),r.value?(f(),k("div",Si,[l.callEnded&&!l.isCallActive?(f(),k("div",Ci,[...u[9]||(u[9]=[e("h4",{class:"text-xs font-bold uppercase tracking-wider text-slate-300"},"Summary",-1),e("p",{class:"text-sm text-slate-100"}," Lead confirmed their details and the call covered the main inquiry discussed in the transcript below. ",-1)])])):q("",!0),e("div",$i,[e("div",null,[u[10]||(u[10]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Di,I(l.mockTranscription.leadLines[0]),1)]),e("div",null,[u[11]||(u[11]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",Ai,I(l.mockTranscription.salesLines[0]),1)]),l.callDuration>=5?(f(),k("div",Ti,[u[12]||(u[12]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Oi,I(l.mockTranscription.leadLines[1]),1)])):q("",!0),l.callDuration>=8?(f(),k("div",Ii,[u[13]||(u[13]=e("span",{class:"text-green-400 font-semibold"},"Sales:",-1)),e("span",Vi,I(l.mockTranscription.salesLines[1]),1)])):q("",!0),l.callDuration>=12?(f(),k("div",Ni,[u[14]||(u[14]=e("span",{class:"text-blue-400 font-semibold"},"Lead:",-1)),e("span",Li,I(l.mockTranscription.leadLines[2]),1)])):q("",!0)]),l.isCallActive?(f(),k("div",Mi,[e("textarea",{"model-value":l.callNotes,"onUpdate:modelValue":u[4]||(u[4]=d=>p.$emit("update:call-notes",d)),placeholder:"Add a quick note about this call...",class:"w-full p-3 bg-slate-800 border border-slate-700 rounded-btn text-white text-sm placeholder-gray-500 focus:outline-none focus:border-blue-500 resize-none",rows:"3"},null,8,qi)])):q("",!0)])):q("",!0)])):q("",!0),l.callEnded&&!l.isCallActive?(f(),k("div",Ui,[e("div",_i,[u[15]||(u[15]=e("div",null,[e("h4",{class:"font-bold text-foreground mb-1 text-sm"},"Call Ended"),e("p",{class:"text-xs text-gray-600"},"Extract information from the transcription")],-1)),e("div",Fi,[s(mi,{label:"Extract information",size:"small",onClick:u[5]||(u[5]=d=>p.$emit("extract-information"))})])])])):q("",!0)])):q("",!0)]))}},Ri={class:"flex items-center gap-2.5 min-w-0"},Ei={class:"flex items-center gap-2 min-w-0"},il={__name:"DeadlineBanner",props:{nextActionDue:{type:String,default:null},isClosed:{type:Boolean,default:!1},showDeadlineBanner:{type:Boolean,default:!0},taskId:{type:[String,Number],required:!0}},emits:["dismissed"],setup(l,{emit:L}){const r=l,p=L,u=T(!1),d=w(()=>Hl(r.nextActionDue)),x=w(()=>d.value.type==="overdue"?Bn:d.value.type==="urgent"?va:Bn),b=w(()=>r.isClosed||!r.showDeadlineBanner||u.value?!1:d.value.type==="overdue"||d.value.type==="urgent"),S=()=>{u.value=!0,p("dismissed")};return(i,$)=>b.value?(f(),k("div",{key:0,class:ae(["flex items-center justify-between px-4 py-2 border-b transition-all duration-200",[d.value.bgClass,d.value.borderClass]])},[e("div",Ri,[e("div",{class:ae(["flex items-center justify-center rounded-full w-5 h-5 shrink-0",d.value.type==="overdue"?"bg-red-100":"bg-orange-100"])},[(f(),re(Nn(x.value),{size:12,class:ae(d.value.textClass)},null,8,["class"]))],2),e("div",Ei,[e("span",{class:ae(["text-xs font-bold uppercase tracking-wider",d.value.textClass])},I(d.value.type==="overdue"?"Overdue":"Urgent"),3),$[0]||($[0]=e("span",{class:"text-xs text-muted-foreground opacity-30"},"•",-1)),e("span",{class:ae(["text-xs font-medium truncate",d.value.textClass])}," Next Action: "+I(t(Ql)(l.nextActionDue)),3)])]),e("button",{onClick:S,class:ae(["p-1 rounded-md transition-colors shrink-0",[d.value.textClass,"hover:bg-black/5"]]),title:"Dismiss"},[s(t(Yn),{size:14})],2)],2)):q("",!0)}},ji={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Wi={class:"space-y-4"},Bi={class:"flex items-center gap-3"},Pi={class:"flex items-center gap-3"},zi={class:"text-sm font-medium text-foreground"},rl={__name:"AppointmentCommunications",props:{appointment:{type:Object,required:!0},customer:{type:Object,required:!0},salesperson:{type:Object,default:null},team:{type:Object,default:null},dealership:{type:Object,default:null}},emits:["update"],setup(l,{emit:L}){const r=L,p=[{value:"email",label:"via Email"},{value:"sms",label:"via SMS"},{value:"whatsapp",label:"via WhatsApp"}],u=T({immediateConfirmationEnabled:!0,immediateConfirmationChannels:["email"],reminderEnabled:!0,reminderChannels:["email"],salespersonNotification:!0});return Ce(u,d=>{var b,S;const x={immediateConfirmation:{enabled:d.immediateConfirmationEnabled,channels:d.immediateConfirmationEnabled&&((b=d.immediateConfirmationChannels)==null?void 0:b.length)>0?d.immediateConfirmationChannels:[]},reminder:{enabled:d.reminderEnabled,channels:d.reminderEnabled&&((S=d.reminderChannels)==null?void 0:S.length)>0?d.reminderChannels:[]},salespersonNotification:{enabled:d.salespersonNotification}};r("update",x)},{deep:!0}),(d,x)=>(f(),k("div",ji,[x[7]||(x[7]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Send confirmations and reminders",-1)),e("div",Wi,[e("div",Bi,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"immediate-confirmation",modelValue:u.value.immediateConfirmationEnabled,"onUpdate:modelValue":x[0]||(x[0]=b=>u.value.immediateConfirmationEnabled=b)},null,8,["modelValue"]),x[5]||(x[5]=e("span",{class:"text-sm font-medium text-foreground"},"Send immediate confirmation to customer",-1))]),_:1}),u.value.immediateConfirmationEnabled?(f(),re(t(st),{key:0,modelValue:u.value.immediateConfirmationChannels,"onUpdate:modelValue":x[1]||(x[1]=b=>u.value.immediateConfirmationChannels=b),items:p,multiple:!0,placeholder:"Select channels",class:"w-48"},null,8,["modelValue"])):q("",!0)]),e("div",Pi,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"reminder",modelValue:u.value.reminderEnabled,"onUpdate:modelValue":x[2]||(x[2]=b=>u.value.reminderEnabled=b)},null,8,["modelValue"]),x[6]||(x[6]=e("span",{class:"text-sm font-medium text-foreground"},"Send reminder the day before appointment",-1))]),_:1}),u.value.reminderEnabled?(f(),re(t(st),{key:0,modelValue:u.value.reminderChannels,"onUpdate:modelValue":x[3]||(x[3]=b=>u.value.reminderChannels=b),items:p,multiple:!0,placeholder:"Select channels",class:"w-48"},null,8,["modelValue"])):q("",!0)]),s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors"},{default:o(()=>[s(t(Yt),{id:"salesperson-notification",modelValue:u.value.salespersonNotification,"onUpdate:modelValue":x[4]||(x[4]=b=>u.value.salespersonNotification=b)},null,8,["modelValue"]),e("span",zi," Notify "+I(l.salesperson?l.salesperson.name:l.team?l.team.name:"salesperson")+" about appointment ",1)]),_:1})]),St(d.$slots,"actions")]))}},Yi={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Un={__name:"CloseAsLostForm",props:{showMultipleNoShows:{type:Boolean,default:!1},preselectedReason:{type:String,default:""},closeButtonLabel:{type:String,default:"Close"}},emits:["close","cancel","update:reason"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=T(p.preselectedReason||"");Ce(()=>p.preselectedReason,S=>{S&&(d.value=S)}),Ce(d,S=>{u("update:reason",S)});const x=w(()=>!!d.value);function b(){x.value&&u("close",d.value)}return L({reason:d,canSubmit:x,submit:b}),(S,i)=>(f(),k("div",Yi,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...i[1]||(i[1]=[C("Reason",-1)])]),_:1}),s(t(It),{modelValue:d.value,"onUpdate:modelValue":i[0]||(i[0]=$=>d.value=$)},{default:o(()=>[s(t(At),{class:"w-full"},{default:o(()=>[s(t(Tt),{placeholder:"Select a reason..."})]),_:1}),s(t(Ot),null,{default:o(()=>[l.showMultipleNoShows?(f(),re(t(fe),{key:0,value:"Multiple no shows"},{default:o(()=>[...i[2]||(i[2]=[C("Multiple no shows",-1)])]),_:1})):q("",!0),s(t(fe),{value:"Data cleanup"},{default:o(()=>[...i[3]||(i[3]=[C("Data cleanup",-1)])]),_:1}),s(t(fe),{value:"Unreachable"},{default:o(()=>[...i[4]||(i[4]=[C("Unreachable",-1)])]),_:1}),s(t(fe),{value:"Purchase postponed"},{default:o(()=>[...i[5]||(i[5]=[C("Purchase postponed",-1)])]),_:1}),s(t(fe),{value:"Vehicle sold"},{default:o(()=>[...i[6]||(i[6]=[C("Vehicle sold",-1)])]),_:1}),s(t(fe),{value:"Out of budget"},{default:o(()=>[...i[7]||(i[7]=[C("Out of budget",-1)])]),_:1}),s(t(fe),{value:"Financing rejected"},{default:o(()=>[...i[8]||(i[8]=[C("Financing rejected",-1)])]),_:1}),s(t(fe),{value:"Duplicate"},{default:o(()=>[...i[9]||(i[9]=[C("Duplicate",-1)])]),_:1}),s(t(fe),{value:"Bought elsewhere"},{default:o(()=>[...i[10]||(i[10]=[C("Bought elsewhere",-1)])]),_:1}),s(t(fe),{value:"Not interested"},{default:o(()=>[...i[11]||(i[11]=[C("Not interested",-1)])]),_:1}),s(t(fe),{value:"Budget constraints"},{default:o(()=>[...i[12]||(i[12]=[C("Budget constraints",-1)])]),_:1}),s(t(fe),{value:"Found better price"},{default:o(()=>[...i[13]||(i[13]=[C("Found better price at competitor",-1)])]),_:1}),s(t(fe),{value:"No response"},{default:o(()=>[...i[14]||(i[14]=[C("Customer not responding",-1)])]),_:1}),s(t(fe),{value:"Wrong timing"},{default:o(()=>[...i[15]||(i[15]=[C("Timing not right",-1)])]),_:1}),s(t(fe),{value:"Other"},{default:o(()=>[...i[16]||(i[16]=[C("Other",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])])]))}},Hi={class:"rounded-lg flex flex-col bg-muted"},Qi={class:"pt-1 px-1"},Ji={class:"bg-white rounded-lg p-4 shadow-nsc-card flex flex-col relative"},Gi={class:"flex items-center gap-3"},Zi={class:"size-8 rounded-lg bg-green-100 flex items-center justify-center shrink-0"},Ki={class:"flex-1 pr-10 min-w-0"},Xi={class:"text-sm font-medium text-foreground"},er={key:0,class:"text-sm text-muted-foreground mt-1"},tr={key:0,class:"mt-4 bg-white rounded-lg shadow-nsc-card overflow-hidden"},sr={class:"grid grid-cols-2 gap-3 p-4 text-sm"},nr={class:"ml-2 font-medium text-foreground"},lr={class:"ml-2 font-medium text-foreground"},ar={class:"ml-2 font-medium text-foreground capitalize"},or={class:"ml-2 font-medium text-foreground"},ir={class:"flex justify-end mt-4"},rr={class:"px-4 py-2 flex items-center justify-between text-sm text-muted-foreground"},ur={class:"tabular-nums"},dr={class:"pt-1 px-1"},cr={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},mr={class:"p-4"},pr={class:"flex justify-between items-start mb-3"},fr={class:"text-base leading-normal font-medium text-foreground"},vr={class:"text-sm leading-normal font-normal text-muted-foreground mt-0.5"},gr={key:0,class:"mb-3 bg-muted border border-border rounded-lg p-3"},yr={class:"flex items-center justify-between gap-4 flex-wrap"},hr={key:0,class:"flex items-center gap-2"},br={class:"flex items-center gap-2"},xr={class:"text-sm text-muted-foreground"},wr={key:1,class:"flex items-center gap-2"},kr={class:"text-sm font-semibold text-foreground"},Sr={key:0,class:"text-sm text-orange-600 font-medium flex items-center gap-1 ml-2"},Cr={class:"px-4 py-4 space-y-3"},$r={key:0,class:"space-y-4"},Dr={class:"outcome-toggle-group flex flex-wrap gap-3"},Ar={key:0,class:"space-y-4"},Tr={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Or={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Ir={class:"followup-channel-toggle-group flex flex-wrap gap-2 mb-4"},Vr={key:0,class:"space-y-3"},Nr=["value"],Lr={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Mr={class:"reschedule-toggle-group flex flex-wrap gap-2"},qr={key:0,class:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"},Ur={class:"flex items-start gap-2"},_r={class:"flex-1"},Fr={class:"text-sm font-semibold text-foreground mb-1"},Rr={class:"text-xs text-muted-foreground"},Er={key:1,class:"mt-3 grid grid-cols-2 gap-3"},jr={key:1,class:"space-y-4"},Wr={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Br={key:2,class:"space-y-4"},Pr={class:"bg-white rounded-lg p-4 shadow-nsc-card"},zr={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Yr={class:"space-y-4"},Hr={class:"flex gap-4"},Qr={class:"space-y-2"},Jr={class:"flex items-center gap-2 cursor-pointer"},Gr={class:"flex justify-end gap-2 mt-4"},Zr={class:"bg-white rounded-lg p-4 shadow-nsc-card"},Kr={class:"space-y-2"},Xr={key:0,class:"space-y-4"},eu={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},tu={class:"grid grid-cols-2 gap-4"},su={class:"flex items-center gap-2"},nu={class:"text-muted-foreground"},lu={class:"font-medium text-foreground"},au={class:"flex items-center gap-2"},ou={class:"font-medium text-foreground"},iu={key:1,class:"space-y-4"},ru={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},uu={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},du={class:"grid grid-cols-2 gap-4"},cu={class:"flex items-center gap-2"},mu={class:"text-muted-foreground"},pu={class:"font-medium text-foreground"},fu={class:"flex items-center gap-2"},vu={class:"font-medium text-foreground"},gu={key:1,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},yu={class:"font-semibold text-foreground text-sm mb-4"},hu={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},bu={class:"grid grid-cols-1 md:grid-cols-2 divide-x divide-black/5"},xu={class:"p-6"},wu={class:"flex items-center justify-between mb-4"},ku={class:"text-sm font-semibold text-foreground"},Su={class:"grid grid-cols-7 gap-1 mb-2"},Cu={class:"grid grid-cols-7 gap-1"},$u=["onClick"],Du={class:"p-6"},Au={class:"text-sm font-semibold text-foreground mb-4"},Tu={key:0,class:"schedule-slot-toggle-group flex flex-col gap-2 w-full space-y-2"},Ou={key:1,class:"text-sm text-muted-foreground py-4 text-center"},Iu={key:2,class:"text-sm text-muted-foreground py-4 text-center"},Vu={key:2,class:"bg-blue-50 border border-blue-200 rounded-lg p-6"},Nu={class:"grid grid-cols-2 gap-3 text-sm mb-3"},Lu={class:"ml-2 font-medium text-foreground"},Mu={class:"ml-2 font-medium text-foreground"},qu={class:"ml-2 font-medium text-foreground capitalize"},Uu={class:"ml-2 font-medium text-foreground"},_u={key:1,class:"flex justify-end gap-2 px-4 pb-4 pt-3"},Fu={__name:"LQTask",props:{lead:{type:Object,required:!0},activities:{type:Array,default:()=>[]},showDeadlineBanner:{type:Boolean,default:!0}},emits:["postponed","validated","qualified","disqualified","call-attempt-logged","note-saved","open-purchase-method","appointment-scheduled","survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const{t:r}=Ns(),p=l,u=L,d=Ut(),x=Vt();Ln();const b=Jt(),S=tl(()=>p.lead,{}),i=al(),{isCallActive:$,callEnded:D,callDuration:m,callNotes:h,callData:y,extractedData:v,mockTranscription:A,formattedCallDuration:g,startCall:M,endCall:B,copyNumber:R}=i,J=T(null),ce=T(!1),_=T(!1),V=T(!1),F=T(!1),E=w(()=>d.assignableUsers),Q=w(()=>d.assignableTeams),oe=w(()=>x.currentUser),G=T({interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""}),$e=T(""),qe=T(""),me=T(""),se=T("");w(()=>{var a;const O=new Set;return(a=Q.value)==null||a.forEach(Z=>{Z.dealership&&O.add(Z.dealership)}),Array.from(O).sort()}),w(()=>{var O;return $e.value?((O=Q.value)==null?void 0:O.filter(a=>a.dealership===$e.value))||[]:Q.value||[]}),w(()=>{var a,Z;if(!qe.value)return E.value||[];const O=(a=Q.value)==null?void 0:a.find(N=>N.id===qe.value);return O?((Z=E.value)==null?void 0:Z.filter(N=>N.team===O.name||N.teamId===O.id))||[]:E.value||[]});const ne=O=>O?O.split(" ").map(a=>a[0]).join("").toUpperCase().substring(0,2):"?",ke=O=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[O]||"bg-muted text-muted-foreground",Ue=O=>{Ee.value.assignee=O,O.type==="team"&&(ye.value=null),ce.value=!1};w(()=>!!Zt.value),w(()=>{if(Ke.value)return Ke.value.statusText;const O=p.activities.filter(a=>a.type==="call"||a.type==="outcome").sort((a,Z)=>new Date(Z.timestamp)-new Date(a.timestamp))[0];return O?O.outcome||O.content||"Outcome logged":null});const Me=async()=>{var O;try{const a=G.value,Z=[];if(a.interestLevel&&Z.push(`Interest level: ${a.interestLevel}`),a.purchaseTimeline&&Z.push(`Purchase timeline: ${a.purchaseTimeline}`),a.budgetRange&&Z.push(`Budget range: ${a.budgetRange}`),a.hasTradeIn&&a.tradeInModel&&Z.push(`Trade-in: ${a.tradeInModel}`),a.financingOption){const Ie={FIN:"Captive Financing",LEA:"Leasing",LTR:"Long-Term Rental"};Z.push(`Financing: ${Ie[a.financingOption]||a.financingOption}`)}a.additionalNotes&&Z.push(a.additionalNotes);const N=Z.join(`
`);if(N.trim()&&(await b.addActivity(p.lead.id,{type:"note",user:((O=oe.value)==null?void 0:O.name)||"You",action:"enriched lead information",content:N,timestamp:new Date().toISOString()}),u("note-saved",{type:"note",content:N,timestamp:new Date().toISOString(),enrichData:{...a}})),a.interestLevel||a.purchaseTimeline||a.budgetRange){const Ie={interestLevel:a.interestLevel,purchaseTimeline:a.purchaseTimeline,budgetRange:a.budgetRange};await b.addActivity(p.lead.id,{type:"survey",action:"Lead Qualification Survey",content:JSON.stringify(Ie),timestamp:new Date().toISOString()}),u("survey-completed",{lead:p.lead,responses:Ie})}G.value={interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""}}catch(a){console.error("Error saving enriched lead data:",a)}},ft=()=>{M(),jt(!1)},z=()=>{R(p.lead.customer.phone)},X=O=>{h.value=O},Xe=w(()=>{var O;return((O=S.primaryAction.value)==null?void 0:O.title)||"Call to Verify Contact Details"}),at=w(()=>{var O;return((O=S.primaryAction.value)==null?void 0:O.description)||"Begin lead qualification by verifying customer contact information."}),Ge=w(()=>p.lead.scheduledAppointment?new Date(p.lead.scheduledAppointment.start)<new Date:!1),_e=w(()=>!!p.lead.scheduledAppointment),Ve=w(()=>_e.value?{text:"Follow-up Scheduled",class:"bg-blue-100 text-blue-700"}:Ge.value?{text:"Overdue",class:"bg-red-100 text-red-700"}:{text:p.lead.nextActionDue?`Task Pending - Due ${Jl(p.lead.nextActionDue)}`:"Task Pending",class:"bg-orange-100 text-orange-700"}),j=S.contactAttempts,W=S.maxContactAttempts,pe=ui(Cs(p,"lead"),y,v,j,W,oe),{showOutcomeSelection:K,selectedOutcome:P,showNoteModal:te,showScheduleAppointmentModal:ue,followupChannels:he,followupChannel:ve,selectedTemplate:je,rescheduleTime:Re,customDate:Ye,customTime:He,disqualifyCategory:xe,disqualifyReason:we,assignment:Ee,preferences:de,messageTemplates:ie,messagePreview:Se,hasExistingAppointment:be,selectOutcome:ge,cancelOutcome:Ae,calculateNextCallDate:nt,surveyCompleted:rt,surveyResponses:Fe,showSurvey:Ze,aiSuggestionData:yt,handleAISuggestionClick:Gt,callLogDateTime:ct,callLogAssignee:Zt,confirmCallLogForm:xt,cancelCallLogForm:ls,initCallLogForm:jt,successState:Ke,successPerformedAt:_t,qualificationMethod:et,qualificationEventType:Pe,qualificationDurationMinutes:We,qualificationCustomDuration:gt,qualificationCalendarMonth:Ft,qualificationSelectedDate:ze,qualificationSelectedSlot:ut,setQualificationSelectedSlot:ht,qualificationDateRange:$t,qualificationCustomDateStart:ot,qualificationCustomDateEnd:vt,availableDatesForRange:Nt,qualificationScheduleSlotOptions:wt,qualificationDurationValue:as,qualificationSelectedTeam:De,qualificationSelectedSalesman:ye,suggestedTeam:qs,communicationPreferences:Xs}=pe;function Wt(O){ve.value=O}function os(O){if(!O){Re.value=null;return}O==="monday"?Gt():Re.value=O}function en(O){we.value=O}const tn=O=>{Xs.value=O},is=w(()=>{if(!ze.value)return[];const O=ze.value.toISOString().split("T")[0];if(ye.value){const a=Ht(`user-${ye.value.id}`,O);return wt.value.filter(Z=>a.includes(Z))}if(De.value){const a=Ht(`team-${De.value.id}`,O);return wt.value.filter(Z=>a.includes(Z))}return wt.value||[]});Ce(ze,()=>{ut.value=""}),w(()=>p.activities.filter(O=>O.type==="note"));const rs=w(()=>(Q.value||[]).slice(0,3)),sn=w(()=>{if(!Q.value)return[];const O=[...Q.value];if(De.value){const a=O.findIndex(Z=>Z.id===De.value.id);if(a>0){const Z=O.splice(a,1)[0];O.unshift(Z)}}return O}),Us=w(()=>sn.value.map(O=>({...O,label:`${O.dealership||"No location"} → ${O.name}`,value:O.id}))),Kt=w(()=>{var Z;if(!De.value)return[];const O=De.value;return(((Z=E.value)==null?void 0:Z.filter(N=>N.team===O.name||N.teamId===O.id))||[]).map(N=>({...N,label:N.name,value:N.id}))}),Xt=w({get:()=>{var O;return((O=De.value)==null?void 0:O.id)||null},set:O=>{var Z;if(!O){De.value=null;return}const a=(Z=Q.value)==null?void 0:Z.find(N=>N.id===O);De.value=a||null}}),Bt=w({get:()=>{var O;return((O=ye.value)==null?void 0:O.id)||null},set:O=>{if(!O){ye.value=null;return}const a=Kt.value.find(Z=>Z.id===O);ye.value=a||null}});function _s(){if(!Pe.value||De.value)return;const O=Q.value;if(!(O!=null&&O.length))return;const a=qs.value;if(a){const Z=O.find(N=>N.id===a.id);if(Z){De.value=Z;return}}if(p.lead.assignee){const Z=O.find(N=>N.name===p.lead.assignee);Z&&(De.value=Z)}}Ce(()=>[Pe.value,qs.value,(Q.value??[]).length,p.lead.assignee],()=>{_s()},{immediate:!0}),Ce(()=>Pe.value&&!De.value,O=>{O&&Ol(_s)},{immediate:!0}),Ce(Pe,O=>{if(O&&!ze.value){const a=new Date;a.setHours(0,0,0,0),ze.value=a,mt.value=a.getMonth(),kt.value=a.getFullYear(),ut.value=""}},{immediate:!0}),Ce(P,O=>{var a,Z,N;if(O==="interested"&&et.value==="assign-only"&&!((a=Ee.value)!=null&&a.assignee))if(p.lead.assignee){const Oe=(Z=E.value)==null?void 0:Z.find(Rt=>Rt.name===p.lead.assignee),Ie=(N=Q.value)==null?void 0:N.find(Rt=>Rt.name===p.lead.assignee);Oe?Ee.value={...Ee.value,assignee:{...Oe,type:"user"}}:Ie&&(Ee.value={...Ee.value,assignee:{...Ie,type:"team"}})}else rs.value.length>0&&(Ee.value={...Ee.value,assignee:{...rs.value[0],type:"team"}})}),Ce(()=>{var O;return(O=Ee.value)==null?void 0:O.assignee},O=>{(O==null?void 0:O.type)!=="team"&&(ye.value=null)}),Ce(De,O=>{ye.value=null,O&&Pe.value&&us(`team-${O.id}`)}),Ce(ye,O=>{O?us(`user-${O.id}`):De.value&&us(`team-${De.value.id}`)}),Ce(ze,()=>{ut.value=""});const us=O=>{const a=new Date;a.setHours(0,0,0,0);for(let Z=0;Z<30;Z++){const N=new Date(a);if(N.setDate(a.getDate()+Z),N.getDay()===0||N.getDay()===6)continue;const Oe=N.toISOString().split("T")[0],Ie=Ht(O,Oe);if(Ie&&Ie.length>0){ze.value=N,mt.value=N.getMonth(),kt.value=N.getFullYear(),setTimeout(()=>{const Rt=wt.value.filter(Sn=>Ie.includes(Sn));Rt.length>0&&(ut.value=Rt[0])},0);break}}},ds=w(()=>!(P.value!=="no-answer"||!ve.value||ve.value!=="dont-send"&&!je.value||!Re.value||Re.value==="custom"&&(!Ye.value||!He.value)));Ce(P,O=>{O!=="interested"&&(G.value={interestLevel:"",purchaseTimeline:"",budgetRange:"",hasTradeIn:!1,tradeInModel:"",financingOption:"",additionalNotes:""},$e.value="",qe.value="",me.value="")}),Ce(me,O=>{var a,Z;if(O){const N=(a=E.value)==null?void 0:a.find(Oe=>Oe.id===O);if(N){const Oe=(Z=Q.value)==null?void 0:Z.find(Ie=>Ie.name===N.team||Ie.id===N.teamId);Oe&&(qe.value=Oe.id,Oe.dealership&&($e.value=Oe.dealership))}}}),Ce(qe,O=>{var a,Z;if(O&&me.value){const N=(a=E.value)==null?void 0:a.find(Ie=>Ie.id===me.value),Oe=(Z=Q.value)==null?void 0:Z.find(Ie=>Ie.id===O);N&&Oe&&N.team!==Oe.name&&N.teamId!==Oe.id&&(me.value="")}}),Ce($e,O=>{var a;if(O&&qe.value){const Z=(a=Q.value)==null?void 0:a.find(N=>N.id===qe.value);Z&&Z.dealership!==O&&(qe.value="",me.value="")}}),Ce(D,O=>{O&&!Ke.value&&jt(!1)});const nn=[{value:"appointment-on-phone",label:"Appointment on the phone (15m)"},{value:"appointment-at-dealership",label:"Appointment at the dealership (30m)"},{value:"recall-internal",label:"Recall - internal (15m)"},{value:"appointment-at-dealership-test-drive",label:"Appointment at the dealership + Test drive (1h)"},{value:"appointment-at-workshop",label:"Appointment at the workshop (15m)"},{value:"appointment-at-customer-site",label:"Appointment at customer's site (1h 40m)"},{value:"appointment-at-customer-site-test-drive",label:"Appointment at customer's site + Test drive (5h)"}],ln=w(()=>nn.map(O=>({value:O.value,label:O.label}))),mt=T(new Date().getMonth()),kt=T(new Date().getFullYear()),Fs=["MON","TUE","WED","THU","FRI","SAT","SUN"],an=w(()=>new Date(kt.value,mt.value).toLocaleDateString("en-US",{month:"long",year:"numeric"})),es=w(()=>{const O=new Date(kt.value,mt.value,1),Z=new Date(kt.value,mt.value+1,0).getDate(),N=O.getDay()===0?6:O.getDay()-1,Oe=[];for(let Ie=0;Ie<N;Ie++)Oe.push(null);for(let Ie=1;Ie<=Z;Ie++)Oe.push(Ie);return Oe}),on=w(()=>{if(!ze.value)return r("forms.schedule.timeSlots.selectDate");const O=ze.value,a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],Z=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${a[O.getDay()]}, ${Z[O.getMonth()]} ${O.getDate()}`}),rn=O=>{if(!O||!ze.value)return!1;const a=ze.value;return a.getDate()===O&&a.getMonth()===mt.value&&a.getFullYear()===kt.value},Rs=O=>{if(!O)return;const a=new Date(kt.value,mt.value,O);ze.value=a,ut.value=""},un=()=>{mt.value===0?(mt.value=11,kt.value--):mt.value--},dn=()=>{mt.value===11?(mt.value=0,kt.value++):mt.value++},cn={"appointment-on-phone":15,"appointment-at-dealership":30,"recall-internal":15,"appointment-at-dealership-test-drive":60,"appointment-at-workshop":15,"appointment-at-customer-site":100,"appointment-at-customer-site-test-drive":300},cs=O=>{We.value=O,gt.value=""};Ce(gt,O=>{O&&(We.value=null)}),Ce(Pe,O=>{if(!O)return;const a=cn[O];a&&(a===15?cs(15):a===30?cs(30):a===60?cs(60):(We.value=null,gt.value=a.toString()))});const mn=w(()=>et.value==="assign-only"?!!(Pe.value&&De.value):!!(Pe.value&&as.value&&ze.value&&ut.value&&De.value)),pn=w(()=>!!we.value);function Es(O){we.value=O,xe.value||(xe.value="Not Valid"),ms()}const fn=w(()=>P.value==="no-answer"?ve.value==="dont-send"?"Postpone":"Send and postpone":P.value==="not-valid"?xe.value?`Close as ${xe.value}`:"Close":P.value==="interested"?"Schedule and qualify":""),vn=w(()=>P.value==="no-answer"?ds.value:P.value==="not-valid"?pn.value:P.value==="interested"?mn.value:!1),js=()=>{P.value==="no-answer"?Bs():P.value==="not-valid"?ms():P.value==="interested"&&hn()},Ws=di(u,i,pe,Cs(p,"lead"),j,W,b,oe,G),{logManualCall:gn,handleScheduleAppointmentConfirm:yn,handleQualify:hn,handleNoAnswerConfirm:Bs,handleNotValidConfirm:ms,handleNoteSave:bn,handleReopen:Ps}=Ws,xn=w(()=>{if(!_t.value)return"";const O=_t.value,a=String(O.getDate()).padStart(2,"0"),Z=String(O.getMonth()+1).padStart(2,"0"),N=String(O.getFullYear()),Oe=String(O.getHours()).padStart(2,"0"),Ie=String(O.getMinutes()).padStart(2,"0");return`${a}/${Z}/${N} ${Oe}:${Ie}`}),{saveTradeInVehicle:wn}=Gl(),zs=async O=>{var a,Z,N;try{_.value=!1,de.value.financing=!0;const Oe=O.type==="FIN"?"Captive Financing":O.type==="LEA"?"Leasing":"Long-Term Rental",Ie=((a=O.fields)==null?void 0:a.monthlyInstalment)||0;await b.addActivity(p.lead.id,{type:"purchase-method",user:((Z=oe.value)==null?void 0:Z.name)||"You",action:`added a ${Oe} purchase method`,content:`${Oe}: €${Ie.toLocaleString()}/month for ${((N=O.fields)==null?void 0:N.duration)||0} months`,data:{purchaseMethodId:O.id,type:O.type,...O.fields},timestamp:new Date().toISOString()}),u("note-saved",{type:"purchase-method",...O})}catch(Oe){console.error("Error saving purchase method:",Oe)}},kn=async O=>{try{if(V.value=!1,O.vehicleType==="tradein"||p.mode==="tradein"){const a=await wn("lead",p.lead.id,O.vehicle,O.valuation||{});de.value.tradeIn=!0,u("note-saved",{type:"tradein",id:a.activity.id,action:"added a trade-in",vehicleId:a.vehicle.id,data:a.activity.data,timestamp:a.activity.timestamp})}else{const{addVehicleToCustomer:a}=await ns(async()=>{const{addVehicleToCustomer:Z}=await import("./contacts-CvrS-If3.js");return{addVehicleToCustomer:Z}},__vite__mapDeps([0,1,2]));await a(p.lead.customerId,O.vehicle),u("note-saved",{type:"vehicle",vehicleType:O.vehicleType,...O.vehicle})}}catch(a){console.error("Error saving vehicle:",a)}};return(O,a)=>{var Z;return f(),k("div",Hi,[t(Ke)?(f(),k(Le,{key:0},[e("div",Qi,[e("div",Ji,[e("div",Gi,[e("div",Zi,[s(t(Pn),{size:16,class:"text-green-600"})]),e("div",Ki,[e("p",Xi,I(t(Ke).statusText),1),t(Ke).reason?(f(),k("p",er,I(t(Ke).reason),1)):q("",!0)])]),t(Ke).meeting?(f(),k("div",tr,[e("div",sr,[e("div",null,[a[42]||(a[42]=e("span",{class:"text-muted-foreground"},"Date:",-1)),e("span",nr,I(t(Ke).meeting.date),1)]),e("div",null,[a[43]||(a[43]=e("span",{class:"text-muted-foreground"},"Time:",-1)),e("span",lr,I(t(Ke).meeting.time),1)]),e("div",null,[a[44]||(a[44]=e("span",{class:"text-muted-foreground"},"Type:",-1)),e("span",ar,I(t(Ke).meeting.title),1)]),e("div",null,[a[45]||(a[45]=e("span",{class:"text-muted-foreground"},"Assigned to:",-1)),e("span",or,I(t(Ke).meeting.location),1)])])])):q("",!0),e("div",ir,[s(t(ee),{variant:"outline",size:"small",class:"flex items-center gap-2 cursor-pointer",onClick:t(Ps)},{default:o(()=>[s(t(pa),{size:14}),a[46]||(a[46]=C(" Re-open ",-1))]),_:1},8,["onClick"])])])]),e("div",rr,[e("span",null,"Updated by "+I(t(Ke).actorName||"Unknown"),1),e("span",ur,I(xn.value),1)])],64)):(f(),k(Le,{key:1},[e("div",dr,[e("div",cr,[s(il,{"next-action-due":l.lead.nextActionDue,"show-deadline-banner":l.showDeadlineBanner,"task-id":l.lead.id},null,8,["next-action-due","show-deadline-banner","task-id"]),e("div",mr,[e("div",pr,[e("div",null,[e("h4",fr,I(Xe.value),1),e("p",vr,I(at.value),1)]),e("div",{class:ae(["flex items-center gap-2 px-2 py-1 rounded-btn text-sm font-semibold",Ve.value.class])},I(Ve.value.text),3)]),_e.value||t(j)>0?(f(),k("div",gr,[e("div",yr,[_e.value?(f(),k("div",hr,[a[48]||(a[48]=e("i",{class:"fa-solid fa-calendar-check text-blue-600 text-sm"},null,-1)),e("div",br,[a[47]||(a[47]=e("span",{class:"text-sm font-semibold text-foreground"},"Scheduled Follow-up Call:",-1)),e("span",xr,I(t(zt)(l.lead.scheduledAppointment.start))+" at "+I(t(Ss)(l.lead.scheduledAppointment.start)),1)])])):q("",!0),t(j)>0?(f(),k("div",wr,[a[50]||(a[50]=e("i",{class:"fa-solid fa-phone text-muted-foreground text-sm"},null,-1)),a[51]||(a[51]=e("span",{class:"text-sm font-semibold text-muted-foreground"},"Contact Attempts:",-1)),e("span",kr,I(t(j))+" / "+I(t(W)),1),t(j)>=t(W)-1?(f(),k("div",Sr,[...a[49]||(a[49]=[e("i",{class:"fa-solid fa-exclamation-triangle"},null,-1),e("span",null,"One more attempt before auto-disqualification",-1)])])):q("",!0)])):q("",!0)])])):q("",!0),s(ol,{"is-call-active":t($),"call-ended":t(D),"call-duration":t(m),"call-notes":t(h),"formatted-call-duration":t(g),"mock-transcription":t(A),"contact-attempts":t(j),"max-contact-attempts":t(W),onStartCall:ft,onEndCall:t(B),onLogManualCall:t(gn),onExtractInformation:a[0]||(a[0]=N=>F.value=!0),"onUpdate:callNotes":X,onCopyNumber:z},null,8,["is-call-active","call-ended","call-duration","call-notes","formatted-call-duration","mock-transcription","contact-attempts","max-contact-attempts","onEndCall","onLogManualCall"])])])]),e("div",Cr,[t(Ke)?q("",!0):(f(),k("div",$r,[e("div",null,[a[55]||(a[55]=e("p",{class:"text-sm font-medium text-foreground leading-normal mb-3"},"Log what is happening?",-1)),e("div",Dr,[s(t(Be),{variant:"outline","model-value":t(P)==="no-answer","onUpdate:modelValue":a[1]||(a[1]=N=>t(ge)(N?"no-answer":null)),class:"outcome-toggle-item"},{default:o(()=>[s(t(ma),{size:18,class:"shrink-0"}),a[52]||(a[52]=e("span",null,"No answer",-1))]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(P)==="not-valid","onUpdate:modelValue":a[2]||(a[2]=N=>t(ge)(N?"not-valid":null)),class:"outcome-toggle-item"},{default:o(()=>[s(t(fa),{size:18,class:"shrink-0"}),a[53]||(a[53]=e("span",null,"Not valid",-1))]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(P)==="interested","onUpdate:modelValue":a[3]||(a[3]=N=>t(ge)(N?"interested":null)),class:"outcome-toggle-item"},{default:o(()=>[s(t(Pn),{size:18,class:"shrink-0"}),a[54]||(a[54]=e("span",null,"Interested",-1))]),_:1},8,["model-value"])])]),t(P)==="no-answer"?(f(),k("div",Ar,[e("div",Tr,[s(t(H),{class:"form-label"},{default:o(()=>[...a[56]||(a[56]=[C("When did you call?",-1)])]),_:1}),s(t(tt),{type:"datetime-local",modelValue:t(ct),"onUpdate:modelValue":a[4]||(a[4]=N=>Mt(ct)?ct.value=N:null),class:"w-full"},null,8,["modelValue"])]),e("div",Or,[a[65]||(a[65]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Send follow-up message",-1)),e("div",Ir,[s(t(Be),{variant:"outline","model-value":t(ve)==="whatsapp","onUpdate:modelValue":a[5]||(a[5]=N=>N&&Wt("whatsapp")),class:"followup-toggle-item"},{default:o(()=>[...a[57]||(a[57]=[e("i",{class:"fa-brands fa-whatsapp text-xs"},null,-1),e("span",null,"WhatsApp",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(ve)==="sms","onUpdate:modelValue":a[6]||(a[6]=N=>N&&Wt("sms")),class:"followup-toggle-item"},{default:o(()=>[...a[58]||(a[58]=[e("i",{class:"fa-solid fa-message text-xs"},null,-1),e("span",null,"SMS",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(ve)==="email","onUpdate:modelValue":a[7]||(a[7]=N=>N&&Wt("email")),class:"followup-toggle-item"},{default:o(()=>[...a[59]||(a[59]=[e("i",{class:"fa-solid fa-envelope text-xs"},null,-1),e("span",null,"Email",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(ve)==="dont-send","onUpdate:modelValue":a[8]||(a[8]=N=>N&&Wt("dont-send")),class:"followup-toggle-item"},{default:o(()=>[...a[60]||(a[60]=[e("i",{class:"fa-solid fa-xmark text-xs"},null,-1),e("span",null,"Don't send",-1)])]),_:1},8,["model-value"])]),t(ve)&&t(ve)!=="dont-send"?(f(),k("div",Vr,[e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[61]||(a[61]=[C("Template",-1)])]),_:1}),s(t(It),{modelValue:t(je),"onUpdate:modelValue":a[9]||(a[9]=N=>Mt(je)?je.value=N:null)},{default:o(()=>[s(t(At),{class:"w-full h-10 min-h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select template"})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"followup-1"},{default:o(()=>[...a[62]||(a[62]=[C("Follow-up 1",-1)])]),_:1}),s(t(fe),{value:"followup-2"},{default:o(()=>[...a[63]||(a[63]=[C("Follow-up 2",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[64]||(a[64]=[C("Message preview",-1)])]),_:1}),e("textarea",{value:t(Se),rows:"4",class:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm text-muted-foreground bg-white resize-none",readonly:""},null,8,Nr)])])):q("",!0)]),e("div",Lr,[a[72]||(a[72]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Next call attempt",-1)),e("div",Mr,[s(t(Be),{variant:"outline","model-value":t(Re)==="tomorrow-9am","onUpdate:modelValue":a[10]||(a[10]=N=>N&&os("tomorrow-9am")),class:"followup-toggle-item"},{default:o(()=>[...a[66]||(a[66]=[C(" Tomorrow 9:00 AM ",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(Re)==="monday","onUpdate:modelValue":a[11]||(a[11]=N=>N&&os("monday")),class:"followup-toggle-item"},{default:o(()=>[...a[67]||(a[67]=[e("i",{class:"fa-solid fa-sparkles text-xs"},null,-1),C(" AI suggestion ",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":t(Re)==="custom","onUpdate:modelValue":a[12]||(a[12]=N=>N&&os("custom")),class:"followup-toggle-item"},{default:o(()=>[...a[68]||(a[68]=[C(" Select time ",-1)])]),_:1},8,["model-value"])]),t(Re)==="monday"&&t(yt)?(f(),k("div",qr,[e("div",Ur,[a[69]||(a[69]=e("i",{class:"fa-solid fa-lightbulb text-blue-600 text-sm mt-0.5"},null,-1)),e("div",_r,[e("p",Fr,I(t(yt).formattedDate)+" at "+I(t(yt).time),1),e("p",Rr,I(t(yt).reason),1)])])])):q("",!0),t(Re)==="custom"?(f(),k("div",Er,[e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[70]||(a[70]=[C("Date",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:t(Ye),"onUpdate:modelValue":a[13]||(a[13]=N=>Mt(Ye)?Ye.value=N:null),class:"w-full"},null,8,["modelValue"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[71]||(a[71]=[C("Time",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:t(He),"onUpdate:modelValue":a[14]||(a[14]=N=>Mt(He)?He.value=N:null),class:"w-full"},null,8,["modelValue"])])])):q("",!0)])])):q("",!0),t(P)==="not-valid"?(f(),k("div",jr,[e("div",Wr,[s(t(H),{class:"form-label"},{default:o(()=>[...a[73]||(a[73]=[C("When did you call?",-1)])]),_:1}),s(t(tt),{type:"datetime-local",modelValue:t(ct),"onUpdate:modelValue":a[15]||(a[15]=N=>Mt(ct)?ct.value=N:null),class:"w-full"},null,8,["modelValue"])]),s(Un,{"preselected-reason":t(we),"close-button-label":"Close as not valid",onClose:Es,onCancel:t(Ae),"onUpdate:reason":en},null,8,["preselected-reason","onCancel"])])):q("",!0),t(P)==="interested"?(f(),k("div",Br,[a[119]||(a[119]=e("div",{class:"text-xs text-muted-foreground px-2"},[e("span",{class:"text-red-600"},"*"),C(" Required fields ")],-1)),e("div",Pr,[s(t(H),{class:"form-label"},{default:o(()=>[...a[74]||(a[74]=[C("When did you call?",-1)])]),_:1}),s(t(tt),{type:"datetime-local",modelValue:t(ct),"onUpdate:modelValue":a[16]||(a[16]=N=>Mt(ct)?ct.value=N:null),class:"w-full"},null,8,["modelValue"])]),e("div",zr,[a[97]||(a[97]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Enrich lead",-1)),e("div",Yr,[e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[75]||(a[75]=[C("Customer interest level?",-1)])]),_:1}),e("div",Hr,[s(t(H),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[lt(e("input",{type:"radio","onUpdate:modelValue":a[17]||(a[17]=N=>G.value.interestLevel=N),value:"High",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[bt,G.value.interestLevel]]),a[76]||(a[76]=e("span",{class:"text-sm text-muted-foreground"},"High",-1))]),_:1}),s(t(H),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[lt(e("input",{type:"radio","onUpdate:modelValue":a[18]||(a[18]=N=>G.value.interestLevel=N),value:"Medium",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[bt,G.value.interestLevel]]),a[77]||(a[77]=e("span",{class:"text-sm text-muted-foreground"},"Medium",-1))]),_:1}),s(t(H),{class:"flex items-center gap-2 cursor-pointer"},{default:o(()=>[lt(e("input",{type:"radio","onUpdate:modelValue":a[19]||(a[19]=N=>G.value.interestLevel=N),value:"Low",class:"w-4 h-4 text-brand-blue focus:ring-brand-blue border-gray-300"},null,512),[[bt,G.value.interestLevel]]),a[78]||(a[78]=e("span",{class:"text-sm text-muted-foreground"},"Low",-1))]),_:1})])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[79]||(a[79]=[C("Expected purchase timeline?",-1)])]),_:1}),s(t(It),{modelValue:G.value.purchaseTimeline,"onUpdate:modelValue":a[20]||(a[20]=N=>G.value.purchaseTimeline=N)},{default:o(()=>[s(t(At),{class:"w-full h-10 min-h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select timeline"})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Immediate"},{default:o(()=>[...a[80]||(a[80]=[C("Immediate",-1)])]),_:1}),s(t(fe),{value:"Within 1 month"},{default:o(()=>[...a[81]||(a[81]=[C("Within 1 month",-1)])]),_:1}),s(t(fe),{value:"Within 3 months"},{default:o(()=>[...a[82]||(a[82]=[C("Within 3 months",-1)])]),_:1}),s(t(fe),{value:"Within 6 months"},{default:o(()=>[...a[83]||(a[83]=[C("Within 6 months",-1)])]),_:1}),s(t(fe),{value:"Just browsing"},{default:o(()=>[...a[84]||(a[84]=[C("Just browsing",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[85]||(a[85]=[C("Budget range (if discussed)?",-1)])]),_:1}),s(t(It),{modelValue:G.value.budgetRange,"onUpdate:modelValue":a[21]||(a[21]=N=>G.value.budgetRange=N)},{default:o(()=>[s(t(At),{class:"w-full h-10 min-h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select budget range"})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Under €30k"},{default:o(()=>[...a[86]||(a[86]=[C("Under €30k",-1)])]),_:1}),s(t(fe),{value:"€30k-€50k"},{default:o(()=>[...a[87]||(a[87]=[C("€30k-€50k",-1)])]),_:1}),s(t(fe),{value:"€50k-€80k"},{default:o(()=>[...a[88]||(a[88]=[C("€50k-€80k",-1)])]),_:1}),s(t(fe),{value:"€80k+"},{default:o(()=>[...a[89]||(a[89]=[C("€80k+",-1)])]),_:1}),s(t(fe),{value:"Not discussed"},{default:o(()=>[...a[90]||(a[90]=[C("Not discussed",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",Qr,[e("label",Jr,[lt(e("input",{type:"checkbox","onUpdate:modelValue":a[22]||(a[22]=N=>G.value.hasTradeIn=N),class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,512),[[In,G.value.hasTradeIn]]),a[91]||(a[91]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Trade in?",-1))]),s(t(tt),{modelValue:G.value.tradeInModel,"onUpdate:modelValue":a[23]||(a[23]=N=>G.value.tradeInModel=N),disabled:!G.value.hasTradeIn,placeholder:"Car brand and model",class:"w-full h-10 min-h-10"},null,8,["modelValue","disabled"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[92]||(a[92]=[C("Financing?",-1)])]),_:1}),s(t(It),{modelValue:G.value.financingOption,"onUpdate:modelValue":a[24]||(a[24]=N=>G.value.financingOption=N)},{default:o(()=>[s(t(At),{class:"w-full h-10 min-h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select financing option"})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"FIN"},{default:o(()=>[...a[93]||(a[93]=[C("Captive Financing",-1)])]),_:1}),s(t(fe),{value:"LEA"},{default:o(()=>[...a[94]||(a[94]=[C("Leasing",-1)])]),_:1}),s(t(fe),{value:"LTR"},{default:o(()=>[...a[95]||(a[95]=[C("Long-Term Rental",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[96]||(a[96]=[C("Additional notes",-1)])]),_:1}),s(t(dt),{modelValue:G.value.additionalNotes,"onUpdate:modelValue":a[25]||(a[25]=N=>G.value.additionalNotes=N),rows:"4",class:"w-full",placeholder:"Any relevant information about customer interest or preferences..."},null,8,["modelValue"])])]),e("div",Gr,[s(t(ee),{label:"Save",variant:"primary",size:"small",onClick:Me})])]),e("div",Zr,[a[100]||(a[100]=e("h5",{class:"font-semibold text-foreground text-sm mb-3"},[C("Qualification method "),e("span",{class:"text-red-600"},"*")],-1)),e("div",Kr,[e("label",{class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",t(et)==="assign-only"?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":a[26]||(a[26]=N=>Mt(et)?et.value=N:null),type:"radio",value:"assign-only",class:"shrink-0"},null,512),[[bt,t(et)]]),a[98]||(a[98]=e("span",{class:"text-sm text-foreground"},"Assign only",-1))],2),e("label",{class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",t(et)==="assign-and-schedule"?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":a[27]||(a[27]=N=>Mt(et)?et.value=N:null),type:"radio",value:"assign-and-schedule",class:"shrink-0"},null,512),[[bt,t(et)]]),a[99]||(a[99]=e("span",{class:"text-sm text-foreground"},"Assign and schedule",-1))],2)])]),t(et)==="assign-only"?(f(),k("div",Xr,[e("div",eu,[a[105]||(a[105]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",tu,[e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[101]||(a[101]=[C("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:Xt.value,"onUpdate:modelValue":a[28]||(a[28]=N=>Xt.value=N),items:Us.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:N})=>[e("div",su,[e("span",nu,I(N.dealership||"No location"),1),a[102]||(a[102]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",lu,I(N.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[103]||(a[103]=[C("Salesperson ",-1),e("span",{class:"optional"},"(optional)",-1)])]),_:1}),s(t(st),{modelValue:Bt.value,"onUpdate:modelValue":a[29]||(a[29]=N=>Bt.value=N),items:Kt.value,disabled:!t(De),placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:N})=>[e("div",au,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",ke(N.role)])},I(ne(N.name)),3),e("span",ou,I(N.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[104]||(a[104]=[C("Notes for assignee",-1)])]),_:1}),s(t(dt),{modelValue:se.value,"onUpdate:modelValue":a[30]||(a[30]=N=>se.value=N),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])])):q("",!0),t(et)==="assign-and-schedule"?(f(),k("div",iu,[e("div",ru,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...a[106]||(a[106]=[C("Event type ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:t(Pe),"onUpdate:modelValue":a[31]||(a[31]=N=>Mt(Pe)?Pe.value=N:null),items:ln.value,placeholder:t(r)("forms.schedule.eventType.placeholder"),"value-key":"value",class:"w-full"},{item:o(({item:N})=>[e("span",null,I(N.label),1)]),_:1},8,["modelValue","items","placeholder"])]),t(Pe)?(f(),k("div",uu,[a[110]||(a[110]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",du,[e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[107]||(a[107]=[C("Team",-1)])]),_:1}),s(t(st),{modelValue:Xt.value,"onUpdate:modelValue":a[32]||(a[32]=N=>Xt.value=N),items:Us.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:N})=>[e("div",cu,[e("span",mu,I(N.dealership||"No location"),1),a[108]||(a[108]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",pu,I(N.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"form-label"},{default:o(()=>[...a[109]||(a[109]=[C("Salesperson ",-1),e("span",{class:"optional"},"(optional)",-1)])]),_:1}),s(t(st),{modelValue:Bt.value,"onUpdate:modelValue":a[33]||(a[33]=N=>Bt.value=N),items:Kt.value,disabled:!t(De),placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:N})=>[e("div",fu,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",ke(N.role)])},I(ne(N.name)),3),e("span",vu,I(N.name),1)])]),_:1},8,["modelValue","items","disabled"])])])])):q("",!0),t(Pe)&&t(De)?(f(),k("div",gu,[e("h5",yu,[C(I(t(r)("forms.schedule.title"))+" ",1),a[111]||(a[111]=e("span",{class:"text-red-600"},"*",-1))]),e("div",hu,[e("div",bu,[e("div",xu,[e("div",wu,[e("button",{onClick:un,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...a[112]||(a[112]=[e("i",{class:"fa-solid fa-chevron-left text-sm text-muted-foreground"},null,-1)])]),e("h6",ku,I(an.value),1),e("button",{onClick:dn,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...a[113]||(a[113]=[e("i",{class:"fa-solid fa-chevron-right text-sm text-muted-foreground"},null,-1)])])]),e("div",Su,[(f(),k(Le,null,Je(Fs,N=>e("div",{key:N,class:"text-center text-xs font-medium text-muted-foreground py-2"},I(N),1)),64))]),e("div",Cu,[(f(!0),k(Le,null,Je(es.value,(N,Oe)=>(f(),k("div",{key:Oe,onClick:Ie=>Rs(N),class:ae(["aspect-square flex items-center justify-center text-sm font-medium rounded-lg transition-all",rn(N)?"bg-primary text-white cursor-pointer":N?"text-muted-foreground hover:bg-muted cursor-pointer":"text-transparent"])},I(N),11,$u))),128))])]),e("div",Du,[e("h6",Au,I(on.value),1),t(ze)&&is.value.length>0?(f(),k("div",Tu,[(f(!0),k(Le,null,Je(is.value,N=>(f(),re(t(Be),{key:N,variant:"outline","model-value":t(ut)===N,"onUpdate:modelValue":Oe=>t(ht)(Oe?N:""),class:"schedule-slot-toggle-item"},{default:o(()=>[C(I(N),1)]),_:2},1032,["model-value","onUpdate:modelValue"]))),128))])):t(ze)&&is.value.length===0?(f(),k("div",Ou,I(t(r)("forms.schedule.timeSlots.noSlots")),1)):(f(),k("div",Iu,I(t(r)("forms.schedule.timeSlots.selectDate")),1))])])])])):q("",!0),s(rl,{appointment:{type:t(Pe),date:t(ze),time:t(ut),duration:t(as)},customer:l.lead.customer,salesperson:t(ye),team:t(De),dealership:(Z=t(De))!=null&&Z.dealership?{name:t(De).dealership}:null,onUpdate:tn},null,8,["appointment","customer","salesperson","team","dealership"])])):q("",!0),t(be)&&t(et)==="assign-only"?(f(),k("div",Vu,[a[118]||(a[118]=Hn('<div class="flex items-start justify-between mb-3"><div class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-blue-600"></i><h5 class="font-semibold text-foreground text-sm">Existing Appointment</h5></div><span class="text-sm font-semibold text-blue-600 uppercase">Scheduled</span></div>',1)),e("div",Nu,[e("div",null,[a[114]||(a[114]=e("span",{class:"text-muted-foreground"},"Date:",-1)),e("span",Lu,I(t(zt)(l.lead.scheduledAppointment.start)),1)]),e("div",null,[a[115]||(a[115]=e("span",{class:"text-muted-foreground"},"Time:",-1)),e("span",Mu,I(t(Ss)(l.lead.scheduledAppointment.start)),1)]),e("div",null,[a[116]||(a[116]=e("span",{class:"text-muted-foreground"},"Type:",-1)),e("span",qu,I(l.lead.scheduledAppointment.type),1)]),e("div",null,[a[117]||(a[117]=e("span",{class:"text-muted-foreground"},"Assigned to:",-1)),e("span",Uu,I(l.lead.scheduledAppointment.assignee),1)])]),s(t(ee),{label:"Reschedule Appointment",variant:"outline",size:"small",onClick:a[34]||(a[34]=N=>ue.value=!0)})])):q("",!0)])):q("",!0)])),t(P)&&!t(Ke)?(f(),k("div",_u,[s(t(ee),{variant:"secondary",onClick:t(Ae)},{default:o(()=>[...a[120]||(a[120]=[C(" Cancel ",-1)])]),_:1},8,["onClick"]),s(t(ee),{variant:"primary",disabled:!vn.value,onClick:js,class:"bg-primary text-white"},{default:o(()=>[C(I(fn.value),1)]),_:1},8,["disabled"])])):q("",!0)])],64)),s(Gn,{ref_key:"noteWidgetRef",ref:J,modal:"",show:t(te),item:null,"task-type":"lead","task-id":l.lead.id,onSave:t(bn),onClose:a[35]||(a[35]=N=>te.value=!1),onCancel:a[36]||(a[36]=N=>te.value=!1)},null,8,["show","task-id","onSave"]),s(ri,{show:t(ue),"preselected-assignee":t(Ee).assignee,onConfirm:t(yn),onClose:a[37]||(a[37]=N=>ue.value=!1)},null,8,["show","preselected-assignee","onConfirm"]),s(el,{show:ce.value,title:"Assign to salesman","confirm-label":"Assign",onConfirm:Ue,onClose:a[38]||(a[38]=N=>ce.value=!1)},null,8,["show"]),s(Zn,{show:_.value,"task-type":"lead","task-id":l.lead.id,onSave:zs,onClose:a[39]||(a[39]=N=>_.value=!1)},null,8,["show","task-id"]),s(Kn,{show:V.value,mode:"tradein","task-type":"lead","task-id":l.lead.id,"customer-id":l.lead.customerId,onClose:a[40]||(a[40]=N=>V.value=!1),onSave:kn},null,8,["show","task-id","customer-id"]),s(qn,{show:F.value,title:"AI Information Extraction",onClose:a[41]||(a[41]=N=>F.value=!1)},null,8,["show"])])}}},Ru={key:0,class:"bg-muted/50 border border-border rounded-lg p-4"},Eu={class:"flex justify-between items-start mb-3"},ju={class:"text-xs text-muted-foreground mt-0.5"},Wu={key:0},Bu={__name:"LeadManagementWidget",props:{lead:{type:Object,required:!0}},emits:["open-purchase-method","open-trade-in"],setup(l,{emit:L}){const r=l,p=L,u=Jt(),d=()=>{var R;const B=u.currentLead;return B&&B.id===((R=r.lead)==null?void 0:R.id)?B:r.lead},x={"call-to-verify":()=>{},"call-prospect":()=>{},"complete-conversion":()=>{},reopen:()=>{}},b=tl(Cs(r,"lead"),x),{handlePostponed:S,handleValidated:i,handleQualified:$,handleCallAttemptLogged:D,handleNoteSaved:m,handleOpenPurchaseMethod:h,handleOpenTradeIn:y,handleAppointmentScheduled:v,handleDisqualified:A,handleReopen:g}=co({getLead:d,leadState:b,emit:p}),M=async B=>{var R;(R=r.lead)!=null&&R.id&&await u.loadLeadById(r.lead.id)};return(B,R)=>(f(),re(sl,{task:l.lead,"hide-title":"","hide-border":""},{"primary-action":o(()=>[t(b).isClosed.value?q("",!0):(f(),re(ll,{key:0,task:l.lead,"task-type":"lead",onReassigned:M,class:"mb-3"},null,8,["task"])),!t(b).isClosed.value&&t(b).showLQWidget.value?(f(),re(Fu,{key:l.lead.id,lead:l.lead,"show-deadline-banner":t(b).showDeadlineBanner.value,onPostponed:t(S),onValidated:t(i),onQualified:t($),onDisqualified:t(A),onCallAttemptLogged:t(D),onNoteSaved:t(m),onOpenPurchaseMethod:t(h),onOpenTradeIn:t(y),onAppointmentScheduled:t(v)},null,8,["lead","show-deadline-banner","onPostponed","onValidated","onQualified","onDisqualified","onCallAttemptLogged","onNoteSaved","onOpenPurchaseMethod","onOpenTradeIn","onAppointmentScheduled"])):!t(b).isClosed.value&&t(b).primaryAction.value?(f(),re(nl,{key:2,action:t(b).primaryAction.value,"color-scheme":t(b).primaryAction.value.colorScheme,onActionClicked:t(b).primaryAction.value.handler},null,8,["action","color-scheme","onActionClicked"])):q("",!0)]),"task-widgets":o(()=>[...R[0]||(R[0]=[])]),"closed-state":o(()=>[t(b).isClosed.value?(f(),k("div",Ru,[e("div",Eu,[e("div",null,[R[1]||(R[1]=e("h4",{class:"font-bold text-foreground text-sm"},"Lead Closed",-1)),e("p",ju,[C(" Status: "+I(t(b).displayStage.value)+" ",1),l.lead.disqualifyReason?(f(),k("span",Wu," - "+I(l.lead.disqualifyReason),1)):q("",!0)])])]),s(t(ee),{variant:"primary",size:"small",onClick:t(g),class:"flex items-center gap-2"},{default:o(()=>[...R[2]||(R[2]=[e("span",null,"Reopen Lead",-1),e("i",{class:"fa-solid fa-rotate-left"},null,-1)])]),_:1},8,["onClick"])])):q("",!0)]),_:1},8,["task"]))}},Pu={class:"rounded-lg flex flex-col bg-muted"},zu={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},Yu={class:"p-4"},Hu={class:"flex justify-between items-start mb-3"},Qu={class:"font-bold text-foreground text-sm"},Ju={class:"text-xs text-muted-foreground mt-0.5"},Gu={class:"flex gap-3 flex-wrap"},Ms={__name:"BaseTaskWidget",props:{title:{type:String,required:!0},description:{type:String,required:!0},colorScheme:{type:Object,required:!1,default:()=>({background:"",border:""})}},setup(l){return(L,r)=>(f(),k("div",Pu,[e("div",zu,[e("div",Yu,[e("div",Hu,[e("div",null,[e("h4",Qu,I(l.title),1),e("p",Ju,I(l.description),1)]),St(L.$slots,"badge")]),e("div",Gu,[St(L.$slots,"actions")]),St(L.$slots,"survey"),St(L.$slots,"content")])])]))}},Zu={key:1,class:"space-y-4"},Ku={class:"flex items-center justify-between"},Xu={class:"space-y-4"},ed={class:"block text-sm font-medium text-muted-foreground"},td=["onUpdate:modelValue","placeholder"],sd={key:2,class:"space-y-2"},nd=["onUpdate:modelValue","value"],ld={class:"flex gap-2 flex-wrap justify-end pt-2"},Ks={__name:"SurveyWidget",props:{questions:{type:Array,required:!0},initialExpanded:{type:Boolean,default:!1}},emits:["survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const r=l,p=L,u=T(r.initialExpanded),d=T({});Ce(()=>r.questions,$=>{const D={};$.forEach(m=>{D[m.key]=""}),d.value=D},{immediate:!0});const x=()=>{p("survey-completed",{...d.value}),i()},b=()=>{p("survey-refused"),i()},S=()=>{p("not-responding"),i()},i=()=>{u.value=!1;const $={};r.questions.forEach(D=>{$[D.key]=""}),d.value=$};return($,D)=>(f(),k("div",null,[u.value?(f(),k("div",Zu,[e("div",Ku,[D[4]||(D[4]=e("h5",{class:"text-sm font-semibold text-foreground"},"Lead Qualification Survey",-1)),e("button",{onClick:D[1]||(D[1]=m=>u.value=!1),class:"text-xs text-muted-foreground hover:text-muted-foreground transition-colors"},[...D[3]||(D[3]=[e("i",{class:"fa-solid fa-chevron-up"},null,-1)])])]),e("div",Xu,[(f(!0),k(Le,null,Je(l.questions,(m,h)=>(f(),k("div",{key:h,class:"space-y-2"},[e("label",ed,I(m.label),1),m.type==="text"?lt((f(),k("textarea",{key:0,"onUpdate:modelValue":y=>d.value[m.key]=y,placeholder:m.placeholder,rows:"3",class:"input resize-none text-sm py-2 px-3 w-full"},null,8,td)),[[Jn,d.value[m.key]]]):m.type==="select"?(f(),re(t(It),{key:1,modelValue:d.value[m.key],"onUpdate:modelValue":y=>d.value[m.key]=y},{default:o(()=>[s(t(At),{class:"w-full h-10 min-h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select an option..."})]),_:1}),s(t(Ot),null,{default:o(()=>[(f(!0),k(Le,null,Je(m.options,y=>(f(),re(t(fe),{key:y,value:y},{default:o(()=>[C(I(y),1)]),_:2},1032,["value"]))),128))]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue"])):m.type==="radio"?(f(),k("div",sd,[(f(!0),k(Le,null,Je(m.options,y=>(f(),k("label",{key:y,class:"flex items-center text-sm text-muted-foreground cursor-pointer"},[lt(e("input",{type:"radio","onUpdate:modelValue":v=>d.value[m.key]=v,value:y,class:"mr-2 w-4 h-4 text-brand-red focus:ring-brand-red border-gray-300"},null,8,nd),[[bt,d.value[m.key]]]),C(" "+I(y),1)]))),128))])):q("",!0)]))),128)),e("div",ld,[s(t(ee),{label:"Complete Survey",variant:"primary",size:"small",onClick:x,class:"!bg-green-600 !hover:bg-green-700 !text-white !border-green-600"}),s(t(ee),{label:"Customer Refused",variant:"outline",size:"small",onClick:b}),s(t(ee),{label:"Not Responding",variant:"outline",size:"small",onClick:S})])])])):(f(),k("button",{key:0,onClick:D[0]||(D[0]=m=>u.value=!0),class:"w-full flex items-center justify-between text-sm text-muted-foreground hover:text-foreground py-2 transition-colors"},[...D[2]||(D[2]=[e("span",{class:"font-medium"},"Lead Qualification Survey",-1),e("i",{class:"fa-solid fa-chevron-down text-xs text-muted-foreground"},null,-1)])]))]))}},ad={__name:"OOFBTask",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","review","survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const r=l,p=L,u=[{key:"offerStatus",label:"Why hasn't an offer been created?",type:"select",options:["Still gathering information","Awaiting customer response","Vehicle unavailable","Pricing concerns","Other"]},{key:"customerInterest",label:"Is customer still interested?",type:"radio",options:["Yes","Maybe","No"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Any relevant feedback or next steps..."}],d=w(()=>{if(!r.opportunity.createdAt)return 0;const D=new Date(r.opportunity.createdAt),h=Math.abs(new Date-D);return Math.ceil(h/(1e3*60*60*24))}),x=()=>{p("create-offer",r.opportunity)},b=()=>{p("review",r.opportunity)},S=D=>{p("survey-completed",{opportunity:r.opportunity,responses:D})},i=()=>{p("survey-refused",{opportunity:r.opportunity})},$=()=>{p("not-responding",{opportunity:r.opportunity})};return(D,m)=>(f(),re(Ms,{title:"Open Opportunity Feedback",description:`This opportunity has been open for ${d.value} days without any offer. Consider creating an offer to move forward.`,"color-scheme":{background:"bg-orange-50/50",border:"border-orange-100"}},{actions:o(()=>[e("button",{onClick:x,class:"bg-orange-600 hover:bg-orange-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"}," Create Offer "),e("button",{onClick:b,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"}," Review Opportunity ")]),survey:o(()=>[s(Ks,{questions:u,onSurveyCompleted:S,onSurveyRefused:i,onNotResponding:$})]),_:1},8,["description"]))}},od={__name:"UFBTask",props:{opportunity:{type:Object,required:!0}},emits:["create-offer","survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const r=l,p=L,u=[{key:"lostInterest",label:"Has customer lost interest?",type:"radio",options:["Yes","Maybe","No","Unknown"]},{key:"blockers",label:"What are the blockers?",type:"select",options:["Pricing","Availability","Financing","No response","Changed mind","Found competitor","Other"]},{key:"notes",label:"Additional feedback",type:"text",placeholder:"Describe the situation and any relevant details..."}],d=w(()=>{if(!r.opportunity.createdAt)return 0;const $=new Date(r.opportunity.createdAt),m=Math.abs(new Date-$);return Math.ceil(m/(1e3*60*60*24))}),x=()=>{p("create-offer",r.opportunity)},b=$=>{p("survey-completed",{opportunity:r.opportunity,responses:$})},S=()=>{p("survey-refused",{opportunity:r.opportunity})},i=()=>{p("not-responding",{opportunity:r.opportunity})};return($,D)=>(f(),re(Ms,{title:"Unsold Feedback",description:`This opportunity has been open for ${d.value} days without any offer. This is a follow-up to ensure progress. Consider creating an offer or closing the opportunity.`,"color-scheme":{background:"bg-red-50/50",border:"border-red-100"}},{actions:o(()=>[e("button",{onClick:x,class:"bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"}," Create Offer ")]),survey:o(()=>[s(Ks,{questions:u,onSurveyCompleted:b,onSurveyRefused:S,onNotResponding:i})]),_:1},8,["description"]))}},id={class:"space-y-4"},rd={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},ud={class:"flex flex-wrap gap-3"},dd={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},cd={key:1},md={__name:"NFUTask",props:{opportunity:{type:Object,required:!0}},emits:["appointment-scheduled","close-as-lost","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=T(null),x=T(null),b=w(()=>{var $;return d.value==="schedule"?!1:d.value==="close-lost"&&(($=x.value)==null?void 0:$.canSubmit)||!1});async function S(){var $;d.value==="schedule"?u("appointment-scheduled",{opportunity:p.opportunity}):d.value==="close-lost"&&(($=x.value)==null||$.submit())}function i($){u("close-as-lost",{opportunity:p.opportunity,reason:$.reason})}return L({canSubmit:b,submit:S}),($,D)=>(f(),k("div",id,[D[6]||(D[6]=e("div",{class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},[e("h4",{class:"font-bold text-foreground text-sm mb-1"},"No Follow-Up Task"),e("p",{class:"text-sm text-muted-foreground"}," 5+ days in negotiation with no future appointment scheduled. Schedule an appointment to move forward or close as lost. ")],-1)),e("div",rd,[D[4]||(D[4]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Choose Action",-1)),e("div",ud,[s(t(ee),{variant:"outline",onClick:D[0]||(D[0]=m=>d.value="schedule"),class:ae(["flex-1",d.value==="schedule"?"border-purple-500 bg-purple-50 text-purple-700":""])},{default:o(()=>[...D[2]||(D[2]=[e("i",{class:"fa-solid fa-calendar-plus mr-2"},null,-1),C(" Schedule Appointment ",-1)])]),_:1},8,["class"]),s(t(ee),{variant:"outline",onClick:D[1]||(D[1]=m=>d.value="close-lost"),class:ae(["flex-1",d.value==="close-lost"?"border-red-500 bg-red-50 text-red-700":""])},{default:o(()=>[...D[3]||(D[3]=[e("i",{class:"fa-solid fa-xmark mr-2"},null,-1),C(" Close as Lost ",-1)])]),_:1},8,["class"])])]),d.value==="schedule"?(f(),k("div",dd,[...D[5]||(D[5]=[e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Schedule Appointment",-1),e("p",{class:"text-sm text-muted-foreground"}," This will reuse the full schedule appointment form from the Awaiting Appointment stage. ",-1)])])):q("",!0),d.value==="close-lost"?(f(),k("div",cd,[s(Un,{ref_key:"closeFormRef",ref:x,item:l.opportunity,"item-type":"opportunity",onClose:i},null,8,["item"])])):q("",!0)]))}},pd={key:0},fd={class:"flex items-center justify-between mb-2"},vd={class:"flex items-center gap-2"},gd={class:"font-semibold text-foreground text-sm"},yd={class:"relative"},hd={class:"flex overflow-x-auto space-x-2 pb-2 scrollbar-hide scroll-smooth snap-x snap-mandatory",style:{"scrollbar-width":"thin"}},bd={class:"w-full h-16 bg-muted flex items-center justify-center overflow-hidden"},xd=["src"],wd={key:1,class:"fa-solid fa-car text-base text-muted-foreground"},kd={class:"p-2 space-y-1.5"},Sd={class:"font-bold text-foreground text-xs leading-tight line-clamp-2 mb-0.5"},Cd={class:"text-sm font-bold text-foreground"},$d={class:"text-xs text-muted-foreground"},Dd={key:0,class:"pt-1"},Ad={key:1,class:"text-center py-6 px-3 bg-muted border border-border rounded-lg"},Td={__name:"OfferCarousel",props:{offers:{type:Array,default:()=>[]},opportunityId:{type:[Number,String],required:!0}},emits:["offer-accepted"],setup(l,{emit:L}){const r=b=>b?new Intl.NumberFormat("en-US").format(b):"0",p=b=>{if(!b)return"";const S=new Date(b),$=Math.abs(new Date-S),D=Math.ceil($/(1e3*60*60*24));return D===0?"today":D===1?"yesterday":D<7?`${D} days ago`:S.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})},u=b=>({active:"Active",accepted:"Accepted",archived:"Archived"})[b]||"Active",d=b=>({active:"bg-blue-600",accepted:"bg-green-600",archived:"bg-gray-600"})[b]||"bg-gray-600",x=b=>b.status==="accepted"?"border-green-500 border-2":"border-border";return(b,S)=>l.offers.length>0?(f(),k("div",pd,[e("div",fd,[e("div",vd,[S[0]||(S[0]=e("i",{class:"fa-solid fa-file-invoice-dollar text-muted-foreground text-xs"},null,-1)),e("h3",gd,"Offers ("+I(l.offers.length)+")",1)])]),e("div",yd,[e("div",hd,[(f(!0),k(Le,null,Je(l.offers,i=>{var $;return f(),k("div",{key:i.id,class:ae(["flex-none w-36 snap-start bg-white border rounded-lg shadow-nsc-card overflow-hidden transition-shadow relative",x(i)])},[e("div",{class:ae(["absolute top-1 right-1 z-10 text-white text-xs font-bold px-1.5 py-0.5 rounded shadow-sm",d(i.status)])},I(u(i.status)),3),e("div",bd,[($=i.data)!=null&&$.image?(f(),k("img",{key:0,src:i.data.image,alt:"Vehicle",class:"w-full h-full object-cover"},null,8,xd)):(f(),k("i",wd))]),e("div",kd,[e("div",null,[e("h4",Sd,I(i.vehicleBrand)+" "+I(i.vehicleModel)+" ("+I(i.vehicleYear)+") ",1),e("p",Cd,"€ "+I(r(i.price)),1),e("p",$d,I(p(i.createdAt)),1)]),i.status==="active"?(f(),k("div",Dd,[s(t(ee),{variant:"primary",size:"small",onClick:Mn(D=>b.$emit("offer-accepted",i),["stop"]),class:"w-full text-xs h-7"},{default:o(()=>[...S[1]||(S[1]=[e("i",{class:"fa-solid fa-check text-xs mr-1"},null,-1),C(" Mark as accepted ",-1)])]),_:1},8,["onClick"])])):q("",!0)])],2)}),128))])])])):(f(),k("div",Ad,[...S[2]||(S[2]=[e("i",{class:"fa-solid fa-file-invoice text-2xl text-muted-foreground mb-2"},null,-1),e("p",{class:"text-xs font-medium text-muted-foreground"},"No offers created yet",-1),e("p",{class:"text-xs text-muted-foreground mt-0.5"},"Create an offer to start negotiations",-1)])]))}},ul=Qt(Td,[["__scopeId","data-v-6df7bd06"]]),Od={class:"space-y-4"},Id={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Vd={class:"text-sm text-muted-foreground"},Nd={key:0,class:"mb-4"},Ld={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Md={class:"grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"},qd={key:0,class:"space-y-3"},Ud={key:0},_d={class:"flex items-center justify-between gap-2"},Fd={class:"text-muted-foreground text-xs"},Rd={__name:"OFBTask",props:{opportunity:{type:Object,required:!0}},emits:["offer-accepted","offer-deleted","view-offer","send-message"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=T(null),x=T(""),b=T(null),S=w(()=>{const y=p.opportunity.lastActivity||p.opportunity.createdAt;if(!y)return 0;const v=new Date(y),g=Math.abs(new Date-v);return Math.ceil(g/(1e3*60*60*24))}),i=w(()=>!p.opportunity.offers||p.opportunity.offers.length===0?[]:p.opportunity.offers.filter(y=>y.status==="active").map(y=>({id:y.id,label:`${y.vehicleBrand} ${y.vehicleModel} (${y.vehicleYear})`,price:y.price,value:y.id}))),$=w(()=>d.value&&x.value.trim().length>0);function D(y){return y?new Intl.NumberFormat("en-US").format(y):"0"}function m(y){u("offer-accepted",y)}async function h(){$.value&&(u("send-message",{channel:d.value,message:x.value,offerId:b.value}),d.value=null,x.value="",b.value=null)}return L({canSubmit:$,submit:h}),(y,v)=>(f(),k("div",Od,[e("div",Id,[v[6]||(v[6]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"Offer Feedback Task",-1)),e("p",Vd," This opportunity has been in negotiation for "+I(S.value)+" days without a contract. Follow up with customer to get feedback and move forward. ",1)]),l.opportunity.offers&&l.opportunity.offers.length>0?(f(),k("div",Nd,[s(ul,{offers:l.opportunity.offers,"opportunity-id":l.opportunity.id,onOfferAccepted:m},null,8,["offers","opportunity-id"])])):q("",!0),e("div",Ld,[v[13]||(v[13]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Contact Customer",-1)),e("div",Md,[s(t(ee),{variant:"outline",onClick:v[0]||(v[0]=A=>d.value="call"),class:ae(["flex items-center justify-center gap-2",d.value==="call"?"border-brand-blue bg-blue-50 text-brand-blue":""])},{default:o(()=>[...v[7]||(v[7]=[e("i",{class:"fa-solid fa-phone text-xs"},null,-1),e("span",null,"Call",-1)])]),_:1},8,["class"]),s(t(ee),{variant:"outline",onClick:v[1]||(v[1]=A=>d.value="whatsapp"),class:ae(["flex items-center justify-center gap-2",d.value==="whatsapp"?"border-brand-blue bg-blue-50 text-brand-blue":""])},{default:o(()=>[...v[8]||(v[8]=[e("i",{class:"fa-brands fa-whatsapp text-xs"},null,-1),e("span",null,"WhatsApp",-1)])]),_:1},8,["class"]),s(t(ee),{variant:"outline",onClick:v[2]||(v[2]=A=>d.value="sms"),class:ae(["flex items-center justify-center gap-2",d.value==="sms"?"border-brand-blue bg-blue-50 text-brand-blue":""])},{default:o(()=>[...v[9]||(v[9]=[e("i",{class:"fa-solid fa-message text-xs"},null,-1),e("span",null,"SMS",-1)])]),_:1},8,["class"]),s(t(ee),{variant:"outline",onClick:v[3]||(v[3]=A=>d.value="email"),class:ae(["flex items-center justify-center gap-2",d.value==="email"?"border-brand-blue bg-blue-50 text-brand-blue":""])},{default:o(()=>[...v[10]||(v[10]=[e("i",{class:"fa-solid fa-envelope text-xs"},null,-1),e("span",null,"Email",-1)])]),_:1},8,["class"])]),d.value?(f(),k("div",qd,[i.value.length>0?(f(),k("div",Ud,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...v[11]||(v[11]=[C("Select offer to reference",-1)])]),_:1}),s(t(st),{modelValue:b.value,"onUpdate:modelValue":v[4]||(v[4]=A=>b.value=A),items:i.value,placeholder:"Select an offer...","value-key":"id",class:"w-full"},{item:o(({item:A})=>[e("div",_d,[e("span",null,I(A.label),1),e("span",Fd,"€ "+I(D(A.price)),1)])]),_:1},8,["modelValue","items"])])):q("",!0),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...v[12]||(v[12]=[C("Message",-1)])]),_:1}),s(t(dt),{modelValue:x.value,"onUpdate:modelValue":v[5]||(v[5]=A=>x.value=A),rows:"4",placeholder:"Type your message here...",class:"w-full"},null,8,["modelValue"])])])):q("",!0)])]))}},Ed={__name:"CFBTask",props:{opportunity:{type:Object,required:!0}},emits:["prepare-delivery","pre-delivery-checklist","survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const r=l,p=L,u=[{key:"deliveryTimeline",label:"Delivery timeline confirmation?",type:"select",options:["On schedule","Delayed","Ahead of schedule","To be determined"]},{key:"concerns",label:"Any concerns?",type:"text",placeholder:"Document any concerns or special requests from customer..."},{key:"readiness",label:"Vehicle readiness status?",type:"select",options:["Ready","In preparation","Waiting for parts","Other"]}],d=w(()=>{var y;if(!((y=r.opportunity)!=null&&y.contractDate))return 0;const D=new Date(r.opportunity.contractDate),h=Math.abs(new Date-D);return Math.ceil(h/(1e3*60*60*24))}),x=()=>{p("prepare-delivery",r.opportunity)},b=()=>{p("pre-delivery-checklist",r.opportunity)},S=D=>{p("survey-completed",{opportunity:r.opportunity,responses:D})},i=()=>{p("survey-refused",{opportunity:r.opportunity})},$=()=>{p("not-responding",{opportunity:r.opportunity})};return(D,m)=>(f(),re(Ms,{title:"Contract Feedback",description:`Contract was signed ${d.value} days ago. Follow up on delivery status and collect customer feedback.`,"color-scheme":{background:"bg-green-50/50",border:"border-green-100"}},{actions:o(()=>[e("button",{onClick:x,class:"bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"}," Prepare for Delivery "),e("button",{onClick:b,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"}," Pre-Delivery Checklist ")]),survey:o(()=>[s(Ks,{questions:u,onSurveyCompleted:S,onSurveyRefused:i,onNotResponding:$})]),_:1},8,["description"]))}},jd={class:"space-y-6"},Wd={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Bd={class:"space-y-6"},Pd={class:"space-y-2"},zd=["value"],Yd={class:"text-sm text-foreground"},Hd={class:"space-y-2"},Qd=["value"],Jd={class:"text-sm text-foreground"},Gd={key:0},Zd={class:"space-y-2"},Kd=["value"],Xd={class:"text-sm text-foreground"},ec={class:"flex items-center gap-2"},tc=["onClick"],sc={key:0,class:"text-sm text-muted-foreground ml-2"},nc={class:"space-y-2"},lc=["value"],ac={class:"text-sm text-foreground"},oc={class:"flex items-center gap-2 mt-2"},ic={class:"space-y-2"},rc=["value"],uc={class:"text-sm text-foreground"},dc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},cc={class:"space-y-4"},mc={class:"flex items-center gap-3"},pc={class:"flex items-center gap-3"},fc={class:"flex items-center gap-3"},vc={class:"flex items-center gap-3"},gc={__name:"PostDeliverySurvey",props:{opportunity:{type:Object,required:!0}},emits:["submit","cancel"],setup(l,{expose:L,emit:r}){const p=r,u=T({q1:"",q2:"",q3:"",q4:"",q5:null,q6:[],q6Other:!1,q6OtherText:"",q7:"",q8:""}),d=T({negativeSatisfaction:!1,issuesReported:!1,deliveryDelay:!1,highNPS:!1}),x=[{value:"very-satisfied",label:"Very Satisfied"},{value:"satisfied",label:"Satisfied"},{value:"neutral",label:"Neutral"},{value:"unsatisfied",label:"Unsatisfied"},{value:"very-unsatisfied",label:"Very Unsatisfied"}],b=[{value:"perfect",label:"Yes, perfect condition"},{value:"acceptable",label:"Yes, acceptable"},{value:"minor-issues",label:"There are minor issues"},{value:"major-issues",label:"There are major issues"}],S=[{value:"on-time",label:"Yes, on time"},{value:"early",label:"Yes, early"},{value:"delayed-minor",label:"No, delayed (minor - 1-3 days)"},{value:"delayed-major",label:"No, delayed (major - more than 3 days)"}],i=[{value:"keys",label:"Vehicle keys"},{value:"manual",label:"Owner's manual"},{value:"registration",label:"Registration documents"},{value:"warranty",label:"Service warranty information"},{value:"insurance",label:"Insurance documents"}],$=[{value:"definitely-yes",label:"Definitely Yes"},{value:"probably-yes",label:"Probably Yes"},{value:"not-sure",label:"Not Sure"},{value:"probably-not",label:"Probably Not"},{value:"definitely-not",label:"Definitely Not"}],D=w(()=>u.value.q2==="minor-issues"||u.value.q2==="major-issues");Ce(()=>u.value.q1,y=>{y==="very-unsatisfied"||y==="unsatisfied"?d.value.negativeSatisfaction=!0:d.value.negativeSatisfaction=!1}),Ce(()=>u.value.q3,y=>{y&&y.trim().length>0?d.value.issuesReported=!0:d.value.issuesReported=!1}),Ce(()=>u.value.q4,y=>{y==="delayed-major"?d.value.deliveryDelay=!0:d.value.deliveryDelay=!1}),Ce(()=>u.value.q7,y=>{y==="definitely-yes"?d.value.highNPS=!0:d.value.highNPS=!1});const m=w(()=>{var A,g;if(!u.value.q1||!u.value.q2||D.value&&!((A=u.value.q3)!=null&&A.trim()))return!1;const y=u.value.q6&&u.value.q6.length>0,v=u.value.q6Other&&((g=u.value.q6OtherText)==null?void 0:g.trim());return!(!y&&!v)});return L({submit:()=>{if(!m.value)return;const y={responses:{...u.value},triggerActions:{...d.value},timestamp:new Date().toISOString()};p("submit",y)},isValid:m}),(y,v)=>(f(),k("div",jd,[e("div",Wd,[v[22]||(v[22]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Post-Delivery Customer Satisfaction Survey",-1)),e("div",Bd,[e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[13]||(v[13]=[C(" How satisfied are you with your new vehicle delivery experience? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",Pd,[(f(),k(Le,null,Je(x,A=>e("label",{key:A.value,class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q1===A.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":v[0]||(v[0]=g=>u.value.q1=g),type:"radio",value:A.value,class:"shrink-0"},null,8,zd),[[bt,u.value.q1]]),e("span",Yd,I(A.label),1)],2)),64))])]),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[14]||(v[14]=[C(" Is the vehicle in the condition you expected? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",Hd,[(f(),k(Le,null,Je(b,A=>e("label",{key:A.value,class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q2===A.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":v[1]||(v[1]=g=>u.value.q2=g),type:"radio",value:A.value,class:"shrink-0"},null,8,Qd),[[bt,u.value.q2]]),e("span",Jd,I(A.label),1)],2)),64))])]),D.value?(f(),k("div",Gd,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[15]||(v[15]=[C(" Please describe the issues you found: ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(dt),{modelValue:u.value.q3,"onUpdate:modelValue":v[2]||(v[2]=A=>u.value.q3=A),rows:"4",placeholder:"Describe the issues...",class:"w-full"},null,8,["modelValue"])])):q("",!0),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[16]||(v[16]=[C(" Was the vehicle delivered on the scheduled date? ",-1)])]),_:1}),e("div",Zd,[(f(),k(Le,null,Je(S,A=>e("label",{key:A.value,class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q4===A.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":v[3]||(v[3]=g=>u.value.q4=g),type:"radio",value:A.value,class:"shrink-0"},null,8,Kd),[[bt,u.value.q4]]),e("span",Xd,I(A.label),1)],2)),64))])]),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[17]||(v[17]=[C(" How would you rate the professionalism of our sales team during delivery? ",-1)])]),_:1}),e("div",ec,[(f(),k(Le,null,Je(5,A=>e("button",{key:A,onClick:g=>u.value.q5=A,class:ae(["text-2xl transition-colors",u.value.q5>=A?"text-yellow-500":"text-gray-300"])}," ⭐ ",10,tc)),64)),u.value.q5?(f(),k("span",sc,I(u.value.q5)+" "+I(u.value.q5===1?"star":"stars"),1)):q("",!0)])]),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[18]||(v[18]=[C(" Did you receive all the required items? ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),e("div",nc,[(f(),k(Le,null,Je(i,A=>e("label",{key:A.value,class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors"},[lt(e("input",{"onUpdate:modelValue":v[4]||(v[4]=g=>u.value.q6=g),type:"checkbox",value:A.value,class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,8,lc),[[In,u.value.q6]]),e("span",ac,I(A.label),1)])),64)),e("div",oc,[lt(e("input",{"onUpdate:modelValue":v[5]||(v[5]=A=>u.value.q6Other=A),type:"checkbox",class:"w-4 h-4 focus:ring-brand-blue border-gray-300 rounded",style:{"accent-color":"var(--brand-blue)"}},null,512),[[In,u.value.q6Other]]),v[19]||(v[19]=e("span",{class:"text-sm text-foreground"},"Other:",-1)),u.value.q6Other?(f(),re(t(tt),{key:0,modelValue:u.value.q6OtherText,"onUpdate:modelValue":v[6]||(v[6]=A=>u.value.q6OtherText=A),placeholder:"Specify other item",class:"flex-1"},null,8,["modelValue"])):q("",!0)])])]),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[20]||(v[20]=[C(" Would you recommend our dealership to friends and family? ",-1)])]),_:1}),e("div",ic,[(f(),k(Le,null,Je($,A=>e("label",{key:A.value,class:ae(["flex items-center gap-3 border rounded-lg px-3 py-2 cursor-pointer transition-colors",u.value.q7===A.value?"border-2 border-brand-blue bg-muted/50":"border border-border hover:bg-muted/50"])},[lt(e("input",{"onUpdate:modelValue":v[7]||(v[7]=g=>u.value.q7=g),type:"radio",value:A.value,class:"shrink-0"},null,8,rc),[[bt,u.value.q7]]),e("span",uc,I(A.label),1)],2)),64))])]),e("div",null,[s(t(H),{class:"form-label mb-2"},{default:o(()=>[...v[21]||(v[21]=[C(" Internal notes for follow-up actions: ",-1),e("span",{class:"text-xs text-muted-foreground ml-1"},"(Private - only for internal staff)",-1)])]),_:1}),s(t(dt),{modelValue:u.value.q8,"onUpdate:modelValue":v[8]||(v[8]=A=>u.value.q8=A),rows:"4",placeholder:"Add internal notes...",class:"w-full"},null,8,["modelValue"])])])]),e("div",dc,[v[31]||(v[31]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Trigger Actions (Email Notifications)",-1)),e("div",cc,[e("div",mc,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"trigger-negative-satisfaction",modelValue:d.value.negativeSatisfaction,"onUpdate:modelValue":v[9]||(v[9]=A=>d.value.negativeSatisfaction=A)},null,8,["modelValue"]),v[23]||(v[23]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Sales Manager + Branch Manager ",-1))]),_:1}),v[24]||(v[24]=e("span",{class:"text-xs text-muted-foreground"},"(Q1 = Very Unsatisfied/Unsatisfied)",-1))]),e("div",pc,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"trigger-issues",modelValue:d.value.issuesReported,"onUpdate:modelValue":v[10]||(v[10]=A=>d.value.issuesReported=A)},null,8,["modelValue"]),v[25]||(v[25]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Service Department ",-1))]),_:1}),v[26]||(v[26]=e("span",{class:"text-xs text-muted-foreground"},"(Q3 = Issues reported)",-1))]),e("div",fc,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"trigger-delay",modelValue:d.value.deliveryDelay,"onUpdate:modelValue":v[11]||(v[11]=A=>d.value.deliveryDelay=A)},null,8,["modelValue"]),v[27]||(v[27]=e("span",{class:"text-sm font-medium text-foreground"}," ⚠️ Email to Delivery Coordinator ",-1))]),_:1}),v[28]||(v[28]=e("span",{class:"text-xs text-muted-foreground"},"(Q4 = Delayed major)",-1))]),e("div",vc,[s(t(H),{class:"flex items-center gap-2 cursor-pointer py-1 px-2 rounded-lg hover:bg-muted/50 transition-colors flex-1"},{default:o(()=>[s(t(Yt),{id:"trigger-nps",modelValue:d.value.highNPS,"onUpdate:modelValue":v[12]||(v[12]=A=>d.value.highNPS=A)},null,8,["modelValue"]),v[29]||(v[29]=e("span",{class:"text-sm font-medium text-foreground"}," ✅ Email to Marketing ",-1))]),_:1}),v[30]||(v[30]=e("span",{class:"text-xs text-muted-foreground"},"(Q7 = Definitely Yes)",-1))])])])]))}},yc={class:"rounded-lg flex flex-col bg-muted"},hc={class:"pt-1 px-1"},bc={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},xc={class:"p-6"},wc={class:"flex flex-wrap gap-3 items-center"},kc={key:0,class:"px-4 py-4 space-y-4"},Sc={class:"flex justify-end gap-2 pt-3"},Cc={__name:"DFBTask",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["close","survey-submitted","survey-cancelled"],setup(l,{emit:L}){const r=l,p=L,u=qt(),d=Vt(),x=T(!1),b=T(null),S=w(()=>{var m;return((m=b.value)==null?void 0:m.isValid)||!1}),i=async m=>{var h,y,v,A,g;try{const M=r.opportunity,{responses:B,triggerActions:R}=m;await u.addActivity(M.id,{type:"post-delivery-survey",user:((h=d.currentUser)==null?void 0:h.name)||"You",action:"completed post-delivery customer satisfaction survey",content:"Post-Delivery Customer Satisfaction Survey completed",data:{responses:B,triggerActions:R,timestamp:m.timestamp},timestamp:m.timestamp});const J=[];R.negativeSatisfaction&&J.push(u.addActivity(M.id,{type:"survey-trigger",user:((y=d.currentUser)==null?void 0:y.name)||"You",action:"triggered email notification",content:"Email sent to Sales Manager + Branch Manager (Negative satisfaction)",data:{trigger:"negative-satisfaction",recipients:["Sales Manager","Branch Manager"],surveyResponse:B.q1},timestamp:new Date().toISOString()})),R.issuesReported&&J.push(u.addActivity(M.id,{type:"survey-trigger",user:((v=d.currentUser)==null?void 0:v.name)||"You",action:"triggered email notification",content:"Email sent to Service Department (Issues reported)",data:{trigger:"issues-reported",recipients:["Service Department"],issueDescription:B.q3},timestamp:new Date().toISOString()})),R.deliveryDelay&&J.push(u.addActivity(M.id,{type:"survey-trigger",user:((A=d.currentUser)==null?void 0:A.name)||"You",action:"triggered email notification",content:"Email sent to Delivery Coordinator (Major delivery delay)",data:{trigger:"delivery-delay",recipients:["Delivery Coordinator"],surveyResponse:B.q4},timestamp:new Date().toISOString()})),R.highNPS&&J.push(u.addActivity(M.id,{type:"survey-trigger",user:((g=d.currentUser)==null?void 0:g.name)||"You",action:"triggered email notification",content:"Email sent to Marketing (High NPS - Definitely Yes)",data:{trigger:"high-nps",recipients:["Marketing"],surveyResponse:B.q7},timestamp:new Date().toISOString()})),await Promise.all(J),x.value=!1,p("survey-submitted",{opportunity:M,surveyData:m})}catch(M){console.error("Failed to submit survey:",M)}},$=()=>{b.value&&b.value.submit()},D=()=>{x.value=!1,p("survey-cancelled",{opportunity:r.opportunity})};return(m,h)=>(f(),k("div",yc,[e("div",hc,[e("div",bc,[e("div",xc,[h[2]||(h[2]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Post-Delivery Customer Satisfaction Survey"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Collect feedback from the customer about their delivery experience ")],-1)),e("div",wc,[s(t(Be),{variant:"outline","model-value":x.value,"onUpdate:modelValue":h[0]||(h[0]=y=>x.value=y),class:"outcome-toggle-item"},{default:o(()=>[...h[1]||(h[1]=[e("i",{class:"fa-solid fa-clipboard-list"},null,-1),e("span",null,"Complete Survey",-1)])]),_:1},8,["model-value"])])])])]),x.value?(f(),k("div",kc,[s(gc,{ref_key:"surveyRef",ref:b,opportunity:l.opportunity,onSubmit:i,onCancel:D},null,8,["opportunity"]),e("div",Sc,[s(t(ee),{variant:"secondary",onClick:D},{default:o(()=>[...h[3]||(h[3]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!S.value,onClick:$},{default:o(()=>[...h[4]||(h[4]=[C(" Submit Survey ",-1)])]),_:1},8,["disabled"])])])):q("",!0)]))}},$c={key:0,class:"mt-4 pt-4 border-t border-border"},Dc={class:"grid grid-cols-2 gap-4"},Ac={class:"flex items-center gap-2"},Tc={class:"text-muted-foreground"},Oc={class:"font-medium text-foreground"},Ic={class:"flex items-center gap-2"},Vc={class:"font-medium text-foreground"},Nc={class:"mt-4"},Lc={class:"mt-4 flex justify-end"},Mc={key:1,class:"mt-4 pt-4 border-t border-border"},qc={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Uc={class:"flex justify-end"},_c={__name:"NSTask",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["not-responding","auto-close-lost","set-callback","assigned","close-as-lost"],setup(l,{emit:L}){const r=l,p=L,u=Ut(),d=Vt(),x=qt(),b=T(null),S=T(null),i=T(""),$=w(()=>u.assignableUsers),D=w(()=>u.assignableTeams),m=w(()=>D.value.map(V=>({...V,label:`${V.dealership||"No location"} → ${V.name}`,value:V.id}))),h=w(()=>{var E;if(!b.value)return[];const V=b.value;return(((E=$.value)==null?void 0:E.filter(Q=>Q.team===V.name||Q.teamId===V.id))||[]).map(Q=>({...Q,label:Q.name,value:Q.id}))}),y=w({get:()=>{var V;return((V=b.value)==null?void 0:V.id)||null},set:V=>{var E;if(!V){b.value=null;return}const F=(E=D.value)==null?void 0:E.find(Q=>Q.id===V);b.value=F||null,F&&(S.value=null)}}),v=w({get:()=>{var V;return((V=S.value)==null?void 0:V.id)||null},set:V=>{if(!V){S.value=null;return}const F=h.value.find(E=>E.id===V);S.value=F||null}}),A=V=>V?V.split(" ").map(F=>F[0]).join("").toUpperCase().substring(0,2):"?",g=V=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[V]||"bg-muted text-muted-foreground";async function M(){var E,Q,oe;if(!b.value)return;const V=((E=S.value)==null?void 0:E.name)||((Q=b.value)==null?void 0:Q.name),F={assignee:V};i.value&&(F.assignmentNote=i.value),await x.updateOpportunity(r.opportunity.id,F),await x.addActivity(r.opportunity.id,{type:"assignment",user:((oe=d.currentUser)==null?void 0:oe.name)||"You",action:"assigned opportunity",content:`Opportunity assigned to ${V}${i.value?` with note: ${i.value}`:""}`,timestamp:new Date().toISOString()}),p("assigned",{opportunity:r.opportunity,assignee:V,note:i.value}),b.value=null,S.value=null,i.value=""}function B(){p("close-as-lost",{opportunity:r.opportunity,reason:"Multiple no shows"})}Ls(()=>{var V,F,E;if(r.opportunity.assignee&&!b.value&&!S.value){const Q=(V=$.value)==null?void 0:V.find(G=>G.name===r.opportunity.assignee),oe=(F=D.value)==null?void 0:F.find(G=>G.name===r.opportunity.assignee);if(Q){const G=(E=D.value)==null?void 0:E.find($e=>$e.name===Q.team||$e.id===Q.teamId);G&&(b.value=G,S.value=Q)}else oe&&(b.value=oe)}r.opportunity.assignmentNote&&(i.value=r.opportunity.assignmentNote)}),Ce(()=>r.opportunity.assignee,V=>{var F,E,Q;if(V&&!b.value&&!S.value){const oe=(F=$.value)==null?void 0:F.find($e=>$e.name===V),G=(E=D.value)==null?void 0:E.find($e=>$e.name===V);if(oe){const $e=(Q=D.value)==null?void 0:Q.find(qe=>qe.name===oe.team||qe.id===oe.teamId);$e&&(b.value=$e,S.value=oe)}else G&&(b.value=G)}});const R=w(()=>{var V;return((V=r.scheduledAppointment)==null?void 0:V.noShowCount)||0}),J=w(()=>{const V=R.value;return V===0||V===1?"NS1":V===2?"NS2":V>=3?"NS3":`NS${V}`}),ce=w(()=>{const V=R.value;return V>=3?"This is the third no-show. The opportunity will be automatically closed as lost if another appointment is not successfully completed.":V>=2?"This is the second no-show. Please make every effort to reach the customer and reschedule.":"Follow up with customer to understand the situation and book another appointment."}),_=w(()=>{var F;return(F=r.scheduledAppointment)!=null&&F.start?new Date(r.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"});return(V,F)=>(f(),re(Ms,{title:J.value,description:`Appointment was scheduled for ${_.value} but customer did not show up. ${ce.value}`,"color-scheme":{background:"bg-yellow-50/50",border:"border-yellow-100"}},{content:o(()=>[R.value<3?(f(),k("div",$c,[F[8]||(F[8]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign to",-1)),e("div",Dc,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...F[3]||(F[3]=[C("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:y.value,"onUpdate:modelValue":F[0]||(F[0]=E=>y.value=E),items:m.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:E})=>[e("div",Ac,[e("span",Tc,I(E.dealership||"No location"),1),F[4]||(F[4]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",Oc,I(E.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...F[5]||(F[5]=[C("Salesperson ",-1),e("span",{class:"text-muted-foreground text-xs"},"(optional)",-1)])]),_:1}),s(t(st),{modelValue:v.value,"onUpdate:modelValue":F[1]||(F[1]=E=>v.value=E),items:h.value,disabled:!b.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:E})=>[e("div",Ic,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",g(E.role)])},I(A(E.name)),3),e("span",Vc,I(E.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",Nc,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...F[6]||(F[6]=[C("Note for sellers",-1)])]),_:1}),s(t(dt),{modelValue:i.value,"onUpdate:modelValue":F[2]||(F[2]=E=>i.value=E),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the sellers..."},null,8,["modelValue"])]),e("div",Lc,[s(t(ee),{variant:"primary",disabled:!b.value,onClick:M,class:"bg-primary"},{default:o(()=>[...F[7]||(F[7]=[C(" Assign ",-1)])]),_:1},8,["disabled"])])])):q("",!0),R.value>=3?(f(),k("div",Mc,[e("div",qc,[F[9]||(F[9]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Close Opportunity as Lost",-1)),F[10]||(F[10]=e("p",{class:"text-sm text-muted-foreground mb-4"}," This is the third no-show. The opportunity should be closed as lost. ",-1)),e("div",Uc,[s(t(ee),{label:"Close Opportunity as Lost",variant:"primary",size:"small",onClick:B})])])])):q("",!0)]),_:1},8,["title","description"]))}},Fc={__name:"AbandonedTask",props:{opportunity:{type:Object,required:!0},activities:{type:Array,default:()=>[]}},emits:["reopen","close-lost","requalify","survey-completed","survey-refused","not-responding"],setup(l,{emit:L}){const r=l,p=L;Ln();const u=[{key:"abandonmentReason",label:"Why was this opportunity abandoned?",type:"select",options:["No response from customer","Customer lost interest","Competitor won","Budget constraints","Timing issues","Other"]},{key:"customerStatus",label:"Customer status?",type:"radio",options:["Still interested","Lost interest","Bought elsewhere","Unknown"]},{key:"notes",label:"Additional notes",type:"text",placeholder:"Document any relevant information about why this opportunity was abandoned..."}],d=w(()=>{const m=r.opportunity.lastActivity||r.opportunity.createdAt;if(!m)return 0;const h=new Date(m),v=Math.abs(new Date-h);return Math.ceil(v/(1e3*60*60*24))}),x=()=>{p("reopen",r.opportunity)},b=()=>{p("close-lost",{opportunity:r.opportunity,reason:"Abandoned - no activity for extended period"})},S=()=>{p("requalify",r.opportunity)},i=m=>{p("survey-completed",{opportunity:r.opportunity,responses:m})},$=()=>{p("survey-refused",{opportunity:r.opportunity})},D=()=>{p("not-responding",{opportunity:r.opportunity})};return(m,h)=>(f(),re(Ms,{title:"Opportunity Abandoned",description:`This opportunity has been inactive for ${d.value} days. Consider reopening it or closing as lost.`,"color-scheme":{background:"bg-muted/50",border:"border"}},{actions:o(()=>[e("button",{onClick:x,class:"bg-gray-600 hover:bg-gray-700 text-white font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors"},[...h[0]||(h[0]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),C(" Reopen Opportunity ",-1)])]),e("button",{onClick:b,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"},[...h[1]||(h[1]=[e("i",{class:"fa-solid fa-xmark"},null,-1),C(" Close as Lost ",-1)])]),e("button",{onClick:S,class:"bg-white border border-D1D5DB text-brand-dark font-medium px-4 py-2 rounded-btn text-xs flex items-center gap-2 transition-colors hover:bg-muted"},[...h[2]||(h[2]=[e("i",{class:"fa-solid fa-arrow-left"},null,-1),C(" Requalify as Lead ",-1)])])]),survey:o(()=>[s(Ks,{questions:u,onSurveyCompleted:i,onSurveyRefused:$,onNotResponding:D})]),_:1},8,["description"]))}},Rc={OOFB:ad,UFB:od,NFU:md,OFB:Rd,CFB:Ed,DFB:Cc,NS:_c,ABANDONED:Fc};function Ec(l,L,r,p,u){const d=w(()=>{const m=Gs(l),h=Gs(L),y=Gs(r);return{opportunity:m,scheduledAppointment:h,activities:y,hasOffers:m.offers&&m.offers.length>0||(y==null?void 0:y.some(v=>v.type==="offer"))||!1,stage:m.displayStage||m.stage,deliverySubstatus:m.deliverySubstatus||null,formatDateTime:u,hasActiveTaskWidget:!1}}),x=w(()=>{const m=d.value,h=Zl(m.stage,m);if(!h)return null;const y=Rc[h];return y?{type:h,component:y,props:{opportunity:m.opportunity,appointment:m.scheduledAppointment,activities:m.activities}}:null}),b=w(()=>({...d.value,hasActiveTaskWidget:!!x.value})),S=w(()=>{const m=b.value,h=Kl(m.stage,m);if(!h)return null;const y=p[h.key];return{...h,handler:y||(()=>{})}}),i=w(()=>{const m=b.value;return Xl(m.stage,m).map(y=>{const v=p[y.key];return{...y,handler:v||(()=>{})}})}),$=w(()=>{const m=d.value;return ea(m.stage)}),D=w(()=>!x.value||!x.value.type?"":ta(x.value.type));return{primaryAction:S,secondaryActions:i,activeTaskWidget:x,taskWidgetTitle:D,isClosed:$}}const jc={class:"relative"},Wc=["disabled"],Bc={key:0,class:"absolute top-full right-0 mt-2 z-50 dropdown-menu-small"},ks={__name:"SecondaryActionsDropdown",props:{actions:{type:Array,default:()=>[]}},emits:["action-selected"],setup(l,{emit:L}){const r=l,p=L,u=T(!1),d=()=>{u.value=!u.value},x=()=>{u.value=!1},b=i=>{i.disabled||(x(),p("action-selected",i),i.handler&&typeof i.handler=="function"&&i.handler())},S=w(()=>(r.actions||[]).map(i=>({key:i.key,label:i.label,disabled:!!i.disabled,onClick:()=>b(i)})));return(i,$)=>{const D=Il("click-outside");return f(),k("div",jc,[e("button",{onClick:Mn(d,["stop"]),class:"w-auto bg-surface hover:bg-muted border border-border text-muted-foreground font-medium px-4 py-2 rounded-lg text-xs flex items-center justify-between gap-2 transition-colors whitespace-nowrap",disabled:!l.actions||l.actions.length===0},[$[0]||($[0]=e("span",null,"More actions",-1)),e("i",{class:ae(["fa-solid fa-chevron-down text-xs transition-transform duration-200 flex-shrink-0",{"rotate-180":u.value}])},null,2)],8,Wc),u.value&&S.value.length>0?lt((f(),k("div",Bc,[s(t(Sl),{items:S.value,className:"w-56"},null,8,["items"])])),[[D,x]]):q("",!0)])}}},Pc={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},zc={class:"space-y-2"},Yc={class:"space-y-2"},Hc={class:"space-y-2"},Qc={__name:"ContractDateModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(l,{emit:L}){const r=l,p=L,u=T(""),d=T(""),x=T(""),b=w(()=>new Date().toISOString().split("T")[0]);Ce(()=>r.show,D=>{if(D){const m=new Date;u.value=m.toISOString().split("T")[0],d.value=m.toTimeString().slice(0,5),x.value=""}});const S=()=>{if(!u.value)return;const D=d.value?`${u.value}T${d.value}:00`:`${u.value}T12:00:00`;p("confirm",{contractDate:D,notes:x.value})},i=()=>{p("cancel")},$=D=>{D||i()};return(D,m)=>(f(),re(t(Vs),{open:l.show,"onUpdate:open":$},{default:o(()=>[s(t($s),null,{default:o(()=>[s(t(Ds),{class:"fixed inset-0 z-50 bg-black/50"}),s(t(As),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[s(t(Ts),{class:"flex-shrink-0"},{default:o(()=>[s(t(Os),null,{default:o(()=>[...m[3]||(m[3]=[C("Set Contract Signing Date",-1)])]),_:1})]),_:1}),e("div",Pc,[e("div",zc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...m[4]||(m[4]=[C("Contract Date",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:u.value,"onUpdate:modelValue":m[0]||(m[0]=h=>u.value=h),max:b.value,class:"w-full h-10"},null,8,["modelValue","max"])]),e("div",Yc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...m[5]||(m[5]=[C("Time (Optional)",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:d.value,"onUpdate:modelValue":m[1]||(m[1]=h=>d.value=h),class:"w-full h-10"},null,8,["modelValue"])]),e("div",Hc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...m[6]||(m[6]=[C("Notes (Optional)",-1)])]),_:1}),s(t(dt),{modelValue:x.value,"onUpdate:modelValue":m[2]||(m[2]=h=>x.value=h),rows:"4",placeholder:"Add any relevant notes about the contract signing...",class:"w-full min-h-[100px] resize-none"},null,8,["modelValue"])])]),s(t(Is),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[s(t(ee),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:i}),s(t(ee),{label:"Set Contract Date",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!u.value,onClick:S},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Jc={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},Gc={class:"space-y-2"},Zc={class:"space-y-2"},Kc={class:"space-y-2"},Xc={class:"space-y-2"},em={__name:"DeliveryModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(l,{emit:L}){const r=l,p=L,u=T(""),d=T(""),x=T(""),b=T(""),S=w(()=>new Date().toISOString().split("T")[0]);Ce(()=>r.show,m=>{if(m){const h=new Date;u.value=h.toISOString().split("T")[0],d.value=h.toTimeString().slice(0,5),x.value="",b.value=""}});const i=()=>{if(!u.value||!x.value)return;const m=d.value?`${u.value}T${d.value}:00`:`${u.value}T12:00:00`;p("confirm",{deliveryDate:m,location:x.value,notes:b.value})},$=()=>{p("cancel")},D=m=>{m||$()};return(m,h)=>(f(),re(t(Vs),{open:l.show,"onUpdate:open":D},{default:o(()=>[s(t($s),null,{default:o(()=>[s(t(Ds),{class:"fixed inset-0 z-50 bg-black/50"}),s(t(As),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[s(t(Ts),{class:"flex-shrink-0"},{default:o(()=>[s(t(Os),null,{default:o(()=>[...h[4]||(h[4]=[C("Mark as Delivered",-1)])]),_:1})]),_:1}),e("div",Jc,[e("div",Gc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...h[5]||(h[5]=[C("Delivery Date",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:u.value,"onUpdate:modelValue":h[0]||(h[0]=y=>u.value=y),max:S.value,class:"w-full h-10"},null,8,["modelValue","max"])]),e("div",Zc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...h[6]||(h[6]=[C("Time (Optional)",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:d.value,"onUpdate:modelValue":h[1]||(h[1]=y=>d.value=y),class:"w-full h-10"},null,8,["modelValue"])]),e("div",Kc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...h[7]||(h[7]=[C("Delivery Location",-1)])]),_:1}),s(t(It),{modelValue:x.value,"onUpdate:modelValue":h[2]||(h[2]=y=>x.value=y)},{default:o(()=>[s(t(At),{class:"w-full h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select location..."})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Dealership"},{default:o(()=>[...h[8]||(h[8]=[C("At Dealership",-1)])]),_:1}),s(t(fe),{value:"Customer Address"},{default:o(()=>[...h[9]||(h[9]=[C("Customer Address",-1)])]),_:1}),s(t(fe),{value:"Other"},{default:o(()=>[...h[10]||(h[10]=[C("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",Xc,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...h[11]||(h[11]=[C("Delivery Notes",-1)])]),_:1}),s(t(dt),{modelValue:b.value,"onUpdate:modelValue":h[3]||(h[3]=y=>b.value=y),rows:"4",placeholder:"Add any relevant delivery details, customer feedback, etc...",class:"w-full min-h-[100px] resize-none"},null,8,["modelValue"])])]),s(t(Is),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[s(t(ee),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:$}),s(t(ee),{label:"Mark as Delivered",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-green-600 !hover:bg-green-700 !border-green-600",disabled:!u.value||!x.value,onClick:i},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},tm={class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},sm={class:"space-y-2"},nm={class:"space-y-2"},zn={__name:"CloseAsLostModal",props:{show:{type:Boolean,required:!0},preselectedReason:{type:String,default:""}},emits:["confirm","cancel"],setup(l,{emit:L}){const r=l,p=L,u=T(""),d=T("");Ce(()=>r.show,i=>{i&&(r.preselectedReason?u.value=r.preselectedReason:u.value="",d.value="")}),Ce(()=>r.preselectedReason,i=>{i&&r.show&&(u.value=i)});const x=()=>{u.value&&p("confirm",{reason:u.value,notes:d.value})},b=()=>{p("cancel")},S=i=>{i||b()};return(i,$)=>(f(),re(t(Vs),{open:l.show,"onUpdate:open":S},{default:o(()=>[s(t($s),null,{default:o(()=>[s(t(Ds),{class:"fixed inset-0 z-50 bg-black/50"}),s(t(As),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[s(t(Ts),{class:"flex-shrink-0"},{default:o(()=>[s(t(Os),null,{default:o(()=>[...$[2]||($[2]=[C("Close as Lost",-1)])]),_:1})]),_:1}),e("div",tm,[e("div",sm,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...$[3]||($[3]=[C("Reason",-1)])]),_:1}),s(t(It),{modelValue:u.value,"onUpdate:modelValue":$[0]||($[0]=D=>u.value=D)},{default:o(()=>[s(t(At),{class:"w-full h-10"},{default:o(()=>[s(t(Tt),{placeholder:"Select a reason..."})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Multiple no shows"},{default:o(()=>[...$[4]||($[4]=[C("Multiple no shows",-1)])]),_:1}),s(t(fe),{value:"Not interested"},{default:o(()=>[...$[5]||($[5]=[C("Not interested",-1)])]),_:1}),s(t(fe),{value:"Budget constraints"},{default:o(()=>[...$[6]||($[6]=[C("Budget constraints",-1)])]),_:1}),s(t(fe),{value:"Found better price"},{default:o(()=>[...$[7]||($[7]=[C("Found better price at competitor",-1)])]),_:1}),s(t(fe),{value:"No response"},{default:o(()=>[...$[8]||($[8]=[C("Customer not responding",-1)])]),_:1}),s(t(fe),{value:"Wrong timing"},{default:o(()=>[...$[9]||($[9]=[C("Timing not right",-1)])]),_:1}),s(t(fe),{value:"Other"},{default:o(()=>[...$[10]||($[10]=[C("Other",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",nm,[s(t(H),{class:"block text-sm font-semibold text-foreground"},{default:o(()=>[...$[11]||($[11]=[C("Additional Notes",-1)])]),_:1}),s(t(dt),{modelValue:d.value,"onUpdate:modelValue":$[1]||($[1]=D=>d.value=D),rows:"5",placeholder:"Add any relevant details about why this opportunity was lost...",class:"w-full min-h-[120px] resize-none"},null,8,["modelValue"])])]),s(t(Is),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[s(t(ee),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:b}),s(t(ee),{label:"Close as Lost",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-red-600 !hover:bg-red-700 !border-red-600",disabled:!u.value,onClick:x},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},lm={__name:"RequalifyAsLeadModal",props:{show:{type:Boolean,required:!0}},emits:["confirm","cancel"],setup(l,{emit:L}){const r=L,p=u=>{u||r("cancel")};return(u,d)=>(f(),re(t(Vs),{open:l.show,"onUpdate:open":p},{default:o(()=>[s(t($s),null,{default:o(()=>[s(t(Ds),{class:"fixed inset-0 z-50 bg-black/50"}),s(t(As),{class:"w-full sm:max-w-lg max-h-[calc(100vh-4rem)] flex flex-col"},{default:o(()=>[s(t(Ts),{class:"flex-shrink-0"},{default:o(()=>[s(t(Os),null,{default:o(()=>[...d[2]||(d[2]=[C("Requalify as Lead",-1)])]),_:1})]),_:1}),d[3]||(d[3]=e("div",{class:"flex-1 overflow-y-auto px-6 py-4 w-full space-y-6"},[e("div",{class:"flex items-start gap-4 mb-6"},[e("div",{class:"flex-shrink-0"},[e("div",{class:"w-12 h-12 rounded-sm bg-yellow-100 flex items-center justify-center border border-yellow-200"},[e("i",{class:"fa-solid fa-exclamation-triangle text-yellow-600 text-xl"})])]),e("div",{class:"flex-1"},[e("p",{class:"text-meta"}," Requalifying this opportunity will reset its stage and remove negotiation history. ")])]),e("div",null,[e("h4",{class:"text-sm font-bold text-red-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-times-circle"}),C(" What will be lost ")]),e("ul",{class:"space-y-2 text-sm text-muted-foreground"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity stage and expected close date")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Opportunity value and negotiation history")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Stock or configured vehicles added to the opportunity")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-minus text-red-500 text-xs mt-1"}),e("span",null,"Offer history and negotiation data")])])]),e("div",null,[e("h4",{class:"text-sm font-bold text-green-700 mb-3 flex items-center gap-2"},[e("i",{class:"fa-solid fa-check-circle"}),C(" What will be kept ")]),e("ul",{class:"space-y-2 text-sm text-muted-foreground"},[e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Customer information and contact details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"Original requested car details")]),e("li",{class:"flex items-start gap-2"},[e("i",{class:"fa-solid fa-check text-green-500 text-xs mt-1"}),e("span",null,"All activities (notes, calls, emails, etc.)")])])]),e("div",{class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4"},[e("p",{class:"text-sm text-yellow-800"},[e("i",{class:"fa-solid fa-info-circle mr-2"}),C(" This action cannot be undone. The opportunity will be permanently removed and replaced with a new lead. ")])])],-1)),s(t(Is),{class:"flex-shrink-0 flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:o(()=>[s(t(ee),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:d[0]||(d[0]=x=>u.$emit("cancel"))}),s(t(ee),{label:"Confirm Requalification",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-yellow-600 !hover:bg-yellow-700 !border-yellow-600",onClick:d[1]||(d[1]=x=>u.$emit("confirm"))})]),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},am={class:"space-y-4"},om={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},im={key:0,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},rm={class:"grid grid-cols-2 gap-4"},um={class:"flex items-center gap-2"},dm={class:"text-muted-foreground"},cm={class:"font-medium text-foreground"},mm={class:"flex items-center gap-2"},pm={class:"font-medium text-foreground"},fm={key:1,class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},vm={class:"bg-white border border-border rounded-lg overflow-hidden"},gm={class:"grid grid-cols-1 md:grid-cols-2 divide-x divide-black/5"},ym={class:"p-6"},hm={class:"flex items-center justify-between mb-4"},bm={class:"text-sm font-semibold text-foreground"},xm={class:"grid grid-cols-7 gap-1 mb-2"},wm={class:"grid grid-cols-7 gap-1"},km=["onClick"],Sm={class:"p-6"},Cm={class:"text-sm font-semibold text-foreground mb-4"},$m={key:0,class:"space-y-2"},Dm=["onClick"],Am={key:1,class:"text-sm text-muted-foreground py-4 text-center"},Tm={key:2,class:"text-sm text-muted-foreground py-4 text-center"},Om={class:"flex justify-end gap-2 px-4 pb-4 pt-3"},Tn={__name:"OpportunityScheduleForm",props:{opportunity:{type:Object,required:!0},mode:{type:String,validator:l=>["schedule","reschedule"].includes(l),default:"schedule"},initialAppointment:{type:Object,default:null}},emits:["submit","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=Ut(),x=T(""),b=T(null),S=T(""),i=T(null),$=T(null),D=T(null),m=T(""),h=T(new Date().getMonth()),y=T(new Date().getFullYear()),v=T({immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}),A=[{value:"appointment-on-phone",label:"Appointment on the phone (15m)"},{value:"appointment-at-dealership",label:"Appointment at the dealership (30m)"},{value:"recall-internal",label:"Recall - internal (15m)"},{value:"appointment-at-dealership-test-drive",label:"Appointment at the dealership + Test drive (1h)"},{value:"appointment-at-workshop",label:"Appointment at the workshop (15m)"},{value:"appointment-at-customer-site",label:"Appointment at customer's site (1h 40m)"},{value:"appointment-at-customer-site-test-drive",label:"Appointment at customer's site + Test drive (5h)"}],g={"appointment-on-phone":15,"appointment-at-dealership":30,"recall-internal":15,"appointment-at-dealership-test-drive":60,"appointment-at-workshop":15,"appointment-at-customer-site":100,"appointment-at-customer-site-test-drive":300},M=w(()=>A.map(j=>({value:j.value,label:j.label}))),B=w(()=>{const j=[];for(let W=9*60;W<=18*60;W+=30){const pe=String(Math.floor(W/60)).padStart(2,"0"),K=String(W%60).padStart(2,"0");j.push(`${pe}:${K}`)}return j}),R=w(()=>{if(D.value!=null)return D.value;const j=parseInt(m.value,10);return Number.isFinite(j)&&j>0?j:null}),J=w(()=>p.mode==="reschedule"?"Reschedule and Save":"Schedule and Save"),ce=w(()=>!!(x.value&&b.value&&S.value&&i.value)),_=["MON","TUE","WED","THU","FRI","SAT","SUN"],V=w(()=>new Date(y.value,h.value).toLocaleDateString("en-US",{month:"long",year:"numeric"})),F=w(()=>{const j=new Date(y.value,h.value,1),pe=new Date(y.value,h.value+1,0).getDate(),K=j.getDay()===0?6:j.getDay()-1,P=[];for(let te=0;te<K;te++)P.push(null);for(let te=1;te<=pe;te++)P.push(te);return P}),E=w(()=>{if(!b.value)return"Select a date";const j=b.value,W=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],pe=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return`${W[j.getDay()]}, ${pe[j.getMonth()]} ${j.getDate()}`}),Q=w(()=>d.assignableUsers),oe=w(()=>d.assignableTeams),G=w(()=>oe.value.map(j=>({...j,label:`${j.dealership||"No location"} → ${j.name}`,value:j.id}))),$e=w(()=>{var pe;if(!i.value)return[];const j=i.value;return(((pe=Q.value)==null?void 0:pe.filter(K=>K.team===j.name||K.teamId===j.id))||[]).map(K=>({...K,label:K.name,value:K.id}))}),qe=w({get:()=>{var j;return((j=i.value)==null?void 0:j.id)||null},set:j=>{var pe;if(!j){i.value=null,$.value=null;return}const W=(pe=oe.value)==null?void 0:pe.find(K=>K.id===j);i.value=W||null,W&&X(`team-${W.id}`)}}),me=w({get:()=>{var j;return((j=$.value)==null?void 0:j.id)||null},set:j=>{if(!j){$.value=null;return}const W=$e.value.find(pe=>pe.id===j);$.value=W||null,W&&X(`user-${W.id}`)}}),se=w(()=>{if(!b.value)return[];const j=b.value.toISOString().split("T")[0];if($.value){const W=Ht(`user-${$.value.id}`,j);return B.value.filter(pe=>W.includes(pe))}if(i.value){const W=Ht(`team-${i.value.id}`,j);return B.value.filter(pe=>W.includes(pe))}return B.value||[]});function ne(j){return j?j.split(" ").map(W=>W[0]).join("").toUpperCase().substring(0,2):"?"}function ke(j){return{manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"}[j]||"bg-muted text-muted-foreground"}function Ue(j){if(!j)return;const W=new Date(y.value,h.value,j);b.value=W,S.value=""}function Me(j){if(!j||!b.value)return!1;const W=b.value;return W.getDate()===j&&W.getMonth()===h.value&&W.getFullYear()===y.value}function ft(){h.value===0?(h.value=11,y.value--):h.value--}function z(){h.value===11?(h.value=0,y.value++):h.value++}function X(j){const W=new Date;W.setHours(0,0,0,0);for(let pe=0;pe<30;pe++){const K=new Date(W);if(K.setDate(W.getDate()+pe),K.getDay()===0||K.getDay()===6)continue;const P=K.toISOString().split("T")[0],te=Ht(j,P);if(te!=null&&te.length){b.value=K,h.value=K.getMonth(),y.value=K.getFullYear();const ue=B.value.filter(he=>te.includes(he));ue.length&&(S.value=ue[0]);break}}}function Xe(j){v.value=j}function at(){Ge(),u("cancel")}function Ge(){x.value="",b.value=null,S.value="",i.value=null,$.value=null,D.value=null,m.value="",v.value={immediateConfirmation:{enabled:!0,channels:["email"]},reminder:{enabled:!0,channels:["email"]},salespersonNotification:{enabled:!0}}}function _e(j){var W,pe,K;if(j){if(x.value=j.type||"",j.assignee){const P=(W=Q.value)==null?void 0:W.find(ue=>ue.name===j.assignee),te=(pe=oe.value)==null?void 0:pe.find(ue=>ue.name===j.assignee);if(P){const ue=(K=oe.value)==null?void 0:K.find(he=>he.name===P.team||he.id===P.teamId);ue&&(i.value=ue,$.value=P)}else te&&(i.value=te)}if(j.start){const P=new Date(j.start),te=new Date(P.getFullYear(),P.getMonth(),P.getDate());b.value=te,h.value=P.getMonth(),y.value=P.getFullYear();const ue=P.getHours(),he=P.getMinutes(),ve=he<15?0:he<45?30:60,je=ve===60?ue+1:ue,Re=ve===60?0:ve,Ye=`${String(je).padStart(2,"0")}:${String(Re).padStart(2,"0")}`;if(B.value.includes(Ye))S.value=Ye;else{const He=je*60+Re,xe=B.value.reduce((we,Ee)=>{const[de,ie]=Ee.split(":").map(Number),Se=de*60+ie;if(!we)return Ee;const[be,ge]=we.split(":").map(Number),Ae=be*60+ge;return Math.abs(Se-He)<Math.abs(Ae-He)?Ee:we},null);S.value=xe||B.value[0]||""}}if(j.duration){const P=j.duration;P===15?D.value=15:P===30?D.value=30:P===60?D.value=60:(D.value=null,m.value=String(P))}}}Ce(x,j=>{if(!j)return;const W=g[j];if(W&&(W===15?D.value=15:W===30?D.value=30:W===60?D.value=60:(D.value=null,m.value=String(W)),!b.value)){const pe=new Date;pe.setHours(0,0,0,0),b.value=pe,h.value=pe.getMonth(),y.value=pe.getFullYear()}}),Ce(b,()=>{S.value=""}),Ce(()=>p.opportunity.assignee,j=>{var K,P,te;if(!j||i.value||$.value)return;const W=(K=Q.value)==null?void 0:K.find(ue=>ue.name===j),pe=(P=oe.value)==null?void 0:P.find(ue=>ue.name===j);if(W){const ue=(te=oe.value)==null?void 0:te.find(he=>he.name===W.team||he.id===W.teamId);ue&&(i.value=ue,$.value=W)}else pe&&(i.value=pe)},{immediate:!0}),Ls(()=>{p.mode==="reschedule"&&p.initialAppointment&&_e(p.initialAppointment)});function Ve(){ce.value&&u("submit",{eventType:x.value,selectedDate:b.value,selectedSlot:S.value,selectedTeam:i.value,selectedSalesman:$.value,durationValue:R.value,communicationPreferences:v.value})}return L({resetForm:Ge}),(j,W)=>{var pe;return f(),k("div",am,[e("div",om,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...W[3]||(W[3]=[C("Event type ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:x.value,"onUpdate:modelValue":W[0]||(W[0]=K=>x.value=K),items:M.value,placeholder:"Select event type...","value-key":"value",class:"w-full"},{item:o(({item:K})=>[e("span",null,I(K.label),1)]),_:1},8,["modelValue","items"])]),x.value?(f(),k("div",im,[W[7]||(W[7]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign appointment to",-1)),e("div",rm,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...W[4]||(W[4]=[C("Team",-1)])]),_:1}),s(t(st),{modelValue:qe.value,"onUpdate:modelValue":W[1]||(W[1]=K=>qe.value=K),items:G.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",um,[e("span",dm,I(K.dealership||"No location"),1),W[5]||(W[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",cm,I(K.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...W[6]||(W[6]=[C("Salesperson (optional)",-1)])]),_:1}),s(t(st),{modelValue:me.value,"onUpdate:modelValue":W[2]||(W[2]=K=>me.value=K),items:$e.value,disabled:!i.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:K})=>[e("div",mm,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",ke(K.role)])},I(ne(K.name)),3),e("span",pm,I(K.name),1)])]),_:1},8,["modelValue","items","disabled"])])])])):q("",!0),x.value&&i.value?(f(),k("div",fm,[W[10]||(W[10]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},[C("Schedule "),e("span",{class:"text-red-600"},"*")],-1)),e("div",vm,[e("div",gm,[e("div",ym,[e("div",hm,[e("button",{type:"button",onClick:ft,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...W[8]||(W[8]=[e("i",{class:"fa-solid fa-chevron-left text-sm text-muted-foreground"},null,-1)])]),e("h6",bm,I(V.value),1),e("button",{type:"button",onClick:z,class:"p-1 hover:bg-muted rounded transition-colors cursor-pointer"},[...W[9]||(W[9]=[e("i",{class:"fa-solid fa-chevron-right text-sm text-muted-foreground"},null,-1)])])]),e("div",xm,[(f(),k(Le,null,Je(_,K=>e("div",{key:K,class:"text-center text-xs font-semibold text-muted-foreground py-1"},I(K),1)),64))]),e("div",wm,[(f(!0),k(Le,null,Je(F.value,(K,P)=>(f(),k("div",{key:P,onClick:te=>K&&Ue(K),class:ae(["aspect-square flex items-center justify-center text-sm font-medium rounded-lg transition-all",Me(K)?"bg-primary text-white cursor-pointer":K?"text-muted-foreground hover:bg-muted cursor-pointer":"text-transparent"])},I(K),11,km))),128))])]),e("div",Sm,[e("h6",Cm,I(E.value),1),b.value&&se.value.length>0?(f(),k("div",$m,[(f(!0),k(Le,null,Je(se.value,K=>(f(),k("button",{key:K,type:"button",onClick:P=>S.value=K,class:ae(["w-full py-2 px-4 border-2 rounded-lg text-sm font-medium transition-all cursor-pointer",S.value===K?"border-primary bg-muted text-foreground":"border-border text-muted-foreground hover:border-primary/30"])},I(K),11,Dm))),128))])):b.value&&se.value.length===0?(f(),k("div",Am," No available time slots for this date ")):(f(),k("div",Tm," Select a date to see available time slots "))])])])])):q("",!0),x.value&&i.value?(f(),re(rl,{key:2,appointment:{type:x.value,date:b.value,time:S.value,duration:R.value},customer:l.opportunity.customer,salesperson:$.value,team:i.value,dealership:(pe=i.value)!=null&&pe.dealership?{name:i.value.dealership}:null,onUpdate:Xe},null,8,["appointment","customer","salesperson","team","dealership"])):q("",!0),e("div",Om,[s(t(ee),{variant:"secondary",onClick:at},{default:o(()=>[...W[11]||(W[11]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!ce.value,onClick:Ve},{default:o(()=>[C(I(J.value),1)]),_:1},8,["disabled"])])])}}},Im={class:"space-y-4"},Vm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Nm={class:"text-sm text-muted-foreground"},Lm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Mm={class:"grid grid-cols-2 gap-4"},qm={class:"flex items-center gap-2"},Um={class:"text-muted-foreground"},_m={class:"font-medium text-foreground"},Fm={class:"flex items-center gap-2"},Rm={class:"font-medium text-foreground"},Em={class:"mt-4"},jm={__name:"NS1Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["assigned","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=Ut(),x=Vt(),b=qt(),S=T(null),i=T(null),$=T(""),D=w(()=>d.assignableUsers),m=w(()=>d.assignableTeams),h=w(()=>m.value.map(_=>({..._,label:`${_.dealership||"No location"} → ${_.name}`,value:_.id}))),y=w(()=>{var F;if(!S.value)return[];const _=S.value;return(((F=D.value)==null?void 0:F.filter(E=>E.team===_.name||E.teamId===_.id))||[]).map(E=>({...E,label:E.name,value:E.id}))}),v=w({get:()=>{var _;return((_=S.value)==null?void 0:_.id)||null},set:_=>{var F;if(!_){S.value=null;return}const V=(F=m.value)==null?void 0:F.find(E=>E.id===_);S.value=V||null,V&&(i.value=null)}}),A=w({get:()=>{var _;return((_=i.value)==null?void 0:_.id)||null},set:_=>{if(!_){i.value=null;return}const V=y.value.find(F=>F.id===_);i.value=V||null}}),g=_=>_?_.split(" ").map(V=>V[0]).join("").toUpperCase().substring(0,2):"?",M=_=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[_]||"bg-muted text-muted-foreground",B=w(()=>!!S.value);async function R(){var F,E,Q;if(!B.value)return;const _=((F=i.value)==null?void 0:F.name)||((E=S.value)==null?void 0:E.name),V={assignee:_};$.value&&(V.assignmentNote=$.value),await b.updateOpportunity(p.opportunity.id,V),await b.addActivity(p.opportunity.id,{type:"assignment",user:((Q=x.currentUser)==null?void 0:Q.name)||"You",action:"assigned opportunity",content:`Opportunity assigned to ${_}${$.value?` with note: ${$.value}`:""}`,timestamp:new Date().toISOString()}),u("assigned",{opportunity:p.opportunity,assignee:_,note:$.value})}L({canSubmit:B,submit:R});const J=w(()=>"Follow up with customer to understand the situation and book another appointment."),ce=w(()=>{var V;return(V=p.scheduledAppointment)!=null&&V.start?new Date(p.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"});return Ls(()=>{var _,V,F;if(p.opportunity.assignee&&!S.value&&!i.value){const E=(_=D.value)==null?void 0:_.find(oe=>oe.name===p.opportunity.assignee),Q=(V=m.value)==null?void 0:V.find(oe=>oe.name===p.opportunity.assignee);if(E){const oe=(F=m.value)==null?void 0:F.find(G=>G.name===E.team||G.id===E.teamId);oe&&(S.value=oe,i.value=E)}else Q&&(S.value=Q)}p.opportunity.assignmentNote&&($.value=p.opportunity.assignmentNote)}),Ce(()=>p.opportunity.assignee,_=>{var V,F,E;if(_&&!S.value&&!i.value){const Q=(V=D.value)==null?void 0:V.find(G=>G.name===_),oe=(F=m.value)==null?void 0:F.find(G=>G.name===_);if(Q){const G=(E=m.value)==null?void 0:E.find($e=>$e.name===Q.team||$e.id===Q.teamId);G&&(S.value=G,i.value=Q)}else oe&&(S.value=oe)}}),(_,V)=>(f(),k("div",Im,[e("div",Vm,[V[3]||(V[3]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"1st No-Show Follow-up Task",-1)),e("p",Nm," Appointment was scheduled for "+I(ce.value)+" but customer did not show up. "+I(J.value),1)]),e("div",Lm,[V[8]||(V[8]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign to",-1)),e("div",Mm,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[4]||(V[4]=[C("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:v.value,"onUpdate:modelValue":V[0]||(V[0]=F=>v.value=F),items:h.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:F})=>[e("div",qm,[e("span",Um,I(F.dealership||"No location"),1),V[5]||(V[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",_m,I(F.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[6]||(V[6]=[C("Salesperson ",-1),e("span",{class:"text-muted-foreground text-xs"},"(optional)",-1)])]),_:1}),s(t(st),{modelValue:A.value,"onUpdate:modelValue":V[1]||(V[1]=F=>A.value=F),items:y.value,disabled:!S.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:F})=>[e("div",Fm,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",M(F.role)])},I(g(F.name)),3),e("span",Rm,I(F.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",Em,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[7]||(V[7]=[C("Notes for assignee",-1)])]),_:1}),s(t(dt),{modelValue:$.value,"onUpdate:modelValue":V[2]||(V[2]=F=>$.value=F),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])]))}},Wm={class:"space-y-4"},Bm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Pm={class:"text-sm text-muted-foreground"},zm={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Ym={class:"grid grid-cols-2 gap-4"},Hm={class:"flex items-center gap-2"},Qm={class:"text-muted-foreground"},Jm={class:"font-medium text-foreground"},Gm={class:"flex items-center gap-2"},Zm={class:"font-medium text-foreground"},Km={class:"mt-4"},Xm={__name:"NS2Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["assigned","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=Ut(),x=Vt(),b=qt(),S=T(null),i=T(null),$=T(""),D=w(()=>d.assignableUsers),m=w(()=>d.assignableTeams),h=w(()=>m.value.map(_=>({..._,label:`${_.dealership||"No location"} → ${_.name}`,value:_.id}))),y=w(()=>{var F;if(!S.value)return[];const _=S.value;return(((F=D.value)==null?void 0:F.filter(E=>E.team===_.name||E.teamId===_.id))||[]).map(E=>({...E,label:E.name,value:E.id}))}),v=w({get:()=>{var _;return((_=S.value)==null?void 0:_.id)||null},set:_=>{var F;if(!_){S.value=null;return}const V=(F=m.value)==null?void 0:F.find(E=>E.id===_);S.value=V||null,V&&(i.value=null)}}),A=w({get:()=>{var _;return((_=i.value)==null?void 0:_.id)||null},set:_=>{if(!_){i.value=null;return}const V=y.value.find(F=>F.id===_);i.value=V||null}}),g=_=>_?_.split(" ").map(V=>V[0]).join("").toUpperCase().substring(0,2):"?",M=_=>({manager:"bg-blue-100 text-blue-700",salesman:"bg-purple-100 text-purple-700",operator:"bg-orange-100 text-orange-700"})[_]||"bg-muted text-muted-foreground",B=w(()=>!!S.value);async function R(){var F,E,Q;if(!B.value)return;const _=((F=i.value)==null?void 0:F.name)||((E=S.value)==null?void 0:E.name),V={assignee:_};$.value&&(V.assignmentNote=$.value),await b.updateOpportunity(p.opportunity.id,V),await b.addActivity(p.opportunity.id,{type:"assignment",user:((Q=x.currentUser)==null?void 0:Q.name)||"You",action:"assigned opportunity",content:`Opportunity assigned to ${_}${$.value?` with note: ${$.value}`:""}`,timestamp:new Date().toISOString()}),u("assigned",{opportunity:p.opportunity,assignee:_,note:$.value})}L({canSubmit:B,submit:R});const J=w(()=>"This is the second no-show. Please make every effort to reach the customer and reschedule."),ce=w(()=>{var V;return(V=p.scheduledAppointment)!=null&&V.start?new Date(p.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"});return Ls(()=>{var _,V,F;if(p.opportunity.assignee&&!S.value&&!i.value){const E=(_=D.value)==null?void 0:_.find(oe=>oe.name===p.opportunity.assignee),Q=(V=m.value)==null?void 0:V.find(oe=>oe.name===p.opportunity.assignee);if(E){const oe=(F=m.value)==null?void 0:F.find(G=>G.name===E.team||G.id===E.teamId);oe&&(S.value=oe,i.value=E)}else Q&&(S.value=Q)}p.opportunity.assignmentNote&&($.value=p.opportunity.assignmentNote)}),Ce(()=>p.opportunity.assignee,_=>{var V,F,E;if(_&&!S.value&&!i.value){const Q=(V=D.value)==null?void 0:V.find(G=>G.name===_),oe=(F=m.value)==null?void 0:F.find(G=>G.name===_);if(Q){const G=(E=m.value)==null?void 0:E.find($e=>$e.name===Q.team||$e.id===Q.teamId);G&&(S.value=G,i.value=Q)}else oe&&(S.value=oe)}}),(_,V)=>(f(),k("div",Wm,[e("div",Bm,[V[3]||(V[3]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"2nd No-Show Follow-up Task",-1)),e("p",Pm," Appointment was scheduled for "+I(ce.value)+" but customer did not show up. "+I(J.value),1)]),e("div",zm,[V[8]||(V[8]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Assign to",-1)),e("div",Ym,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[4]||(V[4]=[C("Team ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(st),{modelValue:v.value,"onUpdate:modelValue":V[0]||(V[0]=F=>v.value=F),items:h.value,placeholder:"Search and select team...","value-key":"id",class:"w-full"},{item:o(({item:F})=>[e("div",Hm,[e("span",Qm,I(F.dealership||"No location"),1),V[5]||(V[5]=e("span",{class:"text-muted-foreground"},"→",-1)),e("span",Jm,I(F.name),1)])]),_:1},8,["modelValue","items"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[6]||(V[6]=[C("Salesperson ",-1),e("span",{class:"text-muted-foreground text-xs"},"(optional)",-1)])]),_:1}),s(t(st),{modelValue:A.value,"onUpdate:modelValue":V[1]||(V[1]=F=>A.value=F),items:y.value,disabled:!S.value,placeholder:"Search and select salesperson...","value-key":"id",class:"w-full"},{item:o(({item:F})=>[e("div",Gm,[e("div",{class:ae(["w-6 h-6 rounded-full flex items-center justify-center font-semibold text-sm shrink-0",M(F.role)])},I(g(F.name)),3),e("span",Zm,I(F.name),1)])]),_:1},8,["modelValue","items","disabled"])])]),e("div",Km,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-1.5"},{default:o(()=>[...V[7]||(V[7]=[C("Notes for assignee",-1)])]),_:1}),s(t(dt),{modelValue:$.value,"onUpdate:modelValue":V[2]||(V[2]=F=>$.value=F),rows:"4",class:"w-full",placeholder:"Add any notes or instructions for the assignee..."},null,8,["modelValue"])])])]))}},ep={class:"space-y-4"},tp={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},sp={class:"text-sm text-muted-foreground"},np={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},lp={__name:"NS3Task",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["close-as-lost","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=T(null),x=w(()=>"This is the third no-show. The opportunity will be automatically closed as lost if another appointment is not successfully completed."),b=w(()=>{var m;return(m=p.scheduledAppointment)!=null&&m.start?new Date(p.scheduledAppointment.start).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"unknown date"}),S=w(()=>{var D;return((D=d.value)==null?void 0:D.canSubmit)||!1});function i(){var D;(D=d.value)==null||D.submit()}function $(D){u("close-as-lost",{opportunity:p.opportunity,reason:D})}return L({canSubmit:S,submit:i}),(D,m)=>(f(),k("div",ep,[e("div",tp,[m[0]||(m[0]=e("h4",{class:"font-bold text-foreground text-sm mb-1"},"3rd No-Show Follow-up Task",-1)),e("p",sp," Appointment was scheduled for "+I(b.value)+" but customer did not show up. "+I(x.value),1)]),e("div",np,[m[1]||(m[1]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Close Opportunity as Lost",-1)),s(Un,{ref_key:"closeFormRef",ref:d,"show-multiple-no-shows":!0,"preselected-reason":"Multiple no shows","close-button-label":"Close as Lost",onClose:$},null,512)])]))}},ap={class:"space-y-4"},op={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},ip={__name:"OfferAssignmentTask",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,required:!0}},emits:["offer-created","cancel"],setup(l,{expose:L,emit:r}){const p=l,u=r,d=T(null),x=w(()=>p.opportunity.requestedCar||p.opportunity.vehicle||null),b=w(()=>{var $;return(($=d.value)==null?void 0:$.isValid)||!1});function S(){var $;($=d.value)==null||$.submit()}function i($){u("offer-created",{opportunity:p.opportunity,offerData:$})}return L({canSubmit:b,submit:S}),($,D)=>(f(),k("div",ap,[D[0]||(D[0]=e("div",{class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},[e("h4",{class:"font-bold text-foreground text-sm mb-1"},"Create Offer"),e("p",{class:"text-sm text-muted-foreground"}," Customer showed up for the appointment. Create an offer to proceed with the opportunity. ")],-1)),e("div",op,[s(Zs,{item:null,"task-type":"opportunity","task-id":l.opportunity.id,"selected-vehicle":x.value,customer:l.opportunity.customer,"hide-header":!0,"hide-actions":!0,ref_key:"offerWidgetRef",ref:d,onSave:i},null,8,["task-id","selected-vehicle","customer"])])]))}},rp={key:1,class:"rounded-lg flex flex-col bg-muted"},up={class:"pt-1 px-1"},dp={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},cp={class:"p-6"},mp={class:"mb-3"},pp={class:"text-sm text-muted-foreground mt-0.5"},fp={key:0,class:"ml-2"},vp=["href"],gp={class:"flex flex-wrap gap-3 items-center"},yp={class:"outcome-toggle-group flex flex-wrap gap-3"},hp={class:"px-4 py-4 space-y-4"},bp={key:0},xp={key:1},wp={key:2,class:"flex justify-end gap-2 px-4 pb-4 pt-3"},kp={key:0,class:"mt-4"},Sp={key:3,class:"flex justify-end gap-2 px-4 pb-4 pt-3"},Cp={key:0,class:"rounded-lg flex flex-col bg-muted"},$p={class:"pt-1 px-1"},Dp={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Ap={class:"p-6"},Tp={class:"mb-3"},Op={class:"text-sm text-muted-foreground mt-0.5"},Ip={key:0,class:"mb-4"},Vp={key:1,class:"mb-4 p-4 bg-muted rounded-lg"},Np={class:"flex flex-wrap gap-3 items-center"},Lp={class:"outcome-toggle-group flex flex-wrap gap-3"},Mp={class:"px-4 py-4 space-y-4"},qp={key:0,class:"space-y-4"},Up={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},_p={class:"followup-channel-toggle-group flex flex-wrap gap-2 mb-4"},Fp={key:0,class:"space-y-3"},Rp={key:0},Ep={class:"flex items-center justify-between gap-2"},jp={class:"text-muted-foreground text-xs"},Wp={key:0,class:"flex justify-end gap-2 pt-3"},Bp={key:1},Pp={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},zp={key:2,class:"flex justify-end gap-2 pt-3"},Yp={key:2,class:"rounded-lg flex flex-col bg-muted"},Hp={class:"pt-1 px-1"},Qp={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Jp={class:"p-6"},Gp={class:"flex flex-wrap gap-3 items-center"},Zp={class:"outcome-toggle-group flex flex-wrap gap-3"},Kp={class:"px-4 py-4 space-y-4"},Xp={key:0},ef={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},tf={class:"space-y-4"},sf={class:"flex justify-end gap-2 mt-4"},nf={key:1},lf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},af={key:2,class:"flex justify-end gap-2 pt-3"},of={key:3},rf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},uf={class:"space-y-4"},df={class:"flex justify-end gap-2 mt-4"},cf={key:4},mf={key:0,class:"space-y-4"},pf={key:0,class:"bg-blue-50 border border-blue-200 rounded-lg p-4"},ff={class:"flex items-start gap-3"},vf={class:"flex-1"},gf={class:"text-sm text-muted-foreground whitespace-pre-wrap"},yf={class:"rounded-lg flex flex-col bg-muted"},hf={class:"pt-1 px-1"},bf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden"},xf={class:"p-6"},wf={class:"px-4 py-4"},kf={key:1,class:"rounded-lg flex flex-col bg-muted"},Sf={class:"pt-1 px-1"},Cf={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},$f={class:"p-6"},Df={class:"mb-3"},Af={class:"font-bold text-foreground text-sm"},Tf={class:"text-sm text-muted-foreground mt-0.5"},Of={class:"flex flex-wrap gap-3 items-center"},If={class:"outcome-toggle-group flex flex-wrap gap-3"},Vf={class:"px-4 py-4 space-y-4"},Nf={key:0},Lf={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Mf={class:"space-y-4"},qf={class:"flex justify-end gap-2 mt-4"},Uf={key:1},_f={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},Ff={class:"text-sm text-muted-foreground mb-4"},Rf={class:"space-y-4"},Ef={class:"flex justify-end gap-2 mt-4"},jf={key:2,class:"rounded-lg flex flex-col bg-muted"},Wf={class:"pt-1 px-1"},Bf={class:"bg-white rounded-lg shadow-nsc-card overflow-visible"},Pf={class:"p-6"},zf={class:"mb-3"},Yf={key:0,class:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg"},Hf={class:"flex items-start gap-2"},Qf={class:"flex-1"},Jf={class:"text-sm text-red-700 mt-1"},Gf={key:0,class:"text-sm text-red-600 mt-2"},Zf={class:"flex flex-wrap gap-3 items-center"},Kf={class:"outcome-toggle-group flex flex-wrap gap-3"},Xf={class:"px-4 py-4 space-y-4"},ev={key:0},tv={class:"bg-white rounded-lg shadow-nsc-card overflow-hidden p-6"},sv={class:"flex justify-end gap-2 pt-3"},nv={key:3,class:"space-y-3"},lv={class:"flex items-center gap-2 pb-2 border-b border"},av={class:"font-semibold text-foreground text-sm"},ov={__name:"OpportunityManagementWidget",props:{opportunity:{type:Object,required:!0},scheduledAppointment:{type:Object,default:null},activities:{type:Array,default:()=>[]}},emits:["vehicle-selected","offer-created","appointment-scheduled","appointment-cancelled","appointment-no-show"],setup(l,{emit:L}){const r=l,p=L,u=Qn(),d=qt();Ut();const x=Vt(),{t:b}=Ns(),S=()=>{var n;const c=d.currentOpportunity;return c&&c.id===((n=r.opportunity)==null?void 0:n.id)?c:r.opportunity},i=w(()=>{var c;return r.scheduledAppointment||((c=r.opportunity)==null?void 0:c.scheduledAppointment)||null}),$=w(()=>{if(i.value&&i.value.start)return!1;const c=ye.displayStage.value,n=c===Js.QUALIFIED,U=c===Js.AWAITING_APPOINTMENT;return(n||U)&&!ye.isClosed.value});w(()=>!i.value||!i.value.start?!1:new Date(i.value.start)<new Date&&i.value.status!=="completed");const D=w(()=>{if(!i.value||!i.value.start)return!1;const c=new Date(i.value.start),n=new Date;return c.getFullYear()===n.getFullYear()&&c.getMonth()===n.getMonth()&&c.getDate()===n.getDate()}),m=w(()=>r.opportunity.customer?typeof r.opportunity.customer=="string"?r.opportunity.customer:r.opportunity.customer.name:"Customer"),h=w(()=>{const c=r.opportunity.customerId||(r.opportunity.customer&&typeof r.opportunity.customer=="object"?r.opportunity.customer.id:null);return c?u.resolve(`/customer/${c}`).href:"#"}),y=c=>{c.preventDefault();const n=r.opportunity.customerId||(r.opportunity.customer&&typeof r.opportunity.customer=="object"?r.opportunity.customer.id:null);n&&window.open(u.resolve(`/customer/${n}`).href,"_blank")},v=w(()=>{const c=r.opportunity,n=ye.displayStage.value;return c.stage==="Closed Won"||n==="Closed Won"}),A=w(()=>{const c=r.opportunity,n=ye.displayStage.value;return c.stage==="Closed Lost"||n==="Closed Lost"}),g=w(()=>{const c=r.opportunity,n=ye.displayStage.value;return c.stage==="Closed Lost"||n==="Closed Lost"||!v.value?!1:c.deliverySubstatus!=="Delivered"}),M=w(()=>!!r.opportunity.deliveryDate),B=w(()=>r.opportunity.deliverySubstatus==="Delivered"),R=w(()=>M.value?"Confirm Delivery":"Schedule Delivery"),J=w(()=>M.value?"Delivery scheduled. Confirm that the delivery has been completed":"Contract signed! Schedule vehicle delivery with the customer"),ce=al(),{isCallActive:_,callEnded:V,callDuration:F,callNotes:E,mockTranscription:Q,formattedCallDuration:oe,startCall:G,endCall:$e,copyNumber:qe}=ce,me=()=>{G()},se=()=>{$e()},ne=()=>{var c;qe(((c=r.opportunity.customer)==null?void 0:c.phone)||"")},ke=c=>{E.value=c},Ue=()=>{ce.callData.value={channel:"external",notes:"",transcription:null}},Me=T(null),ft=()=>{Ge.value=!1},z=()=>{var c;(c=Me.value)==null||c.resetForm()};async function X(c,n){var hs,bs,ss,xs,ws;const{eventType:U,selectedDate:Ne,selectedSlot:Y,selectedTeam:le,selectedSalesman:Te,durationValue:pt,communicationPreferences:it}=c,Qe=r.opportunity,Dt=Ne,[Cn,ts]=Y.split(":").map(Number),Lt=new Date(Dt);Lt.setHours(Cn,ts,0,0);const Pt=pt||30,fs=new Date(Lt.getTime()+Pt*6e4),vs=(Te==null?void 0:Te.name)||(le==null?void 0:le.name)||Qe.assignee||"Unassigned",gs=(Te==null?void 0:Te.id)||(le==null?void 0:le.id)||null,ys=Te?"user":"team";try{if(n==="reschedule"){const Ys={title:`Appointment - ${((hs=Qe.customer)==null?void 0:hs.name)||"Customer"}`,start:Lt.toISOString(),end:fs.toISOString(),type:U,assignee:vs,customerId:Qe.customerId,opportunityId:Qe.id,duration:Pt,status:"pending_confirmation"};let Hs={...Ys};if((bs=i.value)!=null&&bs.id){const{updateCalendarEvent:Dn}=await ns(async()=>{const{updateCalendarEvent:fl}=await import("./users-i2L6lO-2.js").then(vl=>vl.i);return{updateCalendarEvent:fl}},__vite__mapDeps([3,1,2]));await Dn(i.value.id,{...Ys,status:"pending_confirmation"}),Hs.id=i.value.id}else{const Dn=await An({...Ys,status:"pending_confirmation"});Hs={...Ys,id:Dn.id,status:"pending_confirmation"}}await d.updateOpportunity(Qe.id,{scheduledAppointment:Hs}),p("appointment-scheduled",Hs),Ge.value=!1;return}const $n={customerId:Qe.customerId||((ss=Qe.customer)==null?void 0:ss.id),customer:((xs=Qe.customer)==null?void 0:xs.name)||"Unknown",start:Lt.toISOString(),end:fs.toISOString(),type:U,title:`${U} - ${((ws=Qe.customer)==null?void 0:ws.name)||"Customer"}`,assigneeId:gs,assigneeType:ys,teamId:(le==null?void 0:le.id)||null,team:(le==null?void 0:le.name)||null,salesperson:(Te==null?void 0:Te.name)||null,salespersonId:(Te==null?void 0:Te.id)||null,duration:Pt,opportunityId:Qe.id},Fn=await An($n),Rn={id:Fn.id,start:Lt.toISOString(),end:fs.toISOString(),type:U,assignee:vs,assigneeId:gs,assigneeType:ys,duration:Pt,team:(le==null?void 0:le.name)||null,teamId:(le==null?void 0:le.id)||null,salesperson:(Te==null?void 0:Te.name)||null,salespersonId:(Te==null?void 0:Te.id)||null,communications:it,status:"confirmed"};await d.updateOpportunity(Qe.id,{scheduledAppointment:Rn}),p("appointment-scheduled",{...Rn,calendarEventId:Fn.id}),z()}catch($n){console.error("Failed to schedule/reschedule appointment:",$n)}}async function Xe(){if(i.value)try{const c={...i.value,status:"confirmed"};if(i.value.id){const{updateCalendarEvent:n}=await ns(async()=>{const{updateCalendarEvent:U}=await import("./users-i2L6lO-2.js").then(Ne=>Ne.i);return{updateCalendarEvent:U}},__vite__mapDeps([3,1,2]));await n(i.value.id,{status:"confirmed"})}await d.updateOpportunity(r.opportunity.id,{scheduledAppointment:c}),p("appointment-scheduled",c)}catch(c){console.error("Failed to confirm appointment:",c)}}const at=T(!1),Ge=T(!1),_e=T(!1),Ve=T(!1),j=T(""),W=T(null),pe=T(null),K=T(null),P=T(null),te=T(!1),ue=T(!1),he=T(null),ve=T(""),je=T(null),Re=T(null),Ye=T(!1),He=T(!1),xe=T({deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}),we=T({actualDeliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}),Ee=T(!1),de=T(!1),ie=T(!1),Se=T(!1),be=T(!1),ge=T(!1),Ae=T(!1),nt=T(!1),rt=T(!1),Fe=T({contractDate:"",contractTime:"",notes:""}),Ze=T({newDeadline:"",reason:""}),yt=T(null),Gt=T(null),ct=w(()=>[{key:"add-offer",label:"Add offer",handler:()=>wn()},{key:"extend-deadline",label:"Extend deadline",handler:()=>a()},{key:"close-as-lost",label:"Close as Lost",handler:()=>{nt.value=!0}},{key:"schedule-appointment",label:"Schedule appointment",handler:()=>Oe()}]);w(()=>(ye.secondaryActions.value||[]).map(c=>({key:c.key,label:c.label,disabled:!!c.disabled,onClick:()=>{de.value=!1,ie.value=!1,ps(c)}}))),w(()=>(ct.value||[]).map(c=>({key:c.key,label:c.label,disabled:!!c.disabled,onClick:()=>{Se.value=!1,c.handler&&c.handler()}})));function Zt(c){}const xt=w(()=>{var n;const c=((n=i.value)==null?void 0:n.noShowCount)||0;return c===0&&_e.value?(console.log("[OpportunityManagementWidget] nsTaskCount computed: returning 1 (first no-show)"),1):(console.log("[OpportunityManagementWidget] nsTaskCount computed: returning",c),c)});Ce([Ge,_e,Ve],([c,n,U])=>{console.log("[OpportunityManagementWidget] Section visibility changed:",{showRescheduleSection:c,showNsTaskSection:n,showOfferAssignmentSection:U,nsTaskCount:xt.value})});const ls=w(()=>{var U;return((U={1:W,2:pe,3:K}[xt.value].value)==null?void 0:U.canSubmit)||!1}),jt=w(()=>xt.value===3?"Close as Lost":"Assign and Save"),Ke=w(()=>{var c;return((c=P.value)==null?void 0:c.canSubmit)||!1}),_t=w(()=>!opportunity.offers||opportunity.offers.length===0?[]:opportunity.offers.filter(c=>c.status==="active").map(c=>({id:c.id,label:`${c.vehicleBrand} ${c.vehicleModel} (${c.vehicleYear})`,price:c.price,value:c.id}))),et=w(()=>he.value&&ve.value.trim().length>0),Pe=T(!1),We=T(!1),gt=T(!1),Ft=T(!1),ze=T(!1),ut=T(!1),ht=T(!1),$t=T(!1),ot=T(!1),vt=T([]);function Nt(c){return c?new Intl.NumberFormat("en-US").format(c):"0"}function wt(c){return c?new Date(c).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}):""}const as={"schedule-appointment":()=>{at.value=!0},"manage-appointment":()=>{i.value&&($t.value=!0)},"view-or-schedule-appointment":()=>{i.value?$t.value=!0:at.value=!0},reschedule:()=>{i.value&&(ot.value=!0)},"cancel-appointment":()=>{rs()},"mark-no-show":()=>{_n()},"select-vehicle":()=>{ut.value=!0},"create-offer":()=>{!r.opportunity.selectedVehicle&&!r.opportunity.vehicle?ut.value=!0:Pe.value=!0},"call-prospect":()=>{ht.value=!0},"follow-up-offer":()=>{ht.value=!0},"request-decision":()=>{ht.value=!0},"finalize-contract":()=>{gt.value=!0},"schedule-delivery":()=>{if(g.value&&(Ye.value=!0,He.value=!1,!xe.value.deliveryDate)){const c=new Date;xe.value.deliveryDate=c.toISOString().split("T")[0]}},"confirm-delivery":()=>{if(g.value&&(He.value=!0,Ye.value=!1,!we.value.actualDeliveryDate)){const c=new Date;we.value.actualDeliveryDate=c.toISOString().split("T")[0]}},"collect-feedback":()=>{ht.value=!0},reschedule:()=>{ot.value=!0},"cancel-appointment":()=>{rs()},"close-won":()=>{gt.value=!0},"add-offer":()=>{Pe.value=!0},"add-contract":()=>{gt.value=!0},"extend-deadline":()=>{ht.value=!0},"close-lost":()=>{We.value=!0},reopen:()=>{ds()},requalify:()=>{ze.value=!0}},De=Ec(Cs(r,"opportunity"),i,Cs(r,"activities"),as,wt),ye={isClosed:De.isClosed,primaryAction:w(()=>$.value||i.value&&i.value.start&&(ye.displayStage.value===Js.APPOINTMENT_SCHEDULED||ye.displayStage.value===Js.AWAITING_APPOINTMENT)||De.isClosed.value?null:De.primaryAction.value),secondaryActions:w(()=>{const c=De.secondaryActions.value||[];return!c.some(U=>U.key==="close-lost")&&!De.isClosed.value?[...c,{key:"close-lost",label:"Close as Lost",handler:()=>{We.value=!0}}]:c}),activeTaskWidget:w(()=>{if($.value)return null;const c=De.activeTaskWidget.value;return c&&c.type==="NS"?null:c}),taskWidgetTitle:De.taskWidgetTitle,displayStage:w(()=>{var n;const c=Et(r.opportunity,"opportunity");return c||console.warn("No display stage calculated for opportunity:",(n=r.opportunity)==null?void 0:n.id),c}),showDeadlineBanner:w(()=>{var c;return!De.isClosed.value&&!!((c=r.opportunity)!=null&&c.nextActionDue)})},qs=w(()=>{const c=r.opportunity;if(!c||De.isClosed.value)return!1;if(c.stage!=="In Negotiation"){const U=Et(c,"opportunity");if(!(U!=null&&U.startsWith("In Negotiation")))return!1}return!(Et(c,"opportunity")==="In Negotiation - Contract Pending"||c.negotiationSubstatus==="Offer Accepted")}),Xs=async c=>{var n;(n=r.opportunity)!=null&&n.id&&await d.fetchOpportunityById(r.opportunity.id)};function Wt(){}function os(c){console.log("Survey submitted from task widget:",c)}function en(c){ut.value=!1,p("vehicle-selected",c),setTimeout(()=>{Pe.value=!0},300)}function tn(c){Pe.value=!1,p("offer-created",c)}function is(c){at.value=!1,p("appointment-scheduled",{...c,opportunityId:r.opportunity.id,customer:r.opportunity.customer.name})}async function rs(){if(i.value&&confirm("Are you sure you want to cancel this appointment?"))try{if(i.value.id){const{deleteCalendarEvent:c}=await ns(async()=>{const{deleteCalendarEvent:n}=await import("./users-i2L6lO-2.js").then(U=>U.i);return{deleteCalendarEvent:n}},__vite__mapDeps([3,1,2]));await c(i.value.id)}await d.updateOpportunity(r.opportunity.id,{scheduledAppointment:null}),p("appointment-cancelled",i.value.id)}catch(c){console.error("Failed to cancel appointment:",c)}}function sn(c){gt.value=!1,d.updateOpportunity(r.opportunity.id,{stage:"Closed Won",contractDate:c.contractDate})}async function Us(c){var n;Ft.value=!1;try{const U=S();await d.updateOpportunity(U.id,{deliveryDate:c.deliveryDate,deliverySubstatus:"Delivered",actualDeliveryDate:c.deliveryDate,deliveryLocation:c.location,deliveryNotes:c.notes}),await d.addActivity(U.id,{type:"delivery",user:((n=x.currentUser)==null?void 0:n.name)||"You",action:"marked as delivered",content:`Delivery confirmed on ${new Date(c.deliveryDate).toLocaleString()} at ${c.location||"N/A"}`,data:c,timestamp:new Date().toISOString()})}catch(U){console.error("Failed to mark as delivered:",U)}}function Kt(){Ye.value=!1,xe.value={deliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}async function Xt(){var c;if(Bs.value)try{const n=S(),U=xe.value.deliveryTime?`${xe.value.deliveryDate}T${xe.value.deliveryTime}:00`:`${xe.value.deliveryDate}T12:00:00`;await d.updateOpportunity(n.id,{deliveryDate:U,deliverySubstatus:"Awaiting Delivery",deliveryLocation:xe.value.deliveryLocation,deliveryNotes:xe.value.notes}),await d.addActivity(n.id,{type:"delivery-scheduled",user:((c=x.currentUser)==null?void 0:c.name)||"You",action:"scheduled delivery",content:`Delivery scheduled for ${new Date(U).toLocaleString()} at ${xe.value.deliveryLocation}`,data:{deliveryDate:U,location:xe.value.deliveryLocation,notes:xe.value.notes},timestamp:new Date().toISOString()}),Kt()}catch(n){console.error("Failed to schedule delivery:",n)}}function Bt(){He.value=!1,we.value={actualDeliveryDate:"",deliveryTime:"",deliveryLocation:"",notes:""}}async function _s(){var c;if(ms.value)try{const n=S(),U=we.value.deliveryTime?`${we.value.actualDeliveryDate}T${we.value.deliveryTime}:00`:`${we.value.actualDeliveryDate}T12:00:00`;await d.updateOpportunity(n.id,{deliveryDate:U,deliverySubstatus:"Delivered",actualDeliveryDate:U,deliveryLocation:we.value.deliveryLocation,deliveryNotes:we.value.notes}),await d.addActivity(n.id,{type:"delivery",user:((c=x.currentUser)==null?void 0:c.name)||"You",action:"confirmed delivery",content:`Delivery confirmed on ${new Date(U).toLocaleString()} at ${we.value.deliveryLocation}`,data:{actualDeliveryDate:U,scheduledDeliveryDate:n.deliveryDate,location:we.value.deliveryLocation,notes:we.value.notes},timestamp:new Date().toISOString()}),Bt()}catch(n){console.error("Failed to confirm delivery:",n)}}function us(c){const n=typeof c=="string"?c:c.reason||c,U=typeof c=="object"?c.notes:"";We.value=!1,j.value="",d.updateOpportunity(r.opportunity.id,{stage:"Closed Lost",lossReason:n,lossNotes:U})}async function ds(){const c=S(),n=c.offers&&c.offers.length>0;if(Ee.value=!1,!n)await d.updateOpportunity(c.id,{stage:"Qualified",negotiationSubstatus:null});else{const U=c.offers.filter(le=>le.status==="active").sort((le,Te)=>new Date(Te.createdAt)-new Date(le.createdAt))[0],Ne=c.offers.some(le=>le.status==="accepted");let Y="Offer Sent";Ne?Y="Offer Accepted":U&&Math.ceil((new Date-new Date(U.createdAt))/864e5)>=3&&(Y="Offer Feedback"),await d.updateOpportunity(c.id,{stage:"In Negotiation",negotiationSubstatus:Y})}}function nn(c){ze.value=!1,u.push(`/customer/${c.id}?type=lead`)}function ln(c){$t.value=!1}function mt(c){ot.value=!1}function kt({opportunity:c,callbackDate:n}){d.updateOpportunity(c.id,{callbackDate:n})}function Fs({opportunity:c,assignee:n,note:U}){console.log("Opportunity assigned:",{opportunity:c,assignee:n,note:U})}function an(){var U;(U={1:W,2:pe,3:K}[xt.value].value)==null||U.submit()}function es(){_e.value=!1}async function on({opportunity:c,offerData:n}){var U,Ne,Y,le,Te;try{if((U=i.value)!=null&&U.id){const{updateCalendarEvent:pt}=await ns(async()=>{const{updateCalendarEvent:it}=await import("./users-i2L6lO-2.js").then(Qe=>Qe.i);return{updateCalendarEvent:it}},__vite__mapDeps([3,1,2]));await pt(i.value.id,{status:"completed"})}await d.addOffer(c.id,{vehicleBrand:((Ne=n.data)==null?void 0:Ne.brand)||"",vehicleModel:((Y=n.data)==null?void 0:Y.model)||"",vehicleYear:((le=n.data)==null?void 0:le.year)||"",price:((Te=n.data)==null?void 0:Te.price)||0,data:n.data}),Ve.value=!1}catch(pt){console.error("Failed to create offer:",pt)}}function rn(){var c;(c=P.value)==null||c.submit()}function Rs(){Ve.value=!1}async function un(c){var n;console.log("[OpportunityManagementWidget] handleOfferAccepted called",c);try{await d.markOfferAccepted(opportunity.id,c.id),await d.addActivity(opportunity.id,{type:"offer-acceptance",user:((n=x.currentUser)==null?void 0:n.name)||"You",action:"accepted offer",content:`Offer accepted: ${c.vehicleBrand} ${c.vehicleModel} (${c.vehicleYear}) - € ${c.price.toLocaleString()}`,data:{offerId:c.id},timestamp:new Date().toISOString()}),te.value=!1}catch(U){console.error("Failed to mark offer as accepted:",U)}}async function dn(){var c,n;if(et.value){console.log("[OpportunityManagementWidget] handleSendNegotiationMessage called",{channel:he.value,message:ve.value,offerId:je.value});try{const U=(c=opportunity.offers)==null?void 0:c.find(Y=>Y.id===je.value),Ne=U?`${U.vehicleBrand} ${U.vehicleModel} (€${U.price.toLocaleString()})`:"offer";await d.addActivity(opportunity.id,{type:he.value,user:((n=x.currentUser)==null?void 0:n.name)||"You",action:`sent ${he.value}`,content:ve.value,data:{channel:he.value,offerId:je.value,offerReference:Ne},timestamp:new Date().toISOString()}),te.value=!1,he.value=null,ve.value="",je.value=null}catch(U){console.error("Failed to send negotiation message:",U)}}}function cn(){te.value=!1,he.value=null,ve.value="",je.value=null}const cs=w(()=>{var c;return((c=Re.value)==null?void 0:c.isValid)||!1});async function mn(c){var n,U,Ne,Y,le,Te,pt,it,Qe;console.log("[OpportunityManagementWidget] handleInlineOfferCreated called",c);try{await d.addOffer(opportunity.id,{vehicleBrand:((n=c.data)==null?void 0:n.brand)||"",vehicleModel:((U=c.data)==null?void 0:U.model)||"",vehicleYear:((Ne=c.data)==null?void 0:Ne.year)||"",price:((Y=c.data)==null?void 0:Y.price)||0,data:c.data}),await d.addActivity(opportunity.id,{type:"offer",user:((le=x.currentUser)==null?void 0:le.name)||"You",action:"created an offer",content:`Offer created: ${(Te=c.data)==null?void 0:Te.brand} ${(pt=c.data)==null?void 0:pt.model} (${(it=c.data)==null?void 0:it.year}) - € ${(((Qe=c.data)==null?void 0:Qe.price)||0).toLocaleString()}`,data:c.data,timestamp:new Date().toISOString()}),ue.value=!1}catch(Dt){console.error("Failed to create offer:",Dt)}}function pn(){Re.value&&Re.value.submit()}function Es(){ue.value=!1,Re.value}const fn=w(()=>new Date().toISOString().split("T")[0]),vn=w(()=>{const c=new Date;return c.setDate(c.getDate()+1),c.toISOString().split("T")[0]}),js=w(()=>!!Fe.value.contractDate),Ws=w(()=>!!Ze.value.newDeadline),gn=w(()=>{var c;return((c=yt.value)==null?void 0:c.isValid)||!1}),yn=w(()=>new Date().toISOString().split("T")[0]),hn=w(()=>new Date().toISOString().split("T")[0]),Bs=w(()=>!!xe.value.deliveryDate&&!!xe.value.deliveryLocation),ms=w(()=>!!we.value.actualDeliveryDate&&!!we.value.deliveryLocation);function bn(c){if(be.value=c,c&&(ge.value=!1,Ae.value=!1,rt.value=!1,!Fe.value.contractDate)){const n=new Date;Fe.value.contractDate=n.toISOString().split("T")[0],Fe.value.contractTime=n.toTimeString().slice(0,5)}}function Ps(){be.value=!1,Fe.value={contractDate:"",contractTime:"",notes:""}}async function xn(){var c;if(js.value)try{const n=S(),U=Fe.value.contractTime?`${Fe.value.contractDate}T${Fe.value.contractTime}:00`:`${Fe.value.contractDate}T12:00:00`;await d.updateOpportunity(n.id,{contractDate:U,contractNotes:Fe.value.notes,stage:"Closed Won"}),await d.addActivity(n.id,{type:"contract",user:((c=x.currentUser)==null?void 0:c.name)||"You",action:"set contract signing date",content:`Contract date set: ${new Date(U).toLocaleString()}`,data:{contractDate:U,notes:Fe.value.notes},timestamp:new Date().toISOString()}),Ps()}catch(n){console.error("Failed to set contract date:",n)}}function wn(){be.value=!1,Ae.value=!1,rt.value=!1,ge.value=!ge.value}function zs(){ge.value=!1}function kn(){yt.value&&yt.value.submit()}async function O(c){var n,U,Ne,Y,le,Te,pt,it,Qe;try{const Dt=S();await d.addOffer(Dt.id,{vehicleBrand:((n=c.data)==null?void 0:n.brand)||"",vehicleModel:((U=c.data)==null?void 0:U.model)||"",vehicleYear:((Ne=c.data)==null?void 0:Ne.year)||"",price:((Y=c.data)==null?void 0:Y.price)||0,data:c.data}),await d.addActivity(Dt.id,{type:"offer",user:((le=x.currentUser)==null?void 0:le.name)||"You",action:"created an offer",content:`Offer created: ${(Te=c.data)==null?void 0:Te.brand} ${(pt=c.data)==null?void 0:pt.model} (${(it=c.data)==null?void 0:it.year}) - € ${(((Qe=c.data)==null?void 0:Qe.price)||0).toLocaleString()}`,data:c.data,timestamp:new Date().toISOString()}),ge.value=!1}catch(Dt){console.error("Failed to create offer:",Dt)}}function a(){if(be.value=!1,ge.value=!1,rt.value=!1,Ae.value=!Ae.value,Ae.value&&!Ze.value.newDeadline){const c=new Date;c.setDate(c.getDate()+1),Ze.value.newDeadline=c.toISOString().split("T")[0]}}function Z(){Ae.value=!1,Ze.value={newDeadline:"",reason:""}}async function N(){var c;if(Ws.value)try{const n=S();await d.updateOpportunity(n.id,{deadline:Ze.value.newDeadline,deadlineExtensionReason:Ze.value.reason}),await d.addActivity(n.id,{type:"deadline-extension",user:((c=x.currentUser)==null?void 0:c.name)||"You",action:"extended deadline",content:`Deadline extended to ${new Date(Ze.value.newDeadline).toLocaleDateString()}`,data:{newDeadline:Ze.value.newDeadline,reason:Ze.value.reason},timestamp:new Date().toISOString()}),Z()}catch(n){console.error("Failed to extend deadline:",n)}}function Oe(){be.value=!1,ge.value=!1,Ae.value=!1,rt.value=!rt.value}function Ie(){rt.value=!1}async function Rt(c){var ys,hs,bs;const{eventType:n,selectedDate:U,selectedSlot:Ne,selectedTeam:Y,selectedSalesman:le,durationValue:Te,communicationPreferences:pt}=c,it=S(),Qe=U,[Dt,Cn]=Ne.split(":").map(Number),ts=new Date(Qe);ts.setHours(Dt,Cn,0,0);const Lt=Te||30,Pt=new Date(ts.getTime()+Lt*6e4),fs=(le==null?void 0:le.name)||(Y==null?void 0:Y.name)||it.assignee||"Unassigned",vs=(le==null?void 0:le.id)||(Y==null?void 0:Y.id)||null,gs=le?"user":"team";try{const ss={customerId:it.customerId||((ys=it.customer)==null?void 0:ys.id),customer:((hs=it.customer)==null?void 0:hs.name)||"Unknown",start:ts.toISOString(),end:Pt.toISOString(),type:n,title:`${n} - ${((bs=it.customer)==null?void 0:bs.name)||"Customer"}`,assigneeId:vs,assigneeType:gs,teamId:(Y==null?void 0:Y.id)||null,team:(Y==null?void 0:Y.name)||null,salesperson:(le==null?void 0:le.name)||null,salespersonId:(le==null?void 0:le.id)||null,duration:Lt,opportunityId:it.id},xs=await An(ss),ws={id:xs.id,start:ts.toISOString(),end:Pt.toISOString(),type:n,assignee:fs,assigneeId:vs,assigneeType:gs,duration:Lt,team:(Y==null?void 0:Y.name)||null,teamId:(Y==null?void 0:Y.id)||null,salesperson:(le==null?void 0:le.name)||null,salespersonId:(le==null?void 0:le.id)||null,communications:pt,status:"confirmed"};await d.updateOpportunity(it.id,{scheduledAppointment:ws}),p("appointment-scheduled",{...ws,calendarEventId:xs.id}),Ie()}catch(ss){console.error("Failed to schedule appointment:",ss)}}function Sn(c){const n=typeof c=="string"?c:c.reason||c,U=typeof c=="object"?c.notes:"";nt.value=!1,d.updateOpportunity(r.opportunity.id,{stage:"Closed Lost",lossReason:n,lossNotes:U})}function _n(){var c,n;if(console.log("[OpportunityManagementWidget] handleMarkNoShow called",{hasAppointment:!!i.value,appointmentStatus:(c=i.value)==null?void 0:c.status,noShowCount:(n=i.value)==null?void 0:n.noShowCount}),!i.value){console.log("[OpportunityManagementWidget] No scheduled appointment, returning");return}Ge.value=!1,Ve.value=!1,_e.value=!0,console.log("[OpportunityManagementWidget] Set showNsTaskSection to true"),i.value.status!=="no-show"&&(console.log("[OpportunityManagementWidget] Calling updateAppointmentToNoShow"),cl())}function dl(){var c;if(console.log("[OpportunityManagementWidget] handleMarkShowedUp called",{hasAppointment:!!i.value,appointmentStatus:(c=i.value)==null?void 0:c.status}),!i.value){console.log("[OpportunityManagementWidget] No scheduled appointment, returning");return}Ge.value=!1,_e.value=!1,Ve.value=!0,console.log("[OpportunityManagementWidget] Set showOfferAssignmentSection to true")}async function cl(){var c;if(i.value)try{const U=(i.value.noShowCount||0)+1,Ne=U===1?"NS1":U===2?"NS2":"NS3";if(i.value.id){const{updateCalendarEvent:le}=await ns(async()=>{const{updateCalendarEvent:Te}=await import("./users-i2L6lO-2.js").then(pt=>pt.i);return{updateCalendarEvent:Te}},__vite__mapDeps([3,1,2]));await le(i.value.id,{status:"no-show"})}const Y={...i.value,status:"no-show",noShowCount:U};await d.updateOpportunity(r.opportunity.id,{scheduledAppointment:Y}),await d.addActivity(r.opportunity.id,{type:"ns-task",user:((c=x.currentUser)==null?void 0:c.name)||"You",action:`${Ne} - marked appointment as no-show`,content:`${Ne}: Appointment on ${new Date(i.value.start).toLocaleString()} marked as no-show. This is the ${U===1?"first":U===2?"second":"third"} no-show.`,data:{appointmentId:i.value.id,noShowCount:U,nsLabel:Ne},timestamp:new Date().toISOString()}),p("appointment-no-show",{appointmentId:i.value.id,noShowCount:U,nsLabel:Ne})}catch(n){console.error("Failed to mark appointment as no-show:",n)}}function ml({opportunity:c,reason:n}){We.value=!0}async function pl({opportunity:c,reason:n}){var U;_e.value=!1,await d.updateOpportunity(c.id,{stage:"Closed Lost",lossReason:n}),await d.addActivity(c.id,{type:"close-lost",user:((U=x.currentUser)==null?void 0:U.name)||"You",action:"closed opportunity as lost",content:`Opportunity closed as lost. Reason: ${n||"N/A"}`,data:{reason:n},timestamp:new Date().toISOString()})}function ps(c){if(c&&c.handler)c.handler();else if(c&&c.key){const n=as[c.key];n&&n()}}return Ls(async()=>{try{const n=(await la({})).data||[];vt.value=n.filter(U=>U.stockDays!==null&&U.stockDays!==void 0).slice(0,5)}catch(c){console.error("Failed to load recommended cars:",c),vt.value=[]}i.value&&i.value.status==="no-show"&&(_e.value=!0)}),(c,n)=>(f(),k(Le,null,[s(sl,{task:l.opportunity,"hide-title":"","hide-border":""},{"deadline-banner":o(()=>[ye.isClosed.value?q("",!0):(f(),re(il,{key:0,"next-action-due":l.opportunity.nextActionDue,"show-deadline-banner":ye.showDeadlineBanner.value,"task-id":l.opportunity.id},null,8,["next-action-due","show-deadline-banner","task-id"]))]),"primary-action":o(()=>{var U,Ne;return[ye.isClosed.value?q("",!0):(f(),re(ll,{key:0,task:l.opportunity,"task-type":"opportunity",onReassigned:Xs,class:"mb-3"},null,8,["task"])),!ye.isClosed.value&&i.value&&i.value.start?(f(),k("div",rp,[e("div",up,[e("div",dp,[e("div",cp,[e("div",mp,[n[45]||(n[45]=e("h4",{class:"font-bold text-foreground text-sm"},"Manage Appointment",-1)),e("p",pp,[C(" Appointment scheduled for "+I((U=i.value)!=null&&U.start?wt(i.value.start):"TBD")+" ",1),l.opportunity.customer||l.opportunity.customerId?(f(),k("span",fp,[n[44]||(n[44]=C(" with ",-1)),e("a",{href:h.value,target:"_blank",onClick:Mn(y,["stop"]),class:"text-primary hover:underline font-medium"},I(m.value),9,vp)])):q("",!0)])]),e("div",gp,[((Ne=i.value)==null?void 0:Ne.status)==="pending_confirmation"?(f(),re(t(ee),{key:0,variant:"outline",onClick:Xe,class:"inline-flex items-center gap-2 cursor-pointer"},{default:o(()=>[...n[46]||(n[46]=[e("i",{class:"fa-solid fa-calendar-check"},null,-1),e("span",null,"Confirm appointment",-1)])]),_:1})):q("",!0),e("div",yp,[D.value?q("",!0):(f(),re(t(Be),{key:0,variant:"outline","model-value":Ge.value,"onUpdate:modelValue":n[0]||(n[0]=Y=>{Ge.value=Y,Y&&(_e.value=!1,Ve.value=!1)}),class:"outcome-toggle-item"},{default:o(()=>[...n[47]||(n[47]=[e("i",{class:"fa-solid fa-calendar-days"},null,-1),e("span",null,"Reschedule",-1)])]),_:1},8,["model-value"])),D.value?(f(),re(t(Be),{key:1,variant:"outline","model-value":_e.value,"onUpdate:modelValue":n[1]||(n[1]=Y=>{Y?_n():_e.value=!1}),class:"outcome-toggle-item"},{default:o(()=>[...n[48]||(n[48]=[e("i",{class:"fa-solid fa-user-slash"},null,-1),e("span",null,"Mark No-Show",-1)])]),_:1},8,["model-value"])):q("",!0),D.value?(f(),re(t(Be),{key:2,variant:"outline","model-value":Ve.value,"onUpdate:modelValue":n[2]||(n[2]=Y=>{Y?dl():Ve.value=!1}),class:"outcome-toggle-item"},{default:o(()=>[...n[49]||(n[49]=[e("i",{class:"fa-solid fa-user-check"},null,-1),e("span",null,"Mark Showed Up",-1)])]),_:1},8,["model-value"])):q("",!0)]),ye.secondaryActions.value&&ye.secondaryActions.value.length>0?(f(),re(ks,{key:1,actions:ye.secondaryActions.value,onActionSelected:ps},null,8,["actions"])):q("",!0)])])])]),e("div",hp,[Ge.value?(f(),k("div",bp,[s(Tn,{ref_key:"scheduleFormRef",ref:Me,opportunity:l.opportunity,mode:"reschedule","initial-appointment":i.value,onSubmit:n[3]||(n[3]=Y=>X(Y,"reschedule")),onCancel:ft},null,8,["opportunity","initial-appointment"])])):q("",!0),_e.value?(f(),k("div",xp,[xt.value===1?(f(),re(jm,{key:0,ref_key:"ns1TaskRef",ref:W,opportunity:l.opportunity,"scheduled-appointment":i.value,onAssigned:Fs,onCancel:es},null,8,["opportunity","scheduled-appointment"])):xt.value===2?(f(),re(Xm,{key:1,ref_key:"ns2TaskRef",ref:pe,opportunity:l.opportunity,"scheduled-appointment":i.value,onAssigned:Fs,onCancel:es},null,8,["opportunity","scheduled-appointment"])):xt.value>=3?(f(),re(lp,{key:2,ref_key:"ns3TaskRef",ref:K,opportunity:l.opportunity,"scheduled-appointment":i.value,onCloseAsLost:pl,onCancel:es},null,8,["opportunity","scheduled-appointment"])):q("",!0)])):q("",!0),_e.value?(f(),k("div",wp,[s(t(ee),{variant:"secondary",onClick:es},{default:o(()=>[...n[50]||(n[50]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"primary",disabled:!ls.value,onClick:an,class:"bg-primary"},{default:o(()=>[C(I(jt.value),1)]),_:1},8,["disabled"])])):q("",!0),s(On,{name:"expand"},{default:o(()=>[Ve.value?(f(),k("div",kp,[s(ip,{ref_key:"offerAssignmentTaskRef",ref:P,opportunity:l.opportunity,"scheduled-appointment":i.value,onOfferCreated:on,onCancel:Rs},null,8,["opportunity","scheduled-appointment"])])):q("",!0)]),_:1}),Ve.value?(f(),k("div",Sp,[s(t(ee),{variant:"secondary",onClick:Rs},{default:o(()=>[...n[51]||(n[51]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"primary",disabled:!Ke.value,onClick:rn,class:"bg-primary"},{default:o(()=>[...n[52]||(n[52]=[C(" Create Offer ",-1)])]),_:1},8,["disabled"])])):q("",!0)]),!t(De).isClosed.value&&qs.value?(f(),k("div",Cp,[e("div",$p,[e("div",Dp,[e("div",Ap,[e("div",Tp,[n[53]||(n[53]=e("h4",{class:"font-bold text-foreground text-sm"},"Manage Offers & Follow Up",-1)),e("p",Op,[l.opportunity.offers&&l.opportunity.offers.length>0?(f(),k(Le,{key:0},[C(I(l.opportunity.negotiationSubstatus==="Offer Feedback"?"Request feedback on pending offers":"Follow up with customer about offers"),1)],64)):(f(),k(Le,{key:1},[C(I(l.opportunity.negotiationSubstatus==="Offer Feedback"?"Create an offer and request feedback":"Create an offer to continue negotiation"),1)],64))])]),l.opportunity.offers&&l.opportunity.offers.length>0?(f(),k("div",Ip,[s(ul,{offers:l.opportunity.offers,"opportunity-id":l.opportunity.id,onOfferAccepted:un},null,8,["offers","opportunity-id"])])):(f(),k("div",Vp,[...n[54]||(n[54]=[e("p",{class:"text-sm text-muted-foreground"},"No offers yet. Create your first offer to continue.",-1)])])),e("div",Np,[e("div",Lp,[s(t(Be),{variant:"outline","model-value":te.value,"onUpdate:modelValue":n[4]||(n[4]=Y=>{te.value=Y,Y?ue.value=!1:(he.value=null,ve.value="",je.value=null)}),class:"outcome-toggle-item"},{default:o(()=>[n[55]||(n[55]=e("i",{class:"fa-solid fa-phone-volume"},null,-1)),e("span",null,I(l.opportunity.negotiationSubstatus==="Offer Feedback"?"Request Feedback":"Follow Up"),1)]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":ue.value,"onUpdate:modelValue":n[5]||(n[5]=Y=>{ue.value=Y,Y&&(te.value=!1)}),class:"outcome-toggle-item"},{default:o(()=>[...n[56]||(n[56]=[e("i",{class:"fa-solid fa-plus"},null,-1),e("span",null,"Add Offer",-1)])]),_:1},8,["model-value"])]),ye.secondaryActions.value&&ye.secondaryActions.value.length>0?(f(),re(ks,{key:0,actions:ye.secondaryActions.value,onActionSelected:ps},null,8,["actions"])):q("",!0)])])])]),e("div",Mp,[te.value?(f(),k("div",qp,[e("div",Up,[n[63]||(n[63]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Contact Customer",-1)),e("div",_p,[s(t(Be),{variant:"outline","model-value":he.value==="call","onUpdate:modelValue":n[6]||(n[6]=Y=>Y&&(he.value="call")),class:"followup-toggle-item"},{default:o(()=>[...n[57]||(n[57]=[e("i",{class:"fa-solid fa-phone text-xs"},null,-1),e("span",null,"Call",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":he.value==="whatsapp","onUpdate:modelValue":n[7]||(n[7]=Y=>Y&&(he.value="whatsapp")),class:"followup-toggle-item"},{default:o(()=>[...n[58]||(n[58]=[e("i",{class:"fa-brands fa-whatsapp text-xs"},null,-1),e("span",null,"WhatsApp",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":he.value==="sms","onUpdate:modelValue":n[8]||(n[8]=Y=>Y&&(he.value="sms")),class:"followup-toggle-item"},{default:o(()=>[...n[59]||(n[59]=[e("i",{class:"fa-solid fa-message text-xs"},null,-1),e("span",null,"SMS",-1)])]),_:1},8,["model-value"]),s(t(Be),{variant:"outline","model-value":he.value==="email","onUpdate:modelValue":n[9]||(n[9]=Y=>Y&&(he.value="email")),class:"followup-toggle-item"},{default:o(()=>[...n[60]||(n[60]=[e("i",{class:"fa-solid fa-envelope text-xs"},null,-1),e("span",null,"Email",-1)])]),_:1},8,["model-value"])]),he.value?(f(),k("div",Fp,[_t.value.length>0?(f(),k("div",Rp,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[61]||(n[61]=[C("Select offer to reference (Optional)",-1)])]),_:1}),s(t(st),{modelValue:je.value,"onUpdate:modelValue":n[10]||(n[10]=Y=>je.value=Y),items:_t.value,placeholder:"Select an offer...","value-key":"id",class:"w-full"},{item:o(({item:Y})=>[e("div",Ep,[e("span",null,I(Y.label),1),e("span",jp,"€ "+I(Nt(Y.price)),1)])]),_:1},8,["modelValue","items"])])):q("",!0),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[62]||(n[62]=[C("Message",-1)])]),_:1}),s(t(dt),{modelValue:ve.value,"onUpdate:modelValue":n[11]||(n[11]=Y=>ve.value=Y),rows:"4",placeholder:"Type your message here...",class:"w-full"},null,8,["modelValue"])])])):q("",!0)])])):q("",!0)]),te.value?(f(),k("div",Wp,[s(t(ee),{variant:"secondary",onClick:cn},{default:o(()=>[...n[64]||(n[64]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!et.value,onClick:dn},{default:o(()=>[...n[65]||(n[65]=[C(" Send Message ",-1)])]),_:1},8,["disabled"])])):q("",!0),ue.value?(f(),k("div",Bp,[e("div",Pp,[s(Zs,{ref_key:"addOfferWidgetRef",ref:Re,"task-id":l.opportunity.id,"task-type":"opportunity",customer:l.opportunity.customer,"selected-vehicle":l.opportunity.selectedVehicle||l.opportunity.vehicle||l.opportunity.requestedCar,"hide-header":"","hide-actions":"",onSave:mn,onCancel:Es},null,8,["task-id","customer","selected-vehicle"])])])):q("",!0),ue.value?(f(),k("div",zp,[s(t(ee),{variant:"secondary",onClick:Es},{default:o(()=>[...n[66]||(n[66]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!cs.value,onClick:pn},{default:o(()=>[...n[67]||(n[67]=[C(" Create Offer ",-1)])]),_:1},8,["disabled"])])):q("",!0)])):q("",!0)])):q("",!0),!t(De).isClosed.value&&l.opportunity.stage==="In Negotiation"&&(l.opportunity.negotiationSubstatus==="Offer Accepted"||t(Et)(l.opportunity,"opportunity")==="In Negotiation - Contract Pending")?(f(),k("div",Yp,[e("div",Hp,[e("div",Qp,[e("div",Jp,[n[69]||(n[69]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Collect e-signatures, finalize contract"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Get the formal contract signed electronically by the customer. Finalize all contractual terms and conditions. Ensure all required signatures are collected. Set the official Contract Date when customer signs. ")],-1)),e("div",Gp,[e("div",Zp,[s(t(Be),{variant:"outline","model-value":be.value,"onUpdate:modelValue":bn,class:"outcome-toggle-item"},{default:o(()=>[...n[68]||(n[68]=[e("i",{class:"fa-solid fa-file-signature"},null,-1),e("span",null,"Collect Signatures",-1)])]),_:1},8,["model-value"])]),s(ks,{actions:ct.value,onActionSelected:Zt},null,8,["actions"])])])])]),e("div",Kp,[be.value?(f(),k("div",Xp,[e("div",ef,[n[73]||(n[73]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Set Contract Signing Date",-1)),e("div",tf,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[70]||(n[70]=[C("Contract Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:Fe.value.contractDate,"onUpdate:modelValue":n[12]||(n[12]=Y=>Fe.value.contractDate=Y),max:fn.value,class:"w-full"},null,8,["modelValue","max"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[71]||(n[71]=[C("Time (Optional)",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:Fe.value.contractTime,"onUpdate:modelValue":n[13]||(n[13]=Y=>Fe.value.contractTime=Y),class:"w-full"},null,8,["modelValue"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[72]||(n[72]=[C("Notes (Optional)",-1)])]),_:1}),s(t(dt),{modelValue:Fe.value.notes,"onUpdate:modelValue":n[14]||(n[14]=Y=>Fe.value.notes=Y),rows:"4",placeholder:"Add any relevant notes about the contract signing...",class:"w-full"},null,8,["modelValue"])])])]),e("div",sf,[s(t(ee),{variant:"secondary",onClick:Ps},{default:o(()=>[...n[74]||(n[74]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!js.value,onClick:xn},{default:o(()=>[...n[75]||(n[75]=[C(" Set Contract Date ",-1)])]),_:1},8,["disabled"])])])):q("",!0),ge.value?(f(),k("div",nf,[e("div",lf,[s(Zs,{ref_key:"addOfferContractPendingRef",ref:yt,"task-id":l.opportunity.id,"task-type":"opportunity",customer:l.opportunity.customer,"selected-vehicle":l.opportunity.selectedVehicle||l.opportunity.vehicle||l.opportunity.requestedCar,"hide-header":"","hide-actions":"",onSave:O,onCancel:zs},null,8,["task-id","customer","selected-vehicle"])])])):q("",!0),ge.value?(f(),k("div",af,[s(t(ee),{variant:"secondary",onClick:zs},{default:o(()=>[...n[76]||(n[76]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!gn.value,onClick:kn},{default:o(()=>[...n[77]||(n[77]=[C(" Create Offer ",-1)])]),_:1},8,["disabled"])])):q("",!0),Ae.value?(f(),k("div",of,[e("div",rf,[n[80]||(n[80]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Extend Deadline",-1)),e("div",uf,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[78]||(n[78]=[C("New Deadline Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:Ze.value.newDeadline,"onUpdate:modelValue":n[15]||(n[15]=Y=>Ze.value.newDeadline=Y),min:vn.value,class:"w-full"},null,8,["modelValue","min"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[79]||(n[79]=[C("Reason (Optional)",-1)])]),_:1}),s(t(dt),{modelValue:Ze.value.reason,"onUpdate:modelValue":n[16]||(n[16]=Y=>Ze.value.reason=Y),rows:"3",placeholder:"Reason for extending the deadline...",class:"w-full"},null,8,["modelValue"])])])]),e("div",df,[s(t(ee),{variant:"secondary",onClick:Z},{default:o(()=>[...n[81]||(n[81]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!Ws.value,onClick:N},{default:o(()=>[...n[82]||(n[82]=[C(" Extend Deadline ",-1)])]),_:1},8,["disabled"])])])):q("",!0),rt.value?(f(),k("div",cf,[s(Tn,{ref_key:"scheduleAppointmentContractPendingFormRef",ref:Gt,opportunity:l.opportunity,mode:"schedule",onSubmit:n[17]||(n[17]=Y=>Rt(Y)),onCancel:Ie},null,8,["opportunity"])])):q("",!0)])])):!ye.isClosed.value&&ye.primaryAction.value?(f(),re(nl,{key:3,action:ye.primaryAction.value,"color-scheme":ye.primaryAction.value.colorScheme,onActionClicked:ye.primaryAction.value.handler},null,8,["action","color-scheme","onActionClicked"])):q("",!0)]}),"task-widgets":o(()=>[$.value?(f(),k("div",mf,[l.opportunity.assignmentNote?(f(),k("div",pf,[e("div",ff,[n[84]||(n[84]=e("i",{class:"fa-solid fa-sticky-note text-blue-600 text-sm mt-0.5"},null,-1)),e("div",vf,[n[83]||(n[83]=e("h5",{class:"font-semibold text-foreground text-sm mb-1"},"Note from Assigner",-1)),e("p",gf,I(l.opportunity.assignmentNote),1)])])])):q("",!0),e("div",yf,[e("div",hf,[e("div",bf,[e("div",xf,[n[85]||(n[85]=e("div",{class:"mb-3"},[e("h4",{class:"font-bold text-foreground text-sm"},"Call to Schedule Appointment"),e("p",{class:"text-sm text-muted-foreground mt-0.5"}," Contact the customer to schedule an appointment ")],-1)),s(ol,{"is-call-active":t(_),"call-ended":t(V),"call-duration":t(F),"call-notes":t(E),"formatted-call-duration":t(oe),"mock-transcription":t(Q),"contact-attempts":0,"max-contact-attempts":3,onStartCall:me,onEndCall:se,onLogManualCall:Ue,onExtractInformation:n[18]||(n[18]=U=>ht.value=!0),"onUpdate:callNotes":ke,onCopyNumber:ne},null,8,["is-call-active","call-ended","call-duration","call-notes","formatted-call-duration","mock-transcription"])])])]),e("div",wf,[s(Tn,{ref_key:"scheduleFormRef",ref:Me,opportunity:l.opportunity,mode:"schedule",onSubmit:n[19]||(n[19]=U=>X(U,"schedule")),onCancel:z},null,8,["opportunity"])])])])):q("",!0),g.value?(f(),k("div",kf,[e("div",Sf,[e("div",Cf,[e("div",$f,[e("div",Df,[e("h4",Af,I(R.value),1),e("p",Tf,I(J.value),1)]),e("div",Of,[e("div",If,[M.value?q("",!0):(f(),re(t(Be),{key:0,variant:"outline","model-value":Ye.value,"onUpdate:modelValue":n[20]||(n[20]=U=>{if(Ye.value=U,U&&(He.value=!1,!xe.value.value.deliveryDate)){const Ne=new Date;xe.value.value.deliveryDate=Ne.toISOString().split("T")[0]}}),class:"outcome-toggle-item"},{default:o(()=>[...n[86]||(n[86]=[e("i",{class:"fa-solid fa-truck"},null,-1),e("span",null,"Schedule Delivery",-1)])]),_:1},8,["model-value"])),M.value&&!B.value?(f(),re(t(Be),{key:1,variant:"outline","model-value":He.value,"onUpdate:modelValue":n[21]||(n[21]=U=>{if(He.value=U,U&&(Ye.value=!1,!we.value.value.actualDeliveryDate)){const Ne=new Date;we.value.value.actualDeliveryDate=Ne.toISOString().split("T")[0]}}),class:"outcome-toggle-item"},{default:o(()=>[...n[87]||(n[87]=[e("i",{class:"fa-solid fa-calendar-check"},null,-1),e("span",null,"Confirm Delivery",-1)])]),_:1},8,["model-value"])):q("",!0)]),s(t(ee),{variant:"outline",onClick:ds,class:"inline-flex items-center gap-2 cursor-pointer"},{default:o(()=>[...n[88]||(n[88]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),e("span",null,"Reopen Opportunity",-1)])]),_:1}),ye.secondaryActions.value&&ye.secondaryActions.value.length>0?(f(),re(ks,{key:0,actions:ye.secondaryActions.value,onActionSelected:ps},null,8,["actions"])):q("",!0)])])])]),e("div",Vf,[Ye.value?(f(),k("div",Nf,[e("div",Lf,[n[96]||(n[96]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Schedule Delivery",-1)),e("div",Mf,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[89]||(n[89]=[C("Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:xe.value.deliveryDate,"onUpdate:modelValue":n[22]||(n[22]=U=>xe.value.deliveryDate=U),min:yn.value,class:"w-full"},null,8,["modelValue","min"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[90]||(n[90]=[C("Time (Optional)",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:xe.value.deliveryTime,"onUpdate:modelValue":n[23]||(n[23]=U=>xe.value.deliveryTime=U),class:"w-full"},null,8,["modelValue"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[91]||(n[91]=[C("Delivery Location",-1)])]),_:1}),s(t(It),{modelValue:xe.value.deliveryLocation,"onUpdate:modelValue":n[24]||(n[24]=U=>xe.value.deliveryLocation=U)},{default:o(()=>[s(t(At),{class:"w-full"},{default:o(()=>[s(t(Tt),{placeholder:"Select location..."})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Dealership"},{default:o(()=>[...n[92]||(n[92]=[C("At Dealership",-1)])]),_:1}),s(t(fe),{value:"Customer Address"},{default:o(()=>[...n[93]||(n[93]=[C("Customer Address",-1)])]),_:1}),s(t(fe),{value:"Other"},{default:o(()=>[...n[94]||(n[94]=[C("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[95]||(n[95]=[C("Notes (Optional)",-1)])]),_:1}),s(t(dt),{modelValue:xe.value.notes,"onUpdate:modelValue":n[25]||(n[25]=U=>xe.value.notes=U),rows:"4",placeholder:"Add any relevant delivery details...",class:"w-full"},null,8,["modelValue"])])])]),e("div",qf,[s(t(ee),{variant:"secondary",onClick:Kt},{default:o(()=>[...n[97]||(n[97]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!Bs.value,onClick:Xt},{default:o(()=>[...n[98]||(n[98]=[C(" Schedule Delivery ",-1)])]),_:1},8,["disabled"])])])):q("",!0),He.value?(f(),k("div",Uf,[e("div",_f,[n[107]||(n[107]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Confirm Delivery",-1)),e("p",Ff," Delivery was scheduled for "+I(wt(l.opportunity.deliveryDate))+". Confirm that the delivery has been completed. ",1),e("div",Rf,[e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[99]||(n[99]=[C("Scheduled Delivery Date",-1)])]),_:1}),s(t(tt),{type:"text",value:wt(l.opportunity.deliveryDate),disabled:"",class:"w-full"},null,8,["value"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[100]||(n[100]=[C("Actual Delivery Date ",-1),e("span",{class:"text-red-600"},"*",-1)])]),_:1}),s(t(tt),{type:"date",modelValue:we.value.actualDeliveryDate,"onUpdate:modelValue":n[26]||(n[26]=U=>we.value.actualDeliveryDate=U),max:hn.value,class:"w-full"},null,8,["modelValue","max"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[101]||(n[101]=[C("Time (Optional)",-1)])]),_:1}),s(t(tt),{type:"time",modelValue:we.value.deliveryTime,"onUpdate:modelValue":n[27]||(n[27]=U=>we.value.deliveryTime=U),class:"w-full"},null,8,["modelValue"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[102]||(n[102]=[C("Delivery Location",-1)])]),_:1}),s(t(It),{modelValue:we.value.deliveryLocation,"onUpdate:modelValue":n[28]||(n[28]=U=>we.value.deliveryLocation=U)},{default:o(()=>[s(t(At),{class:"w-full"},{default:o(()=>[s(t(Tt),{placeholder:"Select location..."})]),_:1}),s(t(Ot),null,{default:o(()=>[s(t(fe),{value:"Dealership"},{default:o(()=>[...n[103]||(n[103]=[C("At Dealership",-1)])]),_:1}),s(t(fe),{value:"Customer Address"},{default:o(()=>[...n[104]||(n[104]=[C("Customer Address",-1)])]),_:1}),s(t(fe),{value:"Other"},{default:o(()=>[...n[105]||(n[105]=[C("Other Location",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e("div",null,[s(t(H),{class:"block text-sm font-medium text-muted-foreground mb-2"},{default:o(()=>[...n[106]||(n[106]=[C("Delivery Notes (Optional)",-1)])]),_:1}),s(t(dt),{modelValue:we.value.notes,"onUpdate:modelValue":n[29]||(n[29]=U=>we.value.notes=U),rows:"4",placeholder:"Add any relevant delivery details, customer feedback, etc...",class:"w-full"},null,8,["modelValue"])])])]),e("div",Ef,[s(t(ee),{variant:"secondary",onClick:Bt},{default:o(()=>[...n[108]||(n[108]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",disabled:!ms.value,onClick:_s},{default:o(()=>[...n[109]||(n[109]=[C(" Mark as Delivered ",-1)])]),_:1},8,["disabled"])])])):q("",!0)])])):q("",!0),A.value?(f(),k("div",jf,[e("div",Wf,[e("div",Bf,[e("div",Pf,[e("div",zf,[n[112]||(n[112]=e("h4",{class:"font-bold text-foreground text-sm"},"Opportunity Closed as Lost",-1)),n[113]||(n[113]=e("p",{class:"text-sm text-muted-foreground mt-0.5"}," This opportunity was closed as lost. You can reopen it to continue the sales process or requalify it as a lead. ",-1)),l.opportunity.lossReason?(f(),k("div",Yf,[e("div",Hf,[n[111]||(n[111]=e("i",{class:"fa-solid fa-info-circle text-red-600 text-sm mt-0.5"},null,-1)),e("div",Qf,[n[110]||(n[110]=e("p",{class:"text-sm font-medium text-red-900"},"Loss Reason",-1)),e("p",Jf,I(l.opportunity.lossReason),1),l.opportunity.lossNotes?(f(),k("p",Gf,I(l.opportunity.lossNotes),1)):q("",!0)])])])):q("",!0)]),e("div",Zf,[e("div",Kf,[s(t(Be),{variant:"outline","model-value":Ee.value,"onUpdate:modelValue":n[30]||(n[30]=U=>Ee.value=U),class:"outcome-toggle-item"},{default:o(()=>[...n[114]||(n[114]=[e("i",{class:"fa-solid fa-rotate-left"},null,-1),e("span",null,"Reopen Opportunity",-1)])]),_:1},8,["model-value"])]),ye.secondaryActions.value&&ye.secondaryActions.value.length>0?(f(),re(ks,{key:0,actions:ye.secondaryActions.value,onActionSelected:ps},null,8,["actions"])):q("",!0)])])])]),e("div",Xf,[Ee.value?(f(),k("div",ev,[e("div",tv,[n[117]||(n[117]=e("h5",{class:"font-semibold text-foreground text-sm mb-4"},"Reopen Opportunity",-1)),n[118]||(n[118]=e("p",{class:"text-sm text-muted-foreground mb-4"},' Reopening this opportunity will restore it to an active state. The opportunity will return to the appropriate stage based on its current state (e.g., if it has offers, it will return to "In Negotiation"). ',-1)),e("div",sv,[s(t(ee),{variant:"secondary",onClick:n[31]||(n[31]=U=>Ee.value=!1)},{default:o(()=>[...n[115]||(n[115]=[C(" Cancel ",-1)])]),_:1}),s(t(ee),{variant:"default",onClick:ds},{default:o(()=>[...n[116]||(n[116]=[C(" Reopen Opportunity ",-1)])]),_:1})])])])):q("",!0)])])):ye.activeTaskWidget.value&&ye.activeTaskWidget.value.component?(f(),k("div",nv,[e("div",lv,[n[119]||(n[119]=e("i",{class:"fa-solid fa-clipboard-check text-blue-600 text-sm"},null,-1)),e("h5",av,I(ye.taskWidgetTitle.value),1)]),(f(),re(Nn(ye.activeTaskWidget.value.component),Vn(ye.activeTaskWidget.value.props,{onClose:Wt,onSetCallback:kt,onAutoCloseLost:ml,onSurveySubmitted:os,onSurveyCancelled:Wt}),null,16))])):q("",!0)]),"secondary-actions":o(()=>[...n[120]||(n[120]=[])]),_:1},8,["task"]),at.value?(f(),re(Xn,{key:0,show:at.value,customer:l.opportunity.customer,assignee:l.opportunity.assignee,"disabled-fields":["customer"],onCreate:is,onCancel:n[32]||(n[32]=U=>at.value=!1)},null,8,["show","customer","assignee"])):q("",!0),ut.value?(f(),re(sa,{key:1,opportunity:l.opportunity,"requested-car":l.opportunity.requestedCar,"recommended-cars":vt.value,onVehicleSelected:en,onClose:n[33]||(n[33]=U=>ut.value=!1)},null,8,["opportunity","requested-car","recommended-cars"])):q("",!0),Pe.value?(f(),re(Zs,{key:2,opportunity:l.opportunity,vehicle:l.opportunity.selectedVehicle||l.opportunity.vehicle||l.opportunity.requestedCar,onOfferCreated:tn,onClose:n[34]||(n[34]=U=>Pe.value=!1)},null,8,["opportunity","vehicle"])):q("",!0),gt.value?(f(),re(Qc,{key:3,opportunity:l.opportunity,onContractSet:sn,onClose:n[35]||(n[35]=U=>gt.value=!1)},null,8,["opportunity"])):q("",!0),Ft.value?(f(),re(em,{key:4,opportunity:l.opportunity,onDelivered:Us,onClose:n[36]||(n[36]=U=>Ft.value=!1)},null,8,["opportunity"])):q("",!0),We.value?(f(),re(zn,{key:5,opportunity:l.opportunity,"preselected-reason":j.value,onConfirm:us,onCancel:n[37]||(n[37]=U=>{We.value=!1,j.value=""})},null,8,["opportunity","preselected-reason"])):q("",!0),nt.value?(f(),re(zn,{key:6,opportunity:l.opportunity,onConfirm:Sn,onCancel:n[38]||(n[38]=U=>nt.value=!1)},null,8,["opportunity"])):q("",!0),ze.value?(f(),re(lm,{key:7,opportunity:l.opportunity,onRequalified:nn,onClose:n[39]||(n[39]=U=>ze.value=!1)},null,8,["opportunity"])):q("",!0),ht.value?(f(),re(qn,{key:8,onClose:n[40]||(n[40]=U=>ht.value=!1)})):q("",!0),$t.value&&i.value?(f(),re(aa,{key:9,show:$t.value,event:i.value,onClose:n[41]||(n[41]=U=>$t.value=!1),onEdit:n[42]||(n[42]=U=>{$t.value=!1,ot.value=!0}),onDelete:ln},null,8,["show","event"])):q("",!0),ot.value&&i.value?(f(),re(oa,{key:10,show:ot.value,event:i.value,customer:l.opportunity.customer,"disabled-fields":["customer"],onSave:mt,onCancel:n[43]||(n[43]=U=>ot.value=!1)},null,8,["show","event","customer"])):q("",!0)],64))}},iv=Qt(ov,[["__scopeId","data-v-e23d9438"]]);function wv(l){const L=Jt(),r=qt(),p=w(()=>l.value?l.value.type==="lead"?Bu:iv:null),u=w(()=>l.value?l.value.type==="lead"?{currentActivities:w(()=>L.currentLeadActivities),addActivity:(x,b)=>L.addActivity(x,b),updateActivity:(x,b,S)=>L.updateActivity(x,b,S),deleteActivity:(x,b)=>L.deleteActivity(x,b),updateLead:(x,b)=>L.updateLead(x,b),loadLeadById:x=>L.fetchLeadById(x)}:{currentActivities:w(()=>r.currentOpportunityActivities),addActivity:(x,b)=>r.addActivity(x,b),updateActivity:(x,b,S)=>r.updateActivity(x,b,S),deleteActivity:(x,b)=>r.deleteActivity(x,b),addVehicle:(x,b)=>r.addVehicle(x,b),createOffer:(x,b)=>r.createOffer(x,b),updateOpportunity:(x,b)=>r.updateOpportunity(x,b),loadOpportunityById:x=>r.fetchOpportunityById(x)}:null),d=w(()=>l.value?{overviewActions:["financing","tradein","purchase"],tabActions:["note","call","email","sms","whatsapp","attachment"]}:{overviewActions:[],tabActions:[]});return{managementWidget:p,storeAdapter:u,addNewConfig:d}}function kv(l){const L=Jt(),r=qt(),p=Vt(),u=w(()=>{const h=(l.value?L.leads:L.leads.filter(A=>!A.isDisqualified)).map(A=>{const g=Et(A,"lead"),M={...A,type:"lead",compositeId:`lead-${A.id}`,displayStage:g};return!M.customer&&A.customer&&(M.customer=A.customer),M}),y=r.opportunities.map(A=>{const g=Et(A,"opportunity"),M={...A,type:"opportunity",compositeId:`opportunity-${A.id}`,displayStage:g};return!M.customer&&A.customer&&(M.customer=A.customer),M});let v=[];return p.isOperator()?v=h:p.isSalesman()?v=y:v=[...h,...y],v}),d=(m,h)=>!h||h.length===0?m:Array.isArray(h)?m.filter(y=>h.includes(y.type)):h==="all"?m:m.filter(y=>y.type===h),x=m=>{const h=new Date,y=new Date(h.getTime()+24*60*60*1e3);return m.filter(v=>{if(!v.nextActionDue)return!1;const A=new Date(v.nextActionDue);return A>=h&&A<=y})},b=m=>m.filter(h=>h.nextActionDue!=null),S=m=>{const h=new Date(Date.now()-36e5);return m.filter(y=>y.type!=="lead"||!y.createdAt?!1:new Date(y.createdAt)>=h)},i=m=>{var y;const h=(y=p.currentUser)==null?void 0:y.name;return h?m.filter(v=>v.assignee===h):[]},$=(m,h)=>{if(!h||h.length===0)return m;let y=[...m];const v=h.filter(A=>A==="lead"||A==="opportunity");return v.length>0&&(y=d(y,v)),h.forEach(A=>{switch(A){case"due-in-24h":y=x(y);break;case"to-be-called":y=b(y);break;case"leads-1h":y=S(y);break;case"assigned-to-me":y=i(y);break}}),y},D=w(()=>{const m=u.value.some(y=>y.type==="lead"),h=u.value.some(y=>y.type==="opportunity");return m&&h});return{allTasks:u,filterByType:d,filterByDueIn24Hours:x,filterByToBeCalled:b,filterByLeadsCreated1Hour:S,filterByAssignedToMe:i,applyFilters:$,shouldShowTypeFilter:D}}export{xv as D,bv as T,wv as a,kv as u};
