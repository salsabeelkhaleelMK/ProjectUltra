const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DmX4Eg8G.js","assets/index-Dr28XGEp.css"])))=>i.map(i=>d[i]);
import{am as j,an as D,ao as Y,ap as v,aq as Z,ar as tt,a3 as Q,ad as z,r as g,c as I,l as et,as as at,at as nt,au as rt,M as st,a6 as S,av as ot,aw as ct,ai as ut,ag as it,ax as lt,ay as dt,az as ft}from"./index-DmX4Eg8G.js";const m=(e=300)=>new Promise(t=>setTimeout(t,e)),x=()=>v.filter(e=>!e.company||e.company===""),N=async(e={})=>{await m();let t=x();if(e.search){const a=e.search.toLowerCase();t=t.filter(n=>n.name.toLowerCase().includes(a)||n.email.toLowerCase().includes(a))}return{data:t,total:t.length}},P=async e=>{await m();const a=x().find(n=>n.id===parseInt(e));if(!a)throw new Error("Contact not found");return a},H=async e=>{await m();const t={id:v.length+1,...e,company:null,createdAt:new Date().toISOString(),lastContact:new Date().toISOString()};return v.push(t),t},U=async(e,t)=>{if(await m(),x().findIndex(p=>p.id===parseInt(e))===-1)throw new Error("Contact not found");const s=v.findIndex(p=>p.id===parseInt(e));return s!==-1&&(v[s]={...v[s],...t,company:null}),v[s]},G=async e=>{await m();const t=v.findIndex(a=>a.id===parseInt(e));if(t===-1)throw new Error("Contact not found");return v.splice(t,1),{success:!0}},J=async(e,t)=>{if(await m(),!x().find(p=>p.id===parseInt(e)))throw new Error("Contact not found");const s=v.findIndex(p=>p.id===parseInt(e));if(s===-1)throw new Error("Contact not found");return v[s].requestedCar={...t,id:Date.now()},{...v[s]}},K=async e=>{await m();const a=x().find(p=>p.id===parseInt(e));if(!a)throw new Error("Contact not found");if(!a.requestedCar)throw new Error("Contact must have requested car");const{createLead:n}=await Q(async()=>{const{createLead:p}=await import("./index-DmX4Eg8G.js").then(o=>o.bt);return{createLead:p}},__vite__mapDeps([0,1]));return await n({customerId:a.id,requestedCar:a.requestedCar,source:a.source||"Direct",tags:a.tags||[],stage:"Open Lead",status:"Open",priority:"Normal"})},X=async e=>{await m();const a=x().find(p=>p.id===parseInt(e));if(!a)throw new Error("Contact not found");if(!a.requestedCar)throw new Error("Contact must have requested car");const{createOpportunity:n}=await Q(async()=>{const{createOpportunity:p}=await import("./index-DmX4Eg8G.js").then(o=>o.bu);return{createOpportunity:p}},__vite__mapDeps([0,1]));return await n({customerId:a.id,vehicle:a.requestedCar,source:a.source||"Direct",tags:a.tags||[],stage:"Qualified",value:a.requestedCar.price||0})},pt=async e=>{await m();const t=j.filter(a=>a.customerId===parseInt(e));return{data:t,total:t.length}},vt=async e=>{await m();const t=D.filter(a=>a.customerId===parseInt(e));return{data:t,total:t.length}},yt=async e=>{await m();const t=[],a=v.find(o=>o.id===parseInt(e));a!=null&&a.id,j.filter(o=>o.customerId===parseInt(e)).forEach(o=>{o.requestedCar&&t.push({...o.requestedCar,id:`requested-${o.id}`,type:"requested",leadId:o.id,leadStage:o.stage})}),a!=null&&a.requestedCar&&t.push({...a.requestedCar,id:`requested-contact-${a.id}`,type:"requested",contactId:a.id});const s=D.filter(o=>o.customerId===parseInt(e));return s.forEach(o=>{Z.filter(C=>C.opportunityId===o.id&&C.type==="offer").forEach(C=>{var A;(A=C.data)!=null&&A.vehicle&&t.push({...C.data.vehicle,id:`offered-${C.id}`,type:"offered",opportunityId:o.id,opportunityStage:o.stage,offerDate:C.timestamp})})}),tt.filter(o=>o.customerId===parseInt(e)&&o.type==="test-drive").forEach(o=>{o.vehicle&&t.push({brand:o.vehicle.split(" ")[0]||"",model:o.vehicle.split(" ").slice(1).join(" ")||"",id:`drove-${o.id}`,type:"drove",eventId:o.id,testDriveDate:o.start,vehicle:o.vehicle})}),s.forEach(o=>{o.stage==="Closed Won"&&o.vehicle&&t.push({...o.vehicle,id:`purchased-${o.id}`,type:"purchased",opportunityId:o.id,purchaseDate:o.contractDate||o.lastActivity})}),a!=null&&a.vehicles&&Array.isArray(a.vehicles)&&a.vehicles.forEach(o=>{o.type==="owned"&&t.push({...o,id:o.id||`owned-${a.id}-${Date.now()}`,type:"owned",customerId:a.id})}),{data:t,total:t.length}},wt=async(e,t)=>{await m();const a=v.findIndex(p=>p.id===parseInt(e));if(a===-1)throw new Error("Customer not found");const n=v[a];n.vehicles||(n.vehicles=[]);const s={...t,id:t.id||Date.now()};return t.type==="requested"&&(n.requestedCar={brand:t.brand,model:t.model,year:t.year,price:t.price,requestType:t.requestType,requestMessage:t.requestMessage,image:t.image,dealership:t.dealership,fuelType:t.fuelType,gearType:t.gearType,kilometers:t.kilometers,id:s.id}),n.vehicles.push(s),v[a]=n,{...n}},ht=async e=>{await m();const t=Y.filter(a=>a.customerId===parseInt(e));return{data:t,total:t.length}},At=Object.freeze(Object.defineProperty({__proto__:null,addRequestedCarToContact:J,addVehicleToCustomer:wt,convertContactToLead:K,convertContactToOpportunity:X,createContact:H,deleteContact:G,fetchContactById:P,fetchContacts:N,fetchCustomerCars:yt,fetchLeadsByCustomerId:pt,fetchOpportunitiesByCustomerId:vt,fetchTasksByCustomerId:ht,updateContact:U},Symbol.toStringTag,{value:"Module"})),L=(e=300)=>new Promise(t=>setTimeout(t,e)),V=()=>v.filter(e=>e.company&&e.company!==""),mt=async(e={})=>{await L();let t=V();if(e.search){const a=e.search.toLowerCase();t=t.filter(n=>{var s;return n.name.toLowerCase().includes(a)||n.email.toLowerCase().includes(a)||((s=n.company)==null?void 0:s.toLowerCase().includes(a))})}return{data:t,total:t.length}},M=async e=>{await L();const a=V().find(n=>n.id===parseInt(e));if(!a)throw new Error("Account not found");return a},Ct=async e=>{await L();const t={id:v.length+1,...e,createdAt:new Date().toISOString(),lastContact:new Date().toISOString()};return v.push(t),t},gt=async(e,t)=>{if(await L(),V().findIndex(p=>p.id===parseInt(e))===-1)throw new Error("Account not found");const s=v.findIndex(p=>p.id===parseInt(e));return s!==-1&&(v[s]={...v[s],...t}),v[s]},Ot=async e=>{await L();const t=v.findIndex(a=>a.id===parseInt(e));if(t===-1)throw new Error("Account not found");return v.splice(t,1),{success:!0}},Et=z("customers",()=>{const e=g([]),t=g(null),a=g(!1),n=g(null),s=g(""),p=I(()=>e.value.filter(r=>r.type==="contact")),o=I(()=>e.value.filter(r=>r.type==="account")),T=I(()=>e.value.length),C=I(()=>p.value.length),A=I(()=>o.value.length),_=async(r={})=>{a.value=!0,n.value=null;try{const[i,f]=await Promise.all([N(r),mt(r)]),l=[...i.data.map(h=>({...h,type:"contact"})),...f.data.map(h=>({...h,type:"account"}))];return e.value=l,{data:l,total:l.length}}catch(i){throw n.value=i.message,i}finally{a.value=!1}},B=async(r,i=null)=>{a.value=!0,n.value=null;try{if(i==="contact")t.value={...await P(r),type:"contact"};else if(i==="account")t.value={...await M(r),type:"account"};else try{const f=await P(r);t.value={...f,type:"contact"}}catch{const f=await M(r);t.value={...f,type:"account"}}return t.value}catch(f){throw n.value=f.message,f}finally{a.value=!1}},q=async r=>{a.value=!0,n.value=null;try{const i=r.company&&r.company!=="",l={...await(i?Ct(r):H(r)),type:i?"account":"contact"};return e.value.unshift(l),l}catch(i){throw n.value=i.message,i}finally{a.value=!1}},b=async(r,i,f)=>{var l;a.value=!0,n.value=null;try{const h=await(f==="account"?gt(r,i):U(r,i)),k=e.value.findIndex(O=>O.id===r);return k!==-1&&(e.value[k]={...h,type:f}),((l=t.value)==null?void 0:l.id)===r&&(t.value={...h,type:f}),{...h,type:f}}catch(h){throw n.value=h.message,h}finally{a.value=!1}},$=async(r,i)=>{var f;a.value=!0,n.value=null;try{await(i==="account"?Ot(r):G(r)),e.value=e.value.filter(l=>l.id!==r),((f=t.value)==null?void 0:f.id)===r&&(t.value=null)}catch(l){throw n.value=l.message,l}finally{a.value=!1}};function R(r){s.value=r,_({search:r})}return{customers:e,contacts:p,accounts:o,currentCustomer:t,loading:a,error:n,searchQuery:s,totalCustomers:T,totalContacts:C,totalAccounts:A,fetchCustomers:_,fetchCustomerById:B,addCustomer:q,updateCustomer:b,removeCustomer:$,setSearchQuery:R,addContact:async r=>await q({...r,company:null}),modifyContact:async(r,i)=>await b(r,i,"contact"),removeContact:async r=>await $(r,"contact"),addRequestedCar:async(r,i)=>{const f=e.value.find(l=>l.id===r);if(!f)throw new Error("Customer not found");if(f.type==="contact")return await J(r,i);throw new Error("Requested cars not supported for accounts")},convertToLead:async r=>{var f;const i=e.value.find(l=>l.id===r);if(!i)throw new Error("Customer not found");if(i.type==="contact"){const l=await K(r);return e.value=e.value.filter(h=>h.id!==r),((f=t.value)==null?void 0:f.id)===r&&(t.value=null),l}throw new Error("Only contacts can be converted to leads")},convertToOpportunity:async r=>{var f;const i=e.value.find(l=>l.id===r);if(!i)throw new Error("Customer not found");if(i.type==="contact"){const l=await X(r);return e.value=e.value.filter(h=>h.id!==r),((f=t.value)==null?void 0:f.id)===r&&(t.value=null),l}throw new Error("Only contacts can be converted to opportunities")}}}),xt=z("opportunities",()=>{const e=g([]),t=g(null),a=g([]),n=g(!1),s=g(null),p=I(()=>e.value.filter(c=>c.priority==="Hot"&&c.stage!=="Closed Lost"));et(t,async(c,u)=>{if(c){if(!u||u.id!==c.id)try{a.value=await S(c.id)}catch(y){console.error("Failed to load opportunity activities:",y),a.value=[]}}else a.value=[]},{immediate:!0});const o=async(c={})=>{n.value=!0,s.value=null;try{const u=await at(c);return e.value=u.data||u,u}catch(u){throw s.value=u.message,u}finally{n.value=!1}},T=async c=>{n.value=!0,s.value=null;try{const u=await nt(c);t.value=u;const y=e.value.findIndex(d=>d.id===parseInt(c));return y!==-1&&(e.value[y]=u),t.value}catch(u){throw s.value=u.message,u}finally{n.value=!1}},C=async c=>{n.value=!0,s.value=null;try{const u=await rt(c);return e.value.push(u),u}catch(u){throw s.value=u.message,u}finally{n.value=!1}},A=async(c,u)=>{var y,d;n.value=!0,s.value=null;try{const E=st().getSetting("autoCloseWidgetsOnClose"),r=((y=t.value)==null?void 0:y.id)===c?t.value:e.value.find(l=>l.id===c);if(E&&u.stage&&(u.stage==="Closed Won"||u.stage==="Closed Lost")){const l=r==null?void 0:r.stage;if(l&&l!=="Closed Won"&&l!=="Closed Lost"){const k=(await S(c)).filter(O=>{var W,F;return O.type==="nfu-task"||O.type==="ofb-task"||((W=O.action)==null?void 0:W.includes("NFU"))||((F=O.action)==null?void 0:F.includes("OFB"))});for(const O of k)O.completed||await q(c,O.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${u.stage}`})}}const i=await ot(c,u),f=e.value.findIndex(l=>l.id===c);return f!==-1&&(e.value[f]=i),((d=t.value)==null?void 0:d.id)===c&&(t.value=i),i}catch(w){throw s.value=w.message,w}finally{n.value=!1}},_=async c=>{n.value=!0,s.value=null;try{await ct(c),e.value=e.value.filter(u=>u.id!==c)}catch(u){throw s.value=u.message,u}finally{n.value=!1}},B=async(c,u)=>{var y;n.value=!0,s.value=null;try{const d=await ut(c,u);return((y=t.value)==null?void 0:y.id)===parseInt(c)&&(a.value=await S(c)),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},q=async(c,u,y)=>{var d;n.value=!0,s.value=null;try{const w=await it(c,u,y);return((d=t.value)==null?void 0:d.id)===parseInt(c)&&(a.value=await S(c)),w}catch(w){throw s.value=w.message,w}finally{n.value=!1}},b=async(c,u)=>{var y;n.value=!0,s.value=null;try{const d=await lt(c,u),w=e.value.findIndex(E=>E.id===parseInt(c));return w!==-1&&(e.value[w]=d),((y=t.value)==null?void 0:y.id)===parseInt(c)&&(t.value=d),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},$=async(c,u)=>{var y;n.value=!0,s.value=null;try{const d=await dt(c,u),w=e.value.findIndex(E=>E.id===parseInt(c));return w!==-1&&(e.value[w]=d.opportunity),((y=t.value)==null?void 0:y.id)===parseInt(c)&&(t.value=d.opportunity),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},R=async(c,u)=>{var y;n.value=!0,s.value=null;try{return await ft(c,u),((y=t.value)==null?void 0:y.id)===parseInt(c)&&(a.value=await S(c)),{success:!0}}catch(d){throw s.value=d.message,d}finally{n.value=!1}};return{opportunities:e,currentOpportunity:t,loading:n,error:s,currentOpportunityActivities:I(()=>a.value),hotOpportunities:p,fetchOpportunities:o,fetchOpportunityById:T,createOpportunity:C,updateOpportunity:A,deleteOpportunity:_,addActivity:B,updateActivity:q,deleteActivity:R,addVehicle:b,createOffer:$}});export{xt as a,vt as b,ht as c,yt as d,At as e,pt as f,Et as u};
