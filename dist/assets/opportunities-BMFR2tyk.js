const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-GeQorrw7.js","assets/index-Dxaik04B.css"])))=>i.map(i=>d[i]);
import{ab as Q,ac as j,ad as K,ae as p,af as U,ag as z,aa as N,a6 as H,r as g,c as I,l as G,ah as J,ai as M,aj as X,K as Y,a0 as S,ak as Z,al as tt,am as et,an as at,ao as nt,ap as rt,aq as st}from"./index-GeQorrw7.js";const m=(t=300)=>new Promise(e=>setTimeout(e,t)),x=()=>p.filter(t=>!t.company||t.company===""),ot=async(t={})=>{await m();let e=x();if(t.search){const a=t.search.toLowerCase();e=e.filter(n=>n.name.toLowerCase().includes(a)||n.email.toLowerCase().includes(a))}return{data:e,total:e.length}},F=async t=>{await m();const a=x().find(n=>n.id===parseInt(t));if(!a)throw new Error("Contact not found");return a},ct=async t=>{await m();const e={id:p.length+1,...t,company:null,createdAt:new Date().toISOString(),lastContact:new Date().toISOString()};return p.push(e),e},ut=async(t,e)=>{if(await m(),x().findIndex(v=>v.id===parseInt(t))===-1)throw new Error("Contact not found");const s=p.findIndex(v=>v.id===parseInt(t));return s!==-1&&(p[s]={...p[s],...e,company:null}),p[s]},it=async t=>{await m();const e=p.findIndex(a=>a.id===parseInt(t));if(e===-1)throw new Error("Contact not found");return p.splice(e,1),{success:!0}},lt=async(t,e)=>{if(await m(),!x().find(v=>v.id===parseInt(t)))throw new Error("Contact not found");const s=p.findIndex(v=>v.id===parseInt(t));if(s===-1)throw new Error("Contact not found");return p[s].requestedCar={...e,id:Date.now()},{...p[s]}},dt=async t=>{await m();const a=x().find(v=>v.id===parseInt(t));if(!a)throw new Error("Contact not found");if(!a.requestedCar)throw new Error("Contact must have requested car");const{createLead:n}=await N(async()=>{const{createLead:v}=await import("./index-GeQorrw7.js").then(c=>c.bo);return{createLead:v}},__vite__mapDeps([0,1]));return await n({customerId:a.id,requestedCar:a.requestedCar,source:a.source||"Direct",tags:a.tags||[],stage:"Open Lead",status:"Open",priority:"Normal"})},ft=async t=>{await m();const a=x().find(v=>v.id===parseInt(t));if(!a)throw new Error("Contact not found");if(!a.requestedCar)throw new Error("Contact must have requested car");const{createOpportunity:n}=await N(async()=>{const{createOpportunity:v}=await import("./index-GeQorrw7.js").then(c=>c.bp);return{createOpportunity:v}},__vite__mapDeps([0,1]));return await n({customerId:a.id,vehicle:a.requestedCar,source:a.source||"Direct",tags:a.tags||[],stage:"Qualified",value:a.requestedCar.price||0})},mt=async t=>{await m();const e=Q.filter(a=>a.customerId===parseInt(t));return{data:e,total:e.length}},Ct=async t=>{await m();const e=j.filter(a=>a.customerId===parseInt(t));return{data:e,total:e.length}},gt=async t=>{await m();const e=[],a=p.find(c=>c.id===parseInt(t));a!=null&&a.id,Q.filter(c=>c.customerId===parseInt(t)).forEach(c=>{c.requestedCar&&e.push({...c.requestedCar,id:`requested-${c.id}`,type:"requested",leadId:c.id,leadStage:c.stage})}),a!=null&&a.requestedCar&&e.push({...a.requestedCar,id:`requested-contact-${a.id}`,type:"requested",contactId:a.id});const s=j.filter(c=>c.customerId===parseInt(t));return s.forEach(c=>{U.filter(C=>C.opportunityId===c.id&&C.type==="offer").forEach(C=>{var A;(A=C.data)!=null&&A.vehicle&&e.push({...C.data.vehicle,id:`offered-${C.id}`,type:"offered",opportunityId:c.id,opportunityStage:c.stage,offerDate:C.timestamp})})}),z.filter(c=>c.customerId===parseInt(t)&&c.type==="test-drive").forEach(c=>{c.vehicle&&e.push({brand:c.vehicle.split(" ")[0]||"",model:c.vehicle.split(" ").slice(1).join(" ")||"",id:`drove-${c.id}`,type:"drove",eventId:c.id,testDriveDate:c.start,vehicle:c.vehicle})}),s.forEach(c=>{c.stage==="Closed Won"&&c.vehicle&&e.push({...c.vehicle,id:`purchased-${c.id}`,type:"purchased",opportunityId:c.id,purchaseDate:c.contractDate||c.lastActivity})}),{data:e,total:e.length}},Ot=async t=>{await m();const e=K.filter(a=>a.customerId===parseInt(t));return{data:e,total:e.length}},q=(t=300)=>new Promise(e=>setTimeout(e,t)),R=()=>p.filter(t=>t.company&&t.company!==""),vt=async(t={})=>{await q();let e=R();if(t.search){const a=t.search.toLowerCase();e=e.filter(n=>{var s;return n.name.toLowerCase().includes(a)||n.email.toLowerCase().includes(a)||((s=n.company)==null?void 0:s.toLowerCase().includes(a))})}return{data:e,total:e.length}},V=async t=>{await q();const a=R().find(n=>n.id===parseInt(t));if(!a)throw new Error("Account not found");return a},pt=async t=>{await q();const e={id:p.length+1,...t,createdAt:new Date().toISOString(),lastContact:new Date().toISOString()};return p.push(e),e},yt=async(t,e)=>{if(await q(),R().findIndex(v=>v.id===parseInt(t))===-1)throw new Error("Account not found");const s=p.findIndex(v=>v.id===parseInt(t));return s!==-1&&(p[s]={...p[s],...e}),p[s]},wt=async t=>{await q();const e=p.findIndex(a=>a.id===parseInt(t));if(e===-1)throw new Error("Account not found");return p.splice(e,1),{success:!0}},It=H("customers",()=>{const t=g([]),e=g(null),a=g(!1),n=g(null),s=g(""),v=I(()=>t.value.filter(r=>r.type==="contact")),c=I(()=>t.value.filter(r=>r.type==="account")),T=I(()=>t.value.length),C=I(()=>v.value.length),A=I(()=>c.value.length),D=async(r={})=>{a.value=!0,n.value=null;try{const[i,f]=await Promise.all([ot(r),vt(r)]),l=[...i.data.map(h=>({...h,type:"contact"})),...f.data.map(h=>({...h,type:"account"}))];return t.value=l,{data:l,total:l.length}}catch(i){throw n.value=i.message,i}finally{a.value=!1}},b=async(r,i=null)=>{a.value=!0,n.value=null;try{if(i==="contact")e.value={...await F(r),type:"contact"};else if(i==="account")e.value={...await V(r),type:"account"};else try{const f=await F(r);e.value={...f,type:"contact"}}catch{const f=await V(r);e.value={...f,type:"account"}}return e.value}catch(f){throw n.value=f.message,f}finally{a.value=!1}},L=async r=>{a.value=!0,n.value=null;try{const i=r.company&&r.company!=="",l={...await(i?pt(r):ct(r)),type:i?"account":"contact"};return t.value.unshift(l),l}catch(i){throw n.value=i.message,i}finally{a.value=!1}},k=async(r,i,f)=>{var l;a.value=!0,n.value=null;try{const h=await(f==="account"?yt(r,i):ut(r,i)),$=t.value.findIndex(O=>O.id===r);return $!==-1&&(t.value[$]={...h,type:f}),((l=e.value)==null?void 0:l.id)===r&&(e.value={...h,type:f}),{...h,type:f}}catch(h){throw n.value=h.message,h}finally{a.value=!1}},_=async(r,i)=>{var f;a.value=!0,n.value=null;try{await(i==="account"?wt(r):it(r)),t.value=t.value.filter(l=>l.id!==r),((f=e.value)==null?void 0:f.id)===r&&(e.value=null)}catch(l){throw n.value=l.message,l}finally{a.value=!1}};function B(r){s.value=r,D({search:r})}return{customers:t,contacts:v,accounts:c,currentCustomer:e,loading:a,error:n,searchQuery:s,totalCustomers:T,totalContacts:C,totalAccounts:A,fetchCustomers:D,fetchCustomerById:b,addCustomer:L,updateCustomer:k,removeCustomer:_,setSearchQuery:B,addContact:async r=>await L({...r,company:null}),modifyContact:async(r,i)=>await k(r,i,"contact"),removeContact:async r=>await _(r,"contact"),addRequestedCar:async(r,i)=>{const f=t.value.find(l=>l.id===r);if(!f)throw new Error("Customer not found");if(f.type==="contact")return await lt(r,i);throw new Error("Requested cars not supported for accounts")},convertToLead:async r=>{var f;const i=t.value.find(l=>l.id===r);if(!i)throw new Error("Customer not found");if(i.type==="contact"){const l=await dt(r);return t.value=t.value.filter(h=>h.id!==r),((f=e.value)==null?void 0:f.id)===r&&(e.value=null),l}throw new Error("Only contacts can be converted to leads")},convertToOpportunity:async r=>{var f;const i=t.value.find(l=>l.id===r);if(!i)throw new Error("Customer not found");if(i.type==="contact"){const l=await ft(r);return t.value=t.value.filter(h=>h.id!==r),((f=e.value)==null?void 0:f.id)===r&&(e.value=null),l}throw new Error("Only contacts can be converted to opportunities")}}}),At=H("opportunities",()=>{const t=g([]),e=g(null),a=g([]),n=g(!1),s=g(null),v=I(()=>t.value.filter(o=>o.priority==="Hot"&&o.stage!=="Closed Lost"));G(e,async o=>{if(o)try{a.value=await S(o.id)}catch(u){console.error("Failed to load opportunity activities:",u),a.value=[]}else a.value=[]},{immediate:!0});const c=async(o={})=>{n.value=!0,s.value=null;try{const u=await J(o);return t.value=u.data||u,u}catch(u){throw s.value=u.message,u}finally{n.value=!1}},T=async o=>{n.value=!0,s.value=null;try{const u=await M(o);e.value=u;const y=t.value.findIndex(d=>d.id===parseInt(o));return y!==-1&&(t.value[y]=u),e.value}catch(u){throw s.value=u.message,u}finally{n.value=!1}},C=async o=>{n.value=!0,s.value=null;try{const u=await X(o);return t.value.push(u),u}catch(u){throw s.value=u.message,u}finally{n.value=!1}},A=async(o,u)=>{var y,d;n.value=!0,s.value=null;try{const E=Y().getSetting("autoCloseWidgetsOnClose"),r=((y=e.value)==null?void 0:y.id)===o?e.value:t.value.find(l=>l.id===o);if(E&&u.stage&&(u.stage==="Closed Won"||u.stage==="Closed Lost")){const l=r==null?void 0:r.stage;if(l&&l!=="Closed Won"&&l!=="Closed Lost"){const $=(await S(o)).filter(O=>{var P,W;return O.type==="nfu-task"||O.type==="ofb-task"||((P=O.action)==null?void 0:P.includes("NFU"))||((W=O.action)==null?void 0:W.includes("OFB"))});for(const O of $)O.completed||await L(o,O.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${u.stage}`})}}const i=await Z(o,u),f=t.value.findIndex(l=>l.id===o);return f!==-1&&(t.value[f]=i),((d=e.value)==null?void 0:d.id)===o&&(e.value=i),i}catch(w){throw s.value=w.message,w}finally{n.value=!1}},D=async o=>{n.value=!0,s.value=null;try{await tt(o),t.value=t.value.filter(u=>u.id!==o)}catch(u){throw s.value=u.message,u}finally{n.value=!1}},b=async(o,u)=>{var y;n.value=!0,s.value=null;try{const d=await et(o,u);return((y=e.value)==null?void 0:y.id)===parseInt(o)&&(a.value=await S(o)),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},L=async(o,u,y)=>{var d;n.value=!0,s.value=null;try{const w=await at(o,u,y);return((d=e.value)==null?void 0:d.id)===parseInt(o)&&(a.value=await S(o)),w}catch(w){throw s.value=w.message,w}finally{n.value=!1}},k=async(o,u)=>{var y;n.value=!0,s.value=null;try{const d=await nt(o,u),w=t.value.findIndex(E=>E.id===parseInt(o));return w!==-1&&(t.value[w]=d),((y=e.value)==null?void 0:y.id)===parseInt(o)&&(e.value=d),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},_=async(o,u)=>{var y;n.value=!0,s.value=null;try{const d=await rt(o,u),w=t.value.findIndex(E=>E.id===parseInt(o));return w!==-1&&(t.value[w]=d.opportunity),((y=e.value)==null?void 0:y.id)===parseInt(o)&&(e.value=d.opportunity),d}catch(d){throw s.value=d.message,d}finally{n.value=!1}},B=async(o,u)=>{var y;n.value=!0,s.value=null;try{return await st(o,u),((y=e.value)==null?void 0:y.id)===parseInt(o)&&(a.value=await S(o)),{success:!0}}catch(d){throw s.value=d.message,d}finally{n.value=!1}};return{opportunities:t,currentOpportunity:e,loading:n,error:s,currentOpportunityActivities:I(()=>a.value),hotOpportunities:v,fetchOpportunities:c,fetchOpportunityById:T,createOpportunity:C,updateOpportunity:A,deleteOpportunity:D,addActivity:b,updateActivity:L,deleteActivity:B,addVehicle:k,createOffer:_}});export{At as a,Ct as b,Ot as c,gt as d,mt as f,It as u};
