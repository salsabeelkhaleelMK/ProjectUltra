import{r as I,d as S,o as x,s as i,_ as be,c as A,e as l,x as P,g as M,B as m,k as V,y as e,t as q,n as N,F as U,i as j,l as H,h as ne,C as re,D as he,w as xe,q as _e,E as we,m as ke,G as Se}from"./index-D8nDSNmq.js";import{_ as Ce,u as oe}from"./UnifiedAddForm-qVlS6TXg.js";import{u as ie}from"./opportunities-D1cnNxBd.js";import{Q as K,J as R,Y as O,e as Q,t as B,z as ue,G as Z,W as ee,U as te,H as ae,j as se,n as le,A as Fe,c as $e,a as Ie,b as qe,Z as Te,X as J}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-DVyH4GI_.js";import{_ as Ee}from"./PageHeader-DZXsEyk-.js";import"./contacts-BG9sTx9a.js";const Me={__name:"ManualTab",emits:["submit"],setup(p,{expose:f}){const u=I(null);return f({resetSubmitting:()=>{var t;return(t=u.value)==null?void 0:t.resetSubmitting()},submit:()=>{var t;return(t=u.value)==null?void 0:t.submit()},clear:()=>{var t;return(t=u.value)==null?void 0:t.clear()},canSubmit:()=>{var t;return(t=u.value)==null?void 0:t.canSubmit},isSubmitting:()=>{var t;return(t=u.value)==null?void 0:t.isSubmitting}}),(t,c)=>(x(),S("div",null,[i(Ce,{ref_key:"formRef",ref:u,onSubmit:c[0]||(c[0]=b=>t.$emit("submit",b))},null,512)]))}};function Ve(p,f=","){const u=p.split(`
`).filter(b=>b.trim());if(u.length===0)throw new Error("CSV file is empty");const t=u[0].split(f).map(b=>b.trim().replace(/^"|"$/g,"")),c=[];for(let b=1;b<u.length;b++){const w=u[b].split(f).map(o=>o.trim().replace(/^"|"$/g,""));if(w.length!==t.length){const o=u[b],C=new RegExp(`(?:^|${f})(?:"([^"]*)"|([^${f}]*))`,"g"),n=[];let s;for(;(s=C.exec(o))!==null;)n.push(s[1]||s[2]||"");if(n.length===t.length){const y={};t.forEach((d,v)=>{y[d]=n[v]||""}),c.push(y)}else console.warn(`Row ${b+1} has ${w.length} columns, expected ${t.length}. Skipping.`)}else{const o={};t.forEach((C,n)=>{o[C]=w[n]||""}),c.push(o)}}return{headers:t,data:c}}async function De(p){const f=await be(()=>import("./xlsx-D_0l8YDs.js"),[]);return new Promise((u,t)=>{const c=new FileReader;c.onload=b=>{try{const w=new Uint8Array(b.target.result),o=f.read(w,{type:"array"}),C=o.SheetNames[0],n=o.Sheets[C],s=f.utils.sheet_to_json(n,{header:1});if(s.length===0){t(new Error("Excel file is empty"));return}const y=s[0].map(v=>String(v||"").trim()),d=[];for(let v=1;v<s.length;v++){const h=s[v],T={};y.forEach((a,r)=>{T[a]=h[r]!==void 0?String(h[r]):""}),d.push(T)}u({headers:y,data:d})}catch(w){t(new Error(`Failed to parse Excel file: ${w.message}`))}},c.onerror=()=>{t(new Error("Failed to read Excel file"))},c.readAsArrayBuffer(p)})}async function Oe(p){const f=p.name.toLowerCase();if(f.endsWith(".csv")){const u=await p.text();return Ve(u)}else{if(f.endsWith(".xls")||f.endsWith(".xlsx"))return await De(p);throw new Error("Unsupported file format. Please upload a CSV or Excel file (.csv, .xls, .xlsx)")}}function Re(){const p=I(null),f=I(null),u=I([]),t=I(!1),c=I(null),b=n=>{const s=[".csv",".xls",".xlsx"],y=n.name.toLowerCase();if(!s.some(h=>y.endsWith(h)))throw new Error("Invalid file type. Please upload a CSV or Excel file (.csv, .xls, .xlsx)");const v=10*1024*1024;if(n.size>v)throw new Error("File size exceeds 10MB limit");return!0};return{selectedFile:p,parsedData:f,headers:u,loading:t,error:c,handleFileSelect:async n=>{try{c.value=null,t.value=!0,b(n);const s=await Oe(n);if(p.value=n,f.value=s.data,u.value=s.headers,!s.data||s.data.length===0)throw new Error("File contains no data rows");if(!s.headers||s.headers.length===0)throw new Error("File contains no header row");return{file:n,headers:s.headers,data:s.data,rowCount:s.data.length}}catch(s){throw c.value=s.message,p.value=null,f.value=null,u.value=[],s}finally{t.value=!1}},clearFile:()=>{p.value=null,f.value=null,u.value=[],c.value=null},getPreview:(n=5)=>f.value?f.value.slice(0,n):[]}}const Ue={class:"space-y-4"},je={class:"space-y-2"},Pe={class:"relative w-full"},Ae=["disabled"],Ne={class:"text-heading text-sm font-bold mb-1"},ze={class:"text-fluid-xs text-red-700"},He={class:"flex items-center justify-between"},Le={class:"overflow-x-auto"},Ke={class:"w-full text-fluid-xs"},Be={class:"border-b border-border"},We={key:0,class:"text-sub text-fluid-xs mt-3 text-center"},Y=5,Je={__name:"FileUploadForm",props:{modelValue:{type:File,default:null},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","file-parsed"],setup(p,{expose:f,emit:u}){const t=u,c=I(null),{selectedFile:b,parsedData:w,headers:o,loading:C,error:n,handleFileSelect:s,clearFile:y,getPreview:d}=Re(),v=A(()=>d(Y)),h=async T=>{var r;const a=(r=T.target.files)==null?void 0:r[0];if(a)try{const k=await s(a);t("update:modelValue",a),t("file-parsed",k)}catch{t("update:modelValue",null)}};return f({clearFile:y,selectedFile:b,parsedData:w,headers:o}),(T,a)=>(x(),S("div",Ue,[l("div",je,[i(e(K),{class:"block text-sm font-semibold text-heading"},{default:m(()=>[...a[1]||(a[1]=[V(" Select File ",-1),l("span",{class:"text-brand-red"},"*",-1)])]),_:1}),l("div",Pe,[l("input",{ref_key:"fileInputRef",ref:c,type:"file",accept:".csv,.xls,.xlsx",onChange:h,class:"hidden",disabled:e(C)},null,40,Ae),i(e(O),{onClick:a[0]||(a[0]=r=>{var k;return(k=c.value)==null?void 0:k.click()}),class:N(["border-2 border-dashed cursor-pointer transition-all hover:border-brand-primary/50 w-full",{"opacity-50 cursor-not-allowed":e(C),"border-border":!e(C)}])},{default:m(()=>[i(e(R),{class:"text-center py-8"},{default:m(()=>[a[2]||(a[2]=l("i",{class:"fa-solid fa-cloud-arrow-up text-4xl text-sub mb-3"},null,-1)),l("p",Ne,q(e(b)?e(b).name:"Click to upload or drag and drop"),1),a[3]||(a[3]=l("p",{class:"text-sub text-fluid-xs"},"CSV or Excel (.csv, .xls, .xlsx) up to 10MB",-1))]),_:1})]),_:1},8,["class"])]),e(n)?(x(),P(e(O),{key:0,class:"bg-red-50 border-red-200 mt-2"},{default:m(()=>[i(e(R),{class:"flex items-start gap-2 p-3"},{default:m(()=>[a[4]||(a[4]=l("i",{class:"fa-solid fa-exclamation-circle text-red-600 mt-0.5 text-sm"},null,-1)),l("span",ze,q(e(n)),1)]),_:1})]),_:1})):M("",!0)]),e(b)&&e(w)&&e(w).length>0?(x(),P(e(O),{key:0,class:"border-border"},{default:m(()=>[i(e(Q),null,{default:m(()=>[l("div",He,[i(e(B),null,{default:m(()=>[...a[5]||(a[5]=[V("File Preview",-1)])]),_:1}),i(e(ue),{text:`${e(w).length} rows`,theme:"gray",size:"small"},null,8,["text"])])]),_:1}),i(e(R),null,{default:m(()=>[l("div",Le,[l("table",Ke,[l("thead",null,[l("tr",Be,[(x(!0),S(U,null,j(e(o),r=>(x(),S("th",{key:r,class:"text-left p-2 font-bold text-sub uppercase tracking-wider"},q(r),1))),128))])]),l("tbody",null,[(x(!0),S(U,null,j(v.value,(r,k)=>(x(),S("tr",{key:k,class:"border-b border-border hover:bg-surfaceSecondary transition-colors"},[(x(!0),S(U,null,j(e(o),D=>(x(),S("td",{key:D,class:"p-2 text-body"},q(r[D]||"-"),1))),128))]))),128))])])]),e(w).length>Y?(x(),S("p",We," Showing first "+q(Y)+" of "+q(e(w).length)+" rows ",1)):M("",!0)]),_:1})]),_:1})):M("",!0)]))}},Ye={contacts:{required:["name","email"],optional:["phone","company","address"]},leads:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays"]},opportunities:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays","stage","priority"]}};function G(p){return Ye[p]||{required:[],optional:[]}}function Ge(p,f=[]){const u=I({}),t=I({}),c=A(()=>{const d=G(p.value);return{required:d.required||[],optional:d.optional||[]}}),b=()=>{const d=c.value,v=[...d.required,...d.optional];u.value={},v.forEach(h=>{u.value[h]=""})},w=(d,v)=>{u.value[d]=v||"",o()},o=()=>{t.value={},c.value.required.forEach(v=>{(!u.value[v]||u.value[v].trim()==="")&&(t.value[v]="This field is required")})},C=A(()=>(o(),Object.keys(t.value).length===0)),n=d=>{const v={},h=c.value;return[...h.required,...h.optional].forEach(a=>{const r=u.value[a];if(r&&d[r]!==void 0){const k=d[r];a==="year"||a==="price"||a==="kilometers"||a==="stockDays"?v[a]=k?Number(k):null:v[a]=k?String(k).trim():""}}),v},s=d=>d.map((v,h)=>{try{return n(v)}catch(T){return console.error(`Error transforming row ${h+1}:`,T),null}}).filter(v=>v!==null),y=()=>{const d=Object.entries(u.value).filter(([v,h])=>h&&h.trim()!=="").map(([v,h])=>({field:v,fileColumn:h}));return{totalFields:c.value.required.length+c.value.optional.length,mappedFields:d.length,requiredMapped:c.value.required.filter(v=>u.value[v]).length,requiredTotal:c.value.required.length}};return f.length>0&&b(),{mapping:u,errors:t,availableFields:c,isValid:C,setMapping:w,validateMapping:o,transformRow:n,transformData:s,getMappingSummary:y,initializeMapping:b}}const Qe={class:"space-y-4"},Xe={class:"text-sub text-fluid-xs"},Ze={key:0,class:"space-y-4"},et={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},tt={key:0,class:"text-brand-red text-fluid-xs mt-1"},at={key:1,class:"space-y-4"},st={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},lt={class:"flex items-center justify-between"},nt={class:"text-heading font-bold text-sm"},rt={__name:"ColumnMappingForm",props:{entityType:{type:String,required:!0,validator:p=>["contacts","leads","opportunities"].includes(p)},fileColumns:{type:Array,default:()=>[]},mapping:{type:Object,required:!0}},emits:["update:mapping"],setup(p,{expose:f,emit:u}){const t=p,c=u,{availableFields:b,errors:w,isValid:o,setMapping:C,validateMapping:n,getMappingSummary:s,initializeMapping:y}=Ge(A(()=>t.entityType),t.fileColumns);H([()=>t.fileColumns,()=>t.entityType],([T,a])=>{if(T&&T.length>0&&a&&Object.keys(t.mapping).length===0){y();const r=b.value,k=[...r.required,...r.optional],D={};k.forEach(W=>{D[W]=""}),c("update:mapping",D)}},{immediate:!0});const d=A(()=>s()),v=(T,a)=>{C(T,a),c("update:mapping",{...t.mapping,[T]:a})},h=T=>T.replace(/([A-Z])/g," $1").replace(/^./,a=>a.toUpperCase()).trim();return f({isValid:o,validateMapping:n}),(T,a)=>(x(),S("div",Qe,[i(e(O),{class:"border-border"},{default:m(()=>[i(e(Q),null,{default:m(()=>[i(e(B),null,{default:m(()=>[...a[0]||(a[0]=[V("Map Columns",-1)])]),_:1})]),_:1}),i(e(R),{class:"space-y-6"},{default:m(()=>[l("p",Xe,[V(" Map file columns to "+q(p.entityType)+" fields. ",1),a[1]||(a[1]=l("span",{class:"text-brand-red"},"*",-1)),a[2]||(a[2]=V(" Required. ",-1))]),e(b).required.length>0?(x(),S("div",Ze,[a[4]||(a[4]=l("h4",{class:"text-fluid-xs font-bold uppercase text-sub tracking-wider"},"Required Fields",-1)),l("div",et,[(x(!0),S(U,null,j(e(b).required,r=>(x(),S("div",{key:r,class:"space-y-2"},[i(e(K),{class:"block text-sm font-semibold text-heading"},{default:m(()=>[V(q(h(r))+" ",1),a[3]||(a[3]=l("span",{class:"text-brand-red"},"*",-1))]),_:2},1024),i(e(Z),{"model-value":p.mapping[r]||"","onUpdate:modelValue":k=>v(r,k)},{default:m(()=>[i(e(ee),{class:N(["w-full h-10",{"border-brand-red":e(w)[r]}])},{default:m(()=>[i(e(te),{placeholder:"-- Select column --"})]),_:1},8,["class"]),i(e(ae),null,{default:m(()=>[(x(!0),S(U,null,j(p.fileColumns,k=>(x(),P(e(se),{key:k,value:k},{default:m(()=>[V(q(k),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"]),e(w)[r]?(x(),S("p",tt,q(e(w)[r]),1)):M("",!0)]))),128))])])):M("",!0),e(b).optional.length>0?(x(),S("div",at,[a[5]||(a[5]=l("h4",{class:"text-fluid-xs font-bold uppercase text-sub tracking-wider"},"Optional Fields",-1)),l("div",st,[(x(!0),S(U,null,j(e(b).optional,r=>(x(),S("div",{key:r,class:"space-y-2"},[i(e(K),{class:"block text-sm font-semibold text-heading"},{default:m(()=>[V(q(h(r)),1)]),_:2},1024),i(e(Z),{"model-value":p.mapping[r]||"","onUpdate:modelValue":k=>v(r,k)},{default:m(()=>[i(e(ee),{class:"w-full h-10"},{default:m(()=>[i(e(te),{placeholder:"-- Select column --"})]),_:1}),i(e(ae),null,{default:m(()=>[(x(!0),S(U,null,j(p.fileColumns,k=>(x(),P(e(se),{key:k,value:k},{default:m(()=>[V(q(k),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["model-value","onUpdate:modelValue"])]))),128))])])):M("",!0),d.value?(x(),P(e(O),{key:2,class:"bg-surfaceSecondary border-border"},{default:m(()=>[i(e(R),null,{default:m(()=>[l("div",lt,[l("div",null,[a[6]||(a[6]=l("p",{class:"text-sub text-fluid-xs font-semibold uppercase tracking-wider mb-1"},"Mapping Progress",-1)),l("p",nt,q(d.value.mappedFields)+" / "+q(d.value.totalFields)+" fields mapped ",1)]),i(e(ue),{text:`${d.value.requiredMapped}/${d.value.requiredTotal} required`,theme:d.value.requiredMapped===d.value.requiredTotal?"green":"red",size:"small"},null,8,["text","theme"])])]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})]))}},ot={class:"w-full space-y-4"},it={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},ut={class:"flex items-center gap-3 mb-1"},dt={class:"w-10 h-10 rounded-lg bg-surfaceSecondary flex items-center justify-center border border-border shrink-0"},ct={class:"font-bold text-heading text-sm"},pt={class:"text-sub text-fluid-xs"},ft={key:0},mt={key:1},gt={key:2,class:"flex items-center justify-end gap-3 pt-4 border-t border-border"},yt={key:0},vt={key:1},bt={class:"flex items-center justify-between"},ht={class:"text-sub text-fluid-xs"},xt={class:"text-fluid-xs text-orange-700"},_t={class:"text-body text-fluid-xs"},wt={key:0,class:"text-orange-700 font-semibold"},kt={__name:"UploadTab",setup(p){const f=ne(),u=oe(),t=re(),c=ie(),b=I(null),w=I(null),o=I("contacts"),C=I(null),n=I(null),s=I([]),y=I({}),d=I(!1),v=I(0),h=I(0),T=I(0),a=I([]),r=I(!1),k=[{value:"contacts",label:"Contacts",description:"Import customer contacts",icon:"fa-solid fa-users"},{value:"leads",label:"Leads",description:"Import lead records",icon:"fa-solid fa-user-plus"},{value:"opportunities",label:"Opportunities",description:"Import opportunity records",icon:"fa-solid fa-briefcase"}],D=g=>{const F={},_=G(o.value);return[..._.required,..._.optional].forEach(E=>{const z=y.value[E];if(z&&g[z]!==void 0){const L=g[z];E==="year"||E==="price"||E==="kilometers"||E==="stockDays"?F[E]=L?Number(L):null:F[E]=L?String(L).trim():""}}),F},W=g=>g.map(F=>{try{return D(F)}catch(_){return console.error("Error transforming row:",_),null}}).filter(F=>F!==null),pe=A(()=>o.value?(G(o.value).required||[]).every(_=>{const $=y.value[_];return $&&$.trim()!==""}):!1),X=A(()=>o.value&&n.value&&n.value.length>0&&pe.value),fe=A(()=>h.value===0?0:Math.round(v.value/h.value*100)),me=g=>{n.value=g.data,s.value=g.headers,y.value={},r.value=!1,a.value=[]},ge=()=>{var g;o.value="contacts",C.value=null,n.value=null,s.value=[],y.value={},(g=b.value)==null||g.clearFile(),r.value=!1,a.value=[]},ye=async()=>{if(X.value){d.value=!0,v.value=0,T.value=0,a.value=[],r.value=!1,h.value=n.value.length;try{const g=W(n.value),F=10;for(let _=0;_<g.length;_+=F){const $=g.slice(_,_+F);for(const E of $){try{await ve(E),T.value++}catch(z){a.value.push({row:_+$.indexOf(E)+1,error:z.message})}v.value++}}r.value=!0,setTimeout(()=>{const _=o.value==="contacts"?"contacts":o.value==="leads"?"open-leads":"open-opportunities";f.push({path:"/customers",query:{tab:_}})},2e3)}catch(g){console.error("Import error:",g),a.value.push({row:"all",error:g.message})}finally{d.value=!1}}},ve=async g=>{const F={name:g.name||"",email:g.email||"",phone:g.phone||"",company:g.company||null,address:g.address||"",initials:(g.name||"").split(" ").map(E=>E[0]).join("").toUpperCase()||"??",source:g.source||"Import",tags:[]},_=await u.addCustomer(F);if(o.value==="contacts")return;const $={};if((g.brand||g.model||g.year||g.price)&&($.brand=g.brand||"",$.model=g.model||"",$.year=g.year||null,$.price=g.price||null,$.requestMessage=g.requestMessage||"",$.requestType=g.requestType||"",$.source=g.source||"Import",$.dealership=g.dealership||"",$.channel=g.channel||"Email",$.fuelType=g.fuelType||"",$.gearType=g.gearType||"",$.kilometers=g.kilometers||null,$.stockDays=g.stockDays||null),o.value==="leads"){const E={customer:{id:_.id,name:_.name,initials:_.initials,email:_.email,phone:_.phone,address:_.address||""},status:"Open",stage:"Open Lead",priority:g.priority||"Normal",source:$.source||"Import",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};Object.keys($).length>0&&(E.requestedCar=$),await t.createLead(E)}else if(o.value==="opportunities"){const E={customer:{id:_.id,name:_.name,initials:_.initials,email:_.email,phone:_.phone,address:_.address||""},stage:g.stage||"Qualified",priority:g.priority||"Normal",source:$.source||"Import",assignee:null,assigneeInitials:""};Object.keys($).length>0&&(E.vehicle=$),await c.createOpportunity(E)}};return(g,F)=>(x(),S("div",ot,[i(e(O),{class:"border-border"},{default:m(()=>[i(e(Q),null,{default:m(()=>[i(e(B),null,{default:m(()=>[...F[2]||(F[2]=[V("Select Source",-1)])]),_:1})]),_:1}),i(e(R),{class:"space-y-6"},{default:m(()=>[F[3]||(F[3]=l("p",{class:"text-sub text-fluid-xs"}," Choose what type of data you want to import. ",-1)),l("div",it,[(x(),S(U,null,j(k,_=>i(e(O),{key:_.value,onClick:$=>o.value=_.value,class:N(["cursor-pointer transition-all p-1",o.value===_.value?"border-2 border-brand-primary bg-white shadow-md":"border-border hover:border-brand-primary/30 bg-white"])},{default:m(()=>[i(e(R),{class:"p-4"},{default:m(()=>[l("div",ut,[l("div",dt,[l("i",{class:N([_.icon,"text-lg",o.value===_.value?"text-brand-primary":"text-sub"])},null,2)]),l("div",null,[l("span",ct,q(_.label),1),l("p",pt,q(_.description),1)])])]),_:2},1024)]),_:2},1032,["onClick","class"])),64))])]),_:1})]),_:1}),o.value?(x(),S("div",ft,[i(Je,{ref_key:"fileUploadRef",ref:b,modelValue:C.value,"onUpdate:modelValue":F[0]||(F[0]=_=>C.value=_),onFileParsed:me},null,8,["modelValue"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),S("div",mt,[i(rt,{ref_key:"mappingFormRef",ref:w,"entity-type":o.value,"file-columns":s.value,mapping:y.value,"onUpdate:mapping":F[1]||(F[1]=_=>y.value=_)},null,8,["entity-type","file-columns","mapping"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),S("div",gt,[i(e(le),{variant:"outline",size:"small",onClick:ge,disabled:d.value},{default:m(()=>[...F[4]||(F[4]=[V(" Cancel ",-1)])]),_:1},8,["disabled"]),i(e(le),{variant:"primary",size:"small",onClick:ye,disabled:!X.value||d.value},{default:m(()=>[d.value?(x(),S("span",yt,"Importing...")):(x(),S("span",vt,"Import "+q(n.value.length)+" "+q(o.value),1))]),_:1},8,["disabled"])])):M("",!0),d.value?(x(),P(e(O),{key:3,class:"border-border"},{default:m(()=>[i(e(R),{class:"space-y-3"},{default:m(()=>[l("div",bt,[F[5]||(F[5]=l("span",{class:"text-heading text-fluid-xs font-bold"},"Importing...",-1)),l("span",ht,q(v.value)+" / "+q(h.value),1)]),i(e(Fe),{value:fe.value,class:"h-1.5"},null,8,["value"]),a.value.length>0?(x(),P(e(O),{key:0,class:"bg-orange-50 border-orange-200"},{default:m(()=>[i(e(R),{class:"flex items-start gap-2"},{default:m(()=>[F[6]||(F[6]=l("i",{class:"fa-solid fa-exclamation-triangle text-orange-600 mt-0.5 text-sm"},null,-1)),l("span",xt,q(a.value.length)+" errors encountered ",1)]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})):M("",!0),r.value?(x(),P(e(O),{key:4,class:"bg-green-50 border-green-200"},{default:m(()=>[i(e(R),{class:"space-y-2"},{default:m(()=>[F[7]||(F[7]=l("div",{class:"flex items-center gap-2"},[l("i",{class:"fa-solid fa-check-circle text-green-600 text-base"}),l("span",{class:"font-bold text-heading text-fluid-xs"},"Import Successful")],-1)),l("p",_t,[V(" Successfully imported "+q(T.value)+" "+q(o.value)+". ",1),a.value.length>0?(x(),S("span",wt,q(a.value.length)+" rows had errors. ",1)):M("",!0)])]),_:1})]),_:1})):M("",!0)]))}},de="project-ultra-integrations";function St(){try{const p=localStorage.getItem(de);return p?JSON.parse(p):[]}catch(p){return console.error("Failed to read integrations from localStorage:",p),[]}}function Ct(p){try{localStorage.setItem(de,JSON.stringify(p))}catch(f){console.error("Failed to save integrations to localStorage:",f)}}const ce=he("integrations",()=>{const p=[{id:"api",name:"API Integration",type:"api",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:"",webhookUrl:""},lastSync:null,syncHistory:[]},{id:"email",name:"Email Parsing",type:"email",enabled:!1,connected:!1,entityType:null,config:{emailAddress:"",imapServer:"",imapPort:"",username:"",password:""},lastSync:null,syncHistory:[]},{id:"portal",name:"Portal Integration",type:"portal",enabled:!1,connected:!1,entityType:null,config:{portalUrl:"",apiKey:"",username:""},lastSync:null,syncHistory:[]},{id:"zapier",name:"Zapier",type:"zapier",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:""},lastSync:null,syncHistory:[]},{id:"meta",name:"Meta (Facebook/Instagram)",type:"meta",enabled:!1,connected:!1,entityType:null,config:{appId:"",appSecret:"",accessToken:""},lastSync:null,syncHistory:[]},{id:"woice",name:"WOICE",type:"woice",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:""},lastSync:null,syncHistory:[]},{id:"webhook",name:"Custom Webhook",type:"webhook",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:"",secret:""},lastSync:null,syncHistory:[]}],f=St(),u=I(f.length>0?f:p);H(u,n=>{Ct(n)},{deep:!0});const t=n=>u.value.find(s=>s.id===n);return{integrations:u,getIntegration:t,toggleIntegration:n=>{const s=t(n);s&&(s.enabled=!s.enabled,s.enabled||(s.connected=!1))},updateConfig:(n,s)=>{const y=t(n);y&&(y.config={...y.config,...s})},setEntityType:(n,s)=>{const y=t(n);if(y){if(!["contacts","leads","opportunities"].includes(s))throw new Error("Invalid entity type. Must be contacts, leads, or opportunities");y.entityType=s}},testConnection:async n=>{const s=t(n);return s?new Promise(y=>{setTimeout(()=>{s.connected=!0,y(!0)},1e3)}):!1},addSyncHistory:(n,s)=>{const y=t(n);if(!y)return;const d={timestamp:new Date().toISOString(),entityType:y.entityType,recordsImported:s.recordsImported||0,errors:s.errors||[],conflicts:s.conflicts||[]};y.syncHistory.unshift(d),y.lastSync=d.timestamp,y.syncHistory.length>50&&(y.syncHistory=y.syncHistory.slice(0,50))}}}),Ft={class:"px-4 py-4 flex flex-col gap-4"},$t={class:"flex items-center justify-between gap-3"},It={class:"flex items-center gap-3 min-w-0"},qt={class:"w-8 h-8 rounded-lg bg-surfaceSecondary flex items-center justify-center border border-border shrink-0 group-hover:border-primary/30 transition-colors"},Tt={class:"min-w-0"},Et=["checked"],Mt={class:"space-y-2"},Vt={__name:"IntegrationCard",props:{integration:{type:Object,required:!0}},setup(p){var w;const f=p,u=ce(),t=I(((w=f.integration.config)==null?void 0:w.apiKey)||"");H(()=>{var o;return(o=f.integration.config)==null?void 0:o.apiKey},o=>{t.value=o||""});const c=()=>{var o;t.value!==(((o=f.integration.config)==null?void 0:o.apiKey)||"")&&u.updateConfig(f.integration.id,{apiKey:t.value})},b=()=>{u.toggleIntegration(f.integration.id)};return(o,C)=>(x(),P(e(O),{class:"rounded-xl border-border hover:shadow-mk-dashboard-card transition-all group overflow-hidden bg-surface"},{default:m(()=>[l("div",Ft,[l("div",$t,[l("div",It,[l("div",qt,[l("i",{class:N([p.integration.icon,"text-base text-primary"])},null,2)]),l("div",Tt,[C[2]||(C[2]=l("span",{class:"text-fluid-xs font-bold uppercase tracking-tighter text-sub block mb-0.5"},"Platform",-1)),i(e(B),{class:"text-heading text-sm font-bold truncate leading-tight"},{default:m(()=>[V(q(p.integration.name),1)]),_:1})])]),l("label",{class:"inline-flex items-center cursor-pointer",onClick:C[0]||(C[0]=xe(()=>{},["stop"]))},[l("input",{type:"checkbox",checked:p.integration.enabled,onChange:b,class:"sr-only peer"},null,40,Et),l("div",{class:"relative w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-primary/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-brand-primary",style:_e(p.integration.enabled?{backgroundColor:"var(--brand-primary, #0470e9)"}:{})},null,4)])]),l("div",Mt,[i(e(K),{class:"block text-sm font-semibold text-heading"},{default:m(()=>[...C[3]||(C[3]=[V("API Key",-1)])]),_:1}),i(e($e),{modelValue:t.value,"onUpdate:modelValue":C[1]||(C[1]=n=>t.value=n),type:"password",placeholder:"Enter API Key",class:"w-full h-10 text-sm focus-visible:ring-brand-primary",onBlur:c,onKeyup:we(c,["enter"])},null,8,["modelValue"])])])]),_:1}))}},Dt={class:"w-full"},Ot={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"},Rt={__name:"IntegrationsTab",setup(p){const f=ce(),u=A(()=>f.integrations.map(c=>({...c,icon:t(c.type)}))),t=c=>({api:"fa-solid fa-code",email:"fa-solid fa-envelope",portal:"fa-solid fa-globe",zapier:"fa-brands fa-zapier",meta:"fa-brands fa-meta",woice:"fa-solid fa-microphone",webhook:"fa-solid fa-link"})[c]||"fa-solid fa-plug";return(c,b)=>(x(),S("div",Dt,[l("div",Ot,[(x(!0),S(U,null,j(u.value,w=>(x(),P(Vt,{key:w.id,integration:w},null,8,["integration"]))),128))])]))}};function Ut(p,f="manual"){const t=I((()=>{try{return localStorage.getItem(p)||f}catch(c){return console.error("Failed to read tab from localStorage:",c),f}})());return H(t,c=>{try{localStorage.setItem(p,c)}catch(b){console.error("Failed to save tab to localStorage:",b)}}),{activeTab:t}}const jt={class:"page-container overflow-y-auto"},Pt={class:"px-4 md:px-8 py-8"},At={class:"max-w-6xl mx-auto"},Nt={class:"hidden md:inline whitespace-nowrap font-semibold"},Jt={__name:"AddNew",setup(p){const f=ne(),u=oe(),t=re(),c=ie(),b=I(null),{activeTab:w}=Ut("add-new-active-tab","manual");ke(()=>{(!w.value||!["manual","upload","integrations"].includes(w.value))&&(w.value="manual")}),H(w,s=>{});const o=[{key:"manual",label:"Manual"},{key:"upload",label:"Upload"},{key:"integrations",label:"Integrations"}],C=s=>({manual:"fa-solid fa-pen",upload:"fa-solid fa-upload",integrations:"fa-solid fa-plug"})[s]||"fa-solid fa-circle",n=async s=>{try{const{contactMode:y,selectedContact:d,contactData:v,vehicleData:h,markAsLead:T,markAsOpportunity:a}=s;let r=d;if(y==="new"&&(r=await u.addCustomer({...v,initials:v.name.split(" ").map(k=>k[0]).join("").toUpperCase(),source:"Direct",tags:[],company:v.company||null})),T){const k={customer:{id:r.id,name:r.name,initials:r.initials,email:r.email,phone:r.phone,address:r.address||""},status:"Open",stage:"Open Lead",priority:"Normal",source:(h==null?void 0:h.source)||"Direct",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};h&&Object.keys(h).length>0&&(k.requestedCar=h);const D=await t.createLead(k);f.push({path:"/customers",query:{tab:"open-leads",highlight:`lead-${D.id}`}})}else if(a){const k={customer:{id:r.id,name:r.name,initials:r.initials,email:r.email,phone:r.phone,address:r.address||""},stage:"Qualified",priority:"Normal",source:(h==null?void 0:h.source)||"Direct",assignee:null,assigneeInitials:""};h&&Object.keys(h).length>0&&(k.vehicle=h);const D=await c.createOpportunity(k);f.push({path:"/customers",query:{tab:"open-opportunities",highlight:`opp-${D.id}`}})}else h&&Object.keys(h).length>0&&await u.addRequestedCar(r.id,h),f.push({path:"/customers",query:{tab:"contacts",highlight:`contact-${r.id}`}})}catch(y){console.error("Error saving data:",y),alert("Failed to save. Please try again."),b.value&&b.value.resetSubmitting()}};return(s,y)=>(x(),S("div",jt,[i(Ee,{title:"Add New Customer"}),l("div",Pt,[l("div",At,[i(e(Ie),{modelValue:e(w),"onUpdate:modelValue":y[0]||(y[0]=d=>Se(w)?w.value=d:null),class:"w-full"},{default:m(()=>[i(e(qe),{class:"w-full justify-start border-b border-border bg-transparent mb-8"},{default:m(()=>[(x(),S(U,null,j(o,d=>i(e(Te),{key:d.key,value:d.key,class:"flex items-center gap-2 data-[state=active]:border-b-2 data-[state=active]:border-brand-primary data-[state=active]:text-brand-primary rounded-none pb-3 px-6 h-auto"},{default:m(()=>[l("i",{class:N([C(d.key),"text-sm"])},null,2),l("span",Nt,q(d.label),1)]),_:2},1032,["value"])),64))]),_:1}),i(e(J),{value:"manual"},{default:m(()=>[i(Me,{ref_key:"manualTabRef",ref:b,onSubmit:n},null,512)]),_:1}),i(e(J),{value:"upload"},{default:m(()=>[i(kt)]),_:1}),i(e(J),{value:"integrations"},{default:m(()=>[i(Rt)]),_:1})]),_:1},8,["modelValue"])])])]))}};export{Jt as default};
