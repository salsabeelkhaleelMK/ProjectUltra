import{h as H,d as i,o as l,e,t as c,F as U,i as E,g as _,n as B,k as I,_ as ne,r as D,s as A,c as $,x as Y,D as j,y as F,Q as X,C as oe,a2 as re,m as le,l as ie,a3 as de,a4 as ce,a5 as ue}from"./index-B6fu4vW4.js";import{a as pe,u as fe,f as me,b as be,c as xe,d as ve}from"./opportunities-Cpo2JN0p.js";import{l as ge,r as ye,g as he,m as we,_ as ke}from"./ComingSoonModal-BEAkA8MK.js";import{a as _e,F as $e,L as Ce,H as Ae,j as Te,K as Se,C as De,W as Le}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-K7ki7z-B.js";import{_ as Oe}from"./UnifiedAddForm-D9wj8h_S.js";import"./ReassignUserModal-CoERerCP.js";import"./users-BOT_jg40.js";import"./CreateEventModal-U-8LM8Mz.js";const Fe={class:"rounded-card flex flex-col mb-6",style:{"background-color":"var(--base-muted, #f5f5f5)"}},Ie={class:"px-4 py-4 flex items-center justify-between shrink-0"},je={class:"flex items-center gap-2"},Ne={class:"ml-1 px-2 py-0.5 bg-brand-blue/10 text-brand-blue text-xs font-bold rounded-full"},qe={class:"bg-white rounded-lg p-2 shadow-sm flex flex-col",style:{"box-shadow":"var(--nsc-card-shadow)"}},Be={key:0,class:"divide-y divide-gray-100"},Ue=["onClick"],Ee={class:"flex items-start justify-between gap-3"},Re={class:"flex-1 min-w-0"},Ve={class:"flex items-center gap-2 mb-1"},Me={class:"text-xs font-semibold text-heading uppercase tracking-wider"},We={class:"flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-sub"},Pe={key:0,class:"flex items-center gap-1"},ze={key:1,class:"flex items-center gap-1"},Qe={key:0,class:"mt-2 space-y-1.5 border-t border-gray-50 pt-2"},Ye={class:"flex items-center gap-2 min-w-0"},He={class:"text-xs text-body font-medium truncate"},Ke={key:1,class:"text-center py-8 text-sub"},Ge={__name:"CustomerLeadsWidget",props:{leads:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]}},emits:["add-lead"],setup(b,{emit:g}){const m=b,u=H(),o=a=>{if(!a)return 0;const t=new Date(a),p=Math.abs(new Date-t);return Math.ceil(p/(1e3*60*60*24))},y=a=>{const t=[];return m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(p=>p.leadId===a.id).forEach(p=>{t.push({id:p.id,type:p.title||"Task",description:p.description||p.title})}),a.stage==="Open Lead"&&o(a.createdAt)>=0&&t.push({id:`lead-${a.id}-lq`,type:"LQ",description:"Call to Verify Contact Details"}),t},f=a=>({LQ:"bg-orange-50 text-orange-600 border-orange-100"})[a]||"bg-surface text-body border-gray-100",T=a=>({"Open Lead":"bg-orange-50 text-orange-600 border-orange-100",Validated:"bg-blue-50 text-blue-600 border-blue-100",Contacted:"bg-blue-50 text-blue-600 border-blue-100"})[a]||"bg-surfaceSecondary text-body border-gray-100",h=a=>{const t=u.resolve({path:`/tasks/${a.id}`,query:{type:"lead"}});window.open(t.href,"_blank")};return(a,t)=>(l(),i("div",Fe,[e("div",Ie,[e("div",je,[t[1]||(t[1]=e("i",{class:"fa-solid fa-user-circle text-heading"},null,-1)),t[2]||(t[2]=e("h2",{class:"text-fluid-sm font-medium text-heading leading-5"},"Leads",-1)),e("span",Ne,c(b.leads.length),1)]),e("button",{onClick:t[0]||(t[0]=r=>a.$emit("add-lead")),class:"text-fluid-xs text-brand-blue hover:text-brand-blue/80 font-medium flex items-center gap-1 transition-colors"},[...t[3]||(t[3]=[e("i",{class:"fa-solid fa-plus text-xs"},null,-1),e("span",null,"Add Lead",-1)])])]),e("div",qe,[b.leads.length>0?(l(),i("div",Be,[(l(!0),i(U,null,E(b.leads,r=>(l(),i("div",{key:r.id,class:"flex flex-col p-3 hover:bg-surfaceSecondary transition-colors rounded-md group cursor-pointer",onClick:p=>h(r)},[e("div",Ee,[e("div",Re,[e("div",Ve,[e("span",Me,"Lead #"+c(r.id),1),e("span",{class:B(["text-xs px-1.5 py-0.5 rounded font-bold uppercase tracking-tighter border",T(r.stage)])},c(r.stage),3)]),e("div",We,[r.assignee?(l(),i("span",Pe,[t[4]||(t[4]=e("i",{class:"fa-solid fa-user text-xs"},null,-1)),I(" "+c(r.assignee),1)])):_("",!0),r.requestedCar?(l(),i("span",ze,[t[5]||(t[5]=e("i",{class:"fa-solid fa-car text-xs"},null,-1)),I(" "+c(r.requestedCar.brand)+" "+c(r.requestedCar.model),1)])):_("",!0)])]),t[6]||(t[6]=e("div",{class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-blue/30 text-sub hover:text-brand-blue transition-all shrink-0"},[e("i",{class:"fa-solid fa-external-link text-xs"})],-1))]),y(r).length>0?(l(),i("div",Qe,[(l(!0),i(U,null,E(y(r),p=>(l(),i("div",{key:p.id,class:"flex items-center justify-between p-2 bg-surfaceSecondary/50 border border-black/5 rounded-md"},[e("div",Ye,[e("span",{class:B(["text-xs px-1.5 py-0.5 rounded font-black uppercase tracking-widest border",f(p.type)])},c(p.type),3),e("span",He,c(p.description),1)]),t[7]||(t[7]=e("i",{class:"fa-solid fa-chevron-right text-xs text-sub opacity-50"},null,-1))]))),128))])):_("",!0)],8,Ue))),128))])):(l(),i("div",Ke,[...t[8]||(t[8]=[e("i",{class:"fa-solid fa-inbox text-2xl mb-2 opacity-30"},null,-1),e("p",{class:"text-xs"},"No leads associated with this customer",-1)])]))])]))}},Je={class:"rounded-card flex flex-col mb-6",style:{"background-color":"var(--base-muted, #f5f5f5)"}},Xe={class:"px-4 py-4 flex items-center justify-between shrink-0"},Ze={class:"flex items-center gap-2"},et={class:"ml-1 px-2 py-0.5 bg-brand-blue/10 text-brand-blue text-xs font-bold rounded-full"},tt={class:"bg-white rounded-lg p-2 shadow-sm flex flex-col",style:{"box-shadow":"var(--nsc-card-shadow)"}},st={key:0,class:"divide-y divide-gray-100"},at=["onClick"],nt={class:"flex items-start justify-between gap-3"},ot={class:"flex-1 min-w-0"},rt={class:"flex items-center gap-2 mb-1"},lt={class:"text-xs font-semibold text-heading uppercase tracking-wider"},it={class:"flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-sub"},dt={key:0,class:"flex items-center gap-1"},ct={key:1,class:"flex items-center gap-1"},ut={key:2,class:"flex items-center gap-1"},pt={key:0,class:"mt-2 space-y-1.5 border-t border-gray-50 pt-2"},ft={class:"flex items-center gap-2 min-w-0"},mt={class:"text-xs text-body font-medium truncate"},bt={key:1,class:"text-center py-8 text-sub"},xt={__name:"CustomerOpportunitiesWidget",props:{opportunities:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]},activities:{type:Array,default:()=>[]}},emits:["add-opportunity"],setup(b,{emit:g}){const m=b,u=H(),o=a=>{const t=[];m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(k=>k.opportunityId===a.id).forEach(k=>{t.push({id:k.id,type:k.title||"Task",description:k.description||k.title})});const r=m.activities.filter(S=>S.opportunityId===a.id),p={opportunity:a,scheduledAppointment:a.scheduledAppointment||null,activities:r,hasOffers:r.some(S=>S.type==="offer")||!1,stage:a.displayStage||a.stage,deliverySubstatus:a.deliverySubstatus||null},w=ge(p.stage,p);if(w){const S={OOFB:"Open Opportunity Feedback",UFB:"Unsold Feedback",NFU:"No Follow-Up",OFB:"Offer Feedback",CFB:"Contract Feedback",DFB:"Delivery Feedback",NS:"No-Show Follow-up"};t.push({id:`opp-${a.id}-${w}`,type:w,description:S[w]||w})}return t},y=a=>({OOFB:"bg-blue-50 text-blue-600 border-blue-100",UFB:"bg-purple-50 text-purple-600 border-purple-100",NFU:"bg-red-50 text-red-600 border-red-100",OFB:"bg-yellow-50 text-yellow-600 border-yellow-100",CFB:"bg-green-50 text-green-600 border-green-100",DFB:"bg-teal-50 text-teal-600 border-teal-100",NS:"bg-pink-50 text-pink-600 border-pink-100"})[a]||"bg-surface text-body border-gray-100",f=a=>new Intl.NumberFormat("en-US").format(a),T=a=>({Qualified:"bg-purple-50 text-purple-600 border-purple-100","In Negotiation":"bg-blue-50 text-blue-600 border-blue-100","Closed Won":"bg-green-50 text-green-600 border-green-100","Closed Lost":"bg-red-50 text-red-600 border-red-100"})[a]||"bg-surfaceSecondary text-body border-gray-100",h=a=>{const t=u.resolve({path:`/tasks/${a.id}`,query:{type:"opportunity"}});window.open(t.href,"_blank")};return(a,t)=>(l(),i("div",Je,[e("div",Xe,[e("div",Ze,[t[1]||(t[1]=e("i",{class:"fa-solid fa-briefcase text-heading"},null,-1)),t[2]||(t[2]=e("h2",{class:"text-fluid-sm font-medium text-heading leading-5"},"Opportunities",-1)),e("span",et,c(b.opportunities.length),1)]),e("button",{onClick:t[0]||(t[0]=r=>a.$emit("add-opportunity")),class:"text-fluid-xs text-brand-blue hover:text-brand-blue/80 font-medium flex items-center gap-1 transition-colors"},[...t[3]||(t[3]=[e("i",{class:"fa-solid fa-plus text-xs"},null,-1),e("span",null,"Add Opportunity",-1)])])]),e("div",tt,[b.opportunities.length>0?(l(),i("div",st,[(l(!0),i(U,null,E(b.opportunities,r=>(l(),i("div",{key:r.id,class:"flex flex-col p-3 hover:bg-surfaceSecondary transition-colors rounded-md group cursor-pointer",onClick:p=>h(r)},[e("div",nt,[e("div",ot,[e("div",rt,[e("span",lt,"Opp #"+c(r.id),1),e("span",{class:B(["text-xs px-1.5 py-0.5 rounded font-bold uppercase tracking-tighter border",T(r.stage)])},c(r.displayStage||r.stage),3)]),e("div",it,[r.assignee?(l(),i("span",dt,[t[4]||(t[4]=e("i",{class:"fa-solid fa-user text-xs"},null,-1)),I(" "+c(r.assignee),1)])):_("",!0),r.value?(l(),i("span",ct,[t[5]||(t[5]=e("i",{class:"fa-solid fa-tag text-xs"},null,-1)),I(" € "+c(f(r.value)),1)])):_("",!0),r.vehicle?(l(),i("span",ut,[t[6]||(t[6]=e("i",{class:"fa-solid fa-car text-xs"},null,-1)),I(" "+c(r.vehicle.brand)+" "+c(r.vehicle.model),1)])):_("",!0)])]),t[7]||(t[7]=e("div",{class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-blue/30 text-sub hover:text-brand-blue transition-all shrink-0"},[e("i",{class:"fa-solid fa-external-link text-xs"})],-1))]),o(r).length>0?(l(),i("div",pt,[(l(!0),i(U,null,E(o(r),p=>(l(),i("div",{key:p.id,class:"flex items-center justify-between p-2 bg-surfaceSecondary/50 border border-black/5 rounded-md"},[e("div",ft,[e("span",{class:B(["text-xs px-1.5 py-0.5 rounded font-black uppercase tracking-widest border",y(p.type)])},c(p.type),3),e("span",mt,c(p.description),1)]),t[8]||(t[8]=e("i",{class:"fa-solid fa-chevron-right text-xs text-sub opacity-50"},null,-1))]))),128))])):_("",!0)],8,at))),128))])):(l(),i("div",bt,[...t[9]||(t[9]=[e("i",{class:"fa-solid fa-inbox text-2xl mb-2 opacity-30"},null,-1),e("p",{class:"text-xs"},"No opportunities associated with this customer",-1)])]))])]))}},vt={key:0,class:"mb-8"},gt={class:"relative"},yt={class:"flex overflow-x-auto space-x-4 pb-4 scrollbar-hide scroll-smooth snap-x snap-mandatory",style:{"scrollbar-width":"thin"}},ht=["onClick"],wt={class:"w-full h-36 bg-surfaceTertiary flex items-center justify-center overflow-hidden"},kt=["src"],_t={key:1,class:"fa-solid fa-car text-4xl text-sub"},$t={class:"p-6"},Ct={class:"font-bold text-heading text-sm mb-1"},At={key:0,class:"text-xs text-sub mb-2"},Tt={key:1,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-green-50 border border-green-100 text-green-700 text-xs font-semibold rounded-md mb-2"},St={__name:"VehiclesCarousel",props:{cars:{type:Array,default:()=>[]}},emits:["car-click"],setup(b,{emit:g}){const m=g,u=D(!1),o=h=>new Intl.NumberFormat("en-US").format(h),y=h=>({requested:"Requested",offered:"Offered",drove:"Drove",purchased:"Purchased"})[h]||"Car",f=h=>({requested:"bg-blue-600",offered:"bg-purple-600",drove:"bg-green-600",purchased:"bg-teal-600"})[h]||"bg-gray-600",T=h=>{m("car-click",h),u.value=!0};return(h,a)=>b.cars.length>0?(l(),i("div",vt,[a[2]||(a[2]=e("div",{class:"flex items-center gap-2 mb-4"},[e("i",{class:"fa-solid fa-thumbtack text-sub text-xs"}),e("h3",{class:"font-bold text-heading text-sm"},"Cars")],-1)),e("div",gt,[e("div",yt,[(l(!0),i(U,null,E(b.cars,(t,r)=>(l(),i("div",{key:t.id,class:"flex-none w-64 snap-start bg-surface border border-E5E7EB rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow cursor-pointer relative",onClick:p=>T(t)},[e("div",{class:B(["absolute top-2 right-2 z-10 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm",f(t.type)])},c(y(t.type)),3),e("div",wt,[t.image?(l(),i("img",{key:0,src:t.image,alt:"Car",class:"w-full h-full object-cover"},null,8,kt)):(l(),i("i",_t))]),e("div",$t,[e("h4",Ct,c(t.brand)+" "+c(t.model)+" ("+c(t.year)+")",1),t.price?(l(),i("p",At,"€ "+c(o(t.price)),1)):_("",!0),t.stockDays!==null&&t.stockDays!==void 0?(l(),i("div",Tt,[a[1]||(a[1]=e("div",{class:"w-1 h-1 bg-green-500 rounded-full"},null,-1)),I(" In stock ("+c(t.stockDays)+" days) ",1)])):_("",!0)])],8,ht))),128))])]),A(ye,{show:u.value,title:"Car Details",onClose:a[0]||(a[0]=t=>u.value=!1)},null,8,["show"])])):_("",!0)}},Dt=ne(St,[["__scopeId","data-v-b4e6eb55"]]),Lt={__name:"AddLeadOpportunityModal",props:{show:{type:Boolean,default:!1},type:{type:String,required:!0},contact:{type:Object,required:!0}},emits:["close","save"],setup(b,{emit:g}){const m=b,u=g,o=D(null),y=$(()=>m.type==="lead"?"Add New Lead":"Add New Opportunity"),f=$(()=>`Create a ${m.type} for ${m.contact.name}`),T=a=>{a||u("close")},h=a=>{u("save",a)};return(a,t)=>(l(),Y(F(Le),{open:b.show,"onUpdate:open":T},{default:j(()=>[A(F(_e),null,{default:j(()=>[A(F($e),{class:"fixed inset-0 z-50 bg-black/50"}),A(F(Ce),{class:"w-full sm:max-w-lg"},{default:j(()=>[A(F(Ae),null,{default:j(()=>[A(F(Te),null,{default:j(()=>[I(c(y.value),1)]),_:1}),A(F(Se),null,{default:j(()=>[I(c(f.value),1)]),_:1})]),_:1}),A(Oe,{ref_key:"formRef",ref:o,"initial-contact":b.contact,"hide-contact-selection":!0,"force-type":b.type,onSubmit:h},null,8,["initial-contact","force-type"]),A(F(De),{class:"flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"},{default:j(()=>{var r,p,w,S;return[A(F(X),{label:"Cancel",variant:"outline",size:"small",class:"rounded-sm w-full sm:w-auto",onClick:t[0]||(t[0]=k=>a.$emit("close"))}),A(F(X),{label:(r=o.value)!=null&&r.isSubmitting?"Saving...":"Save",variant:"primary",size:"small",class:"rounded-sm w-full sm:w-auto !bg-brand-red !hover:bg-brand-red-dark !text-white !border-brand-red",disabled:((p=o.value)==null?void 0:p.isSubmitting)||!((w=o.value)!=null&&w.canSubmit),onClick:(S=o.value)==null?void 0:S.submit},null,8,["label","disabled","onClick"])]}),_:1})]),_:1})]),_:1})]),_:1},8,["open"]))}},Ot={class:"rounded-card flex flex-col mb-6",style:{"background-color":"var(--base-muted, #f5f5f5)"}},Ft={class:"bg-white rounded-lg p-2 shadow-sm flex flex-col",style:{"box-shadow":"var(--nsc-card-shadow)"}},It={class:"divide-y divide-gray-100"},jt={class:"p-3"},Nt={key:0,class:"text-sm text-body leading-relaxed whitespace-pre-line"},qt={key:1,class:"flex items-center gap-3 py-1 text-sub"},Bt={key:0,class:"p-3"},Ut={class:"flex flex-wrap gap-2"},Et={__name:"CustomerSummaryWidget",props:{summary:{type:String,default:null},preferences:{type:Array,default:()=>[]},customerData:{type:Object,default:null}},setup(b){const g=b,m=$(()=>{if(g.preferences&&g.preferences.length>0)return g.preferences;const u=[],o=g.customerData;if(!o)return u;if(o.preferredVehicleType&&u.push({icon:"fa-solid fa-car",label:`Prefers ${o.preferredVehicleType}s`}),o.preferredChannel){const y={whatsapp:"fa-brands fa-whatsapp",phone:"fa-solid fa-phone",email:"fa-solid fa-envelope",sms:"fa-solid fa-message"};u.push({icon:y[o.preferredChannel.toLowerCase()]||"fa-solid fa-comment",label:`Prefers ${o.preferredChannel}`})}return o.preferredContactTime&&u.push({icon:"fa-solid fa-clock",label:o.preferredContactTime}),o.budgetRange&&u.push({icon:"fa-solid fa-dollar-sign",label:o.budgetRange}),u});return(u,o)=>(l(),i("div",Ot,[o[1]||(o[1]=e("div",{class:"px-4 py-4 flex items-center justify-between shrink-0"},[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-lightbulb text-heading"}),e("h2",{class:"text-fluid-sm font-medium text-heading leading-5"},"Customer Insights")])],-1)),e("div",Ft,[e("div",It,[e("div",jt,[b.summary?(l(),i("p",Nt,c(b.summary),1)):(l(),i("div",qt,[...o[0]||(o[0]=[e("i",{class:"fa-solid fa-circle-info text-sm opacity-20"},null,-1),e("p",{class:"text-xs italic"},"No customer insights available yet. Insights will appear as we learn more about this customer's preferences and behavior.",-1)])]))]),m.value&&m.value.length>0?(l(),i("div",Bt,[e("div",Ut,[(l(!0),i(U,null,E(m.value,(y,f)=>(l(),i("span",{key:f,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-surfaceSecondary text-heading text-xs font-semibold uppercase tracking-wider rounded border border-black/5"},[e("i",{class:B([y.icon,"text-xs text-brand-blue"])},null,2),I(" "+c(y.label),1)]))),128))])])):_("",!0)])])]))}},Rt={class:"rounded-card flex flex-col mb-6",style:{"background-color":"var(--base-muted, #f5f5f5)"}},Vt={class:"bg-white rounded-lg p-2 shadow-sm flex flex-col",style:{"box-shadow":"var(--nsc-card-shadow)"}},Mt={class:"divide-y divide-gray-100"},Wt={key:0,class:"flex items-center justify-between gap-3 p-3 hover:bg-surfaceSecondary transition-colors rounded-md group"},Pt={class:"flex items-center gap-3 min-w-0"},zt={class:"min-w-0"},Qt={class:"text-sm text-body truncate"},Yt={class:"text-xs text-sub truncate"},Ht={key:1,class:"flex items-center justify-between gap-3 p-3 hover:bg-surfaceSecondary transition-colors rounded-md group"},Kt={class:"flex items-center gap-3 min-w-0"},Gt={class:"w-8 h-8 rounded bg-brand-slate/10 flex items-center justify-center shrink-0"},Jt={class:"min-w-0"},Xt={class:"text-sm text-body truncate"},Zt={class:"text-xs text-sub truncate"},es={key:2,class:"flex items-center justify-between gap-3 p-3 hover:bg-surfaceSecondary transition-colors rounded-md group"},ts={class:"flex items-center gap-3 min-w-0"},ss={class:"min-w-0"},as={class:"text-sm text-body truncate"},ns={class:"text-xs text-sub truncate"},os={key:3,class:"flex items-center justify-between gap-3 p-3 hover:bg-surfaceSecondary transition-colors rounded-md group"},rs={class:"flex items-center gap-3 min-w-0"},ls={class:"min-w-0"},is={class:"text-sm text-body truncate"},ds={class:"text-xs text-sub truncate"},cs={key:0,class:"text-center py-6 text-sub"},us={__name:"RecentActivitiesWidget",props:{nextAppointment:{type:Object,default:null},activities:{type:Array,default:()=>[]},leads:{type:Array,default:()=>[]},opportunities:{type:Array,default:()=>[]},customerId:{type:[Number,String],default:null}},setup(b){const g=b,m=H(),u=$(()=>{const n=["email","sms","whatsapp","call"],s=g.activities.filter(v=>n.includes(v.type)).sort((v,L)=>new Date(L.timestamp)-new Date(v.timestamp));return s.length>0?s[0]:null}),o=$(()=>{const n=g.leads.filter(s=>{var v;return!s.isDisqualified&&s.status!=="Disqualified"&&!((v=s.stage)!=null&&v.includes("Closed"))});return n.length>0?n[0]:null}),y=$(()=>{if(!o.value)return null;try{return he({lead:o.value,displayStage:o.value.stage})}catch(n){return console.error("Error getting lead next action:",n),null}}),f=$(()=>{const n=g.opportunities.filter(s=>s.stage!=="Closed Won"&&s.stage!=="Closed Lost");return n.length>0?n[0]:null}),T=$(()=>{if(!f.value)return null;try{const n=g.activities.filter(v=>v.opportunityId===f.value.id)||[];return we(f.value.stage,{opportunity:f.value,scheduledAppointment:f.value.scheduledAppointment||null,activities:n,hasOffers:n.some(v=>v.type==="offer")||!1,stage:f.value.stage,deliverySubstatus:f.value.deliverySubstatus||null,formatDateTime:v=>v?new Date(v).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):""})}catch(n){return console.error("Error getting opportunity next action:",n),null}}),h=n=>({email:"fa-solid fa-envelope",sms:"fa-solid fa-message",whatsapp:"fa-brands fa-whatsapp",call:"fa-solid fa-phone"})[n]||"fa-solid fa-comment",a=n=>n.type==="call"?n.content||`Call with ${n.user||"customer"}`:n.type==="email"?n.subject||n.content||"Email communication":n.type==="sms"||n.type==="whatsapp"?n.content||`${n.type.toUpperCase()} message`:n.content||"Communication",t=n=>{if(!n)return"";const s=new Date(n),v=new Date,L=Math.abs(v-s),C=Math.ceil(L/(1e3*60*60*24));return C===1?"Today":C===2?"Yesterday":C<=7?`${C-1} days ago`:s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:s.getFullYear()!==v.getFullYear()?"numeric":void 0})},r=n=>{if(!n)return"";const s=new Date(n),v=new Date;if(s.toDateString()===v.toDateString())return`Today at ${s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}`;const C=new Date(v);return C.setDate(C.getDate()+1),s.toDateString()===C.toDateString()?`Tomorrow at ${s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}`:s.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},p=()=>{var n,s;(n=g.nextAppointment)!=null&&n.opportunityId?m.push({path:`/tasks/${g.nextAppointment.opportunityId}`,query:{type:"opportunity"}}):(s=g.nextAppointment)!=null&&s.leadId?m.push({path:`/tasks/${g.nextAppointment.leadId}`,query:{type:"lead"}}):m.push({path:"/calendar"})},w=()=>{var n,s;(n=u.value)!=null&&n.opportunityId?m.push({path:`/tasks/${u.value.opportunityId}`,query:{type:"opportunity"}}):(s=u.value)!=null&&s.leadId&&m.push({path:`/tasks/${u.value.leadId}`,query:{type:"lead"}})},S=()=>{var n;(n=o.value)!=null&&n.id&&m.push({path:`/tasks/${o.value.id}`,query:{type:"lead"}})},k=()=>{var n;(n=f.value)!=null&&n.id&&m.push({path:`/tasks/${f.value.id}`,query:{type:"opportunity"}})};return(n,s)=>{var v,L,C,R,M,W;return l(),i("div",Rt,[s[12]||(s[12]=e("div",{class:"px-4 py-4 flex items-center justify-between shrink-0"},[e("div",{class:"flex items-center gap-2"},[e("i",{class:"fa-solid fa-clock-rotate-left text-heading"}),e("h2",{class:"text-fluid-sm font-medium text-heading leading-5"},"Recent Activities")])],-1)),e("div",Vt,[e("div",Mt,[b.nextAppointment?(l(),i("div",Wt,[e("div",Pt,[s[1]||(s[1]=e("div",{class:"w-8 h-8 rounded bg-brand-blue/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-calendar-check text-brand-blue text-sm"})],-1)),e("div",zt,[s[0]||(s[0]=e("div",{class:"text-xs font-semibold text-heading uppercase tracking-wider mb-0.5"},"Next Appointment",-1)),e("div",Qt,c(r(b.nextAppointment.start)),1),e("div",Yt,c(b.nextAppointment.title||"Appointment"),1)])]),e("button",{onClick:p,class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-blue/30 text-sub hover:text-brand-blue transition-all shrink-0",title:"View Details"},[...s[2]||(s[2]=[e("i",{class:"fa-solid fa-arrow-right text-xs"},null,-1)])])])):_("",!0),u.value?(l(),i("div",Ht,[e("div",Kt,[e("div",Gt,[e("i",{class:B([h(u.value.type),"text-brand-slate text-sm"])},null,2)]),e("div",Jt,[s[3]||(s[3]=e("div",{class:"text-xs font-semibold text-heading uppercase tracking-wider mb-0.5"},"Last Communication",-1)),e("div",Xt,c(a(u.value)),1),e("div",Zt,c(t(u.value.timestamp)),1)])]),e("button",{onClick:w,class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-slate/30 text-sub hover:text-brand-slate transition-all shrink-0",title:"View Details"},[...s[4]||(s[4]=[e("i",{class:"fa-solid fa-arrow-right text-xs"},null,-1)])])])):_("",!0),o.value?(l(),i("div",es,[e("div",ts,[s[6]||(s[6]=e("div",{class:"w-8 h-8 rounded bg-brand-dark/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-user-clock text-brand-dark text-sm"})],-1)),e("div",ss,[s[5]||(s[5]=e("div",{class:"text-xs font-semibold text-heading uppercase tracking-wider mb-0.5"},"Active Lead Request",-1)),e("div",as,c(((v=y.value)==null?void 0:v.label)||"No action defined"),1),e("div",ns,c((L=o.value.requestedCar)==null?void 0:L.brand)+" "+c((C=o.value.requestedCar)==null?void 0:C.model),1)])]),e("button",{onClick:S,class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-dark/30 text-sub hover:text-brand-dark transition-all shrink-0",title:"View Details"},[...s[7]||(s[7]=[e("i",{class:"fa-solid fa-arrow-right text-xs"},null,-1)])])])):_("",!0),f.value?(l(),i("div",os,[e("div",rs,[s[9]||(s[9]=e("div",{class:"w-8 h-8 rounded bg-brand-blue/10 flex items-center justify-center shrink-0"},[e("i",{class:"fa-solid fa-handshake text-brand-blue text-sm"})],-1)),e("div",ls,[s[8]||(s[8]=e("div",{class:"text-xs font-semibold text-heading uppercase tracking-wider mb-0.5"},"Active Opportunity",-1)),e("div",is,c(((R=T.value)==null?void 0:R.label)||"No action defined"),1),e("div",ds,c((M=f.value.vehicle)==null?void 0:M.brand)+" "+c((W=f.value.vehicle)==null?void 0:W.model)+" - "+c(f.value.stage),1)])]),e("button",{onClick:k,class:"w-8 h-8 flex items-center justify-center bg-surface border border-black/5 rounded hover:bg-white hover:border-brand-blue/30 text-sub hover:text-brand-blue transition-all shrink-0",title:"View Details"},[...s[10]||(s[10]=[e("i",{class:"fa-solid fa-arrow-right text-xs"},null,-1)])])])):_("",!0)]),!b.nextAppointment&&!u.value&&!o.value&&!f.value?(l(),i("div",cs,[...s[11]||(s[11]=[e("i",{class:"fa-solid fa-inbox text-2xl mb-2 opacity-30"},null,-1),e("p",{class:"text-xs"},"No recent activities available",-1)])])):_("",!0)])])}}},ps={class:"h-full flex flex-col overflow-hidden bg-surface"},fs={key:0,class:"flex-1 flex items-center justify-center"},ms={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},_s={__name:"Customer",setup(b){const g=re(),m=H();oe(),pe();const u=fe(),o=D(!1),y=D(null),f=D(null),T=D([]),h=D([]),a=D([]),t=D([]),r=D([]),p=D(null),w=$(()=>parseInt(g.params.id)),S=$(()=>"contact"),k=$(()=>{const d=f.value||u.currentCustomer;return d?{...d,id:d.id,type:"contact",customer:{id:d.id,name:d.name,email:d.email,phone:d.phone,address:d.address||"",initials:d.initials},source:d.source||"Direct",tags:d.tags||[],stage:"Contact",assignee:null,assigneeId:null}:null}),n=$(()=>null),s=$(()=>({currentActivities:$(()=>[]),addActivity:async()=>{},updateActivity:async()=>{},deleteActivity:async()=>{}})),v=$(()=>({overviewActions:[],tabActions:["note","email","sms","whatsapp","attachment"]})),L=async(d=null)=>{const x=d||w.value;if(x)try{const O=g.query.type==="account"?"account":"contact",[z,Q,K,se,ae]=await Promise.all([u.fetchCustomerById(x,O),me(x),be(x),xe(x),ve(x)]);f.value=z||u.currentCustomer,T.value=Q.data||[],h.value=K.data||[],a.value=se.data||[],t.value=ae.data||[];const G=[];for(const N of T.value)try{const q=await de(N.id);G.push(...q)}catch(q){console.error(`Failed to load activities for lead ${N.id}:`,q)}for(const N of h.value)try{const q=await ce(N.id);G.push(...q)}catch(q){console.error(`Failed to load activities for opportunity ${N.id}:`,q)}r.value=G;try{p.value=await ue(x)}catch(N){console.error("Failed to load next appointment:",N),p.value=null}}catch(O){console.error("Error loading customer data:",O)}},C=async()=>{if(!w.value){y.value="No task ID provided";return}o.value=!0,y.value=null;try{await L()}catch(d){y.value=d.message||"Failed to load task",console.error("Error loading task:",d)}finally{o.value=!1}},R=async d=>{var x;try{const O=((x=k.value)==null?void 0:x.type)==="contact"?"contact":"account";await u.addRequestedCar(w.value,d),await C()}catch(O){console.error("Error adding car to customer:",O),y.value=O.message||"Failed to add car"}},M=async()=>{try{o.value=!0;const d=await u.convertToLead(w.value);m.push({path:`/tasks/${d.id}`,query:{type:"lead"}})}catch(d){console.error("Error converting to lead:",d),y.value=d.message||"Failed to convert to lead",o.value=!1}},W=async()=>{try{o.value=!0;const d=await u.convertToOpportunity(w.value);m.push({path:`/tasks/${d.id}`,query:{type:"opportunity"}})}catch(d){console.error("Error converting to opportunity:",d),y.value=d.message||"Failed to convert to opportunity",o.value=!1}},P=D(!1),V=D("lead"),Z=$(()=>{if(!k.value)return{id:null,name:"Unknown",email:"",phone:"",initials:"?"};const d=k.value;return{id:d.id,name:d.name||"Unknown",email:d.email||"",phone:d.phone||"",initials:d.initials||"?"}}),J=d=>{V.value=d,P.value=!0},ee=async d=>{try{o.value=!0,P.value=!1;const x=w.value;if(!x)throw new Error("Customer ID not found");V.value==="lead"?await u.convertToLead(x):await u.convertToOpportunity(x),await L(x),o.value=!1}catch(x){console.error(`Error adding ${V.value}:`,x),y.value=x.message||`Failed to add ${V.value}`,o.value=!1}};le(async()=>{await C()});const te=async()=>{await L()};return ie(()=>g.params.id,d=>{d&&C()}),(d,x)=>(l(),i("div",ps,[o.value||!k.value||k.value&&k.value.id!==w.value?(l(),i("div",fs,[...x[3]||(x[3]=[e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1)])])):(l(),Y(ke,{key:1,task:k.value,type:S.value,"management-widget":n.value,"store-adapter":s.value,"add-new-config":v.value,onCarAdded:R,onConvertToLead:M,onConvertToOpportunity:W,onTagUpdated:te},{"pinned-extra":j(({task:O})=>{var z,Q;return[A(Et,{summary:O.summary||((z=f.value)==null?void 0:z.summary),preferences:O.preferences||((Q=f.value)==null?void 0:Q.preferences),"customer-data":f.value},null,8,["summary","preferences","customer-data"]),A(us,{"next-appointment":p.value,activities:r.value,leads:T.value,opportunities:h.value,"customer-id":w.value},null,8,["next-appointment","activities","leads","opportunities","customer-id"]),t.value.length>0?(l(),Y(Dt,{key:0,cars:t.value},null,8,["cars"])):_("",!0),e("div",ms,[A(Ge,{leads:T.value,"all-tasks":a.value,onAddLead:x[0]||(x[0]=K=>J("lead"))},null,8,["leads","all-tasks"]),A(xt,{opportunities:h.value,"all-tasks":a.value,activities:r.value,onAddOpportunity:x[1]||(x[1]=K=>J("opportunity"))},null,8,["opportunities","all-tasks","activities"])])]}),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])),k.value?(l(),Y(Lt,{key:2,show:P.value,type:V.value,contact:Z.value,onClose:x[2]||(x[2]=O=>P.value=!1),onSave:ee},null,8,["show","type","contact"])):_("",!0)]))}};export{_s as default};
