import{h as R,d as n,o as l,e as t,g as x,t as u,w as G,j as V,F,i as B,n as S,_ as le,r as k,l as N,c as $,p as L,y as H,x as ne,U as ie,k as de,A as P,V as Q}from"./index-DouNJQER.js";import{u as ue}from"./opportunities-BCa2pMzb.js";import{u as ce,f as pe,a as ye,b as me,c as ge}from"./contacts-gJauSlRm.js";import{g as fe,e as ve,f as be,h as xe}from"./ComingSoonModal-BXyox1CQ.js";import{_ as he}from"./ModalShell-B0wxJMz1.js";import{_ as we}from"./UnifiedAddForm-BS1LdKm2.js";import{f as Ce}from"./customers-DeTjmGHK.js";import"./ReassignUserModal-Zaooi_yc.js";import"./users-BeS_L77O.js";import"./CreateEventModal-BHnnucgI.js";const ke={class:"bg-white border border-gray-200 rounded-xl shadow-sm mb-6"},_e={class:"p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center"},$e={class:"flex items-center gap-2"},qe={key:0,class:"text-xs font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded"},Te={key:0,class:"p-6 text-center text-gray-400"},Ae={key:1,class:"p-4 space-y-3"},Oe=["onClick"],Le={class:"flex items-center justify-between mb-2"},Fe={class:"flex-1 min-w-0"},Be={class:"flex items-center gap-2 mb-1"},Se={class:"font-semibold text-slate-800 text-sm"},Ie={class:"flex items-center gap-3 text-xs text-gray-500"},De={key:0},Ne={key:1},Me={key:0,class:"mt-2 space-y-2 border-t border-gray-200 pt-2"},Ee={class:"flex items-center gap-2"},je={class:"text-xs text-slate-700 font-medium"},Ue={__name:"CustomerLeadsWidget",props:{leads:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]}},emits:["add-lead"],setup(c,{emit:w}){const m=c,h=R(),C=a=>{if(!a)return 0;const e=new Date(a),i=Math.abs(new Date-e);return Math.ceil(i/(1e3*60*60*24))},b=a=>{const e=[];return m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(i=>i.leadId===a.id).forEach(i=>{e.push({id:i.id,type:i.title||"Task",description:i.description||i.title})}),a.stage==="Open Lead"&&C(a.createdAt)>=0&&e.push({id:`lead-${a.id}-lq`,type:"LQ",description:"Call to Verify Contact Details"}),e},y=a=>({LQ:"bg-orange-100 text-orange-700 border border-orange-200"})[a]||"bg-gray-100 text-gray-700 border border-gray-200",g=a=>({"Open Lead":"bg-orange-100 text-orange-700 border border-orange-200",Validated:"bg-blue-100 text-blue-700 border border-blue-200",Contacted:"bg-blue-100 text-blue-700 border border-blue-200"})[a]||"bg-gray-100 text-gray-700 border border-gray-200",p=a=>{const e=h.resolve({path:`/customer/${a.id}`,query:{type:"lead"}});window.open(e.href,"_blank")};return(a,e)=>(l(),n("div",ke,[t("div",_e,[t("div",$e,[e[1]||(e[1]=t("i",{class:"fa-solid fa-user-circle text-gray-400 text-xs"},null,-1)),e[2]||(e[2]=t("h3",{class:"font-bold text-slate-800 text-sm"},"Leads",-1)),c.leads.length>0?(l(),n("span",qe,u(c.leads.length),1)):x("",!0)]),t("button",{onClick:e[0]||(e[0]=G(o=>a.$emit("add-lead"),["stop"])),class:"text-xs font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors"},[...e[3]||(e[3]=[t("i",{class:"fa-solid fa-plus-circle"},null,-1),V(" Add Lead ",-1)])])]),c.leads.length===0?(l(),n("div",Te,[...e[4]||(e[4]=[t("i",{class:"fa-solid fa-inbox text-2xl mb-2"},null,-1),t("p",{class:"text-sm"},"No leads associated with this customer",-1)])])):(l(),n("div",Ae,[(l(!0),n(F,null,B(c.leads,o=>(l(),n("div",{key:o.id,class:"flex flex-col p-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg cursor-pointer transition-colors",onClick:i=>p(o)},[t("div",Le,[t("div",Fe,[t("div",Be,[t("span",Se,"Lead #"+u(o.id),1),t("span",{class:S(["text-xs px-2 py-0.5 rounded-full font-medium",g(o.stage)])},u(o.stage),3)]),t("div",Ie,[o.assignee?(l(),n("span",De,u(o.assignee),1)):x("",!0),o.requestedCar?(l(),n("span",Ne,u(o.requestedCar.brand)+" "+u(o.requestedCar.model),1)):x("",!0)])]),e[5]||(e[5]=t("i",{class:"fa-solid fa-external-link text-gray-400 text-xs ml-2"},null,-1))]),b(o).length>0?(l(),n("div",Me,[(l(!0),n(F,null,B(b(o),i=>(l(),n("div",{key:i.id,class:"flex items-center justify-between p-2 bg-white border border-gray-100 rounded-md shadow-sm"},[t("div",Ee,[t("span",{class:S(["text-[10px] px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider",y(i.type)])},u(i.type),3),t("span",je,u(i.description),1)]),e[6]||(e[6]=t("i",{class:"fa-solid fa-chevron-right text-[10px] text-gray-300"},null,-1))]))),128))])):x("",!0)],8,Oe))),128))]))]))}},Re={class:"bg-white border border-gray-200 rounded-xl shadow-sm mb-6"},Ve={class:"p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center"},We={class:"flex items-center gap-2"},ze={key:0,class:"text-xs font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded"},Pe={key:0,class:"p-6 text-center text-gray-400"},Qe={key:1,class:"p-4 space-y-3"},Ge=["onClick"],He={class:"flex items-center justify-between mb-2"},Je={class:"flex-1 min-w-0"},Ke={class:"flex items-center gap-2 mb-1"},Xe={class:"font-semibold text-slate-800 text-sm"},Ye={class:"flex items-center gap-3 text-xs text-gray-500"},Ze={key:0},et={key:1},tt={key:2},st={key:0,class:"mt-2 space-y-2 border-t border-gray-200 pt-2"},at={class:"flex items-center gap-2"},rt={class:"text-xs text-slate-700 font-medium"},ot={__name:"CustomerOpportunitiesWidget",props:{opportunities:{type:Array,default:()=>[]},allTasks:{type:Array,default:()=>[]},activities:{type:Array,default:()=>[]}},emits:["add-opportunity"],setup(c,{emit:w}){const m=c,h=R(),C=a=>{const e=[];m.allTasks&&m.allTasks.length>0&&m.allTasks.filter(v=>v.opportunityId===a.id).forEach(v=>{e.push({id:v.id,type:v.title||"Task",description:v.description||v.title})});const o=m.activities.filter(f=>f.opportunityId===a.id),i={opportunity:a,scheduledAppointment:a.scheduledAppointment||null,activities:o,hasOffers:o.some(f=>f.type==="offer")||!1,stage:a.displayStage||a.stage,deliverySubstatus:a.deliverySubstatus||null},q=fe(i.stage,i);if(q){const f={OOFB:"Open Opportunity Feedback",UFB:"Unsold Feedback",NFU:"No Follow-Up",OFB:"Offer Feedback",CFB:"Contract Feedback",DFB:"Delivery Feedback",NS:"No-Show Follow-up"};e.push({id:`opp-${a.id}-${q}`,type:q,description:f[q]||q})}return e},b=a=>({OOFB:"bg-blue-100 text-blue-700 border border-blue-200",UFB:"bg-purple-100 text-purple-700 border border-purple-200",NFU:"bg-red-100 text-red-700 border border-red-200",OFB:"bg-yellow-100 text-yellow-700 border border-yellow-200",CFB:"bg-green-100 text-green-700 border border-green-200",DFB:"bg-teal-100 text-teal-700 border border-teal-200",NS:"bg-pink-100 text-pink-700 border border-pink-200"})[a]||"bg-gray-100 text-gray-700 border border-gray-200",y=a=>new Intl.NumberFormat("en-US").format(a),g=a=>({Qualified:"bg-purple-100 text-purple-700 border border-purple-200","In Negotiation":"bg-blue-100 text-blue-700 border border-blue-200","Closed Won":"bg-green-100 text-green-700 border border-green-200","Closed Lost":"bg-red-100 text-red-700 border border-red-200"})[a]||"bg-gray-100 text-gray-700 border border-gray-200",p=a=>{const e=h.resolve({path:`/customer/${a.id}`,query:{type:"opportunity"}});window.open(e.href,"_blank")};return(a,e)=>(l(),n("div",Re,[t("div",Ve,[t("div",We,[e[1]||(e[1]=t("i",{class:"fa-solid fa-briefcase text-gray-400 text-xs"},null,-1)),e[2]||(e[2]=t("h3",{class:"font-bold text-slate-800 text-sm"},"Opportunities",-1)),c.opportunities.length>0?(l(),n("span",ze,u(c.opportunities.length),1)):x("",!0)]),t("button",{onClick:e[0]||(e[0]=G(o=>a.$emit("add-opportunity"),["stop"])),class:"text-xs font-bold text-purple-600 hover:text-purple-700 flex items-center gap-1 transition-colors"},[...e[3]||(e[3]=[t("i",{class:"fa-solid fa-plus-circle"},null,-1),V(" Add Opportunity ",-1)])])]),c.opportunities.length===0?(l(),n("div",Pe,[...e[4]||(e[4]=[t("i",{class:"fa-solid fa-inbox text-2xl mb-2"},null,-1),t("p",{class:"text-sm"},"No opportunities associated with this customer",-1)])])):(l(),n("div",Qe,[(l(!0),n(F,null,B(c.opportunities,o=>(l(),n("div",{key:o.id,class:"flex flex-col p-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg cursor-pointer transition-colors",onClick:i=>p(o)},[t("div",He,[t("div",Je,[t("div",Ke,[t("span",Xe,"Opportunity #"+u(o.id),1),t("span",{class:S(["text-xs px-2 py-0.5 rounded-full font-medium",g(o.stage)])},u(o.displayStage||o.stage),3)]),t("div",Ye,[o.assignee?(l(),n("span",Ze,u(o.assignee),1)):x("",!0),o.value?(l(),n("span",et,"€ "+u(y(o.value)),1)):x("",!0),o.vehicle?(l(),n("span",tt,u(o.vehicle.brand)+" "+u(o.vehicle.model),1)):x("",!0)])]),e[5]||(e[5]=t("i",{class:"fa-solid fa-external-link text-gray-400 text-xs ml-2"},null,-1))]),C(o).length>0?(l(),n("div",st,[(l(!0),n(F,null,B(C(o),i=>(l(),n("div",{key:i.id,class:"flex items-center justify-between p-2 bg-white border border-gray-100 rounded-md shadow-sm"},[t("div",at,[t("span",{class:S(["text-[10px] px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider",b(i.type)])},u(i.type),3),t("span",rt,u(i.description),1)]),e[6]||(e[6]=t("i",{class:"fa-solid fa-chevron-right text-[10px] text-gray-300"},null,-1))]))),128))])):x("",!0)],8,Ge))),128))]))]))}},lt={key:0,class:"mb-8"},nt={class:"relative"},it={class:"flex overflow-x-auto space-x-4 pb-4 scrollbar-hide scroll-smooth snap-x snap-mandatory",style:{"scrollbar-width":"thin"}},dt=["onClick"],ut={class:"w-full h-36 bg-gray-200 flex items-center justify-center overflow-hidden"},ct=["src"],pt={key:1,class:"fa-solid fa-car text-4xl text-gray-400"},yt={class:"p-4"},mt={class:"font-bold text-gray-800 text-sm mb-1"},gt={key:0,class:"text-xs text-gray-500 mb-2"},ft={key:1,class:"inline-flex items-center gap-1.5 px-2 py-0.5 bg-green-50 border border-green-100 text-green-700 text-[10px] font-semibold rounded-md mb-2"},vt={__name:"VehiclesCarousel",props:{cars:{type:Array,default:()=>[]}},emits:["car-click"],setup(c,{emit:w}){const m=w,h=k(!1),C=p=>new Intl.NumberFormat("en-US").format(p),b=p=>({requested:"Requested",offered:"Offered",drove:"Drove",purchased:"Purchased"})[p]||"Car",y=p=>({requested:"bg-blue-600",offered:"bg-purple-600",drove:"bg-green-600",purchased:"bg-teal-600"})[p]||"bg-gray-600",g=p=>{m("car-click",p),h.value=!0};return(p,a)=>c.cars.length>0?(l(),n("div",lt,[a[2]||(a[2]=t("div",{class:"flex items-center gap-2 mb-4"},[t("i",{class:"fa-solid fa-thumbtack text-gray-400 text-xs"}),t("h3",{class:"font-bold text-gray-800 text-sm"},"Cars")],-1)),t("div",nt,[t("div",it,[(l(!0),n(F,null,B(c.cars,(e,o)=>(l(),n("div",{key:e.id,class:"flex-none w-64 snap-start bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow cursor-pointer relative",onClick:i=>g(e)},[t("div",{class:S(["absolute top-2 right-2 z-10 text-white text-[10px] font-bold px-2 py-1 rounded-md shadow-sm",y(e.type)])},u(b(e.type)),3),t("div",ut,[e.image?(l(),n("img",{key:0,src:e.image,alt:"Car",class:"w-full h-full object-cover"},null,8,ct)):(l(),n("i",pt))]),t("div",yt,[t("h4",mt,u(e.brand)+" "+u(e.model)+" ("+u(e.year)+")",1),e.price?(l(),n("p",gt,"€ "+u(C(e.price)),1)):x("",!0),e.stockDays!==null&&e.stockDays!==void 0?(l(),n("div",ft,[a[1]||(a[1]=t("div",{class:"w-1 h-1 bg-green-500 rounded-full"},null,-1)),V(" In stock ("+u(e.stockDays)+" days) ",1)])):x("",!0)])],8,dt))),128))])]),N(ve,{show:h.value,title:"Car Details",onClose:a[0]||(a[0]=e=>h.value=!1)},null,8,["show"])])):x("",!0)}},bt=le(vt,[["__scopeId","data-v-56310396"]]),xt={class:"p-6 overflow-y-auto max-h-[70vh]"},ht={__name:"AddLeadOpportunityModal",props:{show:{type:Boolean,default:!1},type:{type:String,required:!0},contact:{type:Object,required:!0}},emits:["close","save"],setup(c,{emit:w}){const m=c,h=w,C=k(null),b=$(()=>m.type==="lead"?"Add New Lead":"Add New Opportunity"),y=$(()=>`Create a ${m.type} for ${m.contact.name}`),g=p=>{h("save",p)};return(p,a)=>(l(),L(he,{show:c.show,title:b.value,subtitle:y.value,size:"lg",onClose:a[0]||(a[0]=e=>p.$emit("close")),onCancel:a[1]||(a[1]=e=>p.$emit("close"))},{default:H(()=>[t("div",xt,[N(we,{ref_key:"formRef",ref:C,"initial-contact":c.contact,"hide-contact-selection":!0,"force-type":c.type,onSubmit:g},null,8,["initial-contact","force-type"])])]),_:1},8,["show","title","subtitle"]))}},wt={class:"h-full flex flex-col overflow-hidden bg-gray-50"},Ct={key:0,class:"flex-1 flex items-center justify-center"},kt={key:1,class:"flex-1 flex items-center justify-center"},_t={class:"text-center"},$t={class:"text-gray-500 mb-2"},qt={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Tt={key:4,class:"flex-1 flex items-center justify-center"},Et={__name:"Customer",setup(c){const w=ie(),m=R(),h=ne(),C=ue(),b=ce(),y=k(!1),g=k(null),p=k(null),a=k([]),e=k([]),o=k([]),i=k([]),q=k([]),f=$(()=>parseInt(w.params.id)),v=$(()=>w.query.type||w.query.stage||"contact"),_=$(()=>{if(v.value==="contact"){const s=p.value||b.currentContact;return s?{...s,id:s.id,type:"contact",customer:{id:s.id,name:s.name,email:s.email,phone:s.phone,address:s.address||"",initials:s.initials},source:s.source||"Direct",tags:s.tags||[],stage:"Contact",assignee:null,assigneeId:null}:null}else if(v.value==="lead"){const s=h.currentLead;return s?{...s,type:"lead"}:null}else{const s=C.currentOpportunity;return s?{...s,type:"opportunity"}:null}}),J=$(()=>null),K=$(()=>({currentActivities:$(()=>[]),addActivity:async()=>{},updateActivity:async()=>{},deleteActivity:async()=>{}})),X=$(()=>({overviewActions:[],tabActions:["note","email","sms","whatsapp","attachment"]})),I=async(s=null)=>{var r;const d=s||(v.value==="contact"?f.value:(r=_.value)==null?void 0:r.customerId);if(d)try{const[O,se,ae,re,oe]=await Promise.all([Ce(d),pe(d),ye(d),me(d),ge(d)]);p.value=O,a.value=se.data||[],e.value=ae.data||[],o.value=re.data||[],i.value=oe.data||[];const M=[];a.value.forEach(E=>{const j=Q.filter(U=>U.leadId===E.id);M.push(...j)}),e.value.forEach(E=>{const j=Q.filter(U=>U.opportunityId===E.id);M.push(...j)}),q.value=M}catch(O){console.error("Error loading customer data:",O)}},D=async()=>{if(!f.value){g.value="No task ID provided";return}y.value=!0,g.value=null;try{v.value==="contact"?await I():v.value==="lead"?(await h.loadLeadById(f.value),await I()):(await C.loadOpportunityById(f.value),await I())}catch(s){g.value=s.message||"Failed to load task",console.error("Error loading task:",s)}finally{y.value=!1}},Y=async s=>{try{await b.addRequestedCar(f.value,s),await D()}catch(d){console.error("Error adding car to contact:",d),g.value=d.message||"Failed to add car"}},Z=async()=>{try{y.value=!0;const s=await b.convertToLead(f.value);m.replace({path:`/customer/${s.id}`,query:{type:"lead"}})}catch(s){console.error("Error converting to lead:",s),g.value=s.message||"Failed to convert to lead",y.value=!1}},ee=async()=>{try{y.value=!0;const s=await b.convertToOpportunity(f.value);m.replace({path:`/customer/${s.id}`,query:{type:"opportunity"}})}catch(s){console.error("Error converting to opportunity:",s),g.value=s.message||"Failed to convert to opportunity",y.value=!1}},T=k(!1),A=k("lead"),W=$(()=>{if(!_.value)return{id:null,name:"Unknown",email:"",phone:"",initials:"?"};const s=_.value;if(v.value==="contact")return{id:s.id,name:s.name||"Unknown",email:s.email||"",phone:s.phone||"",initials:s.initials||"?"};const r=s.customer||{};return{id:r.id||s.customerId||s.id,name:r.name||"Unknown",email:r.email||"",phone:r.phone||"",initials:r.initials||"?"}}),z=s=>{console.log("openAddModal called with type:",s,"task:",_.value),A.value=s,T.value=!0,console.log("showAddModal set to:",T.value,"contact:",W.value)},te=async s=>{var d;try{y.value=!0,T.value=!1;const r=v.value==="contact"?f.value:(d=_.value)==null?void 0:d.customerId;if(!r)throw new Error("Customer ID not found");A.value==="lead"?await b.convertToLead(r,s.vehicleData):await b.convertToOpportunity(r,s.vehicleData),await I(r),y.value=!1}catch(r){console.error(`Error adding ${A.value}:`,r),g.value=r.message||`Failed to add ${A.value}`,y.value=!1}};return de(async()=>{v.value==="lead"?await h.loadLeads():v.value==="opportunity"&&await C.loadOpportunities(),await D()}),P(()=>w.params.id,s=>{s&&D()}),P(()=>[w.query.stage,w.query.type],()=>{f.value&&D()}),(s,d)=>(l(),n("div",wt,[y.value?(l(),n("div",Ct,[...d[4]||(d[4]=[t("div",{class:"text-center"},[t("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"}),t("p",{class:"text-gray-500"},"Loading...")],-1)])])):g.value||!_.value?(l(),n("div",kt,[t("div",_t,[d[5]||(d[5]=t("i",{class:"fa-solid fa-exclamation-circle text-6xl text-gray-300 mb-4"},null,-1)),t("p",$t,u(g.value||"Task not found"),1),t("button",{onClick:d[0]||(d[0]=r=>s.$router.push("/customers")),class:"px-4 py-2 text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"}," Back to Customers ")])])):_.value&&_.value.id===f.value?(l(),L(be,{key:2,task:_.value,type:v.value,"management-widget":J.value,"store-adapter":K.value,"add-new-config":X.value,onCarAdded:Y,onConvertToLead:Z,onConvertToOpportunity:ee},{"pinned-extra":H(({task:r})=>[t("div",qt,[N(Ue,{leads:a.value,"all-tasks":o.value,onAddLead:d[1]||(d[1]=O=>z("lead"))},null,8,["leads","all-tasks"]),N(ot,{opportunities:e.value,"all-tasks":o.value,activities:q.value,onAddOpportunity:d[2]||(d[2]=O=>z("opportunity"))},null,8,["opportunities","all-tasks","activities"])]),i.value.length>0?(l(),L(bt,{key:0,cars:i.value},null,8,["cars"])):x("",!0),r.type==="contact"&&r.requestedCar?(l(),L(xe,{key:1,brand:r.requestedCar.brand,model:r.requestedCar.model,year:r.requestedCar.year,image:r.requestedCar.image||"",price:r.requestedCar.price||null,"request-message":r.requestedCar.requestMessage||"","request-type":r.requestedCar.requestType||"",source:r.source||"",dealership:r.requestedCar.dealership||"",registration:r.requestedCar.registration||"",kilometers:r.requestedCar.kilometers||null,"fuel-type":r.requestedCar.fuelType||"","gear-type":r.requestedCar.gearType||"",vin:r.requestedCar.vin||"","stock-days":r.requestedCar.stockDays!==void 0?r.requestedCar.stockDays:null,channel:r.requestedCar.channel||"Email","ad-campaign":r.requestedCar.adCampaign||"","expected-purchase-date":r.requestedCar.expectedPurchaseDate||"","fiscal-entity":r.requestedCar.fiscalEntity||"","source-details":r.requestedCar.sourceDetails||"","ad-medium":r.requestedCar.adMedium||"","ad-source":r.requestedCar.adSource||"",label:"Requested Car"},null,8,["brand","model","year","image","price","request-message","request-type","source","dealership","registration","kilometers","fuel-type","gear-type","vin","stock-days","channel","ad-campaign","expected-purchase-date","fiscal-entity","source-details","ad-medium","ad-source"])):x("",!0)]),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])):x("",!0),_.value?(l(),L(ht,{key:3,show:T.value,type:A.value,contact:W.value,onClose:d[3]||(d[3]=r=>T.value=!1),onSave:te},null,8,["show","type","contact"])):(l(),n("div",Tt,[...d[6]||(d[6]=[t("div",{class:"text-center"},[t("div",{class:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"}),t("p",{class:"text-gray-500"},"Loading...")],-1)])]))]))}};export{Et as default};
