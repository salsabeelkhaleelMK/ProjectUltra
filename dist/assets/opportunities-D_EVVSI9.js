const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D-GV69Dn.js","assets/index-C6dtcYjV.css"])))=>i.map(i=>d[i]);
import{D as H,r as h,c as $,l as Y,ay as G,_ as O,az as S,aA as U,aB as z,M as J,ar as w,aC as K,ax as j,aD as q,aE as Q,aF as X,aG as Z,av as ee,aH as te,aI as ae,aJ as ne,aK as ie}from"./index-D-GV69Dn.js";const oe=H("opportunities",()=>{const u=h([]),s=h(null),g=h([]),o=h(!1),l=h(null),E=$(()=>u.value.filter(n=>n.priority==="Hot"&&n.stage!=="Closed Lost"));Y(s,async(n,t)=>{if(n){if(!t||t.id!==n.id)try{g.value=await w(n.id)}catch(i){console.error("Failed to load opportunity activities:",i),g.value=[]}}else g.value=[]},{immediate:!0});const N=async(n={})=>{o.value=!0,l.value=null;try{const t=await G(n),i=t.data||t,{checkNegotiationSubstatusTransition:a}=await O(async()=>{const{checkNegotiationSubstatusTransition:e}=await import("./index-D-GV69Dn.js").then(c=>c.bG);return{checkNegotiationSubstatusTransition:e}},__vite__mapDeps([0,1]));for(const e of i){const c=a(e);c!==e.negotiationSubstatus&&(e.negotiationSubstatus=c,S(e.id,{negotiationSubstatus:c}).catch(d=>{console.error("Failed to auto-update negotiation substatus:",d)}))}return u.value=i,t}catch(t){throw l.value=t.message,t}finally{o.value=!1}},m=async n=>{o.value=!0,l.value=null;try{const t=await U(n),{checkNegotiationSubstatusTransition:i}=await O(async()=>{const{checkNegotiationSubstatusTransition:c}=await import("./index-D-GV69Dn.js").then(d=>d.bG);return{checkNegotiationSubstatusTransition:c}},__vite__mapDeps([0,1])),a=i(t);a!==t.negotiationSubstatus&&(t.negotiationSubstatus=a,S(n,{negotiationSubstatus:a}).catch(c=>{console.error("Failed to auto-update negotiation substatus:",c)})),s.value=t;const e=u.value.findIndex(c=>c.id===parseInt(n));return e!==-1&&(u.value[e]=t),s.value}catch(t){throw l.value=t.message,t}finally{o.value=!1}},I=async n=>{o.value=!0,l.value=null;try{const t=await z(n);return u.value.push(t),t}catch(t){throw l.value=t.message,t}finally{o.value=!1}},x=async(n,t)=>{var i,a;o.value=!0,l.value=null;try{const e=((i=s.value)==null?void 0:i.id)===n?s.value:u.value.find(f=>f.id===n);if(!t.stage&&(e==null?void 0:e.stage)==="In Negotiation"&&(e!=null&&e.contractDate)){const{getDisplayStage:f}=await O(async()=>{const{getDisplayStage:v}=await import("./index-D-GV69Dn.js").then(r=>r.bH);return{getDisplayStage:v}},__vite__mapDeps([0,1]));if(f(e,"opportunity")==="In Negotiation - Contract Pending"){const v=t.deliveryDate!==void 0?t.deliveryDate:e.deliveryDate,r=t.contractSigned!==void 0?t.contractSigned:t.esignatureCollectedDate!==void 0?!!t.esignatureCollectedDate:e.contractSigned||e.esignatureCollectedDate;v&&r&&(t.stage="Closed Won",t.deliverySubstatus="Awaiting Delivery",t.deliveryDate&&!e.deliveryDateSetDate&&!t.deliveryDateSetDate&&(t.deliveryDateSetDate=new Date().toISOString()),(t.contractSigned||t.esignatureCollectedDate)&&!e.esignatureCollectedDate&&!t.esignatureCollectedDate&&(t.esignatureCollectedDate=new Date().toISOString()))}}if(t.contractDate===null&&(e!=null&&e.contractDate)){const f=e.offerAcceptanceMethod==="auto_via_contract",p=e.offers&&e.offers.some(v=>v.acceptance_method==="auto_via_contract");if(f||p){if(e.offers){const v=e.offers.filter(r=>r.acceptance_method==="auto_via_contract");for(const r of v)r.status="active",r.acceptance_status="pending",r.acceptance_date=null,r.acceptance_method=null,r.accepted_by_user_id=null;t.offers=e.offers}t.negotiationSubstatus="Offer Sent",t.offerAcceptanceDate=null,t.offerAcceptanceMethod=null,t.acceptedByUserId=null}}if(J().getSetting("autoCloseWidgetsOnClose")&&t.stage&&(t.stage==="Closed Won"||t.stage==="Closed Lost")){const f=e==null?void 0:e.stage;if(f&&f!=="Closed Won"&&f!=="Closed Lost"){const v=(await w(n)).filter(r=>{var C,b;return r.type==="nfu-task"||r.type==="ofb-task"||((C=r.action)==null?void 0:C.includes("NFU"))||((b=r.action)==null?void 0:b.includes("OFB"))});for(const r of v)r.completed||await _(n,r.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${t.stage}`})}}const y=await S(n,t),A=u.value.findIndex(f=>f.id===n);if(A!==-1&&(u.value[A]=y),((a=s.value)==null?void 0:a.id)===n&&(s.value=y),y.stage==="Closed Won"&&(e==null?void 0:e.stage)==="In Negotiation"&&(e!=null&&e.contractDate)&&!t.stage){const{getDisplayStage:f}=await O(async()=>{const{getDisplayStage:v}=await import("./index-D-GV69Dn.js").then(r=>r.bH);return{getDisplayStage:v}},__vite__mapDeps([0,1]));f(e,"opportunity")==="In Negotiation - Contract Pending"&&await D(n,{type:"stage-transition",user:"System",action:"auto-transitioned to Closed Won - Awaiting Delivery",content:"Both delivery date and e-signatures completed. Opportunity moved to Closed Won - Awaiting Delivery",data:{fromStage:"In Negotiation - Contract Pending",toStage:"Closed Won - Awaiting Delivery",deliveryDateSetDate:y.deliveryDateSetDate,esignatureCollectedDate:y.esignatureCollectedDate},timestamp:new Date().toISOString()})}return t.contractDate===null&&(e!=null&&e.contractDate)&&e.offerAcceptanceMethod==="auto_via_contract"&&await D(n,{type:"contract-deletion",user:"System",action:"contract deleted",content:"Contract deleted, offer reverted to Offer Sent",data:{wasAutoAccepted:e.offerAcceptanceMethod==="auto_via_contract",previousSubstatus:e.negotiationSubstatus,previousStage:e.stage},timestamp:new Date().toISOString()}),y}catch(e){throw l.value=e.message,e}finally{o.value=!1}},B=async n=>{o.value=!0,l.value=null;try{await K(n),u.value=u.value.filter(t=>t.id!==n)}catch(t){throw l.value=t.message,t}finally{o.value=!1}},D=async(n,t)=>{var i;o.value=!0,l.value=null;try{const a=await j(n,t);return((i=s.value)==null?void 0:i.id)===parseInt(n)&&(g.value=await w(n)),a}catch(a){throw l.value=a.message,a}finally{o.value=!1}},F=async(n,t)=>{var i;o.value=!0,l.value=null;try{const a={id:`offer-${Date.now()}`,createdAt:new Date().toISOString(),vehicleBrand:t.vehicleBrand||"",vehicleModel:t.vehicleModel||"",vehicleYear:t.vehicleYear||"",price:t.price||0,status:"active",data:t.data||{}},e=await q(n,a),c=u.value.find(d=>d.id===n);if(c){c.offers||(c.offers=[]);const d=c.offers.length===0;c.offers.push(e),d&&(c.stage="In Negotiation",c.negotiationSubstatus="Offer Sent",await S(n,{stage:"In Negotiation",negotiationSubstatus:"Offer Sent"}))}if(((i=s.value)==null?void 0:i.id)===n){s.value.offers||(s.value.offers=[]);const d=s.value.offers.length===0;s.value.offers.push(e),d&&(s.value.stage="In Negotiation",s.value.negotiationSubstatus="Offer Sent")}return await D(n,{type:"offer",user:"You",action:"created an offer",content:`Offer created: ${a.vehicleBrand} ${a.vehicleModel} (${a.vehicleYear}) - â‚¬ ${a.price.toLocaleString()}`,data:{offerId:a.id},timestamp:new Date().toISOString()}),e}catch(a){throw l.value=a.message,a}finally{o.value=!1}},T=async(n,t)=>{var i;o.value=!0,l.value=null;try{const a=await Q(n,t),e=u.value.find(c=>c.id===n);return e&&(e.contracts||(e.contracts=[]),e.contracts.push(a),e.contracts.length===1&&(e.contractDate=a.contractDate),e.lastActivity=a.contractDate||new Date().toISOString()),((i=s.value)==null?void 0:i.id)===n&&(s.value.contracts||(s.value.contracts=[]),s.value.contracts.push(a),s.value.contracts.length===1&&(s.value.contractDate=a.contractDate),s.value.lastActivity=a.contractDate||new Date().toISOString()),a}catch(a){throw l.value=a.message,a}finally{o.value=!1}},L=async(n,t)=>{var i;o.value=!0,l.value=null;try{await X(n,t);const a=u.value.find(e=>e.id===n);if(a&&a.offers){const e=a.offers.find(c=>c.id===t);e&&(e.status="archived")}if(((i=s.value)==null?void 0:i.id)===n&&s.value.offers){const e=s.value.offers.find(c=>c.id===t);e&&(e.status="archived")}}catch(a){throw l.value=a.message,a}finally{o.value=!1}},M=async(n,t)=>{var i;o.value=!0,l.value=null;try{await Z(n,t);const a=u.value.find(e=>e.id===n);a&&a.offers&&a.offers.forEach(e=>{e.id===t?e.status="active":e.status==="active"&&e.acceptance_status!=="accepted"&&(e.status="archived")}),((i=s.value)==null?void 0:i.id)===n&&s.value.offers&&s.value.offers.forEach(e=>{e.id===t?e.status="active":e.status==="active"&&e.acceptance_status!=="accepted"&&(e.status="archived")}),await m(n)}catch(a){throw l.value=a.message,a}finally{o.value=!1}},P=async(n,t)=>{var i;o.value=!0,l.value=null;try{await S(n,{negotiationSubstatus:t});const a=u.value.find(e=>e.id===n);a&&(a.negotiationSubstatus=t),((i=s.value)==null?void 0:i.id)===n&&(s.value.negotiationSubstatus=t)}catch(a){throw l.value=a.message,a}finally{o.value=!1}},_=async(n,t,i)=>{var a;o.value=!0,l.value=null;try{const e=await ee(n,t,i);return((a=s.value)==null?void 0:a.id)===parseInt(n)&&(g.value=await w(n)),e}catch(e){throw l.value=e.message,e}finally{o.value=!1}},W=async(n,t)=>{var i;o.value=!0,l.value=null;try{const a=await te(n,t),e=u.value.findIndex(c=>c.id===parseInt(n));return e!==-1&&(u.value[e]=a),((i=s.value)==null?void 0:i.id)===parseInt(n)&&(s.value=a),a}catch(a){throw l.value=a.message,a}finally{o.value=!1}},k=async(n,t)=>{var i;o.value=!0,l.value=null;try{const a=await ae(n,t),e=u.value.findIndex(c=>c.id===parseInt(n));return e!==-1&&(u.value[e]=a.opportunity),((i=s.value)==null?void 0:i.id)===parseInt(n)&&(s.value=a.opportunity),a}catch(a){throw l.value=a.message,a}finally{o.value=!1}},V=async(n,t)=>{var i;o.value=!0,l.value=null;try{return await ne(n,t),((i=s.value)==null?void 0:i.id)===parseInt(n)&&(g.value=await w(n)),{success:!0}}catch(a){throw l.value=a.message,a}finally{o.value=!1}},R=async n=>{o.value=!0,l.value=null;try{await ie(n),await m(n)}catch(t){throw l.value=t.message,t}finally{o.value=!1}};return{opportunities:u,currentOpportunity:s,loading:o,error:l,currentOpportunityActivities:$(()=>g.value),hotOpportunities:E,fetchOpportunities:N,fetchOpportunityById:m,createOpportunity:I,updateOpportunity:x,deleteOpportunity:B,addActivity:D,updateActivity:_,deleteActivity:V,addVehicle:W,createOffer:k,addOffer:F,addContract:T,deleteOffer:L,activateOffer:M,deleteContract:R,updateNegotiationSubstatus:P}});export{oe as u};
