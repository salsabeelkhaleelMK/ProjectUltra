const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-aIgEv3db.js","assets/index-Cq_BQFx0.css"])))=>i.map(i=>d[i]);
import{m,L as p,a1 as d,a0 as l}from"./index-aIgEv3db.js";const u=(t=300)=>new Promise(o=>setTimeout(o,t)),D=async(t={})=>{await u();let o=[...p];if(t.stage&&(o=o.filter(e=>e.stage===t.stage)),t.assignee&&(o=o.filter(e=>e.assignee===t.assignee)),t.search){const e=t.search.toLowerCase();o=o.filter(s=>s.customer.name.toLowerCase().includes(e)||s.vehicle.brand.toLowerCase().includes(e)||s.vehicle.model.toLowerCase().includes(e))}return{data:o,total:o.length}},S=async t=>{await u();const o=p.find(e=>e.id===parseInt(t));if(!o)throw new Error("Opportunity not found");return o},v=async t=>(await u(),d.filter(o=>o.opportunityId===parseInt(t))),C=async t=>{await u();const o={id:p.length+1,...t,createdAt:new Date().toISOString()};return p.push(o),o},k=async(t,o)=>{await u();const e=p.findIndex(s=>s.id===parseInt(t));if(e===-1)throw new Error("Opportunity not found");return p[e]={...p[e],...o},p[e]},T=async t=>{await u();const o=p.findIndex(e=>e.id===parseInt(t));if(o===-1)throw new Error("Opportunity not found");return p.splice(o,1),{success:!0}},E=async(t,o)=>{await u();const e={id:d.length+1,opportunityId:parseInt(t),timestamp:new Date().toISOString(),...o};return d.push(e),e},L=async(t,o,e)=>{await u();const s=d.find(a=>a.id===parseInt(o)&&a.opportunityId===parseInt(t));if(!s)throw new Error("Activity not found");return Object.assign(s,e,{timestamp:new Date().toISOString()}),s},x=async(t,o)=>{await u();const e=d.findIndex(s=>s.id===parseInt(o)&&s.opportunityId===parseInt(t));if(e===-1)throw new Error("Activity not found");return d.splice(e,1),{success:!0}},A=()=>p.length>0?Math.max(...p.map(t=>t.id))+1:1,$=async(t,o)=>{var s;await u();const e={id:A(),customer:t.customer,requestedCar:t.requestedCar,vehicle:{...t.requestedCar},stage:"Qualified",tags:t.tags||[],probability:50,value:((s=t.requestedCar)==null?void 0:s.price)||0,expectedCloseDate:new Date(Date.now()+90*24*60*60*1e3).toISOString().split("T")[0],assignee:t.assignee||"Michael Thomas",source:t.source||"Marketing",fiscalEntity:t.fiscalEntity||"",sourceDetails:t.sourceDetails||"",createdAt:new Date().toISOString(),lastActivity:new Date().toISOString()};p.unshift(e);for(const a of o){const y={id:d.length+1,opportunityId:e.id,leadId:void 0,timestamp:a.timestamp,type:a.type,user:a.user,action:a.action,content:a.content,data:a.data};d.push(y)}return e},g=async t=>{if(await u(),!m.find(r=>r.id===t))return[];const e=[],s=new Date,a=7,y=p.filter(r=>{const n=m.find(i=>i.name===r.assignee);return n&&n.id===t});for(const r of y){if(r.stage!=="Qualified"&&r.stage!=="In Negotiation")continue;const n=new Date(r.lastActivity),i=Math.floor((s-n)/(1e3*60*60*24));i<a||i>14||r.scheduledAppointment&&new Date(r.scheduledAppointment.start)>s||d.some(f=>{if(f.opportunityId!==r.id||f.type!=="offer")return!1;const h=new Date(f.timestamp);return Math.floor((s-h)/(1e3*60*60*24))<a})||e.push({id:`stuck-opportunity-${r.id}`,type:"stuck-opportunity",priority:1,question:`This opportunity with ${r.customer.name} has been inactive for ${i} days. Are they still interested in purchasing?`,customer:r.customer,opportunityId:r.id,opportunity:r,createdAt:r.lastActivity,daysInactive:i})}return e},_=async(t,o)=>{if(await u(),!m.find(n=>n.id===t))return[];const s=[],a=new Date,y=new Date(a);y.setDate(y.getDate()-1),y.setHours(0,0,0,0);const r=p.filter(n=>{const i=m.find(c=>c.name===n.assignee);return i&&i.id===t});for(const n of r){if(!n.scheduledAppointment)continue;const i=new Date(n.scheduledAppointment.start),c=Math.floor((a-i)/(1e3*60*60*24));c>=1&&c<=3&&(d.some(h=>h.opportunityId===n.id&&h.type==="offer")||s.push({id:`appt-followup-${n.id}`,type:"appointment-followup",priority:4,question:`You had an appointment ${c===1?"yesterday":`${c} days ago`} with ${n.customer.name} but no offer is added so far. Did they show up to the appointment?`,customer:n.customer,opportunityId:n.id,opportunity:n,createdAt:n.scheduledAppointment.start,appointmentDate:n.scheduledAppointment.start}))}for(const n of r){if(!n.scheduledAppointment)continue;const i=n.scheduledAppointment;if((i.status==="no-show"||i.noShowCount>0)&&i.nsTaskCreatedAt){const c=new Date(i.nsTaskCreatedAt),f=Math.floor((a-c)/(1e3*60*60*24));f>=1&&f<=2&&(d.some(w=>w.opportunityId!==n.id||!["call","email","sms","whatsapp","communication"].includes(w.type)?!1:new Date(w.timestamp)>=c)||s.push({id:`ns-followup-${n.id}`,type:"ns-followup",priority:3,question:`You had to follow up with ${n.customer.name} on a missed appointment. Did you call them?`,customer:n.customer,opportunityId:n.id,opportunity:n,createdAt:i.nsTaskCreatedAt,nsTaskCreatedAt:i.nsTaskCreatedAt}))}}if(o==="manager"||o==="salesman"){const n=await g(t);s.push(...n)}if(o==="manager"||o==="operator"){const{detectUrgentLeads:n}=await l(async()=>{const{detectUrgentLeads:c}=await import("./index-aIgEv3db.js").then(f=>f.a2);return{detectUrgentLeads:c}},__vite__mapDeps([0,1])),i=await n(t);s.push(...i)}return s.forEach(n=>{n.priority||(n.type==="appointment-followup"?n.priority=4:n.type==="offer-followup"&&(n.priority=5))}),s.sort((n,i)=>{if(n.priority!==i.priority)return n.priority-i.priority;const c=new Date(n.createdAt||n.appointmentDate),f=new Date(i.createdAt||i.appointmentDate);return c-f}),s},M=async(t,o)=>{var a,y;await u();const e=p.find(r=>r.id===parseInt(t));if(!e)throw new Error("Opportunity not found");e.scheduledAppointment&&(e.scheduledAppointment.noShowCount=(e.scheduledAppointment.noShowCount||0)+1,e.scheduledAppointment.nsTaskCreatedAt=new Date().toISOString(),e.scheduledAppointment.status="no-show");const s={id:d.length+1,opportunityId:parseInt(t),type:"ns-task-created",user:((a=m.find(r=>r.id===o))==null?void 0:a.name)||"System",action:"NS task created",content:"No-show task created for missed appointment",timestamp:new Date().toISOString()};return d.push(s),{success:!0,noShowCount:((y=e.scheduledAppointment)==null?void 0:y.noShowCount)||0,activity:s}},N=async(t,o)=>{await u();const e=p.find(a=>a.id===parseInt(t));if(!e)throw new Error("Opportunity not found");const s=m.find(a=>a.id===o);if(!s)throw new Error("User not found");return e.assignee=s.name,e};export{D as a,S as b,M as c,v as d,C as e,_ as f,k as g,T as h,E as i,L as j,x as k,$ as l,N as u};
