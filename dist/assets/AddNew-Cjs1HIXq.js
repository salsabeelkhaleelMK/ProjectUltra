import{r as I,d as C,o as x,s as r,_ as be,c as A,e as l,x as U,g as M,B as c,k as V,y as e,t as T,n as N,F as P,i as j,l as H,h as ne,C as re,D as he,E as xe,m as _e,G as ke}from"./index-Db_3peLd.js";import{_ as we,u as oe}from"./UnifiedAddForm-wanemrH9.js";import{u as ie}from"./opportunities-CySWWyzd.js";import{Q as K,J as R,Y as D,e as Q,t as B,z as ue,G as Z,W as ee,U as te,H as ae,j as se,n as le,A as Se,y as Ce,c as Fe,a as $e,b as Ie,Z as Te,X as J}from"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-BDHqZScF.js";import{_ as qe}from"./PageHeader-DewLlPvW.js";import"./contacts-BPIU2ljN.js";const Ee={__name:"ManualTab",emits:["submit"],setup(f,{expose:m}){const u=I(null);return m({resetSubmitting:()=>{var t;return(t=u.value)==null?void 0:t.resetSubmitting()},submit:()=>{var t;return(t=u.value)==null?void 0:t.submit()},clear:()=>{var t;return(t=u.value)==null?void 0:t.clear()},canSubmit:()=>{var t;return(t=u.value)==null?void 0:t.canSubmit},isSubmitting:()=>{var t;return(t=u.value)==null?void 0:t.isSubmitting}}),(t,p)=>(x(),C("div",null,[r(we,{ref_key:"formRef",ref:u,onSubmit:p[0]||(p[0]=b=>t.$emit("submit",b))},null,512)]))}};function Me(f,m=","){const u=f.split(`
`).filter(b=>b.trim());if(u.length===0)throw new Error("CSV file is empty");const t=u[0].split(m).map(b=>b.trim().replace(/^"|"$/g,"")),p=[];for(let b=1;b<u.length;b++){const k=u[b].split(m).map(o=>o.trim().replace(/^"|"$/g,""));if(k.length!==t.length){const o=u[b],F=new RegExp(`(?:^|${m})(?:"([^"]*)"|([^${m}]*))`,"g"),n=[];let s;for(;(s=F.exec(o))!==null;)n.push(s[1]||s[2]||"");if(n.length===t.length){const y={};t.forEach((d,v)=>{y[d]=n[v]||""}),p.push(y)}else console.warn(`Row ${b+1} has ${k.length} columns, expected ${t.length}. Skipping.`)}else{const o={};t.forEach((F,n)=>{o[F]=k[n]||""}),p.push(o)}}return{headers:t,data:p}}async function Ve(f){const m=await be(()=>import("./xlsx-D_0l8YDs.js"),[]);return new Promise((u,t)=>{const p=new FileReader;p.onload=b=>{try{const k=new Uint8Array(b.target.result),o=m.read(k,{type:"array"}),F=o.SheetNames[0],n=o.Sheets[F],s=m.utils.sheet_to_json(n,{header:1});if(s.length===0){t(new Error("Excel file is empty"));return}const y=s[0].map(v=>String(v||"").trim()),d=[];for(let v=1;v<s.length;v++){const h=s[v],q={};y.forEach((a,i)=>{q[a]=h[i]!==void 0?String(h[i]):""}),d.push(q)}u({headers:y,data:d})}catch(k){t(new Error(`Failed to parse Excel file: ${k.message}`))}},p.onerror=()=>{t(new Error("Failed to read Excel file"))},p.readAsArrayBuffer(f)})}async function De(f){const m=f.name.toLowerCase();if(m.endsWith(".csv")){const u=await f.text();return Me(u)}else{if(m.endsWith(".xls")||m.endsWith(".xlsx"))return await Ve(f);throw new Error("Unsupported file format. Please upload a CSV or Excel file (.csv, .xls, .xlsx)")}}function Oe(){const f=I(null),m=I(null),u=I([]),t=I(!1),p=I(null),b=n=>{const s=[".csv",".xls",".xlsx"],y=n.name.toLowerCase();if(!s.some(h=>y.endsWith(h)))throw new Error("Invalid file type. Please upload a CSV or Excel file (.csv, .xls, .xlsx)");const v=10*1024*1024;if(n.size>v)throw new Error("File size exceeds 10MB limit");return!0};return{selectedFile:f,parsedData:m,headers:u,loading:t,error:p,handleFileSelect:async n=>{try{p.value=null,t.value=!0,b(n);const s=await De(n);if(f.value=n,m.value=s.data,u.value=s.headers,!s.data||s.data.length===0)throw new Error("File contains no data rows");if(!s.headers||s.headers.length===0)throw new Error("File contains no header row");return{file:n,headers:s.headers,data:s.data,rowCount:s.data.length}}catch(s){throw p.value=s.message,f.value=null,m.value=null,u.value=[],s}finally{t.value=!1}},clearFile:()=>{f.value=null,m.value=null,u.value=[],p.value=null},getPreview:(n=5)=>m.value?m.value.slice(0,n):[]}}const Re={class:"space-y-4"},Ue={class:"relative"},Pe=["disabled"],je={class:"text-heading text-fluid-xs font-bold mb-1"},Ae={class:"text-fluid-xs text-red-700"},Ne={class:"flex items-center justify-between"},ze={class:"overflow-x-auto"},He={class:"w-full text-fluid-xs"},Le={class:"border-b border-border"},Ke={key:0,class:"text-sub text-fluid-xs mt-3 text-center"},Y=5,Be={__name:"FileUploadForm",props:{modelValue:{type:File,default:null},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","file-parsed"],setup(f,{expose:m,emit:u}){const t=u,p=I(null),{selectedFile:b,parsedData:k,headers:o,loading:F,error:n,handleFileSelect:s,clearFile:y,getPreview:d}=Oe(),v=A(()=>d(Y)),h=async q=>{var i;const a=(i=q.target.files)==null?void 0:i[0];if(a)try{const w=await s(a);t("update:modelValue",a),t("file-parsed",w)}catch{t("update:modelValue",null)}};return m({clearFile:y,selectedFile:b,parsedData:k,headers:o}),(q,a)=>(x(),C("div",Re,[l("div",null,[r(e(K),{class:"block text-sm font-medium text-body mb-1.5"},{default:c(()=>[...a[1]||(a[1]=[V(" Select File ",-1),l("span",{class:"text-brand-red"},"*",-1)])]),_:1}),l("div",Ue,[l("input",{ref_key:"fileInputRef",ref:p,type:"file",accept:".csv,.xls,.xlsx",onChange:h,class:"hidden",disabled:e(F)},null,40,Pe),r(e(D),{onClick:a[0]||(a[0]=i=>{var w;return(w=p.value)==null?void 0:w.click()}),class:N(["border-2 border-dashed cursor-pointer transition-all hover:border-primary/50",{"opacity-50 cursor-not-allowed":e(F),"border-border":!e(F)}])},{default:c(()=>[r(e(R),{class:"text-center py-6"},{default:c(()=>[a[2]||(a[2]=l("i",{class:"fa-solid fa-cloud-arrow-up text-4xl text-sub mb-3"},null,-1)),l("p",je,T(e(b)?e(b).name:"Click to upload or drag and drop"),1),a[3]||(a[3]=l("p",{class:"text-sub text-fluid-xs"},"CSV or Excel (.csv, .xls, .xlsx) up to 10MB",-1))]),_:1})]),_:1},8,["class"])]),e(n)?(x(),U(e(D),{key:0,class:"bg-red-50 border-red-200 mt-2"},{default:c(()=>[r(e(R),{class:"flex items-start gap-2"},{default:c(()=>[a[4]||(a[4]=l("i",{class:"fa-solid fa-exclamation-circle text-red-600 mt-0.5 text-sm"},null,-1)),l("span",Ae,T(e(n)),1)]),_:1})]),_:1})):M("",!0)]),e(b)&&e(k)&&e(k).length>0?(x(),U(e(D),{key:0,class:"border-border"},{default:c(()=>[r(e(Q),null,{default:c(()=>[l("div",Ne,[r(e(B),null,{default:c(()=>[...a[5]||(a[5]=[V("File Preview",-1)])]),_:1}),r(e(ue),{text:`${e(k).length} rows`,theme:"gray",size:"small"},null,8,["text"])])]),_:1}),r(e(R),null,{default:c(()=>[l("div",ze,[l("table",He,[l("thead",null,[l("tr",Le,[(x(!0),C(P,null,j(e(o),i=>(x(),C("th",{key:i,class:"text-left p-2 font-bold text-sub uppercase tracking-wider"},T(i),1))),128))])]),l("tbody",null,[(x(!0),C(P,null,j(v.value,(i,w)=>(x(),C("tr",{key:w,class:"border-b border-border hover:bg-surfaceSecondary transition-colors"},[(x(!0),C(P,null,j(e(o),O=>(x(),C("td",{key:O,class:"p-2 text-body"},T(i[O]||"-"),1))),128))]))),128))])])]),e(k).length>Y?(x(),C("p",Ke," Showing first "+T(Y)+" of "+T(e(k).length)+" rows ",1)):M("",!0)]),_:1})]),_:1})):M("",!0)]))}},We={contacts:{required:["name","email"],optional:["phone","company","address"]},leads:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays"]},opportunities:{required:["name","email"],optional:["phone","company","address","source","brand","model","year","price","requestMessage","requestType","dealership","channel","fuelType","gearType","kilometers","stockDays","stage","priority"]}};function G(f){return We[f]||{required:[],optional:[]}}function Je(f,m=[]){const u=I({}),t=I({}),p=A(()=>{const d=G(f.value);return{required:d.required||[],optional:d.optional||[]}}),b=()=>{const d=p.value,v=[...d.required,...d.optional];u.value={},v.forEach(h=>{u.value[h]=""})},k=(d,v)=>{u.value[d]=v||"",o()},o=()=>{t.value={},p.value.required.forEach(v=>{(!u.value[v]||u.value[v].trim()==="")&&(t.value[v]="This field is required")})},F=A(()=>(o(),Object.keys(t.value).length===0)),n=d=>{const v={},h=p.value;return[...h.required,...h.optional].forEach(a=>{const i=u.value[a];if(i&&d[i]!==void 0){const w=d[i];a==="year"||a==="price"||a==="kilometers"||a==="stockDays"?v[a]=w?Number(w):null:v[a]=w?String(w).trim():""}}),v},s=d=>d.map((v,h)=>{try{return n(v)}catch(q){return console.error(`Error transforming row ${h+1}:`,q),null}}).filter(v=>v!==null),y=()=>{const d=Object.entries(u.value).filter(([v,h])=>h&&h.trim()!=="").map(([v,h])=>({field:v,fileColumn:h}));return{totalFields:p.value.required.length+p.value.optional.length,mappedFields:d.length,requiredMapped:p.value.required.filter(v=>u.value[v]).length,requiredTotal:p.value.required.length}};return m.length>0&&b(),{mapping:u,errors:t,availableFields:p,isValid:F,setMapping:k,validateMapping:o,transformRow:n,transformData:s,getMappingSummary:y,initializeMapping:b}}const Ye={class:"space-y-4"},Ge={class:"text-sub text-fluid-xs"},Qe={key:0},Xe={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Ze={key:0,class:"text-brand-red text-fluid-xs mt-1"},et={key:1},tt={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},at={class:"flex items-center justify-between"},st={class:"text-heading font-bold text-sm"},lt={__name:"ColumnMappingForm",props:{entityType:{type:String,required:!0,validator:f=>["contacts","leads","opportunities"].includes(f)},fileColumns:{type:Array,default:()=>[]},mapping:{type:Object,required:!0}},emits:["update:mapping"],setup(f,{expose:m,emit:u}){const t=f,p=u,{availableFields:b,errors:k,isValid:o,setMapping:F,validateMapping:n,getMappingSummary:s,initializeMapping:y}=Je(A(()=>t.entityType),t.fileColumns);H([()=>t.fileColumns,()=>t.entityType],([q,a])=>{if(q&&q.length>0&&a&&Object.keys(t.mapping).length===0){y();const i=b.value,w=[...i.required,...i.optional],O={};w.forEach(W=>{O[W]=""}),p("update:mapping",O)}},{immediate:!0});const d=A(()=>s()),v=(q,a)=>{F(q,a),p("update:mapping",{...t.mapping,[q]:a})},h=q=>q.replace(/([A-Z])/g," $1").replace(/^./,a=>a.toUpperCase()).trim();return m({isValid:o,validateMapping:n}),(q,a)=>(x(),C("div",Ye,[r(e(D),{class:"border-border"},{default:c(()=>[r(e(Q),null,{default:c(()=>[r(e(B),null,{default:c(()=>[...a[0]||(a[0]=[V("Map Columns",-1)])]),_:1})]),_:1}),r(e(R),{class:"space-y-4"},{default:c(()=>[l("p",Ge,[V(" Map file columns to "+T(f.entityType)+" fields. ",1),a[1]||(a[1]=l("span",{class:"text-brand-red"},"*",-1)),a[2]||(a[2]=V(" Required. ",-1))]),e(b).required.length>0?(x(),C("div",Qe,[a[4]||(a[4]=l("h4",{class:"text-fluid-xs font-bold uppercase text-sub tracking-wider mb-3"},"Required Fields",-1)),l("div",Xe,[(x(!0),C(P,null,j(e(b).required,i=>(x(),C("div",{key:i},[r(e(K),{class:"block text-sm font-medium text-body mb-1.5"},{default:c(()=>[V(T(h(i))+" ",1),a[3]||(a[3]=l("span",{class:"text-brand-red"},"*",-1))]),_:2},1024),r(e(Z),{"model-value":f.mapping[i]||"","onUpdate:modelValue":w=>v(i,w)},{default:c(()=>[r(e(ee),{class:N({"border-brand-red":e(k)[i]})},{default:c(()=>[r(e(te),{placeholder:"-- Select column --"})]),_:1},8,["class"]),r(e(ae),null,{default:c(()=>[(x(!0),C(P,null,j(f.fileColumns,w=>(x(),U(e(se),{key:w,value:w},{default:c(()=>[V(T(w),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue"]),e(k)[i]?(x(),C("p",Ze,T(e(k)[i]),1)):M("",!0)]))),128))])])):M("",!0),e(b).optional.length>0?(x(),C("div",et,[a[5]||(a[5]=l("h4",{class:"text-fluid-xs font-bold uppercase text-sub tracking-wider mb-3"},"Optional Fields",-1)),l("div",tt,[(x(!0),C(P,null,j(e(b).optional,i=>(x(),C("div",{key:i},[r(e(K),{class:"block text-sm font-medium text-body mb-1.5"},{default:c(()=>[V(T(h(i)),1)]),_:2},1024),r(e(Z),{"model-value":f.mapping[i]||"","onUpdate:modelValue":w=>v(i,w)},{default:c(()=>[r(e(ee),null,{default:c(()=>[r(e(te),{placeholder:"-- Select column --"})]),_:1}),r(e(ae),null,{default:c(()=>[(x(!0),C(P,null,j(f.fileColumns,w=>(x(),U(e(se),{key:w,value:w},{default:c(()=>[V(T(w),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["model-value","onUpdate:modelValue"])]))),128))])])):M("",!0),d.value?(x(),U(e(D),{key:2,class:"bg-surfaceSecondary border-border"},{default:c(()=>[r(e(R),null,{default:c(()=>[l("div",at,[l("div",null,[a[6]||(a[6]=l("p",{class:"text-sub text-fluid-xs font-semibold uppercase tracking-wider mb-1"},"Mapping Progress",-1)),l("p",st,T(d.value.mappedFields)+" / "+T(d.value.totalFields)+" fields mapped ",1)]),r(e(ue),{text:`${d.value.requiredMapped}/${d.value.requiredTotal} required`,theme:d.value.requiredMapped===d.value.requiredTotal?"green":"red",size:"small"},null,8,["text","theme"])])]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})]))}},nt={class:"w-full space-y-4"},rt={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},ot={class:"flex items-center gap-2 mb-1"},it={class:"font-bold text-heading text-fluid-xs"},ut={class:"text-sub text-fluid-xs"},dt={key:0},ct={key:1},pt={key:2,class:"flex items-center justify-end gap-3 pt-4 border-t border-border"},mt={key:0},ft={key:1},gt={class:"flex items-center justify-between"},yt={class:"text-sub text-fluid-xs"},vt={class:"text-fluid-xs text-orange-700"},bt={class:"text-body text-fluid-xs"},ht={key:0,class:"text-orange-700 font-semibold"},xt={__name:"UploadTab",setup(f){const m=ne(),u=oe(),t=re(),p=ie(),b=I(null),k=I(null),o=I(null),F=I(null),n=I(null),s=I([]),y=I({}),d=I(!1),v=I(0),h=I(0),q=I(0),a=I([]),i=I(!1),w=[{value:"contacts",label:"Contacts",description:"Import customer contacts",icon:"fa-solid fa-users"},{value:"leads",label:"Leads",description:"Import lead records",icon:"fa-solid fa-user-plus"},{value:"opportunities",label:"Opportunities",description:"Import opportunity records",icon:"fa-solid fa-briefcase"}],O=g=>{const S={},_=G(o.value);return[..._.required,..._.optional].forEach(E=>{const z=y.value[E];if(z&&g[z]!==void 0){const L=g[z];E==="year"||E==="price"||E==="kilometers"||E==="stockDays"?S[E]=L?Number(L):null:S[E]=L?String(L).trim():""}}),S},W=g=>g.map(S=>{try{return O(S)}catch(_){return console.error("Error transforming row:",_),null}}).filter(S=>S!==null),pe=A(()=>o.value?(G(o.value).required||[]).every(_=>{const $=y.value[_];return $&&$.trim()!==""}):!1),X=A(()=>o.value&&n.value&&n.value.length>0&&pe.value),me=A(()=>h.value===0?0:Math.round(v.value/h.value*100)),fe=g=>{n.value=g.data,s.value=g.headers,y.value={},i.value=!1,a.value=[]},ge=()=>{var g;o.value=null,F.value=null,n.value=null,s.value=[],y.value={},(g=b.value)==null||g.clearFile(),i.value=!1,a.value=[]},ye=async()=>{if(X.value){d.value=!0,v.value=0,q.value=0,a.value=[],i.value=!1,h.value=n.value.length;try{const g=W(n.value),S=10;for(let _=0;_<g.length;_+=S){const $=g.slice(_,_+S);for(const E of $){try{await ve(E),q.value++}catch(z){a.value.push({row:_+$.indexOf(E)+1,error:z.message})}v.value++}}i.value=!0,setTimeout(()=>{const _=o.value==="contacts"?"contacts":o.value==="leads"?"open-leads":"open-opportunities";m.push({path:"/customers",query:{tab:_}})},2e3)}catch(g){console.error("Import error:",g),a.value.push({row:"all",error:g.message})}finally{d.value=!1}}},ve=async g=>{const S={name:g.name||"",email:g.email||"",phone:g.phone||"",company:g.company||null,address:g.address||"",initials:(g.name||"").split(" ").map(E=>E[0]).join("").toUpperCase()||"??",source:g.source||"Import",tags:[]},_=await u.addCustomer(S);if(o.value==="contacts")return;const $={};if((g.brand||g.model||g.year||g.price)&&($.brand=g.brand||"",$.model=g.model||"",$.year=g.year||null,$.price=g.price||null,$.requestMessage=g.requestMessage||"",$.requestType=g.requestType||"",$.source=g.source||"Import",$.dealership=g.dealership||"",$.channel=g.channel||"Email",$.fuelType=g.fuelType||"",$.gearType=g.gearType||"",$.kilometers=g.kilometers||null,$.stockDays=g.stockDays||null),o.value==="leads"){const E={customer:{id:_.id,name:_.name,initials:_.initials,email:_.email,phone:_.phone,address:_.address||""},status:"Open",stage:"Open Lead",priority:g.priority||"Normal",source:$.source||"Import",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};Object.keys($).length>0&&(E.requestedCar=$),await t.createLead(E)}else if(o.value==="opportunities"){const E={customer:{id:_.id,name:_.name,initials:_.initials,email:_.email,phone:_.phone,address:_.address||""},stage:g.stage||"Qualified",priority:g.priority||"Normal",source:$.source||"Import",assignee:null,assigneeInitials:""};Object.keys($).length>0&&(E.vehicle=$),await p.createOpportunity(E)}};return(g,S)=>(x(),C("div",nt,[r(e(D),{class:"border-border"},{default:c(()=>[r(e(Q),null,{default:c(()=>[r(e(B),null,{default:c(()=>[...S[2]||(S[2]=[V("Select Entity Type",-1)])]),_:1})]),_:1}),r(e(R),{class:"space-y-3"},{default:c(()=>[S[4]||(S[4]=l("p",{class:"text-sub text-fluid-xs"}," Choose what type of data you want to import. ",-1)),l("div",rt,[(x(),C(P,null,j(w,_=>r(e(D),{key:_.value,onClick:$=>o.value=_.value,class:N(["cursor-pointer transition-all",o.value===_.value?"border-2 border-primary bg-surfaceSecondary":"border-border hover:border-primary/30"])},{default:c(()=>[r(e(R),null,{default:c(()=>[l("div",ot,[l("i",{class:N([_.icon,"text-lg",o.value===_.value?"text-primary":"text-sub"])},null,2),l("span",it,T(_.label),1)]),l("p",ut,T(_.description),1)]),_:2},1024)]),_:2},1032,["onClick","class"])),64))]),o.value?M("",!0):(x(),U(e(D),{key:0,class:"bg-orange-50 border-orange-200"},{default:c(()=>[r(e(R),{class:"flex items-start gap-2"},{default:c(()=>[...S[3]||(S[3]=[l("i",{class:"fa-solid fa-info-circle text-orange-600 mt-0.5 text-sm"},null,-1),l("span",{class:"text-fluid-xs text-orange-700"},"Please select an entity type to continue",-1)])]),_:1})]),_:1}))]),_:1})]),_:1}),o.value?(x(),C("div",dt,[r(Be,{ref_key:"fileUploadRef",ref:b,modelValue:F.value,"onUpdate:modelValue":S[0]||(S[0]=_=>F.value=_),onFileParsed:fe},null,8,["modelValue"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),C("div",ct,[r(lt,{ref_key:"mappingFormRef",ref:k,"entity-type":o.value,"file-columns":s.value,mapping:y.value,"onUpdate:mapping":S[1]||(S[1]=_=>y.value=_)},null,8,["entity-type","file-columns","mapping"])])):M("",!0),o.value&&n.value&&n.value.length>0?(x(),C("div",pt,[r(e(le),{variant:"outline",size:"small",onClick:ge,disabled:d.value},{default:c(()=>[...S[5]||(S[5]=[V(" Cancel ",-1)])]),_:1},8,["disabled"]),r(e(le),{variant:"primary",size:"small",onClick:ye,disabled:!X.value||d.value},{default:c(()=>[d.value?(x(),C("span",mt,"Importing...")):(x(),C("span",ft,"Import "+T(n.value.length)+" "+T(o.value),1))]),_:1},8,["disabled"])])):M("",!0),d.value?(x(),U(e(D),{key:3,class:"border-border"},{default:c(()=>[r(e(R),{class:"space-y-3"},{default:c(()=>[l("div",gt,[S[6]||(S[6]=l("span",{class:"text-heading text-fluid-xs font-bold"},"Importing...",-1)),l("span",yt,T(v.value)+" / "+T(h.value),1)]),r(e(Se),{value:me.value,class:"h-1.5"},null,8,["value"]),a.value.length>0?(x(),U(e(D),{key:0,class:"bg-orange-50 border-orange-200"},{default:c(()=>[r(e(R),{class:"flex items-start gap-2"},{default:c(()=>[S[7]||(S[7]=l("i",{class:"fa-solid fa-exclamation-triangle text-orange-600 mt-0.5 text-sm"},null,-1)),l("span",vt,T(a.value.length)+" errors encountered ",1)]),_:1})]),_:1})):M("",!0)]),_:1})]),_:1})):M("",!0),i.value?(x(),U(e(D),{key:4,class:"bg-green-50 border-green-200"},{default:c(()=>[r(e(R),{class:"space-y-2"},{default:c(()=>[S[8]||(S[8]=l("div",{class:"flex items-center gap-2"},[l("i",{class:"fa-solid fa-check-circle text-green-600 text-base"}),l("span",{class:"font-bold text-heading text-fluid-xs"},"Import Successful")],-1)),l("p",bt,[V(" Successfully imported "+T(q.value)+" "+T(o.value)+". ",1),a.value.length>0?(x(),C("span",ht,T(a.value.length)+" rows had errors. ",1)):M("",!0)])]),_:1})]),_:1})):M("",!0)]))}},de="project-ultra-integrations";function _t(){try{const f=localStorage.getItem(de);return f?JSON.parse(f):[]}catch(f){return console.error("Failed to read integrations from localStorage:",f),[]}}function kt(f){try{localStorage.setItem(de,JSON.stringify(f))}catch(m){console.error("Failed to save integrations to localStorage:",m)}}const ce=he("integrations",()=>{const f=[{id:"api",name:"API Integration",type:"api",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:"",webhookUrl:""},lastSync:null,syncHistory:[]},{id:"email",name:"Email Parsing",type:"email",enabled:!1,connected:!1,entityType:null,config:{emailAddress:"",imapServer:"",imapPort:"",username:"",password:""},lastSync:null,syncHistory:[]},{id:"portal",name:"Portal Integration",type:"portal",enabled:!1,connected:!1,entityType:null,config:{portalUrl:"",apiKey:"",username:""},lastSync:null,syncHistory:[]},{id:"zapier",name:"Zapier",type:"zapier",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:""},lastSync:null,syncHistory:[]},{id:"meta",name:"Meta (Facebook/Instagram)",type:"meta",enabled:!1,connected:!1,entityType:null,config:{appId:"",appSecret:"",accessToken:""},lastSync:null,syncHistory:[]},{id:"woice",name:"WOICE",type:"woice",enabled:!1,connected:!1,entityType:null,config:{apiKey:"",endpoint:""},lastSync:null,syncHistory:[]},{id:"webhook",name:"Custom Webhook",type:"webhook",enabled:!1,connected:!1,entityType:null,config:{webhookUrl:"",secret:""},lastSync:null,syncHistory:[]}],m=_t(),u=I(m.length>0?m:f);H(u,n=>{kt(n)},{deep:!0});const t=n=>u.value.find(s=>s.id===n);return{integrations:u,getIntegration:t,toggleIntegration:n=>{const s=t(n);s&&(s.enabled=!s.enabled,s.enabled||(s.connected=!1))},updateConfig:(n,s)=>{const y=t(n);y&&(y.config={...y.config,...s})},setEntityType:(n,s)=>{const y=t(n);if(y){if(!["contacts","leads","opportunities"].includes(s))throw new Error("Invalid entity type. Must be contacts, leads, or opportunities");y.entityType=s}},testConnection:async n=>{const s=t(n);return s?new Promise(y=>{setTimeout(()=>{s.connected=!0,y(!0)},1e3)}):!1},addSyncHistory:(n,s)=>{const y=t(n);if(!y)return;const d={timestamp:new Date().toISOString(),entityType:y.entityType,recordsImported:s.recordsImported||0,errors:s.errors||[],conflicts:s.conflicts||[]};y.syncHistory.unshift(d),y.lastSync=d.timestamp,y.syncHistory.length>50&&(y.syncHistory=y.syncHistory.slice(0,50))}}}),wt={class:"p-4 flex flex-col gap-4"},St={class:"flex items-center justify-between gap-3"},Ct={class:"flex items-center gap-3 min-w-0"},Ft={class:"w-10 h-10 rounded-lg bg-surfaceSecondary flex items-center justify-center border border-border shrink-0 group-hover:border-brand-dark/30 transition-colors"},$t={class:"min-w-0"},It={class:"space-y-1.5"},Tt={__name:"IntegrationCard",props:{integration:{type:Object,required:!0}},setup(f){var k;const m=f,u=ce(),t=I(((k=m.integration.config)==null?void 0:k.apiKey)||"");H(()=>{var o;return(o=m.integration.config)==null?void 0:o.apiKey},o=>{t.value=o||""});const p=()=>{var o;t.value!==(((o=m.integration.config)==null?void 0:o.apiKey)||"")&&u.updateConfig(m.integration.id,{apiKey:t.value})},b=()=>{u.toggleIntegration(m.integration.id)};return(o,F)=>(x(),U(e(D),{class:"rounded-xl border-border hover:shadow-mk-dashboard-card transition-all group overflow-hidden bg-surface"},{default:c(()=>[l("div",wt,[l("div",St,[l("div",Ct,[l("div",Ft,[l("i",{class:N([f.integration.icon,"text-lg text-primary"])},null,2)]),l("div",$t,[F[1]||(F[1]=l("span",{class:"text-fluid-xs font-bold uppercase tracking-tighter text-sub block mb-0.5"},"Platform",-1)),r(e(B),{class:"text-heading text-sm font-bold truncate leading-tight"},{default:c(()=>[V(T(f.integration.name),1)]),_:1})])]),r(e(Ce),{checked:f.integration.enabled,"onUpdate:checked":b,size:"small"},null,8,["checked"])]),l("div",It,[r(e(K),{class:"text-fluid-xs font-bold uppercase tracking-tighter text-sub"},{default:c(()=>[...F[2]||(F[2]=[V("API Key",-1)])]),_:1}),r(e(Fe),{modelValue:t.value,"onUpdate:modelValue":F[0]||(F[0]=n=>t.value=n),type:"password",placeholder:"Enter API Key",class:"h-9 text-sm focus-visible:ring-brand-dark",onBlur:p,onKeyup:xe(p,["enter"])},null,8,["modelValue"])])])]),_:1}))}},qt={class:"w-full"},Et={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"},Mt={__name:"IntegrationsTab",setup(f){const m=ce(),u=A(()=>m.integrations.map(p=>({...p,icon:t(p.type)}))),t=p=>({api:"fa-solid fa-code",email:"fa-solid fa-envelope",portal:"fa-solid fa-globe",zapier:"fa-brands fa-zapier",meta:"fa-brands fa-meta",woice:"fa-solid fa-microphone",webhook:"fa-solid fa-link"})[p]||"fa-solid fa-plug";return(p,b)=>(x(),C("div",qt,[l("div",Et,[(x(!0),C(P,null,j(u.value,k=>(x(),U(Tt,{key:k.id,integration:k},null,8,["integration"]))),128))])]))}};function Vt(f,m="manual"){const t=I((()=>{try{return localStorage.getItem(f)||m}catch(p){return console.error("Failed to read tab from localStorage:",p),m}})());return H(t,p=>{try{localStorage.setItem(f,p)}catch(b){console.error("Failed to save tab to localStorage:",b)}}),{activeTab:t}}const Dt={class:"page-container"},Ot={class:"px-4 md:px-8 py-4"},Rt={class:"max-w-6xl mx-auto"},Ut={class:"hidden md:inline whitespace-nowrap"},Lt={__name:"AddNew",setup(f){const m=ne(),u=oe(),t=re(),p=ie(),b=I(null),{activeTab:k}=Vt("add-new-active-tab","manual");_e(()=>{(!k.value||!["manual","upload","integrations"].includes(k.value))&&(k.value="manual")}),H(k,s=>{});const o=[{key:"manual",label:"Manual"},{key:"upload",label:"Upload"},{key:"integrations",label:"Integrations"}],F=s=>({manual:"fa-solid fa-pen",upload:"fa-solid fa-upload",integrations:"fa-solid fa-plug"})[s]||"fa-solid fa-circle",n=async s=>{try{const{contactMode:y,selectedContact:d,contactData:v,vehicleData:h,markAsLead:q,markAsOpportunity:a}=s;let i=d;if(y==="new"&&(i=await u.addCustomer({...v,initials:v.name.split(" ").map(w=>w[0]).join("").toUpperCase(),source:"Direct",tags:[],company:v.company||null})),q){const w={customer:{id:i.id,name:i.name,initials:i.initials,email:i.email,phone:i.phone,address:i.address||""},status:"Open",stage:"Open Lead",priority:"Normal",source:(h==null?void 0:h.source)||"Direct",assignee:null,assigneeInitials:"",isDisqualified:!1,disqualifyReason:null,scheduledAppointment:null,contactAttempts:[]};h&&Object.keys(h).length>0&&(w.requestedCar=h);const O=await t.createLead(w);m.push({path:"/customers",query:{tab:"open-leads",highlight:`lead-${O.id}`}})}else if(a){const w={customer:{id:i.id,name:i.name,initials:i.initials,email:i.email,phone:i.phone,address:i.address||""},stage:"Qualified",priority:"Normal",source:(h==null?void 0:h.source)||"Direct",assignee:null,assigneeInitials:""};h&&Object.keys(h).length>0&&(w.vehicle=h);const O=await p.createOpportunity(w);m.push({path:"/customers",query:{tab:"open-opportunities",highlight:`opp-${O.id}`}})}else h&&Object.keys(h).length>0&&await u.addRequestedCar(i.id,h),m.push({path:"/customers",query:{tab:"contacts",highlight:`contact-${i.id}`}})}catch(y){console.error("Error saving data:",y),alert("Failed to save. Please try again."),b.value&&b.value.resetSubmitting()}};return(s,y)=>(x(),C("div",Dt,[r(qe,{title:"Add New Customer"}),l("div",Ot,[l("div",Rt,[r(e($e),{modelValue:e(k),"onUpdate:modelValue":y[0]||(y[0]=d=>ke(k)?k.value=d:null)},{default:c(()=>[r(e(Ie),{class:"w-full justify-start border-b border-border bg-transparent mb-6"},{default:c(()=>[(x(),C(P,null,j(o,d=>r(e(Te),{key:d.key,value:d.key,class:"flex items-center gap-1.5 data-[state=active]:border-b-2 data-[state=active]:border-brand-dark data-[state=active]:text-brand-darkDarker rounded-none pb-2"},{default:c(()=>[l("i",{class:N([F(d.key),"text-sm"])},null,2),l("span",Ut,T(d.label),1)]),_:2},1032,["value"])),64))]),_:1}),r(e(J),{value:"manual"},{default:c(()=>[r(Ee,{ref_key:"manualTabRef",ref:b,onSubmit:n},null,512)]),_:1}),r(e(J),{value:"upload"},{default:c(()=>[r(xt)]),_:1}),r(e(J),{value:"integrations"},{default:c(()=>[r(Mt)]),_:1})]),_:1},8,["modelValue"])])])]))}};export{Lt as default};
