import{a7 as V,r as f,c as A,l as j,ah as q,ai as D,aj as E,a1 as y,ak as H,al as N,am as R,an as T,ao as U,ap as z,aq as G}from"./index-BxN3PUVT.js";import{u as J}from"./settings-DEo_6Gys.js";const Q=V("opportunities",()=>{const n=f([]),r=f(null),o=f([]),l=f(!1),u=f(null),S=A(()=>n.value.filter(e=>e.priority==="Hot"&&e.stage!=="Closed Lost"));j(r,async e=>{if(e)try{o.value=await y(e.id)}catch(t){console.error("Failed to load opportunity activities:",t),o.value=[]}else o.value=[]},{immediate:!0});const x=async(e={})=>{l.value=!0,u.value=null;try{const t=await q(e);return n.value=t.data||t,t}catch(t){throw u.value=t.message,t}finally{l.value=!1}},C=async e=>{l.value=!0,u.value=null;try{const t=await D(e);r.value=t;const s=n.value.findIndex(a=>a.id===parseInt(e));return s!==-1&&(n.value[s]=t),r.value}catch(t){throw u.value=t.message,t}finally{l.value=!1}},I=async e=>{l.value=!0,u.value=null;try{const t=await E(e);return n.value.push(t),t}catch(t){throw u.value=t.message,t}finally{l.value=!1}},$=async(e,t)=>{var s,a;l.value=!0,u.value=null;try{const p=J().getSetting("autoCloseWidgetsOnClose"),d=((s=r.value)==null?void 0:s.id)===e?r.value:n.value.find(c=>c.id===e);if(p&&t.stage&&(t.stage==="Closed Won"||t.stage==="Closed Lost")){const c=d==null?void 0:d.stage;if(c&&c!=="Closed Won"&&c!=="Closed Lost"){const W=(await y(e)).filter(v=>{var g,m;return v.type==="nfu-task"||v.type==="ofb-task"||((g=v.action)==null?void 0:g.includes("NFU"))||((m=v.action)==null?void 0:m.includes("OFB"))});for(const v of W)v.completed||await O(e,v.id,{completed:!0,completedAt:new Date().toISOString(),completionReason:`Opportunity closed as ${t.stage}`})}}const h=await H(e,t),w=n.value.findIndex(c=>c.id===e);return w!==-1&&(n.value[w]=h),((a=r.value)==null?void 0:a.id)===e&&(r.value=h),h}catch(i){throw u.value=i.message,i}finally{l.value=!1}},B=async e=>{l.value=!0,u.value=null;try{await N(e),n.value=n.value.filter(t=>t.id!==e)}catch(t){throw u.value=t.message,t}finally{l.value=!1}},F=async(e,t)=>{var s;l.value=!0,u.value=null;try{const a=await R(e,t);return((s=r.value)==null?void 0:s.id)===parseInt(e)&&(o.value=await y(e)),a}catch(a){throw u.value=a.message,a}finally{l.value=!1}},O=async(e,t,s)=>{var a;l.value=!0,u.value=null;try{const i=await T(e,t,s);return((a=r.value)==null?void 0:a.id)===parseInt(e)&&(o.value=await y(e)),i}catch(i){throw u.value=i.message,i}finally{l.value=!1}},b=async(e,t)=>{var s;l.value=!0,u.value=null;try{const a=await U(e,t),i=n.value.findIndex(p=>p.id===parseInt(e));return i!==-1&&(n.value[i]=a),((s=r.value)==null?void 0:s.id)===parseInt(e)&&(r.value=a),a}catch(a){throw u.value=a.message,a}finally{l.value=!1}},k=async(e,t)=>{var s;l.value=!0,u.value=null;try{const a=await z(e,t),i=n.value.findIndex(p=>p.id===parseInt(e));return i!==-1&&(n.value[i]=a.opportunity),((s=r.value)==null?void 0:s.id)===parseInt(e)&&(r.value=a.opportunity),a}catch(a){throw u.value=a.message,a}finally{l.value=!1}},L=async(e,t)=>{var s;l.value=!0,u.value=null;try{return await G(e,t),((s=r.value)==null?void 0:s.id)===parseInt(e)&&(o.value=await y(e)),{success:!0}}catch(a){throw u.value=a.message,a}finally{l.value=!1}};return{opportunities:n,currentOpportunity:r,loading:l,error:u,currentOpportunityActivities:A(()=>o.value),hotOpportunities:S,fetchOpportunities:x,fetchOpportunityById:C,createOpportunity:I,updateOpportunity:$,deleteOpportunity:B,addActivity:F,updateActivity:O,deleteActivity:L,addVehicle:b,createOffer:k}});export{Q as u};
