import{C as X,r as o,c as u,O as Y,m as Z,l as ee,d as R,x as B,g as S,e as D,D as F,S as te,U as ae,V as oe,h as se,o as v,s as y}from"./index-H5Cqf6fX.js";import{u as re}from"./opportunities-DEbYZ9Ha.js";import{u as ne}from"./UnifiedAddForm-Dcy87xel.js";import{_ as le,a as ie,b as ue,c as ce,d as de,e as pe,f as me,V as ve}from"./RecentActivitiesWidget-Cdtm8Edr.js";import{fetchLeadsByCustomerId as ye,fetchOpportunitiesByCustomerId as fe,fetchTasksByCustomerId as he,fetchCustomerCars as ge}from"./contacts-Dm10rkvw.js";import{b as we}from"./calendar-xvguvRl0.js";import"./ComingSoonModal-DnKIG9sS.js";import"./toggle-group-item.vue_vue_type_script_setup_true_lang-Csij51_o-1_jAZFgo.js";import"./vehicles-By7ZQa14.js";import"./ReassignUserModal-DI-WnWzN.js";import"./users-C7jahJiq.js";import"./CreateEventModal-DnaL32CW.js";const Ce={class:"h-full flex flex-col overflow-hidden bg-surface"},ke={key:0,class:"flex-1 flex items-center justify-center"},Ae={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},De={__name:"Customer",setup(_e){const A=Y(),L=se();X(),re();const n=ne(),s=o(!1),c=o(null),p=o(null),f=o([]),h=o([]),_=o([]),T=o([]),$=o([]),x=o([]),I=o(null),l=u(()=>parseInt(A.params.id)),M=u(()=>"contact"),i=u(()=>{const e=p.value||n.currentCustomer;return e?{...e,id:e.id,type:"contact",customer:{id:e.id,name:e.name,email:e.email,phone:e.phone,address:e.address||"",initials:e.initials},source:e.source||"Direct",tags:e.tags||[],stage:"Contact",assignee:null,assigneeId:null}:null}),V=u(()=>null),N=u(()=>({currentActivities:u(()=>[]),addActivity:async()=>{},updateActivity:async()=>{},deleteActivity:async()=>{}})),U=u(()=>({overviewActions:[],tabActions:["note","email","sms","whatsapp","attachment"]})),g=async(e=null)=>{const t=e||l.value;if(t)try{const a=A.query.type==="account"?"account":"contact",[C,k,J,K,Q]=await Promise.all([n.fetchCustomerById(t,a),ye(t),fe(t),he(t),ge(t)]);p.value=C||n.currentCustomer,f.value=k.data||[],h.value=J.data||[],_.value=K.data||[],T.value=Q.data||[];const O=[];for(const r of f.value)try{const d=await te(r.id);O.push(...d)}catch(d){console.error(`Failed to load activities for lead ${r.id}:`,d)}for(const r of h.value)try{const d=await ae(r.id);O.push(...d)}catch(d){console.error(`Failed to load activities for opportunity ${r.id}:`,d)}$.value=O;try{I.value=await oe(t)}catch(r){console.error("Failed to load next appointment:",r),I.value=null}try{x.value=await we(t)}catch(r){console.error("Failed to load appointments:",r),x.value=[]}}catch(a){console.error("Error loading customer data:",a)}},b=async()=>{if(!l.value){c.value="No task ID provided";return}s.value=!0,c.value=null;try{await g()}catch(e){c.value=e.message||"Failed to load task",console.error("Error loading task:",e)}finally{s.value=!1}},q=async e=>{var t;try{const a=((t=i.value)==null?void 0:t.type)==="contact"?"contact":"account";await n.addRequestedCar(l.value,e),await b()}catch(a){console.error("Error adding car to customer:",a),c.value=a.message||"Failed to add car"}},j=async()=>{try{s.value=!0;const e=await n.convertToLead(l.value);L.push({path:`/tasks/${e.id}`,query:{type:"lead"}})}catch(e){console.error("Error converting to lead:",e),c.value=e.message||"Failed to convert to lead",s.value=!1}},P=async()=>{try{s.value=!0;const e=await n.convertToOpportunity(l.value);L.push({path:`/tasks/${e.id}`,query:{type:"opportunity"}})}catch(e){console.error("Error converting to opportunity:",e),c.value=e.message||"Failed to convert to opportunity",s.value=!1}},w=o(!1),m=o("lead"),W=u(()=>{if(!i.value)return{id:null,name:"Unknown",email:"",phone:"",initials:"?"};const e=i.value;return{id:e.id,name:e.name||"Unknown",email:e.email||"",phone:e.phone||"",initials:e.initials||"?"}}),E=e=>{m.value=e,w.value=!0},z=async e=>{try{s.value=!0,w.value=!1;const t=l.value;if(!t)throw new Error("Customer ID not found");m.value==="lead"?await n.convertToLead(t):await n.convertToOpportunity(t),await g(t),s.value=!1}catch(t){console.error(`Error adding ${m.value}:`,t),c.value=t.message||`Failed to add ${m.value}`,s.value=!1}};Z(async()=>{await b()});const G=async()=>{await g()},H=async()=>{await g()};return ee(()=>A.params.id,e=>{e&&b()}),(e,t)=>(v(),R("div",Ce,[s.value||!i.value||i.value&&i.value.id!==l.value?(v(),R("div",ke,[...t[3]||(t[3]=[D("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"},null,-1)])])):(v(),B(le,{key:1,task:i.value,type:M.value,"management-widget":V.value,"store-adapter":N.value,"add-new-config":U.value,onCarAdded:q,onConvertToLead:j,onConvertToOpportunity:P,onTagUpdated:G,onAppointmentCreated:H},{"pinned-extra":F(({task:a})=>{var C,k;return[y(pe,{summary:a.summary||((C=p.value)==null?void 0:C.summary),preferences:a.preferences||((k=p.value)==null?void 0:k.preferences),"customer-data":p.value},null,8,["summary","preferences","customer-data"]),y(me,{"next-appointment":I.value,activities:$.value,leads:f.value,opportunities:h.value,"customer-id":l.value},null,8,["next-appointment","activities","leads","opportunities","customer-id"]),T.value.length>0?(v(),B(ve,{key:0,cars:T.value},null,8,["cars"])):S("",!0)]}),"tab-negotiations":F(()=>[D("div",Ae,[y(ce,{leads:f.value,"all-tasks":_.value,onAddLead:t[0]||(t[0]=a=>E("lead"))},null,8,["leads","all-tasks"]),y(de,{opportunities:h.value,"all-tasks":_.value,activities:$.value,onAddOpportunity:t[1]||(t[1]=a=>E("opportunity"))},null,8,["opportunities","all-tasks","activities"])])]),"tab-appointments":F(()=>[y(ue,{appointments:x.value},null,8,["appointments"])]),_:1},8,["task","type","management-widget","store-adapter","add-new-config"])),i.value?(v(),B(ie,{key:2,show:w.value,type:m.value,contact:W.value,onClose:t[2]||(t[2]=a=>w.value=!1),onSave:z},null,8,["show","type","contact"])):S("",!0)]))}};export{De as default};
