[build]
  publish = "dist"
  # package.json is renamed to _package.json in git to prevent Netlify's automatic npm install
  # We restore it and handle authentication manually in the build command
  command = '''
    echo "Restoring package.json and package-lock.json..." && \
    mv _package.json package.json && \
    mv _package-lock.json package-lock.json && \
    export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_MK:-$AWS_ACCESS_KEY_ID} && \
    export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_MK:-$AWS_SECRET_ACCESS_KEY} && \
    export AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-eu-west-1} && \
    rm -f .npmrc && \
    if ! command -v aws >/dev/null 2>&1; then
      echo "Installing AWS CLI to user directory...";
      curl -sSL https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o /tmp/awscliv2.zip;
      unzip -q /tmp/awscliv2.zip -d /tmp;
      /tmp/aws/install --install-dir "$HOME/aws-cli" --bin-dir "$HOME/bin";
      export PATH="$HOME/bin:$PATH";
    fi && \
    echo "AWS CLI: $(aws --version)" && \
    echo "Getting CodeArtifact token..." && \
    AUTH_TOKEN=$(aws codeartifact get-authorization-token --domain motork --domain-owner 678121811175 --region eu-west-1 --query authorizationToken --output text) && \
    echo "Token obtained (length: ${#AUTH_TOKEN}), creating .npmrc..." && \
    echo "registry=https://motork-678121811175.d.codeartifact.eu-west-1.amazonaws.com/npm/ui-component-library/" > .npmrc && \
    echo "//motork-678121811175.d.codeartifact.eu-west-1.amazonaws.com/npm/ui-component-library/:always-auth=true" >> .npmrc && \
    echo "//motork-678121811175.d.codeartifact.eu-west-1.amazonaws.com/npm/ui-component-library/:_authToken=${AUTH_TOKEN}" >> .npmrc && \
    echo "Installing dependencies..." && \
    npm install && \
    echo "Building project..." && \
    npm run build
  '''

[build.environment]
  # AWS region for CodeArtifact
  AWS_DEFAULT_REGION = "eu-west-1"
  # Required environment variables (set in Netlify UI):
  # - AWS_ACCESS_KEY_ID_MK: AWS access key for CodeArtifact
  # - AWS_SECRET_ACCESS_KEY_MK: AWS secret key for CodeArtifact

# Optimize static asset caching
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

[[headers]]
  for = "/*.js"
  [headers.values]
    Content-Type = "application/javascript; charset=utf-8"
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

[[headers]]
  for = "/*.css"
  [headers.values]
    Content-Type = "text/css; charset=utf-8"
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

[[headers]]
  for = "/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"

# SPA routing - redirect all routes to index.html
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
